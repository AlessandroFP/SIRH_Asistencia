package pe.gob.sunat.sp.asistencia.ejb;

import java.io.BufferedReader;
import java.io.FileReader;
import java.io.InputStream;
import java.rmi.RemoteException;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.StringTokenizer;
import java.util.Vector;

import javax.ejb.SessionBean;
import javax.ejb.SessionContext;
import javax.sql.DataSource;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.asn1c.core.Int16;

import pe.gob.sunat.batch.dao.QueueDAO;
import pe.gob.sunat.framework.core.bean.ParamBean;
import pe.gob.sunat.framework.core.ejb.FacadeException;
import pe.gob.sunat.framework.core.pattern.ServiceLocator;
import pe.gob.sunat.framework.util.Propiedades;
import pe.gob.sunat.framework.util.dao.SequenceDAO;
import pe.gob.sunat.framework.util.date.FechaBean;
import pe.gob.sunat.framework.util.mail.Correo;
import pe.gob.sunat.sol.BeanFechaHora;
import pe.gob.sunat.sol.BeanMensaje;
import pe.gob.sunat.sol.IncompleteConversationalState;
//import pe.gob.sunat.sp.asistencia.bean.BeanAsistencia;
import pe.gob.sunat.sp.asistencia.bean.BeanHoraExtra;
//import pe.gob.sunat.sp.asistencia.bean.BeanLicencia;
import pe.gob.sunat.sp.asistencia.bean.BeanMarcacion;
import pe.gob.sunat.sp.asistencia.bean.BeanPeriodo;
import pe.gob.sunat.sp.asistencia.bean.BeanProceso;
import pe.gob.sunat.sp.asistencia.bean.BeanTipoMovimiento;
import pe.gob.sunat.sp.asistencia.bean.BeanTurno;
import pe.gob.sunat.sp.asistencia.bean.BeanTurnoTrabajo;
import pe.gob.sunat.sp.asistencia.dao.T1270DAO;
//import pe.gob.sunat.sp.asistencia.dao.T1271DAO;
import pe.gob.sunat.sp.asistencia.dao.T1272DAO;
//import pe.gob.sunat.sp.asistencia.dao.T1273DAO;
import pe.gob.sunat.sp.asistencia.dao.T1275DAO;
import pe.gob.sunat.sp.asistencia.dao.T1276DAO;
import pe.gob.sunat.sp.asistencia.dao.T1279DAO;
import pe.gob.sunat.sp.asistencia.dao.T1281DAO;
import pe.gob.sunat.sp.asistencia.dao.T9437DAO;
import pe.gob.sunat.sp.asistencia.dao.T9446DAO;
//import pe.gob.sunat.sp.asistencia.dao.T1282DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T1271DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T1273DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T1274DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T1277DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T1282DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T130DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T1444DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T1455DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T1608DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T3464DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T3701DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T3792DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T3793DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T72DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T1456DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T8167DAO; //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
import pe.gob.sunat.rrhh.dao.T60DAO;
import pe.gob.sunat.sp.asistencia.dao.T1454DAO;
//import pe.gob.sunat.sp.asistencia.dao.T1456DAO;
import pe.gob.sunat.sp.asistencia.dao.T1481DAO;
import pe.gob.sunat.sp.asistencia.dao.ReporteDAO;
import pe.gob.sunat.sp.asistencia.dao.T1480DAO;
import pe.gob.sunat.sp.asistencia.ejb.delegate.VacacionDelegate;
import pe.gob.sunat.sp.bean.BeanT99;
import pe.gob.sunat.sp.dao.CorreoDAO;
import pe.gob.sunat.sp.dao.T01DAO;
import pe.gob.sunat.sp.dao.T02DAO;
//import pe.gob.sunat.sp.dao.T12DAO;
import pe.gob.sunat.sp.dao.T99DAO;
import pe.gob.sunat.tecnologia.menu.bean.MenuCliente;
import pe.gob.sunat.utils.Constantes;
import pe.gob.sunat.utils.Utiles;
import pe.gob.sunat.utils.bd.OracleSequenceDAO;
import pe.gob.sunat.utils.dbf.AccesoDBFDAO;

//ICAPUNAY 15/12/2010 AOM URGENTE: 44U3T10 Gesti칩n de turnos y calificacion de procesos
import java.text.SimpleDateFormat;

import pe.gob.sunat.rrhh.utils.ConvertidorCSVaLIST;

import java.util.Locale;

import pe.gob.sunat.sp.asistencia.dao.T45DAO;
//FIN ICAPUNAY 15/12/2010 AOM URGENTE: 44U3T10 Gesti칩n de turnos y calificacion de procesos
import pe.gob.sunat.rrhh.siga.dao.OracleModFormativasDAO;//ICAPUNAY 21/06/2011 FORMATIVAS-PARTEII
//ICAPUNAY 09/04/2012 AOM 06A4T11 LABOR EXCEPCIONAL Y COMPENSACIONES-PAS20124E550000064
import pe.gob.sunat.rrhh.asistencia.dao.T4818DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T4819DAO;
import pe.gob.sunat.rrhh.asistencia.dao.T4821DAO;
import pe.gob.sunat.sp.dao.T12DAO;
import pe.gob.sunat.framework.util.mail.CorreoException;
import pe.gob.sunat.sp.asistencia.dao.T1480DAO;
//FIN ICAPUNAY 09/04/2012 AOM 06A4T11 LABOR EXCEPCIONAL Y COMPENSACIONES-PAS20124E550000064


/**
 * 
 * @ejb.bean name="ProcesoFacadeEJB"
 *           description="ProcesoFacade"
 *           jndi-name="ejb/rrhh/facade/sp/asistencia/ProcesoFacadeEJB"
 *           type="Stateless" view-type="remote"
 * 
 * @ejb.home remote-class="pe.gob.sunat.sp.asistencia.ejb.ProcesoFacadeHome"
 * 			 extends="javax.ejb.EJBHome"
 * 
 * @ejb.interface remote-class="pe.gob.sunat.sp.asistencia.ejb.ProcesoFacadeRemote"
 *                extends="javax.ejb.EJBObject"
 *                
 * @ejb.resource-ref res-ref-name="jdbc/dcsp" res-type="javax.sql.DataSource" res-auth="Container"
 * @weblogic.resource-description res-ref-name="jdbc/dcsp" jndi-name="jdbc/dcsp"
 * 
 * @ejb.resource-ref res-ref-name="jdbc/dgsp" res-type="javax.sql.DataSource" res-auth="Container"
 * @weblogic.resource-description res-ref-name="jdbc/dgsp" jndi-name="jdbc/dgsp"
 * 
 * @ejb.resource-ref res-ref-name="pool_oracle" res-type="javax.sql.DataSource" res-auth="Container"
 * @jboss.resource-ref res-ref-name="pool_oracle" jndi-name="java:/pool_scad"
 * @weblogic.resource-description res-ref-name="pool_oracle" jndi-name="jdbc/dcscad"
 * 
 * @ejb.resource-ref res-ref-name="jdbc/dcsig" res-type="javax.sql.DataSource" res-auth="Container"
 * @weblogic.resource-description res-ref-name="jdbc/dcsig" jndi-name="jdbc/dcsig"
 * 
 * @ejb.resource-ref res-ref-name="jdbc/dgsig" res-type="javax.sql.DataSource" res-auth="Container"
 * @weblogic.resource-description res-ref-name="jdbc/dgsig" jndi-name="jdbc/dgsig"
 * 
 * @jboss.container-configuration name="Standard Stateless SessionBean"
 * @jboss.version="3.2"
 *  
 * @weblogic.enable-call-by-reference True
 * 
 * @weblogic.clustering home-is-clusterable="True" stateless-bean-is-clusterable="True"
 * @weblogic.transaction-descriptor trans-timeout-seconds = "300"
 * @weblogic.cache max-beans-in-cache="300"
 * @weblogic.pool max-beans-in-free-pool="300" initial-beans-in-free-pool="10"
 * 
 * @version 1.0
 */
public class ProcesoFacade extends QueueDAO implements SessionBean {

	Propiedades constantes = new Propiedades(getClass(), "/constantes.properties");
	Propiedades propiedadesCorreo = new Propiedades(getClass(), "/correo.properties");//ICAPUNAY 09/04/2012 AOM 06A4T11 LABOR EXCEPCIONAL Y COMPENSACIONES-PAS20124E550000064
	//JRR
	ServiceLocator sl = ServiceLocator.getInstance();
	
	private final Log log_papeleta = LogFactory.getLog("SIRH_papeleta");
	private SessionContext sessionContext;

	public void ejbCreate() {		
	}

	public void ejbRemove() {
	}

	public void ejbActivate() {
	}

	public void ejbPassivate() {
	}

	public void setSessionContext(SessionContext sessionContext) {
		this.sessionContext = sessionContext;
	}

	/**
	 * Metodo que se encarga de ejecutar el proceso masivo de asistencia
	 *
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 * @param params
	 * @param usuario
	 * @return
	 * @throws RemoteException
	 */
	public boolean procesarAsistencia(HashMap params, String usuario)
			throws RemoteException {
		//PRAC-JCALLO
		String id = (String) params.get("messageID");
		String dbpool = (String) params.get("dbpool");
		
		T1279DAO movDAO = new T1279DAO();
		T1271DAO asisDAO = new T1271DAO(dbpool);
		boolean res = true;		
		
		try {

			super.creaLog(id, "PROCESO DE ASISTENCIA", usuario);
			
			String criterio = (String) params.get("criterio");
			String valor = (String) params.get("valor");
			String periodo = (String) params.get("periodo");			
			//String fechaIni = (String) params.get("fechaIni");
			//String fechaFin = (String) params.get("fechaFin");
			String indPap = (String) params.get("indPap");
			
			HashMap seguridad = (HashMap) params.get("seguridad");
			
			int trabIni = Integer.parseInt((String) params.get("limiteInferior"));
			int trabFin = Integer.parseInt((String) params.get("limiteSuperior"));
			//PRAC-JCALLO
			Map prms = new HashMap();
			prms.put("criterio", criterio);
			prms.put("valor", valor);
			prms.put("periodo", periodo);
			prms.put("seguridad", seguridad);
			//JRR - 22/04/2010
			//prms.put("regCAS", (params.get("regCAS")!=null?params.get("regCAS"):""));
			//JRR - 27/04/2011 - Para Modalidad Formativa
			prms.put("regimen", (params.get("regimen")!=null?params.get("regimen"):""));
			
			if (log.isDebugEnabled()) log.debug("metodo procesarAsistencia... prms: "+prms);
			List lista = asisDAO.findPersonalAsistencia(prms);// (dbpool, criterio, valor, periodo, seguridad)REEMPLAZAR POR EL QUE ESTA EN RRHH ASISTENCIA DAO;
			if (log.isDebugEnabled())  log.debug("lista.size"+lista.size());

			ArrayList movimientos = movDAO.findByEstado(dbpool,Constantes.ACTIVO);
			HashMap acumulados = movDAO.findMapByEstado(dbpool,Constantes.ACTIVO);
			HashMap acumPeriodo = movDAO.findMapByEstado(dbpool,Constantes.ACTIVO);

			MantenimientoFacadeHome facadeMantHome = (MantenimientoFacadeHome) ServiceLocator.getInstance().getRemoteHome(
					MantenimientoFacadeHome.JNDI_NAME,
					MantenimientoFacadeHome.class);
			MantenimientoFacadeRemote facadeMantRemote = facadeMantHome.create();
			
			boolean bPeriodoCerrado = false;
			String codUO = "";
			
			T1276DAO periodoDAO = new T1276DAO();
			BeanPeriodo bPer = periodoDAO.findByCodigo(dbpool, periodo);
			
			Map trab = new HashMap();
			Map mapa = new HashMap();

			String fActual = Utiles.obtenerFechaActual();
			String fActualYYYYMMDD = Utiles.toYYYYMMDD(fActual);

			FechaBean fecha_fin = new FechaBean(bPer.getFechaFin(), "yyyy/MM/dd");
			FechaBean fecha_finCAS = new FechaBean(bPer.getFechaFinCAS(), "yyyy/MM/dd");
			FechaBean fecha_finModForm = new FechaBean(bPer.getFechaFinModForm(), "yyyy/MM/dd");
			
			long l_fecha = new FechaBean().getCalendar().getTime().getTime();

			//analizamos cada uno de los trabajadores
			if (lista!=null && lista.size()>0){

				for (int i = trabIni; i <= trabFin; i++) {

					if (i<lista.size()){//ICR 04/05/15-PAS20155E230000154-corregir error "java.lang.IndexOutOfBoundsException"
						//verificamos si el periodo esta cerrado
						trab = (HashMap) lista.get(i);
						if (trab!=null) codUO = (String) trab.get("cod_uorga");
	
						//JRR - 22/04/2010
						if (trab.get("t02cod_rel")!=null && trab.get("t02cod_rel").toString().trim().equals("09")) { //Para el reg. CAS
							mapa.put("dbpool", dbpool);
							mapa.put("periodo", periodo);
							bPeriodoCerrado = facadeMantRemote.periodoCerradoCAS(mapa);
							
						} else if (trab.get("t02cod_rel")!=null && trab.get("t02cod_rel").toString().trim().equals("10")) { //JRR - 28/04/2011 - Para Modalidad Formativa
							mapa.put("dbpool", dbpool);
							mapa.put("periodo", periodo);
							bPeriodoCerrado = facadeMantRemote.periodoCerradoModFormativa(mapa);
							
						} else {
							bPeriodoCerrado = facadeMantRemote.periodoCerradoUOFecha(dbpool, bPer.getFechaIni(), Utiles.obtenerFechaActual(),codUO);	
						}
	
						
						if (bPeriodoCerrado){				
							//output.println("El periodo ".concat(periodo).concat(" ya se encuentra cerrado para la UO ").concat(codUO).concat("."));
						}
						else{
	
							//JRR - 22/04/2010
							params.put("codPers", trab.get("t02cod_pers"));
							params.put("codUO", trab.get("cod_uorga"));
							params.put("movimientos", movimientos);
							params.put("acumulados", acumulados);
							params.put("acumPeriodo", acumPeriodo);
							params.put("usuario", usuario);
	
							if (trab.get("t02cod_rel")!=null && trab.get("t02cod_rel").toString().trim().equals("09")) { //Para el reg. CAS	
								if (i<lista.size()){
									
									//fecha_fin = new FechaBean(bPer.getFechaFinCAS(), "yyyy/MM/dd");
									if ((l_fecha) - (fecha_finCAS.getCalendar().getTime().getTime())<0){
										bPer.setFechaFinCAS(fActualYYYYMMDD);
									}
									params.put("fechaIni", bPer.getFechaIniCAS());
									params.put("fechaFin", bPer.getFechaFinCAS());
									
									procesarAsistenciaTrabajadorCAS(params);
								}	
								
							} else if (trab.get("t02cod_rel")!=null && trab.get("t02cod_rel").toString().trim().equals("10")) { //Para Modalidad Formativa	
								if (i<lista.size()){
									
									//fecha_fin = new FechaBean(bPer.getFechaFinCAS(), "yyyy/MM/dd");
									if ((l_fecha) - (fecha_finModForm.getCalendar().getTime().getTime())<0){
										bPer.setFechaFinModForm(fActualYYYYMMDD);
									}
									params.put("fechaIni", bPer.getFechaIniModForm());
									params.put("fechaFin", bPer.getFechaFinModForm());
									
									procesarAsistenciaTrabModFormativa(params);
								}	
								
							} else {
								if (i<lista.size()){
									
									//fecha_fin = new FechaBean(bPer.getFechaFin(), "yyyy/MM/dd");					
									if ((l_fecha) - (fecha_fin.getCalendar().getTime().getTime())<0){
										bPer.setFechaFin(fActualYYYYMMDD);
									}
									
									procesarAsistenciaTrabajador(
											dbpool, 
											(String) trab.get("t02cod_pers"), 
											(String) trab.get("cod_uorga"), 
											periodo,
											bPer.getFechaIni(), 
											bPer.getFechaFin(), 
											movimientos, 
											acumulados,
											acumPeriodo, 
											usuario,
											indPap);
								}									
							}
						}
					}//ICR 04/05/15-PAS20155E230000154-corregir error "java.lang.IndexOutOfBoundsException"	
				}//DEL FOR
			}			

		} catch (Exception e) {
			res = false;			
			log.error(e);			
			//output.println("Error : " + e.toString());			
		} finally {
			try {
				//ASANCHEZZ 20100514 - PARA QUE SE ACTUALICE EL ESTADO DEL PROCESO Y GENERE EL ZIP CORRESPONDIENTE, 
				//ya que codPers se chanca con otro valor y causa el error
				params.put("codPers", params.get("codPersT1481")!=null ? params.get("codPersT1481").toString().trim():"");
				//FIN
				//registramos el log del proceso
				super.registraLog(dbpool, params, usuario);
			} catch (Exception e) {
			}
		}
		return res;
	}

	/**
	 * Metodo que se encarga de ejecutar el proceso de asistencia para un
	 * trabajador
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="Required"
	 * 
	 */
	public boolean procesarAsistenciaTrabajador(
			String dbpool, 
			String codPers,
			String codUO, 
			String periodo, 
			String fechaIni, 
			String fechaFin,
			ArrayList movimientos, 
			HashMap acumulados, 
			HashMap acumPeriodo,
			String usuario,
			String indPap) 
		throws IncompleteConversationalState, RemoteException {
		
		if (log.isDebugEnabled()) log.debug("Utilizando metodo procesarAsistenciaTrabajador");
		
		//prac-jcallo
		T1271DAO asisDAO = new T1271DAO(dbpool);
		T1272DAO resumenDAO = new T1272DAO();
		T1454DAO diarioDAO = new T1454DAO();
		T1273DAO licenciaDAO = new T1273DAO(dbpool);
		T1282DAO vacacionDAO = new T1282DAO(dbpool);		
		T1270DAO turnoDAO = new T1270DAO();
		T01DAO paramDAO = new T01DAO();
		T99DAO codigoDAO = new T99DAO();
		//JRR - BOLSA
		T1279DAO t1279mov = new T1279DAO();
		T8167DAO climaLabDAO = new T8167DAO(dbpool); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
		
		
		BeanTurnoTrabajo turno = null;
		boolean res = true;
		String fIni = "";
		String fFin = "";
		
		List papeletasGeneradas=null;//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
		
		try {
			String fechaIniNSA = codigoDAO.findParamByCodTabCodigo(dbpool,
					Constantes.CODTAB_PARAMETROS_ASISTENCIA,
					Constantes.FECHA_INICIO_SIRH_NSA);
			
			
			//eliminamos la asistencia resumen en el periodo para el trabajador
			resumenDAO.deleteByCodPersPeriodo(dbpool, codPers, periodo);
			diarioDAO.deleteByCodPersPeriodo(dbpool, codPers, periodo);

			//para la verificacion de dias faltantes
			if (fechaIni.indexOf("/")>3) fIni = fechaIni; else fIni = Utiles.toYYYYMMDD(fechaIni);	
			if (fechaFin.indexOf("/")>3) fFin = fechaFin; else fFin = Utiles.toYYYYMMDD(fechaFin);	

			String fAct = fIni;
			String fReal = fechaIni;
			if (fReal.indexOf("/")>3){ 
				fReal = fReal.substring(8,10) + "/" + fReal.substring(5,7) + "/" + fReal.substring(0,4) ;
			}
			
			boolean bVacacion = false;
			boolean bLicencia = false;
			boolean bInasistencia = true;
			boolean bPrimMarca = true;
			boolean bUltMarca = false;
			//JRR - BOLSA
			boolean bLicGoce = false;
			
			HashMap acumPer = null;
			HashMap acumDetalle = null;
			HashMap acumDetalleRefri = null;//ICR 18052015
			HashMap acumPerRefri = null;//ICR 18052015
			
			List detalles = null;
			List detallesPapGen = null;//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
			//BeanProceso proceso = null;
			Map proceso = new HashMap();
			int minRecuperacion = 0; //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
			
			//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
			Map paramsCli = new HashMap();			
			String climaLab = codigoDAO.findParamByCodTabCodigo(dbpool,Constantes.CODTAB_PARAMETROS_ASISTENCIA,Constantes.MINUTOS_MAXIMO_CLIMALABORAL);
			int minMaxClima = climaLab != null ? Integer.parseInt(climaLab) : 0;
			log.debug("minMaxClima: " + ""+minMaxClima);
			List califClima = null;
			Map autoriClima = null;	
			//ICAPUNAY - PAS20175E230300069
			
			//mientras no haya terminado el periodo en proceso
			while (fAct.compareTo(fFin) <= 0) {

				String tipo_licencia = "";
				
				if (log.isDebugEnabled()) log.debug("--------- Fecha : " + fReal + " ---------");
				
				minRecuperacion = turnoDAO.findHorasCompensa(dbpool,codPers,fReal); //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
				if (log.isDebugEnabled()) log.debug("minRecuperacion3-Planilla:"+minRecuperacion);
				
				//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
				paramsCli.put("cod_pers", codPers);
				paramsCli.put("mov", Constantes.MOV_REFRI_CLIMALABORAL);//136
				paramsCli.put("fecha", new FechaBean(fReal).getSQLDate());				
				log.debug("paramsClii: "+paramsCli);
				
				califClima=asisDAO.findByCodPersMovFecha(paramsCli);
				log.debug("califClimaa: "+califClima);
				autoriClima=climaLabDAO.findAutorizaByRegByFecha(codPers, fReal);
				log.debug("autoriClima new: "+autoriClima);
				//ICAPUNAY - PAS20175E230300069

				//aqui inicializamos todas las variables de control del dia
				bVacacion = false;
				bLicencia = false;
				bInasistencia = true;
				bPrimMarca = true;
				bLicGoce = false;

				//obtenemos el turno del trabajador para la fecha en proceso
				turno = turnoDAO.joinWithT45ByCodFecha(dbpool, codPers, fReal);
				if (log.isDebugEnabled()) log.debug("Turno de trabajador:" + turno);

				//verificamos si esta de vacaciones para la fecha real
				//prac-jcallo
				Map prm = new HashMap();
				prm.put("cod_pers", codPers);
				prm.put("fechaIni", fReal);
				prm.put("fechaFin", "");
				if (log.isDebugEnabled()) log.debug("metodo procesarAsistenciaTrabajador - findByCodPersFIniFFin - prm:"+prm);
				bVacacion = vacacionDAO.findByCodPersFIniFFin(prm);
				
				/******* JRR NUEVA SOLICITUD - 23/04/2009 *******/
				if (!bVacacion) {
					List vacVencidas = vacacionDAO.findByCodPersFIniFFinVacVencidas(prm);
					if (vacVencidas!=null && vacVencidas.size()>0) { 
						bVacacion = true;
						if (log.isDebugEnabled()) log.debug(codPers + " posee Goce de Vacaciones Vencidas.");
					}
				}
				/************************************************/
				
				if (log.isDebugEnabled()) log.debug("bVacacion: "+bVacacion);
				if (bVacacion) {
					
					//output.println("El trabajador esta de vacaciones el " +fReal);
					if (log.isDebugEnabled()) log.debug("El trabajador esta de vacaciones el " +fReal);

					//obtenemos el movimiento de vacaciones e incrementamos el numero de dias
					acumDetalle = (HashMap) acumulados.get(Constantes.MOV_VACACIONES);
					acumDetalle.put("total", "1");
					acumulados.put(Constantes.MOV_VACACIONES, acumDetalle);
					
					//acumulamos del periodo
					acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_VACACIONES);
					
					float totPer = new Float(acumPer.get("total").toString()).floatValue();
					acumPer.put("total", "" + (totPer + 1));
					acumPeriodo.put(Constantes.MOV_VACACIONES, acumPer);

					//el trabajador no ha faltado xq esta de vacaciones
					bInasistencia = false;
					
				} else {

					//verificamos si esta de licencia
					//prac-jcallo
					Map params = new HashMap();
					params.put("cod_pers", codPers);
					params.put("fecha1", fReal);
					params.put("fecha2", "");
					params.put("numero", "");
					if (log.isDebugEnabled()) log.debug("licenciaDAO.findByCodPersFIniFFin(params)... params:"+params);
					bLicencia = licenciaDAO.findByCodPersFIniFFin(params); //(dbpool,codPers, fReal, "", "");
					
					if (bLicencia) {
						
						//output.println("El trabajador esta de licencia el " +fReal);
						if (log.isDebugEnabled()) log.debug("El trabajador esta de licencia el " +fReal);
						
						//obtenemos la licencia de ese dia
						Map prms = new HashMap();
						prms.put("cod_pers", codPers);
						prms.put("fecha", fReal);
						//BeanLicencia
						List lista = licenciaDAO.findByCodPersFecha(prms);
						Map licencia = (Map)lista.get(0); //(dbpool, codPers, fReal);
						//obtenemos el movimiento de vacaciones e incrementamos el numero de dias
						acumDetalle = (HashMap) acumulados.get(licencia.get("licencia").toString().trim());

						//JRR - 07/11/2008 - BOLSA
						Map mapaMov = new HashMap();
						tipo_licencia = licencia.get("licencia").toString().trim();
						if (log.isDebugEnabled()) log.debug("tipo_licencia: " + tipo_licencia);
						if (tipo_licencia!=null && !tipo_licencia.equals(""))
							mapaMov = t1279mov.findByMov(dbpool, tipo_licencia);
						if (log.isDebugEnabled()) log.debug("Movimiento - mapaMov: " + mapaMov);
						if (mapaMov!=null && mapaMov.size()>0){
							if (mapaMov.get("califica")!=null && mapaMov.get("tipo_id")!=null) {
								if (mapaMov.get("califica").equals(Constantes.SIN_DESCUENTO) && mapaMov.get("tipo_id").equals(Constantes.TIPO_MOV_LICENCIA)) {
									bLicGoce = true;									
								}
							}
						}
						//
						
						if (acumDetalle != null) {
							//el trabajador esta de licencia
							acumDetalle.put("total", "1");
							acumulados.put(licencia.get("licencia").toString().trim(),acumDetalle);

							//acumulamos del periodo
							acumPer = (HashMap) acumPeriodo.get(licencia.get("licencia").toString().trim());
							
							float totPer = new Float(acumPer.get("total").toString()).floatValue();
							acumPer.put("total", "" + (totPer + 1));
							acumPeriodo.put(licencia.get("licencia").toString().trim(),acumPer);

						}

						//el trabajador no ha faltado xq esta de licencia
						bInasistencia = false;
					}
				}

/*************************** JRR - 05/11/2008 - BOLSA*****************************			*/
				if (bVacacion || (bLicGoce && !tipo_licencia.equals("") && !tipo_licencia.equals("40"))) {
					//verificamos si es un dia laborable
					boolean diaLab = true;
					if (turno != null && !turno.isOperativo()) {
						if (Utiles.isDiaSemana(fReal, Constantes.SABADO)								
							|| Utiles.isDiaSemana(fReal, Constantes.DOMINGO)
							|| paramDAO.findByFechaFeriado(dbpool, fReal)) {
							diaLab = false;
						}
					}

					if (diaLab) {
						//Si existen pendientes de compensaci칩n por bolsa le insertare una hora
						int minutos = 60;
						Map datos = new HashMap();
						datos.put("dbpool", dbpool);
						datos.put("cod_pers", codPers);
						//fec_compensa es la fecha de la marcacion que se est치 analizando
						datos.put("fec_compensa", new FechaBean(fReal).getSQLDate());
						datos.put("fec_creacion", new FechaBean().getTimestamp());
						datos.put("cod_usucrea", usuario);
						datos.put("tiempo", new Integer(minutos));

						if (log.isDebugEnabled()) log.debug("En PROCESOFACADE - registrarCompensaciones - DATOS: " + datos);
						registrarCompensaciones(datos);

					}
					
				}
				
/*************************************************************/				
				
				//si posee turno y no esta ni de vacaciones ni de licencia
				if (turno != null && !bVacacion && !bLicencia) {
					
					//verificamos si es un dia laborable
					boolean diaLaborable = true;
					if (!turno.isOperativo()) {
						if (Utiles.isDiaSemana(fReal, Constantes.SABADO)								
							|| Utiles.isDiaSemana(fReal, Constantes.DOMINGO)
							|| paramDAO.findByFechaFeriado(dbpool, fReal)) {
							diaLaborable = false;
						}
					}

					//obtenemos el detalle de las calificaciones para la fecha
					//prac-jcallo
					Map params = new HashMap();
					params.put("cod_pers", codPers);
					params.put("fing", fReal);
					
params.put("estado_id", "1");//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
					
					//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
					detallesPapGen = asisDAO.findByCodPersFechaAndEstado(params);
					log.debug("detallesPapGen: "+detallesPapGen);
					
					if (detallesPapGen != null && detallesPapGen.size() > 0) {
						
						String periodoPap = (String)((HashMap)detallesPapGen.get(0)).get("periodo");
						
						HashMap fechas = new HashMap();
						fechas.put("FechaNSA",fechaIniNSA);
						
						DataSource dcsp = ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dcsp");
						pe.gob.sunat.rrhh.dao.T02DAO t02dao = new pe.gob.sunat.rrhh.dao.T02DAO(dcsp);
						HashMap beanPersona = (HashMap)t02dao.findByRegistro(codPers.trim());
						beanPersona.put("t02cod_pers", codPers);
						beanPersona.put("t02cod_uorg", beanPersona.get("cod_uorg"));
						
						HashMap mapa=new HashMap();
						mapa.put("dbpool", "jdbc/dgsp");
						mapa.put("fechaEval",fReal);
						mapa.put("periodo", periodoPap);
						mapa.put("isProcesar", "SI");
						
						Map superMapa = new HashMap();
						superMapa.put("mapa", mapa);
						superMapa.put("beanPersona", beanPersona);
						superMapa.put("fechas", fechas);
						superMapa.put("usuario", usuario);
						superMapa.put("isProcesar", "SI");
						
						String t02cod_rel=(String)beanPersona.get("t02cod_rel");
						
						ProcesoFacade pf=new ProcesoFacade();
						
						log.debug("superMapa--"+superMapa);
						if(t02cod_rel.equals("09")) {
							pf.generarAsistenciaTrabajadorCAS(superMapa);
							log.debug("superMapa: "+superMapa);
						} else if(t02cod_rel.equals("10")) {
							pf.generarAsistenciaTrabajadorModFormativa(superMapa);
						} else {
							pf.generarAsistenciaTrabajador(mapa,beanPersona,fechas,usuario);
						}
						
						papeletasGeneradas = (List)superMapa.get("papeletasGeneradas");
						if (log.isDebugEnabled()) log.debug("papeletasGeneradas fin : "+papeletasGeneradas);
					}
					//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
					
					if (log.isDebugEnabled()) log.debug("asisDAO.findByCodPersFechaPeriodo(params)... params:"+params);
					/*params.put("cod_pers", codPers);
					params.put("cod_pers", codPers);*/
					detalles = asisDAO.findByCodPersFechaPeriodo(params);// (dbpool, codPers, fReal, periodo) CAMBIAR ESTO POR EL DE RRHH ASISTENCIA;
					if (log.isDebugEnabled()) log.debug("detalles.size : "+detalles.size());

					//si el trabajador posee calificaciones para ese dia
					if (detalles != null && detalles.size() > 0) {

						bInasistencia = false;
						
						//analizamos cada movimiento realizado
						for (int j = 0; j < detalles.size(); j++) {
							
							boolean movEspecial = false;
							boolean procesarPapeleta = false;
							//proceso = (BeanProceso) detalles.get(j);
							proceso = (HashMap) detalles.get(j);
							//log.debug("******** PROCESO *********: " + proceso);
							
							//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
							String hing = proceso.get("hing").toString().trim();						
							log.debug("papeletasGeneradas: "+papeletasGeneradas);
							if (papeletasGeneradas!=null){
								for (int k = 0; k <= papeletasGeneradas.size()-1; k++) {
									Map papeleta = (HashMap) papeletasGeneradas.get(k);
									if (hing.equals(papeleta.get("hing"))){
										proceso.put("mov", papeleta.get("mov"));
										proceso.put("estado_id", papeleta.get("estado_id"));
									}
								}
							}
							//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0

							//String mov = proceso.getMovimiento() != null ? proceso.getMovimiento().trim() : "";
							String mov = proceso.get("mov")!= null ? proceso.get("mov").toString().trim() : "";
							acumPer = (HashMap) acumPeriodo.get(mov);
							acumDetalle = (HashMap) acumulados.get(mov);
							String recalifica = mov;
							
							//JRR 19 mayo 2008
							//FechaBean fechaA = new FechaBean(proceso.get("fing").toString().trim());
							//String fing = fechaA.getFormatDate("dd/MM/yyyy");
							String fing = proceso.get("fing_desc").toString().trim();

							if (acumDetalle != null) {
								String tipo = (String) acumDetalle.get("tipo_id");
								String medida = (String) acumDetalle.get("medida");

								float total = new Float(acumDetalle.get("total").toString()).floatValue();
								float cantidad = 0;

								boolean entrada = acumDetalle.get("entrada") != null ? ((String) acumDetalle.get("entrada")).equals(Constantes.ACTIVO): false;
								boolean refrigerio = acumDetalle.get("refrigerio") != null ? ((String) acumDetalle.get("refrigerio")).equals(Constantes.ACTIVO): false;
								boolean salida = acumDetalle.get("salida") != null ? ((String) acumDetalle.get("salida")).equals(Constantes.ACTIVO): false;
								movEspecial = entrada || refrigerio || salida
										|| tipo.trim().equals(Constantes.TIPO_MOV_PAPELETA)
										|| mov.equals(Constantes.MOV_INASISTENCIA);

								//inasistencia
								if (mov.equals(Constantes.MOV_INASISTENCIA)) bInasistencia = true;

								if (!bInasistencia) {
									
									//movimientos de entrada
									if (entrada) {

										bPrimMarca = false;
										String horaLim = turno.getHoraLimite();
										
										if (horaLim != null && !horaLim.equals("")) {

											//cantidad de minutos de tardanza
											cantidad = Utiles
													.calculaAcumulado(
															medida,
//															Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ turno.getHoraIni()),
//															Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ proceso.getHoraIni()));
											Utiles.stringToTimestamp(fing+ " "+ turno.getHoraIni()),
											Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()));
											

											if (cantidad < 0) cantidad *= -1;
											//EBV 05/01/2009
											//Si existe el movimiento pero le ponemos 1 a fin de que grabe
											if (cantidad == 0) cantidad = 1;
											//EBV 05/01/2009
											
											//acumulamos el diario
											acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
											acumulados.put(mov, acumDetalle);
											
											//acumulamos el periodo
											float totPer = new Float(acumPer.get("total").toString()).floatValue();
											acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
											acumPeriodo.put(mov, acumPer);
										}
									}

									//movimientos de refrigerio
									if (refrigerio) {
										
										bPrimMarca = false;

										cantidad = Utiles
												.calculaAcumulado(
														medida,
										Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()),
										Utiles.stringToTimestamp(fing+ " "+ proceso.get("hsal").toString()));

										//ICR 18052015
										String movAnt="";
										if (j != 0){
											Map procesoAnt = (HashMap) detalles.get(j-1);
											movAnt = procesoAnt.get("mov")!= null ? procesoAnt.get("mov").toString().trim() : "";
										}
										//FIN ICR 18052015
										
										if (!movAnt.equals("") && !movAnt.equals(Constantes.MOV_EXCESO_REFRIGERIO)){ //ICR 18052015
											float totalRefri = 0; //linea add ICAPUNAY - PAS20175E230300069
											log.debug("mov anterior no es exceso:"+movAnt);//BORRAR 25/06
											if (mov.equals(Constantes.MOV_EXCESO_REFRIGERIO)) {
												//ICR 18052015	
												log.debug("es mov exceso refri_Planilla");																					
												//cantidad -= turno.getMinutosRefrigerio();
												if (califClima!=null && califClima.size()>0){ //linea add ICAPUNAY - PAS20175E230300069
													totalRefri = new Float(((HashMap)acumulados.get(Constantes.MOV_REFRI_CLIMALABORAL)).get("total").toString()).floatValue();//linea add ICAPUNAY - PAS20175E230300069
												}else{ //linea add ICAPUNAY - PAS20175E230300069
													totalRefri = new Float(((HashMap)acumulados.get(Constantes.MOV_REFRIGERIO)).get("total").toString()).floatValue();
												}//linea add ICAPUNAY - PAS20175E230300069												
												float totalExceRefri = new Float(((HashMap)acumulados.get(Constantes.MOV_EXCESO_REFRIGERIO)).get("total").toString()).floatValue();
												log.debug("totalRefri_Planilla: "+totalRefri);
												log.debug("totalExceRefri_Planilla: "+totalExceRefri);
												//if (califClima!=null && califClima.size()>0){ //linea add ICAPUNAY - PAS20175E230300069
												if ((califClima!=null && califClima.size()>0) || (autoriClima!=null && !autoriClima.isEmpty())){ //linea add ICAPUNAY - PAS20175E230300069
													if (totalRefri+totalExceRefri+cantidad>minMaxClima){
														log.debug(">>>>>entro IF1 new");
														log.debug("cantidad: "+cantidad);
														log.debug("totalRefri+totalExceRefri+cantidad) - minMaxClima>>>>> ("+totalRefri+"+"+totalExceRefri+"+"+cantidad+") - "+minMaxClima+")");//ICR 18052015
														cantidad = (totalRefri+totalExceRefri+cantidad) - minMaxClima;
														log.debug("cantidad: "+cantidad);
														
														//obtenemos el movimiento de "refrigerio clima laboral" y seteamos en 120 el total
														acumDetalleRefri = (HashMap) acumulados.get(Constantes.MOV_REFRI_CLIMALABORAL);
														log.debug("acumDetalleRefri: "+acumDetalleRefri);
														acumDetalleRefri.put("total", ""+ (Math.round(minMaxClima)));
														acumulados.put(Constantes.MOV_REFRI_CLIMALABORAL, acumDetalleRefri);
														log.debug("acumDetalleRefri2: "+acumDetalleRefri);
														//acumulamos al periodo los 120 min por el movimiento de "refrigerio clima laboral"  
														acumPerRefri= (HashMap) acumPeriodo.get(Constantes.MOV_REFRI_CLIMALABORAL);												
														float totPer = new Float(acumPerRefri.get("total").toString()).floatValue();
														log.debug("totPer: "+totPer);
														log.debug("minMaxClima: "+minMaxClima);
														log.debug("totalRefri: "+totalRefri);
														acumPerRefri.put("total", "" + (Math.round(totPer + (minMaxClima-totalRefri))));
														acumPeriodo.put(Constantes.MOV_REFRI_CLIMALABORAL, acumPerRefri);
														log.debug("acumPerRefri: "+acumPerRefri);
														log.debug(">>>>>sale IF1");
													}	
													
												}else{//linea add ICAPUNAY - PAS20175E230300069
													if (totalRefri+totalExceRefri+cantidad>turno.getMinutosRefrigerio()){
														log.debug(">>>>>entro IF");
														log.debug("cantidad: "+cantidad);
														log.debug("totalRefri+totalExceRefri+cantidad) - turno.getMinutosRefrigerio()>>>>> ("+totalRefri+"+"+totalExceRefri+"+"+cantidad+") - "+turno.getMinutosRefrigerio()+")");//ICR 18052015
														cantidad = (totalRefri+totalExceRefri+cantidad) - turno.getMinutosRefrigerio();
														log.debug("cantidad: "+cantidad);
														
														//obtenemos el movimiento de refrigerio y seteamos en 60 el total
														acumDetalleRefri = (HashMap) acumulados.get(Constantes.MOV_REFRIGERIO);
														log.debug("acumDetalleRefri: "+acumDetalleRefri);
														acumDetalleRefri.put("total", ""+ (Math.round(turno.getMinutosRefrigerio())));
														acumulados.put(Constantes.MOV_REFRIGERIO, acumDetalleRefri);
														log.debug("acumDetalleRefri2: "+acumDetalleRefri);
														//acumulamos al periodo los 60 min por el movimiento de refrigerio 
														acumPerRefri= (HashMap) acumPeriodo.get(Constantes.MOV_REFRIGERIO);												
														float totPer = new Float(acumPerRefri.get("total").toString()).floatValue();
														log.debug("totPer: "+totPer);
														log.debug("turno.getMinutosRefrigerio(): "+turno.getMinutosRefrigerio());
														log.debug("totalRefri: "+totalRefri);
														acumPerRefri.put("total", "" + (Math.round(totPer + (turno.getMinutosRefrigerio()-totalRefri))));
														acumPeriodo.put(Constantes.MOV_REFRIGERIO, acumPerRefri);
														log.debug("acumPerRefri: "+acumPerRefri);
														log.debug(">>>>>sale IF");
													}	
												}//linea add ICAPUNAY - PAS20175E230300069													
												log.debug(">>>>>cantidad1: "+cantidad);
												//FIN ICR 18052015									
											}
										}//ICR 18052015
										
										log.debug(">>>>>cantidad2: "+cantidad);//ICR 18052015									
										log.debug(">>>>>(Math.round(total + cantidad)): Math.round("+total +"+" +cantidad+")");
										//acumulamos el diario
										acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
										acumulados.put(mov, acumDetalle);
										log.debug("total_Planilla: "+total);//ICR 18052015
										log.debug("cantidad_Planilla: "+cantidad);//ICR 18052015
										log.debug("mov exceso_Planilla: "+mov);//ICR 18052015
										log.debug("acumDetalle_Planilla: "+acumDetalle);//ICR 18052015
										//acumulamos el periodo
										float totPer = new Float(acumPer.get("total").toString()).floatValue();
										acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
										acumPeriodo.put(mov, acumPer);
										log.debug("totPer_Planilla: "+totPer);//ICR 18052015
										log.debug("acumPeriodo_Planilla: "+acumPeriodo);//ICR 18052015
									}

									//movimientos de salida
									if (salida) {
										bPrimMarca = false;

										if (proceso.get("hing") != null && !proceso.get("hing").toString().trim().equals(Constantes.SALIDA)) {
											
											/****** JRR - 28/04/2009 *******/
											if (log.isDebugEnabled()) {
												log.debug("SALIDA");
												log.debug("fing + turno.getHoraFin(): " + fing+ " "+turno.getHoraFin());
												log.debug("fing + proceso.get('hing').toString(): " + fing+ " "+ proceso.get("hing").toString());
											}
											
											float minutos = Utiles.obtenerMinutosDiferencia(turno.getHoraIni(), proceso.get("hing").toString());
											if (log.isDebugEnabled()) log.debug("minutos: " + minutos);
											//Salida anticipada
											if (minutos <0) {
												cantidad = Utiles
												.calculaAcumulado(
														medida,
														Utiles.stringToTimestamp(fing+ " "+ turno.getHoraIni()),
														Utiles.stringToTimestamp(fing+ " "+ turno.getHoraFin()));
											} else {
											/*****************************/

												cantidad = Utiles
												.calculaAcumulado(
														medida,
														Utiles.stringToTimestamp(fing+ " "+ turno.getHoraFin()),
														Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()));

											}

											if (log.isDebugEnabled()) log.debug("CANTIDAD antes de validar compensacion: " + cantidad);
											
											//en caso el turno sea onomastico se debe trabajar 1 hora mas
											cantidad-=turnoDAO.findHorasCompensa(dbpool,codPers,fReal);

											//salida anticipada
											if (cantidad < 0) {
												cantidad *= -1;
											}
											
//											EBV 05/01/2009
											//Si existe el movimiento pero le ponemos 1 a fin de que grabe
											if (cantidad == 0) cantidad = 1;
											//EBV 05/01/2009

											//acumulamos el diario
											//acumDetalle.put("total", ""+ (total + cantidad));
											acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
											acumulados.put(mov, acumDetalle);

											//acumulamos el periodo
											float totPer = new Float(acumPer.get("total").toString()).floatValue();
											acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
											//acumPer.put("total", ""+ (totPer + cantidad));
											acumPeriodo.put(mov, acumPer);

										}
									}
									
									//en caso sean papeletas
									
									if (tipo.trim().equals(Constantes.TIPO_MOV_PAPELETA)) {
										if (log.isDebugEnabled()) log.debug("Entre Papeletas Planilla");
										if (indPap.equals("1")){ //Si esta Marcado el Flag de Incluir Papeletas
										procesarPapeleta = true;
										
										String horaIni = proceso.get("hing").toString();
										String horaFin = proceso.get("hsal")!=null?proceso.get("hsal").toString():"";
										if (log.isDebugEnabled()) log.debug("Entre Papeletas "+ horaIni +" - " + horaFin);
										//log.debug("Entre Papeletas "+ horaIni +" - " + horaFin.trim().length());
										if (horaFin == null || horaFin.equals("") || horaFin.trim().length()== 0) {
										    //primera marca
											if (log.isDebugEnabled()) log.debug("Primera Marca "+ bPrimMarca);
											if (bPrimMarca) {
												horaIni = turno.getHoraIni();
												horaFin = proceso.get("hing").toString();
											}
											//movimiento de salida
											else {
												bUltMarca=true;
												horaIni = proceso.get("hing").toString();
												horaFin = turno.getHoraFin();
											}
										} else //EBV 18/02/2009 Se pone en False la primera y ultima marca para los demas movimientos
										{
											bUltMarca=false;
											bUltMarca=false;

										}

										if (log.isDebugEnabled()) log.debug("Turno "+turno);
										if (log.isDebugEnabled()) log.debug("Proceso "+proceso);
										if (log.isDebugEnabled()) log.debug("Entre Papeletas "+ horaIni +" - " + horaFin);
										//si estan aceptadas
										if (proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_ACEPTADA)
											|| proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_PROCESADA)
											|| proceso.get("estado_id").toString().trim().equals(Constantes.ASISTENCIA_CALIFICADA)) {
											if (log.isDebugEnabled()) log.debug("Entre Papeletas Aceptadas Procesadas_Planilla");
											if (horaFin != null && !horaFin.equals(Constantes.SALIDA)) {
												
												cantidad = Utiles
														.calculaAcumulado(																
																Constantes.MINUTO,																
												Utiles.stringToTimestamp(fing+ " "+ horaIni),
												Utiles.stringToTimestamp(fing+ " "+ horaFin));
												
												if (log.isDebugEnabled()) log.debug("Entre Papeletas Planilla "+mov +" "+ cantidad);
												
												//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
												//papeleta permiso "particular con descuento" antes y despues del turno (solo se descontara lo que afecte el turno)
												if (mov.equals(Constantes.MOV_PERMISO_SIN_GOCE) || mov.equals(Constantes.MOV_PERM_PART_CON_DESCUENTO_100) ){ //ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia (permiso particular con descuento)
													log.debug("es papeleta perConDescuento03 o perConDescuento100_Planilla");//ICR 18052015
													String horaIniTurno = turno.getHoraIni().trim();
													String horaFinTurno = turno.getHoraFin().trim();
													//ICAPUNAY - PAS20165E230300132 - MSNAAF071
													log.debug("horaIni: "+horaIni);  
													log.debug("horaFin: "+horaFin); 
													log.debug("horaIniTurno: "+horaIniTurno);  
													log.debug("horaFinTurno: "+horaFinTurno);  
													log.debug("minRecuperacion: "+minRecuperacion); 
													//ICAPUNAY - PAS20165E230300132 - MSNAAF071 
													if(!horaFin.equals(horaFinTurno)){ //el proceso tiene que tener hora salida
														log.debug("hsal de movimiento es diferente hora fin turno_Planilla");//ICR 18052015
														//entrada
														if(horaIni.compareTo(horaIniTurno)<0 &&
														   horaFin.compareTo(horaIniTurno)>0){
															log.debug("es perConDescuento03 o perConDescuento100 que afecta entrada_Planilla");//ICR 18052015
															float cantidadDescontable = Utiles.calculaAcumulado(
																			Constantes.MINUTO,
																			Utiles.stringToTimestamp(fing+ " "+ horaIniTurno),
																			Utiles.stringToTimestamp(fing+ " "+ horaFin));
															cantidad = cantidadDescontable;													
														}
														//salida (pero despues se regresa)
														//if(horaIni.compareTo(horaFinTurno)<0 && ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
														if(( (horaIni.compareTo(horaFinTurno)<0) || (horaIni.compareTo(horaFinTurno)>0 && minRecuperacion==60)) && //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
														   horaFin.compareTo(horaFinTurno)>0){
															log.debug("es perConDescuento03 o perConDescuento100 que afecta salida_Planilla");//ICR 18052015
															
															//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios												
															if (!horaFinTurno.substring(0,2).trim().equals("23")){//hora <> 23	
																log.debug("horaFinTurno anterior: "+horaFinTurno);
																if(minRecuperacion>0){ //ICAPUNAY - PAS20165E230300132 - MSNAAF071 (add solo esta linea)
																	//aumentando a la hora final del turno 1 hora por la hora de recuperacion
																	String shora = horaFinTurno.substring(0,2); //08 de 08:55:47
																	String sresto = horaFinTurno.substring(2,horaFinTurno.length()); //:55:47
																	int hora = Integer.parseInt(shora);														
																	hora = hora + 1; 
																	log.debug("hora aumentada: "+hora);
																	if (hora < 10){//anteponemos el 0 delante (caso2: 9)
																		shora = "0"+String.valueOf(hora)+sresto;// (caso2: 09:55:47)														
																	}else{
																		shora = String.valueOf(hora)+sresto;//14:55:47														
																	}	
																	horaFinTurno=shora;
																	log.debug("horaFinTurno con recuperacion: "+ horaFinTurno);
																} //ICAPUNAY - PAS20165E230300132 - MSNAAF071 (add solo esta linea)	
															}else{//hora = 23
																horaFinTurno="23:59:59";
															}
															log.debug("horaFinTurno final: "+ horaFinTurno);
															log.debug("horaFin: "+ horaFin);
															//FIN ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
															
															if (horaFin.compareTo(horaFinTurno)>0){ //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
																float cantidadDescontable = Utiles.calculaAcumulado(
																				Constantes.MINUTO,
																				Utiles.stringToTimestamp(fing+ " "+ horaIni),
																				Utiles.stringToTimestamp(fing+ " "+ horaFinTurno));
																cantidad = cantidadDescontable;
															}//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
														}														
														log.debug("cantidad(perConDescuento03 o perConDescuento100 real)_Planilla: "+cantidad);//ICR 18052015
													}
													//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
													else{
														log.debug("hsal de movimiento es IGUAL a hora fin turno_Planilla");
														if(minRecuperacion>0){
															log.debug("es perConDescuento03 o perConDescuento100_minRecuperacion3:"+minRecuperacion);
															cantidad = cantidad + minRecuperacion;
														}
														log.debug("es perConDescuento03 o perConDescuento100_cantidad3:"+cantidad);
													}
													//FIN ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
												}
												//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
												
												if (cantidad > 480 && (mov.equals(Constantes.MOV_PERMISO_SIN_GOCE) || mov.equals(Constantes.MOV_PERM_PART_CON_DESCUENTO_100))){
													log.debug("cantidad > 480");//BORRAR 25/06
													recalifica = Constantes.MOV_INASISTENCIA;
													acumDetalle = (HashMap) acumulados.get(Constantes.MOV_INASISTENCIA);
													acumDetalle.put("total", "1");
													acumulados.put(Constantes.MOV_INASISTENCIA,acumDetalle);
													//	acumulamos del periodo
													acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_INASISTENCIA);
													float totPer = new Float(acumPer.get("total").toString()).floatValue();
													acumPer.put("total", "" + (totPer + 1));
													acumPeriodo.put(Constantes.MOV_INASISTENCIA, acumPer);
												} else{
													//ICR 03/07/2015
													if (cantidad < 0) {
														cantidad *= -1;
													}
													//FIN ICR
													
													//acumulamos el diario
													log.debug("no sobrepasa 480(total diario):"+total);//BORRAR 25/06
													log.debug("no sobrepasa 480(cantidad diario):"+cantidad);//BORRAR 25/06
													acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
													acumulados.put(mov,acumDetalle);
													log.debug("no sobrepasa 480(acumDetalle):"+acumDetalle);//BORRAR 25/06
												
													//acumulamos el periodo
													float totPer = new Float(acumPer.get("total").toString()).floatValue();
													acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
													acumPeriodo.put(mov,acumPer);
													log.debug("no sobrepasa 480(totPer mensual):"+totPer);//BORRAR 25/06
													log.debug("no sobrepasa 480(cantidad mensual):"+cantidad);//BORRAR 25/06													
													log.debug("no sobrepasa 480(acumPer):"+acumPer);//BORRAR 25/06
												}												
											}
										}
										//si estan rechazadas o registradas
										else if (proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_RECHAZADA)
											     || proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_REGISTRADA)) {
								//EBV - 09072008 - Papeletas	
									           //se recalifica a un movimiento descontable
									           recalifica = Constantes.MOV_PAPELETA_NO_AUTORIZADA;
									           //recalifica = Constantes.MOV_SALIDA_NO_AUTORIZADA;
									           
									           if (horaFin != null && !horaFin.equals(Constantes.SALIDA)) {
									 
									            if (bPrimMarca) {
									 
									             
									             String horaLim = turno.getHoraLimite();
									             
									             if (horaLim != null && !horaLim.equals("")) {
									              recalifica = preCalificarEntrada(
									                fing,
									                proceso.get("hing").toString(),
									                turno.getHoraIni(),
									                turno.getTolera(),
									                turno.getHoraLimite(),
									                Constantes.MINUTO);
									              /*EBV 03/07/2008
									              cantidad = Utiles
									              .calculaAcumulado(
									                medida,
//									                Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ horaLim),
//									                Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ proceso.getHoraIni()));
									              Utiles.stringToTimestamp(fing+ " "+ horaLim),
									              Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()));
									              
									              log.debug("papeleta no autorizada "+ cantidad);
									              
									              if (cantidad >0 ) recalifica = Constantes.MOV_INASISTENCIA;
									              else recalifica = Constantes.MOV_TARDANZA_SIN_DESCUENTO;
									              */
									              //cantidad de minutos de tardanza
									              cantidad = Utiles
									                .calculaAcumulado(
									                	Constantes.MINUTO,
//									                  Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ turno.getHoraIni()),
//									                  Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ proceso.getHoraIni()));
									              Utiles.stringToTimestamp(fing+ " "+ turno.getHoraIni()),
									              Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()));
									 
									              if (log.isDebugEnabled()) log.debug("acumulados-cantidad " + cantidad);
									              if (cantidad < 0) cantidad *= -1;
									              
									              acumDetalle = (HashMap) acumulados.get(recalifica);
									              total = new Float(acumDetalle.get("total").toString()).floatValue();
									              if (recalifica.equals(Constantes.MOV_INASISTENCIA)){
									               
									               acumDetalle.put("total", "1");
									               acumulados.put(Constantes.MOV_INASISTENCIA,acumDetalle);
									               // acumulamos del periodo
									               acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_INASISTENCIA);
									               float totPer = new Float(acumPer.get("total").toString()).floatValue();
									               acumPer.put("total", "" + (totPer + 1));
									               acumPeriodo.put(Constantes.MOV_INASISTENCIA, acumPer);
									              } else{
									              //acumulamos el diario
//									              acumulamos el diario
									              acumPer = (HashMap) acumPeriodo.get(recalifica);
									              acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
									              acumulados.put(recalifica, acumDetalle);
									              
									              //acumulamos el periodo
									              float totPer = new Float(acumPer.get("total").toString()).floatValue();
									              acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
									              acumPeriodo.put(recalifica, acumPer);
									              }
									             }
									            } else {
									             cantidad = Utiles
									             .calculaAcumulado(
									               medida,
//									               Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ horaIni),
//									               Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ horaFin));
									             Utiles.stringToTimestamp(fing+ " "+ horaIni),
									             Utiles.stringToTimestamp(fing+ " "+ horaFin));
									 
									             if (cantidad < 0) cantidad *= -1;
									             
									             /*if (cantidad > 480  ){
									              recalifica = Constantes.MOV_INASISTENCIA;
									              acumDetalle = (HashMap) acumulados.get(Constantes.MOV_INASISTENCIA);
									              acumDetalle.put("total", "1");
									              acumulados.put(Constantes.MOV_INASISTENCIA,acumDetalle);
									              // acumulamos del periodo
									              acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_INASISTENCIA);
									              float totPer = new Float(acumPer.get("total").toString()).floatValue();
									              acumPer.put("total", "" + (totPer + 1));
									              acumPeriodo.put(Constantes.MOV_INASISTENCIA, acumPer);
									             } else{
									      */
									             // acumulamos el diario
									             if ((Constantes.TURNO_RS067).equals(turno.getTurno().trim())){
									            	 recalifica = Constantes.MOV_RESOLUCION_067;
								            	} else {
								            		
								            		if (!bUltMarca) {
								            			recalifica = preCalificarMovimiento(
									            				fing,
									            				horaIni,
									            				horaFin,
									            				turno,
									            				Constantes.MINUTO,
									            				false,
									            				turno.isOperativo());
								               			if (Utiles.obtenerDiasDiferencia(fechaIniNSA ,fing)>=0) {
								               				/*EBV 27/03/2015 CAMBIO POR LINEAMIENTO
                                                                                                        if (recalifica.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
								               					recalifica = Constantes.MOV_SALIDA_AUTORIZADA;
								               					if (log.isDebugEnabled()) {
								               						log.debug("cambio insertamos en proceso " + recalifica);
								               					}
								               				}
                                                                                                       */
								               			}
								               			
								               			
								               			//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
														//salida no autorizada antes y despues del turno (solo se descontara lo que afecte el turno)
														if (recalifica.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)){ 
															log.debug("es SNA_Planilla(papeleta generada)");//ICR 18052015
															String horaIniTurno = turno.getHoraIni().trim();
															String horaFinTurno = turno.getHoraFin().trim();
															if(!horaFin.equals(horaFinTurno)){ //el proceso tiene que tener hora salida
																log.debug("hsal de movimiento es diferente hora fin turno_Planilla");//ICR 18052015
																//entrada
																if(horaIni.compareTo(horaIniTurno)<0 &&
																   horaFin.compareTo(horaIniTurno)>0){
																	log.debug("es SNA que afecta entrada_Planilla");//ICR 18052015
																	float cantidadDescontable = Utiles.calculaAcumulado(
																					Constantes.MINUTO,
																					Utiles.stringToTimestamp(fing+ " "+ horaIniTurno),
																					Utiles.stringToTimestamp(fing+ " "+ horaFin));
																	cantidad = cantidadDescontable;													
																}
																//salida (pero despues se regresa)
																if(horaIni.compareTo(horaFinTurno)<0 &&
																   horaFin.compareTo(horaFinTurno)>0){
																	log.debug("es SNA que afecta salida_Planilla");//ICR 18052015
																	float cantidadDescontable = Utiles.calculaAcumulado(
																					Constantes.MINUTO,
																					Utiles.stringToTimestamp(fing+ " "+ horaIni),
																					Utiles.stringToTimestamp(fing+ " "+ horaFinTurno));
																	cantidad = cantidadDescontable;
																}
																log.debug("cantidad(SNA real)_Planilla: "+cantidad);//ICR 18052015
															}
														}
														//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
								            
								            	
								            		}
								            		else{
														recalifica = preCalificarSalida(
																dbpool,
																codPers,
																fing,
																horaIni,
																horaFin,
																Constantes.MINUTO);
								            		}
								            	}
									             

									             acumDetalle = (HashMap) acumulados.get(recalifica);
									             total = new Float(acumDetalle.get("total").toString()).floatValue();
									             //acumDetalle.put("total",""+ (total + cantidad));
									             acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
									             acumulados.put(recalifica,acumDetalle);
									             if (log.isDebugEnabled()) log.debug("acumulados" + acumulados);
									             // acumulamos el periodo
									             acumPer = (HashMap) acumPeriodo.get(recalifica);
									             float totPer = new Float(acumPer.get("total").toString()).floatValue();
									             //acumPer.put("total",""+ (totPer + cantidad));
									             acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
									             acumPeriodo.put(recalifica,acumPer);
									             //}
									            }
									           }
									          }
								//fin Papeletas EBV	
									
									//las papeletas se cambian a estado procesada									
									if (procesarPapeleta) {
										
										/*asisDAO.updatePapeletaByFecha(
														dbpool,
														codPers,
														proceso.getPeriodo(),
														proceso.getFechaIni(),
														proceso.getHoraIni(),
														recalifica,
														Constantes.PAPELETA_PROCESADA);*/
										//PRAC-JCALLO
										Map prms = new HashMap();
										prms.put("cod_pers", codPers);
										prms.put("periodo", proceso.get("periodo").toString());//proceso.getPeriodo());
										prms.put("fechaIni", fing);//proceso.getFechaIni());
										prms.put("horaIni", proceso.get("hing").toString());//proceso.getHoraIni());
										prms.put("mov", recalifica);
										prms.put("estado", Constantes.PAPELETA_PROCESADA);
										if (log.isDebugEnabled()) log.debug("asisDAO.updatePapeletaByFecha(prms)... prms:"+prms);
										
								//JRR - 18072008 Papeletas v2
								        if ( (!proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_REGISTRADA)) &&
									            (!proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_RECHAZADA)) ) {
									           asisDAO.updatePapeletaByFecha(prms);
									          }
										
										
										log_papeleta.info("Proceso|".
												concat(codPers).
												concat("|").
												concat(fing).
												concat("|").
												concat(proceso.get("hing").toString()).
												concat("|").
												concat(proceso.get("mov").toString()).
												concat("|").
												concat(recalifica)
										);										
									}
										}
										//EBV 16/02/2009 Se pone en False la primera marca para los demas movimientos
										bPrimMarca = false;
									}

									//en caso sea otro tipo de movimiento
									if (!movEspecial) {
										bPrimMarca = false;

										if (log.isDebugEnabled()) log.debug("Entro Mov. Especial" + movEspecial);
										//String horaFinal = proceso.getHoraFin();
										String horaFinal = proceso.get("hsal").toString();

										
										if (horaFinal == null || horaFinal.equals("") || horaFinal.trim().length()== 0) {
											horaFinal = turno.getHoraFin();
										}
										
										cantidad = Utiles
												.calculaAcumulado(
														//medida,
														Constantes.MINUTO,
//														Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ proceso.getHoraIni()),
//														Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ horaFinal));
										Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()),
										Utiles.stringToTimestamp(fing+ " "+ horaFinal));
										log.debug("otro Mov(Planilla)_cantidad:"+cantidad);// ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
										
										//ICR 18052015
										//salida no autorizada antes y despues del turno (solo se descontara lo que afecte el turno)
										if (mov.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)){ 
											log.debug("es SNA_Planilla");//ICR 18052015
											String horaIniTurno = turno.getHoraIni().trim();
											String horaFinTurno = turno.getHoraFin().trim();
											String horaIniProceso = proceso.get("hing").toString().trim();
											String horaFinProceso = horaFinal.trim();
											if(!horaFinProceso.equals(horaFinTurno)){ //el proceso tiene que tener hora salida
												log.debug("hsal de movimiento es diferente hora fin turno_Planilla");//ICR 18052015
												//entrada
												if(horaIniProceso.compareTo(horaIniTurno)<0 &&
												   horaFinProceso.compareTo(horaIniTurno)>0){
													log.debug("es SNA que afecta entrada_Planilla");//ICR 18052015
													float cantidadDescontable = Utiles.calculaAcumulado(
																	Constantes.MINUTO,
																	Utiles.stringToTimestamp(fing+ " "+ horaIniTurno),
																	Utiles.stringToTimestamp(fing+ " "+ horaFinProceso));
													cantidad = cantidadDescontable;													
												}
												//salida (pero despues se regresa)
												//if(horaIniProceso.compareTo(horaFinTurno)<0 &&  ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
												if(( (horaIniProceso.compareTo(horaFinTurno)<0) || (horaIniProceso.compareTo(horaFinTurno)>0 && minRecuperacion==60)) &&  //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
												   horaFinProceso.compareTo(horaFinTurno)>0){ 
													log.debug("es SNA que afecta salida_Planilla");//ICR 18052015
													
													//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios												
													if (!horaFinTurno.substring(0,2).trim().equals("23")){//hora <> 23	
														log.debug("horaFinTurno anterior: "+horaFinTurno);
														if(minRecuperacion>0){ //ICAPUNAY - PAS20165E230300132 - MSNAAF071 (add solo esta linea)
															//aumentando a la hora final del turno 1 hora por la hora de recuperacion
															String shora = horaFinTurno.substring(0,2); //08 de 08:55:47
															String sresto = horaFinTurno.substring(2,horaFinTurno.length()); //:55:47
															int hora = Integer.parseInt(shora);														
															hora = hora + 1; 
															log.debug("hora aumentada: "+hora);
															if (hora < 10){//anteponemos el 0 delante (caso2: 9)
																shora = "0"+String.valueOf(hora)+sresto;// (caso2: 09:55:47)														
															}else{
																shora = String.valueOf(hora)+sresto;//14:55:47														
															}	
															horaFinTurno=shora;
															log.debug("horaFinTurno con recuperacion: "+ horaFinTurno);	
														} //ICAPUNAY - PAS20165E230300132 - MSNAAF071 (add solo esta linea)		
													}else{//hora = 23
														horaFinTurno="23:59:59";
													}
													log.debug("horaFinTurno final: "+ horaFinTurno);
													log.debug("horaFinProceso: "+ horaFinProceso);
													//FIN ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
													
													if (horaFinProceso.compareTo(horaFinTurno)>0){ //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
													
														float cantidadDescontable = Utiles.calculaAcumulado(
																		Constantes.MINUTO,
																		Utiles.stringToTimestamp(fing+ " "+ horaIniProceso),
																		Utiles.stringToTimestamp(fing+ " "+ horaFinTurno));
														cantidad = cantidadDescontable;														
													}//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
												}
												log.debug("cantidad(SNA real)_Planilla: "+cantidad);//ICR 18052015
											}
											//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
											else{
												log.debug("hsal de movimiento es IGUAL a hora fin turno_Planilla");
												if(minRecuperacion>0){
													log.debug("otro Mov(planilla)_minRecuperacion3:"+minRecuperacion);
													cantidad = cantidad + minRecuperacion;
												}
												log.debug("otro Mov(planilla)_cantidad3:"+cantidad);
											}
											//FIN ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
										}
										//FIN ICR 18052015

										//acumulamos el diario
										if (log.isDebugEnabled()) log.debug("Total: " + total);
										if (log.isDebugEnabled()) log.debug("Cantidad: " + cantidad);
										//acumDetalle.put("total", ""+ (total + cantidad));
										
										if (cantidad <0) cantidad = cantidad*(-1);

										//Descomentar si no funciona EBV 02/10/2008
										acumDetalle = (HashMap) acumulados.get(mov);
							            total = new Float(acumDetalle.get("total").toString()).floatValue();
							            
										acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
										acumulados.put(mov, acumDetalle);
										
										//acumulamos del periodo
										float totPer = new Float(acumPer.get("total").toString()).floatValue();
										//acumPer.put("total", ""+ (totPer + cantidad));
										acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
										
										
										acumPeriodo.put(mov, acumPer);
										
									}
								}
							}
						} //end del for de detalles de movimientos del dia
						
					} else {
						//el trabajador no posee marcaciones
						bInasistencia = turno.isControla();
						//EBV Turno Rs 067 - 24/09/2007
						if ((Constantes.TURNO_RS067).equals(turno.getTurno().trim())){
							bInasistencia = true;
						}
				    //EBV-JRR Turnos sin marcaciones - 24/09/2008						
						else {
							   if (log.isDebugEnabled()) log.debug("Turnos sin marcaciones y no es R67");
						       if ((!turno.isControla())&& diaLaborable){
						        acumDetalle = (HashMap) acumulados.get(Constantes.MOV_TRABAJO_CAMPO);
						        acumDetalle.put("total", "1");
						        acumulados.put(Constantes.MOV_TRABAJO_CAMPO,acumDetalle);
						        //acumulamos del periodo
						        acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_TRABAJO_CAMPO);
						        float totPer = new Float(acumPer.get("total").toString()).floatValue();
						        acumPer.put("total", "" + (totPer + 1));
						        acumPeriodo.put(Constantes.MOV_TRABAJO_CAMPO, acumPer);
						        
						       } 
						      }
					//		
						

					}
					
					//si no es un dia laborable 
					if (!diaLaborable) bInasistencia = false;
						
				} else {
					
					bInasistencia = true;
					//no posee turno					
					if (turno==null) bInasistencia = false;
					//esta de vacaciones o licencia					
					else if (bVacacion || bLicencia) bInasistencia = false;					
				}
				
				//si falto ese dia
				if (bInasistencia) {
					
					//output.println("El trabajador no asistio el " + fReal);

					//obtenemos el movimiento de vacaciones e incrementamos el numero de dias
					acumDetalle = (HashMap) acumulados.get(Constantes.MOV_INASISTENCIA);
					acumDetalle.put("total", "1");
					acumulados.put(Constantes.MOV_INASISTENCIA,acumDetalle);
					//acumulamos del periodo
					acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_INASISTENCIA);
					float totPer = new Float(acumPer.get("total").toString()).floatValue();
					acumPer.put("total", "" + (totPer + 1));
					acumPeriodo.put(Constantes.MOV_INASISTENCIA, acumPer);
				}

				//Aqui debemos incluir el acumulado del movimiento 98 - Tardanza Efectiva para 
				//que sea igual al exceso de la Tardanza Con Descuento
				if (log.isDebugEnabled()) log.debug("Calculando tardanza efectiva");
				acumDetalle = (HashMap) acumulados.get(Constantes.MOV_TARDANZA_CON_DESCUENTO);
				float totDetalle = new Float(acumDetalle.get("total").toString()).floatValue();
				if (log.isDebugEnabled()) log.debug("Total Tardanza C/Desc : "+totDetalle);
				if (totDetalle>0){
					acumDetalle = (HashMap) acumulados.get(Constantes.MOV_TARDANZA_EFECTIVA);
					float totTardEfect = totDetalle-turno.getTolera();
					if (log.isDebugEnabled()) log.debug("Total Tardanza Efectiva : "+totTardEfect);
					acumDetalle.put("total", ""+totTardEfect);
					acumulados.put(Constantes.MOV_TARDANZA_EFECTIVA,acumDetalle);
					//vamos acumulando en el acumPeriodo el total del movimiento 98
					acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_TARDANZA_EFECTIVA);
					float totPer = new Float(acumPer.get("total").toString()).floatValue();
					acumPer.put("total", "" + (totPer + totTardEfect));
					acumPeriodo.put(Constantes.MOV_TARDANZA_EFECTIVA, acumPer);					
				}
				
				//registramos el resumen del dia
				for (int z = 0; z < movimientos.size(); z++) {

					BeanTipoMovimiento mov = (BeanTipoMovimiento) movimientos.get(z);
					HashMap acumulado = (HashMap) acumulados.get(mov.getMov().trim());
					if (log.isDebugEnabled()) log.debug("Acumulado " + acumulado);
					if (acumulado != null) {
						float total = new Float(acumulado.get("total").toString()).floatValue();
						if (log.isDebugEnabled()) log.debug("Total " + total);
						//Comentado EBV-..28/02/2006 -- Se insertan todos los movientos que se tienen para ese periodo.
						if (total > 0) {
							if (log.isDebugEnabled()) log.debug("DIARIO : " + mov.getDescrip()+ " - Total : " + total);
							//output.println("DIARIO : " + mov.getDescrip()+ " - Total : " + total);
							//EBV 16/05/2006 Se Redondean los montos
							total = Math.round(total);
							if (log.isDebugEnabled()) log.debug("RESUMEN REDONDEO : " + mov.getDescrip()+ " - Total : " + total);
							//prueba = Math.abs(total);
							//log.debug("RESUMEN ABSOLUTO: " + mov.getDescrip()+ " - Total : " + prueba);
							//double prueba1 = Math.floor(total);
							//log.debug("RESUMEN TRUNCAR : " + mov.getDescrip()+ " - Total : " + prueba1);
							diarioDAO.insertByCodPersPeriodoMov(dbpool,codPers, periodo, fReal, codUO, mov.getMov().trim(), total, usuario);
						}
						acumulado.put("total", "0");
						acumulados.put(mov.getMov(), acumulado);
					}
				} //for registro diario
				
				if (fReal.indexOf("/")>3){ 
					fReal = fReal.substring(8,10) + "/" + fReal.substring(5,7) + "/" + fReal.substring(0,4) ;
				}
				
				fReal =  Utiles.dameFechaSiguiente(fReal, 1);
				fAct = Utiles.toYYYYMMDD(fReal);
			}

			//aqui debemos validar el tema de la tardanza efectiva
			HashMap acumTardCDesc = (HashMap) acumPeriodo.get(Constantes.MOV_TARDANZA_CON_DESCUENTO);
			HashMap acumTardSDesc = (HashMap) acumPeriodo.get(Constantes.MOV_TARDANZA_SIN_DESCUENTO);
			
			//T99DAO codigoDAO = new T99DAO();
			String minutosSinDesc = codigoDAO.findParamByCodTabCodigo(dbpool,
					Constantes.CODTAB_PARAMETROS_ASISTENCIA,
					Constantes.MINUTOS_SIN_DESCUENTO);
			int minSinDesc = minutosSinDesc != null ? Integer.parseInt(minutosSinDesc) : 0;
			
			if (log.isDebugEnabled()) log.debug("minSinDesc : "+minSinDesc);
			
			float tTardanzaCDesc = new Float(acumTardCDesc.get("total").toString()).floatValue();
			if (log.isDebugEnabled()) log.debug("tTardanzaCDesc : "+tTardanzaCDesc);
			float tTardanzaSDesc = new Float(acumTardSDesc.get("total").toString()).floatValue();
			if (log.isDebugEnabled()) log.debug("tTardanzaSDesc : "+tTardanzaSDesc);
			boolean bTardanza = (tTardanzaSDesc + tTardanzaCDesc) > minSinDesc;
			if (log.isDebugEnabled()) log.debug("bTardanza : "+bTardanza);
			
			//si el trabajador sobrepaso el limite de minutos, se actualiza el detalle del resumen diario
			if (bTardanza){
				
				fAct = fIni;
				fReal = fechaIni;
				if (fReal.indexOf("/")>3){ 
					fReal = fReal.substring(8,10) + "/" + fReal.substring(5,7) + "/" + fReal.substring(0,4) ;
				}
				
				acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_TARDANZA_EFECTIVA);
				float totPer1 = new Float("0").floatValue();
				acumPer.put("total", "" + (totPer1));
				acumPeriodo.put(Constantes.MOV_TARDANZA_EFECTIVA, acumPer);
				
				//recorremos todos los dias del periodo 
				while (fAct.compareTo(fFin) <= 0) {
					
					if (log.isDebugEnabled()) log.debug("fReal : "+fReal);
					
					//obtenemos el turno del trabajador para la fecha en proceso
					turno = turnoDAO.joinWithT45ByCodFecha(dbpool, codPers, fReal);
					
					//14/01/2009
					if (turno!=null) {

						float minTardanza = 0;
						//float tTardCDesc = diarioDAO.findDescuentoDiarioMovimiento(
						//		dbpool, codPers, fReal, Constantes.MOV_TARDANZA_CON_DESCUENTO);

						float tTardCDesc = diarioDAO.findDescuentoDiarioMovimiento(
								dbpool, codPers, fReal, Constantes.MOV_TARDANZA_EFECTIVA);

						if (log.isDebugEnabled()) log.debug("Recalculando tTardCDesc : "+tTardCDesc);

						if (tTardCDesc>0){
							minTardanza = turno.getTolera()+tTardCDesc;
						}
						else{
							//EBV - 16/12/2008
							float tTardConDesc = diarioDAO.findDescuentoDiarioMovimiento(
									dbpool, codPers, fReal, Constantes.MOV_TARDANZA_CON_DESCUENTO);
							if (tTardConDesc==turno.getTolera()){
								minTardanza = turno.getTolera()+tTardCDesc;	
							}
							if (log.isDebugEnabled()) log.debug("Recalculando minTardanza : "+minTardanza);
							//

							float tTardSDesc = diarioDAO.findDescuentoDiarioMovimiento(
									dbpool, codPers, fReal, Constantes.MOV_TARDANZA_SIN_DESCUENTO);
							if (tTardSDesc>0) minTardanza = tTardSDesc;

							if (log.isDebugEnabled()) log.debug("Recalculando tTardSDesc : "+tTardSDesc);
						}

						if (log.isDebugEnabled()) log.debug("Recalculando minTardanza : "+minTardanza);

						if (minTardanza>0){

							//acumulamos a los minutos del movimiento 98 los minutos de tolerancia del turno para ese dia
							boolean hayMinTardEfect = diarioDAO.updateTardanzaEfectiva(
									dbpool,
									codPers, 
									periodo, 
									fReal, 
									Constantes.MOV_TARDANZA_EFECTIVA, 
									minTardanza);

							if (log.isDebugEnabled()) log.debug("hayMinTardEfect : "+hayMinTardEfect);

							if (!hayMinTardEfect){
								diarioDAO.insertByCodPersPeriodoMov(
										dbpool,
										codPers, 
										periodo, 
										fReal, 
										codUO, 
										Constantes.MOV_TARDANZA_EFECTIVA, 
										minTardanza, 
										usuario);
							}

							//actualizamos el acumulado en el acumPeriodo el total del movimiento 98
							acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_TARDANZA_EFECTIVA);
							float totPer = new Float(acumPer.get("total").toString()).floatValue();
							acumPer.put("total", "" + (totPer + minTardanza));
							acumPeriodo.put(Constantes.MOV_TARDANZA_EFECTIVA, acumPer);						
						}

					}
					
					if (fReal.indexOf("/")>3){ 
						fReal = fReal.substring(8,10) + "/" + fReal.substring(5,7) + "/" + fReal.substring(0,4) ;
					}
					
					fReal =  Utiles.dameFechaSiguiente(fReal, 1);
					fAct = Utiles.toYYYYMMDD(fReal);					
				}
			}
			
			
			//JRR - BOLSA - 17/12/2008
			Map params = new HashMap();
			Map aux_comp = new HashMap();
			List lista_compPend = new ArrayList();
			Date today = new FechaBean().getSQLDate();
			T3792DAO compDAO = new T3792DAO(dbpool);
			float total_minutos = 0;
			params.put("fec_hoy", today);
			params.put("cod_pers", codPers);
			//
			
			//registramos el resumen del periodo del trabajador
			for (int k = 0; k < movimientos.size(); k++) {
			
				BeanTipoMovimiento mov = (BeanTipoMovimiento) movimientos.get(k);
				HashMap acumulado = (HashMap) acumPeriodo.get(mov.getMov().trim());
				
				if (acumulado != null) {
					
					float total = new Float(acumulado.get("total").toString()).floatValue();
					
					/*********** BOLSA - INSERTAMOS MOV DESCUENTO ************/
					if (mov.getMov().trim().equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
						
						lista_compPend = compDAO.findCompensacionesPendByFecFin(params);
						if (log.isDebugEnabled()) log.debug("Lic. Bolsa no compensada - lista_compPend: " + lista_compPend);
						
						if (lista_compPend !=null && lista_compPend.size()>0) {
							for (int i = 0; i < lista_compPend.size(); i++) {
								aux_comp = (HashMap)lista_compPend.get(i);
									
								//Acumulo tiempo para insertarlo como movimiento de descuento
								total_minutos = total_minutos + new Float(aux_comp.get("cnt_tsaldo").toString()).floatValue();
							}
						}
						
						if (total_minutos>0) {
							if (log.isDebugEnabled()) log.debug("total_minutos: " + total_minutos);
							total = total + total_minutos;
						}
						
					}
					/*********************************************************/
					
					//Comentado EBV-..28/02/2006 -- Se insertan todos los movientos que se tienen para ese periodo.
					if (total > 0) {
						if (log.isDebugEnabled()) log.debug("RESUMEN : " + mov.getDescrip()+ " - Total : " + total);
						//EBV 16/05/2006 Se Redondean los montos
						total = Math.round(total);
						if (log.isDebugEnabled()) log.debug("RESUMEN REDONDEO : " + mov.getDescrip()+ " - Total : " + total);
						//prueba = Math.abs(total);
						//log.debug("RESUMEN ABSOLUTO : " + mov.getDescrip()+ " - Total : " + prueba);
						//double prueba1 = Math.floor(total);
						//log.debug("RESUMEN REDONDEO : " + mov.getDescrip()+ " - Total : " + prueba1);

						//output.println("RESUMEN : " + mov.getDescrip()+ " - Total : " + total);
						resumenDAO.insertByCodPersPeriodoMov(dbpool, codPers,periodo, codUO, mov.getMov().trim(),total,usuario);
					}
					acumulado.put("total", "0");
					acumPeriodo.put(mov.getMov(), acumulado);
				}
			} //for registro mensual


			
/*********************************************************			/			
			//JRR - 17/12/2008 - BOLSA	
			//Calculando si existen licencias por Comp en Bolsa que ya caducaron en este periodo y que deben ser
			//descontados. Obtenemos todas las que estan en estado 0 o 1
			Map params = new HashMap();
			Map aux_comp = new HashMap();
			Date today = new FechaBean().getSQLDate();
			log.debug(today);
			log.debug(codPers);
			
			float total_minutos = 0;
			
			//params.put("fec_hoy", new FechaBean(fechaMarcacion).getSQLDate());
			params.put("fec_hoy", today);
			params.put("cod_pers", codPers);
			T3792DAO compDAO = new T3792DAO(dbpool);
//			T1276DAO periodoDAO = new T1276DAO();
			List lista_compPend = compDAO.findCompensacionesPendByFecFin(params);
			log.debug("************ lista_compPend: " + lista_compPend);
			
			if (lista_compPend !=null) {
				for (int i = 0; i < lista_compPend.size(); i++) {
					aux_comp = (HashMap)lista_compPend.get(i);
						
					//ACUMULO TIEMPO PARA INSERTARLO COMO MOVIMIENTO DE DESCUENTO
					total_minutos = total_minutos + new Float(aux_comp.get("cnt_tsaldo").toString()).floatValue();
				}
			}
			
			if (total_minutos>0) {
				//log.debug("REGISTRO EN TABLA EL MOVIMIENTO");
				//resumenDAO.insertByCodPersPeriodoMov(dbpool, codPers,periodo, codUO, "120", total_minutos, usuario);
				log.debug("AUMENTO EN TABLA EL MOVIMIENTO 12");
				//resumenDAO.insertByCodPersPeriodoMov(dbpool, codPers,periodo, codUO, "12", total_minutos, usuario);
			}
			
			
/*********************************************************/			
			
		} catch (Exception e) {
			log.fatal("Error en el proceso del trabajador "+codPers+" : " + e.getMessage(),e);						
			//output.println("Error en el proceso del trabajador "+codPers+" : " + e.getMessage());
			throw new IncompleteConversationalState(e.toString());
		}
		return res;
	}

	/**
	 * Metodo encargado de ejecutar el proceso de calificaciones para una
	 * determinada fecha
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public boolean procesarCalificacion(HashMap mapa, String usuario)
			throws RemoteException {

		boolean res = true;
		String id = (String) mapa.get("messageID");
		String dbpool = (String) mapa.get("dbpool");
		try {

			super.creaLog(id, "PROCESO DE CALIFICACIONES", usuario);

			HashMap seguridad = (HashMap) mapa.get("seguridad");

			T1279DAO movDAO = new T1279DAO();
			T1270DAO turnoDAO = new T1270DAO();
			//prac-jcallo
			T1271DAO asisDAO = new T1271DAO(dbpool);

			String fecha = (String) mapa.get("fecha");

			BeanTurnoTrabajo turno = null;
			HashMap movimientos = movDAO.findMapByEstado(dbpool,
					Constantes.ACTIVO);

			//output.println("Procesando calificaciones del " + fecha);
			//prac-jcallo
			Map params = new HashMap();
			params.put("fecha", fecha);
			params.put("seguridad", seguridad);
			log.debug("metodo procesarCalificacion... params:"+params);
			List lista = asisDAO.findPersonalByFecha(params);//(dbpool, fecha,seguridad) FALTA CAMBIAR POR EL QUE ESTA RRHH ASISTENCIA;
			log.debug("lista.size:"+lista.size());
			HashMap trab = null;
			List detalles = null;
			//BeanProceso proceso = null;
			HashMap proceso = new HashMap();
			
			HashMap tipoMov = null; 
			    
			for (int i = 0; i < lista.size(); i++) {

				trab = (HashMap) lista.get(i);

				String codPers = (String) trab.get("codigo");

				//output.println("Trabajador : " + codPers);
				turno = turnoDAO.joinWithT45ByCodFecha(dbpool, codPers, fecha);

				//obtenemos el detalle de las calificaciones para la fecha
				//prac-jcallo
				Map prms = new HashMap();
				params.put("cod_pers", codPers);
				params.put("fing", fecha);
				log.debug("asisDAO.findByCodPersFechaPeriodo(prms)... params"+params);
				detalles = asisDAO.findByCodPersFechaPeriodo(prms);//(dbpool, codPers, fecha, "") CAMBIAR POR EL DAO DE RRHH ASISTENCIA  NO OLVIDAR QUE NO RECUPERA BEANS sino HAShMAP;

				//analizamos cada movimiento realizado en la fecha
				if (turno != null && detalles != null && detalles.size() > 0) {

					boolean tieneRefrigerio = false;

					for (int j = 0; j < detalles.size(); j++) {

						//proceso = (BeanProceso) detalles.get(j);
						proceso = (HashMap) detalles.get(j);
						//String mov = proceso.getMovimiento() != null ? proceso.getMovimiento().trim() : "";
						String mov = proceso.get("mov") != null ? proceso.get("mov").toString().trim() : "";
						String recalifica = mov;
						tipoMov = (HashMap) movimientos.get(mov);
						
						//JRR 19 mayo 2008
						//FechaBean fechaA = new FechaBean(proceso.get("fing").toString().trim());
						//String fing = fechaA.getFormatDate("dd/MM/yyyy");
						String fing = proceso.get("fing_desc").toString().trim();

						if (tipoMov != null) {

							if (!turno.isControla()){
								recalifica = Constantes.MOV_TRABAJO_CAMPO;
							}
							else{
							
								String medida = (String) tipoMov.get("medida");
	
								boolean entrada = tipoMov.get("entrada") != null ? ((String) tipoMov
										.get("entrada")).equals(Constantes.ACTIVO)
										: false;
								boolean refrigerio = tipoMov.get("refrigerio") != null ? ((String) tipoMov
										.get("refrigerio"))
										.equals(Constantes.ACTIVO)
										: false;
								boolean salida = tipoMov.get("salida") != null ? ((String) tipoMov
										.get("salida")).equals(Constantes.ACTIVO)
										: false;
	
								//si es un movimiento de entrada
								if (entrada) {
	
									int tolera = turno.getTolera();
									String horaLim = turno.getHoraLimite();
	
									if (horaLim != null && !horaLim.equals("")) {
	
										float dif = Utiles.obtenerHorasDiferencia(
//												proceso.getHoraIni(), horaLim);
												proceso.get("hing").toString(), horaLim);												
	
										if (dif <= 0) {
											recalifica = Constantes.MOV_INASISTENCIA;
										} else {
	
											//cantidad de minutos de tardanza
											float cantidad = Utiles
													.calculaAcumulado(
															medida,
//															Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ turno.getHoraIni()),
//															Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ proceso.getHoraIni()));
											Utiles.stringToTimestamp(fing+ " "+ turno.getHoraIni()),
											Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()));
	
											if (cantidad < 0) {
												recalifica = Constantes.MOV_ENTRADA_ANTICIPADA;
											} else {
	
												if (cantidad > tolera) {
													recalifica = Constantes.MOV_TARDANZA_CON_DESCUENTO;
												} else {
													if (cantidad != 0) {
														recalifica = Constantes.MOV_TARDANZA_SIN_DESCUENTO;
													}
												}
	
											}
										}
									}
								}
	
								//si es un movimiento de refrigerio
								if (refrigerio) {
	
									String refrigerioIni = turno.getHoraIniRefrigerio();
									String refrigerioFin = turno.getHoraFinRefrigerio();
	
									if (tieneRefrigerio) {
										recalifica = Constantes.MOV_EN_OBSERVACION;
									} else {
	
										float antes = Utiles.calculaAcumulado(
												medida,
//												Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ proceso.getHoraIni()),
//												Utiles.stringToTimestamp(proceso.getFechaIni()+ " " + refrigerioIni));
										Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()),
										Utiles.stringToTimestamp(fing+ " " + refrigerioIni));

										if (antes > 0) {
											recalifica = Constantes.MOV_EN_OBSERVACION;
										} else {
	
											float durante = Utiles
													.calculaAcumulado(
															medida,
//															Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ proceso.getHoraIni()),
//															Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ proceso.getHoraFin()));
											Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()),
											Utiles.stringToTimestamp(fing+ " "+ proceso.get("hsal").toString()));
	
											float despues = Utiles
													.calculaAcumulado(
															medida,
//															Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ refrigerioFin),
//															Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ proceso.getHoraIni()));
											Utiles.stringToTimestamp(fing+ " "+ refrigerioFin),
											Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()));
	
											if (despues >= 0) {
												recalifica = Constantes.MOV_EN_OBSERVACION;
											} 
											else {
												tieneRefrigerio = true;
												if (durante > turno
														.getMinutosRefrigerio()) {
													recalifica = Constantes.MOV_EXCESO_REFRIGERIO;
												} else {
													recalifica = Constantes.MOV_REFRIGERIO;
												}
											}
										}
									}
	
								}
	
								//si es un movimiento de salida
								if (salida) {
								    
//									if (proceso.getHoraIni() != null && !proceso.getHoraIni().trim().equals(Constantes.SALIDA)) {
									if (proceso.get("hing") != null && !proceso.get("hing").toString().trim().equals(Constantes.SALIDA)) {	
										float cantidad = Utiles
												.calculaAcumulado(
														medida,
//														Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ turno.getHoraFin()),
//														Utiles.stringToTimestamp(proceso.getFechaIni()+ " "+ proceso.getHoraIni()));
														Utiles.stringToTimestamp(fing+ " "+ turno.getHoraFin()),
														Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()));
	
										//en caso el turno sea onomastico se debe trabajar 1 hora mas
										cantidad-=turnoDAO.findHorasCompensa(dbpool,codPers,fecha);
	
										//salida anticipada
										if (cantidad < 0) {
											recalifica = Constantes.MOV_SALIDA_NO_AUTORIZADA;
										}
									}
								}
							}						
						}						

						//si se ha realizado una recalificacion
						if (!mov.equals(recalifica)) {
							//prac-jcallo
							Map ps = new HashMap();
							ps.put("cod_pers", codPers);
							ps.put("periodo", proceso.get("periodo").toString());//proceso.getPeriodo());
							ps.put("fechaIni", fing); //proceso.getFechaIni());
							ps.put("horaIni", proceso.get("hing").toString()); //proceso.getHoraIni());
							ps.put("mov", recalifica);
							log.debug("asisDAO.updateByCodPersFIniHIni(ps)... ps:"+ps);
							asisDAO.updateByCodPersFIniHIni(ps);/*(
									dbpool, codPers, proceso.getPeriodo(),
									proceso.getFechaIni(),
									proceso.getHoraIni(), recalifica);*/
						}
					}
				}
			}
		} catch (Exception e) {
			log.fatal(e,e);		
			//output.println("Error : " + e.getMessage());
			log.debug("Error : " + e.getMessage());
		} finally {
			try {
				//registramos el log del proceso
				super.registraLog(dbpool, mapa, usuario);
			} catch (Exception e) {
			}
		}
		return res;
	}

	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public boolean procesarMarcaciones(HashMap mapa, String usuario)
			throws RemoteException {
		
		boolean result = true;
		String id = (String) mapa.get("messageID");
		String dbpool = (String) mapa.get("dbpool");
		try {
			
			T02DAO pDAO = new T02DAO();
			T1275DAO marcaDAO = new T1275DAO();

			super.creaLog(id, "PROCESO DE MARCACIONES", usuario);

			String reloj = (String) mapa.get("reloj");
			String fechaIni = (String) mapa.get("fechaIni");
			String fechaFin = (String) mapa.get("fechaFin");
			String ruta = (String) mapa.get("ruta");
			String criterio = (String) mapa.get("criterio");
			String valor = (String) mapa.get("valor");			

			//cargamos el archivo
			BufferedReader buffer = new BufferedReader(new FileReader(ruta));
			String linea = "";
			boolean cargar = false;
			while ((linea = buffer.readLine()) != null) {

				cargar = false;
				if (linea != null && !linea.equals("")) {

					String lectora = linea.substring(0, 3);					
					if (lectora.startsWith("L")) {
						lectora = lectora.replace('L','0');
					}
					
					String anho = linea.substring(3, 7);
					String mes = linea.substring(7, 9);
					String dia = linea.substring(9, 11);
					String hora = linea.substring(11, 17);
					String registro = linea.substring(26, 30);

					if (criterio.equals("2")) cargar = true;
					else if (criterio.equals("0") && registro.trim().equalsIgnoreCase(valor.trim()) ) cargar = true;
					else if (criterio.equals("1") && pDAO.findCodPersInUUOO(dbpool,registro.trim(),valor.trim())) cargar = true;
					
					if ((reloj.equals("-1") || reloj.equalsIgnoreCase(lectora)) && cargar) {
						
						//output.println("Linea : " + linea);

						String fechaReloj = anho + "/" + mes + "/" + dia;
						String fechaReloj1 = dia + "/" + mes + "/" + anho;
						String fIni = Utiles.toYYYYMMDD(fechaIni);
						String fFin = Utiles.toYYYYMMDD(fechaFin);

						if (((fIni.equals("")) || (fIni.compareTo(fechaReloj) <= 0))
							&& ((fFin.equals("")) || (fFin.compareTo(fechaReloj) >= 0))) {

							try {
								if (!hora.startsWith(Constantes.SALIDA)) hora = Utiles.toHHMMSS(hora);
								//insertamos el registro
								marcaDAO.insertByCodPersFechaReloj(dbpool,
										registro, fechaReloj1, hora, lectora,
										usuario);
							} catch (Exception e) {
								//output.println("ERROR : " + e.toString());
								log.error("ERROR : " + e.toString());
								result = false;
							}
						}
					}
				}
			}
			
		} catch (Exception e) {
			log.fatal("Error en el proceso de generacion de marcaciones",e);		
			//output.println("Error : " + e.toString());
			result = false;
		} finally {
			try {
				//registramos el log del proceso
				super.registraLog(dbpool, mapa, usuario);
			} catch (Exception e) {
			}
		}
		return result;
	}

	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public boolean procesarMarcacionesDBF(HashMap mapa, String usuario)
			throws RemoteException {

		boolean result = true;
		String id = (String) mapa.get("messageID");
		String dbpool = (String) mapa.get("dbpool");
		try {
		
			T02DAO pDAO = new T02DAO();
			T1275DAO marcaDAO = new T1275DAO();
			super.creaLog(id, "PROCESO DE MARCACIONES", usuario);

			String reloj = (String) mapa.get("reloj");
			String fechaIni = (String) mapa.get("fechaIni");
			String fechaFin = (String) mapa.get("fechaFin");
			String ruta = (String) mapa.get("ruta");
			String criterio = (String) mapa.get("criterio");
			String valor = (String) mapa.get("valor");
			
			String fIni = Utiles.toYYYYMMDD(fechaIni);
			String fFin = Utiles.toYYYYMMDD(fechaFin);
			
				
			
			ArrayList data = AccesoDBFDAO.leerDBF(ruta);
			HashMap fila = null;
			
			boolean cargar = false;
			if (data!=null){				
				for (int i = 0; i < data.size(); i++) {

					cargar = false;
					fila = (HashMap)data.get(i);
									
					try {
						
						String linea = (String)fila.get("CADRELOJ");
						if (linea!=null){
							
							String lectora = linea.substring(0, 3);					
							if (lectora.startsWith("L")) {
								lectora = lectora.replace('L','0');
							}
							
							String anho = linea.substring(3, 7);
							String mes = linea.substring(7, 9);
							String dia = linea.substring(9, 11);
							String hora = linea.substring(11, 17);							
							String registro = linea.substring(26, 30);
							
							if (criterio.equals("2")) cargar = true;
							else if (criterio.equals("0") && registro.trim().equalsIgnoreCase(valor.trim()) ) cargar = true;
							else if (criterio.equals("1") && pDAO.findCodPersInUUOO(dbpool,registro.trim(),valor.trim())) cargar = true;
							
							if ((reloj.equals("-1") || reloj.equalsIgnoreCase(lectora)) && cargar) {
								
								String fechaReloj = anho + "/" + mes + "/" + dia;
								String fechaReloj1 = dia + "/" + mes + "/" + anho;

								if (((fIni.equals("")) || (fIni.compareTo(fechaReloj) <= 0))
										&& ((fFin.equals("")) || (fFin
												.compareTo(fechaReloj) >= 0))) {

									try {

										if (!hora.startsWith(Constantes.SALIDA)) {
											hora = Utiles.toHHMMSS(hora);
										}

										//insertamos el registro
										marcaDAO.insertByCodPersFechaReloj(dbpool,
												registro, fechaReloj1, hora, lectora,
												usuario);

									} catch (Exception e) {
										//output.println("ERROR : " + e.toString());
										//log.error("ERROR : " + e.toString());
										result = false;
									}
								}
							}
						}
						else{
							
							String codigo = ((String)fila.get("CODIGO")).trim().substring(2,6);					
							String hora = ((String)fila.get("HORA")).trim();
							String lectora = ((String)fila.get("RELOJ")).trim();
							if (lectora.length()==2) lectora = "0"+lectora; 
							String fecha = ((String)fila.get("FECHA")).trim();
							
							if (criterio.equals("2")) cargar = true;
							else if (criterio.equals("0") && codigo.trim().equalsIgnoreCase(valor.trim()) ) cargar = true;
							else if (criterio.equals("1") && pDAO.findCodPersInUUOO(dbpool,codigo.trim(),valor.trim())) cargar = true;
							
							if ((reloj.equals("-1") || reloj.equalsIgnoreCase(lectora)) && cargar) {
								
								BeanFechaHora bfh = new BeanFechaHora(fecha,"yyMMdd");
								String fechaReloj = bfh.getFormatDate("yyyy/MM/dd");
								String fechaReloj1 = bfh.getFormatDate("dd/MM/yyyy");
								if (!hora.startsWith(Constantes.SALIDA)) {
									hora = new BeanFechaHora(hora,"HHmm").getFormatDate("HH:mm:ss");
								}
														
								if (((fIni.equals("")) || (fIni.compareTo(fechaReloj) <= 0))
										&& ((fFin.equals("")) || (fFin.compareTo(fechaReloj) >= 0))) {
									
									try{
										//insertamos el registro
										marcaDAO.insertByCodPersFechaReloj(dbpool,
												codigo, fechaReloj1, hora, lectora,
												usuario);
									} catch (Exception e) {
										//output.println("ERROR : " + e.toString());
										//log.error("ERROR : " + e.toString());
										result = false;
									}										
								}
							}
						}
						
					} catch (Exception e) {
						//output.println("Error en linea " + (i+2) +" : "+ e.toString());		
						result = false;
					}
				}				
			}
			
		} catch (Exception e) {
			log.fatal("Error en el proceso de generacion de marcaciones",e);
			//output.println("Error : " + e.toString());			
			result = false;
		} finally {
			try {
				//registramos el log del proceso
				super.registraLog(dbpool, mapa, usuario);
			} catch (Exception e) {
			}
		}
		return result;
	}	
	
	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public boolean generarRegistroAsistencia(HashMap mapa, String usuario)
			throws RemoteException {

		//log.debug("inicio de metodo ProcesoFacade - generarRegistroAsistencia");
		if(log.isDebugEnabled())log.debug("ProcesoFacade - generarRegistroAsistencia - mapa: " + mapa);
		if(log.isDebugEnabled())log.debug("ProcesoFacade - generarRegistroAsistencia - usuario: " + usuario);
		
		boolean res = false;		
	    String id = (String) mapa.get("messageID");
		String dbpool = (String) mapa.get("dbpool");
		try {

			//T1275DAO daoMarca = new T1275DAO();
			T1276DAO daoPeriodo = new T1276DAO();
			T99DAO codigoDAO = new T99DAO();

			//Fecha Nueva Salida Autorizada
			String fechaIniNSA = codigoDAO.findParamByCodTabCodigo(dbpool,
					Constantes.CODTAB_PARAMETROS_ASISTENCIA,
					Constantes.FECHA_INICIO_SIRH_NSA);
			if(log.isDebugEnabled())log.debug("ProcesoFacade - generarRegistroAsistencia - fechaIniNSA: " + fechaIniNSA);
			
			String fechaEval = "";
			HashMap beanPersona = null;
			String periodo = "";
			
			HashMap fechas = new HashMap();
			fechas.put("FechaNSA",fechaIniNSA);
			
			int trabIni = Integer.parseInt((String) mapa.get("limiteInferior"));
			int trabFin = Integer.parseInt((String) mapa.get("limiteSuperior"));
			
			MantenimientoFacadeHome facadeMantHome = (MantenimientoFacadeHome) ServiceLocator.getInstance().getRemoteHome(
					MantenimientoFacadeHome.JNDI_NAME,
					MantenimientoFacadeHome.class);
			MantenimientoFacadeRemote facadeMantRemote = facadeMantHome.create();
			
			super.creaLog(id, "REGISTRO DE ASISTENCIA", usuario);

			String fechaIni = (String) mapa.get("fechaIni");
			String fechaFin = (String) mapa.get("fechaFin");
			//String criterio = (String) mapa.get("criterio");
			//String valor = (String) mapa.get("valor");

			//ASANCHEZZ 20100413
			//COMENTAMOS ESTO
			//ArrayList listaPersonal = daoMarca.joinWithT02Nested(dbpool, fechaIni, fechaFin, criterio, valor);
			DataSource dcsp = ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dcsp");
			pe.gob.sunat.rrhh.dao.T02DAO t02dao = new pe.gob.sunat.rrhh.dao.T02DAO(dcsp);
			if(log.isDebugEnabled())log.debug("ProcesoFacade - generarRegistroAsistencia - mapa: " + mapa);
			//List listaPersonal = t02dao.buscarPersonal(mapa);//ICAPUNAY 13/06/2012 PASE 2012-381 AJUSTES A LABOR EXCEPCIONAL
			List listaPersonal = t02dao.buscarPersonal_Calificacion(mapa);//ICAPUNAY 13/06/2012 PASE 2012-381 AJUSTES A LABOR EXCEPCIONAL
			//FIN
			
			int numDias = Utiles.obtenerDiasDiferencia(fechaIni, fechaFin);	
			log.debug("llego "+ listaPersonal);
			for (int i = 0; i <= numDias; i++) {				
				
				fechaEval = Utiles.dameFechaSiguiente(fechaIni, i);
				mapa.put("fechaEval",fechaEval);
				
				//obtenemos el periodo del dia 
				periodo = daoPeriodo.findByFecha(dbpool, fechaEval);
				mapa.put("periodo",periodo);
				//Es el periodo en general, el periodo de acuerdo al regimen se considerara para el procesamiento
				//de asistencia, en el caso de la generacion tendria que obtenerse por persona
				//pero no es tan relevante en la t1271, asi que no la consideramos
				
				boolean bPeriodoCerrado = false;
				String codUO = "";
				
				//ASANCHEZZ 20100426
				T1276DAO periodoDAO = new T1276DAO();
				if(log.isDebugEnabled())log.debug("ProcesoFacade - generarRegistroAsistencia - periodo: " + periodo);
				BeanPeriodo bPer = periodoDAO.findByCodigo(dbpool, periodo);
				if(log.isDebugEnabled())log.debug("ProcesoFacade - generarRegistroAsistencia - bPer: " + bPer);
				//FIN
				
				for (int j = trabIni; j <= trabFin; j++) {					
					if (j<listaPersonal.size()){
						beanPersona = (HashMap) listaPersonal.get(j);
						codUO = (String) beanPersona.get("t02cod_uorg");
						//ASANCHEZZ 20100426
						//bPeriodoCerrado = facadeMantRemote.periodoCerradoUOFecha(dbpool,fechaIni,Utiles.obtenerFechaActual(),codUO);
						if(log.isDebugEnabled())log.debug("ProcesoFacade - generarRegistroAsistencia - beanPersona: " + beanPersona);
						String t02cod_rel = (beanPersona.get("t02cod_rel")!=null) ? beanPersona.get("t02cod_rel").toString().trim() : "";
						/*
						if (t02cod_rel.equals("01") || t02cod_rel.equals("02")) {
							if(log.isDebugEnabled())log.debug("ProcesoFacade - generarRegistroAsistencia - CODIGO: " + beanPersona.get("t02cod_pers") + " PLANILLAS");
							bPeriodoCerrado = facadeMantRemote.periodoCerradoUOFecha(dbpool, bPer.getFechaIni(), Utiles.obtenerFechaActual(),codUO);
							if(log.isDebugEnabled())log.debug("ProcesoFacade - generarRegistroAsistencia - bPeriodoCerrado: " + bPeriodoCerrado);
						} else if(t02cod_rel.equals("09")) {//Para el reg. CAS
							if(log.isDebugEnabled())log.debug("ProcesoFacade - generarRegistroAsistencia - CODIGO: " + beanPersona.get("t02cod_pers") + " CAS");
							Map params = new HashMap();
							params.put("dbpool", dbpool);
							params.put("periodo", periodo);
							bPeriodoCerrado = facadeMantRemote.periodoCerradoCAS(params);
							if(log.isDebugEnabled())log.debug("ProcesoFacade - generarRegistroAsistencia - bPeriodoCerrado: " + bPeriodoCerrado);
						}
						*/
						
						//JRR - 04/03/2011
						if(t02cod_rel.equals("09")) {//Para el reg. CAS
							if(log.isDebugEnabled())log.debug("ProcesoFacade - generarRegistroAsistencia - CODIGO: " + beanPersona.get("t02cod_pers") + " CAS");
							Map params = new HashMap();
							params.put("dbpool", dbpool);
							//ICAPUNAY 21/06/2011 FORMATIVAS
							periodo = daoPeriodo.findByFechaCAS(dbpool, fechaEval);
							//ICAPUNAY 21/06/2011 FORMATIVAS
							params.put("periodo", periodo);
							bPeriodoCerrado = facadeMantRemote.periodoCerradoCAS(params);
							if(log.isDebugEnabled())log.debug("ProcesoFacade - generarRegistroAsistencia - bPeriodoCerrado: " + bPeriodoCerrado);
							
						} else if(t02cod_rel.equals("10")) {//Para Modalidades Formativas - JRR - 20/04/2011
							Map params = new HashMap();
							params.put("dbpool", dbpool);
							//ICAPUNAY 21/06/2011 FORMATIVAS
							periodo = daoPeriodo.findByFechaModFormativas(dbpool, fechaEval);
							//ICAPUNAY 21/06/2011 FORMATIVAS
							params.put("periodo", periodo);
							bPeriodoCerrado = facadeMantRemote.periodoCerradoModFormativa(params);
							if(log.isDebugEnabled())log.debug("ProcesoFacade - generarRegistroAsistencia - periodoCerradoModFormativa - bPeriodoCerrado: " + bPeriodoCerrado);
							
						} else {
							if(log.isDebugEnabled())log.debug("ProcesoFacade - generarRegistroAsistencia - CODIGO: " + beanPersona.get("t02cod_pers") + " PLANILLAS");
							bPeriodoCerrado = facadeMantRemote.periodoCerradoUOFecha(dbpool, bPer.getFechaIni(), Utiles.obtenerFechaActual(),codUO);
							if(log.isDebugEnabled())log.debug("ProcesoFacade - generarRegistroAsistencia - bPeriodoCerrado: " + bPeriodoCerrado);
						}
						
						//FIN

						if (bPeriodoCerrado){
							if(log.isDebugEnabled())log.debug("ProcesoFacade - generarRegistroAsistencia - EL PERIODO SE ENCUENTRA CERRADO");
							//El periodo ".concat(periodo).concat(" ya se encuentra cerrado para la UO ").concat(codUO).concat(".")
						}
						else{
							
							//JRR - 04/03/2011
							if(t02cod_rel.equals("09")) {//Para el reg. CAS		
								Map superMapa = new HashMap();
								superMapa.put("mapa", mapa);
								superMapa.put("beanPersona", beanPersona);
								superMapa.put("fechas", fechas);
								superMapa.put("usuario", usuario);
								
								if(log.isDebugEnabled())log.debug("ProcesoFacade - generarAsistenciaTrabajadorCAS - CODIGO: " + beanPersona.get("t02cod_pers") + " CAS");
								generarAsistenciaTrabajadorCAS(superMapa);
								if(log.isDebugEnabled())log.debug("ProcesoFacade - generarAsistenciaTrabajadorCAS - FIN CODIGO: " + beanPersona.get("t02cod_pers") + " CAS");//LOG GENERACION
								
							} else if(t02cod_rel.equals("10")) {//Para Modalidades Formativas - JRR - 20/04/2011
								Map superMapa = new HashMap();
								superMapa.put("mapa", mapa);
								superMapa.put("beanPersona", beanPersona);
								superMapa.put("fechas", fechas);
								superMapa.put("usuario", usuario);
								
								if(log.isDebugEnabled())log.debug("ProcesoFacade - generarAsistenciaTrabajadorModFormativa - CODIGO: " + beanPersona.get("t02cod_pers"));
								generarAsistenciaTrabajadorModFormativa(superMapa);
								if(log.isDebugEnabled())log.debug("ProcesoFacade - generarAsistenciaTrabajadorModFormativa - FIN CODIGO: " + beanPersona.get("t02cod_pers"));//LOG GENERACION
								
							} else {
								if(log.isDebugEnabled())log.debug("ProcesoFacade - generarAsistenciaTrabajador - CODIGO: " + beanPersona.get("t02cod_pers") + " PLANILLAS");
								generarAsistenciaTrabajador(mapa,beanPersona,fechas,usuario);
								if(log.isDebugEnabled())log.debug("ProcesoFacade - generarAsistenciaTrabajador - FIN CODIGO: " + beanPersona.get("t02cod_pers") + " PLANILLAS");//LOG GENERACION
							}
							//FIN
						}
						
					}
				}
			}
			res = true;
			
		} catch (Exception e){			
			res = false;
			log.error(e.toString());
			//output.println("Error en el registro de asistencias  : "+ e.toString());
		} finally {
			try {
				//registramos el log del proceso
				super.registraLog(dbpool, mapa, usuario);
			} catch (Exception e) {
			}
		}
		return res;
	}	

	/**
	 * Metodo encargado del registro de la asistencia de una trabajador para un determinado dia
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="RequiresNew"
	 * 
	 */
	public void generarAsistenciaTrabajador(HashMap mapa, HashMap beanPersona, HashMap fechas, String usuario)
	throws IncompleteConversationalState, RemoteException {
	
	if (log.isDebugEnabled()) log.debug("inicio de metodo ProcesoFacade - generarAsistenciaTrabajador");
    
	ArrayList listaMarcaciones = null;

	BeanMarcacion bMarcacion = null;
	BeanMarcacion bMSgte = null;

	String fechaEval = "";
	String codPers = "";
	String codUO = "";
	String periodo = "";
	String fechaMarcacion = "";
	String horaMarcacion = "";
	String fechaFinMov = "";
	String horaFinMov = "";
	String relojIni = "";
	String relojFin = "";
	String tMov = "";
	String dbpool = "";
	String fechaNSA = (String)fechas.get("FechaNSA");
	
	BeanTurnoTrabajo turno = null;

	T1270DAO daoTurno = new T1270DAO();
	//prac-jcallo
	dbpool = (String) mapa.get("dbpool");
	T1271DAO asisDAO = new T1271DAO(dbpool);
	T01DAO paramDAO = new T01DAO();
	T1275DAO daoMarcacion = new T1275DAO();	//ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)
	T99DAO codigoDAO = new T99DAO(); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
	T8167DAO climaLabDAO = new T8167DAO(dbpool); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral

	boolean tieneRefrigerio = false;
	boolean tieneRefrigerioW = false;//NUEVO
	//boolean bOperativo = false;//ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)
	boolean bControla = true;
	boolean generar = true;
	boolean diaEspecial = false;
	

	try{
		fechaEval = (String) mapa.get("fechaEval");
		periodo = (String) mapa.get("periodo");
		codPers = (String) beanPersona.get("t02cod_pers");
		codUO = (String) beanPersona.get("t02cod_uorg");
		//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
		String isProcesar = (String) mapa.get("isProcesar");
		isProcesar = isProcesar!=null?isProcesar:"NO";
		List papeletasGeneradas= null;
		//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
		
		//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral			
		String climaLab = codigoDAO.findParamByCodTabCodigo(dbpool,Constantes.CODTAB_PARAMETROS_ASISTENCIA,Constantes.MINUTOS_MAXIMO_CLIMALABORAL);
		int minMaxClima = climaLab != null ? Integer.parseInt(climaLab) : 0;
		log.debug("minMaxClima: " + ""+minMaxClima);		
		Map autoriClima = null;
		boolean procesaClima = false;
		boolean refriClima = false; //new
		boolean excesoClima = false; //new
		String estadoAut = "";//new
		Map prms=new HashMap(); //new
		pe.gob.sunat.rrhh.dao.CorreoDAO correoDAO = new pe.gob.sunat.rrhh.dao.CorreoDAO(dbpool);//new
		String cod_auto=""; //new
		String nomApell="";	//new	
		String correoColab="";//new
		String correoAutoriz="";//new
		String mensaje = "";//new		
		String mensajeF = "";//new
		Map mParams = new HashMap();//new
		//mParams.put("fec_correo",new FechaBean().getFormatDate("dd/MM/yyyy"));//fecha envio correo
		//ICAPUNAY - PAS20175E230300069
		
		DataSource ds = ServiceLocator.getInstance().getDataSource(dbpool);
		pe.gob.sunat.rrhh.asistencia.dao.T1271DAO t1271dao = new  pe.gob.sunat.rrhh.asistencia.dao.T1271DAO(ds);


	    //verificamos si es fin de semana o feriado
		//ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)
	    /*diaEspecial = Utiles.isDiaSemana(fechaEval, Constantes.SABADO)
				|| Utiles.isDiaSemana(fechaEval, Constantes.DOMINGO)
				|| paramDAO.findByFechaFeriado(dbpool, fechaEval);
		
	    //obtenemos el turno del dia
	    turno = daoTurno.joinWithT45ByCodFecha(dbpool,codPers, fechaEval);
	    
	    if (turno!=null){		    
	    	
	    	bOperativo = turno.isOperativo();
			bControla = turno.isControla();		    	
	    	String horaIniTurno = turno.getHoraIni();
	    	String horaFinTurno = turno.getHoraFin();
		    if (horaFinTurno.compareTo(horaIniTurno)<=0){			    	
				String ultFecha = (String)fechas.get(codPers);
				log.debug("ultima fecha "+ ultFecha);
				log.debug("fecha eval "+ fechaEval);
				if  (ultFecha==null || !ultFecha.equals(fechaEval))  {
					//EBV 01/06/2006 Le estoy poniendo turno.getDuracion() para hacerlo mas general y
					//abrirlo a mas dias.
					//fechas.put(codPers,Utiles.dameFechaSiguiente(fechaEval, 1));
					if (ultFecha==null){
						log.debug("Primer Control Operativo "+Utiles.dameFechaSiguiente(fechaEval, turno.getDuracion()));
						fechas.put(codPers,Utiles.dameFechaSiguiente(fechaEval, turno.getDuracion()));
					}else {
					if (Utiles.obtenerDiasDiferencia(ultFecha, fechaEval) >0 ) {
						log.debug("Primer Control Operativo "+Utiles.dameFechaSiguiente(fechaEval, turno.getDuracion()));
						fechas.put(codPers,Utiles.dameFechaSiguiente(fechaEval, turno.getDuracion()));
					}
					else{
						generar = false;
						//fechas.put(codPers,fechaEval);
					}
					}
				}
				else{
					generar = false;
					fechas.put(codPers,fechaEval);
				}			    				    
		    }
	    }*/ //FIN ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)
	    
	    //en caso las marcaciones del dia aun no han sido calificadas
		//if (generar && turno!=null){//ICAPUNAY 13/06/2012 PASE 2012-381 AJUSTES A CALIFICACION DE ASISTENCIA
	    if (generar){//ICAPUNAY 13/06/2012 PASE 2012-381 AJUSTES A CALIFICACION DE ASISTENCIA
	       	if (log.isDebugEnabled()) log.debug("generar true");//LOG GENERACION
	    		    	
	    	//ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)
		    BeanMarcacion bMarcacion2 = null;
			BeanMarcacion bMSgte2 = null;
			String fechaMarcacion2 = "";
			String horaMarcacion2 = "";
			String fechaFinMov2 = "";
			String horaFinMov2 = "";
			String relojIni2 = "";
			String relojFin2 = "";
			String tMov2 = "";
			String movAct = ""; //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
			boolean bOperativo2 = false;
			boolean bOperativoW = false;//NUEVO		
		    
		    BeanTurnoTrabajo turnoDx = null;
		    String fechaAntes = "";
		    String horaIniTurnoDw = "";
			String horaFinTurnoDw = "";
			String horaIniTurnoDx = "";
			String horaFinTurnoDx = "";
			BeanTurnoTrabajo turno1 = daoTurno.joinWithT45ByCodPersFecha_Controlado_OperAdm1dia(dbpool,codPers.trim(),fechaEval);		    
			if (turno1!=null){
				turnoDx=turno1;					    
			}else{
				BeanTurnoTrabajo turno2 = daoTurno.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,codPers.trim(),fechaEval);
				turnoDx=turno2;				    
			}
			if (log.isDebugEnabled()) log.debug("turnoDx("+fechaEval+"): " + "("+codPers+"): "+turnoDx);
						
			if (turnoDx!=null){
				if (log.isDebugEnabled()) log.debug("tiene turno dia x");
				horaIniTurnoDx = turnoDx.getHoraIni().trim();
				horaFinTurnoDx = turnoDx.getHoraFin().trim();
				bOperativo2 = turnoDx.isOperativo();
				if (log.isDebugEnabled()) log.debug("horaIniTurnoDx("+codPers+"): " + horaIniTurnoDx);
				if (log.isDebugEnabled()) log.debug("horaFinTurnoDx("+codPers+"): " + horaFinTurnoDx);  
				if(horaFinTurnoDx.trim().compareTo(horaIniTurnoDx.trim())>0){ //adm u ope 1 dia
					if (log.isDebugEnabled()) log.debug("horaFinTurnoDx>horaIniTurnoDx(adm u ope 1 dia)");
					fechaAntes = Utiles.dameFechaAnterior(fechaEval, 1);	    		   
					BeanTurnoTrabajo turnoDw = daoTurno.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,codPers,fechaAntes); //dia (x-1)
					if (log.isDebugEnabled()) log.debug("turno1 dia x-1 (turnoDw)("+codPers+"): " + turnoDw);
					if (turnoDw!=null){	
						
						//ICAPUNAY 23/02/2015 AJUSTES GENERACION ASISTENCIA (caso SES: SI turno (dia x-1) de 2 dias y SI turno dia x de 1 d涌(marcaciones IMPARES requiere para dia x))
						if (log.isDebugEnabled()) log.debug("registro("+codPers+"): SI turno (dia x-1) de 2 dias y SI turno dia x de 1 d涌(marcaciones IMPARES requiere para dia x)_PLANILLA");
						horaIniTurnoDw = turnoDw.getHoraIni().trim();
						horaFinTurnoDw = turnoDw.getHoraFin().trim();
						bOperativoW = turnoDw.isOperativo();//NUEVOO						
						tieneRefrigerio = false;//NUEVOO
						tieneRefrigerioW = false;//NUEVOO
						if (log.isDebugEnabled()) log.debug("horaIniTurnoDw_SES("+codPers+"): " + horaIniTurnoDw);
						if (log.isDebugEnabled()) log.debug("horaFinTurnoDw_SES("+codPers+"): "+ horaFinTurnoDw);												
						//impar requiere (par es omision cuando no puede calificar) //solo S,E,S	//reg 9793-28/01/15	
						
						//NUEVOO
						listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
						if (log.isDebugEnabled()) log.debug("listaMarcaciones_SES:"+listaMarcaciones);
						if (listaMarcaciones != null && listaMarcaciones.size() > 0) {
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral													
							autoriClima=climaLabDAO.findAutorizaByRegByFecha(codPers, fechaEval);
							log.debug("autoriClima: "+autoriClima);							
							if (autoriClima!=null && !autoriClima.isEmpty()){
								procesaClima=true;
							}
							//ICAPUNAY - PAS20175E230300069
							
							int j=0;							
							boolean esPareja=false;
							boolean tieneSalidaW=false;
							boolean tieneEntradaX=false;
							boolean tieneSalidaX=false;//DESARROLLAR PARA ESTE
							Map calificacion = new HashMap();
							for (int i = 0; i <= listaMarcaciones.size()-1; i++) {
								esPareja=false;
								if (log.isDebugEnabled()) log.debug("i_SES:"+i);
								bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
								fechaMarcacion2 = bMarcacion2.getFecha();//28/01/15
								horaMarcacion2 = bMarcacion2.getHora();//01:00:00
								relojIni2 = bMarcacion2.getReloj();
								relojFin2 = "";
								fechaFinMov2= "";
								if (log.isDebugEnabled()) log.debug("i_SES:"+i);								
								if (log.isDebugEnabled()) log.debug("fechaMarcacion_SES("+i+"):"+fechaMarcacion2);
								if (log.isDebugEnabled()) log.debug("horaMarcacion_SES("+i+"):"+horaMarcacion2);
							
								if (i<=listaMarcaciones.size()-2){//i<=7(9 total)										
									j=i+1;	//i=0/j=1								
									bMSgte2 = (BeanMarcacion) listaMarcaciones.get(j);							
									fechaFinMov2 = bMSgte2.getFecha();//28/01/15
									horaFinMov2 = bMSgte2.getHora();//05:00:00
									relojFin2 = bMSgte2.getReloj();
									if (log.isDebugEnabled()) log.debug("j(i+1) SES:"+j);									
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 int_SES :"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 int_SES:"+horaFinMov2);								
																			
									if(horaMarcacion2.trim().compareTo(horaFinTurnoDw.trim())<0){
										if (log.isDebugEnabled()) log.debug("entro 1_SES");
										if (horaFinMov2.trim().compareTo(horaFinTurnoDw.trim())<0){
											if (log.isDebugEnabled()) log.debug("entro 1.1_SES");
											esPareja=true;										
											i=j;
											if (log.isDebugEnabled()) log.debug("j_SES:"+j);
											if (log.isDebugEnabled()) log.debug("i_SES:"+i);
										}else{//horaFinMov2>=horaFinTurnoDw
											if (log.isDebugEnabled()) log.debug("entro 1.2_SES");
											if (tieneSalidaW==false){
												if (log.isDebugEnabled()) log.debug("entro 1.3_SES");
												tMov2 = preCalificarSalidaOpe1(
														dbpool,
														codPers,
														fechaMarcacion2,
														horaMarcacion2,
														turnoDw.getHoraFin(),
														Constantes.MINUTO);
												if (log.isDebugEnabled()) log.debug("salida66 preCalificarSalidaOpe1(tMov2) SES:"+tMov2);					
												horaFinMov2 = "";
												//ICR 18052015
												if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
													horaFinMov2=turnoDw.getHoraFin();
												}
												//ICR 18052015
												tieneSalidaW=true;											
												if (log.isDebugEnabled()) log.debug("tieneSalidaW_SES:"+tieneSalidaW);
												if (log.isDebugEnabled()) log.debug("j_SES:"+j);
												if (log.isDebugEnabled()) log.debug("i_SES:"+i);
											}	
										}										
									}else{//horaMarcacion2>=horaFinTurnoDw //revisando
										if (log.isDebugEnabled()) log.debug("entro 2_SES");
										//ok9
										if (horaMarcacion2.trim().compareTo(horaIniTurnoDx.trim())<=0){//revisando
											if (log.isDebugEnabled()) log.debug("entro 2.1_SES");
											if (tieneSalidaW==false){
												if (log.isDebugEnabled()) log.debug("entro 2.2_SES");
												tMov2 = Constantes.SALIDA_NORMAL; //salida
												tieneSalidaW=true;											
												horaFinMov2 = "";
												if (log.isDebugEnabled()) log.debug("i antes_SES:"+i);												
											}else{//tieneSalidaW==true
												if (log.isDebugEnabled()) log.debug("entro 2.3_SES");
												if (horaFinMov2.trim().compareTo(horaIniTurnoDx.trim())<=0){
													if (log.isDebugEnabled()) log.debug("entro 2.4_SES");
													esPareja=true;												
													i=j;
													if (log.isDebugEnabled()) log.debug("j_SES:"+j);
													if (log.isDebugEnabled()) log.debug("i_SES:"+i);
												}else{//horaFinMov2>horaIniTurnoDx
													if (log.isDebugEnabled()) log.debug("entro 2.5_SES");
													if (tieneEntradaX==false){
														if (log.isDebugEnabled()) log.debug("entro 2.6_SES");
														tMov2 = Constantes.ENTRADA_NORMAL; //entrada
														tieneEntradaX=true;				
														horaFinMov2 = "";
														if (log.isDebugEnabled()) log.debug("i antes2_SES:"+i);														
														if (log.isDebugEnabled()) log.debug("i_SES:"+i);													
														
													}
												}
											}
										}else{//horaMarcacion2>horaIniTurnoDx (aca modificar)	
											if (log.isDebugEnabled()) log.debug("entro 2.7_SES");
											//ok
											if (horaMarcacion2.trim().compareTo(horaFinTurnoDx.trim())<0){//if nuevo
												//ok
												if (tieneEntradaX==false){
													if (log.isDebugEnabled()) log.debug("entro 2.8_SES");
													tMov2 = preCalificarEntrada(
															fechaMarcacion2,
															horaMarcacion2,
															turnoDx.getHoraIni(),
															turnoDx.getTolera(),
															turnoDx.getHoraLimite(),
															Constantes.MINUTO);
													if (log.isDebugEnabled()) log.debug("salida66 preCalificarEntrada(tMov2)_SES:"+tMov2);
													tieneEntradaX=true;												
													horaFinMov2 = "";
													//hsal cuando es tardanza 01 se coloca valor
													if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO) ) {
														horaFinMov2=turnoDx.getHoraIni();
													}
													//fin hsal
													if (log.isDebugEnabled()) log.debug("j_SES:"+j);
													if (log.isDebugEnabled()) log.debug("i_SES:"+i);
												}else{//tieneEntradaX==true //revisar si debe ir tieneSalidaX
													if (log.isDebugEnabled()) log.debug("entro 2.9_SES");																							
													// no interesa si horaFinMov2 es mayor o menor que horaFinTurnoDx
													esPareja=true;											
													i=j;
													if (log.isDebugEnabled()) log.debug("j_SES:"+j);
													if (log.isDebugEnabled()) log.debug("i_SES:"+i);													
																									
												}//ok
											}else{//nuevo //horaMarcacion2>=horaFinTurnoDx
												//desarrollar
												if (tieneSalidaX==false){//if nuevo
													if (log.isDebugEnabled()) log.debug("entro 2.92_SES");
													tMov2 = preCalificarSalidaOpe1(
															dbpool,
															codPers,
															fechaMarcacion2,
															horaMarcacion2,
															turnoDx.getHoraFin(),
															Constantes.MINUTO);
													if (log.isDebugEnabled()) log.debug("salida6666 preCalificarSalidaOpe1(tMov2) SES:"+tMov2);					
													horaFinMov2 = "";
													//ICR 18052015
													if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
														horaFinMov2=turnoDx.getHoraFin();
													}
													//ICR 18052015
													tieneSalidaX=true;											
													if (log.isDebugEnabled()) log.debug("tieneSalidaX_SES:"+tieneSalidaX);
													if (log.isDebugEnabled()) log.debug("j_SES:"+j);
													if (log.isDebugEnabled()) log.debug("i_SES:"+i);
												}else{//tieneSalidaX==true	
													//horaFinMov2 es mayor que horaFinTurnoDx
													esPareja=true;											
													i=j;
													if (log.isDebugEnabled()) log.debug("j_SES:"+j);
													if (log.isDebugEnabled()) log.debug("i_SES:"+i);													
												}//ok		
											}
											//ok
										}//ok9										
									  }
									//ok
									if (esPareja){
										if (log.isDebugEnabled()) log.debug("espareja==true SES");
										//calificacion = preCalificarMovimientoOpe4(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDw, turnoDx,Constantes.MINUTO,tieneRefrigerioW, tieneRefrigerio,bOperativoW,bOperativo2); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										calificacion = preCalificarMovimientoOpe4(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDw, turnoDx,Constantes.MINUTO,tieneRefrigerioW, tieneRefrigerio,bOperativoW,bOperativo2,procesaClima,minMaxClima); //se agrego procesaClima y minMaxClima //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral										
										if (log.isDebugEnabled()) log.debug("salida66 preCalificarMovimientoOpe4(calificacion)_SES:"+calificacion);

										tMov2=(String)calificacion.get("calif");
										
										/*if(calificacion.get("refrigerioW").equals("SI")){
											if (log.isDebugEnabled()) log.debug("refrigerioW==SI");
											if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) {
												if (log.isDebugEnabled()) log.debug("exceso o refrigerio_SES");
												tieneRefrigerioW = true;
												if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2 SES:"+fechaMarcacion2 + " " + horaMarcacion2);
												if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2 SES:"+fechaMarcacion2 + " " + horaFinMov2);
												float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
												float quedan = turnoDw.getMinutosRefrigerio() - durante1;
												if (log.isDebugEnabled()) log.debug("tieneRefrigerioW SES:"+tieneRefrigerioW);
												if (log.isDebugEnabled()) log.debug("durante1 w_SES:"+durante1);
												if (log.isDebugEnabled()) log.debug("quedan w_SES:"+quedan);
												turnoDw.setMinutosRefrigerio( new Float(quedan).intValue());
												log.debug("turnoDw(setMinutosRefrigerio o quedan_SES) : " + quedan);
											}
										}*/	

										if(calificacion.get("refrigerioX").equals("SI")){
											if (log.isDebugEnabled()) log.debug("refrigerioX==SI");
											//if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
											if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
												if (log.isDebugEnabled()) log.debug("exceso o refrigerio_SES");
												// ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
												Map calificacionActual=null;
												calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "2", "3","5"); //0=calificacion inicial, 2=papeleta aprobada, 3= papeleta procesada, //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral (adicion 5=calificacion por rrhh)
												if (log.isDebugEnabled()) log.debug("calificacionActuall : "+calificacionActual);												
												if (calificacionActual!=null){
													if (log.isDebugEnabled()) log.debug("entrooooo");
													movAct= calificacionActual.get("mov").toString().trim();//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													//if (tMov2.trim().equals(calificacionActual.get("mov").toString().trim())){ ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (movAct.equals(Constantes.MOV_EXCESO_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRI_CLIMALABORAL) ){ //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (log.isDebugEnabled()) log.debug("movAct igual a refri, exceso o refri clima");
														if (log.isDebugEnabled()) log.debug("tMov2 : "+tMov2);
														if (log.isDebugEnabled()) log.debug("calificacionActual : "+calificacionActual);
														
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio : "+tieneRefrigerio);
														if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
														tieneRefrigerio = true;
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2 SES:"+fechaMarcacion2 + " " + horaMarcacion2);
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2 SES:"+fechaMarcacion2 + " " + horaFinMov2);
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1 x_SES:"+durante1);
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio SES:"+tieneRefrigerio);
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
															if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
															minMaxClima= new Float(quedan).intValue();
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("turnoDx.getMinutosRefrigerio(): "+turnoDx.getMinutosRefrigerio());
															log.debug("quedan: " + quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());															
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														
													}else{
														tieneRefrigerio = false;
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio: "+tieneRefrigerio);
													}														
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas
												else{													
													calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "0", "0","0"); //0=calificacion inicial
													if (log.isDebugEnabled()) log.debug("calificacionActual2 : "+calificacionActual);
													if (calificacionActual==null){
														tieneRefrigerio = true;
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
															if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
															minMaxClima= new Float(quedan).intValue();
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("turnoDx.getMinutosRefrigerio(): "+turnoDx.getMinutosRefrigerio());
															log.debug("quedan: " + quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());															
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral													
													}													
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas
												//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
											}
										}
									}															
									//todo ok									
								}else{
									//llego aca termine (marcacion sola)
									if (log.isDebugEnabled()) log.debug("no debe llegar aca PLANILLA-ultima marcaci?ES");
									if (log.isDebugEnabled()) log.debug("j_SES:"+j);
									if (log.isDebugEnabled()) log.debug("i_SES:"+i);
									if (listaMarcaciones.size()==1){
										tMov2 = Constantes.MOV_OMISION_MARCA;
										if (log.isDebugEnabled()) log.debug("tMov una marcacion(omision)-SES:"+tMov2);
									}else{
										if (tieneSalidaW==false){
											if (log.isDebugEnabled()) log.debug("entro 1.3_SES");
											tMov2 = preCalificarSalidaOpe1(
													dbpool,
													codPers,
													fechaMarcacion2,
													horaMarcacion2,
													turnoDw.getHoraFin(),
													Constantes.MINUTO);
											if (log.isDebugEnabled()) log.debug("salida66 preCalificarSalidaOpe1(tMov2)_SES:"+tMov2);					
											horaFinMov2 = "";
											//ICR 18052015
											if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
												horaFinMov2=turnoDw.getHoraFin();
											}
											//ICR 18052015
											tieneSalidaW=true;											
											if (log.isDebugEnabled()) log.debug("tieneSalidaW_SES:"+tieneSalidaW);										
										}
										else{//tieneSalidaW==true
											if (tieneEntradaX==false){											
												if (log.isDebugEnabled()) log.debug("entro 3.0_SES");
												tMov2 = preCalificarEntrada(
														fechaMarcacion2,
														horaMarcacion2,
														turnoDx.getHoraIni(),
														turnoDx.getTolera(),
														turnoDx.getHoraLimite(),
														Constantes.MINUTO);
												if (log.isDebugEnabled()) log.debug("salida66 preCalificarEntrada(tMov2)_SES:"+tMov2);
												horaFinMov2 = "";
												//hsal cuando es tardanza 01 se coloca valor
												if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO) ) {
													horaFinMov2=turnoDx.getHoraIni();
												}
												//fin hsal
												tieneEntradaX=true;	
												if (log.isDebugEnabled()) log.debug("tieneEntradaX_SES:"+tieneEntradaX);
											}else{//tieneEntradaX==true
												
												if (tieneSalidaX==false){
													if (log.isDebugEnabled()) log.debug("entro 1.33_SES");
													tMov2 = preCalificarSalidaOpe1(
															dbpool,
															codPers,
															fechaMarcacion2,
															horaMarcacion2,
															turnoDx.getHoraFin(),
															Constantes.MINUTO);
													if (log.isDebugEnabled()) log.debug("salida666 preCalificarSalidaOpe1(tMov2)_SES:"+tMov2);					
													horaFinMov2 = "";
													//ICR 18052015
													if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
														horaFinMov2=turnoDx.getHoraFin();
													}
													//ICR 18052015
													tieneSalidaX=true;											
													if (log.isDebugEnabled()) log.debug("tieneSalidaX_SES:"+tieneSalidaX);
													
												}else{//tieneSalidaX==true
													tMov2 = Constantes.MOV_OMISION_MARCA;
													horaFinMov2 = "";//SI ES OMISION TIENE horaFinMov2 vacion
													if (log.isDebugEnabled()) log.debug("tMov5-PLANILLA_SES(omision):"+tMov2);
												}												
											}
										}
									}	
								}										
								//fin llego aca
								
								try{
									if (horaFinMov2!=null && horaFinMov2!="") {
										if (log.isDebugEnabled()) log.debug("horaFinMov2!=null y horaFinMov2!=vacio");
										if (log.isDebugEnabled()) log.debug("codPers:"+codPers+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"/fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2);
										log.debug("borrando6 asistencia PLANILLA en T1271DAO_SES: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
										t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
									}
									log.debug("datos PLANILLA para T1271DAO_SES: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									Map params1 = new HashMap();
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);
									params1.put("cod_uorgan", codUO);
									params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
									params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									params1.put("mov", tMov2);
									params1.put("relojIni", relojIni2);
									params1.put("relojFin", relojFin2);
									params1.put("usuario", usuario);	
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI (SES");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else {	
										log.debug("isProcesar NO (SES)");
										boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
										if (inserto){
											log.debug("SI inserto1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO inserto1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0						
								}
								catch(Exception e){
									if (log.isDebugEnabled()) log.debug("catch6- generarAsistenciaTrabajador_SES");										
									Map params1 = new HashMap();
									params1.put("mov", tMov2);
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("usuario", usuario);
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);							
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", horaMarcacion2);
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else{
										log.debug("isProcesar NO");
									//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
										boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
										if (actualizo){
											log.debug("SI actualizo1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO actualizo1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0									
								}
							}//fin for ok	
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral - new
							if (autoriClima!=null && !autoriClima.isEmpty()){
								estadoAut=autoriClima.get("ind_aut").toString().trim();
								cod_auto = autoriClima.get("cod_aut").toString().trim();
								if ((excesoClima==true || refriClima==true) && estadoAut.equals("0")){
									log.debug("actualizara estado autorizacion (codPers: "+codPers+" fechaEval: "+fechaEval+" )");
									prms.put("ind_aut", Constantes.ACTIVO);					
									prms.put("cod_user_mod", "BATCH-CLIMA-LAB");
									prms.put("cod_pers", codPers);
									prms.put("fec_aut", autoriClima.get("fec_aut_desc").toString());					
									climaLabDAO.updateRegistroAutorizaCli(prms);
									
									//envio correo
									nomApell = (autoriClima.get("t02ap_pate")!=null?autoriClima.get("t02ap_pate").toString().trim():"")+" "+(autoriClima.get("t02ap_mate")!=null?autoriClima.get("t02ap_mate").toString().trim():"")+" "+(autoriClima.get("t02nombres")!=null?autoriClima.get("t02nombres").toString().trim():"");
									mParams.put("registro",codPers);
									if (log.isDebugEnabled()) log.debug("mParamss: " + mParams);
									
									mensajeF = "El sistema ha procedido a calificar sus marcaciones de Clima Laboral para la fecha "+(String)autoriClima.get("fec_aut_desc")+".";	
									if (log.isDebugEnabled()) log.debug("mensajeFF: " + mensajeF);	
									mensaje = textoCorreoClimaLaboral(mParams,nomApell,mensajeF);//mensaje en html
									if (log.isDebugEnabled()) log.debug("mensajee: " + mensaje);																			
									Correo objCorreo = new Correo(mensaje.toString());									
									objCorreo.setServidor(propiedadesCorreo.leePropiedad("servidor"));									
									objCorreo.setRemitente(propiedadesCorreo.leePropiedad("correoRemitenteMovimientos"),propiedadesCorreo.leePropiedad("nombreRemitenteMovimientos"));
															
									correoColab=correoDAO.findCorreoByRegistro(codPers);
									correoAutoriz=correoDAO.findCorreoByRegistro(cod_auto);
														
									// VALIDANDO SI TRABAJADOR TIENE CORREO																
									if (!correoColab.equals("")) {						
										if (log.isDebugEnabled()) log.debug("correoColab Trabajador= " + correoColab);
										try{
											//trabajador tiene correo correcto, se debe enviar correo a trabajador con copia a autorizador								
											objCorreo.agregarDestinatario(correoColab.trim());
											if(!correoAutoriz.equals("")){
												objCorreo.agregarConCopia(correoAutoriz.trim());
											}
											//objCorreo.agregarConCopia("jquispecoi@sunat.gob.pe");/////ELIMINAR
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral");
											objCorreo.enviarHtml();		
											if (log.isDebugEnabled()) log.debug("Se envio correo a trabajador");	
																		
										} catch (CorreoException ce) {
											//trabajador tiene correo erroneo, hay destinatario erroneo 
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - CORREO ERR흁EO");
											objCorreo.enviarHtml();
									 		if (log.isDebugEnabled()) log.debug("Error en CorreoExceptionn: "+ce.toString());									 	
										 	if (log.isDebugEnabled()) log.debug("SI tiene correo trabajador: "+codPers+" - pero correo es erroneo");									 										 	
										}											
									}//fin if tiene correo
									else {
										//trabajador no tiene correo, no hay destinatario y se debe copiar a rrhh correo
										objCorreo.agregarConCopia(propiedadesCorreo.leePropiedad("correoReceptorAlertaCambioTurnos"));
										objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - NO TIENE CORREO");
										objCorreo.enviarHtml();							
										if (log.isDebugEnabled()) log.debug("NO tiene correo trabajador: " + codPers+" - se envio a rrhh");
									}
									//fin envio correo
								}
							}							
							//ICAPUNAY - PAS20175E230300069
						}
						//FIN NUEVOO
						//FIN ICAPUNAY 23/02/2015 AJUSTES GENERACION ASISTENCIA (caso SES: SI turno (dia x-1) de 2 dias y SI turno dia x de 1 d涌(marcaciones IMPARES requiere para dia x))

										
					}else{
						//logica normal minimo (E S)
						if (log.isDebugEnabled()) log.debug("registro("+codPers+"): NO turno (dia x-1) de 2 dias y SI turno dia x de 1 d涌(marcaciones PARES requiere para dia x)");						
						/**************************************/
						//JRR - 05/11/2008 - PARA TIEMPO EXTRA A COMPENSAR POR BOLSA
						float tiempoExtraEntrada = 0;
						float tiempoExtraSalida = 0;
						int tiempoExtra = 0;
						/**************************************/						
						//par requiere (impar es omision) //logica normal minimo (E S)						
						diaEspecial = Utiles.isDiaSemana(fechaEval, Constantes.SABADO) || Utiles.isDiaSemana(fechaEval, Constantes.DOMINGO) || paramDAO.findByFechaFeriado(dbpool, fechaEval);
						tieneRefrigerio = false;						
						listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
						if (log.isDebugEnabled()) log.debug("listaMarcaciones:"+listaMarcaciones);
						if (listaMarcaciones != null && listaMarcaciones.size() > 0) {	
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral													
							autoriClima=climaLabDAO.findAutorizaByRegByFecha(codPers, fechaEval);
							log.debug("autoriClima: "+autoriClima);							
							if (autoriClima!=null && !autoriClima.isEmpty()){
								procesaClima=true;
							}
							//ICAPUNAY - PAS20175E230300069
							
							for (int i = 0; i < listaMarcaciones.size(); i++) {	
								bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
								fechaMarcacion2 = bMarcacion2.getFecha();
								horaMarcacion2 = bMarcacion2.getHora();
								relojIni2 = bMarcacion2.getReloj();
								relojFin2 = "";
								if (log.isDebugEnabled()) log.debug("i:"+i);
								if (log.isDebugEnabled()) log.debug("bMarcacion2("+i+"):"+bMarcacion2);
								if (log.isDebugEnabled()) log.debug("fechaMarcacion2("+i+"):"+fechaMarcacion2);
								if (log.isDebugEnabled()) log.debug("horaMarcacion2("+i+"):"+horaMarcacion2);
								//primera marcacion de ENTRADA
								if (i==0){
									if (log.isDebugEnabled()) log.debug("primera marca");
									fechaFinMov2 = bMarcacion2.getFecha();
									horaFinMov2 = "";
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 ent:"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 ent:"+horaFinMov2);
									if (diaEspecial && !bOperativo2){
										tMov2 = Constantes.MOV_APORTACION;	
										if (log.isDebugEnabled()) log.debug("tMov2:"+tMov2);
									}else{
										tMov2 = preCalificarEntrada(
												fechaMarcacion2,
												horaMarcacion2,
												turnoDx.getHoraIni(),
												turnoDx.getTolera(),
												turnoDx.getHoraLimite(),
												Constantes.MINUTO);
										if (log.isDebugEnabled()) log.debug("salida preCalificarEntrada(tMov):"+tMov2);
									}								
								}else if (i == (listaMarcaciones.size() - 1)){//ultima marcacion de SALIDA
									if (log.isDebugEnabled()) log.debug("ultima marca");
									fechaFinMov2 = bMarcacion2.getFecha();
									horaFinMov2 = "";
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 sal:"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 sal:"+horaFinMov2);
									if (diaEspecial && !bOperativo2){
										tMov2 = Constantes.MOV_APORTACION;
										if (log.isDebugEnabled()) log.debug("tMov7:"+tMov2);
									}else{
										tMov2 = preCalificarSalida(
												dbpool,
												codPers,
												fechaMarcacion2,
												horaMarcacion2,
												turnoDx.getHoraFin(),
												Constantes.MINUTO);
										if (log.isDebugEnabled()) log.debug("salida preCalificarSalida(tMov2):"+tMov2);
									}														
								}
								//movimientos intermedios
								else{
									if (log.isDebugEnabled()) log.debug("marcaciones en pareja");					
									if (log.isDebugEnabled()) log.debug("listaMarcaciones.size():"+listaMarcaciones.size());								
									if (i < (listaMarcaciones.size() - 2)) {
										if (log.isDebugEnabled()) log.debug("i:"+i);
										bMSgte2 = (BeanMarcacion) listaMarcaciones.get(++i);							
										fechaFinMov2 = bMSgte2.getFecha();
										horaFinMov2 = bMSgte2.getHora();
										relojFin2 = bMSgte2.getReloj();
										if (log.isDebugEnabled()) log.debug("bMSgte2 int:"+bMSgte2);
										if (log.isDebugEnabled()) log.debug("fechaFinMov2 int :"+fechaFinMov2);
										if (log.isDebugEnabled()) log.debug("horaFinMov2 int:"+horaFinMov2);
										if (log.isDebugEnabled()) log.debug("relojFin2 int:"+relojFin2);
										if (diaEspecial && !bOperativo2){
											tMov2 = Constantes.MOV_APORTACION;	
											if (log.isDebugEnabled()) log.debug("tMov9:"+tMov2);
										}else{										
											//tMov2 = preCalificarMovimiento(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDx,	Constantes.MINUTO, tieneRefrigerio,	bOperativo2);
											//tMov2 = preCalificarMovimiento_soloTurnoAdmOpe1dia(dbpool,codPers,fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDx,	Constantes.MINUTO, tieneRefrigerio,	bOperativo2); //se agrego dbpool y codPers //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
											tMov2 = preCalificarMovimiento_soloTurnoAdmOpe1dia(dbpool,codPers,fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDx, Constantes.MINUTO, tieneRefrigerio,bOperativo2,procesaClima,minMaxClima); //se agrego procesaClima y minMaxClima //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
											if (log.isDebugEnabled()) log.debug("salida preCalificarMovimiento_soloTurnoAdmOpe1dia(tMov):"+tMov2);
											//if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
											if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
												
												// ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
												Map calificacionActual=null;
												calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "2", "3","5"); //0=calificacion inicial, 2=papeleta aprobada, 3= papeleta procesada, //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral (adicion 5=calificacion por rrhh)
												if (log.isDebugEnabled()) log.debug("calificacionActuall : "+calificacionActual);												
												if (calificacionActual!=null){
													if (log.isDebugEnabled()) log.debug("entrooooo");
													movAct= calificacionActual.get("mov").toString().trim();//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													//if (tMov2.trim().equals(calificacionActual.get("mov").toString().trim())){ ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (movAct.equals(Constantes.MOV_EXCESO_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRI_CLIMALABORAL) ){ //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (log.isDebugEnabled()) log.debug("movAct igual a refri, exceso o refri clima");
														if (log.isDebugEnabled()) log.debug("tMov2 : "+tMov2);
														if (log.isDebugEnabled()) log.debug("calificacionActual : "+calificacionActual);
														
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio : "+tieneRefrigerio);
														if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
														tieneRefrigerio = true;
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2:"+fechaMarcacion2 + " " + horaMarcacion2);
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2:"+fechaMarcacion2 + " " + horaFinMov2);
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("quedan1:"+quedan);
															minMaxClima= new Float(quedan).intValue();
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("quedan:"+quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														
													}else{
														tieneRefrigerio = false;
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio: "+tieneRefrigerio);
													}
														
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas
												else{													
													calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "0", "0","0"); //0=calificacion inicial
													if (log.isDebugEnabled()) log.debug("calificacionActual2 : "+calificacionActual);
													if (calificacionActual==null){
														tieneRefrigerio = true;
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("quedan1:"+quedan);
															minMaxClima= new Float(quedan).intValue();
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("quedan:"+quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral													
													}													
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas												
												//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
											}										
										}
																		
									}else{//marcacion impar
										if (log.isDebugEnabled()) log.debug("marcacion impar");
										fechaFinMov2 = bMarcacion2.getFecha();
										horaFinMov2 = "";
										if (diaEspecial && !bOperativo2){
											tMov2 = Constantes.MOV_APORTACION;	
											if (log.isDebugEnabled()) log.debug("tMov11:"+tMov2);
										}else{										
											tMov2 = Constantes.MOV_OMISION_MARCA;
											if (log.isDebugEnabled()) log.debug("tMov12:"+tMov2);
										}										
									}	
                                                                       /* EBV 27/03/2015 CAMBIO POR LINEAMIENTO
									if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
										tMov2 = Constantes.MOV_SALIDA_AUTORIZADA;
										if (log.isDebugEnabled()) log.debug("tMov13:"+tMov2);
									}
                                                                      */									
								}
								//fin mov intermedios									
								
								/*************************************			*/			
								//JRR - 05/11/2008 - PARA VER SI EXISTE TIEMPO EXTRA A COMPENSAR								
								Map lhe = new HashMap();
								BeanHoraExtra he = new BeanHoraExtra();
								he.setCodPers(codPers);
								he.setFechaAutorizacion(fechaMarcacion2);//ICR 08/05/2015 - corregir error "Exception en calcularHorasPermanencia: null"	(antes: fechaMarcacion, ahora: fechaMarcacion2) 							
								if(diaEspecial){
									log.debug("BOLSA: ES diaEspecial");
									//Para la entrada anticipada
									he.setHoraSalida("23:59:59");
									he.setHoraIni("00:00:00");								
									String horaFin = he.getHoraSalida() != null ? he.getHoraSalida().trim() : "";
											//JRR
											log.debug("he.getHoraSalida(): " + he.getHoraSalida());
											//solo se procesaran los registros con hora de salida
											log.debug("HORAFIN HE " + horaFin);
											if (!horaFin.equals("")) {
												lhe = calcularHorasPermanencia(dbpool,codPers,he);
												log.debug("calcularHorasPermanencia - lhe: " + lhe);
												String c1= (String)lhe.get("cantidad");
												String hora = (String) lhe.get("hora");
												String hora0 = (String) lhe.get("hora0");
												log.debug(" Hora0 " + hora0);
												log.debug(" Hora " + hora);
												int cantidad = Integer.parseInt(c1);
												log.debug(" -=diaEspecial=- Tiempo de permanencia - Cantidad " + cantidad );
												if (cantidad > 60) {
													tiempoExtraSalida = cantidad;
													log.debug("Se considera como tiempoExtraSalida: " + tiempoExtraSalida);
												}
											}
								}
								else {
									//JRR - BORRA
									log.debug("BOLSA: ES DiaLaboral");									
									if (turno!=null){//14/06/2012
										//Dias Laborales	
										//Para la entrada anticipada
										he.setHoraSalida(turno.getHoraIni());
										he.setHoraIni("00:00:00");										
										String horaFin = he.getHoraSalida() != null ? he.getHoraSalida().trim() : "";
												//solo se procesaran los registros con hora de salida
												if (!horaFin.equals("")) {
													lhe = calcularHorasPermanencia(dbpool,codPers,he);
													log.debug("calcularHorasPermanencia - lhe: " + lhe);
													String c1= (String)lhe.get("cantidad");
													String hora = (String) lhe.get("hora");
													String hora0 = (String) lhe.get("hora0");
													log.debug(" Hora0 " + hora0);
													log.debug(" Hora " + hora);
													int cantidad = Integer.parseInt(c1);
													log.debug(" ES -=Dias Laborales=- Tiempo de permanencia - Cantidad " + cantidad );
													if (cantidad > 60) {
														tiempoExtraEntrada = cantidad;
														log.debug("Se considera como minutosExtraEntrada: " + tiempoExtraEntrada);
													}
												}
												//JRR - BORRA
												log.debug("BOLSA: ES Salida fuera de hora");
												//	Para la Salida fuera de hora
												he.setHoraSalida("23:59:59");
												he.setHoraIni(turno.getHoraFin());
												horaFin = he.getHoraSalida() != null ? he.getHoraSalida().trim() : "";
														//solo se procesaran los registros con hora de salida
														if (!horaFin.equals("")) {
															lhe = calcularHorasPermanencia(dbpool,codPers,he);
															log.debug("calcularHorasPermanencia - lhe: " + lhe);
															String c1= (String)lhe.get("cantidad");
															//String hora = (String) lhe.get("hora");
															int cantidad = Integer.parseInt(c1);
															log.debug(" - Horas : "+cantidad);
															int horasCompensa = daoTurno.findHorasCompensa(dbpool,codPers,fechaMarcacion2);//ICR 08/05/2015 - corregir error "Exception en calcularHorasPermanencia: null"	(antes: fechaMarcacion, ahora: fechaMarcacion2)
															log.debug(" - Horas Compensa : "+ horasCompensa);
															int cantidad1 = cantidad - horasCompensa;
															log.debug("ES -=Salida fuera de hora=- Tiempo de permanencia - Cantidad1 " + cantidad1 );
															if (cantidad1 > 60) {
																tiempoExtraSalida = cantidad;
																log.debug("Se considera como tiempoExtraSalida: " + tiempoExtraSalida);
															}
														}
									}//FIN 14/06/2012								
								}
								log.debug("FIN BOLSA: ES DiaLaboral");								
								/**************************************/	
																					
								try{									
																
									if (log.isDebugEnabled()) log.debug("try- generarAsistenciaTrabajador");	
									if ((Constantes.TURNO_RS067).equals(turnoDx.getTurno().trim())){
										tMov2 = Constantes.MOV_RESOLUCION_067;
										if (log.isDebugEnabled()) log.debug("tMov14:"+tMov2);
									}									
									if (horaFinMov2!=null && horaFinMov2!="") {
										log.debug("borrando asistencia PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
										t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
									}									
									Map params1 = new HashMap();
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);
									params1.put("cod_uorgan", codUO);
									params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
									params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									params1.put("mov", tMov2);
									params1.put("relojIni", relojIni2);
									params1.put("relojFin", relojFin2);
									params1.put("usuario", usuario);	
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI (SES");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else {	
										log.debug("isProcesar NO (SES)");
										boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
										if (inserto){
											log.debug("SI inserto1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO inserto1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0		
								}
								catch(Exception e){
									if (log.isDebugEnabled()) log.debug("catch- generarAsistenciaTrabajador");										
									Map params1 = new HashMap();
									params1.put("mov", tMov2);
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("usuario", usuario);
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);							
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", horaMarcacion2);
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);	
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else{
										log.debug("isProcesar NO");
									//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
										boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
										if (actualizo){
											log.debug("SI actualizo1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO actualizo1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0									
								}								
							}//fin for	
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral - new
							if (autoriClima!=null && !autoriClima.isEmpty()){
								estadoAut=autoriClima.get("ind_aut").toString().trim();
								cod_auto = autoriClima.get("cod_aut").toString().trim();
								if ((excesoClima==true || refriClima==true) && estadoAut.equals("0")){
									log.debug("actualizara estado autorizacion (codPers: "+codPers+" fechaEval: "+fechaEval+" )");
									prms.put("ind_aut", Constantes.ACTIVO);					
									prms.put("cod_user_mod", "BATCH-CLIMA-LAB");
									prms.put("cod_pers", codPers);
									prms.put("fec_aut", autoriClima.get("fec_aut_desc").toString());					
									climaLabDAO.updateRegistroAutorizaCli(prms);
									
									//envio correo
									nomApell = (autoriClima.get("t02ap_pate")!=null?autoriClima.get("t02ap_pate").toString().trim():"")+" "+(autoriClima.get("t02ap_mate")!=null?autoriClima.get("t02ap_mate").toString().trim():"")+" "+(autoriClima.get("t02nombres")!=null?autoriClima.get("t02nombres").toString().trim():"");
									mParams.put("registro",codPers);
									if (log.isDebugEnabled()) log.debug("mParamss: " + mParams);
									
									mensajeF = "El sistema ha procedido a calificar sus marcaciones de Clima Laboral para la fecha "+(String)autoriClima.get("fec_aut_desc")+".";	
									if (log.isDebugEnabled()) log.debug("mensajeFF: " + mensajeF);	
									mensaje = textoCorreoClimaLaboral(mParams,nomApell,mensajeF);//mensaje en html
									if (log.isDebugEnabled()) log.debug("mensajee: " + mensaje);																			
									Correo objCorreo = new Correo(mensaje.toString());									
									objCorreo.setServidor(propiedadesCorreo.leePropiedad("servidor"));									
									objCorreo.setRemitente(propiedadesCorreo.leePropiedad("correoRemitenteMovimientos"),propiedadesCorreo.leePropiedad("nombreRemitenteMovimientos"));
															
									correoColab=correoDAO.findCorreoByRegistro(codPers);
									correoAutoriz=correoDAO.findCorreoByRegistro(cod_auto);
														
									// VALIDANDO SI TRABAJADOR TIENE CORREO																
									if (!correoColab.equals("")) {						
										if (log.isDebugEnabled()) log.debug("correoColab Trabajador= " + correoColab);
										try{
											//trabajador tiene correo correcto, se debe enviar correo a trabajador con copia a autorizador								
											objCorreo.agregarDestinatario(correoColab.trim());
											if(!correoAutoriz.equals("")){
												objCorreo.agregarConCopia(correoAutoriz.trim());
											}
											//objCorreo.agregarConCopia("jquispecoi@sunat.gob.pe");/////ELIMINAR
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral");
											objCorreo.enviarHtml();		
											if (log.isDebugEnabled()) log.debug("Se envio correo a trabajador");	
																		
										} catch (CorreoException ce) {
											//trabajador tiene correo erroneo, hay destinatario erroneo 
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - CORREO ERR흁EO");
											objCorreo.enviarHtml();
									 		if (log.isDebugEnabled()) log.debug("Error en CorreoExceptionn: "+ce.toString());									 	
										 	if (log.isDebugEnabled()) log.debug("SI tiene correo trabajador: "+codPers+" - pero correo es erroneo");									 										 	
										}											
									}//fin if tiene correo
									else {
										//trabajador no tiene correo, no hay destinatario y se debe copiar a rrhh correo
										objCorreo.agregarConCopia(propiedadesCorreo.leePropiedad("correoReceptorAlertaCambioTurnos"));
										objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - NO TIENE CORREO");
										objCorreo.enviarHtml();							
										if (log.isDebugEnabled()) log.debug("NO tiene correo trabajador: " + codPers+" - se envio a rrhh");
									}
									//fin envio correo
								}
							}							
							//ICAPUNAY - PAS20175E230300069
								
						}//fin listaMarcaciones
					}
				}else{
					if (log.isDebugEnabled()) log.debug("horaFinTurnoDx<=horaIniTurnoDx(ope 2 dias)");
					fechaAntes = Utiles.dameFechaAnterior(fechaEval, 1);	    		   
					BeanTurnoTrabajo turnoDw = daoTurno.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,codPers,fechaAntes); //dia (x-1)
					if (log.isDebugEnabled()) log.debug("turno2 dia x-1 (turnoDw)("+codPers+"): " + turnoDw);
					if (turnoDw!=null){
						if (log.isDebugEnabled()) log.debug("registro("+codPers+"): SI turno (dia x-1) de 2 dias y SI turno dia x de 2 dias (marcaciones PARES requiere para dia x)");
						horaIniTurnoDw = turnoDw.getHoraIni().trim();
						horaFinTurnoDw = turnoDw.getHoraFin().trim();
						bOperativoW = turnoDw.isOperativo();//NUEVO						
						tieneRefrigerio = false;//NUEVO
						tieneRefrigerioW = false;//NUEVO
						if (log.isDebugEnabled()) log.debug("horaIniTurnoDw2("+codPers+"): " + horaIniTurnoDw);
						if (log.isDebugEnabled()) log.debug("horaFinTurnoDw2("+codPers+"): "+ horaFinTurnoDw);  						
						//hay 2 turnos turnoDw (anterior) y turnoDx (actual)						
						//par requiere (impar es omision) //solo S,E //09/09/14		
						
						//NUEVO
						listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
						if (log.isDebugEnabled()) log.debug("listaMarcaciones:"+listaMarcaciones);
						if (listaMarcaciones != null && listaMarcaciones.size() > 0) {
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral									
							autoriClima=climaLabDAO.findAutorizaByRegByFecha(codPers, fechaEval);
							log.debug("autoriClima: "+autoriClima);							
							if (autoriClima!=null && !autoriClima.isEmpty()){
								procesaClima=true;
							}
							//ICAPUNAY - PAS20175E230300069
							
							int j=0;
							float cantidad = 0;
							boolean esPareja=false;
							boolean tieneSalidaW=false;
							boolean tieneEntradaX=false;
							Map calificacion = new HashMap();
							for (int i = 0; i <= listaMarcaciones.size()-1; i++) {
								esPareja=false;
								if (log.isDebugEnabled()) log.debug("i:"+i);
								bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
								fechaMarcacion2 = bMarcacion2.getFecha();
								horaMarcacion2 = bMarcacion2.getHora();
								relojIni2 = bMarcacion2.getReloj();
								relojFin2 = "";
								fechaFinMov2= "";
								if (log.isDebugEnabled()) log.debug("i:"+i);								
								if (log.isDebugEnabled()) log.debug("fechaMarcacion2("+i+"):"+fechaMarcacion2);
								if (log.isDebugEnabled()) log.debug("horaMarcacion2("+i+"):"+horaMarcacion2);
							
								if (i<=listaMarcaciones.size()-2){										
									j=i+1;									
									bMSgte2 = (BeanMarcacion) listaMarcaciones.get(j);							
									fechaFinMov2 = bMSgte2.getFecha();
									horaFinMov2 = bMSgte2.getHora();
									relojFin2 = bMSgte2.getReloj();
									if (log.isDebugEnabled()) log.debug("j(i+1):"+j);									
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 int :"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 int:"+horaFinMov2);
									if (log.isDebugEnabled()) log.debug("relojFin2 int:"+relojFin2);
																			
									if(horaMarcacion2.trim().compareTo(horaFinTurnoDw.trim())<0){
										if (log.isDebugEnabled()) log.debug("entro 1");
										if (horaFinMov2.trim().compareTo(horaFinTurnoDw.trim())<0){
											if (log.isDebugEnabled()) log.debug("entro 1.1");
											esPareja=true;										
											i=j;
											if (log.isDebugEnabled()) log.debug("j:"+j);
											if (log.isDebugEnabled()) log.debug("i:"+i);
										}else{//horaFinMov2>horaFinTurnoDw
											if (log.isDebugEnabled()) log.debug("entro 1.2");
											if (tieneSalidaW==false){
												if (log.isDebugEnabled()) log.debug("entro 1.3");
												tMov2 = preCalificarSalidaOpe1(
														dbpool,
														codPers,
														fechaMarcacion2,
														horaMarcacion2,
														turnoDw.getHoraFin(),
														Constantes.MINUTO);
												if (log.isDebugEnabled()) log.debug("salida66 preCalificarSalidaOpe1(tMov2):"+tMov2);					
												horaFinMov2 = "";
												//ICR 18052015
												if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
													horaFinMov2=turnoDw.getHoraFin();
												}
												//ICR 18052015
												tieneSalidaW=true;											
												if (log.isDebugEnabled()) log.debug("tieneSalidaW:"+tieneSalidaW);
												if (log.isDebugEnabled()) log.debug("j:"+j);
												if (log.isDebugEnabled()) log.debug("i:"+i);
											}	
										}										
									}else{//horaMarcacion2>=horaFinTurnoDw
										if (log.isDebugEnabled()) log.debug("entro 2");
										if (horaMarcacion2.trim().compareTo(horaIniTurnoDx.trim())<=0){
											if (log.isDebugEnabled()) log.debug("entro 2.1");
											if (tieneSalidaW==false){
												if (log.isDebugEnabled()) log.debug("entro 2.2");
												tMov2 = Constantes.SALIDA_NORMAL; //salida
												tieneSalidaW=true;											
												horaFinMov2 = "";
												if (log.isDebugEnabled()) log.debug("i antes:"+i);												
											}else{
												if (log.isDebugEnabled()) log.debug("entro 2.3");
												if (horaFinMov2.trim().compareTo(horaIniTurnoDx.trim())<=0){
													if (log.isDebugEnabled()) log.debug("entro 2.4");
													esPareja=true;												
													i=j;
													if (log.isDebugEnabled()) log.debug("j:"+j);
													if (log.isDebugEnabled()) log.debug("i:"+i);
												}else{
													if (log.isDebugEnabled()) log.debug("entro 2.5");
													if (tieneEntradaX==false){
														if (log.isDebugEnabled()) log.debug("entro 2.6");
														tMov2 = Constantes.ENTRADA_NORMAL; //entrada
														tieneEntradaX=true;				
														horaFinMov2 = "";
														if (log.isDebugEnabled()) log.debug("i antes2:"+i);														
														if (log.isDebugEnabled()) log.debug("i:"+i);
													}
												}
											}
										}else{//horaMarcacion2>horaIniTurnoDx	
											if (log.isDebugEnabled()) log.debug("entro 2.7");
											if (tieneEntradaX==false){
												if (log.isDebugEnabled()) log.debug("entro 2.8");
												tMov2 = preCalificarEntradaOpe2(
														fechaMarcacion2,
														horaMarcacion2,
														turnoDx.getHoraIni(),
														turnoDx.getTolera(),
														turnoDx.getHoraLimite(),
														Constantes.MINUTO);
												if (log.isDebugEnabled()) log.debug("salida66 preCalificarEntradaOpe2(tMov2):"+tMov2);
												tieneEntradaX=true;												
												horaFinMov2 = "";
												//hsal cuando es tardanza 01 se coloca valor
												if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO) ) {
													horaFinMov2=turnoDx.getHoraIni();
												}
												//fin hsal
												if (log.isDebugEnabled()) log.debug("j:"+j);
												if (log.isDebugEnabled()) log.debug("i:"+i);
											}else{
												if (log.isDebugEnabled()) log.debug("entro 2.9");
												if (horaFinMov2.trim().compareTo(horaIniTurnoDx.trim())>0){
													if (log.isDebugEnabled()) log.debug("entro 2.10");
													esPareja=true;											
													i=j;
													if (log.isDebugEnabled()) log.debug("j:"+j);
													if (log.isDebugEnabled()) log.debug("i:"+i);
												}
											}
										}										
									}									
									
									if (esPareja){
										if (log.isDebugEnabled()) log.debug("espareja==true");
										//calificacion = preCalificarMovimientoOpe3(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDw, turnoDx,	Constantes.MINUTO,tieneRefrigerioW, tieneRefrigerio,bOperativoW,bOperativo2); ////ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										calificacion = preCalificarMovimientoOpe3(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDw, turnoDx,Constantes.MINUTO,tieneRefrigerioW, tieneRefrigerio,bOperativoW,bOperativo2,procesaClima,minMaxClima); ////ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										if (log.isDebugEnabled()) log.debug("salida66 preCalificarMovimientoOpe3(calificacion):"+calificacion);

										tMov2=(String)calificacion.get("calif");
										
										/*if(calificacion.get("refrigerioW").equals("SI")){
											if (log.isDebugEnabled()) log.debug("refrigerioW==SI");
											if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) {
												if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
												tieneRefrigerioW = true;
												if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2:"+fechaMarcacion2 + " " + horaMarcacion2);
												if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2:"+fechaMarcacion2 + " " + horaFinMov2);
												float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
												float quedan = turnoDw.getMinutosRefrigerio() - durante1;
												if (log.isDebugEnabled()) log.debug("tieneRefrigerioW:"+tieneRefrigerioW);
												if (log.isDebugEnabled()) log.debug("durante1 w:"+durante1);
												if (log.isDebugEnabled()) log.debug("quedan w:"+quedan);
												turnoDw.setMinutosRefrigerio( new Float(quedan).intValue());
												log.debug("turnoDw(setMinutosRefrigerio o quedan) : " + quedan);
											}
										}*/	

										if(calificacion.get("refrigerioX").equals("SI")){
											if (log.isDebugEnabled()) log.debug("refrigerioX==SI");
											//if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) { ////ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
											if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)) { ////ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
												if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
												// ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
												Map calificacionActual=null;
												calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "2", "3","5"); //0=calificacion inicial, 2=papeleta aprobada, 3= papeleta procesada, //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral (adicion 5=calificacion por rrhh)
												if (log.isDebugEnabled()) log.debug("calificacionActuall : "+calificacionActual);												
												if (calificacionActual!=null){
													if (log.isDebugEnabled()) log.debug("entrooooo");
													movAct= calificacionActual.get("mov").toString().trim();//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													//if (tMov2.trim().equals(calificacionActual.get("mov").toString().trim())){ ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (movAct.equals(Constantes.MOV_EXCESO_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRI_CLIMALABORAL) ){ //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (log.isDebugEnabled()) log.debug("movAct igual a refri, exceso o refri clima");
														if (log.isDebugEnabled()) log.debug("tMov2 : "+tMov2);
														if (log.isDebugEnabled()) log.debug("calificacionActual : "+calificacionActual);
														
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio : "+tieneRefrigerio);
														if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
														tieneRefrigerio = true;
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2:"+fechaMarcacion2 + " " + horaMarcacion2);
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2:"+fechaMarcacion2 + " " + horaFinMov2);
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1 x:"+durante1);
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio:"+tieneRefrigerio);
														
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
															if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
															minMaxClima= new Float(quedan).intValue();
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("turnoDx.getMinutosRefrigerio(): "+turnoDx.getMinutosRefrigerio());
															log.debug("quedan: " + quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());															
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														
													}else{
														tieneRefrigerio = false;
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio: "+tieneRefrigerio);
													}
														
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas
												else{													
													calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "0", "0","0"); //0=calificacion inicial
													if (log.isDebugEnabled()) log.debug("calificacionActual2 : "+calificacionActual);
													if (calificacionActual==null){
														tieneRefrigerio = true;
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
														
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
															if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
															minMaxClima= new Float(quedan).intValue();
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("turnoDx.getMinutosRefrigerio(): "+turnoDx.getMinutosRefrigerio());
															log.debug("quedan: " + quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());															
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral													
													}													
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas												
												//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
											}
										}
									}												
									//todo									
								}else{
									//llego aca
									if (log.isDebugEnabled()) log.debug("no debe llegar aca PLANILLA-ultima marcacion");
									if (log.isDebugEnabled()) log.debug("j:"+j);
									if (log.isDebugEnabled()) log.debug("i:"+i);
									if (listaMarcaciones.size()==1){
										tMov2 = Constantes.MOV_OMISION_MARCA;
										if (log.isDebugEnabled()) log.debug("tMov una marcacion-PLANILLA:"+tMov2);
									}else{
										if (tieneSalidaW==false){
											if (log.isDebugEnabled()) log.debug("entro 1.3");
											tMov2 = preCalificarSalidaOpe1(
													dbpool,
													codPers,
													fechaMarcacion2,
													horaMarcacion2,
													turnoDw.getHoraFin(),
													Constantes.MINUTO);
											if (log.isDebugEnabled()) log.debug("salida66 preCalificarSalidaOpe1(tMov2):"+tMov2);					
											horaFinMov2 = "";
											//ICR 18052015
											if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
												horaFinMov2=turnoDw.getHoraFin();
											}
											//ICR 18052015
											tieneSalidaW=true;											
											if (log.isDebugEnabled()) log.debug("tieneSalidaW:"+tieneSalidaW);
											if (log.isDebugEnabled()) log.debug("j:"+j);
											if (log.isDebugEnabled()) log.debug("i:"+i);
										}
										else{//tieneSalidaW==true
											if (tieneEntradaX==false){											
												if (log.isDebugEnabled()) log.debug("entro 3.0");
												tMov2 = preCalificarEntradaOpe2(
														fechaMarcacion2,
														horaMarcacion2,
														turnoDx.getHoraIni(),
														turnoDx.getTolera(),
														turnoDx.getHoraLimite(),
														Constantes.MINUTO);
												if (log.isDebugEnabled()) log.debug("salida66 preCalificarEntradaOpe2(tMov2):"+tMov2);
												tieneEntradaX=true;												
												horaFinMov2 = "";
												//hsal cuando es tardanza 01 se coloca valor
												if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO) ) {
													horaFinMov2=turnoDx.getHoraIni();
												}
												//fin hsal
											}else{
												tMov2 = Constantes.MOV_OMISION_MARCA;
												if (log.isDebugEnabled()) log.debug("tMov5-PLANILLA:"+tMov2);
											}
										}
									}									
								}
								//fin llego aca																	
								
								try{
									if (horaFinMov2!=null && horaFinMov2!="") {
										if (log.isDebugEnabled()) log.debug("horaFinMov2!=null y horaFinMov2!=vacio");
										if (log.isDebugEnabled()) log.debug("codPers:"+codPers+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"/fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2);
										log.debug("borrando6 asistencia PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
										t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
									}
									Map params1 = new HashMap();
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);
									params1.put("cod_uorgan", codUO);
									params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
									params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									params1.put("mov", tMov2);
									params1.put("relojIni", relojIni2);
									params1.put("relojFin", relojFin2);
									params1.put("usuario", usuario);
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI (SES");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else {	
										log.debug("isProcesar NO (SES)");
										boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
										if (inserto){
											log.debug("SI inserto1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO inserto1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0							
								}
								catch(Exception e){
									if (log.isDebugEnabled()) log.debug("catch6- generarAsistenciaTrabajador");										
									Map params1 = new HashMap();
									params1.put("mov", tMov2);
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("usuario", usuario);
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);							
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", horaMarcacion2);
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);	
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else{
										log.debug("isProcesar NO");
									//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
										boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
										if (actualizo){
											log.debug("SI actualizo1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO actualizo1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0									
								}
							}//fin for ok	
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral - new
							if (autoriClima!=null && !autoriClima.isEmpty()){
								estadoAut=autoriClima.get("ind_aut").toString().trim();
								cod_auto = autoriClima.get("cod_aut").toString().trim();
								if ((excesoClima==true || refriClima==true) && estadoAut.equals("0")){
									log.debug("actualizara estado autorizacion (codPers: "+codPers+" fechaEval: "+fechaEval+" )");
									prms.put("ind_aut", Constantes.ACTIVO);					
									prms.put("cod_user_mod", "BATCH-CLIMA-LAB");
									prms.put("cod_pers", codPers);
									prms.put("fec_aut", autoriClima.get("fec_aut_desc").toString());					
									climaLabDAO.updateRegistroAutorizaCli(prms);
									
									//envio correo
									nomApell = (autoriClima.get("t02ap_pate")!=null?autoriClima.get("t02ap_pate").toString().trim():"")+" "+(autoriClima.get("t02ap_mate")!=null?autoriClima.get("t02ap_mate").toString().trim():"")+" "+(autoriClima.get("t02nombres")!=null?autoriClima.get("t02nombres").toString().trim():"");
									mParams.put("registro",codPers);
									if (log.isDebugEnabled()) log.debug("mParamss: " + mParams);
									
									mensajeF = "El sistema ha procedido a calificar sus marcaciones de Clima Laboral para la fecha "+(String)autoriClima.get("fec_aut_desc")+".";	
									if (log.isDebugEnabled()) log.debug("mensajeFF: " + mensajeF);	
									mensaje = textoCorreoClimaLaboral(mParams,nomApell,mensajeF);//mensaje en html
									if (log.isDebugEnabled()) log.debug("mensajee: " + mensaje);																			
									Correo objCorreo = new Correo(mensaje.toString());									
									objCorreo.setServidor(propiedadesCorreo.leePropiedad("servidor"));									
									objCorreo.setRemitente(propiedadesCorreo.leePropiedad("correoRemitenteMovimientos"),propiedadesCorreo.leePropiedad("nombreRemitenteMovimientos"));
															
									correoColab=correoDAO.findCorreoByRegistro(codPers);
									correoAutoriz=correoDAO.findCorreoByRegistro(cod_auto);
														
									// VALIDANDO SI TRABAJADOR TIENE CORREO																
									if (!correoColab.equals("")) {						
										if (log.isDebugEnabled()) log.debug("correoColab Trabajador= " + correoColab);
										try{
											//trabajador tiene correo correcto, se debe enviar correo a trabajador con copia a autorizador								
											objCorreo.agregarDestinatario(correoColab.trim());
											if(!correoAutoriz.equals("")){
												objCorreo.agregarConCopia(correoAutoriz.trim());
											}
											//objCorreo.agregarConCopia("jquispecoi@sunat.gob.pe");/////ELIMINAR
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral");
											objCorreo.enviarHtml();		
											if (log.isDebugEnabled()) log.debug("Se envio correo a trabajador");	
																		
										} catch (CorreoException ce) {
											//trabajador tiene correo erroneo, hay destinatario erroneo 
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - CORREO ERR흁EO");
											objCorreo.enviarHtml();
									 		if (log.isDebugEnabled()) log.debug("Error en CorreoExceptionn: "+ce.toString());									 	
										 	if (log.isDebugEnabled()) log.debug("SI tiene correo trabajador: "+codPers+" - pero correo es erroneo");									 										 	
										}											
									}//fin if tiene correo
									else {
										//trabajador no tiene correo, no hay destinatario y se debe copiar a rrhh correo
										objCorreo.agregarConCopia(propiedadesCorreo.leePropiedad("correoReceptorAlertaCambioTurnos"));
										objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - NO TIENE CORREO");
										objCorreo.enviarHtml();							
										if (log.isDebugEnabled()) log.debug("NO tiene correo trabajador: " + codPers+" - se envio a rrhh");
									}
									//fin envio correo
								}
							}							
							//ICAPUNAY - PAS20175E230300069
						}
						//FIN NUEVO			
						
					}else{
						if (log.isDebugEnabled()) log.debug("registro("+codPers+"): NO turno (dia x-1) de 2 dias y SI turno dia x de 2 dias (marcaciones IMPARES requiere para dia x)");
						tieneRefrigerio = false;
						//preCalificarEntradaOpe2 //preCalificarMovimientoOpe2 //solo E
						//impar requiere (AJUSTAR PARA SI HORA LIMITE ES PASADA LAS 00:00 NO COLOQUE INASISTENCIA CUANDO INGRESA A LAS 16:30 08/09/2014 par es omision)
						
						listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
						if (log.isDebugEnabled()) log.debug("listaMarcaciones:"+listaMarcaciones);
						if (listaMarcaciones != null && listaMarcaciones.size() > 0) {
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral													
							autoriClima=climaLabDAO.findAutorizaByRegByFecha(codPers, fechaEval);
							log.debug("autoriClima: "+autoriClima);							
							if (autoriClima!=null && !autoriClima.isEmpty()){
								procesaClima=true;
							}
							//ICAPUNAY - PAS20175E230300069
							
							for (int i = 0; i < listaMarcaciones.size(); i++) {	
								bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
								fechaMarcacion2 = bMarcacion2.getFecha();
								horaMarcacion2 = bMarcacion2.getHora();
								relojIni2 = bMarcacion2.getReloj();
								relojFin2 = "";
								if (log.isDebugEnabled()) log.debug("i:"+i);
								if (log.isDebugEnabled()) log.debug("bMarcacion2("+i+"):"+bMarcacion2);
								if (log.isDebugEnabled()) log.debug("fechaMarcacion2("+i+"):"+fechaMarcacion2);
								if (log.isDebugEnabled()) log.debug("horaMarcacion2("+i+"):"+horaMarcacion2);
								if (i == 0){//primera marcacion es ENTRADA
									if (log.isDebugEnabled()) log.debug("primera marca");
									fechaFinMov2 = bMarcacion2.getFecha();
									horaFinMov2 = "";
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 ent:"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 ent:"+horaFinMov2);									
									tMov2 = preCalificarEntradaOpe2(
											fechaMarcacion2,
											horaMarcacion2,
											turnoDx.getHoraIni(),
											turnoDx.getTolera(),
											turnoDx.getHoraLimite(),
											Constantes.MINUTO);
									if (log.isDebugEnabled()) log.debug("salida6.1 preCalificarEntradaOpe2(tMov2):"+tMov2);	
									
								}
								//movimientos intermedios
								else{
									if (log.isDebugEnabled()) log.debug("marcaciones6 en pareja desde inicio(i):"+i);					
									if (log.isDebugEnabled()) log.debug("listaMarcaciones.size():"+listaMarcaciones.size());							
									if (i <= (listaMarcaciones.size() - 2)) {
										if (log.isDebugEnabled()) log.debug("i:"+i);
										bMSgte2 = (BeanMarcacion) listaMarcaciones.get(++i);							
										fechaFinMov2 = bMSgte2.getFecha();
										horaFinMov2 = bMSgte2.getHora();
										relojFin2 = bMSgte2.getReloj();
										if (log.isDebugEnabled()) log.debug("bMSgte2 int:"+bMSgte2);
										if (log.isDebugEnabled()) log.debug("fechaFinMov2 int :"+fechaFinMov2);
										if (log.isDebugEnabled()) log.debug("horaFinMov2 int:"+horaFinMov2);
										if (log.isDebugEnabled()) log.debug("relojFin2 int:"+relojFin2);
										if (log.isDebugEnabled()) log.debug("i2:"+i);																													
										//tMov2 = preCalificarMovimientoOpe2(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDx,	Constantes.MINUTO, tieneRefrigerio,	bOperativo2); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										tMov2 = preCalificarMovimientoOpe2(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDx,Constantes.MINUTO, tieneRefrigerio,bOperativo2,procesaClima,minMaxClima); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										if (log.isDebugEnabled()) log.debug("salida6 preCalificarMovimientoOpe2(tMov2):"+tMov2);	

										//if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
											if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
											// ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
											Map calificacionActual=null;
											calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "2", "3","5"); //0=calificacion inicial, 2=papeleta aprobada, 3= papeleta procesada, //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral (adicion 5=calificacion por rrhh)
											if (log.isDebugEnabled()) log.debug("calificacionActuall : "+calificacionActual);												
											if (calificacionActual!=null){
												if (log.isDebugEnabled()) log.debug("entrooooo");
												movAct= calificacionActual.get("mov").toString().trim();//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
												//if (tMov2.trim().equals(calificacionActual.get("mov").toString().trim())){ ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
												if (movAct.equals(Constantes.MOV_EXCESO_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRI_CLIMALABORAL) ){ //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (log.isDebugEnabled()) log.debug("movAct igual a refri, exceso o refri clima");
													if (log.isDebugEnabled()) log.debug("tMov2 : "+tMov2);
													if (log.isDebugEnabled()) log.debug("calificacionActual : "+calificacionActual);
													
													if (log.isDebugEnabled()) log.debug("tieneRefrigerio : "+tieneRefrigerio);
													if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
													tieneRefrigerio = true;
													if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2:"+fechaMarcacion2 + " " + horaMarcacion2);
													if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2:"+fechaMarcacion2 + " " + horaFinMov2);
													float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
													if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
													
													//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (procesaClima){
														float quedan = minMaxClima - durante1;	
														if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
														if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
														minMaxClima= new Float(quedan).intValue();
														//new
														if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
															excesoClima=true;
														}
														if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
															refriClima=true;
														}
														//new
													}else{
													//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
														float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
														log.debug("turnoDx.getMinutosRefrigerio(): " + turnoDx.getMinutosRefrigerio());
														if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
														turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());
													}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													
												}else{
													tieneRefrigerio = false;
													if (log.isDebugEnabled()) log.debug("tieneRefrigerio: "+tieneRefrigerio);
												}
													
											}
											//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas
											else{													
												calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "0", "0","0"); //0=calificacion inicial
												if (log.isDebugEnabled()) log.debug("calificacionActual2 : "+calificacionActual);
												if (calificacionActual==null){
													tieneRefrigerio = true;
													float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
													if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
													
													//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (procesaClima){
														float quedan = minMaxClima - durante1;	
														if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
														if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
														minMaxClima= new Float(quedan).intValue();
														//new
														if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
															excesoClima=true;
														}
														if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
															refriClima=true;
														}
														//new
													}else{
													//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
														float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
														log.debug("turnoDx.getMinutosRefrigerio(): " + turnoDx.getMinutosRefrigerio());
														if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
														turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());
													}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral													
												}													
											}
											//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas											
											//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
										}																						
									}else{//marcacion par
										if (log.isDebugEnabled()) log.debug("marcacion par PLANILLA(i):"+i);
										fechaFinMov2 = bMarcacion2.getFecha();
										horaFinMov2 = "";																				
										tMov2 = Constantes.MOV_OMISION_MARCA;
										//tMov2 = Constantes.MOV_SALIDA_AUTORIZADA;
										if (log.isDebugEnabled()) log.debug("tMov12-PLANILLA:"+tMov2);										
									}																	
								}
								//fin mov intermedios

								try{
									if (horaFinMov2!=null && horaFinMov2!="") {
										log.debug("borrando6 asistencia PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
										t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
									}
									Map params1 = new HashMap();
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);
									params1.put("cod_uorgan", codUO);
									params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
									params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									params1.put("mov", tMov2);
									params1.put("relojIni", relojIni2);
									params1.put("relojFin", relojFin2);
									params1.put("usuario", usuario);	
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI (SES");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else {	
										log.debug("isProcesar NO (SES)");
										boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
										if (inserto){
											log.debug("SI inserto1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO inserto1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0						
								}
								catch(Exception e){
									if (log.isDebugEnabled()) log.debug("catch6- generarAsistenciaTrabajador");										
									Map params1 = new HashMap();
									params1.put("mov", tMov2);
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("usuario", usuario);
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);							
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", horaMarcacion2);
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);	
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else{
										log.debug("isProcesar NO");
									//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
										boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
										if (actualizo){
											log.debug("SI actualizo1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO actualizo1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0									
								}
							}//fin for ok
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral - new
							if (autoriClima!=null && !autoriClima.isEmpty()){
								estadoAut=autoriClima.get("ind_aut").toString().trim();
								cod_auto = autoriClima.get("cod_aut").toString().trim();
								if ((excesoClima==true || refriClima==true) && estadoAut.equals("0")){
									log.debug("actualizara estado autorizacion (codPers: "+codPers+" fechaEval: "+fechaEval+" )");
									prms.put("ind_aut", Constantes.ACTIVO);					
									prms.put("cod_user_mod", "BATCH-CLIMA-LAB");
									prms.put("cod_pers", codPers);
									prms.put("fec_aut", autoriClima.get("fec_aut_desc").toString());					
									climaLabDAO.updateRegistroAutorizaCli(prms);
									
									//envio correo
									nomApell = (autoriClima.get("t02ap_pate")!=null?autoriClima.get("t02ap_pate").toString().trim():"")+" "+(autoriClima.get("t02ap_mate")!=null?autoriClima.get("t02ap_mate").toString().trim():"")+" "+(autoriClima.get("t02nombres")!=null?autoriClima.get("t02nombres").toString().trim():"");
									mParams.put("registro",codPers);
									if (log.isDebugEnabled()) log.debug("mParamss: " + mParams);
									
									mensajeF = "El sistema ha procedido a calificar sus marcaciones de Clima Laboral para la fecha "+(String)autoriClima.get("fec_aut_desc")+".";	
									if (log.isDebugEnabled()) log.debug("mensajeFF: " + mensajeF);	
									mensaje = textoCorreoClimaLaboral(mParams,nomApell,mensajeF);//mensaje en html
									if (log.isDebugEnabled()) log.debug("mensajee: " + mensaje);																			
									Correo objCorreo = new Correo(mensaje.toString());									
									objCorreo.setServidor(propiedadesCorreo.leePropiedad("servidor"));									
									objCorreo.setRemitente(propiedadesCorreo.leePropiedad("correoRemitenteMovimientos"),propiedadesCorreo.leePropiedad("nombreRemitenteMovimientos"));
															
									correoColab=correoDAO.findCorreoByRegistro(codPers);
									correoAutoriz=correoDAO.findCorreoByRegistro(cod_auto);
														
									// VALIDANDO SI TRABAJADOR TIENE CORREO																
									if (!correoColab.equals("")) {						
										if (log.isDebugEnabled()) log.debug("correoColab Trabajador= " + correoColab);
										try{
											//trabajador tiene correo correcto, se debe enviar correo a trabajador con copia a autorizador								
											objCorreo.agregarDestinatario(correoColab.trim());
											if(!correoAutoriz.equals("")){
												objCorreo.agregarConCopia(correoAutoriz.trim());
											}
											//objCorreo.agregarConCopia("jquispecoi@sunat.gob.pe");/////ELIMINAR
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral");
											objCorreo.enviarHtml();		
											if (log.isDebugEnabled()) log.debug("Se envio correo a trabajador");	
																		
										} catch (CorreoException ce) {
											//trabajador tiene correo erroneo, hay destinatario erroneo 
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - CORREO ERR흁EO");
											objCorreo.enviarHtml();
									 		if (log.isDebugEnabled()) log.debug("Error en CorreoExceptionn: "+ce.toString());									 	
										 	if (log.isDebugEnabled()) log.debug("SI tiene correo trabajador: "+codPers+" - pero correo es erroneo");									 										 	
										}											
									}//fin if tiene correo
									else {
										//trabajador no tiene correo, no hay destinatario y se debe copiar a rrhh correo
										objCorreo.agregarConCopia(propiedadesCorreo.leePropiedad("correoReceptorAlertaCambioTurnos"));
										objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - NO TIENE CORREO");
										objCorreo.enviarHtml();							
										if (log.isDebugEnabled()) log.debug("NO tiene correo trabajador: " + codPers+" - se envio a rrhh");
									}
									//fin envio correo
								}
							}							
							//ICAPUNAY - PAS20175E230300069
						}						
					}
				}				
			}//fin turnoDx!=null
			else{
				if (log.isDebugEnabled()) log.debug("NO tiene turno dia x");
				fechaAntes = Utiles.dameFechaAnterior(fechaEval, 1);	    		   
				BeanTurnoTrabajo turnoDw = daoTurno.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,codPers,fechaAntes); //dia (x-1)
				if (log.isDebugEnabled()) log.debug("turno3 dia x-1 (turnoDw)("+codPers+"): " + turnoDw);
				if (turnoDw!=null){	
					if (log.isDebugEnabled()) log.debug("registro("+codPers+"): SI turno (dia x-1) de 2 dias y NO turno dia x (marcaciones IMPARES requiere para dia x)");
					horaIniTurnoDw = turnoDw.getHoraIni().trim();
					horaFinTurnoDw = turnoDw.getHoraFin().trim();
					bOperativo2 = turnoDw.isOperativo();
					tieneRefrigerio = false;
					if (log.isDebugEnabled()) log.debug("horaIniTurnoDw3("+codPers+"): " + horaIniTurnoDw);
					if (log.isDebugEnabled()) log.debug("horaFinTurnoDw3("+codPers+"): "+ horaFinTurnoDw);
					
					//preCalificarSalidaOpe1 //preCalificarMovimientoOpe1 //solo S
					
					//impar requiere (13/09/2014 par es omision)
					//coloque refrigerio de 03 a 05 al turno C06 y debe tomar 60 min (pruebas)
					//hora limite 00:30 y tolerancia 10 min al turno C06 (hora inicio turno 22:30 para el 12/09/2014)
					listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
					if (log.isDebugEnabled()) log.debug("listaMarcaciones:"+listaMarcaciones);
					if (listaMarcaciones != null && listaMarcaciones.size() > 0) {	
						for (int i = 0; i < listaMarcaciones.size(); i++) {	
							bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
							fechaMarcacion2 = bMarcacion2.getFecha();
							horaMarcacion2 = bMarcacion2.getHora();
							relojIni2 = bMarcacion2.getReloj();
							relojFin2 = "";
							if (log.isDebugEnabled()) log.debug("i:"+i);
							if (log.isDebugEnabled()) log.debug("bMarcacion2("+i+"):"+bMarcacion2);
							if (log.isDebugEnabled()) log.debug("fechaMarcacion2("+i+"):"+fechaMarcacion2);
							if (log.isDebugEnabled()) log.debug("horaMarcacion2("+i+"):"+horaMarcacion2);
							if (i == (listaMarcaciones.size() - 1)){//ultima marcacion es SALIDA
								if (log.isDebugEnabled()) log.debug("ultima marca");
								fechaFinMov2 = bMarcacion2.getFecha();
								horaFinMov2 = "";
								if (log.isDebugEnabled()) log.debug("fechaFinMov2 sal:"+fechaFinMov2);
								if (log.isDebugEnabled()) log.debug("horaFinMov2 sal:"+horaFinMov2);									
								tMov2 = preCalificarSalidaOpe1(
										dbpool,
										codPers,
										fechaMarcacion2,
										horaMarcacion2,
										turnoDw.getHoraFin(),
										Constantes.MINUTO);
								if (log.isDebugEnabled()) log.debug("salida2 preCalificarSalidaOpe1(tMov2):"+tMov2);
								//ICR 18052015
								if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
									horaFinMov2=turnoDw.getHoraFin();
								}
								//ICR 18052015
							}
							//movimientos intermedios
							else{
								if (log.isDebugEnabled()) log.debug("marcaciones en pareja desde inicio(i):"+i);					
								if (log.isDebugEnabled()) log.debug("listaMarcaciones.size():"+listaMarcaciones.size());							
								if (i < (listaMarcaciones.size() - 2)) {
									if (log.isDebugEnabled()) log.debug("i:"+i);
									bMSgte2 = (BeanMarcacion) listaMarcaciones.get(++i);							
									fechaFinMov2 = bMSgte2.getFecha();
									horaFinMov2 = bMSgte2.getHora();
									relojFin2 = bMSgte2.getReloj();
									if (log.isDebugEnabled()) log.debug("bMSgte2 int:"+bMSgte2);
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 int :"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 int:"+horaFinMov2);
									if (log.isDebugEnabled()) log.debug("relojFin2 int:"+relojFin2);
									if (log.isDebugEnabled()) log.debug("i2:"+i);																													
									tMov2 = preCalificarMovimientoOpe1(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDw,	Constantes.MINUTO, tieneRefrigerio,	bOperativo2);
									if (log.isDebugEnabled()) log.debug("salida preCalificarMovimientoOpe1(tMov2):"+tMov2);	

									/*if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) {
										if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
										tieneRefrigerio = true;
										if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2:"+fechaMarcacion2 + " " + horaMarcacion2);
										if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2:"+fechaMarcacion2 + " " + horaFinMov2);
										float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
										float quedan = turnoDw.getMinutosRefrigerio() - durante1;
										if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
										if (log.isDebugEnabled()) log.debug("quedan:"+quedan);
										turnoDw.setMinutosRefrigerio( new Float(quedan).intValue());
										log.debug("turnoDw(setMinutosRefrigerio o quedan) : " + quedan);
									}*/																						
								}else{//marcacion par
									if (log.isDebugEnabled()) log.debug("marcacion par PLANILLA(i):"+i);
									fechaFinMov2 = bMarcacion2.getFecha();
									horaFinMov2 = "";																				
									tMov2 = Constantes.MOV_OMISION_MARCA;
									//tMov2 = Constantes.MOV_SALIDA_AUTORIZADA;
									if (log.isDebugEnabled()) log.debug("tMov12-PLANILLA:"+tMov2);										
								}																	
							}
							//fin mov intermedios

							try{
								if (horaFinMov2!=null && horaFinMov2!="") {
									log.debug("borrando5 asistencia PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
									t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
								}
								Map params1 = new HashMap();
								params1.put("cod_pers", codPers);
								params1.put("periodo", periodo);
								params1.put("cod_uorgan", codUO);
								params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
								params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
								params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
								params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
								params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
								params1.put("mov", tMov2);
								params1.put("relojIni", relojIni2);
								params1.put("relojFin", relojFin2);
								params1.put("usuario", usuario);	
								
								//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
								if (isProcesar.equals("SI")){
									log.debug("isProcesar SI (SES");
									if (papeletasGeneradas==null){
										papeletasGeneradas = new ArrayList();											
									}
										
									params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
									List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																		
									if(lstPapeletaGenerada.size()>0){
										HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
										hmPapeletaGenerada.put("mov",tMov2);
										hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
										papeletasGeneradas.add(hmPapeletaGenerada);
										log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
									}									
								}else {	
									log.debug("isProcesar NO (SES)");
									boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
									if (inserto){
										log.debug("SI inserto1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}else{										
										log.debug("NO inserto1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}	
								}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0						
							}
							catch(Exception e){
								if (log.isDebugEnabled()) log.debug("catch2- generarAsistenciaTrabajador");										
								Map params1 = new HashMap();
								params1.put("mov", tMov2);
								params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
								params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
								params1.put("usuario", usuario);
								params1.put("cod_pers", codPers);
								params1.put("periodo", periodo);							
								params1.put("fechaMarcacion", fechaMarcacion2);
								params1.put("horaMarcacion", horaMarcacion2);
								params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
								
								//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
								if (isProcesar.equals("SI")){
									log.debug("isProcesar SI");
									if (papeletasGeneradas==null){
										papeletasGeneradas = new ArrayList();											
									}
										
									params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
									List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																		
									if(lstPapeletaGenerada.size()>0){
										HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
										hmPapeletaGenerada.put("mov",tMov2);
										hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
										papeletasGeneradas.add(hmPapeletaGenerada);
										log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
									}									
								}else{
									log.debug("isProcesar NO");
								//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
									if (actualizo){
										log.debug("SI actualizo1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}else{										
										log.debug("NO actualizo1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}	
								}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0									
							}
						}//fin for ok						
					}					
				}else{
					if (log.isDebugEnabled()) log.debug("registro("+codPers+"): NO turno (dia x-1) de 2 dias y NO turno dia x");
					BeanTurnoTrabajo turnoNoControlado = null;
					BeanTurnoTrabajo turnoNoControl1 = daoTurno.joinWithT45ByCodPersFecha_NoControlado_OperAdm1dia(dbpool,codPers,fechaEval);
					if (turnoNoControl1!=null){
						turnoNoControlado=turnoNoControl1;					    
					}else{
						BeanTurnoTrabajo turnoNoControl2 = daoTurno.joinWithT45ByCodPersFecha_NoControlado_Oper2dias(dbpool,codPers,fechaEval);
						turnoNoControlado=turnoNoControl2;				    
					}
					if (log.isDebugEnabled()) log.debug("turnoNoControlado("+fechaEval+"): " + "("+codPers+"): "+turnoNoControlado);
					
					if (turnoNoControlado!=null){//tiene turno no controlado de 1 o 2 dias (adm u ope)
						//no control 2 dias (ope: 43, 002 {lo puede trabajar como turno no controlado operativo de 1 dia})
						
						listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
						if (log.isDebugEnabled()) log.debug("listaMarcaciones:"+listaMarcaciones);
						if (listaMarcaciones != null && listaMarcaciones.size() > 0) {
							for (int i = 0; i < listaMarcaciones.size(); i++) {	
								bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
								fechaMarcacion2 = bMarcacion2.getFecha();
								horaMarcacion2 = bMarcacion2.getHora();
								relojIni2 = bMarcacion2.getReloj();
								relojFin2 = "";									
								if ((i==0) || i == (listaMarcaciones.size() - 1)){
									if (log.isDebugEnabled()) log.debug("marcaciones primera o ultima");
									fechaFinMov2 = bMarcacion2.getFecha();
									horaFinMov2 = "";										
								}else{//movs intermedios
									if (log.isDebugEnabled()) log.debug("marcaciones en pareja");
									if (i < (listaMarcaciones.size() - 2)) {
										if (log.isDebugEnabled()) log.debug("i:"+i);
										bMSgte2 = (BeanMarcacion) listaMarcaciones.get(++i);							
										fechaFinMov2 = bMSgte2.getFecha();
										horaFinMov2 = bMSgte2.getHora();
										relojFin2 = bMSgte2.getReloj();											
									}else{//marcacion impar
										if (log.isDebugEnabled()) log.debug("marcacion impar");
										fechaFinMov2 = bMarcacion2.getFecha();
										horaFinMov2 = "";																			
									}
								}
								if ((Constantes.TURNO_RS067).equals(turnoNoControlado.getTurno().trim())){
									tMov2 = Constantes.MOV_RESOLUCION_067;										
								}else{//otros turnos no control 1 dia
									tMov2 = Constantes.MOV_TRABAJO_CAMPO;
								}
								if (log.isDebugEnabled()) log.debug("tMov2:"+tMov2);

								try{
									if (horaFinMov2!=null && horaFinMov2!="") {
										log.debug("borrando2 asistencia PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
										t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
									}
									Map params1 = new HashMap();
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);
									params1.put("cod_uorgan", codUO);
									params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
									params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									params1.put("mov", tMov2);
									params1.put("relojIni", relojIni2);
									params1.put("relojFin", relojFin2);
									params1.put("usuario", usuario);	
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI (SES");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else {	
										log.debug("isProcesar NO (SES)");
										boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
										if (inserto){
											log.debug("SI inserto1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO inserto1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0					
								}
								catch(Exception e){
									if (log.isDebugEnabled()) log.debug("catch2- generarAsistenciaTrabajador");										
									Map params1 = new HashMap();
									params1.put("mov", tMov2);
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("usuario", usuario);
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);							
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", horaMarcacion2);
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else{
										log.debug("isProcesar NO");
									//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
										boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
										if (actualizo){
											log.debug("SI actualizo1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO actualizo1 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0									
								}									
							}								
						}							
											
					}else{
						//no tiene ningun turno (APORTACION)
						if (log.isDebugEnabled()) log.debug("Ningun turno-No debe calificar");
						/* //No debe calificar nada
						listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
						if (log.isDebugEnabled()) log.debug("listaMarcaciones:"+listaMarcaciones);
						if (listaMarcaciones != null && listaMarcaciones.size() > 0) {
							for (int i = 0; i < listaMarcaciones.size(); i++) {	
								bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
								fechaMarcacion2 = bMarcacion2.getFecha();
								horaMarcacion2 = bMarcacion2.getHora();
								relojIni2 = bMarcacion2.getReloj();
								relojFin2 = "";									
								if ((i==0) || i == (listaMarcaciones.size() - 1)){
									if (log.isDebugEnabled()) log.debug("marcaciones primera o ultima");
									fechaFinMov2 = bMarcacion2.getFecha();
									horaFinMov2 = "";												
								}else{//movs intermedios
									if (log.isDebugEnabled()) log.debug("marcaciones en pareja");
									if (i < (listaMarcaciones.size() - 2)) {
										if (log.isDebugEnabled()) log.debug("i:"+i);
										bMSgte2 = (BeanMarcacion) listaMarcaciones.get(++i);							
										fechaFinMov2 = bMSgte2.getFecha();
										horaFinMov2 = bMSgte2.getHora();
										relojFin2 = bMSgte2.getReloj();																											
									}else{//marcacion impar
										if (log.isDebugEnabled()) log.debug("marcacion impar");
										fechaFinMov2 = bMarcacion2.getFecha();
										horaFinMov2 = "";																		
									}										
								}
								if (turnoNoControlado==null){
									tMov2 = Constantes.MOV_APORTACION;										
								}							
								try{
									if (horaFinMov2!=null && horaFinMov2!="") {
										log.debug("borrando3 asistencia PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
										t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
									}
									Map params1 = new HashMap();
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);
									params1.put("cod_uorgan", codUO);
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
									params1.put("fechaFinMov", fechaFinMov2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									params1.put("mov", tMov2);
									params1.put("relojIni", relojIni2);
									params1.put("relojFin", relojFin2);
									params1.put("usuario", usuario);										
									boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
									if (inserto){
										log.debug("SI inserto3 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}else{										
										log.debug("NO inserto3 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}			
								}
								catch(Exception e){
									if (log.isDebugEnabled()) log.debug("catch3- generarAsistenciaTrabajador");										
									Map params1 = new HashMap();
									params1.put("mov", tMov2);
									params1.put("fechaFinMov", fechaFinMov2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("usuario", usuario);
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);							
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", horaMarcacion2);
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);									
									boolean actualizo = asisDAO.updateRegistroAsistencia(params1);										
									if (actualizo){
										log.debug("SI actualizo3 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}else{										
										log.debug("NO actualizo3 PLANILLA en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}										
								}							
							}								
						}*/
						//No debe calificar nada
					}					
				}
			}
			//FIN ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)			
		 	    	
	    }//fin generar true						
	} 
	catch (Exception e){
		log.fatal("Error en el registro PLANILLA de asistencias del trabajador "+codPers+" : "+ e.getMessage(),e);
		//output.println("Error en el registro de asistencias del trabajador "+codPers+" : "+ e.getMessage());						
		throw new IncompleteConversationalState(e.toString());
	}
}	
	
	
/***************JRR******************/

	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public void registrarCompensaciones(Map datos) throws RemoteException {

		try {
			/*
			OBSERVACIONES
			2)Revisar que esa fecha ya tenga un registro en txx2 en txx1 cerrado
			3)Si es asi veo si el nuevo tiempo es mayor, de ser asi cojo la diferencia y se lo asigno a tiempo...
			y continuo normalmente.
			ESO SIGNIFICA QUE LOS CERRADOS EN TXX1 SE MANTENDRAN ASI...
			
			*/

			String dbpool = (String) datos.get("dbpool");
			int tiempo = ((Integer) datos.get("tiempo")).intValue();
			boolean procesa = false;
			int tiempo_aux = 0;

			T3793DAO detCompDAO = new T3793DAO(dbpool);
			T3792DAO compDAO = new T3792DAO(dbpool);
			
/*			List lista = detCompDAO.findTiempoCompensadoFechaCerrado(datos);
			log.debug("lista: " + lista);
			
			//Si existen licencias por bolsa cerradas que ya tienen tiempo utilizado perteneciente a la fecha en analisis
			if (lista!=null && lista.size()>0) {
				Map hm = (HashMap) lista.get(0);
				//Tiempo ya utilizado en compensaciones anteriores
				tiempo_aux = Integer.parseInt(hm.get("tiempo_cerrado").toString()); */
				
			    tiempo_aux = detCompDAO.findTiempoCompensadoFechaCerrado(datos);
				log.debug("tiempo_aux: " + tiempo_aux);
				
				if (tiempo_aux>0) {
					tiempo = tiempo - tiempo_aux;
					log.debug("Tiempo disponible - tiempo: " + tiempo);
					//Si existe tiempo para esa fecha que aun no ha sido utilizado en compensaciones
					if (tiempo>0) procesa = true;
				}
				else {
					procesa = true;
				}
				
				
/*			} else {
				procesa = true;
			}
			*/
			
			//JRR - 07/11/2008
			if (procesa) {
				
				// JRR - 31/10/2008
				// Buscamos si existen compensaciones en bolsa activas (0,1) para el trabajador, ordenadas
				// por fecha en forma ascendente (numero, flic, qsaldotiempo, tipo)
				// para que la compensacion mas antigua se compense primero.
				List compensaciones = compDAO.findCompensacionesPendByPers(datos);
				log.debug("Nro Compensaciones: " + compensaciones.size());

				if (compensaciones != null) {
					Map aux = new HashMap();
					int qtiempo = 0;
					int saldo = 0;
					int diferencia = 0;

					// Mientras haya tiempo para utilizar avanzo en las compensaciones pendientes
					for (int j = 0; j < compensaciones.size() && tiempo > 0; j++) {

						// Obtenemos la compensacion en txx1 (numero,flic) 
						aux = (HashMap) compensaciones.get(j);
						log.debug("Map aux compensacion: " + aux);
						
						// datos.put("id", aux.get("id"));
						datos.put("num_licencia", aux.get("num_licencia"));
						datos.put("fec_licencia", aux.get("fec_licencia"));

						
						//*********** JRR
						// Busco si para la fecha en analisis ya existe detalle de compensacion en txx2
						List detCompensaFecha = detCompDAO.findDetalleCompensaFecha(datos);
						log.debug("detCompensaFecha: " + detCompensaFecha);
						
						if (detCompensaFecha!= null && detCompensaFecha.size()>0) {
							//Aqui podria eliminar el registro, volver a insertar en txx2 y actualizar en txx1
							//Pero estaba pensando que podria traer inconsistencias
							//Mejor seria que una vez que este procesada una marcacion, ya quede asi... consultar
							Map hm = (HashMap) detCompensaFecha.get(0);
							
							log.debug("DENTRO DEL INF - HM: " + hm);
							//fmarcacion == fcompensa
							detCompDAO.eliminarDetalleCompensa(datos);
							//
							saldo = Integer.parseInt(aux.get("cnt_tsaldo").toString());
							log.debug("saldo: " + saldo);
							saldo = saldo + Integer.parseInt(hm.get("cnt_tiempo").toString());
							log.debug("NUEVO saldo: " + saldo);
							
							aux.put("cnt_tsaldo", Integer.toString(saldo));
							log.debug("NUEVO SALDO AUX: " + aux.get("cnt_tsaldo"));
							
						}
						
						//***********
						
						
						// COMPENSACION BOLSA

							// Obtenemos el saldo de la compensacion
							saldo = Integer.parseInt(aux.get("cnt_tsaldo").toString());
							log.debug("saldo: " + saldo);
							
							// Obtenemos la cantidad de tiempo a compensar
							diferencia = tiempo - saldo;

							log.debug("diferencia: " + diferencia);

							if (diferencia == 0) {
								//El tiempo a compensar es igual al saldo
								log.debug("diferencia == 0: ");
								qtiempo = tiempo;
								tiempo = 0;
								datos.put("ind_estado", "2");
								
							} else if (diferencia > 0) {
								//El tiempo a compensar es mayor que el saldo
								log.debug("diferencia > 0: ");
								//El nuevo saldo deber치 ser 0
								qtiempo = saldo;
								tiempo = diferencia;
								datos.put("ind_estado", "2");
								
							} else {
								//El tiempo a compensar es menor que el saldo
								log.debug("diferencia < 0: " + tiempo);
								qtiempo = tiempo;
								log.debug("tiempo: " + tiempo);
								tiempo = 0;
								datos.put("ind_estado", "1");
							}

							// Obtenemos nuevo saldo
							datos.put("cnt_tsaldo", new Integer((saldo - qtiempo)));

							// Estado del detalle.
							//datos.put("estado", new Integer(1));

							// Registramos la compensacion parcial
							datos.put("cnt_tiempo", new Integer(Math.abs(qtiempo)));


							log.debug("Map DetalleCompensa: " + datos);
							detCompDAO.registrarDetalleCompensacion(datos);

							log.debug("Mapa ActualizarSaldo: " + datos);
							compDAO.actualizarSaldoCompensacion(datos);
						
					}//FIN DEL FOR
				}
				
			}//FIN del if (procesa)
			
			
		} catch (Exception e) {
			log.error(e);
			// output.println("Error : " + e.toString());
		}
	}
	
	
	
/**************************************/	
	
	
	
	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public ArrayList dameMarcacionesDia(String dbpool, String codPers,
			String fecha, BeanTurnoTrabajo turno) throws RemoteException {

		if (log.isDebugEnabled()) log.debug("ingreso a dameMarcacionesDia");//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("fecha:"+fecha);//LOG GENERACION
		ArrayList lista = null;
		try {
			
			T1275DAO daoMarcacion = new T1275DAO();						
			String nuevaFecha = "";
			ArrayList lista2 = null;

			//traemos las marcaciones del dia
			lista = daoMarcacion.findByCodPersFecha(dbpool, codPers, fecha);
			if (log.isDebugEnabled()) log.debug("lista:"+lista);//LOG GENERACION
			
			if (turno!=null){
				//en caso sea operativo 
				if (turno.isOperativo()){
					
					String horaIniTurno = turno.getHoraIni();
			    	String horaFinTurno = turno.getHoraFin();

				    //estas marcaciones ya fueron calificadas junto con las marcaciones del dia anterior
				    if (horaFinTurno.compareTo(horaIniTurno)<=0){
						//EBV 01/06/2006 Le estoy poniendo turno.getDuracion() para hacerlo mas general y
						//abrirlo a mas dias.
						//nuevaFecha = Utiles.dameFechaSiguiente(fecha, 1);
				    	log.debug("Turno "+ turno.getDuracion());
				    	if (log.isDebugEnabled()) log.debug("duracion(operativo):"+turno.getDuracion());//LOG GENERACION
				    	for (int i = 1; i <= turno.getDuracion(); i++) {
				    		//nuevaFecha = Utiles.dameFechaSiguiente(fecha, 1);
				    		if (log.isDebugEnabled()) log.debug("i:"+i);//LOG GENERACION
				    		nuevaFecha = Utiles.dameFechaSiguiente(fecha, i);
				    		if (log.isDebugEnabled()) log.debug("nuevaFecha:"+nuevaFecha);//LOG GENERACION
				    		lista2 = daoMarcacion.findByCodPersFecha(dbpool, codPers, nuevaFecha);
				    		if (log.isDebugEnabled()) log.debug("lista2:"+lista);//LOG GENERACION
				    		if (lista2!=null && lista2.size()>0) {lista.addAll(lista2);
				    		log.debug("anadi "+nuevaFecha);
				    		}
				    		
				    	}
				    	if (log.isDebugEnabled()) log.debug("lista final:"+lista);//LOG GENERACION
					}				
				}				
			}			
		} catch (Exception e){
			log.error(e);
			//output.println("Error : " + e.toString());
		}
		return lista;
	}	
	
	//ASANCHEZZ 20100412
	
	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="Required"
	 * 
	 */
	public void eliminarMarcacionesImpares(Map params) throws FacadeException {
		/*
		public void eliminarMarcacionesImpares(String dbpool, String fechaIni,
				String fechaFin, String criterio, String valor) throws RemoteException {
		*/
		try {
			/*
			//prac-jcallo
			T1271DAO asisDAO = new T1271DAO(dbpool);
			Map params = new HashMap();
			params.put("fechaIni", fechaIni);
			params.put("fechaFin", fechaFin);
			params.put("criterio", criterio);
			params.put("valor", valor);
			log.debug("asisDAO.findByFIngFFinNull(params)... params:"+params);
			*/
			
			if(log.isDebugEnabled())log.debug("ProcesoFacade - eliminarMarcacionesImpares - params: " + params);
			
			T1271DAO asisDAO = new T1271DAO(params.get("dbpool"));
	//FIN		
			List listaAfectados = asisDAO.findByFIngFFinNull(params);//(dbpool, fechaIni, fechaFin, criterio, valor)REEMPLAZAR POR LA NUEVA VERSION;
			log.debug("listaafectados.size :"+listaAfectados.size());
			//prac-jcallo
			Map bAsis = null;
			if (listaAfectados != null && listaAfectados.size() > 0) {
				for (int i = 0; i < listaAfectados.size(); i++) {
					
				    bAsis = (Map) listaAfectados.get(i);
					asisDAO.deleteByCodPersFecha(bAsis);//(dbpool, bAsis.getCodPers(), bAsis.getFIng());

				}
			}

		} catch (Exception e){
			log.error(e);
			//output.println("Error : " + e.toString());
		}
	}

	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public String preCalificarEntrada(String fechaMarca, String horaMarca,
			String horaIni, int tolera, String horaLim, String medida)
			throws RemoteException {

		String calif = Constantes.ENTRADA_NORMAL;
	
		
		if (log.isDebugEnabled()) log.debug("ingreso preCalificarEntrada");//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("fechaMarca-CAS:"+fechaMarca);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaMarca-CAS:"+horaMarca);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("tolera-CAS:"+tolera);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaLim-CAS:"+horaLim);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("medida-CAS:"+medida);//LOG GENERACION		
		if (log.isDebugEnabled()) log.debug("calif0-CAS:"+calif);//LOG GENERACION
		try {
			
			if (horaLim != null && !horaLim.equals("")) {

				float dif = Utiles.obtenerHorasDiferencia(horaMarca, horaLim);
				//EBV 02/06/2006 ... si la hora Limite es la misma de la marcacion.
				//if (dif <= 0) {
				log.debug("dif " + dif);
				log.debug("horaMarca " + horaMarca);//LOG GENERACION
				log.debug("horaLim " + horaLim);//LOG GENERACION
				if (dif < 0) {
					calif = Constantes.MOV_INASISTENCIA;
					if (log.isDebugEnabled()) log.debug("calif1-CAS:"+calif);//LOG GENERACION
				} 
				else {

					//cantidad de minutos de tardanza
					float cantidad = Utiles.calculaAcumulado(medida, Utiles
							.stringToTimestamp(fechaMarca + " " + horaIni),
							Utiles.stringToTimestamp(fechaMarca + " "
									+ horaMarca));
					
					log.debug("cantidad " + cantidad);//LOG GENERACION
					log.debug("horaIni " + horaIni);//LOG GENERACION
					log.debug("horaMarca " + horaMarca);//LOG GENERACION
					if (cantidad == 0) {
						calif = Constantes.ENTRADA_NORMAL;
						if (log.isDebugEnabled()) log.debug("calif2-CAS:"+calif);//LOG GENERACION
					} else if (cantidad < 0) {
						calif = Constantes.MOV_ENTRADA_ANTICIPADA;
						if (log.isDebugEnabled()) log.debug("calif3-CAS:"+calif);//LOG GENERACION
					} else {
						if (cantidad > tolera) {
							calif = Constantes.MOV_TARDANZA_CON_DESCUENTO;
							if (log.isDebugEnabled()) log.debug("calif4-CAS:"+calif);//LOG GENERACION
						} else {
							calif = Constantes.MOV_TARDANZA_SIN_DESCUENTO;
							if (log.isDebugEnabled()) log.debug("calif5-CAS:"+calif);//LOG GENERACION
						}
					}
				}
			}
			
		} catch (Exception e){
			log.error(e);
			//output.println("Error : " + e.toString());
		}

		return calif;
	}

	/**
	 *
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 *  
	 */
	public String preCalificarSalida(String dbpool, String codPers, String fechaMarca, 
			String horaMarca, String horaFin, String medida)
			throws RemoteException {

		String calif = Constantes.SALIDA_NORMAL;
		if (log.isDebugEnabled()) log.debug("ingreso preCalificarSalida");//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("fechaMarca-CAS:"+fechaMarca);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaMarca-CAS:"+horaMarca);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("medida-CAS:"+medida);//LOG GENERACION		
		if (log.isDebugEnabled()) log.debug("calif0-CAS:"+calif);//LOG GENERACION
		try {
			
			T1270DAO dao = new T1270DAO();			
			int horasCompensa = dao.findHorasCompensa(dbpool,codPers,fechaMarca);
			if (log.isDebugEnabled()) log.debug("horasCompensa-CAS:"+horasCompensa);//LOG GENERACION
			if (horaMarca != null) {
				
				float cantidad = Utiles.calculaAcumulado(medida, Utiles
						.stringToTimestamp(fechaMarca + " " + horaFin), Utiles
						.stringToTimestamp(fechaMarca + " " + horaMarca));

				log.debug("cantidad " + cantidad);//LOG GENERACION
				log.debug("horaFin " + horaFin);//LOG GENERACION
				log.debug("horaMarca " + horaMarca);//LOG GENERACION
				//en caso se posea horas por compensar se adicionan
				cantidad-=horasCompensa;

				//salida anticipada
				if (cantidad < 0) {
					calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
					if (log.isDebugEnabled()) log.debug("calif1-CAS:"+calif);//LOG GENERACION
				}
			}

		} catch (Exception e){
			log.error(e);
			//output.println("Error : " + e.toString());
		}

		return calif;
	}

	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public String preCalificarMovimiento(String fechaMarca, String horaIni, String horaFin,
			BeanTurnoTrabajo turno, String medida, boolean tieneRefrigerio, boolean bOperativo) throws RemoteException {

		if (log.isDebugEnabled()) log.debug("ingreso preCalificarMovimiento");//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("fechaMarca-CAS:"+fechaMarca);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("medida-CAS:"+medida);//LOG GENERACION		
		if (log.isDebugEnabled()) log.debug("turno.getHoraIni()-CAS:"+turno.getHoraIni());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getHoraFin()-CAS:"+turno.getHoraFin());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("tieneRefrigerio-CAS:"+tieneRefrigerio);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("bOperativo-CAS:"+bOperativo);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getHoraIniRefrigerio()-CAS:"+turno.getHoraIniRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getMinutosRefrigerio()-CAS:"+turno.getMinutosRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getHoraFinRefrigerio()-CAS:"+turno.getHoraFinRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getDuracion()-CAS:"+turno.getDuracion());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getHoraLimite()-CAS:"+turno.getHoraLimite());//LOG GENERACION 	----procesar metodo
		if (log.isDebugEnabled()) log.debug("turno.getTolera()-CAS:"+turno.getTolera());//LOG GENERACION 			----procesar metodo
		String calif = Constantes.MOVIMIENTO_NORMAL;
		if (log.isDebugEnabled()) log.debug("calif0-CAS:"+calif);//LOG GENERACION
		try {

			float cantidad = 0;
			
			if (bOperativo){
				if (log.isDebugEnabled()) log.debug("es operativo-CAS");//LOG GENERACION
				calif = Constantes.MOV_TRABAJO_CAMPO;
				if (log.isDebugEnabled()) log.debug("calif1-CAS:"+calif);//LOG GENERACION
			}
			else if ( (turno.getTurno().equals("099")) ||
					(turno.getTurno().equals("098")) ||
					(turno.getTurno().equals("097")) ){
				calif = Constantes.MOV_LABOR_FUERA_OFICINA;
				if (log.isDebugEnabled()) log.debug("turnos 097,098 o 099-CAS");//LOG GENERACION
				if (log.isDebugEnabled()) log.debug("calif2-CAS:"+calif);//LOG GENERACION
			}
			else if (tieneRefrigerio) {
				if (log.isDebugEnabled()) log.debug("tiene refrigerio");//LOG GENERACION
				//EBV 13/03/2006  a ver
				cantidad = Utiles.calculaAcumulado(medida, 
						Utiles.stringToTimestamp(fechaMarca + " " + turno.getHoraFin()),
						Utiles.stringToTimestamp(fechaMarca + " " + horaIni));
				if (log.isDebugEnabled()) log.debug("cantidad-CAS:"+cantidad);//LOG GENERACION
				if (log.isDebugEnabled()) log.debug("turno.getHoraFin()-CAS:"+turno.getHoraFin());//LOG GENERACION
				if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION	
				if (cantidad > 0) {
					calif = Constantes.MOV_APORTACION;
					if (log.isDebugEnabled()) log.debug("calif3-CAS:"+calif);//LOG GENERACION
				} else {
					cantidad = Utiles.calculaAcumulado(medida, 
							Utiles.stringToTimestamp(fechaMarca + " " + horaIni), 
							Utiles.stringToTimestamp(fechaMarca + " " + turno.getHoraIniRefrigerio()));
					if (log.isDebugEnabled()) log.debug("cantidad2-CAS:"+cantidad);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("turno.getHoraIniRefrigerio()-CAS:"+turno.getHoraIniRefrigerio());//LOG GENERACION					
					log_papeleta.debug("Cantidad " + cantidad);
					log_papeleta.debug("Turno.getHoraIniRefrigerio " + turno.getHoraIniRefrigerio());
					log_papeleta.debug("horaIni " + horaIni);
					if (cantidad < 0) {
						float durante1 = Utiles.calculaAcumulado(medida, 
								Utiles.stringToTimestamp(fechaMarca + " " + horaIni),
								Utiles.stringToTimestamp(fechaMarca + " "+ horaFin)
								);
						if (log.isDebugEnabled()) log.debug("durante1-CAS:"+durante1);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION	
						float tarde1 = Utiles.calculaAcumulado(medida,
								Utiles.stringToTimestamp(fechaMarca + " "+ turno.getHoraFinRefrigerio()), 
								Utiles.stringToTimestamp(fechaMarca + " "+ horaIni));
						if (log.isDebugEnabled()) log.debug("tarde1-CAS:"+tarde1);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("turno.getHoraFinRefrigerio()-CAS:"+turno.getHoraFinRefrigerio());//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
						log_papeleta.debug("durante " + durante1);
						log_papeleta.debug("despues " + tarde1);
						if (tarde1 >= 0) {
							calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
							if (log.isDebugEnabled()) log.debug("calif10-CAS:"+calif);//LOG GENERACION
						} else {
							if (durante1 > turno.getMinutosRefrigerio()) {
								calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
								if (log.isDebugEnabled()) log.debug("calif11-CAS:"+calif);//LOG GENERACION
							} else {
								calif = Constantes.MOV_REFRIGERIO;
								if (log.isDebugEnabled()) log.debug("calif12-CAS:"+calif);//LOG GENERACION
							}
						}
						
					} 
					if (log.isDebugEnabled()) log.debug("calif4-CAS:"+calif);//LOG GENERACION	
				}
			}
			else {
				if (log.isDebugEnabled()) log.debug("NO tiene refrigerio");//LOG GENERACION
				cantidad = Utiles.calculaAcumulado(medida, 
						Utiles.stringToTimestamp(fechaMarca + " " + turno.getHoraIni()),
						Utiles.stringToTimestamp(fechaMarca + " " + horaFin));
				if (log.isDebugEnabled()) log.debug("cantidad3-CAS:"+cantidad);//LOG GENERACION
				if (log.isDebugEnabled()) log.debug("turno.getHoraIni()-CAS:"+turno.getHoraIni());//LOG GENERACION
				if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION
				
				if (cantidad < 0) {
					calif = Constantes.MOV_APORTACION;
					if (log.isDebugEnabled()) log.debug("calif5-CAS:"+calif);//LOG GENERACION
				}
				else{
					
					cantidad = Utiles.calculaAcumulado(medida, 
							Utiles.stringToTimestamp(fechaMarca + " " + horaIni), 
							Utiles.stringToTimestamp(fechaMarca + " " + turno.getHoraIniRefrigerio()));
					if (log.isDebugEnabled()) log.debug("cantidad4-CAS:"+cantidad);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("turno.getHoraIniRefrigerio()-CAS:"+turno.getHoraIniRefrigerio());//LOG GENERACION	
					if (cantidad > 0) {
						calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
						if (log.isDebugEnabled()) log.debug("calif5.1-CAS:"+calif);//LOG GENERACION
					} 
					else {
				
						float durante = Utiles.calculaAcumulado(medida, 
								Utiles.stringToTimestamp(fechaMarca + " " + horaIni),
								Utiles.stringToTimestamp(fechaMarca + " "+ horaFin)
								);
						if (log.isDebugEnabled()) log.debug("durante2-CAS:"+durante);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION	

						float despues = Utiles.calculaAcumulado(medida,
								Utiles.stringToTimestamp(fechaMarca + " "+ turno.getHoraFinRefrigerio()), 
								Utiles.stringToTimestamp(fechaMarca + " "+ horaIni));
						if (log.isDebugEnabled()) log.debug("despues-CAS:"+despues);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("turno.getHoraFinRefrigerio()-CAS:"+turno.getHoraFinRefrigerio());//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION

						if (despues >= 0) {
							cantidad = Utiles.calculaAcumulado(medida, 
									Utiles.stringToTimestamp(fechaMarca + " " + turno.getHoraFin()),
									Utiles.stringToTimestamp(fechaMarca + " " + horaIni));
							if (log.isDebugEnabled()) log.debug("cantidad5-CAS:"+despues);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("turno.getHoraFin()-CAS:"+turno.getHoraFin());//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
							log_papeleta.debug("Cantidad " + cantidad);
							log_papeleta.debug("Turno.getHoraFin " + turno.getHoraFin());
							log_papeleta.debug("horaIni " + horaIni);
							if (cantidad > 0) {
								calif = Constantes.MOV_APORTACION;
								if (log.isDebugEnabled()) log.debug("calif6-CAS:"+calif);//LOG GENERACION
							} else {
							calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
							if (log.isDebugEnabled()) log.debug("calif7-CAS:"+calif);//LOG GENERACION
							}
						} else {
							if (durante > turno.getMinutosRefrigerio()) {
								calif = Constantes.MOV_EXCESO_REFRIGERIO;
								if (log.isDebugEnabled()) log.debug("calif8-CAS:"+calif);//LOG GENERACION
							} else {
								calif = Constantes.MOV_REFRIGERIO;
								if (log.isDebugEnabled()) log.debug("calif9-CAS:"+calif);//LOG GENERACION
							}
						}
					}
				}
			}
			
		} catch (Exception e){
			log.error(e);
			//output.println("Error : " + e.toString());
		}

		return calif;
	}

	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	/* EBV 20/11/2008
	public String cerrarAsistencia(HashMap mapa, String usuario)
			throws RemoteException {

		String res = Constantes.OK;
		String id = (String) mapa.get("messageID");
		String dbpool = (String) mapa.get("dbpool");
		try {

			super.creaLog(id, "CIERRE DE ASISTENCIA", usuario);

			String periodo = (String) mapa.get("periodo");
			String criterio = (String) mapa.get("criterio");
			String valor = (String) mapa.get("valor");
			HashMap seguridad = (HashMap) mapa.get("seguridad");

			T02DAO personalDAO = new T02DAO();
			T1272DAO resumenDAO = new T1272DAO();

			//procesar un trabajador
			if (criterio.equals("0")) {
				HashMap t = personalDAO.joinWithT12T99ByCodPers(dbpool, valor,
						null);
				resumenDAO.updateByCodPersUOPeriodo(dbpool, (String) t
						.get("t02cod_pers"), "", periodo, 0, seguridad);
			}

			//procesar los trabajadores de una unidad
			if (criterio.equals("1")) {
				resumenDAO.updateByCodPersUOPeriodo(dbpool, "", valor,
						periodo, 1, seguridad);
			}

			//procesar todos los trabajadores
			if (criterio.equals("2")) {
				resumenDAO.updateByCodPersUOPeriodo(dbpool, "", "",
						periodo, 2, seguridad);
			}

		} catch (Exception e){
			log.error(e);
			//output.println("Error : " + e.toString());
		} finally {
			try {
				//registramos el log del proceso
				super.registraLog(dbpool, mapa, usuario);
			} catch (Exception e) {
			}
		}
		return res;
	}
*/
	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 *
	 */
	public boolean generarDataReloj(HashMap mapa, String usuario)
			throws RemoteException {

		boolean res = true;
		String id = (String) mapa.get("messageID");
		String dbpool = (String) mapa.get("dbpool");
		try {

			super.creaLog(id, "PROCESO DE GENERACION DE DATA DE RELOJ",usuario);

			String fecha = (String) mapa.get("fecha");
			HashMap seguridad = (HashMap) mapa.get("seguridad");

			String f = Utiles.toFechaSeguida(fecha)
					+ Utiles.toHoraActualSeguida();

			if (!f.equals("")) {

				/*output.println("\"L100\"");
				output.println("\"MSG00200*** CONFIGURANDO ***\"");
				output.println("\"TBCE00\"");
				output.println("\"TBME00\"");
				output.println("\"ENBDIS001\"");
				output.println("\"TIPVAL000\"");
				output.println("\"ENBVAL000\"");
				output.println("\"ENBMSG001\"");
				output.println("\"ENBGER000\"");
				output.println("\"TIMMSG001\"");
				output.println("\"TIMDUP0060\"");
				output.println("\"S13000\"");
				output.println("\"S14000\"");
				output.println("\"FW0000\"");
				output.println("\"ENBMAS001\"");
				output.println("\"NUMBERR0005\"");
				output.println("\"MSG00201*RELOJ  CONFIGURADO*\"");
				output.println("\"TBMW0000yyyy1     00031234567890123456789012345678901234567890\"");
				output.println("\"MSG00201*RELOJ  CONFIGURADO*\"");
				output.println("\"CHGMSG0007NO AUTORIZADO\"");
				output.println("\"TWYYYYMMDDHHMMSS\"");
*/
				T1282DAO vacDAO = new T1282DAO(dbpool);
				Map params = new HashMap();
				params.put("fecha", fecha);
				params.put("seguridad", seguridad);
				List lista = vacDAO.joinWithT02ByFecha(params);//joinWithT02ByFecha(dbpool, fecha,seguridad);

				if (lista != null) {
					for (int i = 0; i < lista.size(); i++) {
						String codPers = (String) lista.get(i);
						//output.println("\"TBCW00" + codPers + "\"");

					}
				}
				
				T1275DAO mDAO = new T1275DAO();
				ArrayList pases = mDAO.findPases(dbpool, fecha);

				if (pases != null) {
					for (int i = 0; i < pases.size(); i++) {
						HashMap pase = (HashMap) pases.get(i);
						//output.println("\"TBCW00" + (String)pase.get("cod_pase") + "\"");
					}
				}
				
				ArrayList pradsas = mDAO.findPracticantes(dbpool);
				if (pradsas != null) {
					for (int i = 0; i < pradsas.size(); i++) {
						HashMap pradsa = (HashMap) pradsas.get(i);
						//output.println("\"TBCW00" + (String)pradsa.get("cod_practica") + "\"");

					}
				}

				//output.println("\"ENBVAL001\"");

			} else {
				throw new Exception("La fecha ingresada no es valida");
			}
		} catch (Exception e){
			log.error(e);
			//output.println("Error : " + e.toString());
		}finally {
			try {
				//registramos el log del proceso
				super.registraLog(dbpool, mapa, usuario);
			} catch (Exception e) {
			}
		}
		return res;

	}

	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="Required"
	 * 
	 */
	public String registrarAutorizacionTrabajador(String dbpool,
			String codPers, String codUO, String fecha, String horaIni,
			String horaFin, String obs, String codJefe, String usuario)
			throws RemoteException {

		String res = Constantes.OK;
		boolean registrar = false;
		try {

			//output.println("Trabajador : " + codPers);

			T01DAO paramDAO = new T01DAO();
			T02DAO personalDAO = new T02DAO();
			CorreoDAO correoDAO = new CorreoDAO();

			T130CMPHome cmpHome = (T130CMPHome) ServiceLocator.getInstance().getLocalHome(T130CMPHome.JNDI_NAME);

			TurnoTrabajoFacadeHome facadeHome = (TurnoTrabajoFacadeHome) ServiceLocator
					.getInstance().getRemoteHome(
							TurnoTrabajoFacadeHome.JNDI_NAME,
							TurnoTrabajoFacadeHome.class);
			TurnoTrabajoFacadeRemote facadeRemote = facadeHome.create();
			BeanTurnoTrabajo turno = facadeRemote.buscarTrabTurno(dbpool,
					codPers, fecha);

			if (turno != null) {

				T130DAO horaDAO = new T130DAO();

				boolean tieneAutorizacion = horaDAO.findByCodPersFAutor(dbpool,
						codPers, fecha);

				if (!tieneAutorizacion) {
					
					if (turno.isOperativo()){
						if (Utiles.obtenerHorasDiferencia(turno.getHoraFin(),horaIni) >= 0) {
							registrar = true;
						} else {
							res = "La hora de inicio de la autorizacion debe ser mayor a la hora fin del turno asignado al trabajador.";
							//output.println(res);
						}
					}
					else{										
						
						boolean diaEspecial = Utiles.isDiaSemana(fecha, Constantes.SABADO)
								|| Utiles.isDiaSemana(fecha, Constantes.DOMINGO)
								|| paramDAO.findByFechaFeriado(dbpool, fecha);						
						
						if (!diaEspecial){							
							if (Utiles.obtenerHorasDiferencia(turno.getHoraFin(),horaIni) >= 0) {
								registrar = true;
							} else {
								res = "La hora de inicio de la autorizacion debe ser mayor a la hora fin del turno asignado al trabajador.";
								//output.println(res);
							}
						}
						else{
							registrar = true;
						}												
					}																			
				} else {
					res = "El trabajador ya posee una autorizacion para el dia "+ fecha + ".";
					//output.println(res);
				}
			} else {
				registrar = true;
			}

			if (registrar){
				
				/*String salida = null;		
				//si la autorizacion es para una fecha pasada se registra 
				//la misma hora de fin de autorizacion.
				if (Utiles.obtenerDiasDiferencia(Utiles.obtenerFechaActual(), fecha) < 0){
					salida = horaFin;
				}*/
				
				cmpHome.create(codPers, fecha, horaIni, codUO, horaFin, horaFin/*salida*/,
						obs, codJefe, Constantes.INACTIVO,
						new java.sql.Timestamp(System
								.currentTimeMillis()), usuario);
				
				String mensaje = "Usted tiene una <strong> autorizacion por labor excepcional </strong> para el dia "+ fecha + "."; 
				String nombre = personalDAO.findNombreCompletoByCodPers(dbpool, codPers);
				String texto = Utiles.textoCorreoProceso(dbpool, nombre, mensaje,"");
				
				//enviamos el mail al trabajador
				HashMap datos = new HashMap();
				datos.put("subject",
						"Autorizacion de Labor Excepcional");
				datos.put("message",texto);
				datos.put("from", correoDAO.findCorreoByCodPers(
						dbpool, codJefe));
				datos.put("to", correoDAO.findCorreoByCodPers(dbpool,codPers));
				
				this.sendMail(datos);			
			}			
		
		} catch (Exception e){
			log.error(e);
			//output.println("Error : " + e.toString());
		}

		return res;
	}

	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public void registrarAutorizacionHE(HashMap mapa, String usuario)
			throws RemoteException {

		String id = (String) mapa.get("messageID");
		String dbpool = (String) mapa.get("dbpool");
		try {

			super.creaLog(id,
					"REGISTRO DE AUTORIZACION DE LABOR EXCEPCIONAL", usuario);

			String fecha = (String) mapa.get("fecha");
			String horaIni = (String) mapa.get("horaIni");
			String horaFin = (String) mapa.get("horaFin");
			String obs = (String) mapa.get("obs");
			String codJefe = (String) mapa.get("codJefe");

			String listaTrab = (String) mapa.get("trabajadores");
			StringTokenizer st = new StringTokenizer(listaTrab, "&");

			while (st.hasMoreTokens()) {

				String token = st.nextToken();

				StringTokenizer st2 = new StringTokenizer(token, "_");
				String codPers = st2.nextToken();
				String uo = st2.nextToken();

				if (!codPers.trim().equalsIgnoreCase(codJefe.trim())) {
					registrarAutorizacionTrabajador(dbpool,
							codPers, uo, fecha, horaIni, horaFin, obs, codJefe,
							usuario);
				} else {
					output.print("Trabajador : " + codPers + ". No puede autorizarse a si mismo.");
				}
			}

		} catch (Exception e){
			log.error(e);
			//output.println("Error : " + e.toString());
		} finally {
			try {
				//registramos el log del proceso
				super.registraLog(dbpool, mapa, usuario);
			} catch (Exception e) {
			}
		}
	}
	
	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public HashMap calcularHorasPermanencia(String dbpool, String codpers, BeanHoraExtra he)
			throws RemoteException {

		float cantidad = 0;
		String hora = "";
		String hora0 = "";
		HashMap LHE = new HashMap();
		//PRAC-ASANCHEZ 31/08/2009
		List lista = new ArrayList();//lista que guarada los intervalos de tiempo de LE.
		//
		try {

			T1275DAO daoMarcacion = new T1275DAO();
			T1270DAO turnoDAO = new T1270DAO();
			
			String fecha = he.getFechaAutorizacion() != null ? he.getFechaAutorizacion().trim() : "";
			String horaIni = he.getHoraIni() != null ? he.getHoraIni().trim() : "";
			String horaFin = he.getHoraSalida() != null ? he.getHoraSalida().trim() : "";
			
			//JRR
			if (log.isDebugEnabled()) log.debug("calcularHorasPermanencia - he.getHoraIni()("+codpers+"): " + he.getHoraIni());
			if (log.isDebugEnabled()) log.debug("calcularHorasPermanencia - he.getHoraSalida()("+codpers+"): "+ he.getHoraSalida());
			
			//Obtenemos el turno del trabajador para la fecha						
			BeanTurnoTrabajo turno = turnoDAO.joinWithT45ByCodFecha(dbpool, codpers, fecha);
			if (log.isDebugEnabled()) log.debug("turno("+codpers+"): " + turno);
			//si el turno no se controla se considera la totalidad de la autorizacion
			if (turno!=null && !turno.isControla()){
				//EBV 06/09/2006 Se controla que tenga turno controlado
				//cantidad = Utiles.obtenerHorasDiferencia(horaIni, horaFin);
			}
			else{
				if (log.isDebugEnabled()) log.debug("entramos al else("+codpers+"): ");
				//obtenemos las marcaciones del d츾춼a
				ArrayList marcaciones = daoMarcacion.findByCodPersFecha(dbpool, codpers, fecha);
				//JRR
				if (log.isDebugEnabled()) log.debug("calcularHorasPermanencia - marcaciones("+codpers+"): " + marcaciones);
				
				BeanMarcacion marca = null;
				BeanMarcacion marca1 = null;
				if (marcaciones!=null && marcaciones.size()>0){
					if (marcaciones.size()%2==0){
						marca1 = (BeanMarcacion) marcaciones.get(0);
						hora0 = marca1.getHora();
						for (int i=0; i<marcaciones.size();i++){
							
							marca = (BeanMarcacion) marcaciones.get(i);
							hora = marca.getHora();					
							if (hora.trim().equals(Constantes.SALIDA) || hora.compareTo(horaFin)>0) {
								hora = horaFin;
							}
							
							if (hora.compareTo(horaIni)>=0){
								
								//Marcaciones pares son entradas
								//Marcaciones impares son salidas 
								if (i%2==1){//si marcacion es impar
									log.debug("Hora i%2 ==1("+codpers+"): "+ hora );
									//cantidad += Utiles.obtenerHorasDiferencia(horaIni, hora);
									cantidad += Utiles.obtenerMinutosDiferencia(horaIni, hora);
									//PRAC-ASANCHEZ 31/08/2009 - GUARDANDO ESE INTERVALO DE TIEMPO, 
									//GUARDANDO horaIni, hora y hora - horaIni
									Map mapa = new HashMap();
									mapa.put("horaIni", horaIni);
									mapa.put("hora", hora);
									float dif = Utiles.obtenerMinutosDiferencia(horaIni, hora);
									int can = Math.round(dif);
									mapa.put("diferencia", String.valueOf(can));
									if (log.isDebugEnabled()) log.debug("calcularHorasPermanencia - mapa("+codpers+"): " + mapa);
									if(!horaIni.equals(hora)){
										lista.add(mapa);
									}
									//
								}
								else{
									log.debug("Hora i%2!=1("+codpers+"): "+ hora );
									horaIni = hora;
								}
							}							
						}
					}	

				}	
				//si no posee turno de trabajo
				else{
					//EBV 06/09/2006 Se controla que tenga turno controlado
					//cantidad = Utiles.obtenerHorasDiferencia(horaIni, horaFin);
				}
			}				
			
		} catch (Exception e){
			log.error("Exception en calcularHorasPermanencia: " + e.getMessage(), e);
			//output.println("Error : " + e.toString());
		}
		int canti = Math.round(cantidad);
		LHE.put("cantidad",String.valueOf(canti));
		LHE.put("hora", hora);
		LHE.put("hora0", hora0);
		//PRAC-ASANCHEZ 31/08/2009 - CARGANDO LAS MARACACIONES QUE SIRVEN Y SUS TIEMPOS
		LHE.put("intervalos", lista);
		//
		return LHE;
	}
		
	
	/**
	 * Acumula la labor excepcional de los trabajadores
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="RequiresNew"
	 *
	 * @param mapa Map 
	 * @return 
	 * @throws FacadeException
	 */
	public String acumularHETrabajador(Map mapa) throws RemoteException {
		
		//JRR - 31/03/2009
		if (log.isDebugEnabled()) log.debug("acumularHETrabajador - mapa: " + mapa);
		String dbpool = mapa.get("dbpool").toString().trim();
		String codPers = mapa.get("cod_Trab").toString().trim();
		String usuario = mapa.get("usuario").toString().trim();
		
		ServiceLocator sl = ServiceLocator.getInstance();
		DataSource dgSp = sl.getDataSource("java:comp/env/jdbc/dgsp");

		String res = Constantes.OK;
		try {
			
			//T130CMPHome cmpHome = (T130CMPHome) ServiceLocator.getInstance().getLocalHome(T130CMPHome.JNDI_NAME);
			T01DAO paramDAO = new T01DAO();
			T130DAO dao = new T130DAO();
			T1270DAO turnoDAO = new T1270DAO();
			T02DAO t02DAO = new T02DAO();
			T99DAO codigoDAO = new T99DAO();
			T130DAO dsDAO = new T130DAO(dgSp);
			
			//JRR - 31/03/2009
			String fechainiComp = mapa.get("fechaIni").toString().trim();
			String fechafinComp = mapa.get("fechaFin").toString().trim();
			
			List horas = dao.findByCodPersEstadoMes(dbpool, codPers,
					Constantes.ACTIVO,fechainiComp,fechafinComp);
			
			if (log.isDebugEnabled()) log.debug("horas: " + horas);
			
			//ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100
			String fechaEval = "";
			int numDias = Utiles.obtenerDiasDiferencia(fechainiComp, fechafinComp);//30/03/2012 - 05/04/2012 (6 dias)
			if (log.isDebugEnabled()) log.debug("numDias("+codPers+"): " + numDias);
			for (int i = 0; i <= numDias; i++) {
				fechaEval = Utiles.dameFechaSiguiente(fechainiComp, i);
				if (log.isDebugEnabled()) log.debug("fechaEval("+codPers+"): " + fechaEval);				
				boolean tiene2 = dao.findByCodPersFAutor(dbpool, codPers, fechaEval);
				if (log.isDebugEnabled()) log.debug("tiene2("+fechaEval+"): " + tiene2);
				BeanTurnoTrabajo turnoNoControlado = turnoDAO.joinWithT45ByCodPersFecha_NoControlado_OperAdm1dia(dbpool,codPers,fechaEval);
				String codTurno="";
				if (turnoNoControlado!=null){
					codTurno = turnoNoControlado.getTurno().toString().trim();
					if (codTurno.equals("R67")){							
						if (tiene2){
							dsDAO.deleteLE(codPers, fechaEval);																	
							if (log.isDebugEnabled()) log.debug("se elimino("+codPers+") de bolsa la labor de la fecha: "+fechaEval+" por tener actualmente para dicha fecha turno NO CONTROLADO :"+codTurno);									
						}								
					}
				}		
			}
			//FIN ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100

			
/*			String fechainiComp = codigoDAO.findParamByCodTabCodigo(dbpool,
					Constantes.CODTAB_PARAMETROS_ASISTENCIA,
					Constantes.FECHA_INICIO_COMPENSACION);
			
			ArrayList horas = dao.findByCodPersEstadoMes(dbpool, codPers,
					Constantes.ACTIVO,fechainiComp); */

			HashMap empleado = t02DAO.joinWithT12T99ByCodPers(dbpool, codPers,null);
			String codUO = (String) empleado.get("t02cod_uorg");
			float total = 0;
			BeanHoraExtra he = null;
			HashMap lhe = new HashMap();
			
			String labex = codigoDAO.findParamByCodTabCodigo(dbpool,
					Constantes.CODTAB_PARAMETROS_ASISTENCIA,
					Constantes.MINUTOS_LABOR_EXCEPCIONAL);
			int minLabExc = labex != null ? Integer.parseInt(labex) : 0;
			
			
			/**********************************/
			//JRR - 25/06/2009
			//fecha de ingreso/reingreso
			VacacionFacadeHome facadeVacHome = (VacacionFacadeHome) sl.getRemoteHome(
					VacacionFacadeHome.JNDI_NAME,
					VacacionFacadeHome.class);
			VacacionFacadeRemote facadeVacRemote = facadeVacHome.create();
			String fecha_ingreso = "";
			Map hmVacGen = new HashMap();
			int dias = 0;
			
			hmVacGen = facadeVacRemote.buscarVacacionesGen(dbpool, codPers);
			
		    if (hmVacGen!=null && hmVacGen.get("fecha")!=null && !hmVacGen.get("fecha").toString().equals("")){
				fecha_ingreso = hmVacGen.get("fecha").toString();
			} else {
				fecha_ingreso = empleado.get("t02f_ingsun").toString();
			}
		    
//			T3464DAO t3464dao = new T3464DAO(sl.getDataSource("java:comp/env/jdbc/dcsp"));
			
			pe.gob.sunat.rrhh.dao.T99DAO t99dao = new pe.gob.sunat.rrhh.dao.T99DAO(sl.getDataSource("java:comp/env/jdbc/dcsp"));
			Map params = new HashMap();
			params.put("t99cod_tab", constantes.leePropiedad("CODTAB_TURNOS_AUTORIZADOS_LE"));
			List turnosAutorizados = t99dao.buscarParametro(params);
			

		    /**********************************/
		    		
			T3792DAO compDAO = new T3792DAO(dbpool);
			List compensaciones = new ArrayList();
			Map datos = new HashMap();
			Map compensacion= new HashMap();
			String fechaCompensacion ="";
			int dif = 0;
			
			T3793DAO detCompDAO = new T3793DAO(dbpool);

	    
			if (horas != null) {
				for (int i = 0; i < horas.size(); i++) {

					he = (BeanHoraExtra) horas.get(i);
					
					if (log.isDebugEnabled()) log.debug("ANALISIS DE LE PARA LA FECHA: " + he.getFechaAutorizacion());
					String fecha = he.getFechaAutorizacion() != null ? he.getFechaAutorizacion().trim() : "";
					
					//PARA BORRAR ANTES DE VALIDAR LA BOLSA 
					boolean tiene = dao.findByCodPersFAutor(dbpool, codPers, fecha);

					//JRR
					boolean tieneIguales = false;
					if (tiene) {
						tieneIguales = dao.findByCodPersFAutorAcumIgualActual(dbpool, codPers, fecha);
						if (tieneIguales) {
//							ServiceLocator sl = ServiceLocator.getInstance();
//							DataSource dgSp = sl.getDataSource("java:comp/env/jdbc/dgsp");
//							T130DAO dsDAO = new T130DAO(dgSp);

							dsDAO.deleteLE(codPers, fecha);
							tiene = false;
						}
					}
					//
					
					boolean generarLE = true;
					
					
					/*********************************/
					//JRR - 25/06/2009
					if (log.isDebugEnabled()) log.debug("fecha_ingreso: "+fecha_ingreso);
					
				    //Validar que solo genere LE si fecha >= fecha_ingreso  dd/mm/yyyy
				    dias = Utiles.obtenerDiasDiferencia(fecha_ingreso, fecha);
				    
				    if (dias<0) {
				    	if (log.isDebugEnabled()) log.debug("Fecha menor al ingreso/reingreso por dias: " + dias);
				    	generarLE = false;					
				    }
					//
					//Verificacion de dia autorizado para generar LE
/*					boolean existeAut = t3464dao.existeAutorizado(codPers, fecha, null);
					if (!existeAut) {
						if (log.isDebugEnabled()) log.debug("No existe autorizaci칩n para el d칤a: " + fecha);
						generarLE = false;
					}*/
					//
					//EN REALIDAD SE PROCESAN LOS REGISTROS CON HORAS DE SALIDA
					//Se debe validar que existan marcaciones pares? si es asi:
/*					T1275DAO t1275dao = new T1275DAO();
					List lista = t1275dao.findByCodPersFecha(dbpool, codPers, fecha);
					if (lista!=null && lista.size()>0 && (lista.size()%2!=0)){
						generarLE = false;
						if (log.isDebugEnabled()) log.debug("El trabajador no posee un numero par ("+lista.size()+") de marcaciones para el "+fecha+".");
					} */
					//
					/*********************************/
					
					
					/*  AQUI SE PUEDE VALIDAR QUE SI ESA FECHA ES MENOR QUE UNA FECHA DE INICIO DE COMPENSACION 
					 *  POR BOLSA EXISTENTE AUN NO CERRADA 
					 *  ENTONCES SE CALCULEN HORAS EXTRAS, DE LO CONTRARIO NO HAGA NADA*/ 
/****************************************************			*/
					//Inicio - JRR - 27/10/2008
/*					T3792DAO compDAO = new T3792DAO(dbpool);
					List compensaciones = new ArrayList();
					Map datos = new HashMap();
					Map compensacion= new HashMap();
					String fechaCompensacion ="";
					int dif = 0; */

					
					//boolean generarLE = true;
					//Si paso las validaciones de Fecha de ingreso y de dia Autorizado recien entra a validar Bolsa
					if (generarLE) {

						//Si utilizo obtenerDiferenciaDias
						//datos.put("fechaInicio", fecha);
						datos.put("fec_compensa", new FechaBean(fecha).getSQLDate());
						datos.put("cod_pers", codPers);
						compensaciones = compDAO.findCompensacionesPendByPers(datos);

						if (compensaciones!=null && compensaciones.size()>0) {
							for (int j = 0; j < compensaciones.size(); j++) {

								compensacion = (HashMap) compensaciones.get(j);
								log.debug("Map compensacion: " + compensacion);							
								fechaCompensacion = (String) compensacion.get("fec_ini_desc");
								log.debug("fechaCompensacion: " + fechaCompensacion);
								//datos.put("fechaFin", fechaCompensacion);
								//dif = obtenerDiferenciaDias(datos);
								dif = Utiles.obtenerDiasDiferencia(fecha, fechaCompensacion);
								log.debug("dif: " + dif);
								//Basta que exista una compensacion en bolsa vigente cuya fechaIniCompensacion sea
								//menor a la fecha en la que se intenta calcular LE para q no se deba generar la LE
								//para ese dia
								if (dif<=0) generarLE = false;
								if (log.isDebugEnabled()) log.debug("Valor de generarLE:" + generarLE);

							}		
						}
					}
					
					if (generarLE) {
					//Fin 
/***********************************/
					
/*						boolean tiene = dao.findByCodPersFAutor(dbpool, codPers, fecha);

						//JRR
						boolean tieneIguales = false;
						if (tiene) {
							tieneIguales = dao.findByCodPersFAutorAcumIgualActual(dbpool, codPers, fecha);
							if (tieneIguales) {
								ServiceLocator sl = ServiceLocator.getInstance();
								DataSource dgSp = sl.getDataSource("java:comp/env/jdbc/dgsp");
								T130DAO dsDAO = new T130DAO(dgSp);

								dsDAO.deleteLE(codPers, fecha);
								tiene = false;
							}
						}
						*/

						log.debug("TIENE LE :" + tiene);
						if (!tiene) {


							BeanTurnoTrabajo turno = turnoDAO.joinWithT45ByCodFecha(dbpool, codPers, fecha);
							
							//EBV - 31/10/2008 - turno nulo
							if (turno!=null){
								if (Constantes.TURNO_RS067.equals(turno.getTurno().trim())){
									turno =null;
								}
							}
							if (turno!=null){
								if ((turno.isOperativo()) || (!turno.isControla()) ){
									turno =null;
								}
							}

							
							/*********************************/
							//25/06/2009
							
							if (turno!=null){

								Map turnoAutorizado= new HashMap();
								boolean estaAutorizado = false;

								if (turnosAutorizados!=null && turnosAutorizados.size()>0) {
									for (int k = 0; k < turnosAutorizados.size(); k++) {

										turnoAutorizado = (HashMap) turnosAutorizados.get(k);
										if (log.isDebugEnabled()) log.debug("turnoAutorizado: " + turnoAutorizado);
										if (turnoAutorizado.get("t99codigo").toString().trim().equals(turno.getTurno().trim())) {
											if (log.isDebugEnabled()) log.debug(turnoAutorizado.get("t99codigo").toString().trim() + " = " + turno.getTurno().trim());
											estaAutorizado = true;
											break;
										}
									}
								}

								if (!estaAutorizado) turno = null;

							}
							//	
							/*********************************/
							
							
							boolean diaEspecial = Utiles.isDiaSemana(fecha, Constantes.SABADO)
							|| Utiles.isDiaSemana(fecha, Constantes.DOMINGO)
							|| paramDAO.findByFechaFeriado(dbpool, fecha);						

							if (turno!=null){
								
								/************JRR - 07/11/2008 - COMPENSACION BOLSA****************			*/
								//boolean procesa = false;
								int tiempo_aux = 0;

//								T3793DAO detCompDAO = new T3793DAO(dbpool);
								
								//List lista = null; //detCompDAO.findTiempoCompensadoFechaCerrado(datos);
								tiempo_aux = detCompDAO.findTiempoCompensadoFechaCerrado(datos);
								
								/********************************/
								
								
								if (diaEspecial){
									//Dias NO Laborales
									
									//JRR - BORRA
									log.debug("ES -=diaEspecial=-");

									
									log.debug("TURNO HE " + turno.getHoraFin());
									log.debug("TURNO HE " + turno.getHoraIni());
									//Para la entrada anticipada
									he.setHoraSalida("23:59:59");
									he.setHoraIni("00:00:00");
									///
									String horaFin = he.getHoraSalida() != null ? he
											.getHoraSalida().trim() : "";

											//JRR
											log.debug("he: " + he);
											log.debug("he.getHoraSalida(): " + he.getHoraSalida());

											//solo se procesaran los registros con hora de salida
											log.debug("HORAFIN HE " + horaFin);
											if (!horaFin.equals("")) {
												log.debug("ENTRE HE ");
												log.debug("Fecha : "+fecha);
												//float cantidad = calcularHorasPermanencia(dbpool,codPers,he);
												lhe = calcularHorasPermanencia(dbpool,codPers,he);
												log.debug("LE " + lhe);
												String c1= (String)lhe.get("cantidad");
												String hora = (String) lhe.get("hora");

												String hora0 = (String) lhe.get("hora0");
												log.debug(" Hora0 " + hora0);
												log.debug(" Hora " + hora);
												int cantidad = Integer.parseInt(c1);
												log.debug(" - Horas : "+cantidad);
												
					
												/********** JRR - 07/11/2008 - COMPENSACION BOLSA **********			*/							
												//Si existen licencias por bolsa cerradas que ya tienen tiempo utilizado perteneciente a la fecha en analisis
												log.debug("tiempo_aux: " + tiempo_aux);
												
													if (tiempo_aux>0) {
														int diferencia = cantidad - tiempo_aux;
														log.debug("Tiempo disponible - cantidad: " + cantidad);
														//Si existe tiempo para esa fecha que aun no ha sido utilizado en compensaciones
														if (diferencia>0) 
															{ cantidad = cantidad - tiempo_aux; } 
														else 
															{ cantidad = 0; }
													}
												//Igual si hay resto para LE esta debr치 ser mayor minLabExc
												/**********************************************************/												
												

												if (cantidad > minLabExc) {

													total += cantidad;
													//EBV 06/09/2006 No grabo aun.
													//PRAC-ASANCHEZ 26/08/2009
													dao.insertLE(dbpool, codPers, fecha, hora0, codUO, hora, Math.round(cantidad),Math.round(cantidad), usuario);
													//dao.insertLE(dbpool, codPers, fecha, hora0, codUO, hora, "2",Math.round(cantidad),Math.round(cantidad), usuario);
													//
													/**							T130CMPLocal cmpLocal = cmpHome
							.findByPrimaryKey(new T130CMPPK(he
									.getCodPers(), he
									.getFechaAutorizacion(), he
									.getHoraIni()));

							cmpLocal.setEstId(Constantes.ACTIVO);
							cmpLocal.setFmod(new Timestamp(System.currentTimeMillis()));
							cmpLocal.setCuserMod(usuario);
													 */
												}

											}
								}else{
									
									//JRR - BORRA
									log.debug("ES -=Dias Laborales=-");

									int tiempo_restante = 0;
									boolean seConsumio = false;
									boolean seActualizo = false;
									
									//Dias Laborales	
									log.debug("TURNO HE " + turno.getHoraFin());
									log.debug("TURNO HE " + turno.getHoraIni());
									//Para la entrada anticipada
									he.setHoraSalida(turno.getHoraIni());
									he.setHoraIni("00:00:00");
									///
									String horaFin = he.getHoraSalida() != null ? he
											.getHoraSalida().trim() : "";

											//solo se procesaran los registros con hora de salida
											log.debug("HORAFIN HE " + horaFin);
											if (!horaFin.equals("")) {
												log.debug("ENTRE HE ");
												log.debug("Fecha : "+fecha);
												//float cantidad = calcularHorasPermanencia(dbpool,codPers,he);
												lhe = calcularHorasPermanencia(dbpool,codPers,he);
												log.debug("LE " + lhe);
												String c1= (String)lhe.get("cantidad");
												String hora = (String) lhe.get("hora");

												String hora0 = (String) lhe.get("hora0");
												log.debug(" Hora0 " + hora0);
												log.debug(" Hora " + hora);
												int cantidad = Integer.parseInt(c1);

												log.debug(" Cantidad " + cantidad );
												log.debug(" minLabExc " + minLabExc );
												

												/********** JRR - 07/11/2008 - COMPENSACION BOLSA **********			*/							
												//Si existen licencias por bolsa cerradas que ya tienen tiempo utilizado perteneciente a la fecha en analisis
													log.debug("tiempo_aux: " + tiempo_aux);
													
													if (tiempo_aux>0) {
														int diferencia = cantidad - tiempo_aux;
														log.debug("diferencia: " + diferencia);
														//Si existe tiempo para esa fecha que aun no ha sido utilizado en compensaciones
														if (diferencia>=0) { 
															cantidad = cantidad - tiempo_aux;
															seConsumio = true;
															//En la salida no se utilizaria ya (tiempo_aux) pues se consumio
														} else { 
															cantidad = 0;
															tiempo_restante = diferencia*(-1);
															//Se actualizo (tiempo_aux), aun tiene minutos que ya compensaron algun feriadopor bolsa
															seActualizo = true;
															
														}
														
													}
												//Igual si hay resto para LE esta debr치 ser mayor minLabExc
												/**********************************************************/												
												
												if (cantidad > minLabExc) {

													total += cantidad;
													log.debug(" Total " + total );
													//EBV 06/09/2006 No grabo aun.
													//PRAC-ASANCHEZ 26/08/2009
													dao.insertLE(dbpool, codPers, fecha, hora0, codUO, hora, Math.round(cantidad),Math.round(cantidad), usuario);
													//dao.insertLE(dbpool, codPers, fecha, hora0, codUO, hora, "2",Math.round(cantidad),Math.round(cantidad), usuario);
													//													
													
													
													/**							T130CMPLocal cmpLocal = cmpHome
							.findByPrimaryKey(new T130CMPPK(he
									.getCodPers(), he
									.getFechaAutorizacion(), he
									.getHoraIni()));

							cmpLocal.setEstId(Constantes.ACTIVO);
							cmpLocal.setFmod(new Timestamp(System.currentTimeMillis()));
							cmpLocal.setCuserMod(usuario);
													 */
												}

											}

											
											//JRR - BORRA
											log.debug("ES -=Salida fuera de hora=-");
											
											
											//	/ Para la Salida fuera de hora
											///

											he.setHoraSalida("23:59:59");
											he.setHoraIni(turno.getHoraFin());

											horaFin = he.getHoraSalida() != null ? he
													.getHoraSalida().trim() : "";

													//solo se procesaran los registros con hora de salida
													log.debug("HORAFIN HE " + horaFin);
													if (!horaFin.equals("")) {
														log.debug("ENTRE HE ");
														log.debug("Fecha : "+fecha);
														lhe = calcularHorasPermanencia(dbpool,codPers,he);
														String c1= (String)lhe.get("cantidad");
														String hora = (String) lhe.get("hora");

														int cantidad = Integer.parseInt(c1);
														log.debug(" - Horas : "+cantidad);
														int horasCompensa = turnoDAO.findHorasCompensa(dbpool,codPers,fecha);
														log.debug(" - Horas Compensa : "+ horasCompensa);
														int cantidad1 = cantidad - horasCompensa;
														log.debug(" - Horas Final - cantidad1: "+ cantidad1);
														
														
														/********** JRR - 07/11/2008 - COMPENSACION BOLSA **********			*/							
														//Si existen licencias por bolsa cerradas que ya tienen tiempo utilizado perteneciente a la fecha en analisis
														log.debug("seActualizo: " + seActualizo);
														log.debug("seConsumio: " + seConsumio);	
														
															if (seActualizo) tiempo_aux = tiempo_restante;
															log.debug("tiempo_aux: " + tiempo_aux);
															
															if (tiempo_aux>0) {

																//Existe saldo
																if (!seConsumio) {

																	int diferencia = cantidad1 - tiempo_aux;
																	log.debug("Tiempo disponible - diferencia: " + diferencia);
																	//Si existe tiempo para esa fecha que aun no ha sido utilizado en compensaciones
																	if (diferencia>=0) { 
																		cantidad1 = cantidad1 - tiempo_aux;
																	} else { 
																		cantidad1 = 0;
																	}
																	
																}
																
															}
														//Igual si hay resto para LE esta debr치 ser mayor minLabExc
														/**********************************************************/												
														
														
														if (cantidad1 > minLabExc) {

															total += cantidad1;
															//	EBV 06/09/2006 No grabo aun.
															//PRAC-ASANCHEZ 26/08/2009
															dao.insertLE(dbpool, codPers, fecha, he.getHoraIni(), codUO, hora, Math.round(cantidad1),Math.round(cantidad1), usuario);
															//dao.insertLE(dbpool, codPers, fecha, he.getHoraIni(), codUO, hora, "2",Math.round(cantidad1),Math.round(cantidad1), usuario);
															//
															
															
															
															/**							T130CMPLocal cmpLocal = cmpHome
							.findByPrimaryKey(new T130CMPPK(he
									.getCodPers(), he
									.getFechaAutorizacion(), he
									.getHoraIni()));

							cmpLocal.setEstId(Constantes.ACTIVO);
							cmpLocal.setFmod(new Timestamp(System.currentTimeMillis()));
							cmpLocal.setCuserMod(usuario);
															 */
														}
													}
								}
								
								
								
							}
						}
/****		*/		}//Cierre del IF compensaciones!=null   */
				}
			}

/* JRR - 02/03/2009			
			T132CMPHome acumHome = (T132CMPHome) ServiceLocator.getInstance().getLocalHome(T132CMPHome.JNDI_NAME);
			log.debug("LLEGUE a t132");
			try {
				T132CMPLocal acumLocal = acumHome
						.findByPrimaryKey(new T132CMPPK(codPers));
				float actual = acumLocal.getTAcum().floatValue();
				acumLocal.setTAcum(new java.math.BigDecimal(actual + total));
				acumLocal.setFmod(new java.sql.Timestamp(System.currentTimeMillis()));
				acumLocal.setCuserMod(usuario);
			} catch (Exception e) {
				acumHome.create(codPers,
						new java.math.BigDecimal(total), Constantes.ACTIVO,
						new java.sql.Timestamp(System.currentTimeMillis()),
						usuario);
			}
*/			
		} catch (Exception e){
			log.error(e);
			//output.println("Error : " + e.toString());
		}
		return res;
	}

	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public String acumularHE(HashMap mapa, String usuario)
			throws RemoteException {

		String res = Constantes.OK;
		String id = (String) mapa.get("messageID");
		String dbpool = (String) mapa.get("dbpool");
		try {

			//ICAPUNAY 20/03/2013 - Memo 00023_2013_4F3100	
			int trabIni = Integer.parseInt((String) mapa.get("limiteInferior"));
			int trabFin = Integer.parseInt((String) mapa.get("limiteSuperior"));
			log.debug("trabIni : "+ trabIni);
			log.debug("trabFin : "+ trabFin);
			//ICAPUNAY 20/03/2013 - Memo 00023_2013_4F3100
			
			super.creaLog(id,"PROCESO DE ACUMULACION DE HORAS DE LABOR EXCEPCIONAL",usuario);

			HashMap seguridad = (HashMap) mapa.get("seguridad");
			String criterio = (String) mapa.get("criterio");
			String valor = (String) mapa.get("valor");

			T130DAO dao = new T130DAO();

			ArrayList trabajadores = dao.findAutorizadosByCriterioValor(dbpool,
					criterio, valor, seguridad);
			log.debug(" HE Trabajadores : "+ trabajadores);
			
			if (trabajadores != null) {
				//for (int i = 0; i < trabajadores.size(); i++) {//ICAPUNAY 20/03/2013 - Memo 00023_2013_4F3100
				for (int i = trabIni; i <= trabFin; i++) {//ICAPUNAY 20/03/2013 - Memo 00023_2013_4F3100
					if (i<trabajadores.size()){//ICAPUNAY 20/03/2013 - Memo 00023_2013_4F3100
						String t = (String) trabajadores.get(i);
						//JRR - 31/03/2009
						mapa.put("cod_Trab", t);
						log.debug("t : "+ t);//ICAPUNAY 20/03/2013 - Memo 00023_2013_4F3100
						log.debug("mapa : "+ mapa);//ICAPUNAY 20/03/2013 - Memo 00023_2013_4F3100
						acumularHETrabajador(mapa);
						//acumularHETrabajador(dbpool, t, usuario);
					}//ICAPUNAY 20/03/2013 - Memo 00023_2013_4F3100
				}
			}

		} catch (Exception e){
			log.error(e);
			//output.println("Error : " + e.toString());
		} finally {
			try {
				//registramos el log del proceso
				super.registraLog(dbpool, mapa, usuario);
			} catch (Exception e) {
			}
		}
		return res;
	}

	//JRR
	/**
	 * Metodo encargado de invocar al proceso de Asistencia para los cambios de turno de un trabajador
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @param mapa
	 * @return
	 * @throws RemoteException
	 */
	public void generarRegAsistenciaPorCambioTurnoTrab(Map mdatos)
			throws RemoteException {

		BeanMensaje beanM = new BeanMensaje();
		try {
			QueueDAO qd = new QueueDAO();
			Map mapa = new HashMap();
			if (log.isDebugEnabled()) log.debug("generarRegAsistenciaPorCambioTurnoTrab - mdatos: " + mdatos);
			String usuario = (mdatos.get("cuser_crea")!=null?mdatos.get("cuser_crea").toString():mdatos.get("cuser_mod").toString());
			
			FechaBean fbIni = new FechaBean(mdatos.get("fini").toString().trim().substring(0, 10), "yyyy-MM-dd");
			FechaBean fbFin = new FechaBean(mdatos.get("ffin").toString().trim().substring(0, 10), "yyyy-MM-dd");			
			FechaBean fbAct = new FechaBean();
			
			String fechaIni = fbIni.getFormatDate("dd/MM/yyyy");
			String fechaFin = fbFin.getFormatDate("dd/MM/yyyy");

			//Para validaciones
			String fActual = fbAct.getFormatDate("dd/MM/yyyy");
			String fActualValidacion = fbAct.getFormatDate("yyyy/MM/dd");
			String fechaIniValidacion = fbIni.getFormatDate("yyyy/MM/dd");
			String fechaFinValidacion = fbFin.getFormatDate("yyyy/MM/dd");
			
			if (fechaIniValidacion.compareTo(fActualValidacion) <= 0 ) {
				if (fechaFinValidacion.compareTo(fActualValidacion) > 0) fechaFin = fActual;
				
				if (log.isDebugEnabled()) { 
					log.debug("fechaIni: " + fechaIni);
					log.debug("fechaFin: " + fechaFin);
				}
				
				mapa.put("criterio", "0");
				mapa.put("valor", mdatos.get("cod_pers"));
				mapa.put("fechaIni", fechaIni);
				mapa.put("fechaFin", fechaFin);
				mapa.put("dbpool", "jdbc/dgsp");
				
				//ASANCHEZZ 20100617 - PROBLEMA DEL COD_PERS EN BLANCO EN LA TABLA t1481lote
				mapa.put("codPers", mdatos.get("codiPersProceso"));
				//FIN
				
				//ASANCHEZZ 20100412
				/*COMENTAMOS ESTO
				//eliminamos las marcaciones impares
				eliminarMarcacionesImpares((String)mapa.get("dbpool"), 
						(String)mapa.get("fechaIni"), 
						(String)mapa.get("fechaFin"),
						(String)mapa.get("criterio"), 
						(String)mapa.get("valor"));
				*/
				eliminarMarcacionesImpares(mapa);
				//FIN
				
				//seteamos los limites a procesar
				mapa.put("limiteInferior", "0");
				mapa.put("limiteSuperior", "1");
				mapa.put("observacion", "Registro de asistencias (" + (String)mapa.get("fechaIni") + "-"+
						(String)mapa.get("fechaFin")+"). Criterio : "+  mapa.get("criterio").toString().trim() + " - " +
						mapa.get("valor").toString().toUpperCase().trim() + ".");
				
				if (log.isDebugEnabled()) log.debug("GENERANDO - generarRegAsistenciaPorCambioTurnoTrab - mapa: " + mapa);
				
				qd.encolaProceso(ProcesoFacadeHome.JNDI_NAME,"generarRegistroAsistencia", (HashMap)mapa, usuario);
			}

		} catch (Exception e) {
			log.error(e,e);
			beanM.setMensajeerror(e.getMessage());
			beanM.setMensajesol("Por favor intente nuevamente.");
			throw new IncompleteConversationalState(beanM);
		}
	}
	
	//JRR
	/**
	 * Metodo encargado de registrar una novedad al ocurrir cambios en el turno de un trabajador
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @param mapa
	 * @return
	 * @throws RemoteException
	 */
	public void registrarNovedadPorCambioTurnoTrab(Map mdatos)
			throws RemoteException {

		if (log.isDebugEnabled()) log.debug("Ingres칩 a registrarNovedadPorCambioTurnoTrab(Map mdatos)");//ICAPUNAY 15/12/2010 AOM URGENTE: 44U3T10 Gesti칩n de turnos y calificacion de procesos
		BeanMensaje beanM = new BeanMensaje();
		try {
			/*T3701DAO t3701dao = new T3701DAO("jdbc/dcsp");*/
			T3701DAO t3701dao = new T3701DAO("jdbc/dgsp");//ICAPUNAY 15/12/2010 AOM URGENTE: 44U3T10 Gesti칩n de turnos y calificacion de procesos
			Map mnovedad = new HashMap();
			Map map_aux = null;
			
			mnovedad.put("cod_pers", mdatos.get("cod_pers"));
			mnovedad.put("ind_proceso", "1");
			mnovedad.put("cod_usucrea", mdatos.get("cuser_crea")!=null?mdatos.get("cuser_crea"):mdatos.get("cuser_mod"));
			mnovedad.put("fec_creacion", mdatos.get("fcreacion")!=null?mdatos.get("fcreacion"):mdatos.get("fmod"));
			
			FechaBean fbIni = new FechaBean(mdatos.get("fini").toString().trim().substring(0, 10), "yyyy-MM-dd");
			FechaBean fbFin = new FechaBean(mdatos.get("ffin").toString().trim().substring(0, 10), "yyyy-MM-dd");
			FechaBean fbAct = new FechaBean();			
			String fechaIni = fbIni.getFormatDate("dd/MM/yyyy");
			String fechaFin = fbFin.getFormatDate("yyyy/MM/dd");
			String fActual = fbAct.getFormatDate("yyyy/MM/dd");
			String fecha = Utiles.toYYYYMMDD(fechaIni);
			String fNovedad = fechaIni;
			Date tNovedad = Utiles.stringToDate(fNovedad);
			
			if (log.isDebugEnabled()) {
				log.debug("fechaIni: " + fechaIni);
				log.debug("fechaFin: " + fechaFin);
				log.debug("fActual: " + fActual);
				log.debug("fecha: " + fecha);
				log.debug("tNovedad: " + tNovedad);
			}
			
			//Solo registrara novedad hasta el dia de hoy
			if (fechaFin.compareTo(fActual) > 0) fechaFin =	fActual;
			
			while (fecha.compareTo(fechaFin) <= 0) {
				mnovedad.put("fec_refer", tNovedad);

				map_aux = t3701dao.findNovedadByTrabFec(mnovedad); 
				if(map_aux!=null){
					mnovedad.put("ind_proc_cerrado", "2");
					t3701dao.actualizarNovedadCerrada(mnovedad);
				}
				else
					t3701dao.registrarNovedad(mnovedad);
				
				fNovedad = Utiles.dameFechaSiguiente(fNovedad, 1);
				tNovedad = Utiles.stringToDate(fNovedad);
				fecha = Utiles.toYYYYMMDD(fNovedad);
			}
			
		} catch (Exception e) {
			log.error(e,e);
			beanM.setMensajeerror(e.getMessage());
			beanM.setMensajesol("Por favor intente nuevamente.");
			throw new IncompleteConversationalState(beanM);
		}
	}
	
	
	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="Required"
	 * 
	 */
	public String registrarTurnoSinCruce(Map mapa) throws RemoteException {
/*ASANCHEZZ 20100617 - SE MODIFICA LA INVOCACION AL METODO
public String registrarTurnoSinCruce(String dbpool, String codPers,
	String turno, String uorg, String fechaIni, String fechaFin,
	String usuario, boolean vCruce, boolean tieneLog)
	throws RemoteException {
*///FIN

		String res = Constantes.OK;

		//ASANCHEZZ 20100617
		String dbpool = (String)mapa.get("dbpool");
		String codPers = (String)mapa.get("valor");
		String turno = (String)mapa.get("turno");
		String uorg = (String)mapa.get("uorg");
		String fechaIni = (String)mapa.get("fechaIni");
		String fechaFin = (String)mapa.get("fechaFin");
		String obsSustento=(String)mapa.get("obsSustento");
		String usuario = (String)mapa.get("usuario");
		boolean vCruce = false;
		if(mapa.get("cruce").equals("1")) vCruce = true;
		boolean tieneLog = false;
		if(mapa.get("tieneLog").equals("1")) tieneLog = true;
		String codiPersProceso = (String)mapa.get("codiPersProceso");
		//FIN

		try {
			if (tieneLog) {
				//output.println("Trabajador : " + codPers);
			}

			T1270DAO dao = new T1270DAO();
			//primero obtenemos los turnos asignados al personal
			ArrayList turnos = dao.joinWithT45(dbpool, codPers);

			//verificamos cruces
			java.sql.Timestamp f1 = Utiles.stringToTimestamp(fechaIni);
			java.sql.Timestamp f2 = Utiles.stringToTimestamp(fechaFin);
			java.sql.Timestamp fIni = new java.sql.Timestamp(f1.getTime());
			java.sql.Timestamp fFin = new java.sql.Timestamp(f2.getTime());
			
//			T1270CMPHome cmpHome = (T1270CMPHome) ServiceLocator.getInstance().getLocalHome(T1270CMPHome.JNDI_NAME);
			//JRR - 23/01/2009
			pe.gob.sunat.rrhh.asistencia.dao.T1270DAO t1270dao = new pe.gob.sunat.rrhh.asistencia.dao.T1270DAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dgsp"));
			FechaBean fecAct = new FechaBean();
			Map mturno = new HashMap();
			Map mdatos = new HashMap();
			mdatos.put("cod_pers", codPers);
			mdatos.put("turno", turno);
			mdatos.put("fini", fIni);
			mdatos.put("u_organ", uorg);
			mdatos.put("ffin", fFin);
			mdatos.put("obsSustento", obsSustento);
			mdatos.put("sonom_id", "");
			mdatos.put("est_id", Constantes.ACTIVO);
			//
			
			//ASANCHEZZ 20100617
			mdatos.put("codiPersProceso", codiPersProceso);
			//
			
			//si se desea q se verifique los cruces
			if (vCruce) {

				boolean hayCruce = verificaCruceTurnosTrabajador(turnos, "", fIni, fFin, false);

				//si no hay cruces entonces registramos
				if (!hayCruce) {

					try {
						mturno = t1270dao.findTurnoPersonaByPK(mdatos);
						
						if (mturno!= null && mturno.get("est_id").toString().trim().equals(Constantes.INACTIVO)) {
							mdatos.put("cuser_mod", usuario);
							mdatos.put("fmod", fecAct.getTimestamp());
							
							//Activamos y modificamos el turno
							t1270dao.actualizarTurnoPersona(mdatos);
							
							generarRegAsistenciaPorCambioTurnoTrab(mdatos);
							registrarNovedadPorCambioTurnoTrab(mdatos);
						} else {
							throw new Exception("El turno que desea registrar presenta cruces");
						}
					} catch (Exception ex) {
						log.debug("REgistre aca.");
						mdatos.put("cuser_crea", usuario);
						mdatos.put("fcreacion", fecAct.getTimestamp());
						mdatos.put("modificar","sustento");
						t1270dao.registrarTurnoPersona(mdatos);

						generarRegAsistenciaPorCambioTurnoTrab(mdatos);
						registrarNovedadPorCambioTurnoTrab(mdatos);
					}

				}
				//en caso contrario
				else {
					res = "El turno asignado presenta cruce.";
					//output.println(res);
				}
			} else {

				mdatos.put("cuser_crea", usuario);
				mdatos.put("fcreacion", fecAct.getTimestamp());
				t1270dao.registrarTurnoPersona(mdatos);
				
				generarRegAsistenciaPorCambioTurnoTrab(mdatos);
				registrarNovedadPorCambioTurnoTrab(mdatos);

/*				cmpHome.create(codPers,
						uorg, turno, fIni, fFin, Constantes.ACTIVO,
						new java.sql.Timestamp(System.currentTimeMillis()),
						usuario); */

			} 
		}
		catch (Exception e){
			log.error(e);
			//output.println("Error : " + e.toString());
		}
		return res;
	}

	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public String registrarTurnoTrabajo(HashMap mapa, String usuario)
			throws RemoteException {

		String res = Constantes.OK;
		String id = (String) mapa.get("messageID");
		String dbpool = (String) mapa.get("dbpool");
		try {

			super.creaLog(id, "REGISTRO DE TURNOS DE TRABAJO", usuario);

			HashMap seguridad = (HashMap) mapa.get("seguridad");
			String criterio = (String) mapa.get("criterio");
			String valor = (String) mapa.get("valor");
			String turno = (String) mapa.get("turno");
			String fechaIni = (String) mapa.get("fechaIni") + " 00:00:00";
			String fechaFin = (String) mapa.get("fechaFin") + " 00:00:00";
			String obsSustento = (String) mapa.get("obsSustento");//agregado 22/05/2018 dtarazona
			boolean cruce = mapa.get("cruce") != null ? ((String) mapa
					.get("cruce")).equals("true") : false;

			T02DAO dao = new T02DAO();
			
			//JRR - 13/05/2009
			VacacionFacadeHome facadeVacHome = (VacacionFacadeHome) sl.getRemoteHome(
					VacacionFacadeHome.JNDI_NAME,
					VacacionFacadeHome.class);
			VacacionFacadeRemote facadeVacRemote = facadeVacHome.create();
			if (log.isDebugEnabled()) log.debug("registrarTurnoTrabajo - mapa: "+mapa);
			String fecha_ingreso = "";
			Map hmVacGen = new HashMap();
			int dias = 0;

			//ASANCHEZZ 20100617
			Map mapaAux;
			String codPers = mapa.get("codPers")!=null?(String)mapa.get("codPers"):"";
			//FIN
			
			//registro de turno de trabajo por personal
			if (criterio.equals("0")) {

				HashMap t = dao.joinWithT12T99ByCodPers(dbpool, valor,
						seguridad);
				
				//JRR - 11/05/2009 - Fecha de ingreso/reingreso
				hmVacGen = facadeVacRemote.buscarVacacionesGen(dbpool, valor);
			    if (hmVacGen!=null && hmVacGen.get("fecha")!=null && !hmVacGen.get("fecha").toString().equals("")){
					fecha_ingreso = hmVacGen.get("fecha").toString();
				} 
			    if (log.isDebugEnabled()) log.debug("fecha_ingreso: "+fecha_ingreso);
			    
			    //Validar que solo cambie turno si fechaIni > fecha_ingreso  dd/mm/yyyy
			    dias = Utiles.obtenerDiasDiferencia(fecha_ingreso, mapa.get("fechaIni").toString());
			    
			    if (dias>=0) {
			    	if (log.isDebugEnabled()) log.debug("Fecha Inicio mayor por dias: " + dias);
			    	//ASANCHEZZ 20100617
			    	mapaAux = new HashMap();
			    	mapaAux.put("dbpool", dbpool);
			    	mapaAux.put("valor", valor);
			    	mapaAux.put("turno", turno);
			    	mapaAux.put("uorg", (String) t.get("t02cod_uorg"));
			    	mapaAux.put("fechaIni", fechaIni);
			    	mapaAux.put("fechaFin", fechaFin);
			    	mapaAux.put("obsSustento", obsSustento);
			    	mapaAux.put("usuario", usuario);
			    	mapaAux.put("cruce", cruce == true ? "1" : "0");
			    	mapaAux.put("tieneLog", "1");
			    	mapaAux.put("codiPersProceso", codPers);
			    	
					if (cruce) {
						/*
						res = registrarTurnoSinCruce(dbpool, valor, turno,
								(String) t.get("t02cod_uorg"), fechaIni, fechaFin,
								usuario, cruce, true);
						*/
						res = registrarTurnoSinCruce(mapaAux);
					} else {
						/*
						res = registrarTurnoConCruce(dbpool, valor, turno, fechaIni,
								fechaFin, (String) t.get("t02cod_uorg"), usuario);
						*/
						res = registrarTurnoConCruce(mapaAux);
					}
					//FIN

			    } else {
			    	dias = dias*(-1);
			    	res = "La fecha de inicio del turno es anterior a la fecha de ingreso del trabajador " + valor + " por " + dias +" dias de diferencia.";
			    	super.escribe(res, "REGISTRO DE TURNOS DE TRABAJO", mapa, usuario);
			    }
				//
			}

			//registro de turno de trabajo por unidad
			if (criterio.equals("1")) {

				ArrayList trabajadores = dao.findByUO(dbpool, valor, seguridad);

				HashMap t = null;
				if (trabajadores != null) {
					for (int i = 0; i < trabajadores.size(); i++) {

						t = (HashMap) trabajadores.get(i);
						
						if (log.isDebugEnabled()) log.debug("t: "+t);
						
						//JRR - 11/05/2009 - Fecha de ingreso/reingreso
						hmVacGen = facadeVacRemote.buscarVacacionesGen(dbpool, t.get("t02cod_pers").toString().trim());
					    if (hmVacGen!=null && hmVacGen.get("fecha")!=null && !hmVacGen.get("fecha").toString().equals("")){
							fecha_ingreso = hmVacGen.get("fecha").toString();
						} 
					    if (log.isDebugEnabled()) log.debug("fecha_ingreso: "+fecha_ingreso);
					    
					    //Validar que solo cambie turno si fechaIni > fecha_ingreso  dd/mm/yyyy
					    dias = Utiles.obtenerDiasDiferencia(fecha_ingreso, mapa.get("fechaIni").toString());
					    
					    if (dias>=0) {
					    	if (log.isDebugEnabled()) log.debug("Fecha Inicio mayor por dias: " + dias);
					    	//ASANCHEZZ 20100617
					    	mapaAux = new HashMap();
					    	mapaAux.put("dbpool", dbpool);
					    	mapaAux.put("valor", (String) t.get("t02cod_pers"));
					    	mapaAux.put("turno", turno);
					    	mapaAux.put("uorg", (String) t.get("t02cod_uorg"));
					    	mapaAux.put("fechaIni", fechaIni);
					    	mapaAux.put("fechaFin", fechaFin);
					    	mapaAux.put("obsSustento", obsSustento);
					    	mapaAux.put("usuario", usuario);
					    	mapaAux.put("cruce", cruce == true ? "1" : "0");
					    	mapaAux.put("tieneLog", "1");
					    	mapaAux.put("codiPersProceso", codPers);
					    	
							if (cruce) {
								/*
								registrarTurnoSinCruce(dbpool, (String) t
										.get("t02cod_pers"), turno, (String) t
										.get("t02cod_uorg"), fechaIni, fechaFin,
										usuario, cruce, true);
								*/
								registrarTurnoSinCruce(mapaAux);
							} 
							else {
								/*
								registrarTurnoConCruce(dbpool, (String) t
										.get("t02cod_pers"), turno, fechaIni,
										fechaFin, (String) t.get("t02cod_uorg"),
										usuario);
								*/
								registrarTurnoConCruce(mapaAux);
							}
					    	//FIN
					    	
					    } else {
					    	dias = dias*(-1);
					    	res = "La fecha de inicio del turno es anterior a la fecha de ingreso del trabajador " + t.get("t02cod_pers") + " por " + dias +" dias de diferencia.";
					    	super.escribe(res, "REGISTRO DE TURNOS DE TRABAJO", mapa, usuario);
					    }
						//

					}
				}
			}

			//registro de turno de trabajo por categoria
			if (criterio.equals("2")) {

				ArrayList trabajadores = dao.findByCategoria(dbpool, valor,
						seguridad);

				HashMap t = null;
				if (trabajadores != null) {
					for (int i = 0; i < trabajadores.size(); i++) {

						t = (HashMap) trabajadores.get(i);

						//JRR - 11/05/2009 - Fecha de ingreso/reingreso
						hmVacGen = facadeVacRemote.buscarVacacionesGen(dbpool, t.get("t02cod_pers").toString().trim());
					    if (hmVacGen!=null && hmVacGen.get("fecha")!=null && !hmVacGen.get("fecha").toString().equals("")){
							fecha_ingreso = hmVacGen.get("fecha").toString();
						} 
					    if (log.isDebugEnabled()) log.debug("fecha_ingreso: "+fecha_ingreso);
					    
					    //Validar que solo cambie turno si fechaIni > fecha_ingreso  dd/mm/yyyy
					    dias = Utiles.obtenerDiasDiferencia(fecha_ingreso, mapa.get("fechaIni").toString());
					    
					    if (dias>=0) {
					    	if (log.isDebugEnabled()) log.debug("Fecha Inicio mayor por dias: " + dias);
					    	//ASANCHEZZ 20100617
					    	mapaAux = new HashMap();
					    	mapaAux.put("dbpool", dbpool);
					    	mapaAux.put("valor", (String) t.get("t02cod_pers"));
					    	mapaAux.put("turno", turno);
					    	mapaAux.put("uorg", (String) t.get("t02cod_uorg"));
					    	mapaAux.put("fechaIni", fechaIni);
					    	mapaAux.put("fechaFin", fechaFin);
					    	mapaAux.put("obsSustento", obsSustento);
					    	mapaAux.put("usuario", usuario);
					    	mapaAux.put("cruce", cruce == true ? "1" : "0");
					    	mapaAux.put("tieneLog", "1");
					    	mapaAux.put("codiPersProceso", codPers);

					    	if (cruce) {
								/*
								registrarTurnoSinCruce(dbpool, (String) t
										.get("t02cod_pers"), turno, (String) t
										.get("t02cod_uorg"), fechaIni, fechaFin,
										usuario, cruce, true);
								*/
								registrarTurnoSinCruce(mapaAux);
							} else {
								/*
								registrarTurnoConCruce(dbpool, (String) t
										.get("t02cod_pers"), turno, fechaIni,
										fechaFin, (String) t.get("t02cod_uorg"),
										usuario);
								*/
								registrarTurnoConCruce(mapaAux);
							}
					    	//FIN
					    	
					    } else {
					    	dias = dias*(-1);
					    	res = "La fecha de inicio del turno es anterior a la fecha de ingreso del trabajador " + t.get("t02cod_pers") + " por " + dias +" dias de diferencia.";
					    	super.escribe(res, "REGISTRO DE TURNOS DE TRABAJO", mapa, usuario);
					    }
						//
						
					}
				}
			}
		} catch (Exception e) {
			//output.println(e.getMessage());
			log.error(e);
		} finally {
			try {
				//registramos el log del proceso
				super.registraLog(dbpool, mapa, usuario);
			} catch (Exception e) {
			}
		}
		return res;
	}

	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public String procesarOperativoMasivo(HashMap mapa, String usuario)
			throws RemoteException {

		String res = Constantes.OK;
		String id = (String) mapa.get("messageID");
		String dbpool = (String) mapa.get("dbpool");
		try {
			
			//JRR - 15/05/2009
			VacacionFacadeHome facadeVacHome = (VacacionFacadeHome) sl.getRemoteHome(
					VacacionFacadeHome.JNDI_NAME,
					VacacionFacadeHome.class);
			VacacionFacadeRemote facadeVacRemote = facadeVacHome.create();
			if (log.isDebugEnabled()) log.debug("procesarOperativoMasivo - mapa: "+mapa);
			String fecha_ingreso = "";
			Map hmVacGen = new HashMap();
			int dias = 0;
			//

			super.creaLog(id, "PROCESO DE PLANIFICACION OPERATIVA", usuario);

			String listaTrab = (String) mapa.get("trabajadores");
			StringTokenizer st = new StringTokenizer(listaTrab, "&");
			
			while (st.hasMoreTokens()) {

				String token = st.nextToken();
				StringTokenizer st2 = new StringTokenizer(token, "_");
				String codPers = st2.nextToken();
				String uo = st2.nextToken();

				try {
					mapa.put("codTrab",codPers);
					mapa.put("codUO",uo);
					
					//JRR - 14/05/2009 - Fecha de ingreso/reingreso
					hmVacGen = facadeVacRemote.buscarVacacionesGen(dbpool, codPers);
				    if (hmVacGen!=null && hmVacGen.get("fecha")!=null && !hmVacGen.get("fecha").toString().equals("")){
						fecha_ingreso = hmVacGen.get("fecha").toString();
					} 
				    if (log.isDebugEnabled()) log.debug("fecha_ingreso: "+fecha_ingreso);
				    
				    //Validar que solo cambie turno si fechaIni > fecha_ingreso  dd/mm/yyyy
				    dias = Utiles.obtenerDiasDiferencia(fecha_ingreso, mapa.get("fechaIni").toString());
				    
				    if (dias>=0) {
				    	if (log.isDebugEnabled()) log.debug("Fecha Inicio mayor por dias: " + dias);

				    	//procesamos operativo para el trabajador
						procesarOperativoTrabajador(mapa,usuario);
				    	
				    } else {
				    	dias = dias*(-1);
				    	res = "La fecha de inicio del turno es anterior a la fecha de ingreso del trabajador " + codPers + " por " + dias +" dias de diferencia.";
				    	super.escribe(res, "PROCESO DE PLANIFICACION OPERATIVA", mapa, usuario);
				    }
					//
											
				} catch (Exception e) {
					log.debug("Error : " + e.getMessage());
				}
			}
		} catch (Exception e){
			log.error(e);
			//output.println("Error : " + e.toString());
		} finally {
			try {
				//registramos el log del proceso
				super.registraLog(dbpool, mapa, usuario);
			} catch (Exception e) {
			}
		}
		return res;
	}

	/**
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="RequiresNew"
	 */
	public void procesarOperativoTrabajador(HashMap mapa, String usuario)
		throws IncompleteConversationalState, RemoteException {
		
		
		String dbpool = (String) mapa.get("dbpool");
		String codPers = (String) mapa.get("codTrab");
		String codUO = (String) mapa.get("codUO");
		String fechaIni = (String) mapa.get("fechaIni");
		String fechaFin = (String) mapa.get("fechaFin");
		ArrayList detalle = (ArrayList) mapa.get("detalle");
		String bFeriado = (String) mapa.get("bFeriado");
		String bSabado = (String) mapa.get("bSabado");
		String bDomingo = (String) mapa.get("bDomingo");
    	//ASANCHEZZ 20100617
    	Map mapaAux = new HashMap();
    	//FIN
    	//ASANCHEZZ 20100618 - Se generan mensajes de Registros de Asistencia con codPers = null, ejem: 169154117905
    	String codiPersProceso = mapa.get("codPers") != null ? (String)mapa.get("codPers") : "";
    	//

		try {

			//output.println("Trabajador : "+codPers);

			T01DAO dao = new T01DAO();
			T1270DAO turnoDAO = new T1270DAO(); 

			//instanciamos los EJBs
/*			T1270CMPHome turnoCMP = (T1270CMPHome) ServiceLocator.getInstance().getLocalHome(T1270CMPHome.JNDI_NAME);			
			
			T1270CMPLocal cmpLocal = null;*/
			
			//JRR - 26/01/2009
			pe.gob.sunat.rrhh.asistencia.dao.T1270DAO t1270dao = new pe.gob.sunat.rrhh.asistencia.dao.T1270DAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dgsp"));
			Map mturno = new HashMap();
			Map mdatos = new HashMap();
			String sFin = "";
			Timestamp tFin;
			
			//fecha inicio de proceso
			String fIni = Utiles.toYYYYMMDD(fechaIni);
			//fecha fin de proceso
			String fFin = Utiles.toYYYYMMDD(fechaFin);
			//fecha indice de proceso
			String fAct = fIni;
			String fReal = fechaIni;
			
			log.debug("mapa: " +mapa);
			log.debug("fIni: " + fIni);
			log.debug("fFin: " + fFin);
			log.debug("fAct: " + fAct);
			log.debug("fReal: " + fReal);

			//detalle de planificacion actual
			BeanTurnoTrabajo turno = null;
			//indice del detalle
			int indDetalle = 0;

			//C칩digo del tuno a asignar
			String strTurno = "";
			String fFinTurno = "";

			MantenimientoFacadeHome facadeMantHome = (MantenimientoFacadeHome) ServiceLocator
					.getInstance().getRemoteHome(
							MantenimientoFacadeHome.JNDI_NAME,
							MantenimientoFacadeHome.class);
			
			MantenimientoFacadeRemote facadeMantRemote = facadeMantHome
					.create();

			//para verificar si el turno es de 2 dias
			boolean b2dias = false;			
			//mientras no haya terminado el proceso
			while (fAct.compareTo(fFin) <= 0) {

				//output.println("Fecha Actual : "+fAct);
				//output.println("b2dias : "+b2dias);
				
				//obtenemos el siguiente detalle
				turno = (BeanTurnoTrabajo) detalle.get(indDetalle++);
				int diasDetalle = turno.getDuracion();

				//pasamos al siguiente detalle
				if (indDetalle >= detalle.size()) indDetalle = 0;
				
				String fAux = fReal;
				int iAux = 1;

				while (iAux <= diasDetalle) {

					boolean especial = false;

					if (!bFeriado.equals("true")) {
						if (dao.findByFechaFeriado(dbpool, fAux)) {
							especial = true;
						}
					}

					if (!bSabado.equals("true")) {
						if (Utiles.isDiaSemana(fAux, Constantes.SABADO)) {
							especial = true;
						}
					}

					if (!bDomingo.equals("true")) {
						if (Utiles.isDiaSemana(fAux, Constantes.DOMINGO)) {
							especial = true;
						}
					}

					if (iAux != diasDetalle) {
						fAux = Utiles.dameFechaSiguiente(fAux, 1);
					} else {
						if (especial) {
							fAux = Utiles.dameFechaSiguiente(fAux, 1);
						}
					}

					if (!especial) {
						iAux++;
					}
				}

				//output.println("Tipo Turno : "+turno.getDescTurno());
				
				// Realizamos el registro del turno
				// operativo para cada uno de los trabajadores
				if (!turno.getDescTurno().equals("DESCANSO")) {

					//Obtenemos los datos del turno
					strTurno = turno.getTurno().trim();

					//Obtenemos el bean con los datos del turno
					BeanTurno bTurno = (BeanTurno) ((ArrayList) facadeMantRemote
							.buscarTurnos(dbpool, "6", strTurno)).get(0);
					
					if (bTurno.getHoraFin().compareTo(bTurno.getHoraIni()) <= 0) {
						b2dias = true;
						fFinTurno = Utiles.dameFechaSiguiente(fAux, 1);
					} else {
						b2dias = false;
						fFinTurno = fAux;
					}

					if (Utiles.toYYYYMMDD(fFinTurno).compareTo(fFin) >= 0) {
						fFinTurno = fechaFin;
					}

					//output.println("Fecha Ini NTurno : "+fReal);
					//output.println("Fecha Fin NTurno : "+fFinTurno);
					
			    	//ASANCHEZZ 20100617
			    	mapaAux = new HashMap();
			    	mapaAux.put("dbpool", dbpool);
			    	mapaAux.put("valor", codPers);
			    	mapaAux.put("turno", strTurno);
			    	mapaAux.put("uorg", codUO);
			    	mapaAux.put("fechaIni", fReal + " 00:00:00");
			    	mapaAux.put("fechaFin", fFinTurno + " 00:00:00");
			    	mapaAux.put("usuario", usuario);
			    	//20100618
			    	mapaAux.put("codiPersProceso", codiPersProceso);
			    	//
					/*
					registrarTurnoConCruce(dbpool, codPers, strTurno, fReal + " 00:00:00",
							fFinTurno + " 00:00:00", codUO, usuario);
					*/
					registrarTurnoConCruce(mapaAux);
					//FIN						
													
				}
				else{
					//debemos eliminar todos los turnos asignados durante el periodo de descanso
					BeanTurnoTrabajo bTurnoTrab = null;
						
					ArrayList turnos = null;

					//si el turno anterior va de un dia para otro
					if (b2dias){
						turnos = turnoDAO.joinWithT45ByCodFiniFfin(
									dbpool,codPers,
									Utiles.stringToTimestamp(Utiles.dameFechaSiguiente(fReal, 1) + " 00:00:00"),
									Utiles.stringToTimestamp(Utiles.dameFechaSiguiente(fAux, 1) + " 00:00:00"),
									1);					
					}
					else{
						turnos = turnoDAO.joinWithT45ByCodFiniFfin(
								dbpool,codPers,
								Utiles.stringToTimestamp(fReal + " 00:00:00"),
								Utiles.stringToTimestamp(fAux + " 00:00:00"),
								1);										
					}
					
					if (turnos!=null){
						
						for (int i = 0; i < turnos.size(); i++) {
							
							bTurnoTrab = (BeanTurnoTrabajo)turnos.get(i);
							
							//output.println("Turno : "+bTurnoTrab.getTurno());
							//output.println("FechaIni : "+bTurnoTrab.getFechaIni()+" - FechaFin : "+bTurnoTrab.getFechaFin());

							//JRR 26/01/2009
							mdatos.put("cod_pers", codPers);
							mdatos.put("turno", bTurnoTrab.getTurno());
							mdatos.put("fini", bTurnoTrab.getFechaIni());
							mturno = t1270dao.findTurnoPersonaByPK(mdatos);

							if (mturno!= null) {
								sFin = mturno.get("ffin").toString().trim();
								tFin = Utiles.stringToTimestamp(sFin + " 00:00:00");
								t1270dao.eliminarTurnoPersona(mdatos);

								if (!tFin.before(Utiles.stringToTimestamp(fAux + " 00:00:00"))){
							    	//ASANCHEZZ 20100617
							    	mapaAux = new HashMap();
							    	mapaAux.put("dbpool", dbpool);
							    	mapaAux.put("valor", codPers);
							    	mapaAux.put("turno", bTurnoTrab.getTurno());
							    	mapaAux.put("uorg", codUO);
							    	mapaAux.put("fechaIni", Utiles.dameFechaSiguiente(fAux, 1) + " 00:00:00");
							    	mapaAux.put("fechaFin", Utiles.timeToFecha(tFin) + " 00:00:00");
							    	mapaAux.put("usuario", usuario);
							    	//20100618
							    	mapaAux.put("codiPersProceso", codiPersProceso);
							    	//
							    	/*
									registrarTurnoConCruce(dbpool, 
											codPers, 
											bTurnoTrab.getTurno(), 
											Utiles.dameFechaSiguiente(fAux, 1) + " 00:00:00",
											Utiles.timeToFecha(tFin) + " 00:00:00", 
											codUO, 
											usuario);
									*/
									registrarTurnoConCruce(mapaAux);
									//FIN
								}
							}
							
/*							cmpLocal = turnoCMP.findByPrimaryKey(new T1270CMPPK(
									codPers, 
									bTurnoTrab.getTurno(),
									bTurnoTrab.getFechaIni()));
							
							Timestamp tFin = cmpLocal.getFfin();
							cmpLocal.remove(); 
							
							if (!tFin.before(Utiles.stringToTimestamp(fAux + " 00:00:00"))){
								
								registrarTurnoConCruce(dbpool, 
										codPers, 
										bTurnoTrab.getTurno(), 
										Utiles.dameFechaSiguiente(fAux, 1) + " 00:00:00",
										Utiles.timeToFecha(tFin) + " 00:00:00", 
										codUO, 
										usuario);
								
							}	*/						
						}
					}
				}

				//obtenemos la siguiente fecha de proceso
				if (Utiles.toYYYYMMDD(fAux).compareTo(fFin) >= 0) {
					fAux = fechaFin;
				}
				fReal = Utiles.dameFechaSiguiente(fAux, 1);
				fAct = Utiles.toYYYYMMDD(fReal);		
			}
		}
		catch(Exception e){
			log.error("Error en operativo del trabajador "+codPers+" : "+ e.getMessage(),e);
			//output.println("Error en operativo del trabajador "+codPers+" : "+ e.getMessage());						
			throw new IncompleteConversationalState(e.toString());
		}	
	}
	
	
	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public boolean verificaCruceTurnosTrabajador(ArrayList turnos,
			String turno, java.sql.Timestamp fIni, java.sql.Timestamp fFin,
			boolean modificar) throws RemoteException {

		boolean cruce = false;

		if (turnos != null && turnos.size() > 0) {
			for (int i = 0; i < turnos.size() && !cruce; i++) {

				BeanTurnoTrabajo turnoTrab = (BeanTurnoTrabajo) turnos.get(i);

				boolean comparar = true;
				if (modificar) {

					if (turnoTrab.getTurno().equals(turno)
							&& turnoTrab.getFechaIni().equals(fIni)) {
						comparar = false;
					}
				}

				if (comparar) {
					if (fIni.equals(turnoTrab.getFechaIni())
							|| fIni.equals(turnoTrab.getFechaFin())
							|| fFin.equals(turnoTrab.getFechaIni())
							|| fFin.equals(turnoTrab.getFechaFin())
							|| (fFin.after(turnoTrab.getFechaIni()) && fFin
									.before(turnoTrab.getFechaFin()))
							|| (fIni.after(turnoTrab.getFechaIni()) && fIni
									.before(turnoTrab.getFechaFin()))
							|| (fIni.after(turnoTrab.getFechaIni()) && fFin
									.before(turnoTrab.getFechaFin()))
							|| (fIni.before(turnoTrab.getFechaIni()) && fFin
									.after(turnoTrab.getFechaFin()))) {
						cruce = true;
					}
				}
			}
		}
		return cruce;
	}

	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public String generarVacaciones(HashMap mapa, String usuario)
			throws RemoteException {

		String codPers = "";//ICAPUNAY 23072015 - PAS20155E230300073 - Habilitar Lic. Matrimonio CAS a cuenta 
		String res = Constantes.OK;
		String id = (String) mapa.get("messageID");
		String dbpool = (String) mapa.get("dbpool");
		try {
			CorreoDAO correoDAO = new CorreoDAO();
			T02DAO personalDAO = new T02DAO();

			super.creaLog(id, "PROCESO DE GENERACION DE SALDOS VACACIONALES",
					usuario);

			String anno = (String) mapa.get("anno");
			String criterio = (String) mapa.get("criterio");
			String valor = (String) mapa.get("valor");
			HashMap seguridad = (HashMap) mapa.get("seguridad");
			
			if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-anno: "+anno);//BORRAR
		    if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-criterio: "+criterio);//BORRAR
		    if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-valor: "+valor);//BORRAR
		    if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-seguridad: "+seguridad);//BORRAR

			//T1272DAO resumenDAO = new T1272DAO();
			pe.gob.sunat.rrhh.asistencia.dao.T1272DAO t1272dao = new pe.gob.sunat.rrhh.asistencia.dao.T1272DAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dcsp"));

			//T1456DAO repDAO = new T1456DAO();
			//JRR - 10/05/2011
			T1456DAO repDAO = new T1456DAO(dbpool);
			pe.gob.sunat.rrhh.asistencia.dao.T1281DAO cabvacDAO = new pe.gob.sunat.rrhh.asistencia.dao.T1281DAO(dbpool);
			Map auxTrab = new HashMap();
			//
			
			T9437DAO saldovacDao=new T9437DAO(dbpool);
			T9446DAO saldovac_dDao=new T9446DAO(dbpool);
			
			T99DAO codigoDAO = new T99DAO();
						
			String diasLab = codigoDAO.findParamByCodTabCodigo(dbpool,Constantes.CODTAB_PARAMETROS_ASISTENCIA,Constantes.MIN_DIAS_LABORABLES);
			 if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-diasLab: "+diasLab);//BORRAR
			int minDiasLab = diasLab != null ? Integer.parseInt(diasLab) : 0;
			if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-minDiasLab: "+minDiasLab);//BORRAR
			
			String diasVaca = codigoDAO.findParamByCodTabCodigo(dbpool,Constantes.CODTAB_PARAMETROS_ASISTENCIA,Constantes.DIAS_VACACIONES);
			if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-diasVaca: "+diasVaca);//BORRAR
			int numDiasVaca = diasVaca != null ? Integer.parseInt(diasVaca) : 0;
			if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-numDiasVaca: "+numDiasVaca);//BORRAR
			
			String diasEnfermedad = codigoDAO.findParamByCodTabCodigo(dbpool,Constantes.CODTAB_PARAMETROS_ASISTENCIA,Constantes.DIAS_ENFERMEDAD);
			if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-diasEnfermedad: "+diasEnfermedad);//BORRAR
			int numDiasEnfermedad = diasEnfermedad != null ? Integer.parseInt(diasEnfermedad) : 0;
			if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-numDiasEnfermedad: "+numDiasEnfermedad);//BORRAR
			
			T1281CMPHome cmpHome = (T1281CMPHome) ServiceLocator.getInstance().getLocalHome(T1281CMPHome.JNDI_NAME);					
			
			BeanFechaHora bfh = new BeanFechaHora();			
			int dAct = Integer.parseInt(bfh.getFormatDate("dd"));
			if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-dAct: "+dAct);//BORRAR
			int mAct = Integer.parseInt(bfh.getFormatDate("MM"));
			if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-mAct: "+mAct);//BORRAR
			int yAct = Integer.parseInt(bfh.getFormatDate("yyyy"));
			if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-yAct: "+yAct);//BORRAR
			String fActual = Utiles.obtenerFechaActual();
			if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-fActual: "+fActual);//BORRAR
			String fIni = Utiles.dameFechaAnhoAnterior(fActual, 1);
			if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-fIni: "+fIni);//BORRAR
					
			//obtenemos una lista de todos los trabajadores q hayan ingresado
			// antes del ultimo ano o hayan sido reincorporados
/*			ArrayList lista = repDAO.findByFIngFRepuesto(dbpool, criterio,
					valor, anno, fIni, seguridad);*/
			
			//JRR - 09/05/2011
			Map params = new HashMap();
			params.put("criterio", criterio);
			params.put("valor", valor);
			params.put("anno", anno);
			params.put("fIni", fIni);
			params.put("seguridad", seguridad);
			//JRR - 31/05/2011
			params.put("regimen", (mapa.get("regimen")!=null?mapa.get("regimen"):""));
			if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-params: "+params);//BORRAR
			
			List lista = repDAO.findByFIngFRepuesto(params);
			if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-lista: "+lista);//BORRAR
			//
			
			if (log.isDebugEnabled()) log.debug("ANNO : " + anno);
			T1281CMPLocal cmpLocal = null;
			HashMap trab = null;
			BeanFechaHora bfh2 = null;
			
			String fecha = "";
			String codPersAnte = "";
			Map mapTrabajador = new HashMap();
			FechaBean fbIng = null;
			String fechaIniProy = "";
			String fIniProy = "";
			String fFinProy = "";
			int yTrabAnte = 0;
			int dTrab = 0;
			int mTrab = 0;
			int yTrab = Integer.parseInt(anno);
			if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-yTrab: "+yTrab);//BORRAR
			int yIng = 0;
			
			if (log.isDebugEnabled()) log.debug("LISTA : " + lista);
			if (lista != null) {		
				if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-lista.size(): "+lista.size());//BORRAR
				for (int i = 0; i < lista.size(); i++) {
					if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-lista.get("+i+"): "+lista.get(i));//BORRAR
					trab = (HashMap) lista.get(i);
					if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-trab: "+trab);//BORRAR
					if (log.isDebugEnabled()) log.debug("TRAB : " + trab);
					
					//JRR - 09/05/2011					
					trab.put("fecha", trab.get("f_repuesto")!= null?trab.get("f_repuesto").toString():trab.get("f_ingsun").toString());
					if (log.isDebugEnabled()) log.debug("fecha: " + trab.get("fecha"));
					//
					
					codPers = (String) trab.get("t02cod_pers");
					if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-codPers: "+codPers);//BORRAR
					fecha = trab.get("fecha").toString().trim();
					if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-fecha: "+fecha);//BORRAR
					
					//JRR - 15/01/2009
					yTrabAnte = yTrab - 1;
					if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-yTrabAnte: "+yTrabAnte);//BORRAR
					if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-fecha.substring(4, 10): "+fecha.substring(4, 10));//BORRAR
					fechaIniProy = yTrabAnte + fecha.substring(4, 10);
					if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-fechaIniProy: "+fechaIniProy);//BORRAR
					fbIng = new FechaBean(fechaIniProy, "yyyy-MM-dd");
					if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-fbIng: "+fbIng);//BORRAR
					//Mes y Dia de Ingreso proyectado a fecha de Inicio del Per칤odo vacacional
					fIniProy = fbIng.getFormatDate("yyyy/MM/dd");
					if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-fIniProy: "+fIniProy);//BORRAR
					//Mes y Dia de Ingreso proyectado a fecha de Fin del Per칤odo vacacional
					if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-fIniProy.substring(4, 10): "+fIniProy.substring(4, 10));//BORRAR
					fFinProy = anno + fIniProy.substring(4, 10);
					if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-fFinProy: "+fFinProy);//BORRAR					
					codPersAnte = (trab.get("t02cod_ante")!=null?trab.get("t02cod_ante").toString():"");
					if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-codPersAnte: "+codPersAnte);//BORRAR
					
					mapTrabajador.put("codPers", codPers);
					mapTrabajador.put("finicio", fIniProy);
					mapTrabajador.put("ffin", fFinProy);
					mapTrabajador.put("codPersAnte", codPersAnte);
					if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-mapTrabajador: "+mapTrabajador);//BORRAR
					//
					
					bfh2 = new BeanFechaHora(fecha,"yyyy-MM-dd");
					if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-bfh2: "+bfh2);//BORRAR
					dTrab = Integer.parseInt(bfh2.getFormatDate("dd"));
					if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-dTrab: "+dTrab);//BORRAR
					mTrab = Integer.parseInt(bfh2.getFormatDate("MM"));
					if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-mTrab: "+mTrab);//BORRAR
					//int yTrab = Integer.parseInt(anno);
					yIng = Integer.parseInt(bfh2.getFormatDate("yyyy"));
					if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-yIng: "+yIng);//BORRAR
					
					if (log.isDebugEnabled()) {
						log.debug("DTRAB : " + dTrab);
						log.debug("MTRAB : " + mTrab);
						log.debug("YTRAB : " + yTrab);
						log.debug("DACT : " + dAct);
						log.debug("MACT : " + mAct);
						log.debug("YACT : " + yAct);
					}
					
					//ICAPUNAY 21/06/2011 FORMATIVAS-PARTEII comentando					
					if(trab.get("t02cod_rel")!=null && trab.get("t02cod_rel").equals("10")){//#2: El caso de los Foramtivos			
						
						
						OracleModFormativasDAO formativasDAO = new OracleModFormativasDAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dcsig"));			
						String creaSaldoFormativas="";
						String fecIniFormativas = (String) mapa.get("fecIniFormativas");
						String fecFinFormativas = (String) mapa.get("fecFinFormativas");
						if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-fecIniFormativas: "+fecIniFormativas);//BORRAR
					    if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-fecFinFormativas: "+fecFinFormativas);//BORRAR						
					    
						auxTrab.put("cod_pers", codPers);
						auxTrab.put("anno", anno);
						creaSaldoFormativas="";
						if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-auxTrab: "+auxTrab);//BORRAR

						if (cabvacDAO.findAllColumnsByKey(auxTrab)==null) {
							creaSaldoFormativas = formativasDAO.registrarSaldoVacacionalModFormativas(fecIniFormativas,fecFinFormativas,codPers);//ICAPUNAY 21/06/2011 FORMATIVAS
							if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-creaSaldoFormativas: "+creaSaldoFormativas);//BORRAR
							
							if(creaSaldoFormativas!=null){
								if ("1".equals(creaSaldoFormativas)) {
									auxTrab.put("dias", new Integer(15));
									auxTrab.put("saldo", new Integer(15));
									auxTrab.put("saldo_temp", new Integer(0));
									auxTrab.put("cuser_crea", usuario);
									auxTrab.put("fcreacion", new Timestamp(System.currentTimeMillis()));
									if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-auxTrab: "+auxTrab);//BORRAR
									cabvacDAO.insertarCabVacacion(auxTrab);
									if (log.isDebugEnabled()) log.debug("SE REGISTRO SALDO PARA MOD FORM: " + codPers);
									
									//dtarazona ajuste - 08/05/2018
									//DataSource dsSecuence= sl.getDataSource("java:/comp/env/jdbc/dcbdseq");
									int Secuencia = 0;
									//Secuencia = new SequenceDAO().getSequence(dsSecuence,"SET9395");
									auxTrab.put("secuencia",new Integer(Secuencia));
									auxTrab.put("ind_saldovac","1");
									auxTrab.put("ind_del","0");
									//saldovacDao.insertDetalleSaldoVacacional(auxTrab);
									//fin dtarazona
									
									// env癌 de correo
									String nombres = personalDAO.findNombreCompletoByCodPers(dbpool, codPers);
									Correo correo = new Correo(Utiles.textoCorreoNotificacionSaldoVacacional(nombres, auxTrab.get("dias").toString(), auxTrab.get("anno").toString()));
									correo.agregarDestinatario(correoDAO.findCorreoByCodPers(dbpool, codPers));
									correo.setAsunto("Saldo Vacacional");
									correo.enviarHtml();
								}
							}
							
						}
					}
					else //FIN ICAPUNAY 21/06/2011 FORMATIVAS-PARTEII						
					{
						if ( (mTrab<mAct && yIng < yTrab) || (mTrab==mAct && dTrab<=dAct && yIng < yTrab) || (yTrab<yAct && yIng < yTrab)){
							
							
							//JRR - 10/05/2011
							if (trab.get("t02cod_rel")!=null && trab.get("t02cod_rel").equals("09")) {//#1: El caso de los CAS
								
								auxTrab.put("cod_pers", codPers);
								auxTrab.put("anno", anno);
								if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-auxTrab: "+auxTrab);//BORRAR
								
								Map cabVacacion = cabvacDAO.findAllColumnsByKey(auxTrab); //ICAPUNAY 23072015 - PAS20155E230300073 - Habilitar Lic. Matrimonio CAS a cuenta 
								if(log.isDebugEnabled()) log.debug("cabVacacion CAS:"+ cabVacacion);
								
								if (cabVacacion==null) { //ICAPUNAY 23072015 - PAS20155E230300073 - Habilitar Lic. Matrimonio CAS a cuenta
								//if (cabvacDAO.findAllColumnsByKey(auxTrab)==null) { //ICAPUNAY 23072015 - PAS20155E230300073 - Habilitar Lic. Matrimonio CAS a cuenta
																
									DataSource dcsp=ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dcsp");
									pe.gob.sunat.rrhh.dao.T99DAO t99dao=new pe.gob.sunat.rrhh.dao.T99DAO(dcsp);
						        	ParamBean prmNumDias = t99dao.buscar(new String []{"510"}, dcsp, "01");//parametro de cantidad de d涌 de vacaciones
									if(log.isDebugEnabled()) log.debug("prmNumDias : Cantidad de dias :"+ prmNumDias.getDescripcion()+", D涌:" + prmNumDias.getDescripcionCorta());
									//auxTrab.put("dias", new Integer(15));
									//auxTrab.put("saldo", new Integer(15));
									auxTrab.put("dias", new Integer(Integer.parseInt(prmNumDias.getDescripcion()))); //AMVS-09-2012 
									auxTrab.put("saldo", new Integer(Integer.parseInt(prmNumDias.getDescripcion()))); //AMVS-09-2012
									auxTrab.put("saldo_temp", new Integer(0));
									auxTrab.put("cuser_crea", usuario);
									auxTrab.put("fcreacion", new Timestamp(System.currentTimeMillis()));
									if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-auxTrab: "+auxTrab);//BORRAR
									cabvacDAO.insertarCabVacacion(auxTrab);
									if (log.isDebugEnabled()) log.debug("SE REGISTRO SALDO PARA TRAB CAS: " + codPers);
									
									//dtarazona - ajuste 08/05/2018
									//DataSource dsSecuence= sl.getDataSource("java:/comp/env/jdbc/dcbdseq");
									int Secuencia = 0;
									//Secuencia = new SequenceDAO().getSequence(dsSecuence,"SET9395");
									auxTrab.put("secuencia",new Integer(Secuencia));
									auxTrab.put("ind_saldovac","1");
									auxTrab.put("ind_del","0");
									//saldovacDao.insertDetalleSaldoVacacional(auxTrab);
									//fin dtarazona
									
									// env癌 de correo
									String nombres = personalDAO.findNombreCompletoByCodPers(dbpool, codPers);
									Correo correo = new Correo(Utiles.textoCorreoNotificacionSaldoVacacional(nombres, auxTrab.get("dias").toString(), auxTrab.get("anno").toString()));
									correo.agregarDestinatario(correoDAO.findCorreoByCodPers(dbpool, codPers));
									correo.setAsunto("Saldo Vacacional");
									correo.enviarHtml();
								}
								//ICAPUNAY 23072015 - PAS20155E230300073 - Habilitar Lic. Matrimonio CAS a cuenta 
								else {
									Map columns= new HashMap();
									columns.put("dias", new Integer(Integer.parseInt(cabVacacion.get("dias")+"") + 30  ));  
									columns.put("saldo", new Integer(Integer.parseInt(cabVacacion.get("saldo")+"") + 30  ));
									columns.put("cuser_mod",usuario);
						  		    columns.put("fmod",new Timestamp(System.currentTimeMillis()));
						  		    if (log.isDebugEnabled()) log.debug("columns CAS: " + columns);
						  		    auxTrab.put("columns", columns);
									cabvacDAO.updateCustomColumns(auxTrab);
									
									if (log.isDebugEnabled()) log.debug("SE ACTUALIZO SALDO PARA TRAB CAS: " + codPers);
								}
								//FIN ICAPUNAY 23072015 - PAS20155E230300073 - Habilitar Lic. Matrimonio CAS a cuenta 

							} 
								/*ICAPUNAY 21/06/2011 FORMATIVAS-PARTEII
								else if (trab.get("t02cod_rel")!=null && trab.get("t02cod_rel").equals("10")){//#2: El caso de Modalidad Formativa
								//JRR - 27/05/2011 - A pesar de ser similares, lo separamos por temas de futuros mantenimientos
								
								//ICAPUNAY 21/06/2011 FORMATIVAS-PARTEII			
								OracleModFormativasDAO formativasDAO = new OracleModFormativasDAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dcsig"));			
								String creaSaldoFormativas="";
								String fecIniFormativas = (String) mapa.get("fecIniFormativas");
								String fecFinFormativas = (String) mapa.get("fecFinFormativas");
								if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-fecIniFormativas: "+fecIniFormativas);//BORRAR
							    if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-fecFinFormativas: "+fecFinFormativas);//BORRAR
								//FIN ICAPUNAY 21/06/2011 FORMATIVAS-PARTEII
							    
								auxTrab.put("cod_pers", codPers);
								auxTrab.put("anno", anno);
								creaSaldoFormativas="";//ICAPUNAY 21/06/2011 FORMATIVAS-PARTEII
								if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-auxTrab: "+auxTrab);//BORRAR

								if (cabvacDAO.findAllColumnsByKey(auxTrab)==null) {
									creaSaldoFormativas = formativasDAO.registrarSaldoVacacionalModFormativas(fecIniFormativas,fecFinFormativas,codPers);//ICAPUNAY 21/06/2011 FORMATIVAS
									if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-creaSaldoFormativas: "+creaSaldoFormativas);//BORRAR
									if ("1".equals(creaSaldoFormativas)) {//ICAPUNAY 21/06/2011 FORMATIVAS-PARTEII

										auxTrab.put("dias", new Integer(15));
										auxTrab.put("saldo", new Integer(15));
										auxTrab.put("saldo_temp", new Integer(0));
										auxTrab.put("cuser_crea", usuario);
										auxTrab.put("fcreacion", new Timestamp(System.currentTimeMillis()));
										if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-auxTrab: "+auxTrab);//BORRAR
										cabvacDAO.insertarCabVacacion(auxTrab);
										
										if (log.isDebugEnabled()) log.debug("SE REGISTRO SALDO PARA MOD FORM: " + codPers);
									}
								}								

								} FIN ICAPUNAY 21/06/2011 FORMATIVAS-PARTEII */
								else {//#3: El caso normal de Nombrados y Contratados
								
								//output.print("Trabajador : " + codPers + " - Fecha Ingreso : "+fecha);
								if (log.isDebugEnabled()) log.debug("Trabajador : " + codPers + " - Fecha Ingreso : "+fecha); 
								if (log.isDebugEnabled()) log.debug("Rango a considerar - fIniProy: " + fIniProy + " fFinProy: " + fFinProy);

								if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-mapTrabajador: "+mapTrabajador);//BORRAR
								//aqui debemos verificar si cumple con la condicion de dias laborables
								int diasLaborables = t1272dao.findDiasLaborablesByFiniFin(mapTrabajador);
								
								int diasInasistLicDesc=t1272dao.findDiasInasistLicDescByFiniFin(mapTrabajador);// dtarazona
								if (log.isDebugEnabled()) log.debug("Dias Inasist y lic desc: "+diasInasistLicDesc);
								int diasLabAlm=diasLaborables+diasInasistLicDesc;//dtarazona
								if (log.isDebugEnabled()) log.debug("Dias Laborables: "+diasLaborables);
								
								//dtarazona
								ArrayList ListaDiasLaborables=(ArrayList)t1272dao.findListDiasLaborablesByFiniFfin(mapTrabajador);
								ArrayList ListaDiasDescontables=(ArrayList)t1272dao.findListDiasDescontablesByFiniFfin(mapTrabajador);
								ArrayList ListaDiasEnfermedad=(ArrayList)t1272dao.findListDiasEnfermedadByFiniFfin(mapTrabajador);
								log.debug("Listas:"+ListaDiasLaborables);
								//dtarazona
								
								int diasLicEnferm = t1272dao.findDiasEnfermedadByFiniFin(mapTrabajador);
								//int diasLicEnferm = resumenDAO.findDiasEnfermedadByFiniFin(dbpool, codPers, fIni, fActual);
								if (log.isDebugEnabled()) log.debug("Dias Licencia Enfermedad: "+diasLicEnferm);
								int diasLicEnfAlm=diasLicEnferm>numDiasEnfermedad ? (diasLicEnferm-numDiasEnfermedad) : 0;//dtarazona
								//decrementamos el exceso de dias con licencia por enfermedad
								diasLaborables -= (diasLicEnferm>numDiasEnfermedad ? (diasLicEnferm-numDiasEnfermedad) : 0);
								if (log.isDebugEnabled()) log.debug("Dias Laborables Total: "+diasLaborables);
								if (log.isDebugEnabled()) log.debug("Minimos dias de Labor: "+minDiasLab);
								
								super.escribe("Total de d칤as de labor efectiva para el trabajador " + codPers + ": " + diasLaborables + " d칤as.", "SALDO VACACIONAL", mapa, usuario);
								
								String generoSaldo="0";
								//JRR 25/09/2008 - Para controlar 210 dias
								if ( (diasLaborables >= minDiasLab) && ( yIng < yTrab )){
									
									if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-(diasLaborables >= minDiasLab): "+(diasLaborables >= minDiasLab));//BORRAR
									if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-( yIng < yTrab ): "+( yIng < yTrab ));//BORRAR
									/*try{
										log.debug("Entrando al try");
										cmpLocal = cmpHome.findByPrimaryKey(new T1281CMPPK(codPers,anno));
										
										int saldo_temp = cmpLocal.getSaldoTemp().intValue();
										if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-saldo_temp: "+saldo_temp);//BORRAR
										
										cmpLocal.setDias(new Integer(numDiasVaca));
										if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-cmpLocal.getDias(): "+cmpLocal.getDias().intValue());//BORRAR
										cmpLocal.setSaldo(new Integer(numDiasVaca-saldo_temp));
										if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-cmpLocal.getSaldo(): "+cmpLocal.getSaldo().intValue());//BORRAR
										cmpLocal.setSaldoTemp(new Integer(0));
										if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-cmpLocal.getSaldoTemp(): "+cmpLocal.getSaldoTemp().intValue());//BORRAR
										cmpLocal.setCuserMod(usuario);
										if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-cmpLocal.getCuserMod(): "+cmpLocal.getCuserMod());//BORRAR
										cmpLocal.setFmod(new Timestamp(System.currentTimeMillis()));
										if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-cmpLocal.getFmod(): "+cmpLocal.getFmod());//BORRAR
										
									}
									catch(Exception e){
										log.debug("Entrando Cath");
										
										
										cmpLocal = cmpHome.create(codPers,anno);
										cmpLocal.setDias(new Integer(numDiasVaca));
										cmpLocal.setSaldo(new Integer(numDiasVaca));
										cmpLocal.setSaldoTemp(new Integer(0));
										cmpLocal.setCuserCrea(usuario);
										cmpLocal.setFcreacion(new Timestamp(System.currentTimeMillis()));
										
										// env癌 de correo
										String nombres = personalDAO.findNombreCompletoByCodPers(dbpool, codPers);
										Correo correo = new Correo(Utiles.textoCorreoNotificacionSaldoVacacional(nombres, cmpLocal.getDias().toString(), cmpLocal.getAnno()));
										correo.agregarDestinatario(correoDAO.findCorreoByCodPers(dbpool, codPers));
										correo.setAsunto("Saldo Vacacional");
										correo.enviarHtml();
									}
									
									//generamos el saldo de vacaciones
									/*boolean result = vacDAO.insertByCodPersAnno(dbpool,
											codPers, anno, numDiasVaca, usuario);*/
									
									//Finalmente actualizamos el saldo si existe adelanto de vacaciones
									auxTrab=new HashMap();
									auxTrab.put("cod_pers", codPers);
									auxTrab.put("anno", anno);
									Map cabVacacion = cabvacDAO.findAllColumnsByKey(auxTrab); //ICAPUNAY 23072015 - PAS20155E230300073 - Habilitar Lic. Matrimonio CAS a cuenta
									
										if(log.isDebugEnabled()) log.debug("cabVacacion planilla:"+ cabVacacion);
										if (cabVacacion==null) {
											auxTrab.put("dias", new Integer(numDiasVaca)); //Nmero de d眼s 0 
											auxTrab.put("saldo", new Integer(numDiasVaca)); //Saldo negativo
											auxTrab.put("saldo_temp", new Integer(0));
											auxTrab.put("cuser_crea", usuario);
											auxTrab.put("fcreacion", new Timestamp(System.currentTimeMillis()));
											if(log.isDebugEnabled()) log.debug("**** ProcesoFacade-generarVacaciones-auxTrab: "+auxTrab);//BORRAR
											cabvacDAO.insertarCabVacacion(auxTrab);
										}else{
											Map columns= new HashMap();
											columns.put("dias", new Integer(numDiasVaca));  
											columns.put("saldo", new Integer(Integer.parseInt(cabVacacion.get("saldo")+"") + numDiasVaca));
											columns.put("cuser_mod",usuario);
								  		    columns.put("fmod",new Timestamp(System.currentTimeMillis()));
								  		    if (log.isDebugEnabled()) log.debug("columns CAS: " + columns);
								  		    auxTrab.put("columns", columns);
											cabvacDAO.updateCustomColumns(auxTrab);
										}
										
										String nombres = personalDAO.findNombreCompletoByCodPers(dbpool, codPers);
										Correo correo = new Correo(Utiles.textoCorreoNotificacionSaldoVacacional(nombres, cmpLocal.getDias().toString(), cmpLocal.getAnno()));
										correo.agregarDestinatario(correoDAO.findCorreoByCodPers(dbpool, codPers));
										correo.setAsunto("Saldo Vacacional");
										correo.enviarHtml();
										
									if (log.isDebugEnabled()) log.debug("SE REGISTRO SALDO PARA TRABAJADOR: " + codPers);
									
									generoSaldo="1";
								}
									//dtarazona ajuste 08/05/2018
									//HashMap existeReg=(HashMap)saldovacDao.findByPK(codPers,anno);
									
									HashMap datosSaldo=new HashMap();
									datosSaldo.put("cod_pers", codPers);
									datosSaldo.put("anno", anno);
									datosSaldo.put("fec_saldovac",Utiles.stringToDate(Utiles.obtenerFechaActual().toString()));
									datosSaldo.put("dias", new Integer(diasLabAlm));//DiasLaborables
									datosSaldo.put("saldo", new Integer(diasInasistLicDesc));//DiasLicenciasDescontables
									datosSaldo.put("saldo_temp", new Integer(diasLicEnfAlm));//exceso de licencia por enfermedad
									datosSaldo.put("ind_saldovac",generoSaldo);
									datosSaldo.put("ind_del","0");
									datosSaldo.put("cuser_crea", usuario);
									datosSaldo.put("fcreacion", new Timestamp(System.currentTimeMillis()));
									//if(existeReg!=null){
									//}else{
										saldovacDao.insertDetalleSaldoVacacional(datosSaldo);
									//}
										
									int num_saldovac=saldovacDao.findMaxNumSerial();
									log.debug("MaximoSerial:"+num_saldovac);
									HashMap listaDias=new HashMap();
									listaDias.put("num_saldovac",new Integer(num_saldovac));
									listaDias.put("ind_del","0");
									listaDias.put("cuser_crea", usuario);
									listaDias.put("fcreacion", new Timestamp(System.currentTimeMillis()));
									if(diasLabAlm>0){
										listaDias.put("ind_saldovac_d","1");
										for(int k=0;k<ListaDiasLaborables.size();k++){
											HashMap dia=(HashMap)ListaDiasLaborables.get(k); 
											listaDias.put("fec_saldovac_d",dia.get("fecha"));
											saldovac_dDao.insertDiasSaldoVacacional(listaDias);
										}
									}
									if(diasInasistLicDesc>0){
										listaDias.put("ind_saldovac_d","2");
										for(int j=0;j<ListaDiasDescontables.size();j++){
											HashMap dia=(HashMap)ListaDiasDescontables.get(j);
											listaDias.put("fec_saldovac_d",dia.get("fecha"));		
											saldovac_dDao.insertDiasSaldoVacacional(listaDias);
										}
									}
									if(ListaDiasEnfermedad.size()>0){
										for(int l=0;l<ListaDiasEnfermedad.size();l++){
											if(l<numDiasEnfermedad)
											{
												listaDias.put("ind_saldovac_d","1");
											}else{
												listaDias.put("ind_saldovac_d","3");
											}
											HashMap dia=(HashMap)ListaDiasEnfermedad.get(l);
											listaDias.put("fec_saldovac_d",dia.get("fecha"));
											saldovac_dDao.insertDiasSaldoVacacional(listaDias);
										}	
									}									
									//fin dtarazona
															
								//output.println(" / Dias laborables acumulados : " + diasLaborables);								
							}//Fin de #3																			
						}//Fin condicional para cas y planilla						
					}//FIN NO ES FORMATIVO-ICAPUNAY 21/06/2011 FORMATIVAS-PARTEII
				}
			}					
		} catch (Exception e) {
			super.escribe("Error: " + e.getMessage() + " registro: "+codPers, "SALDO VACACIONAL", mapa, usuario); //ICAPUNAY 23072015 - PAS20155E230300073 - Habilitar Lic. Matrimonio CAS a cuenta
		
			log.error("Error(generarVacaciones): " + e.getMessage() + " con registro: "+codPers,e);
			//output.println("Error : " + e.toString());
		} finally {
			try {
				//registramos el log del proceso
				super.registraLog(dbpool, mapa, usuario);
			} catch (Exception e) {
			}
		}
		return res;
	}

	
	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="Required"
	 * 
	 */
	public String registrarTurnoConCruce(Map mapa)
			throws RemoteException {
	/*ASANCHEZZ 20100617 - CAMBIO EN EL LLAMADO
	public String registrarTurnoConCruce(
			String dbpool, 
			String codPers, 
			String turno,
			String fechaIni, 
			String fechaFin, 
			String codUO,
			String usuario)
			throws RemoteException {
	*/
		String res = Constantes.OK;

		//ASANCHEZZ 20100617
		String dbpool = (String)mapa.get("dbpool");
		String codPers = (String)mapa.get("valor");
		String turno = (String)mapa.get("turno");
		String fechaIni = (String)mapa.get("fechaIni");
		String fechaFin = (String)mapa.get("fechaFin");
		String obsSustento = (String)mapa.get("obsSustento");
		String codUO = (String)mapa.get("uorg");
		String usuario = (String)mapa.get("usuario");
		String codiPersProceso = (String)mapa.get("codiPersProceso");
		//FIN

		try {

			//output.println("Trabajador : " + codPers);
			
			String nvaFIni = "";
			String nvaFFin = "";

			//Listar los turnos con los que se cruza.
			T1270DAO daoTT = new T1270DAO();
			ArrayList listaTurnos = daoTT.joinWithT45ByCodFiniFfin(dbpool,
					codPers, Utiles.stringToTimestamp(fechaIni), Utiles
							.stringToTimestamp(fechaFin), 1);

//			T1270CMPHome cmpHome = (T1270CMPHome) ServiceLocator.getInstance().getLocalHome(T1270CMPHome.JNDI_NAME);
			BeanTurnoTrabajo tAnt = null; 
//			T1270CMPLocal cmpLocal = null;
//			JRR - 23/01/2009
			pe.gob.sunat.rrhh.asistencia.dao.T1270DAO t1270dao = new pe.gob.sunat.rrhh.asistencia.dao.T1270DAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dgsp"));
			FechaBean fecAct = new FechaBean();
			Map mturno = new HashMap();
			Map mdatos = new HashMap();
			//ASANCHEZZ 20100617
			mdatos.put("codiPersProceso", codiPersProceso);
			mdatos.put("obsSustento",obsSustento);
			//
			    
			if (listaTurnos != null && listaTurnos.size() > 0) {
				for (int i = 0; i < listaTurnos.size(); i++) {
					
					tAnt = (BeanTurnoTrabajo) listaTurnos.get(i);
					
					mdatos.put("cod_pers", tAnt.getCodPers());
					mdatos.put("turno", tAnt.getTurno());
					mdatos.put("fini", tAnt.getFechaIni());
					mturno = t1270dao.findTurnoPersonaByPK(mdatos);
					
					//Partir los turnos.
					if (tAnt.getFechaIni().before(Utiles.stringToTimestamp(fechaIni + " 00:00:00")) && 
					   (tAnt.getFechaFin().before(Utiles.stringToTimestamp(fechaFin+ " 00:00:00")) || 
					   	tAnt.getFechaFin().equals(Utiles.stringToTimestamp(fechaFin+ " 00:00:00")))){

						//Cruce izquierda cerramos el turno anterior el dia anterior del comienzo del turno nuevo
						nvaFFin = Utiles.dameFechaAnterior(fechaIni, 1);
						

						if (mturno!= null) {
							//estos 3 campos son para completar la sentencia
							mdatos.put("u_organ", mturno.get("u_organ"));
							mdatos.put("sonom_id", mturno.get("sonom_id"));
							mdatos.put("est_id", mturno.get("est_id"));
							mdatos.put("ffin", Utiles.stringToTimestamp(nvaFFin+ " 00:00:00"));
							mdatos.put("cuser_mod", usuario);
							mdatos.put("fmod", fecAct.getTimestamp());

							t1270dao.actualizarTurnoPersona(mdatos);
							
							generarRegAsistenciaPorCambioTurnoTrab(mdatos);
							registrarNovedadPorCambioTurnoTrab(mdatos);
						}
						
/*						cmpLocal = cmpHome
								.findByPrimaryKey(new T1270CMPPK(
										tAnt.getCodPers(), 
										tAnt.getTurno(),
										tAnt.getFechaIni()));

						cmpLocal.setFfin(Utiles.stringToTimestamp(nvaFFin+ " 00:00:00"));
						cmpLocal.setFmod(new Timestamp(System.currentTimeMillis()));
						cmpLocal.setCuserMod(usuario);*/
					} 
					else if ((tAnt.getFechaIni().after(Utiles.stringToTimestamp(fechaIni + " 00:00:00")) && 
							(tAnt.getFechaIni().before(Utiles.stringToTimestamp(fechaFin+ " 00:00:00")) || 
							 tAnt.getFechaIni().equals(Utiles.stringToTimestamp(fechaFin+ " 00:00:00")))) && 
							 tAnt.getFechaFin().after(Utiles.stringToTimestamp(fechaFin+ " 00:00:00")))
					{

						//modificamos el turno anterior justo para que empiece al dia sgte. de terminado el nuevo
						nvaFIni = Utiles.dameFechaSiguiente(fechaFin, 1);

						//Desactivamos el turno anterior
						//Creamos un turno con la nueva fecha de inicio
						
						if (mturno!= null) t1270dao.eliminarTurnoPersona(mdatos);
						
						mdatos.put("u_organ", tAnt.getCodUOrg());
						mdatos.put("fini", Utiles.stringToTimestamp(nvaFIni + " 00:00:00"));
						mdatos.put("ffin", tAnt.getFechaFin());
						mdatos.put("est_id", Constantes.ACTIVO);
						mdatos.put("sonom_id", "");
						mdatos.put("cuser_crea", usuario);
						mdatos.put("fcreacion", fecAct.getTimestamp());
						t1270dao.registrarTurnoPersona(mdatos);
						
						generarRegAsistenciaPorCambioTurnoTrab(mdatos);
						registrarNovedadPorCambioTurnoTrab(mdatos);
						
/*						cmpLocal = cmpHome.findByPrimaryKey(new T1270CMPPK(
										tAnt.getCodPers(), 
										tAnt.getTurno(),
										tAnt.getFechaIni()));

						//horasCompensa = cmpLocal.getHorasCompensa();
						
						//Desactivamos el turno anterior
						cmpLocal.remove();						

						//Creamos un turno con la nueva fecha de inicio
						cmpHome.create(tAnt.getCodPers(), tAnt
								.getCodUOrg(), tAnt.getTurno(), Utiles
								.stringToTimestamp(nvaFIni + " 00:00:00"), tAnt
								.getFechaFin(), Constantes.ACTIVO,
								new Timestamp(System.currentTimeMillis()),
								usuario);*/

					} 
					else if ((tAnt.getFechaIni().after(Utiles.stringToTimestamp(fechaIni + " 00:00:00")) || 
							  tAnt.getFechaIni().equals(Utiles.stringToTimestamp(fechaIni+ " 00:00:00")))
							&& (tAnt.getFechaFin().before(Utiles.stringToTimestamp(fechaFin+ " 00:00:00")) || 
								tAnt.getFechaFin().equals(Utiles.stringToTimestamp(fechaFin+ " 00:00:00")))) 
					{

						if (mturno!= null) t1270dao.eliminarTurnoPersona(mdatos);
						//Desactivamos el turno anterior
						
/*						cmpLocal = cmpHome.findByPrimaryKey(new T1270CMPPK(
										tAnt.getCodPers(), 
										tAnt.getTurno(),
										tAnt.getFechaIni()));

						//Desactivamos el turno anterior
						cmpLocal.remove();*/

					} else {
						//Abarcado por...
						if (tAnt.getFechaFin().equals(Utiles.stringToTimestamp(fechaFin+ " 00:00:00"))) {
						
							//Fecha de fin igual a la fecha de inicio
							nvaFFin = Utiles.dameFechaAnterior(fechaIni, 1);
							
							if (mturno!= null) {
								mdatos.put("u_organ", mturno.get("u_organ"));
								mdatos.put("sonom_id", mturno.get("sonom_id"));
								mdatos.put("est_id", mturno.get("est_id"));
								mdatos.put("ffin", Utiles.stringToTimestamp(nvaFFin+ " 00:00:00"));
								mdatos.put("cuser_mod", usuario);
								mdatos.put("fmod", fecAct.getTimestamp());

								t1270dao.actualizarTurnoPersona(mdatos);
								
								generarRegAsistenciaPorCambioTurnoTrab(mdatos);
								registrarNovedadPorCambioTurnoTrab(mdatos);
							}
							

/*							cmpLocal = cmpHome.findByPrimaryKey(new T1270CMPPK(
											tAnt.getCodPers(), 
											tAnt.getTurno(),
											tAnt.getFechaIni()));

							cmpLocal.setFfin(Utiles.stringToTimestamp(nvaFFin
									+ " 00:00:00"));
							cmpLocal.setFmod(new Timestamp(System
									.currentTimeMillis()));
							cmpLocal.setCuserMod(usuario);*/

						} 
						else if (tAnt.getFechaIni().equals(Utiles.stringToTimestamp(fechaIni+ " 00:00:00"))) 
						{

							//Fecha de fin igual fecha de fin
							nvaFIni = Utiles.dameFechaSiguiente(fechaFin, 1);
							
							//Desactivamos el turno anterior
							//Creamos un turno con la nueva fecha de inicio
							
							if (mturno!= null) t1270dao.eliminarTurnoPersona(mdatos);
							
							mdatos.put("u_organ", tAnt.getCodUOrg());
							mdatos.put("fini", Utiles.stringToTimestamp(nvaFIni + " 00:00:00"));
							mdatos.put("ffin", tAnt.getFechaFin());
							mdatos.put("est_id", Constantes.ACTIVO);
							mdatos.put("sonom_id", "");
							mdatos.put("cuser_crea", usuario);
							mdatos.put("fcreacion", fecAct.getTimestamp());
							t1270dao.registrarTurnoPersona(mdatos);
							
							generarRegAsistenciaPorCambioTurnoTrab(mdatos);
							registrarNovedadPorCambioTurnoTrab(mdatos);
							
/*							cmpLocal = cmpHome.findByPrimaryKey(new T1270CMPPK(
											tAnt.getCodPers(), 
											tAnt.getTurno(),
											tAnt.getFechaIni()));

							//horasCompensa = cmpLocal.getHorasCompensa();
							
							//Desactivamos el turno anterior
							cmpLocal.remove();

							//Creamos un turno con la nueva fecha de inicio
							cmpHome.create(tAnt.getCodPers(), tAnt
									.getCodUOrg(), tAnt.getTurno(), Utiles
									.stringToTimestamp(nvaFIni + " 00:00:00"),
									tAnt.getFechaFin(), Constantes.ACTIVO,
									new Timestamp(System.currentTimeMillis()),
									usuario);*/

						} 
						else {

							//Ambos lados mayores a los extremos del nuevo turno
							nvaFFin = Utiles.dameFechaAnterior(fechaIni, 1);
							
							if (mturno!= null) {
								mdatos.put("u_organ", mturno.get("u_organ"));
								mdatos.put("sonom_id", mturno.get("sonom_id"));
								mdatos.put("est_id", mturno.get("est_id"));
								mdatos.put("ffin", Utiles.stringToTimestamp(nvaFFin+ " 00:00:00"));
								mdatos.put("cuser_mod", usuario);
								mdatos.put("fmod", fecAct.getTimestamp());

								t1270dao.actualizarTurnoPersona(mdatos);
								
								generarRegAsistenciaPorCambioTurnoTrab(mdatos);
								registrarNovedadPorCambioTurnoTrab(mdatos);
							}
							
/*							cmpLocal = cmpHome.findByPrimaryKey(new T1270CMPPK(
											tAnt.getCodPers(), 
											tAnt.getTurno(),
											tAnt.getFechaIni()));
							cmpLocal.setFfin(Utiles.stringToTimestamp(nvaFFin+ " 00:00:00"));
							cmpLocal.setFmod(new Timestamp(System
									.currentTimeMillis()));
							cmpLocal.setCuserMod(usuario);   
							
							//horasCompensa = cmpLocal.getHorasCompensa();  */
							
							nvaFIni = Utiles.dameFechaSiguiente(fechaFin, 1);
							
							//Creamos un turno con la nueva fecha de inicio
							mdatos.put("u_organ", tAnt.getCodUOrg());
							mdatos.put("fini", Utiles.stringToTimestamp(nvaFIni + " 00:00:00"));
							mdatos.put("ffin", tAnt.getFechaFin());
							mdatos.put("est_id", Constantes.ACTIVO);
							mdatos.put("sonom_id", "");
							mdatos.put("cuser_crea", usuario);
							mdatos.put("fcreacion", fecAct.getTimestamp());
							mdatos.put("obsSustento",tAnt.getSustento());
							mdatos.put("modificar", "sustento");
							t1270dao.registrarTurnoPersona(mdatos);
							
							generarRegAsistenciaPorCambioTurnoTrab(mdatos);
							registrarNovedadPorCambioTurnoTrab(mdatos);

/*							//Creamos un turno con la nueva fecha de inicio
							cmpHome.create(
									tAnt.getCodPers(), 
									tAnt.getCodUOrg(), 
									tAnt.getTurno(), 
									Utiles.stringToTimestamp(nvaFIni + " 00:00:00"),
									tAnt.getFechaFin(), 
									Constantes.ACTIVO,
									new Timestamp(System.currentTimeMillis()),
									usuario);*/
						}
					}					
				}
			}

			mdatos.put("cod_pers", codPers);
			mdatos.put("turno", turno);
			mdatos.put("fini", Utiles.stringToTimestamp(fechaIni + " 00:00:00"));
			mdatos.put("u_organ", codUO);
			mdatos.put("ffin", Utiles.stringToTimestamp(fechaFin + " 00:00:00"));
			mdatos.put("est_id", Constantes.ACTIVO);
			mdatos.put("sonom_id", "");
			mdatos.put("cuser_crea", usuario);
			mdatos.put("fcreacion", fecAct.getTimestamp());
			mdatos.put("obsSustento",obsSustento);
			mdatos.put("modificar", "sustento");
			t1270dao.registrarTurnoPersona(mdatos);
			
			generarRegAsistenciaPorCambioTurnoTrab(mdatos);
			registrarNovedadPorCambioTurnoTrab(mdatos);
			
/*			cmpLocal = cmpHome.create(
					codPers,
					codUO,
					turno, 
					Utiles.stringToTimestamp(fechaIni + " 00:00:00"),
					Utiles.stringToTimestamp(fechaFin + " 00:00:00"),
					Constantes.ACTIVO,
					new Timestamp(System.currentTimeMillis()), 
					usuario);*/											
			
		} catch (Exception e) {
			log.error(e);			
			//output.println("Error : " + e.getMessage());
			res = "Error : " + e.getMessage();
		}
		return res;
	}
	
	/**
	 * Metodo encargado de obtener la lista de procesos
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @param dbpool
	 * @param codPers
	 * @return
	 * @throws RemoteException
	 */
	public ArrayList cargarLogProcesos(String dbpool, String codPers)
			throws RemoteException {

		ArrayList lista = null;
		try {
			T1481DAO t1481 = new T1481DAO();
			lista = t1481.findLogsByCodPers(dbpool, codPers, "0");
			//lista = this.findLogsByCodPers(dbpool, codPers, "0");
		} catch (Exception e) {
			log.error(e);
			throw new RemoteException(e.getMessage());
		}
		return lista;
	}

	/**
	 * Metodo encargado de descargar el log de un proceso
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported" 
	 * @param dbpool
	 * @param id
	 * @return
	 * @throws RemoteException
	 */
	public InputStream descargarLogProceso(String dbpool, String id)
			throws RemoteException {

		InputStream archivo;
		try {
			T1481DAO t1481 = new T1481DAO();
			archivo = t1481.findArchivoById(dbpool, id);
						
			//archivo = this.findArchivoById(dbpool, id);
		} catch (Exception e) {
			log.error(e);
			throw new RemoteException(e.getMessage());
		}
		return archivo;
	}
	
	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public void registrarLicencia(HashMap mapa, String usuario)
			throws RemoteException {

		String id = (String) mapa.get("messageID");
		String dbpool = (String) mapa.get("dbpool");
		try {

			super.creaLog(id, ((String)mapa.get("observacion")).toUpperCase(), usuario);

			String listaTrab = (String) mapa.get("trabajadores");
			StringTokenizer st = new StringTokenizer(listaTrab, "&");

			MantenimientoFacadeHome facadeMantHome = (MantenimientoFacadeHome) ServiceLocator.getInstance().getRemoteHome(
					MantenimientoFacadeHome.JNDI_NAME,
					MantenimientoFacadeHome.class);
			MantenimientoFacadeRemote facadeMantRemote = facadeMantHome.create();
			
			T1279DAO movDAO = new T1279DAO();
			HashMap tipoMov = movDAO.findByMov(dbpool, (String)mapa.get("tipoLicencia"));
			boolean bPeriodoCerrado = false;
			String fechaIni = (String)mapa.get("fechaIni");
			
			while (st.hasMoreTokens()) {

				String token = st.nextToken();

				StringTokenizer st2 = new StringTokenizer(token, "_");
				String codPers = st2.nextToken();
				String uo = st2.nextToken();				
				
				mapa.put("codTrab",codPers);
				mapa.put("codUO",uo);
				mapa.put("ind_dias",tipoMov.get("ind_dias"));

				bPeriodoCerrado = facadeMantRemote.periodoCerradoUOFecha(dbpool,fechaIni,Utiles.obtenerFechaActual(),uo);
				if (bPeriodoCerrado){				
					//output.println("El periodo ya se encuentra cerrado para la UO ".concat(uo).concat("."));
				}
				else{
					registrarLicenciaTrabajador(mapa);						
				}
			}

		} catch (Exception e) {
			log.error(e);			
		} finally {
			try {
				//registramos el log del proceso
				super.registraLog(dbpool, mapa, usuario);
			} catch (Exception e) {
			}
		}
	}	
	
	

	/**
	 * Metodo encargado de registrar la Licencia de un trabajador
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="RequiresNew"
	 * @param datos
	 * @return
	 * @throws RemoteException
	 */
	public String registrarLicenciaTrabajador(HashMap datos)
			throws IncompleteConversationalState, RemoteException {

		String res = Constantes.OK;		
		try {

			int numDias = 0;
			
			String dbpool = (String)datos.get("dbpool");
			String codPers = (String)datos.get("codTrab");
			String codUO = (String)datos.get("codUO");
			
			//output.println("Trabajador : " + codPers);
			
			String fechaIni = (String)datos.get("fechaIni");
			String fechaFin = (String)datos.get("fechaFin");
			String tipo = ((String)datos.get("tipoLicencia")).trim();
			String annoLicencia = (String)datos.get("annoLicencia");
			
			String ano_ref = (String)datos.get("ano_ref");
			String numero_ref = (String)datos.get("numero_ref");
			String area_ref = (String)datos.get("area_ref");
			
			String obs = (String)datos.get("obs");
			String certif = (String)datos.get("certif");
			String cmp = (String)datos.get("cmp");
			String tipoEnfermedad = (String)datos.get("tipoEnfermedad");
			String fechaCita = (String)datos.get("fechaCita");
			String fechaCompensa = (String)datos.get("fechaCompensa");
			//JRR
			String fechaFinCompensa = (datos.get("fechaFinCompensa")!=null?datos.get("fechaFinCompensa").toString():"");
			
			String usuario = (String)datos.get("usuario");
			
        	DataSource dsOracle = ServiceLocator.getInstance().getDataSource("java:comp/env/pool_oracle");
			
			T99DAO codigoDAO = new T99DAO();
			//prac-jcallo
			T1273DAO licenciaDAO = new T1273DAO(dbpool);
			T1282DAO vacacionDAO = new T1282DAO(dbpool);
			T1276DAO periodoDAO = new T1276DAO();
			String periodoActual = (periodoDAO.findPeriodoActual(dbpool)).getPeriodo();
			T1281DAO dao = new T1281DAO();
			
			// prac-aquispe
/*			Txx1DAO compensaDAO = new Txx1DAO(dbpool);
*/ 
			// fin-prac-aquispe
			
			if (tipo.trim().equalsIgnoreCase(Constantes.LICENCIA_TITULACION)) {
				int saldo = dao.findByCodPers(dbpool,codPers);
				if (saldo>0) {
					throw new Exception("El trabajador posee "+saldo+" d&iacute;as de saldo vacacional.");
				}
			}
			//prac-jcallo
			//T1273CMPHome cmpHome = (T1273CMPHome) ServiceLocator.getInstance().getLocalHome(T1273CMPHome.JNDI_NAME);

			AsistenciaFacadeHome asisHome = (AsistenciaFacadeHome) ServiceLocator
					.getInstance().getRemoteHome(
							AsistenciaFacadeHome.JNDI_NAME,
							AsistenciaFacadeHome.class);

			//AsistenciaFacadeHome asisHome = (AsistenciaFacadeHome) ServiceLocator.getInstance().getLocalHome(AsistenciaFacadeHome.JNDI_NAME);
			AsistenciaFacadeRemote asisRemote = asisHome.create();			
			//prac-jcallo
			Map prm = new HashMap();
			prm.put("cod_pers", codPers);
			prm.put("fechaIni", fechaIni);
			prm.put("fechaFin", fechaFin);
			if (log.isDebugEnabled()) log.debug("vacacionDAO.findByCodPersFIniFFin(prm)... prm"+prm);
			boolean bVacacion = vacacionDAO.findByCodPersFIniFFin(prm); //findByCodPersFIniFFin(dbpool,codPers, fechaIni, );
			if (!bVacacion) {
				//prac-jcallo
				Map prms = new HashMap();
				prms.put("cod_pers", codPers);
				prms.put("fecha1", fechaIni);
				prms.put("fecha2", fechaFin);
				prms.put("numero", "");
				if (log.isDebugEnabled()) log.debug("licenciaDAO.findByCodPersFIniFFin(prms)... prms:"+prms);
				boolean bLicencia = licenciaDAO.findByCodPersFIniFFin(prms);//(dbpool,codPers, fechaIni, fechaFin, "");

				if (!bLicencia) {
					pe.gob.sunat.sp.dao.T02DAO empleadoDAO = new pe.gob.sunat.sp.dao.T02DAO();		//jquispecoi
					Map mapaEmpleado = empleadoDAO.joinWithT12T99ByCodPers("java:comp/env/jdbc/dgsp",codPers, null);	
					String regimenCol = (mapaEmpleado!=null && !mapaEmpleado.isEmpty())?((String)mapaEmpleado.get("t02cod_rel")):"";
					
					if(tipo.equals(Constantes.LICENCIA_MATRIMONIO) && regimenCol.equals(Constantes.CODREL_REG1057)){	//matrimonio CAS
						log.debug("matrimonio datos: "+datos);
						
						/**1. El solicitante no debe tener licencia de matrimonio en seguimiento**/
						T1455DAO seguimientoDAO = new T1455DAO(dbpool);
						HashMap paramsSeguimiento = new HashMap();
						paramsSeguimiento.put("codPers", codPers);
						paramsSeguimiento.put("licencia", tipo);
						List seguimientos = seguimientoDAO.findSolicitudesByCodpersAndLicencia(paramsSeguimiento);
						log.debug("paramsSeguimiento: "+paramsSeguimiento);
						log.debug("seguimientos: "+seguimientos);
						HashMap seguimiento;					
						if(seguimientos!=null && seguimientos.size()>0){
							 seguimiento = (HashMap)seguimientos.get(0);
							 String estado = ((String)seguimiento.get("estado_id")).trim();
							 String anno = (String)seguimiento.get("anno");
							 Integer numero = (Integer)seguimiento.get("numero");
							 
							 if(estado.equals(Constantes.ESTADO_SEGUIMIENTO))
								 throw new Exception("El trabajador cuenta con una solicitud de licencia de matrimonio en seguimiento Nro. "+anno+"-"+numero+".");
						}
						
						/**6. El solicitante debe tener antig?edad mayor a 3 meses de su fecha de ingreso de no tener a la fecha ning?n a?acacional generado [sino ver el punto EX071 de excepciones].**/
						//6.1. Obtener fecha de ingreso
						SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yyyy");
						String strFechaIngreso  = (mapaEmpleado!=null && !mapaEmpleado.isEmpty())?((String)mapaEmpleado.get("t02f_ingsun")):null;
						
						//6.2. Obtener a?e trabajo
						String strFechaActual = Utiles.obtenerFechaActual();
						String strAnioActual = Utiles.dameAnho(strFechaActual);
						String strFechaCalculo = strFechaIngreso.substring(0, 6) + strAnioActual;
						String anioSaldoVacVig;
						int difDias = Utiles.obtenerDiasDiferencia(strFechaCalculo, strFechaActual);
						log.debug("difDias: "+difDias);
						if (difDias >= 0) 
							anioSaldoVacVig = strAnioActual;					
						else 
							anioSaldoVacVig = (Integer.parseInt(strAnioActual) - 1) + ""; 
						String annoVac = (Integer.parseInt(anioSaldoVacVig)+1)+"";
						//6.3 Restamos tres meses a la fecha actual
						//Date dteFechaActual = sdf.parse(strFechaActual);
						log.debug("anioSaldoVacVig: "+anioSaldoVacVig);
						log.debug("annoVac: "+annoVac);
						Date dteFechaIngresoTrunco = sdf.parse(strFechaIngreso.substring(0, 6)+anioSaldoVacVig);
						
						Date dteFechaInicio = sdf.parse(fechaIni);
						Calendar calFechaInicio = Calendar.getInstance();
						calFechaInicio.setTime(dteFechaInicio);
						calFechaInicio.add(Calendar.MONTH, -3);
						Date dteFechaInicioDisminuido = calFechaInicio.getTime();
						log.debug("dteFechaInicio: "+dteFechaInicio);
						log.debug("dteFechaInicioDisminuido: "+dteFechaInicioDisminuido);
						log.debug("dteFechaIngresoTrunco: "+dteFechaIngresoTrunco);
						
						String ddmmFecIngTrunco = new SimpleDateFormat("dd/MM/yyyy").format(dteFechaIngresoTrunco).toString().substring(0,6);//ICAPUNAY 23072015 - PAS20155E230300073 - Habilitar Lic. Matrimonio CAS a cuenta vacaciones (SC)
						String ddmmFecIniDismin = new SimpleDateFormat("dd/MM/yyyy").format(dteFechaInicioDisminuido).toString().substring(0,6);//ICAPUNAY 23072015 - PAS20155E230300073 - Habilitar Lic. Matrimonio CAS a cuenta vacaciones (SC)
						
						//if(dteFechaIngresoTrunco.after(dteFechaInicioDisminuido))	//ICAPUNAY 23072015 - PAS20155E230300073 - Habilitar Lic. Matrimonio CAS a cuenta vacaciones (SC)
						if(dteFechaIngresoTrunco.after(dteFechaInicioDisminuido) || ddmmFecIngTrunco.equals(ddmmFecIniDismin))	//ICAPUNAY 23072015 - PAS20155E230300073 - Habilitar Lic. Matrimonio CAS a cuenta vacaciones (SC)
							throw new Exception("Debe tener una antig?edad mayor a 3 meses de su fecha de ingreso o generaci?e saldo vacacional para esta licencia.");

						//7. La fecha de inicio de la solicitud debe ser menor a la pr?a fecha de generaci?d涌쪛 mes de fecha de ingreso) de saldo vacacional.
						int anioSaldoVacProx = Integer.parseInt(anioSaldoVacVig)+1;
						Date dteProxFechaGeneracion = sdf.parse(strFechaIngreso.substring(0, 6)+anioSaldoVacProx);
						Date dteFfin = Utiles.stringToDate(fechaFin);
						if(!dteFfin.before(dteProxFechaGeneracion))
							throw new Exception("La fecha fin de la solicitud debe ser menor a la pr?a fecha de generaci?e saldo vacacional (d涌쪛 mes correspondientes a la fecha de ingreso).");
						
						//8. Transacci?						
						VacacionFacadeHome facadeHome = (VacacionFacadeHome) ServiceLocator.getInstance().getRemoteHome(VacacionFacadeHome.JNDI_NAME, VacacionFacadeHome.class);
						VacacionFacadeRemote facadeRemote = facadeHome.create();
						numDias = Utiles.obtenerDiasDiferencia(fechaIni, fechaFin) + 1;
						HashMap prmVacacionMatrimonio = new HashMap();
						prmVacacionMatrimonio.put("codPers", codPers);
						prmVacacionMatrimonio.put("periodo", periodoActual);
						prmVacacionMatrimonio.put("annoVac", annoVac);
						prmVacacionMatrimonio.put("uorgan", codUO);
						prmVacacionMatrimonio.put("asunto", obs);
						prmVacacionMatrimonio.put("ffinicio", Utiles.stringToTimestamp(fechaIni + " 00:00:00"));
						prmVacacionMatrimonio.put("ffin", Utiles.stringToTimestamp(fechaFin + " 00:00:00"));
						prmVacacionMatrimonio.put("anno", null);
						//prmVacacionMatrimonio.put("uorgan", null);
						prmVacacionMatrimonio.put("numero", null);
						prmVacacionMatrimonio.put("dias", numDias+"");
						
						log.debug("prmVacacionMatrimonio: "+prmVacacionMatrimonio);
						List mensajes = facadeRemote.convertirEfectivaMatrimonio(dbpool, prmVacacionMatrimonio, usuario);
						
					}else{ //dem固맓icencias
					
					//si la validacion es por dias habiles
					if (((String)datos.get("ind_dias")).equals("1")) {
						numDias = asisRemote.obtenerDiasHabilesDiferencia(dbpool,fechaIni,fechaFin) + 1;
					}
					else{
						numDias = Utiles.obtenerDiasDiferencia(fechaIni, fechaFin) + 1;
					}
					if (log.isDebugEnabled()) log.debug("Dias Habiles ? "+datos.get("ind_dias"));
					if (log.isDebugEnabled()) log.debug("NumDias Diferencia : "+numDias);

					ArrayList params = codigoDAO.findByCodTab(dbpool, "0", tipo, Constantes.CODTAB_DIAS_LICENCIA);
					if (params != null && params.size() > 0) {

						// verificamos q el numero de dias coincida con algunos de los parametros de dia
						boolean existe = false;
						for (int i = 0; i < params.size() && !existe; i++) {
							BeanT99 p = (BeanT99) params.get(i);
							int dias = 0;
							try {
								dias = Integer.parseInt(p.getT99descrip().trim());
							} catch (Exception e) {
							}
							existe = dias == numDias;
						}
						if (!existe) {
							throw new Exception("El rango de fechas ingresado no corresponde a los parametros requeridos por la licencia.");
						}
					}

					
					/**************************************/					
					if (tipo.trim().equalsIgnoreCase(Constantes.LICENCIA_NACIMIENTO)) {
						
						//JRR - 20/11/2009 - Validacion de turno y dias habiles
						String fechaNac = fechaIni;
						pe.gob.sunat.rrhh.dao.T99DAO t99dao = new pe.gob.sunat.rrhh.dao.T99DAO(sl.getDataSource("java:comp/env/jdbc/dcsp"));

						T1270DAO tpDAO = new T1270DAO();
						BeanTurnoTrabajo turno = tpDAO.joinWithT45ByCodFecha(dbpool,codPers,fechaNac);

						int diasLicNac = 0;
						Map mapaT99 = new HashMap();
						Map dat = new HashMap();
						dat.put("t99cod_tab", constantes.leePropiedad("CODTAB_DIAS_LICENCIA"));
						dat.put("t99tip_desc", constantes.leePropiedad("T99DETALLE"));
						dat.put("t99estado", constantes.leePropiedad("ACTIVO"));
						dat.put("t99codigo", tipo);

						mapaT99 = t99dao.findParamByCodTabCodigo(dat);
						if (mapaT99 != null) 
							diasLicNac = Integer.parseInt(mapaT99.get("t99descrip").toString().trim()) - 1;						

						if (log.isDebugEnabled()) {
							log.debug("diasLicNac: " + diasLicNac);
							log.debug("turno: " + turno);
							log.debug("datos: " + datos);
						}

						/*if (turno!=null && !turno.isOperativo()){
							if (log.isDebugEnabled()) {
								log.debug("Turno es Administrativo");
								log.debug("Dias Habiles ? "+datos.get("ind_dias"));
								log.debug("NumDias Diferencia : "+numDias);
							}
						}else*/
						
						if (turno!=null && turno.isOperativo()) {
							int i = 0;
							String fechaAux = fechaNac;//Solo para inicializar
							boolean existeFecha;

							//Para los dem치s d칤as dependemos de que tenga turno o no
							while ((i<diasLicNac) && (Utiles.obtenerDiasDiferencia(fechaAux, fechaFin)>0)){
								existeFecha = false;
								for(int j=1;j<=diasLicNac;j++){
									fechaNac = fechaAux; //fechaAux cambia de valor cada pasada
									fechaAux = Utiles.dameFechaSiguiente(fechaNac, j);
									if (log.isDebugEnabled()) log.debug(j +" fechaAux: "+ fechaAux);
									turno = tpDAO.joinWithT45ByCodFecha(dbpool,codPers,fechaAux);
									if (turno!=null){
										existeFecha = true;
										if (log.isDebugEnabled()) log.debug("Salgo del for");
										break;
									}
								}

								if (existeFecha)
									i++;
								else {
									i=diasLicNac;
									throw new Exception("El trabajador no posee turno de trabajo entre los dias que abarcar칤a la licencia.");
								}
							}
							if (log.isDebugEnabled()) log.debug("fechaAux FINAL: " + fechaAux);
							//mapa.put("fechaFin", fechaAux);
							
							if (i<diasLicNac)
								throw new Exception("El trabajador no posee suficientes d칤as con turno en el intervalo ingresado como Per칤odo de Licencia");
							
						}

						else if (turno==null){
							throw new Exception("El trabajador no posee un turno de trabajo para la fecha solicitada.");
						}
						
					}
					//
					/**************************************/	
					
					
					//String periodoActual = (periodoDAO.findPeriodoActual(dbpool)).getPeriodo();//jquispecoi
					
					java.sql.Timestamp fLicI = Utiles.stringToTimestamp(fechaIni + " 00:00:00");
					java.sql.Timestamp fLicF = Utiles.stringToTimestamp(fechaFin + " 00:00:00");
					
					OracleSequenceDAO seqDAO = new OracleSequenceDAO();
					String numero = seqDAO.getSequenceDS(dsOracle,Constantes.SEQ_LICENCIA);
					
					if (tipo.trim().equalsIgnoreCase(Constantes.LICENCIA_ENFERMEDAD)) {
						annoLicencia = Utiles.dameAnho(fechaIni);
					}
					//prac-jcallo
					/*cmpHome.create(
							periodoActual, 
							annoLicencia, 
							new java.lang.Short(numero), 
							codUO, 
							fLicI, 
							fLicF,
							codPers, 
							numDias, 
							tipo, 
							ano_ref != null ? ano_ref.trim() : "",
							numero_ref != null ? (numero_ref.equals("") ? "0" : numero_ref.trim()) : "0",
							area_ref != null ? area_ref.trim() : "", 
							obs,
							new java.sql.Timestamp(System.currentTimeMillis()),
							usuario);*/
					//prac-jcallo
					Map dts = new HashMap();
					dts.put("periodo", periodoActual);
					dts.put("anno", annoLicencia);
					dts.put("numero", new Integer(numero));
					dts.put("u_organ", codUO);
					dts.put("ffinicio", fLicI);
					dts.put("ffin", fLicF);
					dts.put("cod_pers", codPers);
					dts.put("qdias", new Integer(numDias));
					dts.put("licencia", tipo);
					dts.put("anno_ref", ano_ref != null ? ano_ref.trim() : "");
					dts.put("numero_ref", ( numero_ref != null && !numero_ref.equals("") ) ? new Integer(numero_ref) : new Integer("0"));
					dts.put("area_ref", area_ref != null ? area_ref.trim() : "");
					dts.put("observ", obs);
					dts.put("fcreacion", new FechaBean().getTimestamp());
					dts.put("cuser_crea", usuario);//revisar todaviaaa
					if (log.isDebugEnabled()) log.debug("licenciaDAO.registrarLicenciaGeneral(dts)... dts:"+dts);
					licenciaDAO.registrarLicenciaGeneral(dts);

					//LICENCIA POR ENFERMEDAD 
					if (tipo.trim().equalsIgnoreCase(Constantes.LICENCIA_ENFERMEDAD)) {
						//prac-jcallo
						//T1274CMPHome medicaHome = (T1274CMPHome) ServiceLocator.getInstance().getLocalHome(T1274CMPHome.JNDI_NAME);

						/*medicaHome.create(
								codPers, tipo, periodoActual, annoLicencia,
								new java.lang.Short(numero), fLicI,
								fLicF, certif, cmp, 
								Utiles.stringToTimestamp(fechaCita+ " 00:00:00"), 
								tipoEnfermedad,
								new Timestamp(System.currentTimeMillis()),
								usuario);*/
						//prac-jcallo
						T1274DAO t1274dao = new T1274DAO(dbpool);
						//cod_pers, licencia, periodo, anno, numero, ffinicio, ffin, nvl(c_certific,'') as c_certific, nvl(cod_cmp,'') as cod_cmp, fecha, nvl(enfermedad,'') as enfermedad, fcreacion, cuser_crea
						Map dtoLicMe = new HashMap(); 
						dtoLicMe.put("cod_pers", codPers);
						dtoLicMe.put("licencia", tipo);
						dtoLicMe.put("periodo", periodoActual);
						dtoLicMe.put("anno", annoLicencia);
						dtoLicMe.put("numero", new Integer(numero));
						dtoLicMe.put("ffinicio", fLicI);
						dtoLicMe.put("ffin", fLicF);
						dtoLicMe.put("c_certific", certif);
						dtoLicMe.put("cod_cmp", cmp);
						dtoLicMe.put("fecha", Utiles.stringToTimestamp(fechaCita+ " 00:00:00"));
						dtoLicMe.put("enfermedad", tipoEnfermedad);
						dtoLicMe.put("fcreacion", new FechaBean().getTimestamp());
						dtoLicMe.put("cuser_crea", usuario);
						String codDiagnostico =" ";
						if (datos.containsKey("codDiagnostico")) {
							codDiagnostico=(String)datos.get("codDiagnostico");	
						}
						dtoLicMe.put("cod_cie10", codDiagnostico);
						 	
						//crear archivo
						int nroArchivos=0;
						if (datos.containsKey("numArchivo")) {
							int numArchivo =  Integer.parseInt(datos.get("numArchivo").toString());
							ArchivoFacadeHome facadeHome = (ArchivoFacadeHome) ServiceLocator.getInstance().getRemoteHome(ArchivoFacadeHome.JNDI_NAME,
									ArchivoFacadeHome.class);
							ArchivoFacadeRemote facadeRemote = facadeHome.create();
							
							ArchivoTmpFacadeHome facadeTmpHome = (ArchivoTmpFacadeHome) ServiceLocator.getInstance().getRemoteHome(ArchivoTmpFacadeHome.JNDI_NAME,
									ArchivoTmpFacadeHome.class);
							ArchivoTmpFacadeRemote facadeTmpRemote = facadeTmpHome.create();
							
							Map filtro = new HashMap();
							
							filtro.put("cod_estado", Constantes.SOL_REINTEGRO_ESTADO_ACTIVO);
							filtro.put("cod_usucrea", usuario);
							filtro.put("num_archivo", numArchivo +"");
							filtro.put("num_seqdoc", "0");
							filtro.put("ind_del", Constantes.EST_ARC_TEMP_OK);
							facadeTmpRemote.cambiarEstado("jdbc/dgsp", filtro, Constantes.EST_ARC_TEMP_COPIAR_PERMANENTE);
							 
							Map archivo = new HashMap();
							archivo.put("num_archivo", numArchivo+"");
							archivo.put("cod_estado", Constantes.SOL_REINTEGRO_ESTADO_ACTIVO);
							archivo.put("cod_usucrea",usuario);
							archivo.put("ind_del", Constantes.EST_ARC_TEMP_COPIAR_PERMANENTE);
							nroArchivos = facadeRemote.registrarEnPermanente("jdbc/dcsp", archivo); 
							
							archivo = new HashMap();
							archivo.put("num_archivo", numArchivo+"");
							facadeTmpRemote.eliminarArchivosTemporales("jdbc/dgsp", archivo);
							if(nroArchivos>0){
								dtoLicMe.put("num_archivo",  numArchivo+"");
							} else{
								dtoLicMe.put("num_archivo",  0+"");
							}
						} else{
							dtoLicMe.put("num_archivo",  0+"");
						}
							
							
						//insertando registro
						if (log.isDebugEnabled()) log.debug("t1274dao.insertarLicenciaMed(dtoLicMe)... dtoLicMe:"+dtoLicMe);
						t1274dao.insertarLicenciaMed(dtoLicMe);
					}
					
					//LICENCIAS COMPENSABLES
					if (log.isDebugEnabled()) log.debug(" Licencia "+ tipo);
					if ((tipo.trim().equalsIgnoreCase(Constantes.FERIADO_COMPENSABLE)) ||
						(tipo.trim().equalsIgnoreCase(Constantes.LICENCIA_ELECCIONES)) //||
						//(tipo.trim().equalsIgnoreCase(Constantes.LICENCIA_ONOMASTICO))
							)
					{

						TurnoTrabajoFacadeHome facadeHome = (TurnoTrabajoFacadeHome) ServiceLocator
						.getInstance().getRemoteHome(TurnoTrabajoFacadeHome.JNDI_NAME,
								TurnoTrabajoFacadeHome.class);
						TurnoTrabajoFacadeRemote turno = facadeHome.create();

						int diasComp = turno.calcularHorasCompensa(dbpool,
								codPers,
								Utiles.timeToFecha(fLicI), 
								Utiles.timeToFecha(fLicF));
						
						java.sql.Timestamp fLicC = Utiles.stringToTimestamp(fechaCompensa + " 00:00:00");
						HashMap mapa = new HashMap();
						mapa.put("dbpool",dbpool);
						mapa.put("codPers",codPers);
						mapa.put("codUO",codUO);
						mapa.put("fechaLic",Utiles.timeToFecha(fLicF));
						mapa.put("fechaGen",Utiles.obtenerFechaActual());
						mapa.put("diasComp",""+diasComp);
						mapa.put("horComp","1");
						mapa.put("usuario",usuario);
						mapa.put("fechaCompensa",Utiles.timeToFecha(fLicC));
						
						//JRR - 20/05/2009
						mapa.put("anno",annoLicencia);
						mapa.put("num_refer",new Integer(numero));
						
						try{
							//registramos los turnos de compensacion
							turno.registrarTurnoCompensa(mapa);
						} catch (Exception e) {
							//JRR - 28/05/2009
							if (log.isDebugEnabled()) log.debug("licenciaDAO.deleteByPrimaryKey(dts)... dts:"+dts);
							licenciaDAO.deleteByPrimaryKey(dts);	
							
							res = "No se crearon los registros de compensaci칩n."+e.toString().substring(e.toString().lastIndexOf(":")+1);
					    	super.escribe(res, "REGISTRO DE TURNOS DE TRABAJO", datos, usuario);
							
							throw new Exception("El trabajador no tiene Turno disponible para Compensar.");
						}
						
					} 

					
//JRR - FERIADOS COMPENSABLES - 21/10/2008					
					if (tipo.trim().equalsIgnoreCase(constantes.leePropiedad("LICENCIA_BOLSA"))) {
					
						Map mapa = new HashMap();
						mapa.put("cod_pers", codPers);
						mapa.put("periodo", periodoActual);
						mapa.put("dbpool", dbpool);
						mapa.put("fec_ini", new FechaBean(fechaCompensa).getSQLDate());
						mapa.put("fec_fin", new FechaBean(fechaFinCompensa).getSQLDate());  
						mapa.put("num_licencia", new Integer(numero));
						mapa.put("ind_estado", "0"); // 0: No Compensado
						//mapa.put("ind_tipo", "1"); //Bolsa - Por ahora no ir치, en un futuro podr칤a servir el campo						
						mapa.put("fec_creacion", new FechaBean().getTimestamp());
						mapa.put("cod_usucrea", usuario);
						if (log.isDebugEnabled()) log.debug("Mapa: " + mapa);

						T3792DAO compensaDAO = new T3792DAO(dbpool);

						int dias = Utiles.obtenerDiasDiferencia(fechaIni, fechaFin);
						/*Map map_fechas = new HashMap();
						map_fechas.put("fechaIni", fechaIni);
						map_fechas.put("fechaFin", fechaFin);
						int dias = obtenerDiferenciaDias(map_fechas);*/
						
						String fLic = fechaIni;
						if (log.isDebugEnabled()) log.debug("Dias de Licencia: " + dias);
						if (log.isDebugEnabled()) log.debug("Primera Fecha de la Licencia: " + fLic);

						T1270DAO tpDAO = new T1270DAO();
						
						for (int i = 0; i < dias + 1; i++) {
							mapa.put("fec_licencia", new FechaBean(fLic).getSQLDate());
							BeanTurnoTrabajo turnoTrab = tpDAO.joinWithT45ByCodFecha(dbpool, codPers, fLic);

							if (turnoTrab != null) {
								int horas = Math.round(Utiles.obtenerHorasDifDia(turnoTrab.getHoraIni(), turnoTrab.getHoraFin()));
								int total = 60 * horas;

								//JRR 23/12/2008 - Para que solo registre si tiene turno no operativo
								if (total > 0) {
									mapa.put("cnt_ttotal", new Integer(total));
									mapa.put("cnt_tsaldo", new Integer(total));

									if (log.isDebugEnabled()) log.debug("Mapa Compensacion: " + mapa);
									compensaDAO.registrarCompensacion(mapa);
								}
								
								fLic = Utiles.dameFechaSiguiente(fLic, 1);
								if (log.isDebugEnabled()) log.debug("Siguiente Fecha de Licencia: " + fLic);
							} else {
								throw new Exception("El trabajador no posee turno para la fecha de la licencia.");
							}
						}
					}		
//JRR - FIN DE IF LICENCIA TIPO 40
					

					}
				} else {
					throw new Exception("El trabajador ya posee una licencia durante esas fechas.");
				}
			} else {
				throw new Exception("El trabajador se encuentra de vacaciones durante esas fechas.");
			}

		} catch (Exception e) {
			res = e.getMessage();
			log.error(e);
			//output.println("Error : " + e.getMessage());
		}

		return res;
	}	
	
	
	/***************** PROCESO DE CIERRE *****************/
	
	/**
	 * Metodo encargado de realizar el cierre de Asistencia
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @param params
	 * @param usuario
	 * @return
	 * @throws RemoteException
	 */
	public void cerrarAsistencia(HashMap params, String usuario)
			throws RemoteException {
	    String id = (String) params.get("messageID");
		String dbpool = (String) params.get("dbpool");
		try {
			
			pe.gob.sunat.rrhh.asistencia.dao.T1272DAO t1272 = new pe.gob.sunat.rrhh.asistencia.dao.T1272DAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dcsp"));
			T72DAO t72dao = new T72DAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dgsp"));
			T1282DAO t1282 = new T1282DAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dcsp"));
			T1444DAO t1444 = new T1444DAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dcsp"));
			
			//t72dao.eliminarResumenCierre(params);
			//Eliminamos por concepto para minimizar riesgos en BD
			params.put("cod_concepto", "4032");
			t72dao.eliminarResumenCierreConcepto(params);
			params.put("cod_concepto", "4027");
			t72dao.eliminarResumenCierreConcepto(params);
			params.put("cod_concepto", "4028");
			t72dao.eliminarResumenCierreConcepto(params);
			params.put("cod_concepto", "4029");
			t72dao.eliminarResumenCierreConcepto(params);
			params.put("cod_concepto", "4030");
			t72dao.eliminarResumenCierreConcepto(params);
			params.put("cod_concepto", "4047");
			t72dao.eliminarResumenCierreConcepto(params);
			params.put("cod_concepto", "4061");
			t72dao.eliminarResumenCierreConcepto(params);
			params.put("cod_concepto", "1099");
			t72dao.eliminarResumenCierreConcepto(params);
			params.put("cod_concepto", "1113");
			t72dao.eliminarResumenCierreConcepto(params);
			params.put("cod_concepto", "1114");
			t72dao.eliminarResumenCierreConcepto(params);
			params.put("cod_concepto", "1116");
			t72dao.eliminarResumenCierreConcepto(params);
			params.put("cod_concepto", "1115");
			t72dao.eliminarResumenCierreConcepto(params);
			params.put("cod_concepto", "1164");
			t72dao.eliminarResumenCierreConcepto(params);
			params.put("cod_concepto", "1165");
			t72dao.eliminarResumenCierreConcepto(params);

			params.put("cod_concepto", "");
			
			
			List lista4032 = null;
			List lista4027 = null;
			List lista4028 = null;
			List lista4029 = null;
			List lista4030 = null;
			List lista4047 = null;
			List lista4061 = null;
			List lista1099 = null;
			List lista1113 = null;
			List lista1114 = null;
			List lista1116 = null;
			List lista1115 = null;
			List lista1164 = null;
			List lista1165 = null;
			
			Map datos = new HashMap();
			FechaBean dia = new FechaBean();
			String indMail = (String) params.get("indMail");
			String ind_estado = (String) params.get("ind_estado");
			
			T3792DAO compDAO = new T3792DAO(dbpool);
			Map aux_comp = new HashMap();
			List lista_compPend = new ArrayList();
			
			super.creaLog(id, "CIERRE DE ASISTENCIA", usuario);
			
			//LicenciaSinGoce
			lista4032 = t1272.findAcumulaResumenLicenciaSinGoce(params);
			lista1113 = t1444.findAcumulaResumenLicenciaSinGoce(params);
			
			//PermisoParticular
			params.put("mov", "05");
			lista4027 = t1272.findAcumulaResumenTipoConceptoDescuento(params);
			lista1114 = t1444.findAcumulaResumenTipoConceptoDescuento(params);
			
			//Inasistencia
			params.put("mov", "00");
			lista4028 = t1272.findAcumulaResumenConceptoDescuento(params);
			lista1116 = t1444.findAcumulaResumenConceptoDescuento(params);
			
			//Tardanza
			params.put("mov", "98");
			lista4029 = t1272.findAcumulaResumenConceptoDescuento(params);
			lista1115 = t1444.findAcumulaResumenConceptoDescuento(params);
			
			//SalidaNoAutorizada
			params.put("mov", "12");
			lista4030 = t1272.findAcumulaResumenConceptoDescuento(params);
			lista1164 = t1444.findAcumulaResumenConceptoDescuento(params);
			
			//ExcesoRefrigerio
			params.put("mov", "09");
			lista4047 = t1272.findAcumulaResumenConceptoDescuento(params);
			
			//SuspensionLabores
			params.put("mov", "008");
			lista4061 = t1272.findAcumulaResumenConceptoDescuento(params);
			lista1165 = t1444.findAcumulaResumenConceptoDescuento(params);

			//CompensacionVacacional
			lista1099 = t1282.findDiasCompensacionVacacional();
			
			
			//4032
			for(int i = 0; i<lista4032.size(); i++){
				datos = (Map)lista4032.get(i);
				
				if (log.isDebugEnabled()) log.debug("DATOS 1 - 4032 : "+ datos);
				
				String suma = datos.get("suma").toString();
				double acum = Double.parseDouble(suma);
				double acum_minutos = acum * 480;
				//String acumulado = acum_minutos + "";
 				
				datos.put("cod_anho", datos.get("periodo").toString().substring(0,4)); 
				datos.put("cod_mes", datos.get("periodo").toString().substring(4,6));
				datos.put("ind_tip_planil", "1");
				datos.put("cod_persona", datos.get("cod_pers"));
				datos.put("cod_anho_origen", datos.get("periodo").toString().substring(0,4));
				datos.put("cod_mes_origen", datos.get("periodo").toString().substring(4,6));
				datos.put("cod_concepto", "4032");
				datos.put("num_min_stma", new Double(acum_minutos));
				datos.put("num_min_mod",  new Double(acum_minutos)); 
				datos.put("num_dias", new Double(0));
				datos.put("ind_estado", ind_estado);
				datos.put("cod_usumodif", "");
				//datos.put("fec_modif", ""); 
				datos.put("cod_usucrea", usuario);
				datos.put("fec_creacion", dia.getSQLDate());
				datos.put("ind_tipo_carga", "A");
				datos.put("ind_devol", "0");
				
				if (log.isDebugEnabled()) log.debug("DATOS 2 : "+ datos);
				t72dao.registrarResumenCierre(datos);
			}
			
			//1113
			for(int i = 0; i<lista1113.size(); i++){
				datos = (Map)lista1113.get(i);
				
				if (log.isDebugEnabled()) log.debug("DATOS 1 - lista1113 : "+ datos);
				
				String suma = datos.get("suma").toString();
				double acum = Double.parseDouble(suma);
				double acum_minutos = acum * 480;
 				
				datos.put("cod_anho", datos.get("period_reg").toString().substring(0,4)); 
				datos.put("cod_mes", datos.get("period_reg").toString().substring(4,6));
				datos.put("ind_tip_planil", "1");
				datos.put("cod_persona", datos.get("cod_pers"));
				datos.put("cod_anho_origen", datos.get("periodo").toString().substring(0,4));
				datos.put("cod_mes_origen", datos.get("periodo").toString().substring(4,6));
				datos.put("cod_concepto", "1113");
				datos.put("num_min_stma", new Double(acum_minutos));
				datos.put("num_min_mod",  new Double(acum_minutos)); 
				datos.put("num_dias", new Double(0));
				datos.put("ind_estado", ind_estado);
				datos.put("cod_usumodif", "");
				//datos.put("fec_modif", ""); 
				datos.put("cod_usucrea", usuario);
				datos.put("fec_creacion", dia.getSQLDate());
				datos.put("ind_tipo_carga", "A");
				datos.put("ind_devol", "1");
				
				if (log.isDebugEnabled()) log.debug("DATOS 2 : "+ datos);
				t72dao.registrarResumenCierre(datos);
			}
			

			//4027
			for(int i = 0; i<lista4027.size(); i++){
				datos = (Map)lista4027.get(i);
				
				if (log.isDebugEnabled()) log.debug("DATOS 1 - 4027 : "+ datos);
				
				String suma = datos.get("suma").toString();
				double acum = Double.parseDouble(suma);
				
				datos.put("cod_anho", datos.get("periodo").toString().substring(0,4)); 
				datos.put("cod_mes", datos.get("periodo").toString().substring(4,6));
				datos.put("ind_tip_planil", "1");
				datos.put("cod_persona", datos.get("cod_pers"));
				datos.put("cod_anho_origen", datos.get("periodo").toString().substring(0,4));
				datos.put("cod_mes_origen", datos.get("periodo").toString().substring(4,6));
				datos.put("cod_concepto", "4027");
				datos.put("num_min_stma", new Double(acum));
				datos.put("num_min_mod",  new Double(acum)); 
				datos.put("num_dias", new Double(0));
				datos.put("ind_estado", ind_estado);
				datos.put("cod_usumodif", "");
				//datos.put("fec_modif", ""); 
				datos.put("cod_usucrea", usuario);
				datos.put("fec_creacion", dia.getSQLDate());
				datos.put("ind_tipo_carga", "A");
				datos.put("ind_devol", "0");
				
				if (log.isDebugEnabled()) log.debug("DATOS 2 : "+ datos);
				t72dao.registrarResumenCierre(datos);
			}

			//1114
			for(int i = 0; i<lista1114.size(); i++){
				datos = (Map)lista1114.get(i);
				
				if (log.isDebugEnabled()) log.debug("DATOS 1 - 1114 : "+ datos);
				
				String suma = datos.get("suma").toString();
				double acum = Double.parseDouble(suma);
				
				datos.put("cod_anho", datos.get("period_reg").toString().substring(0,4)); 
				datos.put("cod_mes", datos.get("period_reg").toString().substring(4,6));
				datos.put("ind_tip_planil", "1");
				datos.put("cod_persona", datos.get("cod_pers"));
				datos.put("cod_anho_origen", datos.get("periodo").toString().substring(0,4));
				datos.put("cod_mes_origen", datos.get("periodo").toString().substring(4,6));
				datos.put("cod_concepto", "1114");
				datos.put("num_min_stma", new Double(acum));
				datos.put("num_min_mod",  new Double(acum)); 
				datos.put("num_dias", new Double(0));
				datos.put("ind_estado", ind_estado);
				datos.put("cod_usumodif", "");
				//datos.put("fec_modif", ""); 
				datos.put("cod_usucrea", usuario);
				datos.put("fec_creacion", dia.getSQLDate());
				datos.put("ind_tipo_carga", "A");
				datos.put("ind_devol", "1");
				
				if (log.isDebugEnabled()) log.debug("DATOS 2 : "+ datos);
				t72dao.registrarResumenCierre(datos);
			}
			
			
			//4028
			for(int i = 0; i<lista4028.size(); i++){
				datos = (Map)lista4028.get(i);
				
				if (log.isDebugEnabled()) log.debug("DATOS 1 - 4028 : "+ datos);
				
				String suma = datos.get("suma").toString();
				double acum = Double.parseDouble(suma);
				double acum_minutos = acum * 480;
				//String acumulado = acum_minutos + "";
 				
				datos.put("cod_anho", datos.get("periodo").toString().substring(0,4)); 
				datos.put("cod_mes", datos.get("periodo").toString().substring(4,6));
				datos.put("ind_tip_planil", "1");
				datos.put("cod_persona", datos.get("cod_pers"));
				datos.put("cod_anho_origen", datos.get("periodo").toString().substring(0,4));
				datos.put("cod_mes_origen", datos.get("periodo").toString().substring(4,6));
				datos.put("cod_concepto", "4028");
				datos.put("num_min_stma", new Double(acum_minutos));
				datos.put("num_min_mod",  new Double(acum_minutos)); 
				datos.put("num_dias", new Double(0));
				datos.put("ind_estado", ind_estado);
				datos.put("cod_usumodif", "");
				//datos.put("fec_modif", ""); 
				datos.put("cod_usucrea", usuario);
				datos.put("fec_creacion", dia.getSQLDate());
				datos.put("ind_tipo_carga", "A");
				datos.put("ind_devol", "0");
				
				if (log.isDebugEnabled()) log.debug("DATOS 2 : "+ datos);
				t72dao.registrarResumenCierre(datos);
			}
			
			//1116
			for(int i = 0; i<lista1116.size(); i++){
				datos = (Map)lista1116.get(i);
				
				if (log.isDebugEnabled()) log.debug("DATOS 1 - 1116 : "+ datos);
				
				String suma = datos.get("suma").toString();
				double acum = Double.parseDouble(suma);
				double acum_minutos = acum * 480;
 				
				datos.put("cod_anho", datos.get("period_reg").toString().substring(0,4)); 
				datos.put("cod_mes", datos.get("period_reg").toString().substring(4,6));
				datos.put("ind_tip_planil", "1");
				datos.put("cod_persona", datos.get("cod_pers"));
				datos.put("cod_anho_origen", datos.get("periodo").toString().substring(0,4));
				datos.put("cod_mes_origen", datos.get("periodo").toString().substring(4,6));
				datos.put("cod_concepto", "1116");
				datos.put("num_min_stma", new Double(acum_minutos));
				datos.put("num_min_mod",  new Double(acum_minutos)); 
				datos.put("num_dias", new Double(0));
				datos.put("ind_estado", ind_estado);
				datos.put("cod_usumodif", "");
				//datos.put("fec_modif", ""); 
				datos.put("cod_usucrea", usuario);
				datos.put("fec_creacion", dia.getSQLDate());
				datos.put("ind_tipo_carga", "A");
				datos.put("ind_devol", "1");
				
				if (log.isDebugEnabled()) log.debug("DATOS 2 : "+ datos);
				t72dao.registrarResumenCierre(datos);
			}
			

			//4029
			for(int i = 0; i<lista4029.size(); i++){
				datos = (Map)lista4029.get(i);
				
				if (log.isDebugEnabled()) log.debug("DATOS 1 - 4029 : "+ datos);
				
				String suma = datos.get("suma").toString();
				double acum = Double.parseDouble(suma);
				
				//String acumulado = acum_minutos + "";
 				
				datos.put("cod_anho", datos.get("periodo").toString().substring(0,4)); 
				datos.put("cod_mes", datos.get("periodo").toString().substring(4,6));
				datos.put("ind_tip_planil", "1");
				datos.put("cod_persona", datos.get("cod_pers"));
				datos.put("cod_anho_origen", datos.get("periodo").toString().substring(0,4));
				datos.put("cod_mes_origen", datos.get("periodo").toString().substring(4,6));
				datos.put("cod_concepto", "4029");
				datos.put("num_min_stma", new Double(acum));
				datos.put("num_min_mod",  new Double(acum)); 
				datos.put("num_dias", new Double(0));
				datos.put("ind_estado", ind_estado);
				datos.put("cod_usumodif", "");
				//datos.put("fec_modif", ""); 
				datos.put("cod_usucrea", usuario);
				datos.put("fec_creacion", dia.getSQLDate());
				datos.put("ind_tipo_carga", "A");
				datos.put("ind_devol", "0");
				
				if (log.isDebugEnabled()) log.debug("DATOS 2 : "+ datos);
				t72dao.registrarResumenCierre(datos);
			}

			//1115
			for(int i = 0; i<lista1115.size(); i++){
				datos = (Map)lista1115.get(i);
				
				if (log.isDebugEnabled()) log.debug("DATOS 1 - 1115 : "+ datos);
				
				String suma = datos.get("suma").toString();
				double acum = Double.parseDouble(suma);
 				
				datos.put("cod_anho", datos.get("period_reg").toString().substring(0,4)); 
				datos.put("cod_mes", datos.get("period_reg").toString().substring(4,6));
				datos.put("ind_tip_planil", "1");
				datos.put("cod_persona", datos.get("cod_pers"));
				datos.put("cod_anho_origen", datos.get("periodo").toString().substring(0,4));
				datos.put("cod_mes_origen", datos.get("periodo").toString().substring(4,6));
				datos.put("cod_concepto", "1115");
				datos.put("num_min_stma", new Double(acum));
				datos.put("num_min_mod",  new Double(acum)); 
				datos.put("num_dias", new Double(0));
				datos.put("ind_estado", ind_estado);
				datos.put("cod_usumodif", "");
				//datos.put("fec_modif", ""); 
				datos.put("cod_usucrea", usuario);
				datos.put("fec_creacion", dia.getSQLDate());
				datos.put("ind_tipo_carga", "A");
				datos.put("ind_devol", "1");
				
				if (log.isDebugEnabled()) log.debug("DATOS 2 : "+ datos);
				t72dao.registrarResumenCierre(datos);
			}

			
			//4030
			for(int i = 0; i<lista4030.size(); i++){
				datos = (Map)lista4030.get(i);
				
				if (log.isDebugEnabled()) log.debug("DATOS 1 - 4030 : "+ datos);
				
				String suma = datos.get("suma").toString();
				double acum = Double.parseDouble(suma);
				
 				
				datos.put("cod_anho", datos.get("periodo").toString().substring(0,4)); 
				datos.put("cod_mes", datos.get("periodo").toString().substring(4,6));
				datos.put("ind_tip_planil", "1");
				datos.put("cod_persona", datos.get("cod_pers"));
				datos.put("cod_anho_origen", datos.get("periodo").toString().substring(0,4));
				datos.put("cod_mes_origen", datos.get("periodo").toString().substring(4,6));
				datos.put("cod_concepto", "4030");
				datos.put("num_min_stma", new Double(acum));
				datos.put("num_min_mod",  new Double(acum)); 
				datos.put("num_dias", new Double(0));
				datos.put("ind_estado", ind_estado);
				datos.put("cod_usumodif", "");
				//datos.put("fec_modif", ""); 
				datos.put("cod_usucrea", usuario);
				datos.put("fec_creacion", dia.getSQLDate());
				datos.put("ind_tipo_carga", "A");
				datos.put("ind_devol", "0");
				
				if (log.isDebugEnabled()) log.debug("DATOS 2 : "+ datos);
				t72dao.registrarResumenCierre(datos);

				
				//JRR - 17/12/2008
				/************* ACTUALIZACION DE LIC POR BOLSA NO COMPENSADAS *************/
				if (ind_estado.equals("2")) {
					datos.put("fec_hoy", dia.getSQLDate());
					lista_compPend = compDAO.findCompensacionesPendByFecFin(datos);
					if (log.isDebugEnabled()) log.debug("lista_compPend: " + lista_compPend);

					if (lista_compPend !=null && lista_compPend.size()>0) {
						for (int k = 0; k < lista_compPend.size(); k++) {
							aux_comp = (HashMap)lista_compPend.get(k);
							aux_comp.put("ind_estado", "3");
							aux_comp.put("cod_usucrea", usuario);
							aux_comp.put("fec_creacion", dia.getSQLDate());
							compDAO.actualizarEstadoCompensacion(aux_comp);
						}
					}
				}
				/************************************************************************/			
				
			}

			//1164
			for(int i = 0; i<lista1164.size(); i++){
				datos = (Map)lista1164.get(i);
				
				if (log.isDebugEnabled()) log.debug("DATOS 1 - 1164 : "+ datos);
				
				String suma = datos.get("suma").toString();
				double acum = Double.parseDouble(suma);
 				
				datos.put("cod_anho", datos.get("period_reg").toString().substring(0,4)); 
				datos.put("cod_mes", datos.get("period_reg").toString().substring(4,6));
				datos.put("ind_tip_planil", "1");
				datos.put("cod_persona", datos.get("cod_pers"));
				datos.put("cod_anho_origen", datos.get("periodo").toString().substring(0,4));
				datos.put("cod_mes_origen", datos.get("periodo").toString().substring(4,6));
				datos.put("cod_concepto", "1164");
				datos.put("num_min_stma", new Double(acum));
				datos.put("num_min_mod",  new Double(acum)); 
				datos.put("num_dias", new Double(0));
				datos.put("ind_estado", ind_estado);
				datos.put("cod_usumodif", "");
				//datos.put("fec_modif", ""); 
				datos.put("cod_usucrea", usuario);
				datos.put("fec_creacion", dia.getSQLDate());
				datos.put("ind_tipo_carga", "A");
				datos.put("ind_devol", "1");
				
				if (log.isDebugEnabled()) log.debug("DATOS 2 : "+ datos);
				t72dao.registrarResumenCierre(datos);
			}

			
			//4047
			for(int i = 0; i<lista4047.size(); i++){
				datos = (Map)lista4047.get(i);
				
				if (log.isDebugEnabled()) log.debug("DATOS 1 - 4047 : "+ datos);
				
				String suma = datos.get("suma").toString();
				double acum = Double.parseDouble(suma);
				
 				
				datos.put("cod_anho", datos.get("periodo").toString().substring(0,4)); 
				datos.put("cod_mes", datos.get("periodo").toString().substring(4,6));
				datos.put("ind_tip_planil", "1");
				datos.put("cod_persona", datos.get("cod_pers"));
				datos.put("cod_anho_origen", datos.get("periodo").toString().substring(0,4));
				datos.put("cod_mes_origen", datos.get("periodo").toString().substring(4,6));
				datos.put("cod_concepto", "4047");
				datos.put("num_min_stma", new Double(acum));
				datos.put("num_min_mod",  new Double(acum)); 
				datos.put("num_dias", new Double(0));
				datos.put("ind_estado", ind_estado);
				datos.put("cod_usumodif", "");
				//datos.put("fec_modif", ""); 
				datos.put("cod_usucrea", usuario);
				datos.put("fec_creacion", dia.getSQLDate());
				datos.put("ind_tipo_carga", "A");
				datos.put("ind_devol", "0");
				
				if (log.isDebugEnabled()) log.debug("DATOS 2 : "+ datos);
				t72dao.registrarResumenCierre(datos);
			}

			
			//4061
			for(int i = 0; i<lista4061.size(); i++){
				datos = (Map)lista4061.get(i);
				
				if (log.isDebugEnabled()) log.debug("DATOS 1 - 4061 : "+ datos);
				
				String suma = datos.get("suma").toString();
				double acum = Double.parseDouble(suma);
				double acum_minutos = acum * 480;
				//String acumulado = acum_minutos + "";
 				
				datos.put("cod_anho", datos.get("periodo").toString().substring(0,4)); 
				datos.put("cod_mes", datos.get("periodo").toString().substring(4,6));
				datos.put("ind_tip_planil", "1");
				datos.put("cod_persona", datos.get("cod_pers"));
				datos.put("cod_anho_origen", datos.get("periodo").toString().substring(0,4));
				datos.put("cod_mes_origen", datos.get("periodo").toString().substring(4,6));
				datos.put("cod_concepto", "4061");
				datos.put("num_min_stma", new Double(acum_minutos));
				datos.put("num_min_mod",  new Double(acum_minutos)); 
				datos.put("num_dias", new Double(0));
				datos.put("ind_estado", ind_estado);
				datos.put("cod_usumodif", "");
				//datos.put("fec_modif", ""); 
				datos.put("cod_usucrea", usuario);
				datos.put("fec_creacion", dia.getSQLDate());
				datos.put("ind_tipo_carga", "A");
				datos.put("ind_devol", "0");
				
				if (log.isDebugEnabled()) log.debug("DATOS 2 : "+ datos);
				t72dao.registrarResumenCierre(datos);
			}
			
			//1165
			for(int i = 0; i<lista1165.size(); i++){
				datos = (Map)lista1165.get(i);
				
				if (log.isDebugEnabled()) log.debug("DATOS 1 - 1165 : "+ datos);
				
				String suma = datos.get("suma").toString();
				double acum = Double.parseDouble(suma);
				double acum_minutos = acum * 480;
 				
				datos.put("cod_anho", datos.get("period_reg").toString().substring(0,4)); 
				datos.put("cod_mes", datos.get("period_reg").toString().substring(4,6));
				datos.put("ind_tip_planil", "1");
				datos.put("cod_persona", datos.get("cod_pers"));
				datos.put("cod_anho_origen", datos.get("periodo").toString().substring(0,4));
				datos.put("cod_mes_origen", datos.get("periodo").toString().substring(4,6));
				datos.put("cod_concepto", "1165");
				datos.put("num_min_stma", new Double(acum_minutos));
				datos.put("num_min_mod",  new Double(acum_minutos)); 
				datos.put("num_dias", new Double(0));
				datos.put("ind_estado", ind_estado);
				datos.put("cod_usumodif", "");
				//datos.put("fec_modif", ""); 
				datos.put("cod_usucrea", usuario);
				datos.put("fec_creacion", dia.getSQLDate());
				datos.put("ind_tipo_carga", "A");
				datos.put("ind_devol", "1");
				
				if (log.isDebugEnabled()) log.debug("DATOS 2 : "+ datos);
				t72dao.registrarResumenCierre(datos);
			}
			
			
			//1099
			for(int i = 0; i<lista1099.size(); i++){
				datos = (Map)lista1099.get(i);
				
				if (log.isDebugEnabled()) log.debug("DATOS 1 - 1099 : "+ datos);
 				
				datos.put("cod_anho", params.get("periodo").toString().substring(0,4)); 
				datos.put("cod_mes", params.get("periodo").toString().substring(4,6));
				datos.put("ind_tip_planil", "1");
				datos.put("cod_persona", datos.get("cod_pers"));
				datos.put("cod_anho_origen", params.get("periodo").toString().substring(0,4));
				datos.put("cod_mes_origen", params.get("periodo").toString().substring(4,6));
				datos.put("cod_concepto", "1099");
				datos.put("num_min_stma", new Double(0));
				datos.put("num_min_mod",  new Double(0)); 
				datos.put("num_dias", new Double(datos.get("total").toString()));
				datos.put("ind_estado", ind_estado);
				datos.put("cod_usumodif", "");
				//datos.put("fec_modif", ""); 
				datos.put("cod_usucrea", usuario);
				datos.put("fec_creacion", dia.getSQLDate());
				datos.put("ind_tipo_carga", "A");
				datos.put("ind_devol", "0");
				
				if (log.isDebugEnabled()) log.debug("DATOS 2 : "+ datos);
				t72dao.registrarResumenCierre(datos);
			}
			
			/******** EXCLUSIONES ***********/
			
			if (ind_estado.equals("2")) {

				T1273DAO t1273dao = new T1273DAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dcsp"));
				T60DAO t60dao = new T60DAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dgsp"));
				FechaBean fbIni = null;
				FechaBean fbFin = null;
				//Elimino data previa
				t60dao.eliminarExclusionesPeriodo(params);
				List listaLSGH = t1273dao.findSupLimiteLicenciasSinGoce(params);
	
				for(int i = 0; i<listaLSGH.size(); i++){
					datos = (Map)listaLSGH.get(i);
					if (log.isDebugEnabled()) log.debug("DATOS 1 - EXCLUSIONES : "+ datos);
					
					fbIni = new FechaBean(datos.get("ffinicio_desc").toString(), "dd/MM/yyyy hh:mm:ss"); 
					fbFin = new FechaBean(datos.get("ffin_desc").toString(), "dd/MM/yyyy hh:mm:ss");
	 				
					datos.put("cod_anho", params.get("periodo").toString().substring(0,4)); 
					datos.put("cod_mes", params.get("periodo").toString().substring(4,6));
					datos.put("ind_tip_planil", "1");
					datos.put("cod_persona", datos.get("cod_pers"));
					datos.put("cod_motivo", "3");
					datos.put("ind_estado", "1");
					datos.put("ffinicio", fbIni.getSQLDate());
					datos.put("ffin", fbFin.getSQLDate());
					datos.put("observa", "");
					datos.put("cond_var",  ""); 
					datos.put("fec_creacion", dia.getTimestamp());
					datos.put("cod_usucrea", usuario);
					
					if (log.isDebugEnabled()) log.debug("DATOS 2 : "+ datos);
					t60dao.registrarExclusionesPeriodo(datos);
				}
				
			}

			
			/***************************** CORREOS *********************************/
			
			if (indMail.equals("1") && !ind_estado.equals("2")) {

				pe.gob.sunat.rrhh.asistencia.dao.T1276DAO t1276dao = new pe.gob.sunat.rrhh.asistencia.dao.T1276DAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dcsp"));
				Map mapaPer = t1276dao.findPeriodoByFecha(datos.get("cod_anho")+"/"+datos.get("cod_mes")+"/01");

				FechaBean fbIni = new FechaBean(mapaPer.get("finicio").toString(), "yyyy/MM/dd");
				FechaBean fbFin = new FechaBean(mapaPer.get("ffin").toString(), "yyyy/MM/dd");
				params.put("finicio", fbIni.getFormatDate("dd/MM/yyyy"));
				params.put("ffin", fbFin.getFormatDate("dd/MM/yyyy"));
				
				//JRR - PARA ENVIAR CORREO POR PAPELETAS PENDIENTES
				T1271DAO t1271dao = new T1271DAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dcsp"));
				CorreoDAO correoDAO = new CorreoDAO();
				T02DAO personalDAO = new T02DAO();

				int mes = Integer.parseInt(datos.get("cod_mes").toString());
				String nombreMes = "";
				switch (mes) {
					case 1: nombreMes = "Enero"; break;
					case 2: nombreMes = "Febrero"; break;
					case 3: nombreMes = "Marzo"; break;
					case 4: nombreMes = "Abril"; break;
					case 5: nombreMes = "Mayo"; break;
					case 6: nombreMes = "Junio"; break;
					case 7: nombreMes = "Julio"; break;
					case 8: nombreMes = "Agosto"; break;
					case 9: nombreMes = "Setiembre"; break;
					case 10: nombreMes = "Octubre"; break;
					case 11: nombreMes = "Noviembre"; break;
					case 12: nombreMes = "Diciembre"; break;
				}

				//String dbpool = (String) params.get("dbpool");
				Map jefe = new HashMap();

				String mensaje = "Usted tiene <strong> papeletas pendientes de Aprobaci칩n/Rechazo </strong> para el per칤odo de "+ nombreMes + " del " + datos.get("cod_anho") + ".";			
				List jefes = t1271dao.findJefeAutorPapeletasPendientesByPeriodo(datos);
				if (log.isDebugEnabled()) log.debug("jefes: " + jefes);

				if (jefes != null && !jefes.isEmpty()){
					for (int i=0; i<jefes.size(); i++) {
						jefe = (HashMap)jefes.get(i); 
						String nombre = personalDAO.findNombreCompletoByCodPers(dbpool, jefe.get("jefe_autor").toString().trim());

						StringBuffer sb_mensaje = new StringBuffer("");
						String mensajeF = "";
						List personal = t1271dao.findTrabPapeletasPendientesByPeriodoAndJefe(datos, jefe);

						if(personal != null && !personal.isEmpty()){
							for(int j=0; j<personal.size(); j++) {
								Map Trab = (HashMap)personal.get(j); 
								String nombreTrab = personalDAO.findNombreCompletoByCodPers(dbpool, Trab.get("cod_pers").toString());
								Trab.put("nombreTrab", nombreTrab);
							}
						}

						sb_mensaje.append("<tr><td>&nbsp;</td></tr>")			
						.append("<tr><td style='background-color:#B6CBEB;'>")
						.append(generaTablaDatos(personal))
						.append("</td></tr><tr><td>&nbsp;</td></tr>");
						mensajeF = mensaje + sb_mensaje.toString();

						//LINK
						ResourceBundle bundle = ResourceBundle.getBundle("pe.gob.sunat.sp.asistencia.sirh");
						String servidorIP = bundle.getString("servidorIP");
						String programa = bundle.getString("programa6");
						String url = new MenuCliente().generaInvocacionURL(programa,null,true,MenuCliente.INTRANET,"/ol-ti-iaasistencia/asisS11Alias");
						String strURL = "http://"+servidorIP+url;

						//Para el link se env칤a strURL, de lo contrario ""
						String texto = Utiles.textoCorreoProceso(dbpool, nombre, mensajeF, strURL);

						Correo objCorreo = new Correo(texto);
						objCorreo.agregarDestinatario(correoDAO.findCorreoByCodPers(dbpool, jefe.get("jefe_autor").toString().trim()));
						objCorreo.setAsunto("Notificaci칩n de Papeletas Electr칩nicas Pendientes");
						objCorreo.enviarHtml();

					}
				}


				//JRR - PARA ENVIAR CORREO POR SOLICITUDES PENDIENTES
				T1455DAO t1455dao = new T1455DAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dcsp"));
				String mensajeSol = "Usted tiene <strong> solicitudes pendientes de Aprobaci칩n/Rechazo </strong> para el per칤odo de "+ nombreMes + " del " + datos.get("cod_anho") + ".";
				List responsables = t1455dao.findRespSolicitudesPendientesByffinicio(params);
				if (log.isDebugEnabled()) log.debug("responsables: " + responsables);
				Map responsable = new HashMap();

				if (responsables != null && !responsables.isEmpty()){
					for (int i=0; i<responsables.size(); i++) {
						responsable = (HashMap)responsables.get(i); 
						String nombre = personalDAO.findNombreCompletoByCodPers(dbpool, responsable.get("cuser_dest").toString().trim());

						StringBuffer sb_mensaje = new StringBuffer("");
						String mensajeF = "";
						List personal = t1455dao.findTrabSolicitudesPendientesByffinicioAndResp(params, responsable);

						if(personal != null && !personal.isEmpty()){
							for(int j=0; j<personal.size(); j++) {
								Map Trab = (HashMap)personal.get(j); 
								String nombreTrab = personalDAO.findNombreCompletoByCodPers(dbpool, Trab.get("cod_pers").toString());
								Trab.put("nombreTrab", nombreTrab);
							}
						}

						sb_mensaje.append("<tr><td>&nbsp;</td></tr>")			
						.append("<tr><td style='background-color:#B6CBEB;'>")
						.append(generaTablaDatos(personal))
						.append("</td></tr><tr><td>&nbsp;</td></tr>");
						mensajeF = mensajeSol + sb_mensaje.toString();

						//LINK
						ResourceBundle bundle = ResourceBundle.getBundle("pe.gob.sunat.sp.asistencia.sirh");
						String servidorIP = bundle.getString("servidorIP");
						String programa = bundle.getString("programa1");
						String url = new MenuCliente().generaInvocacionURL(programa,null,true,MenuCliente.INTRANET,"/ol-ti-iaasistencia/asisS11Alias");
						String strURL = "http://"+servidorIP+url;

						//Para el link se env칤a strURL, de lo contrario ""
						String texto = Utiles.textoCorreoProceso(dbpool, nombre, mensajeF, strURL);

						Correo objCorreo = new Correo(texto);
						objCorreo.agregarDestinatario(correoDAO.findCorreoByCodPers(dbpool, responsable.get("cuser_dest").toString().trim()));
						objCorreo.setAsunto("Notificaci칩n de Solicitudes Pendientes");
						objCorreo.enviarHtml();

					}
				}

			}
			
		} catch (Exception e) {
			log.error(e);
			throw new RemoteException(e.getMessage());
		}
		finally {
			try {
				//registramos el log del proceso
				super.registraLog(dbpool, params, usuario);
			} catch (Exception e) {
			}
		}
	}
	

	/**
	 * genera una cadena que contiene una tabla html con los datos
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 *
	 * @param dbean DynaBean 
	 * @param hm HashMap
	 * @return 
	 * @throws FacadeException
	 */
	public String generaTablaDatos(List lista) throws FacadeException{
		StringBuffer cadenaTabla = new StringBuffer("");
		HashMap registro = null;
		
		try{
			cadenaTabla.append("<table border='0' cellpadding='0' cellspacing='1'> <tr align='center'>")
			.append("<th width='5%' nowrap><font face='Verdana' size='2'>N&uacute;mero</font></th>")
			.append("<th width='10%' ><font face='Verdana' size='2'>N&uacute;m. Registro</font></th>")
			.append("<th width='60%' ><font face='Verdana' size='2'>Apellidos - Nombres</font></th>")			
			.append("<th width='25%' ><font face='Verdana' size='2'>Fecha Recepci&oacute;n</font></th>")
			.append("</tr>");

			for(int i=0;i<lista.size();i++){
				registro = (HashMap) lista.get(i);
				
				cadenaTabla.append("<tr align='left' class='dato'><td align='center' style='background-color:#FFF;'><font face='Verdana' size='2'>")
				//.append(i+1)
				.append(registro.get("numero")!=null ? registro.get("numero").toString().trim():i+1+"")
				.append("</font></td><td align='center' style='background-color:#FFF;'><font face='Verdana' size='2'>")
				.append( (registro.get("cod_pers")!=null) ? (String)registro.get("cod_pers"):"")
				.append("</font></td><td style='background-color:#FFF;'><font face='Verdana' size='2'>")
				.append( (registro.get("nombreTrab")!=null) ? (registro.get("nombreTrab").toString().trim()):"")
				.append("</font></td><td align='center' style='background-color:#FFF;'><font face='Verdana' size='2'>")
				.append( (registro.get("fmod_desc")!=null) ?(String)registro.get("fmod_desc"):"")			
				.append("</font></td></tr>");
			}
			
			cadenaTabla.append("</table>");
			
		} catch(Exception e){
			log.error(e);
			throw new FacadeException(this,e.getMessage());
		} finally{
		}
		return cadenaTabla.toString(); 
	}

	
	/**
	 * Metodo que se encarga de ejecutar el proceso de asistencia para un
	 * trabajador CAS
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="Required"
	 * @param mapaPrin
	 * @return
	 * @throws RemoteException
	 */
	public boolean procesarAsistenciaTrabajadorCAS(Map mapaPrin) 
		throws RemoteException {
		
		if (log.isDebugEnabled()) log.debug("Utilizando metodo procesarAsistenciaTrabajadorCAS");
		
		String dbpool = mapaPrin.get("dbpool").toString(); 
		String codPers = mapaPrin.get("codPers").toString();
		String codUO = mapaPrin.get("codUO").toString(); 
		String periodo = mapaPrin.get("periodo").toString(); 
		String fechaIni = mapaPrin.get("fechaIni").toString(); 
		String fechaFin = mapaPrin.get("fechaFin").toString();
		List movimientos = (List) mapaPrin.get("movimientos"); 
		Map acumulados = (Map) mapaPrin.get("acumulados"); 
		Map acumPeriodo = (Map) mapaPrin.get("acumPeriodo");
		String usuario = mapaPrin.get("usuario").toString();
		String indPap = mapaPrin.get("indPap").toString(); 

		T1271DAO asisDAO = new T1271DAO(dbpool);
		T1272DAO resumenDAO = new T1272DAO();
		T1454DAO diarioDAO = new T1454DAO();
		T1273DAO licenciaDAO = new T1273DAO(dbpool);
		T1282DAO vacacionDAO = new T1282DAO(dbpool);		
		T1270DAO turnoDAO = new T1270DAO();
		T01DAO paramDAO = new T01DAO();
		T99DAO codigoDAO = new T99DAO();
		T8167DAO climaLabDAO = new T8167DAO(dbpool); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
				
		BeanTurnoTrabajo turno = null;
		boolean res = true;
		String fIni = "";
		String fFin = "";
		
		List papeletasGeneradas=null;//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
		
		try {
			String fechaIniNSA = codigoDAO.findParamByCodTabCodigo(dbpool,
					Constantes.CODTAB_PARAMETROS_ASISTENCIA,
					Constantes.FECHA_INICIO_SIRH_NSA);
			
			//eliminamos la asistencia resumen en el periodo para el trabajador
			resumenDAO.deleteByCodPersPeriodo(dbpool, codPers, periodo);
			diarioDAO.deleteByCodPersPeriodo(dbpool, codPers, periodo);

			//para la verificacion de dias faltantes
			if (fechaIni.indexOf("/")>3) fIni = fechaIni; else fIni = Utiles.toYYYYMMDD(fechaIni);	
			if (fechaFin.indexOf("/")>3) fFin = fechaFin; else fFin = Utiles.toYYYYMMDD(fechaFin);	

			String fAct = fIni;
			String fReal = fechaIni;
			if (fReal.indexOf("/")>3){ 
				fReal = fReal.substring(8,10) + "/" + fReal.substring(5,7) + "/" + fReal.substring(0,4) ;
			}
			
			boolean bVacacion = false;
			boolean bLicencia = false;
			boolean bInasistencia = true;
			boolean bPrimMarca = true;
			boolean bUltMarca = false;
			HashMap acumPer = null;
			HashMap acumDetalle = null;
			HashMap acumDetalleRefri = null;//ICR 18052015
			HashMap acumPerRefri = null;//ICR 18052015
			
			List detalles = null;
			List detallesPapGen = null;//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
			Map proceso = new HashMap();
			
			int minRecuperacion = 0; //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
			
			//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
			Map paramsCli = new HashMap();			
			String climaLab = codigoDAO.findParamByCodTabCodigo(dbpool,Constantes.CODTAB_PARAMETROS_ASISTENCIA,Constantes.MINUTOS_MAXIMO_CLIMALABORAL);
			int minMaxClima = climaLab != null ? Integer.parseInt(climaLab) : 0;
			log.debug("minMaxClima: " + ""+minMaxClima);
			List califClima = null;
			Map autoriClima = null;			
			//ICAPUNAY - PAS20175E230300069
			
			//mientras no haya terminado el periodo en proceso
			while (fAct.compareTo(fFin) <= 0) {

				if (log.isDebugEnabled()) log.debug("--------- Fecha : " + fReal + " ---------");
				
				minRecuperacion = turnoDAO.findHorasCompensa(dbpool,codPers,fReal); //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
				if (log.isDebugEnabled()) log.debug("minRecuperacion3-CAS:"+minRecuperacion);
				
				//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
				paramsCli.put("cod_pers", codPers);
				paramsCli.put("mov", Constantes.MOV_REFRI_CLIMALABORAL);//136
				paramsCli.put("fecha", new FechaBean(fReal).getSQLDate());				
				log.debug("paramsClii: "+paramsCli);
				
				califClima=asisDAO.findByCodPersMovFecha(paramsCli);
				log.debug("califClimaa: "+califClima);
				autoriClima=climaLabDAO.findAutorizaByRegByFecha(codPers, fReal);
				log.debug("autoriClima new: "+autoriClima);	
				//ICAPUNAY - PAS20175E230300069
				

				//aqui inicializamos todas las variables de control del dia
				bVacacion = false;
				bLicencia = false;
				bInasistencia = true;
				bPrimMarca = true;

				//obtenemos el turno del trabajador para la fecha en proceso
				turno = turnoDAO.joinWithT45ByCodFecha(dbpool, codPers, fReal);
				if (log.isDebugEnabled()) log.debug("Turno de trabajador:" + turno);

				//verificamos si esta de vacaciones para la fecha real
				//prac-jcallo
				Map prm = new HashMap();
				prm.put("cod_pers", codPers);
				prm.put("fechaIni", fReal);
				prm.put("fechaFin", "");
				if (log.isDebugEnabled()) log.debug("metodo procesarAsistenciaTrabajadorCAS - findByCodPersFIniFFin - prm:"+prm);
				bVacacion = vacacionDAO.findByCodPersFIniFFin(prm);
				
				/******* JRR NUEVA SOLICITUD - 23/04/2009 *******/
				if (!bVacacion) {
					List vacVencidas = vacacionDAO.findByCodPersFIniFFinVacVencidas(prm);
					if (vacVencidas!=null && vacVencidas.size()>0) { 
						bVacacion = true;
						if (log.isDebugEnabled()) log.debug(codPers + " posee Goce de Vacaciones Vencidas.");
					}
				}
				/************************************************/
				
				if (log.isDebugEnabled()) log.debug("bVacacion: "+bVacacion);
				if (bVacacion) {
					
					if (log.isDebugEnabled()) log.debug("El trabajador esta de vacaciones el " +fReal);

					//obtenemos el movimiento de vacaciones e incrementamos el numero de dias
					acumDetalle = (HashMap) acumulados.get(Constantes.MOV_VACACIONES);
					acumDetalle.put("total", "1");
					acumulados.put(Constantes.MOV_VACACIONES, acumDetalle);
					
					//acumulamos del periodo
					acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_VACACIONES);
					
					float totPer = new Float(acumPer.get("total").toString()).floatValue();
					acumPer.put("total", "" + (totPer + 1));
					acumPeriodo.put(Constantes.MOV_VACACIONES, acumPer);

					//el trabajador no ha faltado xq esta de vacaciones
					bInasistencia = false;
					
				} else {

					//verificamos si esta de licencia
					//prac-jcallo
					Map params = new HashMap();
					params.put("cod_pers", codPers);
					params.put("fecha1", fReal);
					params.put("fecha2", "");
					params.put("numero", "");
					if (log.isDebugEnabled()) log.debug("licenciaDAO.findByCodPersFIniFFin(params)... params:"+params);
					bLicencia = licenciaDAO.findByCodPersFIniFFin(params); //(dbpool,codPers, fReal, "", "");
					
					if (bLicencia) {
						
						if (log.isDebugEnabled()) log.debug("El trabajador esta de licencia el " +fReal);
						
						//obtenemos la licencia de ese dia
						Map prms = new HashMap();
						prms.put("cod_pers", codPers);
						prms.put("fecha", fReal);

						List lista = licenciaDAO.findByCodPersFecha(prms);
						Map licencia = (Map)lista.get(0); //(dbpool, codPers, fReal);
						//obtenemos el movimiento de vacaciones e incrementamos el numero de dias
						acumDetalle = (HashMap) acumulados.get(licencia.get("licencia").toString().trim());
						
						if (acumDetalle != null) {
							//el trabajador esta de licencia
							acumDetalle.put("total", "1");
							acumulados.put(licencia.get("licencia").toString().trim(),acumDetalle);

							//acumulamos del periodo
							acumPer = (HashMap) acumPeriodo.get(licencia.get("licencia").toString().trim());
							
							float totPer = new Float(acumPer.get("total").toString()).floatValue();
							acumPer.put("total", "" + (totPer + 1));
							acumPeriodo.put(licencia.get("licencia").toString().trim(),acumPer);

						}

						//el trabajador no ha faltado xq esta de licencia
						bInasistencia = false;
					}
				}
				
				//si posee turno y no esta ni de vacaciones ni de licencia
				if (turno != null && !bVacacion && !bLicencia) {
					if (log.isDebugEnabled()) log.debug("tiene turno y no esta de vacaciones ni licencia");//BORRAR 26/06
					
					//verificamos si es un dia laborable
					boolean diaLaborable = true;
					if (!turno.isOperativo()) {
						if (log.isDebugEnabled()) log.debug("turno es adm");//BORRAR 26/06
						if (Utiles.isDiaSemana(fReal, Constantes.SABADO)								
							|| Utiles.isDiaSemana(fReal, Constantes.DOMINGO)
							|| paramDAO.findByFechaFeriado(dbpool, fReal)) {
							diaLaborable = false;
							if (log.isDebugEnabled()) log.debug("diaLaborable: "+diaLaborable);//BORRAR 26/06
						}
					}

					//obtenemos el detalle de las calificaciones para la fecha
					//prac-jcallo
					Map params = new HashMap();
					params.put("cod_pers", codPers);
					params.put("fing", fReal);
					params.put("estado_id", "1");//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
					
					//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
					detallesPapGen = asisDAO.findByCodPersFechaAndEstado(params);
					log.debug("detallesPapGen: "+detallesPapGen);
					
					if (detallesPapGen != null && detallesPapGen.size() > 0) {
						
						String periodoPap = (String)((HashMap)detallesPapGen.get(0)).get("periodo");
						
						HashMap fechas = new HashMap();
						fechas.put("FechaNSA",fechaIniNSA);
						
						DataSource dcsp = ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dcsp");
						pe.gob.sunat.rrhh.dao.T02DAO t02dao = new pe.gob.sunat.rrhh.dao.T02DAO(dcsp);
						HashMap beanPersona = (HashMap)t02dao.findByRegistro(codPers.trim());
						beanPersona.put("t02cod_pers", codPers);
						beanPersona.put("t02cod_uorg", beanPersona.get("cod_uorg"));
						
						HashMap mapa=new HashMap();
						mapa.put("dbpool", "jdbc/dgsp");
						mapa.put("fechaEval",fReal);
						mapa.put("periodo", periodoPap);
						mapa.put("isProcesar", "SI");
						
						Map superMapa = new HashMap();
						superMapa.put("mapa", mapa);
						superMapa.put("beanPersona", beanPersona);
						superMapa.put("fechas", fechas);
						superMapa.put("usuario", usuario);
						superMapa.put("isProcesar", "SI");
						
						String t02cod_rel=(String)beanPersona.get("t02cod_rel");
						
						ProcesoFacade pf=new ProcesoFacade();
						
						log.debug("superMapa--"+superMapa);
						if(t02cod_rel.equals("09")) {
							pf.generarAsistenciaTrabajadorCAS(superMapa);
							log.debug("superMapa: "+superMapa);
						} else if(t02cod_rel.equals("10")) {
							pf.generarAsistenciaTrabajadorModFormativa(superMapa);
						} else {
							pf.generarAsistenciaTrabajador(mapa,beanPersona,fechas,usuario);
						}
						
						papeletasGeneradas = (List)superMapa.get("papeletasGeneradas");
						if (log.isDebugEnabled()) log.debug("papeletasGeneradas fin : "+papeletasGeneradas);
					}
					//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
					
					if (log.isDebugEnabled()) log.debug("asisDAO.findByCodPersFechaPeriodo(params)... params:"+params);
					detalles = asisDAO.findByCodPersFechaPeriodo(params);// (dbpool, codPers, fReal, periodo) CAMBIAR ESTO POR EL DE RRHH ASISTENCIA;
					if (log.isDebugEnabled()) log.debug("detalles.size : "+detalles.size());
														
					//si el trabajador posee calificaciones para ese dia
					if (detalles != null && detalles.size() > 0) {

						bInasistencia = false;
						
						//analizamos cada movimiento realizado
						for (int j = 0; j < detalles.size(); j++) {
							if (log.isDebugEnabled()) log.debug("entro detalles");
							
							boolean movEspecial = false;
							boolean procesarPapeleta = false;
							proceso = (HashMap) detalles.get(j);
							
							//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
							String hing = proceso.get("hing").toString().trim();						
							log.debug("papeletasGeneradas: "+papeletasGeneradas);
							if (papeletasGeneradas!=null){
								for (int k = 0; k <= papeletasGeneradas.size()-1; k++) {
									Map papeleta = (HashMap) papeletasGeneradas.get(k);
									if (hing.equals(papeleta.get("hing"))){
										proceso.put("mov", papeleta.get("mov"));
										proceso.put("estado_id", papeleta.get("estado_id"));
									}
								}
							}
							//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
							
							String mov = proceso.get("mov")!= null ? proceso.get("mov").toString().trim() : "";
							if (log.isDebugEnabled()) log.debug("proceso: "+proceso);//BORRAR 26/06

							
							acumPer = (HashMap) acumPeriodo.get(mov);
							acumDetalle = (HashMap) acumulados.get(mov);
							if (log.isDebugEnabled()) log.debug("mov: "+mov);//BORRAR 26/06
							if (log.isDebugEnabled()) log.debug("acumPer: "+acumPer);//BORRAR 26/06
							if (log.isDebugEnabled()) log.debug("acumDetalle: "+acumDetalle);//BORRAR 26/06
							String recalifica = mov;
							if (log.isDebugEnabled()) log.debug("recalifica: "+recalifica);//BORRAR 26/06
							
							//JRR 19 mayo 2008
							String fing = proceso.get("fing_desc").toString().trim();

							if (acumDetalle != null) {
								String tipo = (String) acumDetalle.get("tipo_id");
								if (log.isDebugEnabled()) log.debug("tipo: "+tipo);//BORRAR 26/06
								String medida = (String) acumDetalle.get("medida");

								float total = new Float(acumDetalle.get("total").toString()).floatValue();
								float cantidad = 0;
								if (log.isDebugEnabled()) log.debug("total: "+total);//BORRAR 26/06

								boolean entrada = acumDetalle.get("entrada") != null ? ((String) acumDetalle.get("entrada")).equals(Constantes.ACTIVO): false;
								boolean refrigerio = acumDetalle.get("refrigerio") != null ? ((String) acumDetalle.get("refrigerio")).equals(Constantes.ACTIVO): false;
								boolean salida = acumDetalle.get("salida") != null ? ((String) acumDetalle.get("salida")).equals(Constantes.ACTIVO): false;
								if (log.isDebugEnabled()) log.debug("entrada: "+entrada);//BORRAR 26/06
								if (log.isDebugEnabled()) log.debug("refrigerio: "+refrigerio);//BORRAR 26/06
								if (log.isDebugEnabled()) log.debug("salida: "+salida);//BORRAR 26/06
								movEspecial = entrada || refrigerio || salida
										|| tipo.trim().equals(Constantes.TIPO_MOV_PAPELETA)
										|| mov.equals(Constantes.MOV_INASISTENCIA);
								log.debug("movEspecial: "+movEspecial);//BORRAR 25/06
								
								//inasistencia
								if (mov.equals(Constantes.MOV_INASISTENCIA)) bInasistencia = true;

								if (!bInasistencia) {
									log.debug("no es Inasistencia");//BORRAR 25/06
									
									//movimientos de entrada
									if (entrada) {
										log.debug("ingreso a entrada");//BORRAR 25/06

										bPrimMarca = false;
										String horaLim = turno.getHoraLimite();
										log.debug("horaLim: "+horaLim);//BORRAR 25/06
										
										if (horaLim != null && !horaLim.equals("")) {
											log.debug("horaLim != null y vacio");//BORRAR 25/06

											//cantidad de minutos de tardanza
											cantidad = Utiles
													.calculaAcumulado(
															medida,
											Utiles.stringToTimestamp(fing+ " "+ turno.getHoraIni()),
											Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()));
											log.debug("cantidad1:"+cantidad);//BORRAR 25/06
											

											if (cantidad < 0) cantidad *= -1;
											//EBV 05/01/2009
											//Si existe el movimiento pero le ponemos 1 a fin de que grabe
											if (cantidad == 0) cantidad = 1;
											//EBV 05/01/2009
											
											//acumulamos el diario
											acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
											acumulados.put(mov, acumDetalle);
											log.debug("total:"+total);//BORRAR 25/06
											log.debug("cantidad:"+cantidad);//BORRAR 25/06
											log.debug("acumDetalle:"+acumDetalle);//BORRAR 25/06
											
											//acumulamos el periodo
											float totPer = new Float(acumPer.get("total").toString()).floatValue();
											acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
											acumPeriodo.put(mov, acumPer);
											log.debug("totPer:"+totPer);//BORRAR 25/06
											log.debug("cantidad:"+cantidad);//BORRAR 25/06
											log.debug("acumPer:"+acumPer);//BORRAR 25/06
										}
									}

									//movimientos de refrigerio
									if (refrigerio) {
										log.debug("ingreso a refrigerioo");//BORRAR 25/06
										
										bPrimMarca = false;

										cantidad = Utiles
												.calculaAcumulado(
														medida,
										Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()),
										Utiles.stringToTimestamp(fing+ " "+ proceso.get("hsal").toString()));
										log.debug("procesoo:"+proceso);//BORRAR 25/06
										log.debug("cantidadd:"+cantidad);//BORRAR 25/06

										//ICR 18052015
										String movAnt="";
										if (j != 0){
											Map procesoAnt = (HashMap) detalles.get(j-1);
											movAnt = procesoAnt.get("mov")!= null ? procesoAnt.get("mov").toString().trim() : "";
										}
										//FIN ICR 18052015
										
										if (!movAnt.equals("") && !movAnt.equals(Constantes.MOV_EXCESO_REFRIGERIO)){ //ICR 18052015
											float totalRefri = 0; //linea add ICAPUNAY - PAS20175E230300069
											log.debug("mov anterior no es exceso:"+movAnt);//BORRAR 25/06
											if (mov.equals(Constantes.MOV_EXCESO_REFRIGERIO)) {
												//ICR 18052015	
												log.debug("es mov exceso refri_CAS");																					
												//cantidad -= turno.getMinutosRefrigerio();
												if (califClima!=null && califClima.size()>0){ //linea add ICAPUNAY - PAS20175E230300069
													totalRefri = new Float(((HashMap)acumulados.get(Constantes.MOV_REFRI_CLIMALABORAL)).get("total").toString()).floatValue();//linea add ICAPUNAY - PAS20175E230300069
												}else{ //linea add ICAPUNAY - PAS20175E230300069
													totalRefri = new Float(((HashMap)acumulados.get(Constantes.MOV_REFRIGERIO)).get("total").toString()).floatValue();
												}//linea add ICAPUNAY - PAS20175E230300069												
												float totalExceRefri = new Float(((HashMap)acumulados.get(Constantes.MOV_EXCESO_REFRIGERIO)).get("total").toString()).floatValue();
												log.debug("totalRefri_CAS: "+totalRefri);
												log.debug("totalExceRefri_CAS: "+totalExceRefri);
												//if (califClima!=null && califClima.size()>0){ //linea add ICAPUNAY - PAS20175E230300069
												if ((califClima!=null && califClima.size()>0) || (autoriClima!=null && !autoriClima.isEmpty())){ //linea add ICAPUNAY - PAS20175E230300069
													if (totalRefri+totalExceRefri+cantidad>minMaxClima){
														log.debug(">>>>>entro IF1 new");
														log.debug("cantidad: "+cantidad);
														log.debug("totalRefri+totalExceRefri+cantidad) - minMaxClima>>>>> ("+totalRefri+"+"+totalExceRefri+"+"+cantidad+") - "+minMaxClima+")");//ICR 18052015
														cantidad = (totalRefri+totalExceRefri+cantidad) - minMaxClima;
														log.debug("cantidad: "+cantidad);
														
														//obtenemos el movimiento de "refrigerio clima laboral" y seteamos en 120 el total
														acumDetalleRefri = (HashMap) acumulados.get(Constantes.MOV_REFRI_CLIMALABORAL);
														log.debug("acumDetalleRefri: "+acumDetalleRefri);
														acumDetalleRefri.put("total", ""+ (Math.round(minMaxClima)));
														acumulados.put(Constantes.MOV_REFRI_CLIMALABORAL, acumDetalleRefri);
														log.debug("acumDetalleRefri2: "+acumDetalleRefri);
														//acumulamos al periodo los 120 min por el movimiento de "refrigerio clima laboral" 
														acumPerRefri= (HashMap) acumPeriodo.get(Constantes.MOV_REFRI_CLIMALABORAL);												
														float totPer = new Float(acumPerRefri.get("total").toString()).floatValue();
														log.debug("totPer: "+totPer);
														log.debug("minMaxClima: "+minMaxClima);
														log.debug("totalRefri: "+totalRefri);
														acumPerRefri.put("total", "" + (Math.round(totPer + (minMaxClima-totalRefri))));
														acumPeriodo.put(Constantes.MOV_REFRI_CLIMALABORAL, acumPerRefri);
														log.debug("acumPerRefri: "+acumPerRefri);
														log.debug(">>>>>sale IF1");
													}	
													
												}else{//linea add ICAPUNAY - PAS20175E230300069
													if (totalRefri+totalExceRefri+cantidad>turno.getMinutosRefrigerio()){
														log.debug(">>>>>entro IF");
														log.debug("cantidad: "+cantidad);
														log.debug("totalRefri+totalExceRefri+cantidad) - turno.getMinutosRefrigerio()>>>>> ("+totalRefri+"+"+totalExceRefri+"+"+cantidad+") - "+turno.getMinutosRefrigerio()+")");//ICR 18052015
														cantidad = (totalRefri+totalExceRefri+cantidad) - turno.getMinutosRefrigerio();
														log.debug("cantidad: "+cantidad);
														
														//obtenemos el movimiento de refrigerio y seteamos en 60 el total
														acumDetalleRefri = (HashMap) acumulados.get(Constantes.MOV_REFRIGERIO);
														log.debug("acumDetalleRefri: "+acumDetalleRefri);
														acumDetalleRefri.put("total", ""+ (Math.round(turno.getMinutosRefrigerio())));
														acumulados.put(Constantes.MOV_REFRIGERIO, acumDetalleRefri);
														log.debug("acumDetalleRefri2: "+acumDetalleRefri);
														//acumulamos al periodo los 60 min por el movimiento de refrigerio 
														acumPerRefri= (HashMap) acumPeriodo.get(Constantes.MOV_REFRIGERIO);												
														float totPer = new Float(acumPerRefri.get("total").toString()).floatValue();
														log.debug("totPer: "+totPer);
														log.debug("turno.getMinutosRefrigerio(): "+turno.getMinutosRefrigerio());
														log.debug("totalRefri: "+totalRefri);
														acumPerRefri.put("total", "" + (Math.round(totPer + (turno.getMinutosRefrigerio()-totalRefri))));
														acumPeriodo.put(Constantes.MOV_REFRIGERIO, acumPerRefri);
														log.debug("acumPerRefri: "+acumPerRefri);
														log.debug(">>>>>sale IF");
													}	
												}//linea add ICAPUNAY - PAS20175E230300069													
												log.debug(">>>>>cantidad1: "+cantidad);
												//FIN ICR 18052015									
											}
										}//ICR 18052015
										
										log.debug(">>>>>cantidad2: "+cantidad);//ICR 18052015									
										log.debug(">>>>>(Math.round(total + cantidad)): Math.round("+total +"+" +cantidad+")");
										//acumulamos el diario
										acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
										acumulados.put(mov, acumDetalle);
										log.debug("total_CAS: "+total);//ICR 18052015
										log.debug("cantidad_CAS: "+cantidad);//ICR 18052015
										log.debug("mov exceso_CAS: "+mov);//ICR 18052015
										log.debug("acumDetalle_CAS: "+acumDetalle);//ICR 18052015
										//acumulamos el periodo
										float totPer = new Float(acumPer.get("total").toString()).floatValue();
										acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
										acumPeriodo.put(mov, acumPer);
										log.debug("totPer_CAS: "+totPer);//ICR 18052015
										log.debug("acumPer_CAS: "+acumPer);//ICR 18052015
										log.debug("acumPeriodo_CAS: "+acumPeriodo);//ICR 18052015
									}

									//movimientos de salida
									if (salida) {
										log.debug("ingreso a salida");//BORRAR 25/06
										bPrimMarca = false;

										if (proceso.get("hing") != null && !proceso.get("hing").toString().trim().equals(Constantes.SALIDA)) {
											log.debug("entro20");//BORRAR 25/06
											
											/****** JRR - 28/04/2009 *******/
											if (log.isDebugEnabled()) {
												log.debug("SALIDA");
												log.debug("fing + turno.getHoraFin(): " + fing+ " "+turno.getHoraFin());
												log.debug("fing + proceso.get('hing').toString(): " + fing+ " "+ proceso.get("hing").toString());
											}
											
											float minutos = Utiles.obtenerMinutosDiferencia(turno.getHoraIni(), proceso.get("hing").toString());
											if (log.isDebugEnabled()) log.debug("minutos: " + minutos);
											//Salida anticipada
											if (minutos <0) {
												log.debug("entro20.1");//BORRAR 25/06
												cantidad = Utiles
												.calculaAcumulado(
														medida,
														Utiles.stringToTimestamp(fing+ " "+ turno.getHoraIni()),
														Utiles.stringToTimestamp(fing+ " "+ turno.getHoraFin()));
												log.debug("fing + turno.getHoraIni(): " + fing+ " "+turno.getHoraIni());
												log.debug("fing + turno.getHoraFin(): " + fing+ " "+turno.getHoraFin());
												log.debug("cantidad:"+cantidad);//BORRAR 25/06
											} else {
												log.debug("entro20.2");//BORRAR 25/06
											/*****************************/

												cantidad = Utiles
												.calculaAcumulado(
														medida,
														Utiles.stringToTimestamp(fing+ " "+ turno.getHoraFin()),
														Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()));
												log.debug("cantidad2:"+cantidad);//BORRAR 25/06

											}

											if (log.isDebugEnabled()) log.debug("CANTIDAD antes de validar compensacion: " + cantidad);
											
											//en caso el turno sea onomastico se debe trabajar 1 hora mas
											cantidad-=turnoDAO.findHorasCompensa(dbpool,codPers,fReal);
											log.debug("cantidad disminuye:"+cantidad);//BORRAR 25/06

											//salida anticipada
											if (cantidad < 0) {
												cantidad *= -1;
											}
											
//											EBV 05/01/2009
											//Si existe el movimiento pero le ponemos 1 a fin de que grabe
											if (cantidad == 0) cantidad = 1;
											//EBV 05/01/2009

											//acumulamos el diario
											acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
											acumulados.put(mov, acumDetalle);
											log.debug("acumDetalle:"+acumDetalle);//BORRAR 25/06

											//acumulamos el periodo
											float totPer = new Float(acumPer.get("total").toString()).floatValue();
											acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
											acumPeriodo.put(mov, acumPer);
											log.debug("acumPer:"+acumPer);//BORRAR 25/06

										}
									}
									
									//en caso sean papeletas									
									if (tipo.trim().equals(Constantes.TIPO_MOV_PAPELETA)) {
										if (log.isDebugEnabled()) log.debug("Entre Papeletas CAS");
										if (indPap.equals("1")){ //Si esta Marcado el Flag de Incluir Papeletas
										procesarPapeleta = true;
										
										String horaIni = proceso.get("hing").toString();
										String horaFin = proceso.get("hsal")!=null?proceso.get("hsal").toString():"";
										if (log.isDebugEnabled()) log.debug("Entre Papeletas "+ horaIni +" - " + horaFin);
										if (horaFin == null || horaFin.equals("") || horaFin.trim().length()== 0) {
											log.debug("entro 30");//BORRAR 25/06
										    //primera marca
											if (log.isDebugEnabled()) log.debug("Primera Marca "+ bPrimMarca);
											if (bPrimMarca) {
												log.debug("entro 30.1");//BORRAR 25/06
												horaIni = turno.getHoraIni();
												horaFin = proceso.get("hing").toString();
											}
											//movimiento de salida
											else {
												log.debug("entro 30.2");//BORRAR 25/06
												bUltMarca=true;
												horaIni = proceso.get("hing").toString();
												horaFin = turno.getHoraFin();
											}
										} else //EBV 18/02/2009 Se pone en False la primera y ultima marca para los demas movimientos
										{
											bUltMarca=false;
											bUltMarca=false;
											log.debug("entro 30.3");//BORRAR 25/06
										}

										if (log.isDebugEnabled()) log.debug("Turno "+turno);
										if (log.isDebugEnabled()) log.debug("Proceso "+proceso);
										if (log.isDebugEnabled()) log.debug("Entre Papeletas "+ horaIni +" - " + horaFin);
										//si estan aceptadas
										if (proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_ACEPTADA)
											|| proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_PROCESADA)
											|| proceso.get("estado_id").toString().trim().equals(Constantes.ASISTENCIA_CALIFICADA)) {
											if (log.isDebugEnabled()) log.debug("Entre Papeletas Aceptadas Procesadas");
											if (horaFin != null && !horaFin.equals(Constantes.SALIDA)) {
												cantidad = Utiles
														.calculaAcumulado(
																Constantes.MINUTO,
												Utiles.stringToTimestamp(fing+ " "+ horaIni),
												Utiles.stringToTimestamp(fing+ " "+ horaFin));
												
												if (log.isDebugEnabled()) log.debug("Entre Papeletas CAS "+mov +" "+ cantidad);
												
												//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
												//papeleta permiso "particular con descuento" antes y despues del turno (solo se descontara lo que afecte el turno)
												if (mov.equals(Constantes.MOV_PERMISO_SIN_GOCE) || mov.equals(Constantes.MOV_PERM_PART_CON_DESCUENTO_100) ){ //ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia (permiso particular con descuento)
													log.debug("es papeleta perConDescuento03 o perConDescuento100_CAS");//ICR 18052015
													String horaIniTurno = turno.getHoraIni().trim();
													String horaFinTurno = turno.getHoraFin().trim();
													if(!horaFin.equals(horaFinTurno)){ //el proceso tiene que tener hora salida
														log.debug("hsal de movimiento es diferente hora fin turno_CAS");//ICR 18052015
														//entrada
														if(horaIni.compareTo(horaIniTurno)<0 &&
														   horaFin.compareTo(horaIniTurno)>0){
															log.debug("es perConDescuento03 o perConDescuento100 que afecta entrada_CAS");//ICR 18052015
															float cantidadDescontable = Utiles.calculaAcumulado(
																			Constantes.MINUTO,
																			Utiles.stringToTimestamp(fing+ " "+ horaIniTurno),
																			Utiles.stringToTimestamp(fing+ " "+ horaFin));
															cantidad = cantidadDescontable;													
														}
														//salida (pero despues se regresa)
														//if(horaIni.compareTo(horaFinTurno)<0 && ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
														if(( (horaIni.compareTo(horaFinTurno)<0) || (horaIni.compareTo(horaFinTurno)>0 && minRecuperacion==60)) && //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
														   horaFin.compareTo(horaFinTurno)>0){
															log.debug("es perConDescuento03 o perConDescuento100 que afecta salida_CAS");//ICR 18052015
															
															//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios												
															if (!horaFinTurno.substring(0,2).trim().equals("23")){//hora <> 23	
																log.debug("horaFinTurno anterior: "+horaFinTurno);
																if(minRecuperacion>0){ //ICAPUNAY - PAS20165E230300132 - MSNAAF071 (add solo esta linea)
																	//aumentando a la hora final del turno 1 hora por la hora de recuperacion
																	String shora = horaFinTurno.substring(0,2); //08 de 08:55:47
																	String sresto = horaFinTurno.substring(2,horaFinTurno.length()); //:55:47
																	int hora = Integer.parseInt(shora);														
																	hora = hora + 1; 
																	log.debug("hora aumentada: "+hora);
																	if (hora < 10){//anteponemos el 0 delante (caso2: 9)
																		shora = "0"+String.valueOf(hora)+sresto;// (caso2: 09:55:47)														
																	}else{
																		shora = String.valueOf(hora)+sresto;//14:55:47														
																	}	
																	horaFinTurno=shora;
																	log.debug("horaFinTurno con recuperacion: "+ horaFinTurno);	
																} //ICAPUNAY - PAS20165E230300132 - MSNAAF071 (add solo esta linea)		
															}else{//hora = 23
																horaFinTurno="23:59:59";
															}
															log.debug("horaFinTurno final: "+ horaFinTurno);
															log.debug("horaFin: "+ horaFin);
															//FIN ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
															
															if (horaFin.compareTo(horaFinTurno)>0){ //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
																float cantidadDescontable = Utiles.calculaAcumulado(
																				Constantes.MINUTO,
																				Utiles.stringToTimestamp(fing+ " "+ horaIni),
																				Utiles.stringToTimestamp(fing+ " "+ horaFinTurno));
																cantidad = cantidadDescontable;
															}//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios											
															
														}														
														log.debug("cantidad(perConDescuento03 o perConDescuento100 real)_CAS: "+cantidad);//ICR 18052015
													}
													//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
													else{
														log.debug("hsal de movimiento es IGUAL a hora fin turno_CAS");
														if(minRecuperacion>0){
															log.debug("es perConDescuento03 o perConDescuento100_minRecuperacion3:"+minRecuperacion);
															cantidad = cantidad + minRecuperacion;
														}
														log.debug("es perConDescuento03 o perConDescuento100_cantidad3:"+cantidad);
													}
													//FIN ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
												}
												//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
												
												if (cantidad > 480 && (mov.equals(Constantes.MOV_PERMISO_SIN_GOCE) || mov.equals(Constantes.MOV_PERM_PART_CON_DESCUENTO_100))){
													log.debug("cantidad > 480");//BORRAR 25/06
													recalifica = Constantes.MOV_INASISTENCIA;
													acumDetalle = (HashMap) acumulados.get(Constantes.MOV_INASISTENCIA);
													acumDetalle.put("total", "1");
													acumulados.put(Constantes.MOV_INASISTENCIA,acumDetalle);
													//	acumulamos del periodo
													acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_INASISTENCIA);
													float totPer = new Float(acumPer.get("total").toString()).floatValue();
													acumPer.put("total", "" + (totPer + 1));
													acumPeriodo.put(Constantes.MOV_INASISTENCIA, acumPer);
												} else{													
													//ICR 03/07/2015
													if (cantidad < 0) {
														cantidad *= -1;
													}
													//FIN ICR
													
													//acumulamos el diario
													log.debug("no sobrepasa 480(total diario):"+total);//BORRAR 25/06
													log.debug("no sobrepasa 480(cantidad diario):"+cantidad);//BORRAR 25/06
													acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
													acumulados.put(mov,acumDetalle);
													log.debug("no sobrepasa 480(acumDetalle):"+acumDetalle);//BORRAR 25/06
												
													//acumulamos el periodo
													float totPer = new Float(acumPer.get("total").toString()).floatValue();
													acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
													acumPeriodo.put(mov,acumPer);
													log.debug("no sobrepasa 480(totPer mensual):"+totPer);//BORRAR 25/06
													log.debug("no sobrepasa 480(cantidad mensual):"+cantidad);//BORRAR 25/06													
													log.debug("no sobrepasa 480(acumPer):"+acumPer);//BORRAR 25/06
												}
											}
										}
										//si estan rechazadas o registradas
										else if (proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_RECHAZADA)
											     || proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_REGISTRADA)) {
												log.debug("papeleta rechazada o generada");//BORRAR 25/06
								//EBV - 09072008 - Papeletas	
									           //se recalifica a un movimiento descontable
									            recalifica = Constantes.MOV_PAPELETA_NO_AUTORIZADA;									            
									           
									           if (horaFin != null && !horaFin.equals(Constantes.SALIDA)) {
									        	   log.debug("entro pap");//BORRAR 25/06
									 
									            if (bPrimMarca) {
									            	 log.debug("entro pap2");//BORRAR 25/06
									 
									             
									             String horaLim = turno.getHoraLimite();
									             
									             if (horaLim != null && !horaLim.equals("")) {
									            	 log.debug("entro precalentrada");//BORRAR 25/06
									              recalifica = preCalificarEntrada(
									                fing,
									                proceso.get("hing").toString(),
									                turno.getHoraIni(),
									                turno.getTolera(),
									                turno.getHoraLimite(),
									                Constantes.MINUTO);
									              //cantidad de minutos de tardanza
									              cantidad = Utiles
									                .calculaAcumulado(
									                	Constantes.MINUTO,
									              Utiles.stringToTimestamp(fing+ " "+ turno.getHoraIni()),
									              Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()));
									 
									              log.debug("recalifica ent:"+recalifica);//BORRAR 25/06
									              if (log.isDebugEnabled()) log.debug("acumulados-cantidad " + cantidad);
									              if (cantidad < 0) cantidad *= -1;
									              
									              acumDetalle = (HashMap) acumulados.get(recalifica);
									              total = new Float(acumDetalle.get("total").toString()).floatValue();
									              if (recalifica.equals(Constantes.MOV_INASISTENCIA)){
									               
									               acumDetalle.put("total", "1");
									               acumulados.put(Constantes.MOV_INASISTENCIA,acumDetalle);
									               // acumulamos del periodo
									               acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_INASISTENCIA);
									               float totPer = new Float(acumPer.get("total").toString()).floatValue();
									               acumPer.put("total", "" + (totPer + 1));
									               acumPeriodo.put(Constantes.MOV_INASISTENCIA, acumPer);
									              } else{
									              //acumulamos el diario
									              acumPer = (HashMap) acumPeriodo.get(recalifica);
									              acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
									              acumulados.put(recalifica, acumDetalle);
									              log.debug("acumDetalle ent:"+acumDetalle);//BORRAR 25/06
									              
									              //acumulamos el periodo
									              float totPer = new Float(acumPer.get("total").toString()).floatValue();
									              acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
									              acumPeriodo.put(recalifica, acumPer);
									              log.debug("acumPer ent:"+acumPer);//BORRAR 25/06
									              }
									             }
									            } else {
									            	log.debug("entro pap4");//BORRAR 25/06
									             cantidad = Utiles
									             .calculaAcumulado(
									               medida,
									             Utiles.stringToTimestamp(fing+ " "+ horaIni),
									             Utiles.stringToTimestamp(fing+ " "+ horaFin));
									             log.debug("cantidad pap4:"+cantidad);//BORRAR 25/06
									 
									             if (cantidad < 0) cantidad *= -1;
									             
									             // acumulamos el diario
									             if ((Constantes.TURNO_RS067).equals(turno.getTurno().trim())){
									            	 log.debug("entro RS67 pap4");//BORRAR 25/06
									            	 recalifica = Constantes.MOV_RESOLUCION_067;
								            	} else {
								            		log.debug("entro no es RS67 pap4");//BORRAR 25/06
								            		
								            		if (!bUltMarca) {
								            			log.debug("entro precalmovimiento");//BORRAR 25/06
								            			recalifica = preCalificarMovimiento(
									            				fing,
									            				horaIni,
									            				horaFin,
									            				turno,
									            				Constantes.MINUTO,
									            				false,
									            				turno.isOperativo());
								            			log.debug("recalifica calmov:"+recalifica);//BORRAR 25/06
								               			if (Utiles.obtenerDiasDiferencia(fechaIniNSA ,fing)>=0) {
/*EBV 25/03/2015 CAMBIO DE LINEAMIENTO
								               				if (recalifica.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
								               					recalifica = Constantes.MOV_SALIDA_AUTORIZADA;
								               					if (log.isDebugEnabled()) {
								               						log.debug("cambio insertamos en proceso " + recalifica);
								               					}
								               				}
*/
								               			}
								               			
								               			//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
														//salida no autorizada antes y despues del turno (solo se descontara lo que afecte el turno)
														if (recalifica.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)){ 
															log.debug("es SNA_CAS(papeleta generada)");//ICR 18052015
															String horaIniTurno = turno.getHoraIni().trim();
															String horaFinTurno = turno.getHoraFin().trim();
															if(!horaFin.equals(horaFinTurno)){ //el proceso tiene que tener hora salida
																log.debug("hsal de movimiento es diferente hora fin turno_CAS");//ICR 18052015
																//entrada
																if(horaIni.compareTo(horaIniTurno)<0 &&
																   horaFin.compareTo(horaIniTurno)>0){
																	log.debug("es SNA que afecta entrada_CAS");//ICR 18052015
																	float cantidadDescontable = Utiles.calculaAcumulado(
																					Constantes.MINUTO,
																					Utiles.stringToTimestamp(fing+ " "+ horaIniTurno),
																					Utiles.stringToTimestamp(fing+ " "+ horaFin));
																	cantidad = cantidadDescontable;													
																}
																//salida (pero despues se regresa)
																if(horaIni.compareTo(horaFinTurno)<0 &&
																   horaFin.compareTo(horaFinTurno)>0){
																	log.debug("es SNA que afecta salida_CAS");//ICR 18052015
																	float cantidadDescontable = Utiles.calculaAcumulado(
																					Constantes.MINUTO,
																					Utiles.stringToTimestamp(fing+ " "+ horaIni),
																					Utiles.stringToTimestamp(fing+ " "+ horaFinTurno));
																	cantidad = cantidadDescontable;
																}
																log.debug("cantidad(SNA real)_CAS: "+cantidad);//ICR 18052015
															}
														}
														//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia																		            
								            	
								            		}
								            		else{
								            			log.debug("entro precalsalida");//BORRAR 25/06
														recalifica = preCalificarSalida(
																dbpool,
																codPers,
																fing,
																horaIni,
																horaFin,
																Constantes.MINUTO);
														log.debug("recalifica sali:"+recalifica);//BORRAR 25/06
								            		}
								            	}
									             

									             acumDetalle = (HashMap) acumulados.get(recalifica);
									             total = new Float(acumDetalle.get("total").toString()).floatValue();
									             acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
									             acumulados.put(recalifica,acumDetalle);
									             log.debug("acumDetalle final:"+acumDetalle);//BORRAR 25/06
									             if (log.isDebugEnabled()) log.debug("acumulados" + acumulados);
									             // acumulamos el periodo
									             acumPer = (HashMap) acumPeriodo.get(recalifica);
									             float totPer = new Float(acumPer.get("total").toString()).floatValue();
									             acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
									             acumPeriodo.put(recalifica,acumPer);
									             log.debug("acumPer final:"+acumPer);//BORRAR 25/06
									             //}
									             log.debug("entro fin pap4");//BORRAR 25/06
									            }
									           }
									          }
								//fin Papeletas EBV	
									
									//las papeletas se cambian a estado procesada									
									if (procesarPapeleta) {
										
										//PRAC-JCALLO
										Map prms = new HashMap();
										prms.put("cod_pers", codPers);
										prms.put("periodo", proceso.get("periodo").toString());//proceso.getPeriodo());
										prms.put("fechaIni", fing);//proceso.getFechaIni());
										prms.put("horaIni", proceso.get("hing").toString());//proceso.getHoraIni());
										prms.put("mov", recalifica);
										prms.put("estado", Constantes.PAPELETA_PROCESADA);
										if (log.isDebugEnabled()) log.debug("asisDAO.updatePapeletaByFecha(prms)... prms:"+prms);
										
								//JRR - 18072008 Papeletas v2
								        if ( (!proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_REGISTRADA)) &&
									            (!proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_RECHAZADA)) ) {
									           asisDAO.updatePapeletaByFecha(prms);
									          }
										
										
										log_papeleta.info("Proceso|".
												concat(codPers).
												concat("|").
												concat(fing).
												concat("|").
												concat(proceso.get("hing").toString()).
												concat("|").
												concat(proceso.get("mov").toString()).
												concat("|").
												concat(recalifica)
										);										
									}
										}
										//EBV 16/02/2009 Se pone en False la primera marca para los demas movimientos
										bPrimMarca = false;
									}

									//en caso sea otro tipo de movimiento
									if (!movEspecial) {
										bPrimMarca = false;

										if (log.isDebugEnabled()) log.debug("Entro Mov. Especial" + movEspecial);
										String horaFinal = proceso.get("hsal").toString();
										
										if (horaFinal == null || horaFinal.equals("") || horaFinal.trim().length()== 0) {
											horaFinal = turno.getHoraFin();
										}
										
										cantidad = Utiles
												.calculaAcumulado(
														Constantes.MINUTO,
										Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()),
										Utiles.stringToTimestamp(fing+ " "+ horaFinal));
										log.debug("otro Mov(cas)_cantidad:"+cantidad);// ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
										
										//ICR 18052015
										//salida no autorizada antes y despues del turno (solo se descontara lo que afecte el turno)
										if (mov.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)){ 
											log.debug("es SNA_CAS");//ICR 18052015
											String horaIniTurno = turno.getHoraIni().trim();
											String horaFinTurno = turno.getHoraFin().trim();
											String horaIniProceso = proceso.get("hing").toString().trim();
											String horaFinProceso = horaFinal.trim();
											if(!horaFinProceso.equals(horaFinTurno)){ //el proceso tiene que tener hora salida
												log.debug("hsal de movimiento es diferente hora fin turno_CAS");//ICR 18052015
												//entrada
												if(horaIniProceso.compareTo(horaIniTurno)<0 &&
												   horaFinProceso.compareTo(horaIniTurno)>0){
													log.debug("es SNA que afecta entrada_CAS");//ICR 18052015
													float cantidadDescontable = Utiles.calculaAcumulado(
																	Constantes.MINUTO,
																	Utiles.stringToTimestamp(fing+ " "+ horaIniTurno),
																	Utiles.stringToTimestamp(fing+ " "+ horaFinProceso));
													cantidad = cantidadDescontable;													
												}
												//salida (pero despues regresa o no)
												//if(horaIniProceso.compareTo(horaFinTurno)<0 &&  ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
												if(( (horaIniProceso.compareTo(horaFinTurno)<0) || (horaIniProceso.compareTo(horaFinTurno)>0 && minRecuperacion==60)) &&  //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
												   horaFinProceso.compareTo(horaFinTurno)>0){ 
													log.debug("es SNA que afecta salida_cas");//ICR 18052015
													
													//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios												
													if (!horaFinTurno.substring(0,2).trim().equals("23")){//hora <> 23	
														log.debug("horaFinTurno anterior: "+horaFinTurno);
														if(minRecuperacion>0){ //ICAPUNAY - PAS20165E230300132 - MSNAAF071 (add solo esta linea)
															//aumentando a la hora final del turno 1 hora por la hora de recuperacion
															String shora = horaFinTurno.substring(0,2); //08 de 08:55:47
															String sresto = horaFinTurno.substring(2,horaFinTurno.length()); //:55:47
															int hora = Integer.parseInt(shora);														
															hora = hora + 1; 
															log.debug("hora aumentada: "+hora);
															if (hora < 10){//anteponemos el 0 delante (caso2: 9)
																shora = "0"+String.valueOf(hora)+sresto;// (caso2: 09:55:47)														
															}else{
																shora = String.valueOf(hora)+sresto;//14:55:47														
															}	
															horaFinTurno=shora;
															log.debug("horaFinTurno con recuperacion: "+ horaFinTurno);	
														} //ICAPUNAY - PAS20165E230300132 - MSNAAF071 (add solo esta linea)	
													}else{//hora = 23
														horaFinTurno="23:59:59";
													}
													log.debug("horaFinTurno final: "+ horaFinTurno);
													log.debug("horaFinProceso: "+ horaFinProceso);
													//FIN ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
													
													if (horaFinProceso.compareTo(horaFinTurno)>0){ //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
													
														float cantidadDescontable = Utiles.calculaAcumulado(
																		Constantes.MINUTO,
																		Utiles.stringToTimestamp(fing+ " "+ horaIniProceso),
																		Utiles.stringToTimestamp(fing+ " "+ horaFinTurno));
														cantidad = cantidadDescontable;														
													}//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios	
												}
												log.debug("cantidad(SNA real)_cas: "+cantidad);//ICR 18052015
											}
											//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
											else{
												log.debug("hsal de movimiento es IGUAL a hora fin turno_CAS");
												if(minRecuperacion>0){
													log.debug("otro Mov(cas)_minRecuperacion3:"+minRecuperacion);
													cantidad = cantidad + minRecuperacion;
												}
												log.debug("otro Mov(cas)_cantidad3:"+cantidad);
											}
											//FIN ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
										}
										//FIN ICR 18052015
										
										//acumulamos el diario
										if (log.isDebugEnabled()) log.debug("Total: " + total);
										if (log.isDebugEnabled()) log.debug("Cantidad: " + cantidad);
										
										if (cantidad <0) cantidad = cantidad*(-1);

										//Descomentar si no funciona EBV 02/10/2008
										acumDetalle = (HashMap) acumulados.get(mov);
							            total = new Float(acumDetalle.get("total").toString()).floatValue();
							            
										acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
										acumulados.put(mov, acumDetalle);
										log.debug("acumDetalle mov especial:"+acumDetalle);//BORRAR 25/06
										
										//acumulamos del periodo
										float totPer = new Float(acumPer.get("total").toString()).floatValue();
										acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
										
										
										acumPeriodo.put(mov, acumPer);
										log.debug("acumPer mov especial:"+acumPer);//BORRAR 25/06
										
									}
								}
							}
						} //end del for de detalles de movimientos del dia
						
					} else {
						//el trabajador no posee calificaciones
						bInasistencia = turno.isControla();
						//EBV Turno Rs 067 - 24/09/2007
						if ((Constantes.TURNO_RS067).equals(turno.getTurno().trim())){
							bInasistencia = true;
						}
				    //EBV-JRR Turnos sin marcaciones - 24/09/2008						
						else {
							   if (log.isDebugEnabled()) log.debug("Turnos sin marcaciones y no es R67");
						       if ((!turno.isControla())&& diaLaborable){
						        acumDetalle = (HashMap) acumulados.get(Constantes.MOV_TRABAJO_CAMPO);
						        acumDetalle.put("total", "1");
						        acumulados.put(Constantes.MOV_TRABAJO_CAMPO,acumDetalle);
						        //acumulamos del periodo
						        acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_TRABAJO_CAMPO);
						        float totPer = new Float(acumPer.get("total").toString()).floatValue();
						        acumPer.put("total", "" + (totPer + 1));
						        acumPeriodo.put(Constantes.MOV_TRABAJO_CAMPO, acumPer);
						        
						       } 
						      }
					//		
						

					}
					
					//si no es un dia laborable 
					if (!diaLaborable) bInasistencia = false;
						
				} else {
					
					bInasistencia = true;
					//no posee turno					
					if (turno==null) bInasistencia = false;
					//esta de vacaciones o licencia					
					else if (bVacacion || bLicencia) bInasistencia = false;					
				}
				
				//si falto ese dia
				if (bInasistencia) {
					
					//output.println("El trabajador no asistio el " + fReal);

					//obtenemos el movimiento de vacaciones e incrementamos el numero de dias
					acumDetalle = (HashMap) acumulados.get(Constantes.MOV_INASISTENCIA);
					acumDetalle.put("total", "1");
					acumulados.put(Constantes.MOV_INASISTENCIA,acumDetalle);
					//acumulamos del periodo
					acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_INASISTENCIA);
					float totPer = new Float(acumPer.get("total").toString()).floatValue();
					acumPer.put("total", "" + (totPer + 1));
					acumPeriodo.put(Constantes.MOV_INASISTENCIA, acumPer);
				}

				//Aqui debemos incluir el acumulado del movimiento 98 - Tardanza Efectiva para 
				//que sea igual al exceso de la Tardanza Con Descuento
				if (log.isDebugEnabled()) log.debug("Calculando tardanza efectiva");
				acumDetalle = (HashMap) acumulados.get(Constantes.MOV_TARDANZA_CON_DESCUENTO);
				float totDetalle = new Float(acumDetalle.get("total").toString()).floatValue();
				if (log.isDebugEnabled()) log.debug("Total Tardanza C/Desc : "+totDetalle);
				if (totDetalle>0){
					acumDetalle = (HashMap) acumulados.get(Constantes.MOV_TARDANZA_EFECTIVA);
					float totTardEfect = totDetalle-turno.getTolera();
					if (log.isDebugEnabled()) log.debug("Total Tardanza Efectiva : "+totTardEfect);
					acumDetalle.put("total", ""+totTardEfect);
					acumulados.put(Constantes.MOV_TARDANZA_EFECTIVA,acumDetalle);
					//vamos acumulando en el acumPeriodo el total del movimiento 98
					acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_TARDANZA_EFECTIVA);
					float totPer = new Float(acumPer.get("total").toString()).floatValue();
					acumPer.put("total", "" + (totPer + totTardEfect));
					acumPeriodo.put(Constantes.MOV_TARDANZA_EFECTIVA, acumPer);					
				}
				
				//registramos el resumen del dia
				for (int z = 0; z < movimientos.size(); z++) {

					BeanTipoMovimiento mov = (BeanTipoMovimiento) movimientos.get(z);
					HashMap acumulado = (HashMap) acumulados.get(mov.getMov().trim());
					if (log.isDebugEnabled()) log.debug("Acumulado " + acumulado);
					if (acumulado != null) {
						float total = new Float(acumulado.get("total").toString()).floatValue();
						if (log.isDebugEnabled()) log.debug("Total " + total);
						//Comentado EBV-..28/02/2006 -- Se insertan todos los movientos que se tienen para ese periodo.
						if (total > 0) {
							if (log.isDebugEnabled()) log.debug("DIARIO : " + mov.getDescrip()+ " - Total : " + total);
							//EBV 16/05/2006 Se Redondean los montos
							total = Math.round(total);
							if (log.isDebugEnabled()) log.debug("RESUMEN REDONDEO : " + mov.getDescrip()+ " - Total : " + total);
							diarioDAO.insertByCodPersPeriodoMov(dbpool,codPers, periodo, fReal, codUO, mov.getMov().trim(), total, usuario);
						}
						acumulado.put("total", "0");
						acumulados.put(mov.getMov(), acumulado);
					}
				} //for registro diario
				
				if (fReal.indexOf("/")>3){ 
					fReal = fReal.substring(8,10) + "/" + fReal.substring(5,7) + "/" + fReal.substring(0,4) ;
				}
				
				fReal =  Utiles.dameFechaSiguiente(fReal, 1);
				fAct = Utiles.toYYYYMMDD(fReal);
			}

			//aqui debemos validar el tema de la tardanza efectiva
			HashMap acumTardCDesc = (HashMap) acumPeriodo.get(Constantes.MOV_TARDANZA_CON_DESCUENTO);
			HashMap acumTardSDesc = (HashMap) acumPeriodo.get(Constantes.MOV_TARDANZA_SIN_DESCUENTO);
			
			//T99DAO codigoDAO = new T99DAO();
			String minutosSinDesc = codigoDAO.findParamByCodTabCodigo(dbpool,
					Constantes.CODTAB_PARAMETROS_ASISTENCIA,
					Constantes.MINUTOS_SIN_DESCUENTO);
			int minSinDesc = minutosSinDesc != null ? Integer.parseInt(minutosSinDesc) : 0;
			
			if (log.isDebugEnabled()) log.debug("minSinDesc : "+minSinDesc);
			
			float tTardanzaCDesc = new Float(acumTardCDesc.get("total").toString()).floatValue();
			if (log.isDebugEnabled()) log.debug("tTardanzaCDesc : "+tTardanzaCDesc);
			float tTardanzaSDesc = new Float(acumTardSDesc.get("total").toString()).floatValue();
			if (log.isDebugEnabled()) log.debug("tTardanzaSDesc : "+tTardanzaSDesc);
			boolean bTardanza = (tTardanzaSDesc + tTardanzaCDesc) > minSinDesc;
			if (log.isDebugEnabled()) log.debug("bTardanza : "+bTardanza);
			
			//si el trabajador sobrepaso el limite de minutos, se actualiza el detalle del resumen diario
			if (bTardanza){
				
				fAct = fIni;
				fReal = fechaIni;
				if (fReal.indexOf("/")>3){ 
					fReal = fReal.substring(8,10) + "/" + fReal.substring(5,7) + "/" + fReal.substring(0,4) ;
				}
				
				acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_TARDANZA_EFECTIVA);
				float totPer1 = new Float("0").floatValue();
				acumPer.put("total", "" + (totPer1));
				acumPeriodo.put(Constantes.MOV_TARDANZA_EFECTIVA, acumPer);
				
				//recorremos todos los dias del periodo 
				while (fAct.compareTo(fFin) <= 0) {
					
					if (log.isDebugEnabled()) log.debug("fReal : "+fReal);
					
					//obtenemos el turno del trabajador para la fecha en proceso
					turno = turnoDAO.joinWithT45ByCodFecha(dbpool, codPers, fReal);
					
					//14/01/2009
					if (turno!=null) {

						float minTardanza = 0;
						float tTardCDesc = diarioDAO.findDescuentoDiarioMovimiento(
								dbpool, codPers, fReal, Constantes.MOV_TARDANZA_EFECTIVA);

						if (log.isDebugEnabled()) log.debug("Recalculando tTardCDesc : "+tTardCDesc);

						if (tTardCDesc>0){
							minTardanza = turno.getTolera()+tTardCDesc;
						}
						else{
							//EBV - 16/12/2008
							float tTardConDesc = diarioDAO.findDescuentoDiarioMovimiento(
									dbpool, codPers, fReal, Constantes.MOV_TARDANZA_CON_DESCUENTO);
							if (tTardConDesc==turno.getTolera()){
								minTardanza = turno.getTolera()+tTardCDesc;	
							}
							if (log.isDebugEnabled()) log.debug("Recalculando minTardanza : "+minTardanza);
							//

							float tTardSDesc = diarioDAO.findDescuentoDiarioMovimiento(
									dbpool, codPers, fReal, Constantes.MOV_TARDANZA_SIN_DESCUENTO);
							if (tTardSDesc>0) minTardanza = tTardSDesc;

							if (log.isDebugEnabled()) log.debug("Recalculando tTardSDesc : "+tTardSDesc);
						}

						if (log.isDebugEnabled()) log.debug("Recalculando minTardanza : "+minTardanza);

						if (minTardanza>0){

							//acumulamos a los minutos del movimiento 98 los minutos de tolerancia del turno para ese dia
							boolean hayMinTardEfect = diarioDAO.updateTardanzaEfectiva(
									dbpool,
									codPers, 
									periodo, 
									fReal, 
									Constantes.MOV_TARDANZA_EFECTIVA, 
									minTardanza);

							if (log.isDebugEnabled()) log.debug("hayMinTardEfect : "+hayMinTardEfect);

							if (!hayMinTardEfect){
								diarioDAO.insertByCodPersPeriodoMov(
										dbpool,
										codPers, 
										periodo, 
										fReal, 
										codUO, 
										Constantes.MOV_TARDANZA_EFECTIVA, 
										minTardanza, 
										usuario);
							}

							//actualizamos el acumulado en el acumPeriodo el total del movimiento 98
							acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_TARDANZA_EFECTIVA);
							float totPer = new Float(acumPer.get("total").toString()).floatValue();
							acumPer.put("total", "" + (totPer + minTardanza));
							acumPeriodo.put(Constantes.MOV_TARDANZA_EFECTIVA, acumPer);						
						}

					}
					
					if (fReal.indexOf("/")>3){ 
						fReal = fReal.substring(8,10) + "/" + fReal.substring(5,7) + "/" + fReal.substring(0,4) ;
					}
					
					fReal =  Utiles.dameFechaSiguiente(fReal, 1);
					fAct = Utiles.toYYYYMMDD(fReal);					
				}
			}
			
			
			//registramos el resumen del periodo del trabajador
			for (int k = 0; k < movimientos.size(); k++) {
			
				BeanTipoMovimiento mov = (BeanTipoMovimiento) movimientos.get(k);
				HashMap acumulado = (HashMap) acumPeriodo.get(mov.getMov().trim());
				
				if (acumulado != null) {
					
					float total = new Float(acumulado.get("total").toString()).floatValue();
					
					//Comentado EBV-..28/02/2006 -- Se insertan todos los movientos que se tienen para ese periodo.
					if (total > 0) {
						if (log.isDebugEnabled()) log.debug("RESUMEN : " + mov.getDescrip()+ " - Total : " + total);
						//EBV 16/05/2006 Se Redondean los montos
						total = Math.round(total);
						if (log.isDebugEnabled()) log.debug("RESUMEN REDONDEO : " + mov.getDescrip()+ " - Total : " + total);
						resumenDAO.insertByCodPersPeriodoMov(dbpool, codPers,periodo, codUO, mov.getMov().trim(),total,usuario);
					}
					acumulado.put("total", "0");
					acumPeriodo.put(mov.getMov(), acumulado);
				}
			} //for registro mensual

			
		} catch (Exception e) {
			log.fatal("Error en el proceso del trabajador "+codPers+" : " + e.getMessage(),e);						
			throw new RemoteException(e.toString());
		}
		return res;
	}

	
	//ASANCHEZZ 20100426
	/**
	 * Metodo encargado del registro de la asistencia de una trabajador CAS para un determinado dia
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="RequiresNew"
	 * @param params
	 * @return
	 * @throws RemoteException
	 */
	public void generarAsistenciaTrabajadorCAS(Map params)
	throws IncompleteConversationalState, RemoteException {

	if (log.isDebugEnabled()) log.debug("inicio de metodo ProcesoFacade - generarAsistenciaTrabajadorCAS");
	
	Map mapa = (HashMap)params.get("mapa");
	Map beanPersona = (HashMap)params.get("beanPersona");
	Map fechas = (HashMap)params.get("fechas");
	String usuario = params.get("usuario").toString();

	ArrayList listaMarcaciones = null;

	BeanMarcacion bMarcacion = null;
	BeanMarcacion bMSgte = null;

	String fechaEval = "";
	String codPers = "";
	String codUO = "";
	String periodo = "";
	String fechaMarcacion = "";
	String horaMarcacion = "";
	String fechaFinMov = "";
	String horaFinMov = "";
	String relojIni = "";
	String relojFin = "";
	String tMov = "";
	String dbpool = "";
	String fechaNSA = (String)fechas.get("FechaNSA");
	
	BeanTurnoTrabajo turno = null;

	T1270DAO daoTurno = new T1270DAO();
	dbpool = (String) mapa.get("dbpool");
	T1271DAO asisDAO = new T1271DAO(dbpool);
	T01DAO paramDAO = new T01DAO();
	T1275DAO daoMarcacion = new T1275DAO();	//ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)
	T99DAO codigoDAO = new T99DAO(); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
	T8167DAO climaLabDAO = new T8167DAO(dbpool); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
	

	boolean tieneRefrigerio = false;
	boolean tieneRefrigerioW = false;//NUEVO
	//boolean bOperativo = false; //ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)
	boolean bControla = true;
	boolean generar = true;
	boolean diaEspecial = false;

	try{
		fechaEval = (String) mapa.get("fechaEval");
		periodo = (String) mapa.get("periodo");
		codPers = (String) beanPersona.get("t02cod_pers");
		codUO = (String) beanPersona.get("t02cod_uorg");
		//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
		String isProcesar = (String) params.get("isProcesar");
		isProcesar = isProcesar!=null?isProcesar:"NO";
		List papeletasGeneradas= null;
		//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
		
		//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
		String climaLab = codigoDAO.findParamByCodTabCodigo(dbpool,Constantes.CODTAB_PARAMETROS_ASISTENCIA,Constantes.MINUTOS_MAXIMO_CLIMALABORAL);
		int minMaxClima = climaLab != null ? Integer.parseInt(climaLab) : 0;
		log.debug("minMaxClima: " + ""+minMaxClima);		
		Map autoriClima = null;
		boolean procesaClima = false;
		boolean refriClima = false; //new
		boolean excesoClima = false; //new
		String estadoAut = "";//new
		Map prms=new HashMap(); //new
		pe.gob.sunat.rrhh.dao.CorreoDAO correoDAO = new pe.gob.sunat.rrhh.dao.CorreoDAO(dbpool);//new
		String cod_auto=""; //new
		String nomApell="";	//new	
		String correoColab="";//new
		String correoAutoriz="";//new
		String mensaje = "";//new		
		String mensajeF = "";//new
		Map mParams = new HashMap();//new
		//mParams.put("fec_correo",new FechaBean().getFormatDate("dd/MM/yyyy"));//fecha envio correo
		//ICAPUNAY - PAS20175E230300069
		
		DataSource ds = ServiceLocator.getInstance().getDataSource(dbpool);
		pe.gob.sunat.rrhh.asistencia.dao.T1271DAO t1271dao = new  pe.gob.sunat.rrhh.asistencia.dao.T1271DAO(ds);
	     
		 //en caso las marcaciones del dia aun no han sido calificadas
	    if (log.isDebugEnabled()) log.debug("generar:"+generar);
	    
	    //if (generar && turno!=null){//ICAPUNAY 13/06/2012 PASE 2012-381 AJUSTES A CALIFICACION DE ASISTENCIA
	    if (generar){//ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)
	    	if (log.isDebugEnabled()) log.debug("generar true");//LOG GENERACION
		    		    
		    //ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)
		    BeanMarcacion bMarcacion2 = null;
			BeanMarcacion bMSgte2 = null;
			String fechaMarcacion2 = "";
			String horaMarcacion2 = "";
			String fechaFinMov2 = "";
			String horaFinMov2 = "";
			String relojIni2 = "";
			String relojFin2 = "";
			String tMov2 = "";
			String movAct = ""; //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
			boolean bOperativo2 = false;
			boolean bOperativoW = false;//NUEVO			
		    
		    BeanTurnoTrabajo turnoDx = null;
		    String fechaAntes = "";
		    String horaIniTurnoDw = "";
			String horaFinTurnoDw = "";
			String horaIniTurnoDx = "";
			String horaFinTurnoDx = "";
			BeanTurnoTrabajo turno1 = daoTurno.joinWithT45ByCodPersFecha_Controlado_OperAdm1dia(dbpool,codPers.trim(),fechaEval);		    
			if (turno1!=null){
				turnoDx=turno1;					    
			}else{
				BeanTurnoTrabajo turno2 = daoTurno.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,codPers.trim(),fechaEval);
				turnoDx=turno2;				    
			}
			if (log.isDebugEnabled()) log.debug("turnoDx("+fechaEval+"): " + "("+codPers+"): "+turnoDx);
						
			if (turnoDx!=null){
				if (log.isDebugEnabled()) log.debug("tiene turno dia x");
				horaIniTurnoDx = turnoDx.getHoraIni().trim();
				horaFinTurnoDx = turnoDx.getHoraFin().trim();
				bOperativo2 = turnoDx.isOperativo();
				if (log.isDebugEnabled()) log.debug("horaIniTurnoDx("+codPers+"): " + horaIniTurnoDx);
				if (log.isDebugEnabled()) log.debug("horaFinTurnoDx("+codPers+"): " + horaFinTurnoDx);  
				if(horaFinTurnoDx.trim().compareTo(horaIniTurnoDx.trim())>0){ //adm u ope 1 dia
					if (log.isDebugEnabled()) log.debug("horaFinTurnoDx>horaIniTurnoDx(adm u ope 1 dia)");
					fechaAntes = Utiles.dameFechaAnterior(fechaEval, 1);	    		   
					BeanTurnoTrabajo turnoDw = daoTurno.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,codPers,fechaAntes); //dia (x-1)
					if (log.isDebugEnabled()) log.debug("turno1 dia x-1 (turnoDw)("+codPers+"): " + turnoDw);
					if (turnoDw!=null){	
						
						//ICAPUNAY 23/02/2015 AJUSTES GENERACION ASISTENCIA (caso SES: SI turno (dia x-1) de 2 dias y SI turno dia x de 1 d涌(marcaciones IMPARES requiere para dia x))
						if (log.isDebugEnabled()) log.debug("registro("+codPers+"): SI turno (dia x-1) de 2 dias y SI turno dia x de 1 dia(marcaciones IMPARES requiere para dia x)_CAS");
						horaIniTurnoDw = turnoDw.getHoraIni().trim();
						horaFinTurnoDw = turnoDw.getHoraFin().trim();
						bOperativoW = turnoDw.isOperativo();//NUEVOO						
						tieneRefrigerio = false;//NUEVOO
						tieneRefrigerioW = false;//NUEVOO
						if (log.isDebugEnabled()) log.debug("horaIniTurnoDw_SES("+codPers+"): " + horaIniTurnoDw);
						if (log.isDebugEnabled()) log.debug("horaFinTurnoDw_SES("+codPers+"): "+ horaFinTurnoDw);												
						//impar requiere (par es omision cuando no puede calificar) //solo S,E,S	//reg 9793(CAS)-28/01/15	
						
						//NUEVOO CAS
						listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
						if (log.isDebugEnabled()) log.debug("listaMarcaciones_SES:"+listaMarcaciones);
						if (listaMarcaciones != null && listaMarcaciones.size() > 0) {
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral												
							autoriClima=climaLabDAO.findAutorizaByRegByFecha(codPers, fechaEval);
							log.debug("autoriClima f: "+autoriClima);							
							if (autoriClima!=null && !autoriClima.isEmpty()){
								procesaClima=true;
							}
							//ICAPUNAY - PAS20175E230300069
							
							int j=0;							
							boolean esPareja=false;
							boolean tieneSalidaW=false;
							boolean tieneEntradaX=false;
							boolean tieneSalidaX=false;//DESARROLLAR PARA ESTE
							Map calificacion = new HashMap();
							for (int i = 0; i <= listaMarcaciones.size()-1; i++) {
								esPareja=false;
								if (log.isDebugEnabled()) log.debug("i_SES:"+i);
								bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
								fechaMarcacion2 = bMarcacion2.getFecha();//28/01/15
								horaMarcacion2 = bMarcacion2.getHora();//01:00:00
								relojIni2 = bMarcacion2.getReloj();
								relojFin2 = "";
								fechaFinMov2= "";
								if (log.isDebugEnabled()) log.debug("i_SES:"+i);								
								if (log.isDebugEnabled()) log.debug("fechaMarcacion_SES("+i+"):"+fechaMarcacion2);
								if (log.isDebugEnabled()) log.debug("horaMarcacion_SES("+i+"):"+horaMarcacion2);
							
								if (i<=listaMarcaciones.size()-2){//i<=7(9 total)										
									j=i+1;	//i=0/j=1								
									bMSgte2 = (BeanMarcacion) listaMarcaciones.get(j);							
									fechaFinMov2 = bMSgte2.getFecha();//28/01/15
									horaFinMov2 = bMSgte2.getHora();//05:00:00
									relojFin2 = bMSgte2.getReloj();
									if (log.isDebugEnabled()) log.debug("j(i+1) SES:"+j);									
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 int_SES :"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 int_SES:"+horaFinMov2);								
																			
									if(horaMarcacion2.trim().compareTo(horaFinTurnoDw.trim())<0){
										if (log.isDebugEnabled()) log.debug("entro 1_SES");
										if (horaFinMov2.trim().compareTo(horaFinTurnoDw.trim())<0){
											if (log.isDebugEnabled()) log.debug("entro 1.1_SES");
											esPareja=true;										
											i=j;
											if (log.isDebugEnabled()) log.debug("j_SES:"+j);
											if (log.isDebugEnabled()) log.debug("i_SES:"+i);
										}else{//horaFinMov2>=horaFinTurnoDw
											if (log.isDebugEnabled()) log.debug("entro 1.2_SES");
											if (tieneSalidaW==false){
												if (log.isDebugEnabled()) log.debug("entro 1.3_SES");
												tMov2 = preCalificarSalidaOpe1(
														dbpool,
														codPers,
														fechaMarcacion2,
														horaMarcacion2,
														turnoDw.getHoraFin(),
														Constantes.MINUTO);
												if (log.isDebugEnabled()) log.debug("salida66 preCalificarSalidaOpe1(tMov2) SES:"+tMov2);					
												horaFinMov2 = "";
												//ICR 18052015
												if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
													horaFinMov2=turnoDw.getHoraFin();
												}
												//ICR 18052015
												tieneSalidaW=true;											
												if (log.isDebugEnabled()) log.debug("tieneSalidaW_SES:"+tieneSalidaW);
												if (log.isDebugEnabled()) log.debug("j_SES:"+j);
												if (log.isDebugEnabled()) log.debug("i_SES:"+i);
											}	
										}										
									}else{//horaMarcacion2>=horaFinTurnoDw //revisando
										if (log.isDebugEnabled()) log.debug("entro 2_SES");
										//ok9
										if (horaMarcacion2.trim().compareTo(horaIniTurnoDx.trim())<=0){//revisando
											if (log.isDebugEnabled()) log.debug("entro 2.1_SES");
											if (tieneSalidaW==false){
												if (log.isDebugEnabled()) log.debug("entro 2.2_SES");
												tMov2 = Constantes.SALIDA_NORMAL; //salida
												tieneSalidaW=true;											
												horaFinMov2 = "";
												if (log.isDebugEnabled()) log.debug("i antes_SES:"+i);												
											}else{//tieneSalidaW==true
												if (log.isDebugEnabled()) log.debug("entro 2.3_SES");
												if (horaFinMov2.trim().compareTo(horaIniTurnoDx.trim())<=0){
													if (log.isDebugEnabled()) log.debug("entro 2.4_SES");
													esPareja=true;												
													i=j;
													if (log.isDebugEnabled()) log.debug("j_SES:"+j);
													if (log.isDebugEnabled()) log.debug("i_SES:"+i);
												}else{//horaFinMov2>horaIniTurnoDx
													if (log.isDebugEnabled()) log.debug("entro 2.5_SES");
													if (tieneEntradaX==false){
														if (log.isDebugEnabled()) log.debug("entro 2.6_SES");
														tMov2 = Constantes.ENTRADA_NORMAL; //entrada
														tieneEntradaX=true;				
														horaFinMov2 = "";
														if (log.isDebugEnabled()) log.debug("i antes2_SES:"+i);														
														if (log.isDebugEnabled()) log.debug("i_SES:"+i);
																							
													}
												}
											}
										}else{//horaMarcacion2>horaIniTurnoDx (aca modificar)	
											if (log.isDebugEnabled()) log.debug("entro 2.7_SES");
											//ok
											if (horaMarcacion2.trim().compareTo(horaFinTurnoDx.trim())<0){//if nuevo
												//ok
												if (tieneEntradaX==false){
													if (log.isDebugEnabled()) log.debug("entro 2.8_SES");
													tMov2 = preCalificarEntrada(
															fechaMarcacion2,
															horaMarcacion2,
															turnoDx.getHoraIni(),
															turnoDx.getTolera(),
															turnoDx.getHoraLimite(),
															Constantes.MINUTO);
													if (log.isDebugEnabled()) log.debug("salida66 preCalificarEntrada(tMov2)_SES:"+tMov2);
													tieneEntradaX=true;												
													horaFinMov2 = "";
													//hsal cuando es tardanza 01 se coloca valor
													if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO) ) {
														horaFinMov2=turnoDx.getHoraIni();
													}
													//fin hsal
													if (log.isDebugEnabled()) log.debug("j_SES:"+j);
													if (log.isDebugEnabled()) log.debug("i_SES:"+i);
												}else{//tieneEntradaX==true //revisar si debe ir tieneSalidaX
													if (log.isDebugEnabled()) log.debug("entro 2.9_SES");																							
													// no interesa si horaFinMov2 es mayor o menor que horaFinTurnoDx
													esPareja=true;											
													i=j;
													if (log.isDebugEnabled()) log.debug("j_SES:"+j);
													if (log.isDebugEnabled()) log.debug("i_SES:"+i);													
																									
												}//ok
											}else{//nuevo //horaMarcacion2>=horaFinTurnoDx
												//desarrollar
												if (tieneSalidaX==false){//if nuevo
													if (log.isDebugEnabled()) log.debug("entro 2.92_SES");
													tMov2 = preCalificarSalidaOpe1(
															dbpool,
															codPers,
															fechaMarcacion2,
															horaMarcacion2,
															turnoDx.getHoraFin(),
															Constantes.MINUTO);
													if (log.isDebugEnabled()) log.debug("salida6666 preCalificarSalidaOpe1(tMov2) SES:"+tMov2);					
													horaFinMov2 = "";
													//ICR 18052015
													if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
														horaFinMov2=turnoDx.getHoraFin();
													}
													//ICR 18052015
													tieneSalidaX=true;											
													if (log.isDebugEnabled()) log.debug("tieneSalidaX_SES:"+tieneSalidaX);
													if (log.isDebugEnabled()) log.debug("j_SES:"+j);
													if (log.isDebugEnabled()) log.debug("i_SES:"+i);
												}else{//tieneSalidaX==true	
													//horaFinMov2 es mayor que horaFinTurnoDx
													esPareja=true;											
													i=j;
													if (log.isDebugEnabled()) log.debug("j_SES:"+j);
													if (log.isDebugEnabled()) log.debug("i_SES:"+i);													
												}//ok		
											}
											//ok
										}//ok9										
									  }
									//ok
									if (esPareja){
										if (log.isDebugEnabled()) log.debug("espareja==true SES");
										//calificacion = preCalificarMovimientoOpe4(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDw, turnoDx,Constantes.MINUTO,tieneRefrigerioW, tieneRefrigerio,bOperativoW,bOperativo2); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										calificacion = preCalificarMovimientoOpe4(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDw, turnoDx,Constantes.MINUTO,tieneRefrigerioW, tieneRefrigerio,bOperativoW,bOperativo2,procesaClima,minMaxClima); //se agrego procesaClima y minMaxClima //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										if (log.isDebugEnabled()) log.debug("salida66 preCalificarMovimientoOpe4(calificacion)_SES:"+calificacion);

										tMov2=(String)calificacion.get("calif");
										
										/*if(calificacion.get("refrigerioW").equals("SI")){
											if (log.isDebugEnabled()) log.debug("refrigerioW==SI");
											if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) {
												if (log.isDebugEnabled()) log.debug("exceso o refrigerio_SES");
												tieneRefrigerioW = true;
												if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2 SES:"+fechaMarcacion2 + " " + horaMarcacion2);
												if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2 SES:"+fechaMarcacion2 + " " + horaFinMov2);
												float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
												float quedan = turnoDw.getMinutosRefrigerio() - durante1;
												if (log.isDebugEnabled()) log.debug("tieneRefrigerioW SES:"+tieneRefrigerioW);
												if (log.isDebugEnabled()) log.debug("durante1 w_SES:"+durante1);
												if (log.isDebugEnabled()) log.debug("quedan w_SES:"+quedan);
												turnoDw.setMinutosRefrigerio( new Float(quedan).intValue());
												log.debug("turnoDw(setMinutosRefrigerio o quedan_SES) : " + quedan);
											}
										}*/	

										if(calificacion.get("refrigerioX").equals("SI")){
											if (log.isDebugEnabled()) log.debug("refrigerioX==SI");
											//if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
											if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
												if (log.isDebugEnabled()) log.debug("exceso o refrigerio_SES");
												
												// ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
												Map calificacionActual=null;
												calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "2", "3","5"); //0=calificacion inicial, 2=papeleta aprobada, 3= papeleta procesada, //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral (adicion 5=calificacion por rrhh)
												if (log.isDebugEnabled()) log.debug("calificacionActuall : "+calificacionActual);												
												if (calificacionActual!=null){
													if (log.isDebugEnabled()) log.debug("entrooooo");
													movAct= calificacionActual.get("mov").toString().trim();//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													//if (tMov2.trim().equals(calificacionActual.get("mov").toString().trim())){ ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (movAct.equals(Constantes.MOV_EXCESO_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRI_CLIMALABORAL) ){ //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (log.isDebugEnabled()) log.debug("movAct igual a refri, exceso o refri clima");
														if (log.isDebugEnabled()) log.debug("tMov2 : "+tMov2);
														if (log.isDebugEnabled()) log.debug("calificacionActual : "+calificacionActual);
														
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio : "+tieneRefrigerio);
														if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
														tieneRefrigerio = true;
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2 SES:"+fechaMarcacion2 + " " + horaMarcacion2);
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2 SES:"+fechaMarcacion2 + " " + horaFinMov2);
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1 x_SES:"+durante1);
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio SES:"+tieneRefrigerio);
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
															if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
															minMaxClima= new Float(quedan).intValue();															
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("turnoDx.getMinutosRefrigerio(): "+turnoDx.getMinutosRefrigerio());
															log.debug("quedan: " + quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());															
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral												
													}else{
														tieneRefrigerio = false;
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio: "+tieneRefrigerio);
													}														
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas
												else{													
													calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "0", "0","0"); //0=calificacion inicial
													if (log.isDebugEnabled()) log.debug("calificacionActual2 : "+calificacionActual);
													if (calificacionActual==null){
														tieneRefrigerio = true;
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
															if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
															minMaxClima= new Float(quedan).intValue();
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("turnoDx.getMinutosRefrigerio(): "+turnoDx.getMinutosRefrigerio());
															log.debug("quedan: " + quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());															
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral																											
													}													
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas	
												//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
											}
										}
									}															
									//todo ok									
								}else{
									//llego aca termine (marcacion sola)
									if (log.isDebugEnabled()) log.debug("no debe llegar aca CAS-ultima marcaci?ES");
									if (log.isDebugEnabled()) log.debug("j_SES:"+j);
									if (log.isDebugEnabled()) log.debug("i_SES:"+i);
									if (listaMarcaciones.size()==1){
										tMov2 = Constantes.MOV_OMISION_MARCA;
										if (log.isDebugEnabled()) log.debug("tMov una marcacion(omision)-SES:"+tMov2);
									}else{
										if (tieneSalidaW==false){
											if (log.isDebugEnabled()) log.debug("entro 1.3_SES");
											tMov2 = preCalificarSalidaOpe1(
													dbpool,
													codPers,
													fechaMarcacion2,
													horaMarcacion2,
													turnoDw.getHoraFin(),
													Constantes.MINUTO);
											if (log.isDebugEnabled()) log.debug("salida66 preCalificarSalidaOpe1(tMov2)_SES:"+tMov2);					
											horaFinMov2 = "";
											//ICR 18052015
											if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
												horaFinMov2=turnoDw.getHoraFin();
											}
											//ICR 18052015
											tieneSalidaW=true;											
											if (log.isDebugEnabled()) log.debug("tieneSalidaW_SES:"+tieneSalidaW);										
										}
										else{//tieneSalidaW==true
											if (tieneEntradaX==false){											
												if (log.isDebugEnabled()) log.debug("entro 3.0_SES");
												tMov2 = preCalificarEntrada(
														fechaMarcacion2,
														horaMarcacion2,
														turnoDx.getHoraIni(),
														turnoDx.getTolera(),
														turnoDx.getHoraLimite(),
														Constantes.MINUTO);
												if (log.isDebugEnabled()) log.debug("salida66 preCalificarEntrada(tMov2)_SES:"+tMov2);
												horaFinMov2 = "";
												//hsal cuando es tardanza 01 se coloca valor
												if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO) ) {
													horaFinMov2=turnoDx.getHoraIni();
												}
												//fin hsal
												tieneEntradaX=true;	
												if (log.isDebugEnabled()) log.debug("tieneEntradaX_SES:"+tieneEntradaX);
											}else{//tieneEntradaX==true
												
												if (tieneSalidaX==false){
													if (log.isDebugEnabled()) log.debug("entro 1.33_SES");
													tMov2 = preCalificarSalidaOpe1(
															dbpool,
															codPers,
															fechaMarcacion2,
															horaMarcacion2,
															turnoDx.getHoraFin(),
															Constantes.MINUTO);
													if (log.isDebugEnabled()) log.debug("salida666 preCalificarSalidaOpe1(tMov2)_SES:"+tMov2);					
													horaFinMov2 = "";
													//ICR 18052015
													if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
														horaFinMov2=turnoDx.getHoraFin();
													}
													//ICR 18052015
													tieneSalidaX=true;											
													if (log.isDebugEnabled()) log.debug("tieneSalidaX_SES:"+tieneSalidaX);
													
												}else{//tieneSalidaX==true
													tMov2 = Constantes.MOV_OMISION_MARCA;
													horaFinMov2 = "";//SI ES OMISION TIENE horaFinMov2 vacion
													if (log.isDebugEnabled()) log.debug("tMov5-CAS_SES(omision):"+tMov2);
												}												
											}
										}
									}	
								}
								if (tMov2.equals(Constantes.MOV_ENTRADA_ANTICIPADA)) {
									tMov2 = Constantes.ENTRADA_NORMAL;
									if (log.isDebugEnabled()) log.debug("tMov4-CAS_SES:"+tMov2);
								}	
								/*EBV 31/03/2015 CAMBIO DE LINEAMIENTO
								if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO)) {
									tMov2 = Constantes.MOV_TARDANZA_EFECTIVA;
									if (log.isDebugEnabled()) log.debug("tMov5-CAS_SES:"+tMov2);
								}			*/
								//fin llego aca
								
								try{
									if (horaFinMov2!=null && horaFinMov2!="") {
										if (log.isDebugEnabled()) log.debug("horaFinMov2!=null y horaFinMov2!=vacio");
										if (log.isDebugEnabled()) log.debug("codPers:"+codPers+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"/fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2);
										log.debug("borrando6 asistencia CAS en T1271DAO_SES: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
										t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
									}
									log.debug("datos CAS para T1271DAO_SES: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									Map params1 = new HashMap();
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);
									params1.put("cod_uorgan", codUO);
									params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
									params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									params1.put("mov", tMov2);
									params1.put("relojIni", relojIni2);
									params1.put("relojFin", relojFin2);
									params1.put("usuario", usuario);
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI (SES");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else {	
										log.debug("isProcesar NO (SES)");
										boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
										if (inserto){
											log.debug("SI inserto1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO inserto1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0		
								}
								catch(Exception e){
									if (log.isDebugEnabled()) log.debug("catch6- generarAsistenciaTrabajadorCAS_SES");										
									Map params1 = new HashMap();
									params1.put("mov", tMov2);
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("usuario", usuario);
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);							
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", horaMarcacion2);
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else{
										log.debug("isProcesar NO");
									//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
										boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
										if (actualizo){
											log.debug("SI actualizo1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO actualizo1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									
								}
							}//fin for ok	
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral - new
							if (autoriClima!=null && !autoriClima.isEmpty()){
								estadoAut=autoriClima.get("ind_aut").toString().trim();
								cod_auto = autoriClima.get("cod_aut").toString().trim();
								if ((excesoClima==true || refriClima==true) && estadoAut.equals("0")){
									log.debug("actualizara estado autorizacion (codPers: "+codPers+" fechaEval: "+fechaEval+" )");
									prms.put("ind_aut", Constantes.ACTIVO);					
									prms.put("cod_user_mod", "BATCH-CLIMA-LAB");
									prms.put("cod_pers", codPers);
									prms.put("fec_aut", autoriClima.get("fec_aut_desc").toString());					
									climaLabDAO.updateRegistroAutorizaCli(prms);
									
									//envio correo
									nomApell = (autoriClima.get("t02ap_pate")!=null?autoriClima.get("t02ap_pate").toString().trim():"")+" "+(autoriClima.get("t02ap_mate")!=null?autoriClima.get("t02ap_mate").toString().trim():"")+" "+(autoriClima.get("t02nombres")!=null?autoriClima.get("t02nombres").toString().trim():"");
									mParams.put("registro",codPers);
									if (log.isDebugEnabled()) log.debug("mParamss: " + mParams);
									
									mensajeF = "El sistema ha procedido a calificar sus marcaciones de Clima Laboral para la fecha "+(String)autoriClima.get("fec_aut_desc")+".";	
									if (log.isDebugEnabled()) log.debug("mensajeFF: " + mensajeF);	
									mensaje = textoCorreoClimaLaboral(mParams,nomApell,mensajeF);//mensaje en html
									if (log.isDebugEnabled()) log.debug("mensajee: " + mensaje);																			
									Correo objCorreo = new Correo(mensaje.toString());									
									objCorreo.setServidor(propiedadesCorreo.leePropiedad("servidor"));									
									objCorreo.setRemitente(propiedadesCorreo.leePropiedad("correoRemitenteMovimientos"),propiedadesCorreo.leePropiedad("nombreRemitenteMovimientos"));
															
									correoColab=correoDAO.findCorreoByRegistro(codPers);
									correoAutoriz=correoDAO.findCorreoByRegistro(cod_auto);
														
									// VALIDANDO SI TRABAJADOR TIENE CORREO																
									if (!correoColab.equals("")) {						
										if (log.isDebugEnabled()) log.debug("correoColab Trabajador= " + correoColab);
										try{
											//trabajador tiene correo correcto, se debe enviar correo a trabajador con copia a autorizador								
											objCorreo.agregarDestinatario(correoColab.trim());
											if(!correoAutoriz.equals("")){
												objCorreo.agregarConCopia(correoAutoriz.trim());
											}
											//objCorreo.agregarConCopia("jquispecoi@sunat.gob.pe");/////ELIMINAR
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral");
											objCorreo.enviarHtml();		
											if (log.isDebugEnabled()) log.debug("Se envio correo a trabajador");	
																		
										} catch (CorreoException ce) {
											//trabajador tiene correo erroneo, hay destinatario erroneo 
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - CORREO ERR흁EO");
											objCorreo.enviarHtml();
									 		if (log.isDebugEnabled()) log.debug("Error en CorreoExceptionn: "+ce.toString());									 	
										 	if (log.isDebugEnabled()) log.debug("SI tiene correo trabajador: "+codPers+" - pero correo es erroneo");									 										 	
										}											
									}//fin if tiene correo
									else {
										//trabajador no tiene correo, no hay destinatario y se debe copiar a rrhh correo
										objCorreo.agregarConCopia(propiedadesCorreo.leePropiedad("correoReceptorAlertaCambioTurnos"));
										objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - NO TIENE CORREO");
										objCorreo.enviarHtml();							
										if (log.isDebugEnabled()) log.debug("NO tiene correo trabajador: " + codPers+" - se envio a rrhh");
									}
									//fin envio correo
								}
							}							
							//ICAPUNAY - PAS20175E230300069
						}
						//FIN NUEVOO CAS
						//FIN ICAPUNAY 23/02/2015 AJUSTES GENERACION ASISTENCIA (caso SES: SI turno (dia x-1) de 2 dias y SI turno dia x de 1 d涌(marcaciones IMPARES requiere para dia x))

						
					}else{
						if (log.isDebugEnabled()) log.debug("registro("+codPers+"): NO turno (dia x-1) de 2 dias y SI turno dia x de 1 dia(marcaciones PARES requiere para dia x)");
						
						//par requiere (impar es omision) //logica normal minimo (E S)						
						diaEspecial = Utiles.isDiaSemana(fechaEval, Constantes.SABADO) || Utiles.isDiaSemana(fechaEval, Constantes.DOMINGO) || paramDAO.findByFechaFeriado(dbpool, fechaEval);
						tieneRefrigerio = false;						
						listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
						if (log.isDebugEnabled()) log.debug("listaMarcaciones:"+listaMarcaciones);
						if (listaMarcaciones != null && listaMarcaciones.size() > 0) {	
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral										
							autoriClima=climaLabDAO.findAutorizaByRegByFecha(codPers, fechaEval);
							log.debug("autoriClima: "+autoriClima);							
							if (autoriClima!=null && !autoriClima.isEmpty()){
								procesaClima=true;
							}
							//ICAPUNAY - PAS20175E230300069
							
							for (int i = 0; i < listaMarcaciones.size(); i++) {	
								bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
								fechaMarcacion2 = bMarcacion2.getFecha();
								horaMarcacion2 = bMarcacion2.getHora();
								relojIni2 = bMarcacion2.getReloj();
								relojFin2 = "";
								if (log.isDebugEnabled()) log.debug("i:"+i);
								if (log.isDebugEnabled()) log.debug("bMarcacion2("+i+"):"+bMarcacion2);
								if (log.isDebugEnabled()) log.debug("fechaMarcacion2("+i+"):"+fechaMarcacion2);
								if (log.isDebugEnabled()) log.debug("horaMarcacion2("+i+"):"+horaMarcacion2);
								//primera marcacion de ENTRADA
								if (i==0){
									if (log.isDebugEnabled()) log.debug("primera marca");
									fechaFinMov2 = bMarcacion2.getFecha();
									horaFinMov2 = "";
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 ent:"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 ent:"+horaFinMov2);
									if (diaEspecial && !bOperativo2){
										tMov2 = Constantes.MOV_APORTACION;	
										if (log.isDebugEnabled()) log.debug("tMov2-CAS:"+tMov2);
									}else{
										tMov2 = preCalificarEntrada(
												fechaMarcacion2,
												horaMarcacion2,
												turnoDx.getHoraIni(),
												turnoDx.getTolera(),
												turnoDx.getHoraLimite(),
												Constantes.MINUTO);
										if (log.isDebugEnabled()) log.debug("salida preCalificarEntrada(tMov):"+tMov2);
									}							
									
									if (tMov2.equals(Constantes.MOV_ENTRADA_ANTICIPADA)) {
										tMov2 = Constantes.ENTRADA_NORMAL;
										if (log.isDebugEnabled()) log.debug("tMov4-CAS:"+tMov2);
									}		
									/*EBV 31/03/2015 CAMBIO DE LINEAMIENTO
									if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO)) {
										tMov2 = Constantes.MOV_TARDANZA_EFECTIVA;
										if (log.isDebugEnabled()) log.debug("tMov5-CAS:"+tMov2);
									}
									*/
								}else if (i == (listaMarcaciones.size() - 1)){//ultima marcacion de SALIDA
									if (log.isDebugEnabled()) log.debug("ultima marca");
									fechaFinMov2 = bMarcacion2.getFecha();
									horaFinMov2 = "";
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 sal:"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 sal:"+horaFinMov2);
									if (diaEspecial && !bOperativo2){
										tMov2 = Constantes.MOV_APORTACION;
										if (log.isDebugEnabled()) log.debug("tMov7-CAS:"+tMov2);
									}else{
										tMov2 = preCalificarSalida(
												dbpool,
												codPers,
												fechaMarcacion2,
												horaMarcacion2,
												turnoDx.getHoraFin(),
												Constantes.MINUTO);
										if (log.isDebugEnabled()) log.debug("salida preCalificarSalida(tMov2):"+tMov2);
									}							
															
								}
								//movimientos intermedios
								else{
									if (log.isDebugEnabled()) log.debug("marcaciones en pareja");					
									if (log.isDebugEnabled()) log.debug("listaMarcaciones.size():"+listaMarcaciones.size());								
									if (i < (listaMarcaciones.size() - 2)) {
										if (log.isDebugEnabled()) log.debug("i:"+i);
										bMSgte2 = (BeanMarcacion) listaMarcaciones.get(++i);							
										fechaFinMov2 = bMSgte2.getFecha();
										horaFinMov2 = bMSgte2.getHora();
										relojFin2 = bMSgte2.getReloj();
										if (log.isDebugEnabled()) log.debug("bMSgte2 int:"+bMSgte2);
										if (log.isDebugEnabled()) log.debug("fechaFinMov2 int :"+fechaFinMov2);
										if (log.isDebugEnabled()) log.debug("horaFinMov2 int:"+horaFinMov2);
										if (log.isDebugEnabled()) log.debug("relojFin2 int:"+relojFin2);
										if (diaEspecial && !bOperativo2){
											tMov2 = Constantes.MOV_APORTACION;	
											if (log.isDebugEnabled()) log.debug("tMov9-CAS:"+tMov2);
										}else{										
											//tMov2 = preCalificarMovimiento(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDx,	Constantes.MINUTO, tieneRefrigerio,	bOperativo2);
											//tMov2 = preCalificarMovimiento_soloTurnoAdmOpe1dia(dbpool,codPers,fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDx,	Constantes.MINUTO, tieneRefrigerio,	bOperativo2); //se agrego dbpool y codPers //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
											tMov2 = preCalificarMovimiento_soloTurnoAdmOpe1dia(dbpool,codPers,fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDx, Constantes.MINUTO, tieneRefrigerio,bOperativo2,procesaClima,minMaxClima); //se agrego procesaClima y minMaxClima //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
											if (log.isDebugEnabled()) log.debug("salida preCalificarMovimiento_soloTurnoAdmOpe1dia(tMov):"+tMov2);
											//if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
											if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
												if (log.isDebugEnabled()) log.debug("exceso o refrigerio_SE");
												
												// ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
												Map calificacionActual=null;
												calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "2", "3","5"); //0=calificacion inicial, 2=papeleta aprobada, 3= papeleta procesada, //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral (adicion 5=calificacion por rrhh)
												if (log.isDebugEnabled()) log.debug("calificacionActuall : "+calificacionActual);												
												if (calificacionActual!=null){
													if (log.isDebugEnabled()) log.debug("entrooooo");
													movAct= calificacionActual.get("mov").toString().trim();//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													//if (tMov2.trim().equals(calificacionActual.get("mov").toString().trim())){ ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (movAct.equals(Constantes.MOV_EXCESO_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRI_CLIMALABORAL) ){ //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (log.isDebugEnabled()) log.debug("movAct igual a refri, exceso o refri clima");
														if (log.isDebugEnabled()) log.debug("tMov2 : "+tMov2);
														if (log.isDebugEnabled()) log.debug("calificacionActual : "+calificacionActual);
																																										
														tieneRefrigerio = true;
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio : "+tieneRefrigerio);
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2:"+fechaMarcacion2 + " " + horaMarcacion2);
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2:"+fechaMarcacion2 + " " + horaFinMov2);
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("quedan1:"+quedan);
															minMaxClima= new Float(quedan).intValue();
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("quedan:"+quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral																												
														
													}else{
														tieneRefrigerio = false;
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio2: "+tieneRefrigerio);
													}
														
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas
												else{													
													calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "0", "0","0"); //0=calificacion inicial
													if (log.isDebugEnabled()) log.debug("calificacionActual2 : "+calificacionActual);
													if (calificacionActual==null){
														tieneRefrigerio = true;
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("quedan1:"+quedan);
															minMaxClima= new Float(quedan).intValue();
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("quedan:"+quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
																											
													}													
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas	
												//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
											}										
										}
																	
									}else{//marcacion impar
										if (log.isDebugEnabled()) log.debug("marcacion impar");
										fechaFinMov2 = bMarcacion2.getFecha();
										horaFinMov2 = "";
										if (diaEspecial && !bOperativo2){
											tMov2 = Constantes.MOV_APORTACION;	
											if (log.isDebugEnabled()) log.debug("tMov11-CAS:"+tMov2);
										}else{										
											tMov2 = Constantes.MOV_OMISION_MARCA;
											if (log.isDebugEnabled()) log.debug("tMov12-CAS:"+tMov2);
										}										
									}	
									/*EBV 27/03/2015 CAMBIO DE LINEAMIENTO								
									if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
										tMov2 = Constantes.MOV_SALIDA_AUTORIZADA;
										if (log.isDebugEnabled()) log.debug("tMov13-CAS:"+tMov2);
									}
									 */									
								}
								//fin mov intermedios								
								try{			
									if (log.isDebugEnabled()) log.debug("try- generarAsistenciaTrabajadorCAS");	
									if ((Constantes.TURNO_RS067).equals(turnoDx.getTurno().trim())){
										tMov2 = Constantes.MOV_RESOLUCION_067;
										if (log.isDebugEnabled()) log.debug("tMov14-CAS:"+tMov2);
									}									
									if (horaFinMov2!=null && horaFinMov2!="") {
										log.debug("borrando asistencia CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
										t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
									}									
									Map params1 = new HashMap();
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);
									params1.put("cod_uorgan", codUO);
									params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
									params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
									params1.put("fechaFinMov", (fechaFinMov2!=null  && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									params1.put("mov", tMov2);
									params1.put("relojIni", relojIni2);
									params1.put("relojFin", relojFin2);
									params1.put("usuario", usuario);
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI (SES");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else {	
										log.debug("isProcesar NO (SES)");
										boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
										if (inserto){
											log.debug("SI inserto1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO inserto1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0		
																		
								}
								catch(Exception e){
									if (log.isDebugEnabled()) log.debug("catch- generarAsistenciaTrabajadorCAS");										
									Map params1 = new HashMap();
									params1.put("mov", tMov2);
									params1.put("fechaFinMov", (fechaFinMov2!=null  && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("usuario", usuario);
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);							
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", horaMarcacion2);
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else{
										log.debug("isProcesar NO");
									//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
										boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
										if (actualizo){
											log.debug("SI actualizo1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO actualizo1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0									
																		
								}								
							}//fin for	
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral - new
							if (autoriClima!=null && !autoriClima.isEmpty()){
								estadoAut=autoriClima.get("ind_aut").toString().trim();
								cod_auto = autoriClima.get("cod_aut").toString().trim();
								if ((excesoClima==true || refriClima==true) && estadoAut.equals("0")){
									log.debug("actualizara estado autorizacion (codPers: "+codPers+" fechaEval: "+fechaEval+" )");
									prms.put("ind_aut", Constantes.ACTIVO);					
									prms.put("cod_user_mod", "BATCH-CLIMA-LAB");
									prms.put("cod_pers", codPers);
									prms.put("fec_aut", autoriClima.get("fec_aut_desc").toString());					
									climaLabDAO.updateRegistroAutorizaCli(prms);
									
									//envio correo
									nomApell = (autoriClima.get("t02ap_pate")!=null?autoriClima.get("t02ap_pate").toString().trim():"")+" "+(autoriClima.get("t02ap_mate")!=null?autoriClima.get("t02ap_mate").toString().trim():"")+" "+(autoriClima.get("t02nombres")!=null?autoriClima.get("t02nombres").toString().trim():"");
									mParams.put("registro",codPers);
									if (log.isDebugEnabled()) log.debug("mParamss: " + mParams);
									
									mensajeF = "El sistema ha procedido a calificar sus marcaciones de Clima Laboral para la fecha "+(String)autoriClima.get("fec_aut_desc")+".";	
									if (log.isDebugEnabled()) log.debug("mensajeFF: " + mensajeF);	
									mensaje = textoCorreoClimaLaboral(mParams,nomApell,mensajeF);//mensaje en html
									if (log.isDebugEnabled()) log.debug("mensajee: " + mensaje);																			
									Correo objCorreo = new Correo(mensaje.toString());									
									objCorreo.setServidor(propiedadesCorreo.leePropiedad("servidor"));									
									objCorreo.setRemitente(propiedadesCorreo.leePropiedad("correoRemitenteMovimientos"),propiedadesCorreo.leePropiedad("nombreRemitenteMovimientos"));
															
									correoColab=correoDAO.findCorreoByRegistro(codPers);
									correoAutoriz=correoDAO.findCorreoByRegistro(cod_auto);
														
									// VALIDANDO SI TRABAJADOR TIENE CORREO																
									if (!correoColab.equals("")) {						
										if (log.isDebugEnabled()) log.debug("correoColab Trabajador= " + correoColab);
										try{
											//trabajador tiene correo correcto, se debe enviar correo a trabajador con copia a autorizador								
											objCorreo.agregarDestinatario(correoColab.trim());
											if(!correoAutoriz.equals("")){
												objCorreo.agregarConCopia(correoAutoriz.trim());
											}
											//objCorreo.agregarConCopia("jquispecoi@sunat.gob.pe");/////ELIMINAR
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral");
											objCorreo.enviarHtml();		
											if (log.isDebugEnabled()) log.debug("Se envio correo a trabajador");	
																		
										} catch (CorreoException ce) {
											//trabajador tiene correo erroneo, hay destinatario erroneo 
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - CORREO ERR흁EO");
											objCorreo.enviarHtml();
									 		if (log.isDebugEnabled()) log.debug("Error en CorreoExceptionn: "+ce.toString());									 	
										 	if (log.isDebugEnabled()) log.debug("SI tiene correo trabajador: "+codPers+" - pero correo es erroneo");									 										 	
										}											
									}//fin if tiene correo
									else {
										//trabajador no tiene correo, no hay destinatario y se debe copiar a rrhh correo
										objCorreo.agregarConCopia(propiedadesCorreo.leePropiedad("correoReceptorAlertaCambioTurnos"));
										objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - NO TIENE CORREO");
										objCorreo.enviarHtml();							
										if (log.isDebugEnabled()) log.debug("NO tiene correo trabajador: " + codPers+" - se envio a rrhh");
									}
									//fin envio correo
								}
							}							
							//ICAPUNAY - PAS20175E230300069
						}
					}
				}//fin adm u ope 1 dia
				else{
					if (log.isDebugEnabled()) log.debug("horaFinTurnoDx<=horaIniTurnoDx(ope 2 dias)");
					fechaAntes = Utiles.dameFechaAnterior(fechaEval, 1);	    		   
					BeanTurnoTrabajo turnoDw = daoTurno.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,codPers,fechaAntes); //dia (x-1)
					if (log.isDebugEnabled()) log.debug("turno2 dia x-1 (turnoDw)("+codPers+"): " + turnoDw);
					if (turnoDw!=null){
						if (log.isDebugEnabled()) log.debug("registro("+codPers+"): SI turno (dia x-1) de 2 dias y SI turno dia x de 2 dia (marcaciones PARES requiere para dia x)");
						horaIniTurnoDw = turnoDw.getHoraIni().trim();
						horaFinTurnoDw = turnoDw.getHoraFin().trim();
						bOperativoW = turnoDw.isOperativo();//NUEVO						
						tieneRefrigerio = false;//NUEVO
						tieneRefrigerioW = false;//NUEVO
						if (log.isDebugEnabled()) log.debug("horaIniTurnoDw2("+codPers+"): " + horaIniTurnoDw);
						if (log.isDebugEnabled()) log.debug("horaFinTurnoDw2("+codPers+"): "+ horaFinTurnoDw); 						
						//hay 2 turnos turnoDw (anterior) y turnoDx (actual)						
						//par requiere (impar es omision) //solo S,E //09/09/14							
						//NUEVO
						listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
						if (log.isDebugEnabled()) log.debug("listaMarcaciones:"+listaMarcaciones);
						if (listaMarcaciones != null && listaMarcaciones.size() > 0) {
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral												
							autoriClima=climaLabDAO.findAutorizaByRegByFecha(codPers, fechaEval);
							log.debug("autoriClima: "+autoriClima);							
							if (autoriClima!=null && !autoriClima.isEmpty()){
								procesaClima=true;
							}
							//ICAPUNAY - PAS20175E230300069
							
							int j=0;
							float cantidad = 0;
							boolean esPareja=false;
							boolean tieneSalidaW=false;
							boolean tieneEntradaX=false;
							Map calificacion = new HashMap();
							for (int i = 0; i <= listaMarcaciones.size()-1; i++) {
								esPareja=false;
								if (log.isDebugEnabled()) log.debug("i:"+i);
								bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
								fechaMarcacion2 = bMarcacion2.getFecha();
								horaMarcacion2 = bMarcacion2.getHora();
								relojIni2 = bMarcacion2.getReloj();
								relojFin2 = "";
								fechaFinMov2= "";
								if (log.isDebugEnabled()) log.debug("i:"+i);								
								if (log.isDebugEnabled()) log.debug("fechaMarcacion2("+i+"):"+fechaMarcacion2);
								if (log.isDebugEnabled()) log.debug("horaMarcacion2("+i+"):"+horaMarcacion2);
							
								if (i<=listaMarcaciones.size()-2){										
									j=i+1;									
									bMSgte2 = (BeanMarcacion) listaMarcaciones.get(j);							
									fechaFinMov2 = bMSgte2.getFecha();
									horaFinMov2 = bMSgte2.getHora();
									relojFin2 = bMSgte2.getReloj();
									if (log.isDebugEnabled()) log.debug("j(i+1):"+j);									
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 int :"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 int:"+horaFinMov2);
									if (log.isDebugEnabled()) log.debug("relojFin2 int:"+relojFin2);
																			
									if(horaMarcacion2.trim().compareTo(horaFinTurnoDw.trim())<0){
										if (log.isDebugEnabled()) log.debug("entro 1");
										if (horaFinMov2.trim().compareTo(horaFinTurnoDw.trim())<0){
											if (log.isDebugEnabled()) log.debug("entro 1.1");
											esPareja=true;										
											i=j;
											if (log.isDebugEnabled()) log.debug("j:"+j);
											if (log.isDebugEnabled()) log.debug("i:"+i);
										}else{//horaFinMov2>horaFinTurnoDw
											if (log.isDebugEnabled()) log.debug("entro 1.2");
											if (tieneSalidaW==false){
												if (log.isDebugEnabled()) log.debug("entro 1.3");
												tMov2 = preCalificarSalidaOpe1(
														dbpool,
														codPers,
														fechaMarcacion2,
														horaMarcacion2,
														turnoDw.getHoraFin(),
														Constantes.MINUTO);
												if (log.isDebugEnabled()) log.debug("salida66 preCalificarSalidaOpe1(tMov2):"+tMov2);					
												horaFinMov2 = "";
												//ICR 18052015
												if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
													horaFinMov2=turnoDw.getHoraFin();
												}
												//ICR 18052015
												tieneSalidaW=true;											
												if (log.isDebugEnabled()) log.debug("tieneSalidaW:"+tieneSalidaW);
												if (log.isDebugEnabled()) log.debug("j:"+j);
												if (log.isDebugEnabled()) log.debug("i:"+i);
											}	
										}										
									}else{//horaMarcacion2>=horaFinTurnoDw
										if (log.isDebugEnabled()) log.debug("entro 2");
										if (horaMarcacion2.trim().compareTo(horaIniTurnoDx.trim())<=0){
											if (log.isDebugEnabled()) log.debug("entro 2.1");
											if (tieneSalidaW==false){
												if (log.isDebugEnabled()) log.debug("entro 2.2");
												tMov2 = Constantes.SALIDA_NORMAL; //salida
												tieneSalidaW=true;											
												horaFinMov2 = "";
												if (log.isDebugEnabled()) log.debug("i antes:"+i);												
											}else{
												if (log.isDebugEnabled()) log.debug("entro 2.3");
												if (horaFinMov2.trim().compareTo(horaIniTurnoDx.trim())<=0){
													if (log.isDebugEnabled()) log.debug("entro 2.4");
													esPareja=true;												
													i=j;
													if (log.isDebugEnabled()) log.debug("j:"+j);
													if (log.isDebugEnabled()) log.debug("i:"+i);
												}else{
													if (log.isDebugEnabled()) log.debug("entro 2.5");
													if (tieneEntradaX==false){
														if (log.isDebugEnabled()) log.debug("entro 2.6");
														tMov2 = Constantes.ENTRADA_NORMAL; //entrada
														tieneEntradaX=true;				
														horaFinMov2 = "";
														if (log.isDebugEnabled()) log.debug("i antes2:"+i);														
														if (log.isDebugEnabled()) log.debug("i:"+i);
													}
												}
											}
										}else{//horaMarcacion2>horaIniTurnoDx	
											if (log.isDebugEnabled()) log.debug("entro 2.7");
											if (tieneEntradaX==false){
												if (log.isDebugEnabled()) log.debug("entro 2.8");
												tMov2 = preCalificarEntradaOpe2(
														fechaMarcacion2,
														horaMarcacion2,
														turnoDx.getHoraIni(),
														turnoDx.getTolera(),
														turnoDx.getHoraLimite(),
														Constantes.MINUTO);
												if (log.isDebugEnabled()) log.debug("salida66 preCalificarEntradaOpe2(tMov2):"+tMov2);
												tieneEntradaX=true;												
												horaFinMov2 = "";
												//hsal cuando es tardanza 01 se coloca valor
												if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO) ) {
													horaFinMov2=turnoDx.getHoraIni();
												}
												//fin hsal
												if (log.isDebugEnabled()) log.debug("j:"+j);
												if (log.isDebugEnabled()) log.debug("i:"+i);
											}else{
												if (log.isDebugEnabled()) log.debug("entro 2.9");
												if (horaFinMov2.trim().compareTo(horaIniTurnoDx.trim())>0){
													if (log.isDebugEnabled()) log.debug("entro 2.10");
													esPareja=true;											
													i=j;
													if (log.isDebugEnabled()) log.debug("j:"+j);
													if (log.isDebugEnabled()) log.debug("i:"+i);
												}
											}
										}										
									}									
									
									if (esPareja){
										if (log.isDebugEnabled()) log.debug("espareja==true");
										//calificacion = preCalificarMovimientoOpe3(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDw, turnoDx,	Constantes.MINUTO,tieneRefrigerioW, tieneRefrigerio,bOperativoW,bOperativo2); ////ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										calificacion = preCalificarMovimientoOpe3(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDw, turnoDx,Constantes.MINUTO,tieneRefrigerioW, tieneRefrigerio,bOperativoW,bOperativo2,procesaClima,minMaxClima); ////ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										if (log.isDebugEnabled()) log.debug("salida66 preCalificarMovimientoOpe3(calificacion):"+calificacion);

										tMov2=(String)calificacion.get("calif");
										
										/*if(calificacion.get("refrigerioW").equals("SI")){
											if (log.isDebugEnabled()) log.debug("refrigerioW==SI");
											if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) {
												if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
												tieneRefrigerioW = true;
												if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2:"+fechaMarcacion2 + " " + horaMarcacion2);
												if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2:"+fechaMarcacion2 + " " + horaFinMov2);
												float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
												float quedan = turnoDw.getMinutosRefrigerio() - durante1;
												if (log.isDebugEnabled()) log.debug("tieneRefrigerioW:"+tieneRefrigerioW);
												if (log.isDebugEnabled()) log.debug("durante1 w:"+durante1);
												if (log.isDebugEnabled()) log.debug("quedan w:"+quedan);
												turnoDw.setMinutosRefrigerio( new Float(quedan).intValue());
												log.debug("turnoDw(setMinutosRefrigerio o quedan) : " + quedan);
											}
										}*/	

										if(calificacion.get("refrigerioX").equals("SI")){
											if (log.isDebugEnabled()) log.debug("refrigerioX==SI");
											//if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) { ////ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
											if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)) { ////ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
												if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
												
												// ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
												Map calificacionActual=null;
												calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "2", "3","5"); //0=calificacion inicial, 2=papeleta aprobada, 3= papeleta procesada, //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral (adicion 5=calificacion por rrhh)
												if (log.isDebugEnabled()) log.debug("calificacionActuall : "+calificacionActual);												
												if (calificacionActual!=null){
													if (log.isDebugEnabled()) log.debug("entrooooo");
													movAct= calificacionActual.get("mov").toString().trim();//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													//if (tMov2.trim().equals(calificacionActual.get("mov").toString().trim())){ ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (movAct.equals(Constantes.MOV_EXCESO_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRI_CLIMALABORAL) ){ //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (log.isDebugEnabled()) log.debug("movAct igual a refri, exceso o refri clima");
														if (log.isDebugEnabled()) log.debug("tMov2 : "+tMov2);
														if (log.isDebugEnabled()) log.debug("calificacionActual : "+calificacionActual);
														
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio : "+tieneRefrigerio);
														if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
														tieneRefrigerio = true;
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2:"+fechaMarcacion2 + " " + horaMarcacion2);
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2:"+fechaMarcacion2 + " " + horaFinMov2);
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1 x:"+durante1);
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio:"+tieneRefrigerio);
														
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
															if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
															minMaxClima= new Float(quedan).intValue();
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("turnoDx.getMinutosRefrigerio(): "+turnoDx.getMinutosRefrigerio());
															log.debug("quedan: " + quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());															
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral														
													}else{
														tieneRefrigerio = false;
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio: "+tieneRefrigerio);
													}
														
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas
												else{													
													calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "0", "0","0"); //0=calificacion inicial
													if (log.isDebugEnabled()) log.debug("calificacionActual2 : "+calificacionActual);
													if (calificacionActual==null){
														tieneRefrigerio = true;
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
														
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
															if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
															minMaxClima= new Float(quedan).intValue();
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("turnoDx.getMinutosRefrigerio(): "+turnoDx.getMinutosRefrigerio());
															log.debug("quedan: " + quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());															
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral																											
													}													
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas	
												//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
											}
										}
									}															
									//todo									
								}else{
									//llego aca
									if (log.isDebugEnabled()) log.debug("no debe llegar aca CAS-ultima marcacion");
									if (log.isDebugEnabled()) log.debug("j:"+j);
									if (log.isDebugEnabled()) log.debug("i:"+i);
									if (listaMarcaciones.size()==1){
										tMov2 = Constantes.MOV_OMISION_MARCA;
										if (log.isDebugEnabled()) log.debug("tMov una marcacion-CAS:"+tMov2);
									}else{
										if (tieneSalidaW==false){
											if (log.isDebugEnabled()) log.debug("entro 1.3");
											tMov2 = preCalificarSalidaOpe1(
													dbpool,
													codPers,
													fechaMarcacion2,
													horaMarcacion2,
													turnoDw.getHoraFin(),
													Constantes.MINUTO);
											if (log.isDebugEnabled()) log.debug("salida66 preCalificarSalidaOpe1(tMov2):"+tMov2);					
											horaFinMov2 = "";
											//ICR 18052015
											if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
												horaFinMov2=turnoDw.getHoraFin();
											}
											//ICR 18052015
											tieneSalidaW=true;											
											if (log.isDebugEnabled()) log.debug("tieneSalidaW:"+tieneSalidaW);
											if (log.isDebugEnabled()) log.debug("j:"+j);
											if (log.isDebugEnabled()) log.debug("i:"+i);
										}
										else{//tieneSalidaW==true
											if (tieneEntradaX==false){											
												if (log.isDebugEnabled()) log.debug("entro 3.0");
												tMov2 = preCalificarEntradaOpe2(
														fechaMarcacion2,
														horaMarcacion2,
														turnoDx.getHoraIni(),
														turnoDx.getTolera(),
														turnoDx.getHoraLimite(),
														Constantes.MINUTO);
												if (log.isDebugEnabled()) log.debug("salida66 preCalificarEntradaOpe2(tMov2):"+tMov2);
												tieneEntradaX=true;												
												horaFinMov2 = "";
												//hsal cuando es tardanza 01 se coloca valor
												if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO) ) {
													horaFinMov2=turnoDx.getHoraIni();
												}
												//fin hsal
											}else{
												tMov2 = Constantes.MOV_OMISION_MARCA;
												if (log.isDebugEnabled()) log.debug("tMov5-CAS:"+tMov2);
											}
										}
									}	
								}
								if (tMov2.equals(Constantes.MOV_ENTRADA_ANTICIPADA)) {
									tMov2 = Constantes.ENTRADA_NORMAL;
									if (log.isDebugEnabled()) log.debug("tMov4-CAS:"+tMov2);
								}	
								/*EBV 31/03/2015 CAMBIO DE LINEAMIENTO
								if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO)) {
									tMov2 = Constantes.MOV_TARDANZA_EFECTIVA;
									if (log.isDebugEnabled()) log.debug("tMov5-CAS:"+tMov2);
								}*/			
								//fin llego aca
								
								try{
									if (horaFinMov2!=null && horaFinMov2!="") {
										if (log.isDebugEnabled()) log.debug("horaFinMov2!=null y horaFinMov2!=vacio");
										if (log.isDebugEnabled()) log.debug("codPers:"+codPers+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"/fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2);
										log.debug("borrando6 asistencia CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
										t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
									}
									log.debug("datos CAS para T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									Map params1 = new HashMap();
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);
									params1.put("cod_uorgan", codUO);
									params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
									params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									params1.put("mov", tMov2);
									params1.put("relojIni", relojIni2);
									params1.put("relojFin", relojFin2);
									params1.put("usuario", usuario);	
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI (SES");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else {	
										log.debug("isProcesar NO (SES)");
										boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
										if (inserto){
											log.debug("SI inserto1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO inserto1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0		
								}
								catch(Exception e){
									if (log.isDebugEnabled()) log.debug("catch6- generarAsistenciaTrabajadorCAS");										
									Map params1 = new HashMap();
									params1.put("mov", tMov2);
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("usuario", usuario);
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);							
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", horaMarcacion2);
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else{
										log.debug("isProcesar NO");
									//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
										boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
										if (actualizo){
											log.debug("SI actualizo1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO actualizo1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									
								}
							}//fin for ok
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral - new
							if (autoriClima!=null && !autoriClima.isEmpty()){
								estadoAut=autoriClima.get("ind_aut").toString().trim();
								cod_auto = autoriClima.get("cod_aut").toString().trim();
								if ((excesoClima==true || refriClima==true) && estadoAut.equals("0")){
									log.debug("actualizara estado autorizacion (codPers: "+codPers+" fechaEval: "+fechaEval+" )");
									prms.put("ind_aut", Constantes.ACTIVO);					
									prms.put("cod_user_mod", "BATCH-CLIMA-LAB");
									prms.put("cod_pers", codPers);
									prms.put("fec_aut", autoriClima.get("fec_aut_desc").toString());					
									climaLabDAO.updateRegistroAutorizaCli(prms);
									
									//envio correo
									nomApell = (autoriClima.get("t02ap_pate")!=null?autoriClima.get("t02ap_pate").toString().trim():"")+" "+(autoriClima.get("t02ap_mate")!=null?autoriClima.get("t02ap_mate").toString().trim():"")+" "+(autoriClima.get("t02nombres")!=null?autoriClima.get("t02nombres").toString().trim():"");
									mParams.put("registro",codPers);
									if (log.isDebugEnabled()) log.debug("mParamss: " + mParams);
									
									mensajeF = "El sistema ha procedido a calificar sus marcaciones de Clima Laboral para la fecha "+(String)autoriClima.get("fec_aut_desc")+".";	
									if (log.isDebugEnabled()) log.debug("mensajeFF: " + mensajeF);	
									mensaje = textoCorreoClimaLaboral(mParams,nomApell,mensajeF);//mensaje en html
									if (log.isDebugEnabled()) log.debug("mensajee: " + mensaje);																			
									Correo objCorreo = new Correo(mensaje.toString());									
									objCorreo.setServidor(propiedadesCorreo.leePropiedad("servidor"));									
									objCorreo.setRemitente(propiedadesCorreo.leePropiedad("correoRemitenteMovimientos"),propiedadesCorreo.leePropiedad("nombreRemitenteMovimientos"));
															
									correoColab=correoDAO.findCorreoByRegistro(codPers);
									correoAutoriz=correoDAO.findCorreoByRegistro(cod_auto);
														
									// VALIDANDO SI TRABAJADOR TIENE CORREO																
									if (!correoColab.equals("")) {						
										if (log.isDebugEnabled()) log.debug("correoColab Trabajador= " + correoColab);
										try{
											//trabajador tiene correo correcto, se debe enviar correo a trabajador con copia a autorizador								
											objCorreo.agregarDestinatario(correoColab.trim());
											if(!correoAutoriz.equals("")){
												objCorreo.agregarConCopia(correoAutoriz.trim());
											}
											//objCorreo.agregarConCopia("jquispecoi@sunat.gob.pe");/////ELIMINAR
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral");
											objCorreo.enviarHtml();		
											if (log.isDebugEnabled()) log.debug("Se envio correo a trabajador");	
																		
										} catch (CorreoException ce) {
											//trabajador tiene correo erroneo, hay destinatario erroneo 
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - CORREO ERR흁EO");
											objCorreo.enviarHtml();
									 		if (log.isDebugEnabled()) log.debug("Error en CorreoExceptionn: "+ce.toString());									 	
										 	if (log.isDebugEnabled()) log.debug("SI tiene correo trabajador: "+codPers+" - pero correo es erroneo");									 										 	
										}											
									}//fin if tiene correo
									else {
										//trabajador no tiene correo, no hay destinatario y se debe copiar a rrhh correo
										objCorreo.agregarConCopia(propiedadesCorreo.leePropiedad("correoReceptorAlertaCambioTurnos"));
										objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - NO TIENE CORREO");
										objCorreo.enviarHtml();							
										if (log.isDebugEnabled()) log.debug("NO tiene correo trabajador: " + codPers+" - se envio a rrhh");
									}
									//fin envio correo
								}
							}							
							//ICAPUNAY - PAS20175E230300069
						}
						//FIN NUEVO						
						
					}else{
						if (log.isDebugEnabled()) log.debug("registro("+codPers+"): NO turno (dia x-1) de 2 dias y SI turno dia x de 2 dias (marcaciones IMPARES requiere para dia x)");
						tieneRefrigerio = false;
						//preCalificarEntradaOpe2 //preCalificarMovimientoOpe2 //solo E
						//impar requiere (AJUSTAR PARA SI HORA LIMITE ES PASADA LAS 00:00 NO COLOQUE INASISTENCIA CUANDO INGRESA A LAS 16:30 08/09/2014 par es omision)
						
						listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
						if (log.isDebugEnabled()) log.debug("listaMarcaciones:"+listaMarcaciones);
						if (listaMarcaciones != null && listaMarcaciones.size() > 0) {
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
							autoriClima=climaLabDAO.findAutorizaByRegByFecha(codPers, fechaEval);
							log.debug("autoriClima: "+autoriClima);							
							if (autoriClima!=null && !autoriClima.isEmpty()){
								procesaClima=true;
							}
							//ICAPUNAY - PAS20175E230300069
							
							for (int i = 0; i < listaMarcaciones.size(); i++) {	
								bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
								fechaMarcacion2 = bMarcacion2.getFecha();
								horaMarcacion2 = bMarcacion2.getHora();
								relojIni2 = bMarcacion2.getReloj();
								relojFin2 = "";
								if (log.isDebugEnabled()) log.debug("i:"+i);
								if (log.isDebugEnabled()) log.debug("bMarcacion2("+i+"):"+bMarcacion2);
								if (log.isDebugEnabled()) log.debug("fechaMarcacion2("+i+"):"+fechaMarcacion2);
								if (log.isDebugEnabled()) log.debug("horaMarcacion2("+i+"):"+horaMarcacion2);
								if (i == 0){//primera marcacion es ENTRADA
									if (log.isDebugEnabled()) log.debug("primera marca");
									fechaFinMov2 = bMarcacion2.getFecha();
									horaFinMov2 = "";
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 ent:"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 ent:"+horaFinMov2);									
									tMov2 = preCalificarEntradaOpe2(
											fechaMarcacion2,
											horaMarcacion2,
											turnoDx.getHoraIni(),
											turnoDx.getTolera(),
											turnoDx.getHoraLimite(),
											Constantes.MINUTO);
									if (log.isDebugEnabled()) log.debug("salida6.1 preCalificarEntradaOpe2(tMov2):"+tMov2);	
									if (tMov2.equals(Constantes.MOV_ENTRADA_ANTICIPADA)) {
										tMov2 = Constantes.ENTRADA_NORMAL;
										if (log.isDebugEnabled()) log.debug("tMov4-CAS:"+tMov2);
									}
									//hsal cuando es tardanza 01 se coloca valor
									if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO) ) {
										horaFinMov2=turnoDx.getHoraIni();
									}
									//fin hsal
									/*EBV 31/03/2015 CAMBIO DE LINEAMIENTO
									if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO)) {
										tMov2 = Constantes.MOV_TARDANZA_EFECTIVA;
										if (log.isDebugEnabled()) log.debug("tMov5-CAS:"+tMov2);
									} */
								}
								//movimientos intermedios
								else{
									if (log.isDebugEnabled()) log.debug("marcaciones6 en pareja desde inicio(i):"+i);					
									if (log.isDebugEnabled()) log.debug("listaMarcaciones.size():"+listaMarcaciones.size());							
									if (i <= (listaMarcaciones.size() - 2)) {
										if (log.isDebugEnabled()) log.debug("i:"+i);
										bMSgte2 = (BeanMarcacion) listaMarcaciones.get(++i);							
										fechaFinMov2 = bMSgte2.getFecha();
										horaFinMov2 = bMSgte2.getHora();
										relojFin2 = bMSgte2.getReloj();
										if (log.isDebugEnabled()) log.debug("bMSgte2 int:"+bMSgte2);
										if (log.isDebugEnabled()) log.debug("fechaFinMov2 int :"+fechaFinMov2);
										if (log.isDebugEnabled()) log.debug("horaFinMov2 int:"+horaFinMov2);
										if (log.isDebugEnabled()) log.debug("relojFin2 int:"+relojFin2);
										if (log.isDebugEnabled()) log.debug("i2:"+i);																													
										//tMov2 = preCalificarMovimientoOpe2(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDx,	Constantes.MINUTO, tieneRefrigerio,	bOperativo2); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										tMov2 = preCalificarMovimientoOpe2(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDx,Constantes.MINUTO, tieneRefrigerio,bOperativo2,procesaClima,minMaxClima); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										if (log.isDebugEnabled()) log.debug("salida6 preCalificarMovimientoOpe2(tMov2):"+tMov2);	

										//if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
											if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
																						
											// ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
											Map calificacionActual=null;
											calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "2", "3","5"); //0=calificacion inicial, 2=papeleta aprobada, 3= papeleta procesada, //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral (adicion 5=calificacion por rrhh)
											if (log.isDebugEnabled()) log.debug("calificacionActuall : "+calificacionActual);												
											if (calificacionActual!=null){
												if (log.isDebugEnabled()) log.debug("entrooooo");
												movAct= calificacionActual.get("mov").toString().trim();//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
												//if (tMov2.trim().equals(calificacionActual.get("mov").toString().trim())){ ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
												if (movAct.equals(Constantes.MOV_EXCESO_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRI_CLIMALABORAL) ){ //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (log.isDebugEnabled()) log.debug("movAct igual a refri, exceso o refri clima");
													if (log.isDebugEnabled()) log.debug("tMov2 : "+tMov2);
													if (log.isDebugEnabled()) log.debug("calificacionActual : "+calificacionActual);
													
													if (log.isDebugEnabled()) log.debug("tieneRefrigerio : "+tieneRefrigerio);
													if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
													tieneRefrigerio = true;
													if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2:"+fechaMarcacion2 + " " + horaMarcacion2);
													if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2:"+fechaMarcacion2 + " " + horaFinMov2);
													float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
													if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
													
													//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (procesaClima){
														float quedan = minMaxClima - durante1;	
														if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
														if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
														minMaxClima= new Float(quedan).intValue();
														//new
														if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
															excesoClima=true;
														}
														if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
															refriClima=true;
														}
														//new
													}else{
													//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
														float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
														log.debug("turnoDx.getMinutosRefrigerio(): " + turnoDx.getMinutosRefrigerio());
														if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
														turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());
													}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral												
												}else{
													tieneRefrigerio = false;
													if (log.isDebugEnabled()) log.debug("tieneRefrigerio: "+tieneRefrigerio);
												}													
											}
											//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas
											else{													
												calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "0", "0","0"); //0=calificacion inicial
												if (log.isDebugEnabled()) log.debug("calificacionActual2 : "+calificacionActual);
												if (calificacionActual==null){
													tieneRefrigerio = true;
													float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
													if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
													
													//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (procesaClima){
														float quedan = minMaxClima - durante1;	
														if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
														if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
														minMaxClima= new Float(quedan).intValue();
														//new
														if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
															excesoClima=true;
														}
														if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
															refriClima=true;
														}
														//new
													}else{
													//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
														float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
														log.debug("turnoDx.getMinutosRefrigerio(): " + turnoDx.getMinutosRefrigerio());
														if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
														turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());
													}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral																								
												}													
											}
											//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas
											//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
										}																						
									}else{//marcacion par
										if (log.isDebugEnabled()) log.debug("marcacion par CAS(i):"+i);
										fechaFinMov2 = bMarcacion2.getFecha();
										horaFinMov2 = "";																				
										tMov2 = Constantes.MOV_OMISION_MARCA;
										//tMov2 = Constantes.MOV_SALIDA_AUTORIZADA;
										if (log.isDebugEnabled()) log.debug("tMov12-CAS:"+tMov2);										
									}																	
								}
								//fin mov intermedios

								try{
									if (horaFinMov2!=null && horaFinMov2!="") {
										log.debug("borrando6 asistencia CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
										t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
									}
									Map params1 = new HashMap();
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);
									params1.put("cod_uorgan", codUO);
									params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
									params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
									params1.put("fechaFinMov", (fechaFinMov2!=null  && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									params1.put("mov", tMov2);
									params1.put("relojIni", relojIni2);
									params1.put("relojFin", relojFin2);
									params1.put("usuario", usuario);	
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI (SES");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else {	
										log.debug("isProcesar NO (SES)");
										boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
										if (inserto){
											log.debug("SI inserto1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO inserto1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0		
								}
								catch(Exception e){
									if (log.isDebugEnabled()) log.debug("catch6- generarAsistenciaTrabajadorCAS");										
									Map params1 = new HashMap();
									params1.put("mov", tMov2);
									params1.put("fechaFinMov", (fechaFinMov2!=null  && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("usuario", usuario);
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);							
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", horaMarcacion2);
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);	
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else{
										log.debug("isProcesar NO");
									//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
										boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
										if (actualizo){
											log.debug("SI actualizo1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO actualizo1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									
								}
							}//fin for ok
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral - new
							if (autoriClima!=null && !autoriClima.isEmpty()){
								estadoAut=autoriClima.get("ind_aut").toString().trim();
								cod_auto = autoriClima.get("cod_aut").toString().trim();
								if ((excesoClima==true || refriClima==true) && estadoAut.equals("0")){
									log.debug("actualizara estado autorizacion (codPers: "+codPers+" fechaEval: "+fechaEval+" )");
									prms.put("ind_aut", Constantes.ACTIVO);					
									prms.put("cod_user_mod", "BATCH-CLIMA-LAB");
									prms.put("cod_pers", codPers);
									prms.put("fec_aut", autoriClima.get("fec_aut_desc").toString());					
									climaLabDAO.updateRegistroAutorizaCli(prms);
									
									//envio correo
									nomApell = (autoriClima.get("t02ap_pate")!=null?autoriClima.get("t02ap_pate").toString().trim():"")+" "+(autoriClima.get("t02ap_mate")!=null?autoriClima.get("t02ap_mate").toString().trim():"")+" "+(autoriClima.get("t02nombres")!=null?autoriClima.get("t02nombres").toString().trim():"");
									mParams.put("registro",codPers);
									if (log.isDebugEnabled()) log.debug("mParamss: " + mParams);
									
									mensajeF = "El sistema ha procedido a calificar sus marcaciones de Clima Laboral para la fecha "+(String)autoriClima.get("fec_aut_desc")+".";	
									if (log.isDebugEnabled()) log.debug("mensajeFF: " + mensajeF);	
									mensaje = textoCorreoClimaLaboral(mParams,nomApell,mensajeF);//mensaje en html
									if (log.isDebugEnabled()) log.debug("mensajee: " + mensaje);																			
									Correo objCorreo = new Correo(mensaje.toString());									
									objCorreo.setServidor(propiedadesCorreo.leePropiedad("servidor"));									
									objCorreo.setRemitente(propiedadesCorreo.leePropiedad("correoRemitenteMovimientos"),propiedadesCorreo.leePropiedad("nombreRemitenteMovimientos"));
															
									correoColab=correoDAO.findCorreoByRegistro(codPers);
									correoAutoriz=correoDAO.findCorreoByRegistro(cod_auto);
														
									// VALIDANDO SI TRABAJADOR TIENE CORREO																
									if (!correoColab.equals("")) {						
										if (log.isDebugEnabled()) log.debug("correoColab Trabajador= " + correoColab);
										try{
											//trabajador tiene correo correcto, se debe enviar correo a trabajador con copia a autorizador								
											objCorreo.agregarDestinatario(correoColab.trim());
											if(!correoAutoriz.equals("")){
												objCorreo.agregarConCopia(correoAutoriz.trim());
											}
											//objCorreo.agregarConCopia("jquispecoi@sunat.gob.pe");/////ELIMINAR
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral");
											objCorreo.enviarHtml();		
											if (log.isDebugEnabled()) log.debug("Se envio correo a trabajador");	
																		
										} catch (CorreoException ce) {
											//trabajador tiene correo erroneo, hay destinatario erroneo 
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - CORREO ERR흁EO");
											objCorreo.enviarHtml();
									 		if (log.isDebugEnabled()) log.debug("Error en CorreoExceptionn: "+ce.toString());									 	
										 	if (log.isDebugEnabled()) log.debug("SI tiene correo trabajador: "+codPers+" - pero correo es erroneo");									 										 	
										}											
									}//fin if tiene correo
									else {
										//trabajador no tiene correo, no hay destinatario y se debe copiar a rrhh correo
										objCorreo.agregarConCopia(propiedadesCorreo.leePropiedad("correoReceptorAlertaCambioTurnos"));
										objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - NO TIENE CORREO");
										objCorreo.enviarHtml();							
										if (log.isDebugEnabled()) log.debug("NO tiene correo trabajador: " + codPers+" - se envio a rrhh");
									}
									//fin envio correo
								}
							}							
							//ICAPUNAY - PAS20175E230300069
						}						
					}
				}				
			}//fin turnoDx!=null
			else{
				if (log.isDebugEnabled()) log.debug("NO tiene turno dia x");
				fechaAntes = Utiles.dameFechaAnterior(fechaEval, 1);	    		   
				BeanTurnoTrabajo turnoDw = daoTurno.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,codPers,fechaAntes); //dia (x-1)
				if (log.isDebugEnabled()) log.debug("turno3 dia x-1 (turnoDw)("+codPers+"): " + turnoDw);
				if (turnoDw!=null){	
					if (log.isDebugEnabled()) log.debug("registro("+codPers+"): SI turno (dia x-1) de 2 dias y NO turno dia x (marcaciones IMPARES requiere para dia x)");
					horaIniTurnoDw = turnoDw.getHoraIni().trim();
					horaFinTurnoDw = turnoDw.getHoraFin().trim();
					bOperativo2 = turnoDw.isOperativo();
					tieneRefrigerio = false;
					if (log.isDebugEnabled()) log.debug("horaIniTurnoDw3("+codPers+"): " + horaIniTurnoDw);
					if (log.isDebugEnabled()) log.debug("horaFinTurnoDw3("+codPers+"): "+ horaFinTurnoDw);
					
					//preCalificarSalidaOpe1 //preCalificarMovimientoOpe1 //solo S
					
					//impar requiere (13/09/2014 par es omision)
					//coloque refrigerio de 03 a 05 al turno C06 y debe tomar 60 min (pruebas)
					//hora limite 00:30 y tolerancia 10 min al turno C06 (hora inicio turno 22:30 para el 12/09/2014)
					listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
					if (log.isDebugEnabled()) log.debug("listaMarcaciones:"+listaMarcaciones);
					if (listaMarcaciones != null && listaMarcaciones.size() > 0) {						
						for (int i = 0; i < listaMarcaciones.size(); i++) {	
							bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
							fechaMarcacion2 = bMarcacion2.getFecha();
							horaMarcacion2 = bMarcacion2.getHora();
							relojIni2 = bMarcacion2.getReloj();
							relojFin2 = "";
							if (log.isDebugEnabled()) log.debug("i:"+i);
							if (log.isDebugEnabled()) log.debug("bMarcacion2("+i+"):"+bMarcacion2);
							if (log.isDebugEnabled()) log.debug("fechaMarcacion2("+i+"):"+fechaMarcacion2);
							if (log.isDebugEnabled()) log.debug("horaMarcacion2("+i+"):"+horaMarcacion2);
							if (i == (listaMarcaciones.size() - 1)){//ultima marcacion es SALIDA
								if (log.isDebugEnabled()) log.debug("ultima marca");
								fechaFinMov2 = bMarcacion2.getFecha();
								horaFinMov2 = "";
								if (log.isDebugEnabled()) log.debug("fechaFinMov2 sal:"+fechaFinMov2);
								if (log.isDebugEnabled()) log.debug("horaFinMov2 sal:"+horaFinMov2);									
								tMov2 = preCalificarSalidaOpe1(
										dbpool,
										codPers,
										fechaMarcacion2,
										horaMarcacion2,
										turnoDw.getHoraFin(),
										Constantes.MINUTO);
								if (log.isDebugEnabled()) log.debug("salida2 preCalificarSalidaOpe1(tMov2):"+tMov2);
								//ICR 18052015
								if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
									horaFinMov2=turnoDw.getHoraFin();
								}
								//ICR 18052015
							}
							//movimientos intermedios
							else{
								if (log.isDebugEnabled()) log.debug("marcaciones en pareja desde inicio(i):"+i);					
								if (log.isDebugEnabled()) log.debug("listaMarcaciones.size():"+listaMarcaciones.size());							
								if (i < (listaMarcaciones.size() - 2)) {
									if (log.isDebugEnabled()) log.debug("i:"+i);
									bMSgte2 = (BeanMarcacion) listaMarcaciones.get(++i);							
									fechaFinMov2 = bMSgte2.getFecha();
									horaFinMov2 = bMSgte2.getHora();
									relojFin2 = bMSgte2.getReloj();
									if (log.isDebugEnabled()) log.debug("bMSgte2 int:"+bMSgte2);
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 int :"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 int:"+horaFinMov2);
									if (log.isDebugEnabled()) log.debug("relojFin2 int:"+relojFin2);
									if (log.isDebugEnabled()) log.debug("i2:"+i);																													
									tMov2 = preCalificarMovimientoOpe1(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDw,	Constantes.MINUTO, tieneRefrigerio,	bOperativo2);
									if (log.isDebugEnabled()) log.debug("salida preCalificarMovimientoOpe1(tMov2):"+tMov2);	

									/*if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) {
										if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
										tieneRefrigerio = true;
										if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2:"+fechaMarcacion2 + " " + horaMarcacion2);
										if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2:"+fechaMarcacion2 + " " + horaFinMov2);
										float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
										float quedan = turnoDw.getMinutosRefrigerio() - durante1;
										if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
										if (log.isDebugEnabled()) log.debug("quedan:"+quedan);
										turnoDw.setMinutosRefrigerio( new Float(quedan).intValue());
										log.debug("turnoDw(setMinutosRefrigerio o quedan) : " + quedan);
									}*/																						
								}else{//marcacion par
									if (log.isDebugEnabled()) log.debug("marcacion par CAS(i):"+i);
									fechaFinMov2 = bMarcacion2.getFecha();
									horaFinMov2 = "";																				
									tMov2 = Constantes.MOV_OMISION_MARCA;
									//tMov2 = Constantes.MOV_SALIDA_AUTORIZADA;									
									if (log.isDebugEnabled()) log.debug("tMov12-CAS:"+tMov2);										
								}																	
							}
							//fin mov intermedios

							try{
								if (horaFinMov2!=null && horaFinMov2!="") {
									log.debug("borrando5 asistencia CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
									t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
								}
								Map params1 = new HashMap();
								params1.put("cod_pers", codPers);
								params1.put("periodo", periodo);
								params1.put("cod_uorgan", codUO);
								params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
								params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
								params1.put("fechaFinMov", (fechaFinMov2!=null  && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
								params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
								params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
								params1.put("mov", tMov2);
								params1.put("relojIni", relojIni2);
								params1.put("relojFin", relojFin2);
								params1.put("usuario", usuario);	
								
								//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
								if (isProcesar.equals("SI")){
									log.debug("isProcesar SI (SES");
									if (papeletasGeneradas==null){
										papeletasGeneradas = new ArrayList();											
									}
										
									params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
									List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																		
									if(lstPapeletaGenerada.size()>0){
										HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
										hmPapeletaGenerada.put("mov",tMov2);
										hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
										papeletasGeneradas.add(hmPapeletaGenerada);
										log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
									}									
								}else {	
									log.debug("isProcesar NO (SES)");
									boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
									if (inserto){
										log.debug("SI inserto1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}else{										
										log.debug("NO inserto1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}	
								}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0		
							}
							catch(Exception e){
								if (log.isDebugEnabled()) log.debug("catch2- generarAsistenciaTrabajadorCAS");										
								Map params1 = new HashMap();
								params1.put("mov", tMov2);
								params1.put("fechaFinMov", (fechaFinMov2!=null  && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
								params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
								params1.put("usuario", usuario);
								params1.put("cod_pers", codPers);
								params1.put("periodo", periodo);							
								params1.put("fechaMarcacion", fechaMarcacion2);
								params1.put("horaMarcacion", horaMarcacion2);
								params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
								
								//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
								if (isProcesar.equals("SI")){
									log.debug("isProcesar SI");
									if (papeletasGeneradas==null){
										papeletasGeneradas = new ArrayList();											
									}
										
									params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
									List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																		
									if(lstPapeletaGenerada.size()>0){
										HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
										hmPapeletaGenerada.put("mov",tMov2);
										hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
										papeletasGeneradas.add(hmPapeletaGenerada);
										log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
									}									
								}else{
									log.debug("isProcesar NO");
								//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
									if (actualizo){
										log.debug("SI actualizo1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}else{										
										log.debug("NO actualizo1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}	
								}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
								
							}
						}//fin for ok						
					}					
				}else{
					if (log.isDebugEnabled()) log.debug("registro("+codPers+"): NO turno (dia x-1) de 2 dias y NO turno dia x");
					BeanTurnoTrabajo turnoNoControlado = null;
					BeanTurnoTrabajo turnoNoControl1 = daoTurno.joinWithT45ByCodPersFecha_NoControlado_OperAdm1dia(dbpool,codPers,fechaEval);
					if (turnoNoControl1!=null){
						turnoNoControlado=turnoNoControl1;					    
					}else{
						BeanTurnoTrabajo turnoNoControl2 = daoTurno.joinWithT45ByCodPersFecha_NoControlado_Oper2dias(dbpool,codPers,fechaEval);
						turnoNoControlado=turnoNoControl2;				    
					}
					if (log.isDebugEnabled()) log.debug("turnoNoControlado("+fechaEval+"): " + "("+codPers+"): "+turnoNoControlado);
					
					if (turnoNoControlado!=null){//tiene turno no controlado de 1 o 2 dias (adm u ope)						
						//no control 2 dias (ope: 43, 002 {lo puede trabajar como turno no controlado operativo de 1 dia})						
							
						listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
						if (log.isDebugEnabled()) log.debug("listaMarcaciones:"+listaMarcaciones);
						if (listaMarcaciones != null && listaMarcaciones.size() > 0) {
							for (int i = 0; i < listaMarcaciones.size(); i++) {	
								bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
								fechaMarcacion2 = bMarcacion2.getFecha();
								horaMarcacion2 = bMarcacion2.getHora();
								relojIni2 = bMarcacion2.getReloj();
								relojFin2 = "";									
								if ((i==0) || i == (listaMarcaciones.size() - 1)){
									if (log.isDebugEnabled()) log.debug("marcaciones primera o ultima");
									fechaFinMov2 = bMarcacion2.getFecha();
									horaFinMov2 = "";										
								}else{//movs intermedios
									if (log.isDebugEnabled()) log.debug("marcaciones en pareja");
									if (i < (listaMarcaciones.size() - 2)) {
										if (log.isDebugEnabled()) log.debug("i:"+i);
										bMSgte2 = (BeanMarcacion) listaMarcaciones.get(++i);							
										fechaFinMov2 = bMSgte2.getFecha();
										horaFinMov2 = bMSgte2.getHora();
										relojFin2 = bMSgte2.getReloj();											
									}else{//marcacion impar
										if (log.isDebugEnabled()) log.debug("marcacion impar");
										fechaFinMov2 = bMarcacion2.getFecha();
										horaFinMov2 = "";																			
									}
								}
								if ((Constantes.TURNO_RS067).equals(turnoNoControlado.getTurno().trim())){
									tMov2 = Constantes.MOV_RESOLUCION_067;										
								}else{//otros turnos no control 1 dia
									tMov2 = Constantes.MOV_TRABAJO_CAMPO;
								}
								if (log.isDebugEnabled()) log.debug("tMov2-CAS:"+tMov2);

								try{
									if (horaFinMov2!=null && horaFinMov2!="") {
										log.debug("borrando2 asistencia CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
										t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
									}
									Map params1 = new HashMap();
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);
									params1.put("cod_uorgan", codUO);
									params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
									params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
									params1.put("fechaFinMov", (fechaFinMov2!=null  && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									params1.put("mov", tMov2);
									params1.put("relojIni", relojIni2);
									params1.put("relojFin", relojFin2);
									params1.put("usuario", usuario);
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI (SES");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else {	
										log.debug("isProcesar NO (SES)");
										boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
										if (inserto){
											log.debug("SI inserto1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO inserto1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0			
								}
								catch(Exception e){
									if (log.isDebugEnabled()) log.debug("catch2- generarAsistenciaTrabajadorCAS");										
									Map params1 = new HashMap();
									params1.put("mov", tMov2);
									params1.put("fechaFinMov", (fechaFinMov2!=null  && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("usuario", usuario);
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);							
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", horaMarcacion2);
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else{
										log.debug("isProcesar NO");
									//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
										boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
										if (actualizo){
											log.debug("SI actualizo1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO actualizo1 CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									
								}									
							}								
						}							
										
					}else{
						//NO TIENE NINGUN TURNO (NO DEBE CALIFICAR)
						if (log.isDebugEnabled()) log.debug("Ningun turno-No debe calificar");
						
					}					
				}
			}
			//FIN ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)

	    }//fin generar true
	    
	    params.put("papeletasGeneradas", papeletasGeneradas);
	    
	    if (log.isDebugEnabled()) log.debug("fin de metodo ProcesoFacade - generarAsistenciaTrabajadorCAS");//LOG GENERACION
	}catch (Exception e){
		log.fatal("Error en el registro CAS de asistencias del trabajador "+codPers+" con fecha "+fechaEval+" : "+ e.getMessage(),e);
		throw new IncompleteConversationalState(e.toString());
	}
}
	//
	
	//ICAPUNAY 15/12/2010 AOM URGENTE: 44U3T10 Gesti칩n de turnos y calificacion de procesos
	/**	
	 * Metodo encargado de la Planificacion de Turnos Masivos 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"	 
	 * @param mapa HashMap
	 * @param usuario String
	 * @return	String
	 * @throws RemoteException
	 */
	public String planificarTurnosMasivos(HashMap mapa, String usuario)
			throws RemoteException {

		String result = Constantes.OK; 
		String mes=null;
		String anio=null;
		
		boolean cruce = mapa.get("cmbCruce").equals("1");
		mes =  (String)mapa.get("cmbMes");
		anio =  (String)mapa.get("cmbAnio");
		
		mapa.put("cruce", "" + cruce);
		
		
		if (log.isDebugEnabled()) log.debug("Ingreso al metodo planificarTurnosMasivos-ProcesoFacade");
		if (log.isDebugEnabled()) log.debug("result al iniciar: "+result);
		
		try {
			
			if (log.isDebugEnabled()) log.debug("Va a ingresar al metodo validarArchivoCsvTurnos-ProcesoFacade");
			if (log.isDebugEnabled()) log.debug("mapa validarArchivoCsvTurnos: "+mapa);
			if (log.isDebugEnabled()) log.debug("usuario validarArchivoCsvTurnos: "+usuario);
			
			String resVal=validarArchivoCsvTurnos(mapa,usuario);
			
			if (log.isDebugEnabled()) log.debug("Salio del metodo validarArchivoCsvTurnos-ProcesoFacade");
			if (log.isDebugEnabled()) log.debug("Estado DESPUES de Validacion (resVal): "+resVal);
			
			if("Error".equals(resVal)){
				
				result="Error";
				if (log.isDebugEnabled()) log.debug("Estado ERROR Validacion (resVal): "+resVal);
				
			}else{			
				
				mapa.put("observacion", "Registro de turnos Masivos de "+ mes + "/" + anio);
				
				if (log.isDebugEnabled()) log.debug("Va a ingresar al metodo cargarTurnosMasivos-ProcesoFacade");
				if (log.isDebugEnabled()) log.debug("mapa cargarTurnosMasivos: "+mapa);
				if (log.isDebugEnabled()) log.debug("usuario cargarTurnosMasivos: "+usuario);
				
				QueueDAO qd = new QueueDAO();
				qd.encolaProceso(ProcesoFacadeHome.JNDI_NAME,
				"cargarTurnosMasivos", mapa, usuario);	
				
				if (log.isDebugEnabled()) log.debug("Salio del metodo cargarTurnosMasivos-ProcesoFacade");
				
			}
			
		} catch (Exception e) {	
			result="Error";		
			log.error(e.getMessage());
			
		} finally {
			try {
				
				result = Constantes.OK;
				
			} catch (Exception e) {				
				result="Error";				
				log.error(e.getMessage());
			}
		}
		return result;
		
	}


	/**	 
	 * Metodo encargado de la Validacion del Archivo de Turnos Masivos
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"	
	 * @param mapa HashMap
	 * @param usuario String
	 * @return	String
	 * @throws RemoteException
	 */
	public String validarArchivoCsvTurnos(HashMap mapa, String usuario)
			throws RemoteException {

		String res = Constantes.OK; 
		String id = (String) mapa.get("messageID");
		String dbpool = (String) mapa.get("dbpool");
		String texto=null;
		
		if (log.isDebugEnabled()) log.debug("Ingreso al metodo validarArchivoCsvTurnos-ProcesoFacade");
		if (log.isDebugEnabled()) log.debug("res al iniciar: "+res);		
		if (log.isDebugEnabled()) log.debug("mapa: "+mapa);
		if (log.isDebugEnabled()) log.debug("usuario: "+usuario);
		if (log.isDebugEnabled()) log.debug("id: "+id);
		if (log.isDebugEnabled()) log.debug("dbpool: "+dbpool);
		
		try {		
			
			super.creaLog(id, "VALIDACION DE TURNOS MASIVOS", usuario);
			
			String mes = (String) mapa.get("cmbMes");
			String anio = (String) mapa.get("cmbAnio");	
			/* ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
			String codUO = (String) mapa.get("cmbUUOO");
			codUO = codUO.toUpperCase();
			*/
			List archivoCSV = (List) mapa.get("archivo");			
			Map cabecera = (HashMap) archivoCSV.get(0);//obteniendo la cabecera del archivo
			
			if (log.isDebugEnabled()) log.debug("mes: "+mes);
			if (log.isDebugEnabled()) log.debug("anio: "+anio);		
			//if (log.isDebugEnabled()) log.debug("codUO: "+codUO);
			if (log.isDebugEnabled()) log.debug("cabecera: "+cabecera);			
			if (log.isDebugEnabled()) log.debug("llego1");

			// VALIDANDO CADA UNO DE LOS REGISTROS DEL ARCHIVO CSV - NO INCLUYE LA CABECERA
			T02DAO dao02 = new T02DAO();
			pe.gob.sunat.rrhh.asistencia.dao.T45DAO dao45Abstract = new pe.gob.sunat.rrhh.asistencia.dao.T45DAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dgsp"));
			T45DAO dao45 = new T45DAO();
			
			if (log.isDebugEnabled()) log.debug("llego2");
			
			texto=" Fila "+"  Reg  "+"    UO    "+"      Nombre      "+"  Turno "+" Inicio "+" Fin "+"     Problema     ";					
			super.escribe(texto,"VALIDACION DE TURNOS MASIVOS", mapa, usuario);
			
			texto="--------------------------------------------------------------------------------------";					
			super.escribe(texto,"VALIDACION DE TURNOS MASIVOS", mapa, usuario);
			
			if (log.isDebugEnabled()) log.debug("llego3");
			
			int tamanoArchivo=archivoCSV.size();
			int numRegMatriz=0;
			//ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
			//String[][] m = new String[tamanoArchivo][5];
			String[][] m = new String[tamanoArchivo][7];
			//
			int filasErroneas=0;
			boolean swError=false;
			SimpleDateFormat sd = new SimpleDateFormat("dd/MM/yyyy", Locale.getDefault());			
			boolean fInicioCorrecta=false;
			boolean fFinCorrecta=false;
			int numFila=0;
			String problema=null;
			Map fila=new HashMap();
			String codReg=null;
			String turno=null;
			String inicio=null;
			String fin=null;  
			String sustento=null;
			HashMap mapaPersona=new HashMap();
			String nombre=null;
			Map mapaTurnoExiste = new HashMap();
			String codTurnoExiste;
			ArrayList mapaTurnoActivo=new ArrayList();
			ConvertidorCSVaLIST validadorFecha = new ConvertidorCSVaLIST();
			boolean validacionFInicio=false;
			Vector fechaInicioSeparada;
			StringTokenizer st;
			int digDiasInicio;
			int digMesInicio;
			int digAnioInicio;			
			boolean validacionFFin=false;
			Vector fechaFinSeparada;
			StringTokenizer stf;
			int digDiasFin;
			int digMesFin;
			int digAnioFin;
			Date fecIni = new Date();	
			Date fecFin = new Date();
			Date fecSeleccionada = new Date();
			String regiAux=null;
			String turnoAux=null;
			String inicioAux=null;
			String finAux=null;
			String filaAux=null;
			// ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
			String nombreAux = null;
			String uoAux = null;
			//
			Date InicioI = new Date();
			Date InicioJ = new Date();			
			Date FinI = new Date();
			Date FinJ = new Date();
			String codRegJ=null;
			String turnoJ=null;
			String filaJ=null;			
			String problemaJ=null;	
			// ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE			
			String uoJ=null;
			//
			int numFilasVector=0;
			String[] v;
			Date inicioI = new Date();
			Date finI = new Date();		
			Date inicioJ = new Date();
			Date finJ = new Date();
			int filasValidadas=0;
			// ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
			//HashMap mapaPersonaJ=new HashMap();
			//
			String nombreJ=null;
			
			// ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
			String codUO = null;
			//
			
			if (log.isDebugEnabled()) log.debug("llego4");
			
			for (int i = 1; i < tamanoArchivo; i++) {//inicio del for del archivo			
			
				fInicioCorrecta=false;
				fFinCorrecta=false;
				codTurnoExiste = null;
				digDiasInicio=0;
				digMesInicio=0;
				digAnioInicio=0;
				digDiasFin=0;
				digMesFin=0;
				digAnioFin=0;
				
				if (log.isDebugEnabled()) log.debug("Entro a FOR");
				
				numFila=i+1;						
				
				fila = (HashMap) archivoCSV.get(i);	//OBTENIENDO EL REGISTRO COMPLETO
			
				if (log.isDebugEnabled()) log.debug("fila ("+numFila+"): "+fila);
				
				codReg = (String)fila.get(cabecera.get(new Integer(0)));//cod registro
				turno = (String)fila.get(cabecera.get(new Integer(1)));//cod turno
				inicio = (String)fila.get(cabecera.get(new Integer(2)));//fecha inicio
				fin = (String)fila.get(cabecera.get(new Integer(3)));//fecha fin
				sustento=(String)fila.get(cabecera.get(new Integer(4)));
				//String cadenaNormalize = Normalizer.normalize(sustento, Normalizer.Form.NFD);   
				//String cadenaSinAcentos = cadenaNormalize.replaceAll("[^\\p{ASCII}]", "");
				//sustento=sustento.replace("[^a-zA-Z0-9]", "");
						
				// CONVIRTIENDO el Registro a Mayuscula y fijandolo en el archivo
				codReg = codReg.toUpperCase();				
				fila.put(cabecera.get(new Integer(0)), codReg);
				if (log.isDebugEnabled()) log.debug("codReg Mayusc.: "+codReg);
				
				//nuevo codigo agregado				  
				// CONVIRTIENDO el Turno a Mayuscula y fijandolo en el archivo
				turno = turno.toUpperCase();				
				fila.put(cabecera.get(new Integer(1)), turno);	
				if (log.isDebugEnabled()) log.debug("turno Mayusc.: "+turno);
				//fin nuevo codigo agregado
				
				// VALIDANDO que exista el codigo de registro y que se encuentre activo
				mapaPersona = dao02.findByCodPers(dbpool, codReg);
				if (log.isDebugEnabled()) log.debug("llego5"); //BORRAR
								
				//fijando nombre de persona obtenida					
				if ((mapaPersona.get("t02ap_pate").equals("S/descripcion")) && (mapaPersona.get("t02ap_mate").equals("-")) && (mapaPersona.get("t02nombres").equals("-"))){
					nombre="";
				}else{
					nombre=((String)mapaPersona.get("t02ap_pate")).trim()+" "+((String)mapaPersona.get("t02ap_mate")).trim()+" "+((String)mapaPersona.get("t02nombres")).trim();					
				}
				if (log.isDebugEnabled()) log.debug("nombre: "+nombre);
				if (log.isDebugEnabled()) log.debug("llego6"); //BORRAR
				
				if (mapaPersona.get("t02cod_pers").equals("-")) {
					
					// ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
					if (log.isDebugEnabled()) log.debug("llego7"); //BORRAR
					codUO="";
					if (log.isDebugEnabled()) log.debug("codUO: "+codUO);
					//
					
					// VALIDANDO que Registro no existe					
					problema="Registro no existe";					
					texto = String.valueOf(numFila)+ " "+codReg+" "+codUO+" "+nombre+" "+turno+" "+inicio+" "+fin+" "+problema;						
					super.escribe(texto, "VALIDACION DE TURNOS MASIVOS",mapa, usuario);					
					res="Error";					
					swError=true;	
					if (log.isDebugEnabled()) log.debug("Registro no existe");
					
				} else {
					
					if (log.isDebugEnabled()) log.debug("llego8"); //BORRAR
					if (log.isDebugEnabled()) log.debug("mapaPersona: "+mapaPersona);
					// ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
					if (mapaPersona.get("t02cod_uorgl") == null || mapaPersona.get("t02cod_uorgl").toString().trim().equals("")) {
						if (mapaPersona.get("t02cod_uorg") == null || mapaPersona.get("t02cod_uorg").toString().trim().equals("")) {
							codUO="";
							if (log.isDebugEnabled()) log.debug("codUO: "+codUO);
						}else{
							codUO = ((String)mapaPersona.get("t02cod_uorg")).trim();
							if (log.isDebugEnabled()) log.debug("codUO_cod_uorg: "+codUO);
						}						
					}else{
						codUO = ((String)mapaPersona.get("t02cod_uorgl")).trim();
						if (log.isDebugEnabled()) log.debug("codUO_cod_uorgl: "+codUO);
					}		
					// FIN ICAPUNAY 27/04/2011
					
					if (mapaPersona.get("t02cod_stat").equals("0")) {
						
						if (log.isDebugEnabled()) log.debug("llego9"); //BORRAR
						//VALIDANDO que Registro no esta activo (pero si existe)						
						problema="Registro no activo";						
						texto = String.valueOf(numFila)+ " "+codReg+" "+codUO+" "+nombre+" "+turno+" "+inicio+" "+fin+" "+problema;						
						super.escribe(texto, "VALIDACION DE TURNOS MASIVOS",mapa, usuario);						
						res="Error";						
						swError=true;	
						if (log.isDebugEnabled()) log.debug("Registro no activo");
					}
					
					// VALIDANDO que el registro tenga asignada una UO o pertenenezca a la UO seleccionada
					else {					
						if (mapaPersona.get("t02cod_uorgl") == null || mapaPersona.get("t02cod_uorgl").toString().trim().equals("")) {
							if (log.isDebugEnabled()) log.debug("llego10"); //BORRAR
							if (mapaPersona.get("t02cod_uorg") == null || mapaPersona.get("t02cod_uorg").toString().trim().equals("")) {
								// VALIDANDO que Registro no tiene UO asignada
								if (log.isDebugEnabled()) log.debug("llego11"); //BORRAR
								problema="Registro no tiene UO asignada";								
								texto = String.valueOf(numFila)+ " "+codReg+" "+codUO+" "+nombre+" "+turno+" "+inicio+" "+fin+" "+problema;						
								super.escribe(texto, "VALIDACION DE TURNOS MASIVOS",mapa, usuario);								
								res="Error";							
								swError=true;	
								if (log.isDebugEnabled()) log.debug("Registro no tiene UO asignada");
								
							}
							/* ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
							else {								
								if (!mapaPersona.get("t02cod_uorg").equals(codUO)) {
									// VALIDANDO que Registro no pertenece a UO seleccionada									
									problema="Registro no pertenece a UO seleccionada";									
									texto= String.valueOf(numFila)+ " "+codReg+" "+codUO+" "+nombre+" "+turno+" "+inicio+" "+fin+" "+problema;						
									super.escribe(texto, "VALIDACION DE TURNOS MASIVOS",mapa, usuario);									
									res="Error";								
									swError=true;	
									if (log.isDebugEnabled()) log.debug("Registro no pertenece a UO seleccionada");
								}							
							}
							*/							
						} 
						/* ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
						else {							
							if (!mapaPersona.get("t02cod_uorgl").equals(codUO)) {								
								if (mapaPersona.get("t02cod_uorg") == null || mapaPersona.get("t02cod_uorg").toString().trim().equals("")) {
									// VALIDANDO que Registro no pertenece a UO seleccionada									
									problema="Registro no pertenece a UO seleccionada";								
									texto = String.valueOf(numFila)+ " "+codReg+" "+codUO+" "+nombre+" "+turno+" "+inicio+" "+fin+" "+problema;						
									super.escribe(texto, "VALIDACION DE TURNOS MASIVOS",mapa, usuario);									
									res="Error";									
									swError=true;	
									if (log.isDebugEnabled()) log.debug("Registro no pertenece a UO seleccionada");
									
								}else{									
									if (!mapaPersona.get("t02cod_uorg").equals(codUO)) {
										// VALIDANDO que Registro no pertenece a UO seleccionada										
										problema="Registro no pertenece a UO seleccionada";									
										texto = String.valueOf(numFila)+ " "+codReg+" "+codUO+" "+nombre+" "+turno+" "+inicio+" "+fin+" "+problema;						
										super.escribe(texto, "VALIDACION DE TURNOS MASIVOS",mapa, usuario);										
										res="Error";								
										swError=true;	
										if (log.isDebugEnabled()) log.debug("Registro no pertenece a UO seleccionada");
									}									
								}													
							}						
						}*/						
					}				
				}
				
				
				// VALIDANDO que exista el codigo de turno y que se encuentre activo
				try{dao45Abstract.setIsolationLevel(1);}catch(Throwable ex){log.debug("No se pudo cambiar a dirty read");}
				mapaTurnoExiste = dao45Abstract.findByCodTurno(turno);	
				if (log.isDebugEnabled()) log.debug("llego12"); //BORRAR
				
				if (mapaTurnoExiste!=null){
					
					if (log.isDebugEnabled()) log.debug("mapaTurnoExiste: "+mapaTurnoExiste);
					if (log.isDebugEnabled()) log.debug("mapaTurnoExiste.get(cod_turno): "+mapaTurnoExiste.get("cod_turno"));
					codTurnoExiste=(String)mapaTurnoExiste.get("cod_turno");
				}				
				
				if (log.isDebugEnabled()) log.debug("codTurnoExiste: "+codTurnoExiste);
				if (codTurnoExiste == null || codTurnoExiste=="" ) {
					// VALIDANDO que C칩digo de turno no existe	
					if (log.isDebugEnabled()) log.debug("llego13"); //BORRAR
					problema="C칩digo de turno no existe";					
					texto = String.valueOf(numFila)+ " "+codReg+" "+codUO+" "+nombre+" "+turno+" "+inicio+" "+fin+" "+problema;						
					super.escribe(texto, "VALIDACION DE TURNOS MASIVOS",mapa, usuario);					
					res="Error";				
					swError=true;	
					if (log.isDebugEnabled()) log.debug("C칩digo de turno no existe");
					
				}else{					
					// VALIDANDO que este activo el codigo de turno (pero si existe)					
					mapaTurnoActivo = dao45.findByCritVal(dbpool, "6", turno);	
					if (log.isDebugEnabled()) log.debug("llego14"); //BORRAR
					if (log.isDebugEnabled()) log.debug("mapaTurnoActivo: "+mapaTurnoActivo);
					if (mapaTurnoActivo == null || mapaTurnoActivo.size() <= 0) {
						//VALIDANDO que C칩digo de turno no est치 activo												
						problema="C칩digo de turno no activo";						
						texto = String.valueOf(numFila)+ " "+codReg+" "+codUO+" "+nombre+" "+turno+" "+inicio+" "+fin+" "+problema;						
						super.escribe(texto, "VALIDACION DE TURNOS MASIVOS",mapa, usuario);						
						res="Error";					
						swError=true;	
						if (log.isDebugEnabled()) log.debug("C칩digo de turno no activo");
					}								
				}				
				
				
				// VALIDANDO cantidad de digitos ingresados o formato invalido de FECHA DE INICIO	
				
				validacionFInicio = validadorFecha.isFechaValida(inicio);	
				if (log.isDebugEnabled()) log.debug("inicio: "+inicio);
				if (log.isDebugEnabled()) log.debug("validacionFInicio: "+String.valueOf(validacionFInicio));
				if (validacionFInicio==true){
					fechaInicioSeparada = new Vector();
					st = new StringTokenizer(inicio, "/");					
					while (st.hasMoreTokens()) {
						fechaInicioSeparada.addElement(st.nextToken()); //nextToken obtiene el nombre					
					}				
					digDiasInicio= fechaInicioSeparada.get(0).toString().trim().length();
					digMesInicio= fechaInicioSeparada.get(1).toString().trim().length();
					digAnioInicio= fechaInicioSeparada.get(2).toString().trim().length();
					
					if (log.isDebugEnabled()) log.debug(" DIAS fechaInicioSeparada.get(0).toString(): "+fechaInicioSeparada.get(0).toString());
					if (log.isDebugEnabled()) log.debug(" MES fechaInicioSeparada.get(1).toString(): "+fechaInicioSeparada.get(1).toString());
					if (log.isDebugEnabled()) log.debug(" ANIO fechaInicioSeparada.get(2).toString(): "+fechaInicioSeparada.get(2).toString());
					if (log.isDebugEnabled()) log.debug("digDiasInicio: "+String.valueOf(digDiasInicio));
					if (log.isDebugEnabled()) log.debug("digMesInicio: "+String.valueOf(digMesInicio));
					if (log.isDebugEnabled()) log.debug("digAnioInicio: "+String.valueOf(digAnioInicio));
					if (digDiasInicio!=2 || digMesInicio!=2 || digAnioInicio!=4){						
						problema="Formato fecha inicio no v치lido";						
						texto = String.valueOf(numFila)+ " "+codReg+" "+codUO+" "+nombre+" "+turno+" "+inicio+" "+fin+" "+problema;						
						super.escribe(texto, "VALIDACION DE TURNOS MASIVOS",mapa, usuario);						
						res="Error";					
						swError=true;
						if (log.isDebugEnabled()) log.debug("Formato fecha inicio no v치lido");
					}	
					if (digDiasInicio==2 && digMesInicio==2 && digAnioInicio==4){
						fInicioCorrecta=true;
					}				
				}else{
					problema="Formato fecha inicio no v치lido";					
					texto = String.valueOf(numFila)+ " "+codReg+" "+codUO+" "+nombre+" "+turno+" "+inicio+" "+fin+" "+problema;						
					super.escribe(texto, "VALIDACION DE TURNOS MASIVOS",mapa, usuario);						
					res="Error";			
					swError=true;	
					if (log.isDebugEnabled()) log.debug("Formato fecha inicio no v치lido");
				}	
				
				
				// VALIDANDO cantidad de digitos ingresados o formato invalido de FECHA DE FIN			
				validacionFFin = validadorFecha.isFechaValida(fin);	
				if (log.isDebugEnabled()) log.debug("fin: "+fin);
				if (log.isDebugEnabled()) log.debug("validacionFFin: "+String.valueOf(validacionFFin));
				if (validacionFFin==true){
					fechaFinSeparada = new Vector();
					stf = new StringTokenizer(fin, "/");					
					while (stf.hasMoreTokens()) {
						fechaFinSeparada.addElement(stf.nextToken()); //nextToken obtiene el nombre						
					}				
					digDiasFin= fechaFinSeparada.get(0).toString().trim().length();
					digMesFin= fechaFinSeparada.get(1).toString().trim().length();
					digAnioFin= fechaFinSeparada.get(2).toString().trim().length();
					if (log.isDebugEnabled()) log.debug(" DIAS fechaFinSeparada.get(0).toString(): "+fechaFinSeparada.get(0).toString());
					if (log.isDebugEnabled()) log.debug(" MES fechaFinSeparada.get(1).toString(): "+fechaFinSeparada.get(1).toString());
					if (log.isDebugEnabled()) log.debug(" ANIO fechaFinSeparada.get(2).toString(): "+fechaFinSeparada.get(2).toString());
					if (log.isDebugEnabled()) log.debug("digDiasFin: "+String.valueOf(digDiasFin));
					if (log.isDebugEnabled()) log.debug("digMesFin: "+String.valueOf(digMesFin));
					if (log.isDebugEnabled()) log.debug("digAnioFin: "+String.valueOf(digAnioFin));
					if (digDiasFin!=2 || digMesFin!=2 || digAnioFin!=4){						
						problema="Formato fecha fin no v치lido";						
						texto = String.valueOf(numFila)+ " "+codReg+" "+codUO+" "+nombre+" "+turno+" "+inicio+" "+fin+" "+problema;						
						super.escribe(texto, "VALIDACION DE TURNOS MASIVOS",mapa, usuario);						
						res="Error";						
						swError=true;	
						if (log.isDebugEnabled()) log.debug("Formato fecha fin no v치lido");
					}
					if (digDiasFin==2 && digMesFin==2 && digAnioFin==4){
						fFinCorrecta=true;
					}					
				}else{
					problema="Formato fecha fin no v치lido";					
					texto = String.valueOf(numFila)+ " "+codReg+" "+codUO+" "+nombre+" "+turno+" "+inicio+" "+fin+" "+problema;						
					super.escribe(texto, "VALIDACION DE TURNOS MASIVOS",mapa, usuario);						
					res="Error";				
					swError=true;	
					if (log.isDebugEnabled()) log.debug("Formato fecha fin no v치lido");
				}				
				
				//VALIDACIONES CUANDO LOS FORMATOS DE FECHAS DE INICIO Y FIN SON VALIDOS
				if (validacionFInicio==true && validacionFFin==true){					 
					sd.setLenient(false);										
					fecIni = sd.parse(inicio);									
					fecFin =sd.parse(fin);							
					// VALIDANDO que Fecha Fin es menor que la fecha de inicio
					if (fInicioCorrecta==true && fFinCorrecta==true){
						if (fecIni.compareTo(fecFin) > 0) {							
							problema="Fecha de fin es menor que fecha de inicio";						
							texto = String.valueOf(numFila)+ " "+codReg+" "+codUO+" "+nombre+" "+turno+" "+inicio+" "+fin+" "+problema;						
							super.escribe(texto, "VALIDACION DE TURNOS MASIVOS",mapa, usuario);							
							res="Error";							
							swError=true;
							if (log.isDebugEnabled()) log.debug("Fecha de fin es menor que fecha de inicio");
						} 
					}
					
					fecSeleccionada = sd.parse("01/" + mes + "/" + anio);					
					// VALIDANDO que fecha de inicio es menor que la fecha seleccionada	
					if (fInicioCorrecta==true){
						if (fecIni.compareTo(fecSeleccionada) < 0) {													
							problema="Fecha de inicio es menor que mes y a침o seleccionado";							
							texto = String.valueOf(numFila)+ " "+codReg+" "+codUO+" "+nombre+" "+turno+" "+inicio+" "+fin+" "+problema;						
							super.escribe(texto, "VALIDACION DE TURNOS MASIVOS",mapa, usuario);							
							res="Error";							
							swError=true;
							if (log.isDebugEnabled()) log.debug("Fecha de inicio es menor que mes y a침o seleccionado");
						}					
					}			
										
					// VALIDANDO que fecha de fin es menor que la fecha seleccionada
					if (fFinCorrecta==true){
						if (fecFin.compareTo(fecSeleccionada) < 0) {													
							problema="Fecha de fin es menor que mes y a침o seleccionado";							
							texto = String.valueOf(numFila)+ " "+codReg+" "+codUO+" "+nombre+" "+turno+" "+inicio+" "+fin+" "+problema;						
							super.escribe(texto, "VALIDACION DE TURNOS MASIVOS",mapa, usuario);							
							res="Error";							
							swError=true;
							if (log.isDebugEnabled()) log.debug("Fecha de fin es menor que mes y a침o seleccionado");
						}												
					}					
				 }
								
				if(swError==true){//la validacion de la fila (registro-turno-inicio-termino) presenta algun error
					filasErroneas=filasErroneas+1;					
					swError=false;	
					if (log.isDebugEnabled()) log.debug("Esta fila esta ERRONEA");
				}else{//la validacion no presenta ningun error en la fila						
					m[numRegMatriz][0]=codReg;//fijando el registro
					m[numRegMatriz][1]=turno;//fijando el turno
					m[numRegMatriz][2]=inicio;//fijando la fecha d inicio
					m[numRegMatriz][3]=fin;//fijando la fecha d fin
					m[numRegMatriz][4]=String.valueOf(numFila);//fijando el numero de fila del archivo original
					// ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
					m[numRegMatriz][5]=nombre;//fijando el nombre completo del trabajador
					m[numRegMatriz][6]=codUO;//fijando el codigo de la UO del trabajador
					//
					numRegMatriz=numRegMatriz+1;	
					if (log.isDebugEnabled()) log.debug("Esta fila esta OK");
				}//fin de la validacion no presenta ningun error en la fila				
			}//fin del for del archivo 
			if (log.isDebugEnabled()) log.debug("numRegMatriz despues de primer FOR: "+String.valueOf(numRegMatriz)); //BORRAR
			//(HASTA ACA TENGO EL VALOR DE LA UO PARA IMPRESION EN EL LOG)
			
			
			//ordenando1 los registros de la matriz m por REGISTRO				
			for (int i = 0; i <= numRegMatriz-2; i++) {							
				for (int j = i+1; j <= numRegMatriz-1; j++) {							
					if ((m[j][0].compareTo(m[i][0]))<0){//m[j][0] es menor que m[i][0]								
							//intercambio1 la posicion del REGISTRO
							regiAux=m[i][0];
							m[i][0]=m[j][0];
							m[j][0]=regiAux;
							//fin intercambio1
							if (log.isDebugEnabled()) log.debug("llego24");			
							//intercambio2 la posicion del TURNO
							turnoAux=m[i][1];
							m[i][1]=m[j][1];
							m[j][1]=turnoAux;
							//fin intercambio2
												
							//intercambio3 la posicion del FEC. INICIO
							inicioAux=m[i][2];
							m[i][2]=m[j][2];
							m[j][2]=inicioAux;
							//fin intercambio3				
							
							//intercambio4 la posicion del FEC. FIN
							finAux=m[i][3];
							m[i][3]=m[j][3];
							m[j][3]=finAux;
							//fin intercambio4			
							
							//intercambio5 la posicion de la FILA
							filaAux=m[i][4];
							m[i][4]=m[j][4];
							m[j][4]=filaAux;
							//fin intercambio5		
							
							// ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
							//intercambio6 la posicion del NOMBRE
							nombreAux=m[i][5];
							m[i][5]=m[j][5];
							m[j][5]=nombreAux;
							//fin intercambio6	
							
							//intercambio7 la posicion del CODIGO DE LA UO
							uoAux=m[i][6];
							m[i][6]=m[j][6];
							m[j][6]=uoAux;
							//fin intercambio7	
							//
					}					
				}				
			}			
			//fin ordenando1 REGISTRO
			
			
			//ordenando2 los registros de la matriz m (ya ordenada por REGISTRO) por FECHA DE INICIO					
			for (int i = 0; i <= numRegMatriz-2; i++) {				
				for (int j = i+1; j <= numRegMatriz-1; j++) {					
					//convirtiendo las fechas de inicio d la posicion i y j a Date
					InicioI = sd.parse(m[i][2]);
					InicioJ = sd.parse(m[j][2]);					
					//convirtiendo las fechas de fin d la posicion i y j a Date
					FinI = sd.parse(m[i][3]);
					FinJ = sd.parse(m[j][3]);					
					if ((m[i][0].equals(m[j][0]) && InicioJ.compareTo(InicioI)<0) || ( m[i][0].equals(m[j][0]) && m[i][2].equals(m[j][2]) && FinJ.compareTo(FinI)<0 ) ){
						//InicioJ es menor que InicioI o ((InicioJ es igual a InicioI) y (FinJ es menor que FinI))						
							
							//intercambio1 la posicion del TURNO
							turnoAux=m[i][1];
							m[i][1]=m[j][1];
							m[j][1]=turnoAux;
							//fin intercambio1							
							if (log.isDebugEnabled()) log.debug("llego25");
							//intercambio2 la posicion del FEC. INICIO
							inicioAux=m[i][2];
							m[i][2]=m[j][2];
							m[j][2]=inicioAux;
							//fin intercambio2							
							
							//intercambio3 la posicion del FEC. FIN
							finAux=m[i][3];
							m[i][3]=m[j][3];
							m[j][3]=finAux;
							//fin intercambio3							
							
							//intercambio4 la posicion de la FILA
							filaAux=m[i][4];
							m[i][4]=m[j][4];
							m[j][4]=filaAux;
							//fin intercambio4	
							
							// ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
							//intercambio6 la posicion del NOMBRE
							nombreAux=m[i][5];
							m[i][5]=m[j][5];
							m[j][5]=nombreAux;
							//fin intercambio6	
							
							//intercambio7 la posicion del CODIGO DE LA UO
							uoAux=m[i][6];
							m[i][6]=m[j][6];
							m[j][6]=uoAux;
							//fin intercambio7	
							//
					}					
				}				
			}			
			//fin ordenando2 por FECHA DE INICIO			
			
			//VALIDANDO LA SUPERPOSICION DE FECHAS DE VIGENCIA Y ACTUALIZANDO VARIABLE filasErroneas			
			v = new String[numRegMatriz];
			for (int i = 0; i <= numRegMatriz-2; i++) {				
				for (int j = i+1; j <= numRegMatriz-1; j++) {
					
					//convirtiendo las fechas de inicio y fin d la posicion i a Date
					inicioI = sd.parse(m[i][2]);
					finI = sd.parse(m[i][3]);
					
					//convirtiendo las fechas de inicio y fin d la posicion j a Date
					inicioJ = sd.parse(m[j][2]);
					finJ = sd.parse(m[j][3]);
					
					turnoJ=m[j][1];
					filaJ=m[j][4];
					codRegJ=m[j][0];
					
					// ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
					nombreJ=m[j][5];
					uoJ=m[j][6];
					//
					
					if (log.isDebugEnabled()) log.debug("llego26");
					
					
					/* ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
					mapaPersonaJ = dao02.findByCodPers(dbpool, codRegJ);
					//fijando nombre de persona obtenida	
										
					if ((mapaPersonaJ.get("t02ap_pate").equals("S/descripcion")) && (mapaPersonaJ.get("t02ap_mate").equals("-")) && (mapaPersonaJ.get("t02nombres").equals("-"))){
						nombreJ="";
					}else{
						nombreJ=((String)mapaPersonaJ.get("t02ap_pate")).trim()+" "+((String)mapaPersonaJ.get("t02ap_mate")).trim()+" "+((String)mapaPersonaJ.get("t02nombres")).trim();					
					}
					*/
					
					if ( m[i][0].equals(m[j][0]) && ( ( inicioJ.compareTo(inicioI)>=0 && inicioJ.compareTo(finI)<=0 ) || ( finJ.compareTo(inicioI)>=0 && finJ.compareTo(finI)<=0 ) ) ){//registro i = registro j && ((inicioJ esta superpusta en el rango de fechas de i) o (finJ esta superpusta en el rango de fechas de i)) 						
						
						v[numFilasVector]=filaJ;						
						problemaJ="Rango de fecha superpuesto para el mismo registro en la fila "+m[i][4];
						// ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
						//texto = String.valueOf(filaJ)+ " "+codRegJ+" "+codUO+" "+nombreJ+" "+turnoJ+" "+m[j][2]+" "+m[j][3]+" "+problemaJ;
						texto = String.valueOf(filaJ)+ " "+codRegJ+" "+uoJ+" "+nombreJ+" "+turnoJ+" "+m[j][2]+" "+m[j][3]+" "+problemaJ;
						//
						super.escribe(texto, "VALIDACION DE TURNOS MASIVOS",mapa, usuario);					
						res="Error";						
						numFilasVector=numFilasVector+1;						
					}					
				}					
			}			
			//FIN VALIDANDO SUPERPOSICION
			
			
			//ADICIONANDO NUEVAS FILAS ERRONEAS a la variable filasErroneas POR LA SUPERPOSICION
			for (int i = 0; i <= numFilasVector-2; i++) {				
				for (int j = i+1; j <= numFilasVector-1; j++) {					
					if(v[i].equals(v[j])){									
						numFilasVector=numFilasVector-1;						
					}
				}				
			}			
			filasErroneas=filasErroneas+numFilasVector;			
			//FIN ADICIONANDO
						
			//inicio codigo bueno-la variable filasErroneas tiene q ser actualizada con los nuevos errores
			filasValidadas=tamanoArchivo-1-filasErroneas;
			texto = String.valueOf(filasValidadas)+" Filas Validadas" ;
			super.escribe(" ","VALIDACION DE TURNOS MASIVOS",mapa, usuario);
			super.escribe(texto,"VALIDACION DE TURNOS MASIVOS",mapa, usuario);			
			
			texto = String.valueOf(filasErroneas)+" Filas no Validadas" ;						
			super.escribe(texto,"VALIDACION DE TURNOS MASIVOS",mapa, usuario);			
			//fin codigo bueno-la variable filasErroneas tiene q ser actualizada con los nuevos errores
			
		} catch (Exception e) {	
			res="Error";	
			if (log.isDebugEnabled()) log.debug("llego27");
			if (log.isDebugEnabled()) log.debug("No valido: "+e.toString());
			log.error(e);
		} finally {
			try {
				// registramos el log del proceso
				super.registraLog(dbpool, mapa, usuario);			
				
			} catch (Exception e) {				
				res="Error";	
				if (log.isDebugEnabled()) log.debug("llego28");
				if (log.isDebugEnabled()) log.debug("No valido2: "+e.toString());
				log.error(e);
			}
		}
		return res;
	}

	/**	
	 * Metodo encargado de la Carga o Registro del Archivo de Turnos Masivos 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"	 
	 * @param mapa HashMap
	 * @param usuario String
	 * @return	String
	 * @throws RemoteException
	 */
	public String cargarTurnosMasivos(HashMap mapa, String usuario)
			throws RemoteException {

		if (log.isDebugEnabled()) log.debug("Ingreso a cargarTurnosMasivos-ProcesoFacade");		
		if (log.isDebugEnabled()) log.debug("mapa: "+mapa);
		if (log.isDebugEnabled()) log.debug("usuario: "+usuario);
		
		String res = Constantes.OK; 
		String id = (String) mapa.get("messageID");
		String dbpool = (String) mapa.get("dbpool");
		String codPers = (String) mapa.get("codPers");
		List archivoCSV = (List) mapa.get("archivo");
		HashMap seguridad = (HashMap) mapa.get("seguridad");
		// ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
		//String codUo = (String) mapa.get("cmbUUOO"); 
		String codUo=null;
		//
		String texto=null;
		int filasRegistradas=0;
		HashMap cabecera=(HashMap) archivoCSV.get(0);
		Map fila=new HashMap();
		HashMap params = new HashMap();
		HashMap mapaPersona= new HashMap();
		String nombre=null;
		String codReg;
		
		try {						
			
			super.creaLog(id, "REGISTRO DE TURNOS DE TRABAJO", usuario);		
			
			texto=" Fila "+"  Reg  "+"    UO    "+"      Nombre      "+"  Turno "+" Inicio "+" Fin "+"     Problema     ";					
			super.escribe(texto,"REGISTRO DE TURNOS DE TRABAJO", mapa, usuario);
			
			texto="--------------------------------------------------------------------------------------";					
			super.escribe(texto,"REGISTRO DE TURNOS DE TRABAJO", mapa, usuario);			
			
			for (int i = 1; i < archivoCSV.size(); i++) {
				
				codReg=null;
				fila = (HashMap) archivoCSV.get(i);			
								
				params.put("messageID", id);
				params.put("dbpool", dbpool);
				params.put("codPers", codPers);
				params.put("criterio", "0");
				params.put("valor", fila.get(cabecera.get(new Integer(0))));//codRegistro de la persona							
				params.put("seguridad", seguridad);
				/* ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
				params.put("codUo", codUo);
				*/
				params.put("turno", fila.get(cabecera.get(new Integer(1))));//codTurno
				params.put("fechaIni", fila.get(cabecera.get(new Integer(2))));//Fecha Inicio del turno
				params.put("fechaFin", fila.get(cabecera.get(new Integer(3))));//Fecha Fin del turno
				
				//String cadenaNormalize = Normalizer.normalize(fila.get(cabecera.get(new Integer(4)).toString()).toString(), Normalizer.Form.NFD);   
				//String cadenaSinAcentos = cadenaNormalize.replaceAll("[^\\p{ASCII}]", "");
				String cadenaSinAcentos=fila.get(cabecera.get(new Integer(4)).toString())!=""?fila.get(cabecera.get(new Integer(4)).toString()).toString():"";
				//cadenaSinAcentos.replace(",", "");
				log.debug("SustentoImportante:"+cadenaSinAcentos);
				//cadenaSinAcentos.replaceAll("[^a-zA-Z0-9]", "");
				//cadenaSinAcentos.replace(",", "");
				
				params.put("obsSustento", cadenaSinAcentos);//observacion (MODIFICADO DTARAZONA 23/05/2018)
				log.debug("observa:"+ cadenaSinAcentos);
				params.put("cruce", mapa.get("cruce"));	
				params.put("fila", String.valueOf(i+1));
				
				//fijando buscando y fijando nombre completo de persona segun su registro
				codReg= params.get("valor").toString();				
				
				T02DAO dao02=new T02DAO();				
				mapaPersona = dao02.findByCodPers(dbpool, codReg);	
				// ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
				if (mapaPersona.get("t02cod_uorgl") == null || mapaPersona.get("t02cod_uorgl").toString().trim().equals("")) {
					if (mapaPersona.get("t02cod_uorg") == null || mapaPersona.get("t02cod_uorg").toString().trim().equals("")) {
						codUo="";
						if (log.isDebugEnabled()) log.debug("codUo: "+codUo);
					}else{
						codUo = ((String)mapaPersona.get("t02cod_uorg")).trim();
						if (log.isDebugEnabled()) log.debug("codUo_cod_uorg: "+codUo);
					}						
				}else{
					codUo = ((String)mapaPersona.get("t02cod_uorgl")).trim();
					if (log.isDebugEnabled()) log.debug("codUo_cod_uorgl: "+codUo);
				}	
				params.put("codUo", codUo);	
				// FIN ICAPUNAY 27/04/2011				
				
				if ((mapaPersona.get("t02ap_pate").equals("S/descripcion")) && (mapaPersona.get("t02ap_mate").equals("-")) && (mapaPersona.get("t02nombres").equals("-"))){
					nombre="";
				}else{					
					nombre=((String)mapaPersona.get("t02ap_pate")).trim()+" "+((String)mapaPersona.get("t02ap_mate")).trim()+" "+((String)mapaPersona.get("t02nombres")).trim();					
				}				
				params.put("nombre", nombre);
				
				if (log.isDebugEnabled()) log.debug("Va ingresar a registrarTurnoTrabajoMasivo-Individual");				
				if (log.isDebugEnabled()) log.debug("params enviado: "+params);
				if (log.isDebugEnabled()) log.debug("usuario enviado: "+usuario);
				
				res= registrarTurnoTrabajoMasivo(params, usuario);
				
				if (log.isDebugEnabled()) log.debug("Salio de registrarTurnoTrabajoMasivo-Individual");
				
				if (!res.equals("Mal")){				
					filasRegistradas=filasRegistradas+1;
				}				
			}
			if(filasRegistradas>0){
				super.escribe(" ", "REGISTRO DE TURNOS DE TRABAJO",mapa, usuario);
				texto = String.valueOf(filasRegistradas)+" Filas Cargadas" ;
				super.escribe(texto, "REGISTRO DE TURNOS DE TRABAJO",mapa, usuario);				
			}
			super.escribe(" ", "REGISTRO DE TURNOS DE TRABAJO",mapa, usuario);
			texto = String.valueOf(archivoCSV.size()-1-filasRegistradas)+" Filas no Cargadas" ;
			super.escribe(texto, "REGISTRO DE TURNOS DE TRABAJO",mapa, usuario);			
			
		} catch (Exception e) {					
			res="Mal";
			log.error(e.getMessage());
		} finally {
			try {
				// registramos el log del proceso
				super.registraLog(dbpool, mapa, usuario); 
				
			} catch (Exception e) {			
				res="Mal";
				log.error(e.getMessage());
			}
		}
		return res;
	}
	
	/**	 
	 * Metodo encargado de la Carga o Registro del Turno Individual de una Persona
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"	 
	 * @param mapa HashMap
	 * @param usuario String
	 * @return	String
	 * @throws RemoteException
	 */
	public String registrarTurnoTrabajoMasivo(HashMap mapa, String usuario)
			throws RemoteException {

		if (log.isDebugEnabled()) log.debug("Ingreso a registrarTurnoTrabajoMasivo-ProcesoFacade: ");
		
		String res = Constantes.OK;		
		String dbpool = (String) mapa.get("dbpool");
		String valor = (String) mapa.get("valor");
		String turno = (String) mapa.get("turno");
		String fechaIniOriginal = (String) mapa.get("fechaIni");
		String fechaFinOriginal = (String) mapa.get("fechaFin");
		String fechaIni = (String) mapa.get("fechaIni") + " 00:00:00";
		String fechaFin = (String) mapa.get("fechaFin") + " 00:00:00";
		String obsSustento=(String)mapa.get("obsSustento");
		String nombre = (String) mapa.get("nombre");
		String fila = (String) mapa.get("fila");
		// ICAPUNAY 27/04/2011- REQUERIDO X RUBEN LAZARTE 
		//String codUo = (String) mapa.get("cmbUUOO"); //ICAPUNAY 15/12/2010 AOM URGENTE: 44U3T10 Gesti칩n de turnos y calificacion de procesos
		String codUo=(String)mapa.get("codUo");	
		//	
		String problema=null;
		String texto=null;
		
		if (log.isDebugEnabled()) log.debug("mapa: "+mapa);
		if (log.isDebugEnabled()) log.debug("usuario: "+usuario);
		
		try {

			HashMap seguridad = (HashMap) mapa.get("seguridad");
			String criterio = (String) mapa.get("criterio");			
			
			boolean cruce = mapa.get("cruce") != null ? ((String) mapa
					.get("cruce")).equals("true") : false;		    
			T02DAO dao = new T02DAO();

			// JRR - 13/05/2009
			VacacionFacadeHome facadeVacHome = (VacacionFacadeHome) sl.getRemoteHome(VacacionFacadeHome.JNDI_NAME,
							VacacionFacadeHome.class);
			VacacionFacadeRemote facadeVacRemote = facadeVacHome.create();
			if (log.isDebugEnabled()) log.debug("registrarTurnoTrabajoMasivo - mapa: " + mapa);
			String fecha_ingreso = "";
			Map hmVacGen = new HashMap();
			int dias = 0;

			// ASANCHEZZ 20100617
			Map mapaAux;
			String codPers = mapa.get("codPers") != null ? (String) mapa.get("codPers") : "";		   
			// FIN

			// registro de turno de trabajo por personal
			if (criterio.equals("0")) {
				
				HashMap t = dao.joinWithT12T99ByCodPers(dbpool, valor,seguridad);
				//HashMap t1 = dao.findByCodPers(dbpool, valor);
				
				log.debug("DAtosImportantes:"+valor+"-"+seguridad.toString());
				// JRR - 11/05/2009 - Fecha de ingreso/reingreso
				hmVacGen = facadeVacRemote.buscarVacacionesGen(dbpool, valor);
				if (hmVacGen != null && hmVacGen.get("fecha") != null && !hmVacGen.get("fecha").toString().equals("")) {
					fecha_ingreso = hmVacGen.get("fecha").toString();
				}
				if (log.isDebugEnabled()) log.debug("fecha_ingreso: " + fecha_ingreso);

				// Validar que solo cambie turno si fechaIni > fecha_ingreso dd/mm/yyyy
				dias = Utiles.obtenerDiasDiferencia(fecha_ingreso, mapa.get("fechaIni").toString());

				if (dias >= 0) {
					if (log.isDebugEnabled()) log.debug("Fecha Inicio mayor por dias: " + dias);
					// ASANCHEZZ 20100617
					mapaAux = new HashMap();
					mapaAux.put("dbpool", dbpool);
					mapaAux.put("valor", valor);
					mapaAux.put("turno", turno);
					if (log.isDebugEnabled()) log.debug("valor devuelto de UO aca: " + (String) t.get("t02cod_uorg"));
					mapaAux.put("uorg", (String) t.get("t02cod_uorg"));
					mapaAux.put("fechaIniOriginal", fechaIniOriginal);
					mapaAux.put("fechaFinOriginal", fechaFinOriginal);
					mapaAux.put("fechaIni", fechaIni);
					mapaAux.put("fechaFin", fechaFin);
					mapaAux.put("obsSustento", obsSustento);
					mapaAux.put("usuario", usuario);
					mapaAux.put("cruce", cruce == true ? "1" : "0");
					mapaAux.put("tieneLog", "1");
					mapaAux.put("codiPersProceso", codPers);					
					mapaAux.put("nombre", nombre);
					mapaAux.put("fila", fila);

					if (cruce) {
						
						if (log.isDebugEnabled()) log.debug("entro a CRUCE igual TRUE");
						if (log.isDebugEnabled()) log.debug("Va ingresar a registrarTurnoSinCruceMasivo");
						if (log.isDebugEnabled()) log.debug("mapaAux enviado: "+mapaAux);
						
						res = registrarTurnoSinCruceMasivo(mapaAux);
						
						if (log.isDebugEnabled()) log.debug("Salio de registrarTurnoSinCruceMasivo");
						
					} else {
						
						if (log.isDebugEnabled()) log.debug("entro a CRUCE igual FALSE");
						if (log.isDebugEnabled()) log.debug("Va ingresar a registrarTurnoConCruceMasivo");
						if (log.isDebugEnabled()) log.debug("mapaAux enviado: "+mapaAux);
						
						res = registrarTurnoConCruceMasivo(mapaAux);
						
						if (log.isDebugEnabled()) log.debug("Salio de registrarTurnoConCruceMasivo");
					}
					// FIN

				} else {
					res="Mal";
					dias = dias * (-1);					
					problema = "Fecha de inicio del turno es anterior a fecha de ingreso del trabajador"
							+ valor + " por " + dias + " dias de diferencia.";					
					texto = fila+ " "+valor+" "+codUo+" "+nombre+" "+turno+" "+fechaIniOriginal+" "+fechaFinOriginal+" "+problema;//ICAPUNAY 15/12/2010 AOM URGENTE: 44U3T10 Gesti칩n de turnos y calificacion de procesos					
					super.escribe(texto, "REGISTRO DE TURNOS DE TRABAJO",mapa,usuario);					
					super.escribe("Se revierte la carga", "REGISTRO DE TURNOS DE TRABAJO",mapa,usuario);
					super.escribe(" ", "REGISTRO DE TURNOS DE TRABAJO",mapa,usuario);
					
				}
				//
			}			
			
		} catch (Exception e) {			
			res="Mal";
			log.error(e.getMessage());		
			problema = e.getMessage();								
			texto = fila+ " "+valor+" "+codUo+" "+nombre+" "+turno+" "+fechaIniOriginal+" "+fechaFinOriginal+" "+problema;//ICAPUNAY 15/12/2010 AOM URGENTE: 44U3T10 Gesti칩n de turnos y calificacion de procesos					
			super.escribe(texto, "REGISTRO DE TURNOS DE TRABAJO", mapa,usuario);
			super.escribe("Se revierte la carga", "REGISTRO DE TURNOS DE TRABAJO",mapa,usuario);
			super.escribe(" ", "REGISTRO DE TURNOS DE TRABAJO",mapa,usuario);
			
		} finally {
			try {					
				
			} catch (Exception e) {
				res="Mal";
				log.error(e.getMessage());
				problema = e.getMessage();								
				texto = fila+ " "+valor+" "+codUo+" "+nombre+" "+turno+" "+fechaIniOriginal+" "+fechaFinOriginal+" "+problema;//ICAPUNAY 15/12/2010 AOM URGENTE: 44U3T10 Gesti칩n de turnos y calificacion de procesos					
				super.escribe(texto, "REGISTRO DE TURNOS DE TRABAJO", mapa,usuario);
				super.escribe("Se revierte la carga", "REGISTRO DE TURNOS DE TRABAJO",mapa,usuario);
				super.escribe(" ", "REGISTRO DE TURNOS DE TRABAJO",mapa,usuario);
			}
		}
		return res;
	}
	
	
	/**
	 * Metodo registrarTurnoSinCruceMasivo Individual
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="Required"	
	 * @param mapa Mapa
	 * @return	String
	 * @throws RemoteException
	 */
	public String registrarTurnoSinCruceMasivo(Map mapa) throws RemoteException {
		
		if (log.isDebugEnabled()) log.debug("Ingreso a registrarTurnoSinCruceMasivo-mapa: "+mapa);
		
		String res = Constantes.OK;
		String problema=null;
		String texto=null;

		// ASANCHEZZ 20100617
		String dbpool = (String) mapa.get("dbpool");
		String codPers = (String) mapa.get("valor");
		String turno = (String) mapa.get("turno");
		String uorg = (String) mapa.get("uorg");
		String fechaIniOriginal = (String) mapa.get("fechaIniOriginal");
		String fechaFinOriginal = (String) mapa.get("fechaFinOriginal");
		String fechaIni = (String) mapa.get("fechaIni");
		String fechaFin = (String) mapa.get("fechaFin");
		String obsSustento=(String)mapa.get("obsSustento");
		String usuario = (String) mapa.get("usuario");
		String nombre = (String) mapa.get("nombre");
		String fila = (String) mapa.get("fila");		
		boolean vCruce = false;
		if (mapa.get("cruce").equals("1")) vCruce = true;
		boolean tieneLog = false;
		if (mapa.get("tieneLog").equals("1")) tieneLog = true;
		String codiPersProceso = (String) mapa.get("codiPersProceso");
		// FIN

		try {
			if (tieneLog) {
				// output.println("Trabajador : " + codPers);
			}

			T1270DAO dao = new T1270DAO();
			// primero obtenemos los turnos asignados al personal
			ArrayList turnos = dao.joinWithT45(dbpool, codPers);
			
			// verificamos cruces
			java.sql.Timestamp f1 = Utiles.stringToTimestamp(fechaIni);
			java.sql.Timestamp f2 = Utiles.stringToTimestamp(fechaFin);
			java.sql.Timestamp fIni = new java.sql.Timestamp(f1.getTime());
			java.sql.Timestamp fFin = new java.sql.Timestamp(f2.getTime());

			// T1270CMPHome cmpHome = (T1270CMPHome)
			// ServiceLocator.getInstance().getLocalHome(T1270CMPHome.JNDI_NAME);
			// JRR - 23/01/2009
			pe.gob.sunat.rrhh.asistencia.dao.T1270DAO t1270dao = new pe.gob.sunat.rrhh.asistencia.dao.T1270DAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dgsp"));
			FechaBean fecAct = new FechaBean();
			Map mturno = new HashMap();
			Map mdatos = new HashMap();
			mdatos.put("cod_pers", codPers);
			mdatos.put("turno", turno);
			mdatos.put("fini", fIni);
			mdatos.put("u_organ", uorg);
			mdatos.put("ffin", fFin);
			mdatos.put("obsSustento",obsSustento);
			mdatos.put("sonom_id", "");
			mdatos.put("est_id", Constantes.ACTIVO);		
			//

			// ASANCHEZZ 20100617
			mdatos.put("codiPersProceso", codiPersProceso);
			//
			
			if (log.isDebugEnabled()) log.debug("mdatos: "+mdatos);

			// si se desea q se verifique los cruces
			if (vCruce) {

				boolean hayCruce = verificaCruceTurnosTrabajador(turnos, "", fIni, fFin, false);
				if (log.isDebugEnabled()) log.debug("llego1");
				
				// si no hay cruces entonces registramos
				if (!hayCruce) {
					if (log.isDebugEnabled()) log.debug("llego2");
					try {
						mturno = t1270dao.findTurnoPersonaByPK(mdatos);

						if (mturno != null && mturno.get("est_id").toString().trim().equals(Constantes.INACTIVO)) {
							mdatos.put("cuser_mod", usuario);
							mdatos.put("fmod", fecAct.getTimestamp());

							// Activamos y modificamos el turno
							t1270dao.actualizarTurnoPersona(mdatos);
							if (log.isDebugEnabled()) log.debug("llego3");
							generarRegAsistenciaPorCambioTurnoTrab(mdatos);
							registrarNovedadPorCambioTurnoTrab(mdatos);
							if (log.isDebugEnabled()) log.debug("llego4");

						} else {	
							
							throw new Exception("El turno no presenta cruce");								
						}
						
					} catch (Exception ex) {						

						mdatos.put("cuser_crea", usuario);
						mdatos.put("fcreacion", fecAct.getTimestamp());
						mdatos.put("modificar","sustento");
						t1270dao.registrarTurnoPersona(mdatos);
						if (log.isDebugEnabled()) log.debug("llego6");
						generarRegAsistenciaPorCambioTurnoTrab(mdatos);
						registrarNovedadPorCambioTurnoTrab(mdatos);
						if (log.isDebugEnabled()) log.debug("llego7");						

					}

				}
				// en caso contrario
				else {
					res = "Mal";				
					problema = "El turno presenta cruce";								
					texto = fila+ " "+codPers+" "+uorg+" "+nombre+" "+turno+" "+fechaIniOriginal+" "+fechaFinOriginal+" "+problema;//ICAPUNAY 15/12/2010 AOM URGENTE: 44U3T10 Gesti칩n de turnos y calificacion de procesos					
					super.escribe(texto, "REGISTRO DE TURNOS DE TRABAJO", (HashMap)mapa,usuario);
					super.escribe("Se revierte la carga", "REGISTRO DE TURNOS DE TRABAJO",(HashMap)mapa,usuario);
					super.escribe(" ", "REGISTRO DE TURNOS DE TRABAJO",(HashMap)mapa,usuario);
					if (log.isDebugEnabled()) log.debug("llego8");
				}
			} else {

				mdatos.put("cuser_crea", usuario);
				mdatos.put("fcreacion", fecAct.getTimestamp());
				t1270dao.registrarTurnoPersona(mdatos);
				if (log.isDebugEnabled()) log.debug("llego9");
				generarRegAsistenciaPorCambioTurnoTrab(mdatos);
				registrarNovedadPorCambioTurnoTrab(mdatos);	
				if (log.isDebugEnabled()) log.debug("llego10");

			}
		} catch (Exception e) {
			
			log.error(e.getMessage());
			res = "Mal";
			problema = e.getMessage();								
			texto = fila+ " "+codPers+" "+uorg+" "+nombre+" "+turno+" "+fechaIniOriginal+" "+fechaFinOriginal+" "+problema;//ICAPUNAY 15/12/2010 AOM URGENTE: 44U3T10 Gesti칩n de turnos y calificacion de procesos					
			super.escribe(texto, "REGISTRO DE TURNOS DE TRABAJO", (HashMap)mapa,usuario);
			super.escribe("Se revierte la carga", "REGISTRO DE TURNOS DE TRABAJO",(HashMap)mapa,usuario);
			super.escribe(" ", "REGISTRO DE TURNOS DE TRABAJO",(HashMap)mapa,usuario);
			if (log.isDebugEnabled()) log.debug("llego11");
		}
		return res;
	}
	
	/**
	 * Metodo registrarTurnoConCruceMasivo Individual
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="Required"	 
	 * @param mapa Mapa
	 * @return	String
	 * @throws RemoteException
	 */
	public String registrarTurnoConCruceMasivo(Map mapa) throws RemoteException {//cruce igual a FALSE
		
		String res = Constantes.OK;
		String problema=null;
		String texto=null;
		
		if (log.isDebugEnabled()) log.debug("Ingreso a registrarTurnoConCruceMasivo-mapa: "+mapa);

		// ASANCHEZZ 20100617
		String dbpool = (String) mapa.get("dbpool");
		String codPers = (String) mapa.get("valor");
		String turno = (String) mapa.get("turno");
		String fechaIniOriginal = (String) mapa.get("fechaIniOriginal");
		String fechaFinOriginal = (String) mapa.get("fechaFinOriginal");
		String fechaIni = (String) mapa.get("fechaIni");
		String fechaFin = (String) mapa.get("fechaFin");
		String obsSustento=(String)mapa.get("obsSustento");
		String codUO = (String) mapa.get("uorg");
		String usuario = (String) mapa.get("usuario");
		String codiPersProceso = (String) mapa.get("codiPersProceso");
		String nombre = (String) mapa.get("nombre");
		String fila = (String) mapa.get("fila");
		// FIN

		try {		

			String nvaFIni = "";
			String nvaFFin = "";

			// Listar los turnos con los que se cruza.
			T1270DAO daoTT = new T1270DAO();
			ArrayList listaTurnos = daoTT.joinWithT45ByCodFiniFfin(dbpool,
					codPers, Utiles.stringToTimestamp(fechaIni), Utiles
							.stringToTimestamp(fechaFin), 1);

			
			BeanTurnoTrabajo tAnt = null;
			// T1270CMPLocal cmpLocal = null;
			// JRR - 23/01/2009
			pe.gob.sunat.rrhh.asistencia.dao.T1270DAO t1270dao = new pe.gob.sunat.rrhh.asistencia.dao.T1270DAO(ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dgsp"));
			FechaBean fecAct = new FechaBean();
			Map mturno = new HashMap();
			Map mdatos = new HashMap();
			// ASANCHEZZ 20100617
			mdatos.put("codiPersProceso", codiPersProceso);
			mdatos.put("obsSustento",obsSustento);
			//
			
			if (log.isDebugEnabled()) log.debug("llego antes de for");

			if (listaTurnos != null && listaTurnos.size() > 0) {
				for (int i = 0; i < listaTurnos.size(); i++) {

					tAnt = (BeanTurnoTrabajo) listaTurnos.get(i);
					
					if (log.isDebugEnabled()) log.debug("Entro a for");
					
					if (log.isDebugEnabled()) log.debug("tAnt:" + tAnt);				

					mdatos.put("cod_pers", tAnt.getCodPers());
					mdatos.put("turno", tAnt.getTurno());
					mdatos.put("fini", tAnt.getFechaIni());
					
					if (log.isDebugEnabled()) log.debug("mdatos:" + mdatos);
					
					mturno = t1270dao.findTurnoPersonaByPK(mdatos);
					
					if (log.isDebugEnabled()) log.debug("mturno:" + mturno);

					// Partir los turnos.
					if (tAnt.getFechaIni().before(Utiles.stringToTimestamp(fechaIni + " 00:00:00")) && 
						(tAnt.getFechaFin().before(Utiles.stringToTimestamp(fechaFin + " 00:00:00")) || 
						tAnt.getFechaFin().equals(Utiles.stringToTimestamp(fechaFin + " 00:00:00")))) {

						// Cruce izquierda cerramos el turno anterior el dia anterior del comienzo del turno nuevo
						nvaFFin = Utiles.dameFechaAnterior(fechaIni, 1);

						if (mturno != null) {
							// estos 3 campos son para completar la sentencia
							mdatos.put("u_organ", mturno.get("u_organ"));
							mdatos.put("sonom_id", mturno.get("sonom_id"));
							mdatos.put("est_id", mturno.get("est_id"));
							mdatos.put("ffin", Utiles.stringToTimestamp(nvaFFin+ " 00:00:00"));
							mdatos.put("cuser_mod", usuario);
							mdatos.put("fmod", fecAct.getTimestamp());

							if (log.isDebugEnabled()) log.debug("mdatos-para-actualizarTurnoPersona:" + mdatos);
							
							t1270dao.actualizarTurnoPersona(mdatos);

							if (log.isDebugEnabled()) log.debug("actualiz칩 Turno de Persona");
							
							generarRegAsistenciaPorCambioTurnoTrab(mdatos);
							registrarNovedadPorCambioTurnoTrab(mdatos);
						}						
					} else if ((tAnt.getFechaIni().after(Utiles.stringToTimestamp(fechaIni + " 00:00:00")) && 
							  (tAnt.getFechaIni().before(Utiles.stringToTimestamp(fechaFin + " 00:00:00")) || 
							  tAnt.getFechaIni().equals(Utiles.stringToTimestamp(fechaFin + " 00:00:00")))) && 
							  tAnt.getFechaFin().after(Utiles.stringToTimestamp(fechaFin + " 00:00:00"))) 
					{

						// modificamos el turno anterior justo para que empiece
						// al dia sgte. de terminado el nuevo
						nvaFIni = Utiles.dameFechaSiguiente(fechaFin, 1);

						// Desactivamos el turno anterior
						// Creamos un turno con la nueva fecha de inicio

						if (mturno != null) t1270dao.eliminarTurnoPersona(mdatos);

						mdatos.put("u_organ", tAnt.getCodUOrg());
						mdatos.put("fini", Utiles.stringToTimestamp(nvaFIni + " 00:00:00"));
						mdatos.put("ffin", tAnt.getFechaFin());
						mdatos.put("est_id", Constantes.ACTIVO);
						mdatos.put("sonom_id", "");
						mdatos.put("cuser_crea", usuario);
						mdatos.put("fcreacion", fecAct.getTimestamp());
						
						if (log.isDebugEnabled()) log.debug("mdatos-para-registrarTurnoPersona:" + mdatos);
						
						t1270dao.registrarTurnoPersona(mdatos);

						if (log.isDebugEnabled()) log.debug("registro Turno de Persona");
						
						generarRegAsistenciaPorCambioTurnoTrab(mdatos);
						registrarNovedadPorCambioTurnoTrab(mdatos);						

					} else if ((tAnt.getFechaIni().after(Utiles.stringToTimestamp(fechaIni + " 00:00:00")) || 
							  tAnt.getFechaIni().equals(Utiles.stringToTimestamp(fechaIni + " 00:00:00")))
							&& (tAnt.getFechaFin().before(Utiles.stringToTimestamp(fechaFin + " 00:00:00")) || 
								tAnt.getFechaFin().equals(Utiles.stringToTimestamp(fechaFin + " 00:00:00")))) 
					{

						if (mturno != null) t1270dao.eliminarTurnoPersona(mdatos);
						
					} else {
						// Abarcado por...
						if (tAnt.getFechaFin().equals(Utiles.stringToTimestamp(fechaFin + " 00:00:00"))) {

							// Fecha de fin igual a la fecha de inicio
							nvaFFin = Utiles.dameFechaAnterior(fechaIni, 1);

							if (mturno != null) {
								mdatos.put("u_organ", mturno.get("u_organ"));
								mdatos.put("sonom_id", mturno.get("sonom_id"));
								mdatos.put("est_id", mturno.get("est_id"));
								mdatos.put("ffin", Utiles.stringToTimestamp(nvaFFin + " 00:00:00"));
								mdatos.put("cuser_mod", usuario);
								mdatos.put("fmod", fecAct.getTimestamp());

								if (log.isDebugEnabled()) log.debug("mdatos2-para-actualizarTurnoPersona:" + mdatos);
								
								t1270dao.actualizarTurnoPersona(mdatos);

								if (log.isDebugEnabled()) log.debug("actualizo2 Turno de Persona");							

								generarRegAsistenciaPorCambioTurnoTrab(mdatos);
								registrarNovedadPorCambioTurnoTrab(mdatos);
							}							

						} else if (tAnt.getFechaIni().equals(Utiles.stringToTimestamp(fechaIni + " 00:00:00"))) 
						{

							// Fecha de fin igual fecha de fin
							nvaFIni = Utiles.dameFechaSiguiente(fechaFin, 1);

							// Desactivamos el turno anterior
							// Creamos un turno con la nueva fecha de inicio

							if (mturno != null) t1270dao.eliminarTurnoPersona(mdatos);

							mdatos.put("u_organ", tAnt.getCodUOrg());
							mdatos.put("fini", Utiles.stringToTimestamp(nvaFIni + " 00:00:00"));
							mdatos.put("ffin", tAnt.getFechaFin());
							mdatos.put("est_id", Constantes.ACTIVO);
							mdatos.put("sonom_id", "");
							mdatos.put("cuser_crea", usuario);
							mdatos.put("fcreacion", fecAct.getTimestamp());							
							
							if (log.isDebugEnabled()) log.debug("mdatos2-para-registrarTurnoPersona:" + mdatos);
							
							t1270dao.registrarTurnoPersona(mdatos);

							if (log.isDebugEnabled()) log.debug("registro2 Turno de Persona");

							generarRegAsistenciaPorCambioTurnoTrab(mdatos);
							registrarNovedadPorCambioTurnoTrab(mdatos);					

						} 
						else {

							// Ambos lados mayores a los extremos del nuevo turno
							nvaFFin = Utiles.dameFechaAnterior(fechaIni, 1);

							if (mturno != null) {
								mdatos.put("u_organ", mturno.get("u_organ"));
								mdatos.put("sonom_id", mturno.get("sonom_id"));
								mdatos.put("est_id", mturno.get("est_id"));
								mdatos.put("ffin", Utiles.stringToTimestamp(nvaFFin + " 00:00:00"));
								mdatos.put("cuser_mod", usuario);
								mdatos.put("fmod", fecAct.getTimestamp());
							
								if (log.isDebugEnabled()) log.debug("mdatos3-para-actualizarTurnoPersona:" + mdatos);
								
								t1270dao.actualizarTurnoPersona(mdatos);

								if (log.isDebugEnabled()) log.debug("actualizo3 Turno de Persona");

								generarRegAsistenciaPorCambioTurnoTrab(mdatos);
								registrarNovedadPorCambioTurnoTrab(mdatos);
							}							

							nvaFIni = Utiles.dameFechaSiguiente(fechaFin, 1);

							// Creamos un turno con la nueva fecha de inicio
							mdatos.put("u_organ", tAnt.getCodUOrg());
							mdatos.put("fini", Utiles.stringToTimestamp(nvaFIni + " 00:00:00"));
							mdatos.put("ffin", tAnt.getFechaFin());
							mdatos.put("est_id", Constantes.ACTIVO);
							mdatos.put("sonom_id", "");
							mdatos.put("cuser_crea", usuario);
							mdatos.put("fcreacion", fecAct.getTimestamp());
							mdatos.put("obsSustento",tAnt.getSustento());
							mdatos.put("modificar", "sustento");							
							if (log.isDebugEnabled()) log.debug("mdatos3-para-registrarTurnoPersona:" + mdatos);
							
							t1270dao.registrarTurnoPersona(mdatos);

							if (log.isDebugEnabled()) log.debug("registro3 Turno de Persona");

							generarRegAsistenciaPorCambioTurnoTrab(mdatos);
							registrarNovedadPorCambioTurnoTrab(mdatos);							
						}
					}
				}
			}

			mdatos.put("cod_pers", codPers);
			mdatos.put("turno", turno);
			mdatos.put("fini", Utiles.stringToTimestamp(fechaIni + " 00:00:00"));
			mdatos.put("u_organ", codUO);
			mdatos.put("ffin", Utiles.stringToTimestamp(fechaFin + " 00:00:00"));
			mdatos.put("est_id", Constantes.ACTIVO);
			mdatos.put("sonom_id", "");
			mdatos.put("cuser_crea", usuario);
			mdatos.put("fcreacion", fecAct.getTimestamp());	
			mdatos.put("obsSustento",obsSustento);
			mdatos.put("modificar", "sustento");
			
			if (log.isDebugEnabled()) log.debug("mdatos4-para-registrarTurnoPersona:" + mdatos);
			
			t1270dao.registrarTurnoPersona(mdatos);	

			generarRegAsistenciaPorCambioTurnoTrab(mdatos);
			registrarNovedadPorCambioTurnoTrab(mdatos);
			

		} catch (Exception e) {			
			log.error(e.getMessage());
			res = "Mal";			
			problema = e.getMessage();								
			texto = fila+ " "+codPers+" "+codUO+" "+nombre+" "+turno+" "+fechaIniOriginal+" "+fechaFinOriginal+" "+problema;//ICAPUNAY 15/12/2010 AOM URGENTE: 44U3T10 Gesti칩n de turnos y calificacion de procesos					
			super.escribe(texto, "REGISTRO DE TURNOS DE TRABAJO", (HashMap)mapa,usuario);
			super.escribe("Se revierte la carga", "REGISTRO DE TURNOS DE TRABAJO",(HashMap)mapa,usuario);
			super.escribe(" ", "REGISTRO DE TURNOS DE TRABAJO",(HashMap)mapa,usuario);
		}
		return res;
	}
	//FIN ICAPUNAY 15/12/2010 AOM URGENTE: 44U3T10 Gesti칩n de turnos y calificacion de procesos

	
	//JRR 25042011
	/**
	 * Metodo encargado del registro de la asistencia de Modalidad Formativa para un determinado dia
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="RequiresNew"
	 * @param params
	 * @return
	 * @throws RemoteException
	 */
	public void generarAsistenciaTrabajadorModFormativa(Map params)
	throws IncompleteConversationalState, RemoteException {

	if (log.isDebugEnabled()) log.debug("inicio de metodo ProcesoFacade - generarAsistenciaTrabajadorModFormativa");
	
	Map mapa = (HashMap)params.get("mapa");
	Map beanPersona = (HashMap)params.get("beanPersona");
	Map fechas = (HashMap)params.get("fechas");
	String usuario = params.get("usuario").toString();

	ArrayList listaMarcaciones = null;

	BeanMarcacion bMarcacion = null;
	BeanMarcacion bMSgte = null;

	String fechaEval = "";
	String codPers = "";
	String codUO = "";
	String periodo = "";
	String fechaMarcacion = "";
	String horaMarcacion = "";
	String fechaFinMov = "";
	String horaFinMov = "";
	String relojIni = "";
	String relojFin = "";
	String tMov = "";
	String dbpool = "";
	String fechaNSA = (String)fechas.get("FechaNSA");
	
	BeanTurnoTrabajo turno = null;

	T1270DAO daoTurno = new T1270DAO();
	dbpool = (String) mapa.get("dbpool");
	T1271DAO asisDAO = new T1271DAO(dbpool);
	T01DAO paramDAO = new T01DAO();
	T1275DAO daoMarcacion = new T1275DAO();	//ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)
	T99DAO codigoDAO = new T99DAO(); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
	T8167DAO climaLabDAO = new T8167DAO(dbpool); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
	
	boolean tieneRefrigerio = false;
	boolean tieneRefrigerioW = false;//NUEVO
	//boolean bOperativo = false; //ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)
	boolean bControla = true;
	boolean generar = true;
	boolean diaEspecial = false;

	try{
		fechaEval = (String) mapa.get("fechaEval");
		periodo = (String) mapa.get("periodo");
		codPers = (String) beanPersona.get("t02cod_pers");
		codUO = (String) beanPersona.get("t02cod_uorg");
		//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
		String isProcesar = (String) params.get("isProcesar");
		isProcesar = isProcesar!=null?isProcesar:"NO";
		List papeletasGeneradas= null;
		//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
		
		//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral		
		String climaLab = codigoDAO.findParamByCodTabCodigo(dbpool,Constantes.CODTAB_PARAMETROS_ASISTENCIA,Constantes.MINUTOS_MAXIMO_CLIMALABORAL);
		int minMaxClima = climaLab != null ? Integer.parseInt(climaLab) : 0;
		log.debug("minMaxClima: " + ""+minMaxClima);		
		Map autoriClima = null;
		boolean procesaClima = false;
		boolean refriClima = false; //new
		boolean excesoClima = false; //new
		String estadoAut = "";//new
		Map prms=new HashMap(); //new
		pe.gob.sunat.rrhh.dao.CorreoDAO correoDAO = new pe.gob.sunat.rrhh.dao.CorreoDAO(dbpool);//new
		String cod_auto=""; //new
		String nomApell="";	//new	
		String correoColab="";//new
		String correoAutoriz="";//new
		String mensaje = "";//new		
		String mensajeF = "";//new
		Map mParams = new HashMap();//new
		//mParams.put("fec_correo",new FechaBean().getFormatDate("dd/MM/yyyy"));//fecha envio correo
		//ICAPUNAY - PAS20175E230300069
		
		DataSource ds = ServiceLocator.getInstance().getDataSource(dbpool);
		pe.gob.sunat.rrhh.asistencia.dao.T1271DAO t1271dao = new  pe.gob.sunat.rrhh.asistencia.dao.T1271DAO(ds);

	    //verificamos si es fin de semana o feriado
		/* //ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)
	    diaEspecial = Utiles.isDiaSemana(fechaEval, Constantes.SABADO)
				|| Utiles.isDiaSemana(fechaEval, Constantes.DOMINGO)
				|| paramDAO.findByFechaFeriado(dbpool, fechaEval);
		
	    //obtenemos el turno del dia
	    turno = daoTurno.joinWithT45ByCodFecha(dbpool,codPers, fechaEval);
	    if (log.isDebugEnabled()) log.debug("fechaEval:"+fechaEval);//LOG GENERACION
	    if (turno!=null){		    
	    	bOperativo = turno.isOperativo();
			bControla = turno.isControla();		    	
	    	String horaIniTurno = turno.getHoraIni();
	    	String horaFinTurno = turno.getHoraFin();
		    if (horaFinTurno.compareTo(horaIniTurno)<=0){
		    	if (log.isDebugEnabled()) log.debug("horaFinTurno.compareTo(horaIniTurno):"+horaFinTurno.compareTo(horaIniTurno));//LOG GENERACION
				String ultFecha = (String)fechas.get(codPers);
				if (log.isDebugEnabled()) log.debug("turno.getDuracion():"+turno.getDuracion());//LOG GENERACION
				if  (ultFecha==null || !ultFecha.equals(fechaEval))  {
					if (ultFecha==null){						
						fechas.put(codPers,Utiles.dameFechaSiguiente(fechaEval, turno.getDuracion()));
						if (log.isDebugEnabled()) log.debug("fechas:"+fechas);//LOG GENERACION
					}else {
					if (Utiles.obtenerDiasDiferencia(ultFecha, fechaEval) >0 ) {
						fechas.put(codPers,Utiles.dameFechaSiguiente(fechaEval, turno.getDuracion()));
						if (log.isDebugEnabled()) log.debug("fechas1:"+fechas);//LOG GENERACION
					}
					else{
						generar = false;
						if (log.isDebugEnabled()) log.debug("generar1:"+generar);//LOG GENERACION
					}
					}
				}
				else{
					generar = false;
					fechas.put(codPers,fechaEval);
					if (log.isDebugEnabled()) log.debug("fechas2:"+fechas);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("generar2:"+generar);//LOG GENERACION
				}			    				    
		    }
	    }
	    */ //ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)
	    
		 //en caso las marcaciones del dia aun no han sido calificadas
	    if (log.isDebugEnabled()) log.debug("generar:"+generar);
	    
	    //if (generar && turno!=null){//ICAPUNAY 13/06/2012 PASE 2012-381 AJUSTES A CALIFICACION DE ASISTENCIA
	    if (generar){//ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)
	    	if (log.isDebugEnabled()) log.debug("generar true");//LOG GENERACION
		   		    
		    //ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)
		    BeanMarcacion bMarcacion2 = null;
			BeanMarcacion bMSgte2 = null;
			String fechaMarcacion2 = "";
			String horaMarcacion2 = "";
			String fechaFinMov2 = "";
			String horaFinMov2 = "";
			String relojIni2 = "";
			String relojFin2 = "";
			String tMov2 = "";
			String movAct = ""; //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
			boolean bOperativo2 = false;
			boolean bOperativoW = false;//NUEVO			
		    
		    BeanTurnoTrabajo turnoDx = null;
		    String fechaAntes = "";
		    String horaIniTurnoDw = "";
			String horaFinTurnoDw = "";
			String horaIniTurnoDx = "";
			String horaFinTurnoDx = "";
			BeanTurnoTrabajo turno1 = daoTurno.joinWithT45ByCodPersFecha_Controlado_OperAdm1dia(dbpool,codPers.trim(),fechaEval);		    
			if (turno1!=null){
				turnoDx=turno1;					    
			}else{
				BeanTurnoTrabajo turno2 = daoTurno.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,codPers.trim(),fechaEval);
				turnoDx=turno2;				    
			}
			if (log.isDebugEnabled()) log.debug("turnoDx("+fechaEval+"): " + "("+codPers+"): "+turnoDx);
						
			if (turnoDx!=null){
				
				//ICAPUNAY 23/02/2015 AJUSTES GENERACION ASISTENCIA (caso SES: SI turno (dia x-1) de 2 dias y SI turno dia x de 1 d涌(marcaciones IMPARES requiere para dia x))
				if (log.isDebugEnabled()) log.debug("tiene turno dia x");
				horaIniTurnoDx = turnoDx.getHoraIni().trim();
				horaFinTurnoDx = turnoDx.getHoraFin().trim();
				bOperativo2 = turnoDx.isOperativo();
				if (log.isDebugEnabled()) log.debug("horaIniTurnoDx("+codPers+"): " + horaIniTurnoDx);
				if (log.isDebugEnabled()) log.debug("horaFinTurnoDx("+codPers+"): " + horaFinTurnoDx);  
				if(horaFinTurnoDx.trim().compareTo(horaIniTurnoDx.trim())>0){ //adm u ope 1 dia
					if (log.isDebugEnabled()) log.debug("horaFinTurnoDx>horaIniTurnoDx(adm u ope 1 dia)");
					fechaAntes = Utiles.dameFechaAnterior(fechaEval, 1);	    		   
					BeanTurnoTrabajo turnoDw = daoTurno.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,codPers,fechaAntes); //dia (x-1)
					if (log.isDebugEnabled()) log.debug("turno1 dia x-1 (turnoDw)("+codPers+"): " + turnoDw);
					if (turnoDw!=null){	
						if (log.isDebugEnabled()) log.debug("registro("+codPers+"): SI turno (dia x-1) de 2 dias y SI turno dia x de 1 d涌(marcaciones IMPARES requiere para dia x)_FORMATIVAS");
						horaIniTurnoDw = turnoDw.getHoraIni().trim();
						horaFinTurnoDw = turnoDw.getHoraFin().trim();
						bOperativoW = turnoDw.isOperativo();//NUEVOO						
						tieneRefrigerio = false;//NUEVOO
						tieneRefrigerioW = false;//NUEVOO
						if (log.isDebugEnabled()) log.debug("horaIniTurnoDw_SES("+codPers+"): " + horaIniTurnoDw);
						if (log.isDebugEnabled()) log.debug("horaFinTurnoDw_SES("+codPers+"): "+ horaFinTurnoDw);												
						//impar requiere (par es omision cuando no puede calificar) //solo S,E,S	//reg 9793(FORMATIVAS)-28/01/15	
						
						//NUEVOO FORMATIVAS
						listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
						if (log.isDebugEnabled()) log.debug("listaMarcaciones_SES:"+listaMarcaciones);
						if (listaMarcaciones != null && listaMarcaciones.size() > 0) {
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral													
							autoriClima=climaLabDAO.findAutorizaByRegByFecha(codPers, fechaEval);
							log.debug("autoriClima: "+autoriClima);							
							if (autoriClima!=null && !autoriClima.isEmpty()){
								procesaClima=true;
							}
							//ICAPUNAY - PAS20175E230300069
							
							int j=0;							
							boolean esPareja=false;
							boolean tieneSalidaW=false;
							boolean tieneEntradaX=false;
							boolean tieneSalidaX=false;//DESARROLLAR PARA ESTE
							Map calificacion = new HashMap();
							for (int i = 0; i <= listaMarcaciones.size()-1; i++) {
								esPareja=false;
								if (log.isDebugEnabled()) log.debug("i_SES:"+i);
								bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
								fechaMarcacion2 = bMarcacion2.getFecha();//28/01/15
								horaMarcacion2 = bMarcacion2.getHora();//01:00:00
								relojIni2 = bMarcacion2.getReloj();
								relojFin2 = "";
								fechaFinMov2= "";
								if (log.isDebugEnabled()) log.debug("i_SES:"+i);								
								if (log.isDebugEnabled()) log.debug("fechaMarcacion_SES("+i+"):"+fechaMarcacion2);
								if (log.isDebugEnabled()) log.debug("horaMarcacion_SES("+i+"):"+horaMarcacion2);
							
								if (i<=listaMarcaciones.size()-2){//i<=7(9 total)										
									j=i+1;	//i=0/j=1								
									bMSgte2 = (BeanMarcacion) listaMarcaciones.get(j);							
									fechaFinMov2 = bMSgte2.getFecha();//28/01/15
									horaFinMov2 = bMSgte2.getHora();//05:00:00
									relojFin2 = bMSgte2.getReloj();
									if (log.isDebugEnabled()) log.debug("j(i+1) SES:"+j);									
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 int_SES :"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 int_SES:"+horaFinMov2);								
																			
									if(horaMarcacion2.trim().compareTo(horaFinTurnoDw.trim())<0){
										if (log.isDebugEnabled()) log.debug("entro 1_SES");
										if (horaFinMov2.trim().compareTo(horaFinTurnoDw.trim())<0){
											if (log.isDebugEnabled()) log.debug("entro 1.1_SES");
											esPareja=true;										
											i=j;
											if (log.isDebugEnabled()) log.debug("j_SES:"+j);
											if (log.isDebugEnabled()) log.debug("i_SES:"+i);
										}else{//horaFinMov2>=horaFinTurnoDw
											if (log.isDebugEnabled()) log.debug("entro 1.2_SES");
											if (tieneSalidaW==false){
												if (log.isDebugEnabled()) log.debug("entro 1.3_SES");
												tMov2 = preCalificarSalidaOpe1(
														dbpool,
														codPers,
														fechaMarcacion2,
														horaMarcacion2,
														turnoDw.getHoraFin(),
														Constantes.MINUTO);
												if (log.isDebugEnabled()) log.debug("salida66 preCalificarSalidaOpe1(tMov2) SES:"+tMov2);					
												horaFinMov2 = "";
												//ICR 18052015
												if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
													horaFinMov2=turnoDw.getHoraFin();
												}
												//ICR 18052015
												tieneSalidaW=true;											
												if (log.isDebugEnabled()) log.debug("tieneSalidaW_SES:"+tieneSalidaW);
												if (log.isDebugEnabled()) log.debug("j_SES:"+j);
												if (log.isDebugEnabled()) log.debug("i_SES:"+i);
											}	
										}										
									}else{//horaMarcacion2>=horaFinTurnoDw //revisando
										if (log.isDebugEnabled()) log.debug("entro 2_SES");
										//ok9
										if (horaMarcacion2.trim().compareTo(horaIniTurnoDx.trim())<=0){//revisando
											if (log.isDebugEnabled()) log.debug("entro 2.1_SES");
											if (tieneSalidaW==false){
												if (log.isDebugEnabled()) log.debug("entro 2.2_SES");
												tMov2 = Constantes.SALIDA_NORMAL; //salida
												tieneSalidaW=true;											
												horaFinMov2 = "";
												if (log.isDebugEnabled()) log.debug("i antes_SES:"+i);												
											}else{//tieneSalidaW==true
												if (log.isDebugEnabled()) log.debug("entro 2.3_SES");
												if (horaFinMov2.trim().compareTo(horaIniTurnoDx.trim())<=0){
													if (log.isDebugEnabled()) log.debug("entro 2.4_SES");
													esPareja=true;												
													i=j;
													if (log.isDebugEnabled()) log.debug("j_SES:"+j);
													if (log.isDebugEnabled()) log.debug("i_SES:"+i);
												}else{//horaFinMov2>horaIniTurnoDx
													if (log.isDebugEnabled()) log.debug("entro 2.5_SES");
													if (tieneEntradaX==false){
														if (log.isDebugEnabled()) log.debug("entro 2.6_SES");
														tMov2 = Constantes.ENTRADA_NORMAL; //entrada
														tieneEntradaX=true;				
														horaFinMov2 = "";
														if (log.isDebugEnabled()) log.debug("i antes2_SES:"+i);														
														if (log.isDebugEnabled()) log.debug("i_SES:"+i);
																							
													}
												}
											}
										}else{//horaMarcacion2>horaIniTurnoDx (aca modificar)	
											if (log.isDebugEnabled()) log.debug("entro 2.7_SES");
											//ok
											if (horaMarcacion2.trim().compareTo(horaFinTurnoDx.trim())<0){//if nuevo
												//ok
												if (tieneEntradaX==false){
													if (log.isDebugEnabled()) log.debug("entro 2.8_SES");
													tMov2 = preCalificarEntrada(
															fechaMarcacion2,
															horaMarcacion2,
															turnoDx.getHoraIni(),
															turnoDx.getTolera(),
															turnoDx.getHoraLimite(),
															Constantes.MINUTO);
													if (log.isDebugEnabled()) log.debug("salida66 preCalificarEntrada(tMov2)_SES:"+tMov2);
													tieneEntradaX=true;												
													horaFinMov2 = "";
													if (tMov2.equals(Constantes.MOV_ENTRADA_ANTICIPADA)) {
														tMov2 = Constantes.ENTRADA_NORMAL;
														if (log.isDebugEnabled()) log.debug("tMov4:"+tMov2);
													}									
													if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO)) {
														tMov2 = Constantes.MOV_TARDANZA_EFECTIVA;
														if (log.isDebugEnabled()) log.debug("tMov5:"+tMov2);
													}
													//hsal cuando es tardanza 01 se coloca valor
													if (tMov2.equals(Constantes.MOV_TARDANZA_EFECTIVA)) {
														horaFinMov2=turnoDx.getHoraIni();
													}
													//fin hsal
													if (log.isDebugEnabled()) log.debug("j_SES:"+j);
													if (log.isDebugEnabled()) log.debug("i_SES:"+i);
												}else{//tieneEntradaX==true //revisar si debe ir tieneSalidaX
													if (log.isDebugEnabled()) log.debug("entro 2.9_SES");																							
													// no interesa si horaFinMov2 es mayor o menor que horaFinTurnoDx
													esPareja=true;											
													i=j;
													if (log.isDebugEnabled()) log.debug("j_SES:"+j);
													if (log.isDebugEnabled()) log.debug("i_SES:"+i);													
																									
												}//ok
											}else{//nuevo //horaMarcacion2>=horaFinTurnoDx
												//desarrollar
												if (tieneSalidaX==false){//if nuevo
													if (log.isDebugEnabled()) log.debug("entro 2.92_SES");
													tMov2 = preCalificarSalidaOpe1(
															dbpool,
															codPers,
															fechaMarcacion2,
															horaMarcacion2,
															turnoDx.getHoraFin(),
															Constantes.MINUTO);
													if (log.isDebugEnabled()) log.debug("salida6666 preCalificarSalidaOpe1(tMov2) SES:"+tMov2);					
													horaFinMov2 = "";
													//ICR 18052015
													if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
														horaFinMov2=turnoDx.getHoraFin();
													}
													//ICR 18052015
													tieneSalidaX=true;											
													if (log.isDebugEnabled()) log.debug("tieneSalidaX_SES:"+tieneSalidaX);
													if (log.isDebugEnabled()) log.debug("j_SES:"+j);
													if (log.isDebugEnabled()) log.debug("i_SES:"+i);
												}else{//tieneSalidaX==true	
													//horaFinMov2 es mayor que horaFinTurnoDx
													esPareja=true;											
													i=j;
													if (log.isDebugEnabled()) log.debug("j_SES:"+j);
													if (log.isDebugEnabled()) log.debug("i_SES:"+i);													
												}//ok		
											}
											//ok
										}//ok9										
									  }
									//ok
									if (esPareja){
										if (log.isDebugEnabled()) log.debug("espareja==true SES");
										//calificacion = preCalificarMovimientoOpe4(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDw, turnoDx,Constantes.MINUTO,tieneRefrigerioW, tieneRefrigerio,bOperativoW,bOperativo2); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										calificacion = preCalificarMovimientoOpe4(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDw, turnoDx,Constantes.MINUTO,tieneRefrigerioW, tieneRefrigerio,bOperativoW,bOperativo2,procesaClima,minMaxClima); //se agrego procesaClima y minMaxClima //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										if (log.isDebugEnabled()) log.debug("salida66 preCalificarMovimientoOpe4(calificacion)_SES:"+calificacion);

										tMov2=(String)calificacion.get("calif");
										
										/*if(calificacion.get("refrigerioW").equals("SI")){
											if (log.isDebugEnabled()) log.debug("refrigerioW==SI");
											if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) {
												if (log.isDebugEnabled()) log.debug("exceso o refrigerio_SES");
												tieneRefrigerioW = true;
												if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2 SES:"+fechaMarcacion2 + " " + horaMarcacion2);
												if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2 SES:"+fechaMarcacion2 + " " + horaFinMov2);
												float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
												float quedan = turnoDw.getMinutosRefrigerio() - durante1;
												if (log.isDebugEnabled()) log.debug("tieneRefrigerioW SES:"+tieneRefrigerioW);
												if (log.isDebugEnabled()) log.debug("durante1 w_SES:"+durante1);
												if (log.isDebugEnabled()) log.debug("quedan w_SES:"+quedan);
												turnoDw.setMinutosRefrigerio( new Float(quedan).intValue());
												log.debug("turnoDw(setMinutosRefrigerio o quedan_SES) : " + quedan);
											}
										}*/	

										if(calificacion.get("refrigerioX").equals("SI")){
											if (log.isDebugEnabled()) log.debug("refrigerioX==SI");
											//if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
											if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
												if (log.isDebugEnabled()) log.debug("exceso o refrigerio_SES");
												// ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
												Map calificacionActual=null;
												calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "2", "3","5"); //0=calificacion inicial, 2=papeleta aprobada, 3= papeleta procesada, //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral (adicion 5=calificacion por rrhh)
												if (log.isDebugEnabled()) log.debug("calificacionActuall : "+calificacionActual);												
												if (calificacionActual!=null){
													if (log.isDebugEnabled()) log.debug("entrooooo");
													movAct= calificacionActual.get("mov").toString().trim();//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													//if (tMov2.trim().equals(calificacionActual.get("mov").toString().trim())){ ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (movAct.equals(Constantes.MOV_EXCESO_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRI_CLIMALABORAL) ){ //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (log.isDebugEnabled()) log.debug("movAct igual a refri, exceso o refri clima");
														if (log.isDebugEnabled()) log.debug("tMov2 : "+tMov2);
														if (log.isDebugEnabled()) log.debug("calificacionActual : "+calificacionActual);
														
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio : "+tieneRefrigerio);
														if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
														tieneRefrigerio = true;
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2 SES:"+fechaMarcacion2 + " " + horaMarcacion2);
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2 SES:"+fechaMarcacion2 + " " + horaFinMov2);
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1 x_SES:"+durante1);
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio SES:"+tieneRefrigerio);
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
															if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
															minMaxClima= new Float(quedan).intValue();
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("turnoDx.getMinutosRefrigerio(): "+turnoDx.getMinutosRefrigerio());
															log.debug("quedan: " + quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());															
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														
													}else{
														tieneRefrigerio = false;
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio: "+tieneRefrigerio);
													}														
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas
												else{													
													calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "0", "0","0"); //0=calificacion inicial
													if (log.isDebugEnabled()) log.debug("calificacionActual2 : "+calificacionActual);
													if (calificacionActual==null){
														tieneRefrigerio = true;
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
															if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
															minMaxClima= new Float(quedan).intValue();
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("turnoDx.getMinutosRefrigerio(): "+turnoDx.getMinutosRefrigerio());
															log.debug("quedan: " + quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());															
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral													
													}													
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas												
												//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
											}
										}
									}															
									//todo ok									
								}else{
									//llego aca termine (marcacion sola)
									if (log.isDebugEnabled()) log.debug("no debe llegar aca FORMATIVAS-ultima marcaci?ES");
									if (log.isDebugEnabled()) log.debug("j_SES:"+j);
									if (log.isDebugEnabled()) log.debug("i_SES:"+i);
									if (listaMarcaciones.size()==1){
										tMov2 = Constantes.MOV_OMISION_MARCA;
										if (log.isDebugEnabled()) log.debug("tMov una marcacion(omision)-SES:"+tMov2);
									}else{
										if (tieneSalidaW==false){
											if (log.isDebugEnabled()) log.debug("entro 1.3_SES");
											tMov2 = preCalificarSalidaOpe1(
													dbpool,
													codPers,
													fechaMarcacion2,
													horaMarcacion2,
													turnoDw.getHoraFin(),
													Constantes.MINUTO);
											if (log.isDebugEnabled()) log.debug("salida66 preCalificarSalidaOpe1(tMov2)_SES:"+tMov2);					
											horaFinMov2 = "";
											//ICR 18052015
											if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
												horaFinMov2=turnoDw.getHoraFin();
											}
											//ICR 18052015
											tieneSalidaW=true;											
											if (log.isDebugEnabled()) log.debug("tieneSalidaW_SES:"+tieneSalidaW);										
										}
										else{//tieneSalidaW==true
											if (tieneEntradaX==false){											
												if (log.isDebugEnabled()) log.debug("entro 3.0_SES");
												tMov2 = preCalificarEntrada(
														fechaMarcacion2,
														horaMarcacion2,
														turnoDx.getHoraIni(),
														turnoDx.getTolera(),
														turnoDx.getHoraLimite(),
														Constantes.MINUTO);
												if (log.isDebugEnabled()) log.debug("salida66 preCalificarEntrada(tMov2)_SES:"+tMov2);
												horaFinMov2 = "";
												if (tMov2.equals(Constantes.MOV_ENTRADA_ANTICIPADA)) {
													tMov2 = Constantes.ENTRADA_NORMAL;
													if (log.isDebugEnabled()) log.debug("tMov4:"+tMov2);
												}									
												if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO)) {
													tMov2 = Constantes.MOV_TARDANZA_EFECTIVA;
													if (log.isDebugEnabled()) log.debug("tMov5:"+tMov2);
												}
												//hsal cuando es tardanza 01 se coloca valor
												if (tMov2.equals(Constantes.MOV_TARDANZA_EFECTIVA)) {
													horaFinMov2=turnoDx.getHoraIni();
												}
												//fin hsal
												tieneEntradaX=true;	
												if (log.isDebugEnabled()) log.debug("tieneEntradaX_SES:"+tieneEntradaX);
											}else{//tieneEntradaX==true
												
												if (tieneSalidaX==false){
													if (log.isDebugEnabled()) log.debug("entro 1.33_SES");
													tMov2 = preCalificarSalidaOpe1(
															dbpool,
															codPers,
															fechaMarcacion2,
															horaMarcacion2,
															turnoDx.getHoraFin(),
															Constantes.MINUTO);
													if (log.isDebugEnabled()) log.debug("salida666 preCalificarSalidaOpe1(tMov2)_SES:"+tMov2);					
													horaFinMov2 = "";
													//ICR 18052015
													if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
														horaFinMov2=turnoDx.getHoraFin();
													}
													//ICR 18052015
													tieneSalidaX=true;											
													if (log.isDebugEnabled()) log.debug("tieneSalidaX_SES:"+tieneSalidaX);
													
												}else{//tieneSalidaX==true
													tMov2 = Constantes.MOV_OMISION_MARCA;
													horaFinMov2 = "";//SI ES OMISION TIENE horaFinMov2 vacion
													if (log.isDebugEnabled()) log.debug("tMov5-FORMATIVAS_SES(omision):"+tMov2);
												}												
											}
										}
									}	
								}
								if (tMov2.equals(Constantes.MOV_ENTRADA_ANTICIPADA)) {
									tMov2 = Constantes.ENTRADA_NORMAL;
									if (log.isDebugEnabled()) log.debug("tMov4-FORMATIVAS_SES:"+tMov2);
								}	
								if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO)) {
									tMov2 = Constantes.MOV_TARDANZA_EFECTIVA;
									if (log.isDebugEnabled()) log.debug("tMov5-FORMATIVAS_SES:"+tMov2);
								}			
								//fin llego aca
								
								try{
									if (horaFinMov2!=null && horaFinMov2!="") {
										if (log.isDebugEnabled()) log.debug("horaFinMov2!=null y horaFinMov2!=vacio");
										if (log.isDebugEnabled()) log.debug("codPers:"+codPers+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"/fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2);
										log.debug("borrando6 asistencia FORMATIVAS en T1271DAO_SES: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
										t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
									}
									log.debug("datos FORMATIVAS para T1271DAO_SES: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									Map params1 = new HashMap();
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);
									params1.put("cod_uorgan", codUO);
									params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
									params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									params1.put("mov", tMov2);
									params1.put("relojIni", relojIni2);
									params1.put("relojFin", relojFin2);
									params1.put("usuario", usuario);	
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI (SES");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else {	
										log.debug("isProcesar NO (SES)");
										boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
										if (inserto){
											log.debug("SI inserto1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO inserto1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0		
								}
								catch(Exception e){
									if (log.isDebugEnabled()) log.debug("catch6- generarAsistenciaTrabajadorModFormativa_SES");										
									Map params1 = new HashMap();
									params1.put("mov", tMov2);
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("usuario", usuario);
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);							
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", horaMarcacion2);
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else{
										log.debug("isProcesar NO");
									//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
										boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
										if (actualizo){
											log.debug("SI actualizo1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO actualizo1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0									
								}
							}//fin for ok
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral - new
							if (autoriClima!=null && !autoriClima.isEmpty()){
								estadoAut=autoriClima.get("ind_aut").toString().trim();
								cod_auto = autoriClima.get("cod_aut").toString().trim();
								if ((excesoClima==true || refriClima==true) && estadoAut.equals("0")){
									log.debug("actualizara estado autorizacion (codPers: "+codPers+" fechaEval: "+fechaEval+" )");
									prms.put("ind_aut", Constantes.ACTIVO);					
									prms.put("cod_user_mod", "BATCH-CLIMA-LAB");
									prms.put("cod_pers", codPers);
									prms.put("fec_aut", autoriClima.get("fec_aut_desc").toString());					
									climaLabDAO.updateRegistroAutorizaCli(prms);
									
									//envio correo
									nomApell = (autoriClima.get("t02ap_pate")!=null?autoriClima.get("t02ap_pate").toString().trim():"")+" "+(autoriClima.get("t02ap_mate")!=null?autoriClima.get("t02ap_mate").toString().trim():"")+" "+(autoriClima.get("t02nombres")!=null?autoriClima.get("t02nombres").toString().trim():"");
									mParams.put("registro",codPers);
									if (log.isDebugEnabled()) log.debug("mParamss: " + mParams);
									
									mensajeF = "El sistema ha procedido a calificar sus marcaciones de Clima Laboral para la fecha "+(String)autoriClima.get("fec_aut_desc")+".";	
									if (log.isDebugEnabled()) log.debug("mensajeFF: " + mensajeF);	
									mensaje = textoCorreoClimaLaboral(mParams,nomApell,mensajeF);//mensaje en html
									if (log.isDebugEnabled()) log.debug("mensajee: " + mensaje);																			
									Correo objCorreo = new Correo(mensaje.toString());									
									objCorreo.setServidor(propiedadesCorreo.leePropiedad("servidor"));									
									objCorreo.setRemitente(propiedadesCorreo.leePropiedad("correoRemitenteMovimientos"),propiedadesCorreo.leePropiedad("nombreRemitenteMovimientos"));
															
									correoColab=correoDAO.findCorreoByRegistro(codPers);
									correoAutoriz=correoDAO.findCorreoByRegistro(cod_auto);
														
									// VALIDANDO SI TRABAJADOR TIENE CORREO																
									if (!correoColab.equals("")) {						
										if (log.isDebugEnabled()) log.debug("correoColab Trabajador= " + correoColab);
										try{
											//trabajador tiene correo correcto, se debe enviar correo a trabajador con copia a autorizador								
											objCorreo.agregarDestinatario(correoColab.trim());
											if(!correoAutoriz.equals("")){
												objCorreo.agregarConCopia(correoAutoriz.trim());
											}
											//objCorreo.agregarConCopia("jquispecoi@sunat.gob.pe");/////ELIMINAR
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral");
											objCorreo.enviarHtml();		
											if (log.isDebugEnabled()) log.debug("Se envio correo a trabajador");	
																		
										} catch (CorreoException ce) {
											//trabajador tiene correo erroneo, hay destinatario erroneo 
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - CORREO ERR흁EO");
											objCorreo.enviarHtml();
									 		if (log.isDebugEnabled()) log.debug("Error en CorreoExceptionn: "+ce.toString());									 	
										 	if (log.isDebugEnabled()) log.debug("SI tiene correo trabajador: "+codPers+" - pero correo es erroneo");									 										 	
										}											
									}//fin if tiene correo
									else {
										//trabajador no tiene correo, no hay destinatario y se debe copiar a rrhh correo
										objCorreo.agregarConCopia(propiedadesCorreo.leePropiedad("correoReceptorAlertaCambioTurnos"));
										objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - NO TIENE CORREO");
										objCorreo.enviarHtml();							
										if (log.isDebugEnabled()) log.debug("NO tiene correo trabajador: " + codPers+" - se envio a rrhh");
									}
									//fin envio correo
								}
							}							
							//ICAPUNAY - PAS20175E230300069
						}
						//FIN NUEVOO FORMATIVAS
						//FIN ICAPUNAY 23/02/2015 AJUSTES GENERACION ASISTENCIA (caso SES: SI turno (dia x-1) de 2 dias y SI turno dia x de 1 d涌(marcaciones IMPARES requiere para dia x))
										
					}else{
						if (log.isDebugEnabled()) log.debug("registro("+codPers+"): NO turno (dia x-1) de 2 dias y SI turno dia x de 1 d涌(marcaciones PARES requiere para dia x)");
						
						//par requiere (impar es omision) //logica normal minimo (E S)						
						diaEspecial = Utiles.isDiaSemana(fechaEval, Constantes.SABADO) || Utiles.isDiaSemana(fechaEval, Constantes.DOMINGO) || paramDAO.findByFechaFeriado(dbpool, fechaEval);
						tieneRefrigerio = false;						
						listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
						if (log.isDebugEnabled()) log.debug("listaMarcaciones:"+listaMarcaciones);
						if (listaMarcaciones != null && listaMarcaciones.size() > 0) {	
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral												
							autoriClima=climaLabDAO.findAutorizaByRegByFecha(codPers, fechaEval);
							log.debug("autoriClima: "+autoriClima);							
							if (autoriClima!=null && !autoriClima.isEmpty()){
								procesaClima=true;
							}
							//ICAPUNAY - PAS20175E230300069
							
							for (int i = 0; i < listaMarcaciones.size(); i++) {	
								bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
								fechaMarcacion2 = bMarcacion2.getFecha();
								horaMarcacion2 = bMarcacion2.getHora();
								relojIni2 = bMarcacion2.getReloj();
								relojFin2 = "";
								if (log.isDebugEnabled()) log.debug("i:"+i);
								if (log.isDebugEnabled()) log.debug("bMarcacion2("+i+"):"+bMarcacion2);
								if (log.isDebugEnabled()) log.debug("fechaMarcacion2("+i+"):"+fechaMarcacion2);
								if (log.isDebugEnabled()) log.debug("horaMarcacion2("+i+"):"+horaMarcacion2);
								//primera marcacion de ENTRADA
								if (i==0){
									if (log.isDebugEnabled()) log.debug("primera marca");
									fechaFinMov2 = bMarcacion2.getFecha();
									horaFinMov2 = "";
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 ent:"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 ent:"+horaFinMov2);
									if (diaEspecial && !bOperativo2){
										tMov2 = Constantes.MOV_APORTACION;	
										if (log.isDebugEnabled()) log.debug("tMov2:"+tMov2);
									}else{
										tMov2 = preCalificarEntrada(
												fechaMarcacion2,
												horaMarcacion2,
												turnoDx.getHoraIni(),
												turnoDx.getTolera(),
												turnoDx.getHoraLimite(),
												Constantes.MINUTO);
										if (log.isDebugEnabled()) log.debug("salida preCalificarEntrada(tMov):"+tMov2);
									}							
									if (tMov2.equals(Constantes.MOV_ENTRADA_ANTICIPADA)) {
										tMov2 = Constantes.ENTRADA_NORMAL;
										if (log.isDebugEnabled()) log.debug("tMov4:"+tMov2);
									}									
									if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO)) {
										tMov2 = Constantes.MOV_TARDANZA_EFECTIVA;
										if (log.isDebugEnabled()) log.debug("tMov5:"+tMov2);
									}
								}else if (i == (listaMarcaciones.size() - 1)){//ultima marcacion de SALIDA
									if (log.isDebugEnabled()) log.debug("ultima marca");
									fechaFinMov2 = bMarcacion2.getFecha();
									horaFinMov2 = "";
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 sal:"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 sal:"+horaFinMov2);
									
									if (diaEspecial && !bOperativo2){
										tMov2 = Constantes.MOV_APORTACION;
										if (log.isDebugEnabled()) log.debug("tMov7:"+tMov2);
									}else{
										tMov2 = preCalificarSalida(
												dbpool,
												codPers,
												fechaMarcacion2,
												horaMarcacion2,
												turnoDx.getHoraFin(),
												Constantes.MINUTO);
										if (log.isDebugEnabled()) log.debug("salida preCalificarSalida(tMov2):"+tMov2);
									}															
								}
								//movimientos intermedios
								else{
									if (log.isDebugEnabled()) log.debug("marcaciones en pareja");					
									if (log.isDebugEnabled()) log.debug("listaMarcaciones.size():"+listaMarcaciones.size());								
									if (i < (listaMarcaciones.size() - 2)) {
										if (log.isDebugEnabled()) log.debug("i:"+i);
										bMSgte2 = (BeanMarcacion) listaMarcaciones.get(++i);							
										fechaFinMov2 = bMSgte2.getFecha();
										horaFinMov2 = bMSgte2.getHora();
										relojFin2 = bMSgte2.getReloj();
										if (log.isDebugEnabled()) log.debug("bMSgte2 int:"+bMSgte2);
										if (log.isDebugEnabled()) log.debug("fechaFinMov2 int :"+fechaFinMov2);
										if (log.isDebugEnabled()) log.debug("horaFinMov2 int:"+horaFinMov2);
										if (log.isDebugEnabled()) log.debug("relojFin2 int:"+relojFin2);
										if (diaEspecial && !bOperativo2){
											tMov2 = Constantes.MOV_APORTACION;	
											if (log.isDebugEnabled()) log.debug("tMov9:"+tMov2);
										}else{										
											//tMov2 = preCalificarMovimiento(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDx,	Constantes.MINUTO, tieneRefrigerio,	bOperativo2);
											//tMov2 = preCalificarMovimiento_soloTurnoAdmOpe1dia(dbpool,codPers,fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDx,	Constantes.MINUTO, tieneRefrigerio,	bOperativo2); //se agrego dbpool y codPers //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
											tMov2 = preCalificarMovimiento_soloTurnoAdmOpe1dia(dbpool,codPers,fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDx, Constantes.MINUTO, tieneRefrigerio,bOperativo2,procesaClima,minMaxClima); //se agrego procesaClima y minMaxClima //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
											if (log.isDebugEnabled()) log.debug("salida preCalificarMovimiento_soloTurnoAdmOpe1dia(tMov):"+tMov2);
											//if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
											if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
												
												// ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
												Map calificacionActual=null;
												calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "2", "3","5"); //0=calificacion inicial, 2=papeleta aprobada, 3= papeleta procesada, //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral (adicion 5=calificacion por rrhh)
												if (log.isDebugEnabled()) log.debug("calificacionActuall : "+calificacionActual);												
												if (calificacionActual!=null){
													if (log.isDebugEnabled()) log.debug("entrooooo");
													movAct= calificacionActual.get("mov").toString().trim();//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													//if (tMov2.trim().equals(calificacionActual.get("mov").toString().trim())){ ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (movAct.equals(Constantes.MOV_EXCESO_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRI_CLIMALABORAL) ){ //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (log.isDebugEnabled()) log.debug("movAct igual a refri, exceso o refri clima");
														if (log.isDebugEnabled()) log.debug("tMov2 : "+tMov2);
														if (log.isDebugEnabled()) log.debug("calificacionActual : "+calificacionActual);
														
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio : "+tieneRefrigerio);
														if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
														tieneRefrigerio = true;
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2:"+fechaMarcacion2 + " " + horaMarcacion2);
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2:"+fechaMarcacion2 + " " + horaFinMov2);
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("quedan1:"+quedan);
															minMaxClima= new Float(quedan).intValue();
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("quedan:"+quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														
													}else{
														tieneRefrigerio = false;
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio: "+tieneRefrigerio);
													}
														
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas
												else{													
													calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "0", "0","0"); //0=calificacion inicial
													if (log.isDebugEnabled()) log.debug("calificacionActual2 : "+calificacionActual);
													if (calificacionActual==null){
														tieneRefrigerio = true;
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("quedan1:"+quedan);
															minMaxClima= new Float(quedan).intValue();
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("quedan:"+quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral													
													}													
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas
												//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
											}										
										}															
									}else{//marcacion impar
										if (log.isDebugEnabled()) log.debug("marcacion impar");
										fechaFinMov2 = bMarcacion2.getFecha();
										horaFinMov2 = "";
										if (diaEspecial && !bOperativo2){
											tMov2 = Constantes.MOV_APORTACION;	
											if (log.isDebugEnabled()) log.debug("tMov11:"+tMov2);
										}else{										
											tMov2 = Constantes.MOV_OMISION_MARCA;
											if (log.isDebugEnabled()) log.debug("tMov12:"+tMov2);
										}										
									}		
									/*EBV 27/03/2015 CAMBIO DE LINEAMIENTO
									if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
										tMov2 = Constantes.MOV_SALIDA_AUTORIZADA;
										if (log.isDebugEnabled()) log.debug("tMov13:"+tMov2);
									}
									 */									
								}
								//fin mov intermedios								
								try{			
									if (log.isDebugEnabled()) log.debug("try- generarAsistenciaTrabajadorModFormativa");	
									if ((Constantes.TURNO_RS067).equals(turnoDx.getTurno().trim())){
										tMov2 = Constantes.MOV_RESOLUCION_067;
										if (log.isDebugEnabled()) log.debug("tMov14:"+tMov2);
									}									
									if (horaFinMov2!=null && horaFinMov2!="") {
										log.debug("borrando asistencia FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
										t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
									}									
									Map params1 = new HashMap();
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);
									params1.put("cod_uorgan", codUO);
									params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
									params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									params1.put("mov", tMov2);
									params1.put("relojIni", relojIni2);
									params1.put("relojFin", relojFin2);
									params1.put("usuario", usuario);
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI (SES");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else {	
										log.debug("isProcesar NO (SES)");
										boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
										if (inserto){
											log.debug("SI inserto1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO inserto1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0		
								}
								catch(Exception e){
									if (log.isDebugEnabled()) log.debug("catch- generarAsistenciaTrabajadorModFormativa");										
									Map params1 = new HashMap();
									params1.put("mov", tMov2);
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("usuario", usuario);
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);							
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", horaMarcacion2);
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else{
										log.debug("isProcesar NO");
									//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
										boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
										if (actualizo){
											log.debug("SI actualizo1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO actualizo1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0									
								}								
							}//fin for	
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral - new
							if (autoriClima!=null && !autoriClima.isEmpty()){
								estadoAut=autoriClima.get("ind_aut").toString().trim();
								cod_auto = autoriClima.get("cod_aut").toString().trim();
								if ((excesoClima==true || refriClima==true) && estadoAut.equals("0")){
									log.debug("actualizara estado autorizacion (codPers: "+codPers+" fechaEval: "+fechaEval+" )");
									prms.put("ind_aut", Constantes.ACTIVO);					
									prms.put("cod_user_mod", "BATCH-CLIMA-LAB");
									prms.put("cod_pers", codPers);
									prms.put("fec_aut", autoriClima.get("fec_aut_desc").toString());					
									climaLabDAO.updateRegistroAutorizaCli(prms);
									
									//envio correo
									nomApell = (autoriClima.get("t02ap_pate")!=null?autoriClima.get("t02ap_pate").toString().trim():"")+" "+(autoriClima.get("t02ap_mate")!=null?autoriClima.get("t02ap_mate").toString().trim():"")+" "+(autoriClima.get("t02nombres")!=null?autoriClima.get("t02nombres").toString().trim():"");
									mParams.put("registro",codPers);
									if (log.isDebugEnabled()) log.debug("mParamss: " + mParams);
									
									mensajeF = "El sistema ha procedido a calificar sus marcaciones de Clima Laboral para la fecha "+(String)autoriClima.get("fec_aut_desc")+".";	
									if (log.isDebugEnabled()) log.debug("mensajeFF: " + mensajeF);	
									mensaje = textoCorreoClimaLaboral(mParams,nomApell,mensajeF);//mensaje en html
									if (log.isDebugEnabled()) log.debug("mensajee: " + mensaje);																			
									Correo objCorreo = new Correo(mensaje.toString());									
									objCorreo.setServidor(propiedadesCorreo.leePropiedad("servidor"));									
									objCorreo.setRemitente(propiedadesCorreo.leePropiedad("correoRemitenteMovimientos"),propiedadesCorreo.leePropiedad("nombreRemitenteMovimientos"));
															
									correoColab=correoDAO.findCorreoByRegistro(codPers);
									correoAutoriz=correoDAO.findCorreoByRegistro(cod_auto);
														
									// VALIDANDO SI TRABAJADOR TIENE CORREO																
									if (!correoColab.equals("")) {						
										if (log.isDebugEnabled()) log.debug("correoColab Trabajador= " + correoColab);
										try{
											//trabajador tiene correo correcto, se debe enviar correo a trabajador con copia a autorizador								
											objCorreo.agregarDestinatario(correoColab.trim());
											if(!correoAutoriz.equals("")){
												objCorreo.agregarConCopia(correoAutoriz.trim());
											}
											//objCorreo.agregarConCopia("jquispecoi@sunat.gob.pe");/////ELIMINAR
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral");
											objCorreo.enviarHtml();		
											if (log.isDebugEnabled()) log.debug("Se envio correo a trabajador");	
																		
										} catch (CorreoException ce) {
											//trabajador tiene correo erroneo, hay destinatario erroneo 
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - CORREO ERR흁EO");
											objCorreo.enviarHtml();
									 		if (log.isDebugEnabled()) log.debug("Error en CorreoExceptionn: "+ce.toString());									 	
										 	if (log.isDebugEnabled()) log.debug("SI tiene correo trabajador: "+codPers+" - pero correo es erroneo");									 										 	
										}											
									}//fin if tiene correo
									else {
										//trabajador no tiene correo, no hay destinatario y se debe copiar a rrhh correo
										objCorreo.agregarConCopia(propiedadesCorreo.leePropiedad("correoReceptorAlertaCambioTurnos"));
										objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - NO TIENE CORREO");
										objCorreo.enviarHtml();							
										if (log.isDebugEnabled()) log.debug("NO tiene correo trabajador: " + codPers+" - se envio a rrhh");
									}
									//fin envio correo
								}
							}							
							//ICAPUNAY - PAS20175E230300069
						}
					}
				}else{
					if (log.isDebugEnabled()) log.debug("horaFinTurnoDx<=horaIniTurnoDx(ope 2 dias)");
					fechaAntes = Utiles.dameFechaAnterior(fechaEval, 1);	    		   
					BeanTurnoTrabajo turnoDw = daoTurno.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,codPers,fechaAntes); //dia (x-1)
					if (log.isDebugEnabled()) log.debug("turno2 dia x-1 (turnoDw)("+codPers+"): " + turnoDw);
					if (turnoDw!=null){
						if (log.isDebugEnabled()) log.debug("registro("+codPers+"): SI turno (dia x-1) de 2 dias y SI turno dia x de 2 d涌 (marcaciones PARES requiere para dia x)");
						horaIniTurnoDw = turnoDw.getHoraIni().trim();
						horaFinTurnoDw = turnoDw.getHoraFin().trim();
						bOperativoW = turnoDw.isOperativo();//NUEVO						
						tieneRefrigerio = false;//NUEVO
						tieneRefrigerioW = false;//NUEVO
						if (log.isDebugEnabled()) log.debug("horaIniTurnoDw2("+codPers+"): " + horaIniTurnoDw);
						if (log.isDebugEnabled()) log.debug("horaFinTurnoDw2("+codPers+"): "+ horaFinTurnoDw);						
						//hay 2 turnos turnoDw (anterior) y turnoDx (actual)						
						//par requiere (impar es omision) //solo S,E //09/09/14	
						
						//NUEVO
						listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
						if (log.isDebugEnabled()) log.debug("listaMarcaciones:"+listaMarcaciones);
						if (listaMarcaciones != null && listaMarcaciones.size() > 0) {
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral									
							autoriClima=climaLabDAO.findAutorizaByRegByFecha(codPers, fechaEval);
							log.debug("autoriClima: "+autoriClima);							
							if (autoriClima!=null && !autoriClima.isEmpty()){
								procesaClima=true;
							}
							//ICAPUNAY - PAS20175E230300069
							
							int j=0;
							float cantidad = 0;
							boolean esPareja=false;
							boolean tieneSalidaW=false;
							boolean tieneEntradaX=false;
							Map calificacion = new HashMap();
							for (int i = 0; i <= listaMarcaciones.size()-1; i++) {
								esPareja=false;
								if (log.isDebugEnabled()) log.debug("i:"+i);
								bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
								fechaMarcacion2 = bMarcacion2.getFecha();
								horaMarcacion2 = bMarcacion2.getHora();
								relojIni2 = bMarcacion2.getReloj();
								relojFin2 = "";
								fechaFinMov2= "";
								if (log.isDebugEnabled()) log.debug("i:"+i);								
								if (log.isDebugEnabled()) log.debug("fechaMarcacion2("+i+"):"+fechaMarcacion2);
								if (log.isDebugEnabled()) log.debug("horaMarcacion2("+i+"):"+horaMarcacion2);
							
								if (i<=listaMarcaciones.size()-2){										
									j=i+1;									
									bMSgte2 = (BeanMarcacion) listaMarcaciones.get(j);							
									fechaFinMov2 = bMSgte2.getFecha();
									horaFinMov2 = bMSgte2.getHora();
									relojFin2 = bMSgte2.getReloj();
									if (log.isDebugEnabled()) log.debug("j(i+1):"+j);									
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 int :"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 int:"+horaFinMov2);
									if (log.isDebugEnabled()) log.debug("relojFin2 int:"+relojFin2);
																			
									if(horaMarcacion2.trim().compareTo(horaFinTurnoDw.trim())<0){
										if (log.isDebugEnabled()) log.debug("entro 1");
										if (horaFinMov2.trim().compareTo(horaFinTurnoDw.trim())<0){
											if (log.isDebugEnabled()) log.debug("entro 1.1");
											esPareja=true;										
											i=j;
											if (log.isDebugEnabled()) log.debug("j:"+j);
											if (log.isDebugEnabled()) log.debug("i:"+i);
										}else{//horaFinMov2>horaFinTurnoDw
											if (log.isDebugEnabled()) log.debug("entro 1.2");
											if (tieneSalidaW==false){
												if (log.isDebugEnabled()) log.debug("entro 1.3");
												tMov2 = preCalificarSalidaOpe1(
														dbpool,
														codPers,
														fechaMarcacion2,
														horaMarcacion2,
														turnoDw.getHoraFin(),
														Constantes.MINUTO);
												if (log.isDebugEnabled()) log.debug("salida66 preCalificarSalidaOpe1(tMov2):"+tMov2);					
												horaFinMov2 = "";
												//ICR 18052015
												if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
													horaFinMov2=turnoDw.getHoraFin();
												}
												//ICR 18052015
												tieneSalidaW=true;											
												if (log.isDebugEnabled()) log.debug("tieneSalidaW:"+tieneSalidaW);
												if (log.isDebugEnabled()) log.debug("j:"+j);
												if (log.isDebugEnabled()) log.debug("i:"+i);
											}	
										}										
									}else{//horaMarcacion2>=horaFinTurnoDw
										if (log.isDebugEnabled()) log.debug("entro 2");
										if (horaMarcacion2.trim().compareTo(horaIniTurnoDx.trim())<=0){
											if (log.isDebugEnabled()) log.debug("entro 2.1");
											if (tieneSalidaW==false){
												if (log.isDebugEnabled()) log.debug("entro 2.2");
												tMov2 = Constantes.SALIDA_NORMAL; //salida
												tieneSalidaW=true;											
												horaFinMov2 = "";
												if (log.isDebugEnabled()) log.debug("i antes:"+i);												
											}else{
												if (log.isDebugEnabled()) log.debug("entro 2.3");
												if (horaFinMov2.trim().compareTo(horaIniTurnoDx.trim())<=0){
													if (log.isDebugEnabled()) log.debug("entro 2.4");
													esPareja=true;												
													i=j;
													if (log.isDebugEnabled()) log.debug("j:"+j);
													if (log.isDebugEnabled()) log.debug("i:"+i);
												}else{
													if (log.isDebugEnabled()) log.debug("entro 2.5");
													if (tieneEntradaX==false){
														if (log.isDebugEnabled()) log.debug("entro 2.6");
														tMov2 = Constantes.ENTRADA_NORMAL; //entrada
														tieneEntradaX=true;				
														horaFinMov2 = "";
														if (log.isDebugEnabled()) log.debug("i antes2:"+i);														
														if (log.isDebugEnabled()) log.debug("i:"+i);
													}
												}
											}
										}else{//horaMarcacion2>horaIniTurnoDx	
											if (log.isDebugEnabled()) log.debug("entro 2.7");
											if (tieneEntradaX==false){
												if (log.isDebugEnabled()) log.debug("entro 2.8");
												tMov2 = preCalificarEntradaOpe2(
														fechaMarcacion2,
														horaMarcacion2,
														turnoDx.getHoraIni(),
														turnoDx.getTolera(),
														turnoDx.getHoraLimite(),
														Constantes.MINUTO);
												if (log.isDebugEnabled()) log.debug("salida66 preCalificarEntradaOpe2(tMov2):"+tMov2);
												tieneEntradaX=true;												
												horaFinMov2 = "";
												if (tMov2.equals(Constantes.MOV_ENTRADA_ANTICIPADA)) {
													tMov2 = Constantes.ENTRADA_NORMAL;
													if (log.isDebugEnabled()) log.debug("tMov4:"+tMov2);
												}									
												if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO)) {
													tMov2 = Constantes.MOV_TARDANZA_EFECTIVA;
													if (log.isDebugEnabled()) log.debug("tMov5:"+tMov2);
												}
												//hsal cuando es tardanza 01 se coloca valor
												if (tMov2.equals(Constantes.MOV_TARDANZA_EFECTIVA)) {
													horaFinMov2=turnoDx.getHoraIni();
												}
												//fin hsal
												if (log.isDebugEnabled()) log.debug("j:"+j);
												if (log.isDebugEnabled()) log.debug("i:"+i);
											}else{
												if (log.isDebugEnabled()) log.debug("entro 2.9");
												if (horaFinMov2.trim().compareTo(horaIniTurnoDx.trim())>0){
													if (log.isDebugEnabled()) log.debug("entro 2.10");
													esPareja=true;											
													i=j;
													if (log.isDebugEnabled()) log.debug("j:"+j);
													if (log.isDebugEnabled()) log.debug("i:"+i);
												}
											}
										}										
									}									
									
									if (esPareja){
										if (log.isDebugEnabled()) log.debug("espareja==true");
										//calificacion = preCalificarMovimientoOpe3(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDw, turnoDx,	Constantes.MINUTO,tieneRefrigerioW, tieneRefrigerio,bOperativoW,bOperativo2); ////ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										calificacion = preCalificarMovimientoOpe3(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDw, turnoDx,Constantes.MINUTO,tieneRefrigerioW, tieneRefrigerio,bOperativoW,bOperativo2,procesaClima,minMaxClima); ////ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										if (log.isDebugEnabled()) log.debug("salida66 preCalificarMovimientoOpe3(calificacion):"+calificacion);

										tMov2=(String)calificacion.get("calif");
										
										/*if(calificacion.get("refrigerioW").equals("SI")){
											if (log.isDebugEnabled()) log.debug("refrigerioW==SI");
											if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) {
												if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
												tieneRefrigerioW = true;
												if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2:"+fechaMarcacion2 + " " + horaMarcacion2);
												if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2:"+fechaMarcacion2 + " " + horaFinMov2);
												float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
												float quedan = turnoDw.getMinutosRefrigerio() - durante1;
												if (log.isDebugEnabled()) log.debug("tieneRefrigerioW:"+tieneRefrigerioW);
												if (log.isDebugEnabled()) log.debug("durante1 w:"+durante1);
												if (log.isDebugEnabled()) log.debug("quedan w:"+quedan);
												turnoDw.setMinutosRefrigerio( new Float(quedan).intValue());
												log.debug("turnoDw(setMinutosRefrigerio o quedan) : " + quedan);
											}
										}*/	

										if(calificacion.get("refrigerioX").equals("SI")){
											if (log.isDebugEnabled()) log.debug("refrigerioX==SI");
											//if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) { ////ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
											if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)) { ////ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
												if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
												// ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
												Map calificacionActual=null;
												calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "2", "3","5"); //0=calificacion inicial, 2=papeleta aprobada, 3= papeleta procesada, //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral (adicion 5=calificacion por rrhh)
												if (log.isDebugEnabled()) log.debug("calificacionActuall : "+calificacionActual);												
												if (calificacionActual!=null){
													if (log.isDebugEnabled()) log.debug("entrooooo");
													movAct= calificacionActual.get("mov").toString().trim();//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													//if (tMov2.trim().equals(calificacionActual.get("mov").toString().trim())){ ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (movAct.equals(Constantes.MOV_EXCESO_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRI_CLIMALABORAL) ){ //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (log.isDebugEnabled()) log.debug("movAct igual a refri, exceso o refri clima");
														if (log.isDebugEnabled()) log.debug("tMov2 : "+tMov2);
														if (log.isDebugEnabled()) log.debug("calificacionActual : "+calificacionActual);
														
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio : "+tieneRefrigerio);
														if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
														tieneRefrigerio = true;
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2:"+fechaMarcacion2 + " " + horaMarcacion2);
														if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2:"+fechaMarcacion2 + " " + horaFinMov2);
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1 x:"+durante1);
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio:"+tieneRefrigerio);
														
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
															if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
															minMaxClima= new Float(quedan).intValue();
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("turnoDx.getMinutosRefrigerio(): "+turnoDx.getMinutosRefrigerio());
															log.debug("quedan: " + quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());															
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													}else{
														tieneRefrigerio = false;
														if (log.isDebugEnabled()) log.debug("tieneRefrigerio: "+tieneRefrigerio);
													}
														
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas
												else{													
													calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "0", "0","0"); //0=calificacion inicial
													if (log.isDebugEnabled()) log.debug("calificacionActual2 : "+calificacionActual);
													if (calificacionActual==null){
														tieneRefrigerio = true;
														float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
														if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
														
														//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
														if (procesaClima){
															float quedan = minMaxClima - durante1;														
															if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
															if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
															minMaxClima= new Float(quedan).intValue();
															//new
															if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
																excesoClima=true;
															}
															if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
																refriClima=true;
															}
															//new
														}else{
														//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
															float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
															if (log.isDebugEnabled()) log.debug("turnoDx.getMinutosRefrigerio(): "+turnoDx.getMinutosRefrigerio());
															log.debug("quedan: " + quedan);
															turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());															
														}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral														
													}													
												}
												//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas											
												//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
											}
										}
									}																									
									//todo									
								}else{
									//llego aca
									if (log.isDebugEnabled()) log.debug("no debe llegar aca FORMATIVAS-ultima marcacion");
									if (log.isDebugEnabled()) log.debug("j:"+j);
									if (log.isDebugEnabled()) log.debug("i:"+i);
									if (listaMarcaciones.size()==1){
										tMov2 = Constantes.MOV_OMISION_MARCA;
										if (log.isDebugEnabled()) log.debug("tMov una marcacion-FORMATIVAS:"+tMov2);
									}else{
										if (tieneSalidaW==false){
											if (log.isDebugEnabled()) log.debug("entro 1.3");
											tMov2 = preCalificarSalidaOpe1(
													dbpool,
													codPers,
													fechaMarcacion2,
													horaMarcacion2,
													turnoDw.getHoraFin(),
													Constantes.MINUTO);
											if (log.isDebugEnabled()) log.debug("salida66 preCalificarSalidaOpe1(tMov2):"+tMov2);					
											horaFinMov2 = "";
											//ICR 18052015
											if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
												horaFinMov2=turnoDw.getHoraFin();
											}
											//ICR 18052015
											tieneSalidaW=true;											
											if (log.isDebugEnabled()) log.debug("tieneSalidaW:"+tieneSalidaW);
											if (log.isDebugEnabled()) log.debug("j:"+j);
											if (log.isDebugEnabled()) log.debug("i:"+i);
										}
										else{//tieneSalidaW==true
											if (tieneEntradaX==false){											
												if (log.isDebugEnabled()) log.debug("entro 3.0");
												tMov2 = preCalificarEntradaOpe2(
														fechaMarcacion2,
														horaMarcacion2,
														turnoDx.getHoraIni(),
														turnoDx.getTolera(),
														turnoDx.getHoraLimite(),
														Constantes.MINUTO);
												if (log.isDebugEnabled()) log.debug("salida66 preCalificarEntradaOpe2(tMov2):"+tMov2);
												tieneEntradaX=true;												
												horaFinMov2 = "";
												if (tMov2.equals(Constantes.MOV_ENTRADA_ANTICIPADA)) {
													tMov2 = Constantes.ENTRADA_NORMAL;
													if (log.isDebugEnabled()) log.debug("tMov4:"+tMov2);
												}									
												if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO)) {
													tMov2 = Constantes.MOV_TARDANZA_EFECTIVA;
													if (log.isDebugEnabled()) log.debug("tMov5:"+tMov2);
												}
												//hsal cuando es tardanza 01 se coloca valor
												if (tMov2.equals(Constantes.MOV_TARDANZA_EFECTIVA)) {
													horaFinMov2=turnoDx.getHoraIni();
												}
												//fin hsal												
											}else{
												tMov2 = Constantes.MOV_OMISION_MARCA;
												if (log.isDebugEnabled()) log.debug("tMov5-FORMATIVAS:"+tMov2);
											}
										}
									}									
								}
								if (tMov2.equals(Constantes.MOV_ENTRADA_ANTICIPADA)) {
									tMov2 = Constantes.ENTRADA_NORMAL;
									if (log.isDebugEnabled()) log.debug("tMov4-FORMATIVAS:"+tMov2);
								}	
								if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO)) {
									tMov2 = Constantes.MOV_TARDANZA_EFECTIVA;
									if (log.isDebugEnabled()) log.debug("tMov5-FORMATIVAS:"+tMov2);
								}								
								//fin llego aca																	
								
								try{
									if (horaFinMov2!=null && horaFinMov2!="") {
										if (log.isDebugEnabled()) log.debug("horaFinMov2!=null y horaFinMov2!=vacio");
										if (log.isDebugEnabled()) log.debug("codPers:"+codPers+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"/fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2);
										log.debug("borrando6 asistencia CAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
										t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
									}
									Map params1 = new HashMap();
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);
									params1.put("cod_uorgan", codUO);
									params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
									params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									params1.put("mov", tMov2);
									params1.put("relojIni", relojIni2);
									params1.put("relojFin", relojFin2);
									params1.put("usuario", usuario);	
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI (SES");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else {	
										log.debug("isProcesar NO (SES)");
										boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
										if (inserto){
											log.debug("SI inserto1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO inserto1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0		
								}
								catch(Exception e){
									if (log.isDebugEnabled()) log.debug("catch6- generarAsistenciaTrabajadorModFormativa");										
									Map params1 = new HashMap();
									params1.put("mov", tMov2);
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("usuario", usuario);
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);							
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", horaMarcacion2);
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);	
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else{
										log.debug("isProcesar NO");
									//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
										boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
										if (actualizo){
											log.debug("SI actualizo1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO actualizo1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0										
								}
							}//fin for ok	
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral - new
							if (autoriClima!=null && !autoriClima.isEmpty()){
								estadoAut=autoriClima.get("ind_aut").toString().trim();
								cod_auto = autoriClima.get("cod_aut").toString().trim();
								if ((excesoClima==true || refriClima==true) && estadoAut.equals("0")){
									log.debug("actualizara estado autorizacion (codPers: "+codPers+" fechaEval: "+fechaEval+" )");
									prms.put("ind_aut", Constantes.ACTIVO);					
									prms.put("cod_user_mod", "BATCH-CLIMA-LAB");
									prms.put("cod_pers", codPers);
									prms.put("fec_aut", autoriClima.get("fec_aut_desc").toString());					
									climaLabDAO.updateRegistroAutorizaCli(prms);
									
									//envio correo
									nomApell = (autoriClima.get("t02ap_pate")!=null?autoriClima.get("t02ap_pate").toString().trim():"")+" "+(autoriClima.get("t02ap_mate")!=null?autoriClima.get("t02ap_mate").toString().trim():"")+" "+(autoriClima.get("t02nombres")!=null?autoriClima.get("t02nombres").toString().trim():"");
									mParams.put("registro",codPers);
									if (log.isDebugEnabled()) log.debug("mParamss: " + mParams);
									
									mensajeF = "El sistema ha procedido a calificar sus marcaciones de Clima Laboral para la fecha "+(String)autoriClima.get("fec_aut_desc")+".";	
									if (log.isDebugEnabled()) log.debug("mensajeFF: " + mensajeF);	
									mensaje = textoCorreoClimaLaboral(mParams,nomApell,mensajeF);//mensaje en html
									if (log.isDebugEnabled()) log.debug("mensajee: " + mensaje);																			
									Correo objCorreo = new Correo(mensaje.toString());									
									objCorreo.setServidor(propiedadesCorreo.leePropiedad("servidor"));									
									objCorreo.setRemitente(propiedadesCorreo.leePropiedad("correoRemitenteMovimientos"),propiedadesCorreo.leePropiedad("nombreRemitenteMovimientos"));
															
									correoColab=correoDAO.findCorreoByRegistro(codPers);
									correoAutoriz=correoDAO.findCorreoByRegistro(cod_auto);
														
									// VALIDANDO SI TRABAJADOR TIENE CORREO																
									if (!correoColab.equals("")) {						
										if (log.isDebugEnabled()) log.debug("correoColab Trabajador= " + correoColab);
										try{
											//trabajador tiene correo correcto, se debe enviar correo a trabajador con copia a autorizador								
											objCorreo.agregarDestinatario(correoColab.trim());
											if(!correoAutoriz.equals("")){
												objCorreo.agregarConCopia(correoAutoriz.trim());
											}
											//objCorreo.agregarConCopia("jquispecoi@sunat.gob.pe");/////ELIMINAR
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral");
											objCorreo.enviarHtml();		
											if (log.isDebugEnabled()) log.debug("Se envio correo a trabajador");	
																		
										} catch (CorreoException ce) {
											//trabajador tiene correo erroneo, hay destinatario erroneo 
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - CORREO ERR흁EO");
											objCorreo.enviarHtml();
									 		if (log.isDebugEnabled()) log.debug("Error en CorreoExceptionn: "+ce.toString());									 	
										 	if (log.isDebugEnabled()) log.debug("SI tiene correo trabajador: "+codPers+" - pero correo es erroneo");									 										 	
										}											
									}//fin if tiene correo
									else {
										//trabajador no tiene correo, no hay destinatario y se debe copiar a rrhh correo
										objCorreo.agregarConCopia(propiedadesCorreo.leePropiedad("correoReceptorAlertaCambioTurnos"));
										objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - NO TIENE CORREO");
										objCorreo.enviarHtml();							
										if (log.isDebugEnabled()) log.debug("NO tiene correo trabajador: " + codPers+" - se envio a rrhh");
									}
									//fin envio correo
								}
							}							
							//ICAPUNAY - PAS20175E230300069
						}
						//FIN NUEVO					
					}else{
						if (log.isDebugEnabled()) log.debug("registro("+codPers+"): NO turno (dia x-1) de 2 dias y SI turno dia x de 2 d涌 (marcaciones IMPARES requiere para dia x)");
						tieneRefrigerio = false;
						//preCalificarEntradaOpe2 //preCalificarMovimientoOpe2 //solo E
						//impar requiere (AJUSTAR PARA SI HORA LIMITE ES PASADA LAS 00:00 NO COLOQUE INASISTENCIA CUANDO INGRESA A LAS 16:30 08/09/2014 par es omision)
						
						listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
						if (log.isDebugEnabled()) log.debug("listaMarcaciones:"+listaMarcaciones);
						if (listaMarcaciones != null && listaMarcaciones.size() > 0) {
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral													
							autoriClima=climaLabDAO.findAutorizaByRegByFecha(codPers, fechaEval);
							log.debug("autoriClima: "+autoriClima);							
							if (autoriClima!=null && !autoriClima.isEmpty()){
								procesaClima=true;
							}
							//ICAPUNAY - PAS20175E230300069
							
							for (int i = 0; i < listaMarcaciones.size(); i++) {	
								bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
								fechaMarcacion2 = bMarcacion2.getFecha();
								horaMarcacion2 = bMarcacion2.getHora();
								relojIni2 = bMarcacion2.getReloj();
								relojFin2 = "";
								if (log.isDebugEnabled()) log.debug("i:"+i);
								if (log.isDebugEnabled()) log.debug("bMarcacion2("+i+"):"+bMarcacion2);
								if (log.isDebugEnabled()) log.debug("fechaMarcacion2("+i+"):"+fechaMarcacion2);
								if (log.isDebugEnabled()) log.debug("horaMarcacion2("+i+"):"+horaMarcacion2);
								if (i == 0){//primera marcacion es ENTRADA
									if (log.isDebugEnabled()) log.debug("primera marca");
									fechaFinMov2 = bMarcacion2.getFecha();
									horaFinMov2 = "";
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 ent:"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 ent:"+horaFinMov2);									
									tMov2 = preCalificarEntradaOpe2(
											fechaMarcacion2,
											horaMarcacion2,
											turnoDx.getHoraIni(),
											turnoDx.getTolera(),
											turnoDx.getHoraLimite(),
											Constantes.MINUTO);
									if (log.isDebugEnabled()) log.debug("salida6.1 preCalificarEntradaOpe2(tMov2):"+tMov2);	
									if (tMov2.equals(Constantes.MOV_ENTRADA_ANTICIPADA)) {
										tMov2 = Constantes.ENTRADA_NORMAL;
										if (log.isDebugEnabled()) log.debug("tMov4:"+tMov2);
									}									
									if (tMov2.equals(Constantes.MOV_TARDANZA_CON_DESCUENTO) || tMov2.equals(Constantes.MOV_TARDANZA_SIN_DESCUENTO)) {
										tMov2 = Constantes.MOV_TARDANZA_EFECTIVA;
										if (log.isDebugEnabled()) log.debug("tMov5:"+tMov2);
									}
									//hsal cuando es tardanza 01 se coloca valor
									if (tMov2.equals(Constantes.MOV_TARDANZA_EFECTIVA)) {
										horaFinMov2=turnoDx.getHoraIni();
									}
									//fin hsal
								}
								//movimientos intermedios
								else{
									if (log.isDebugEnabled()) log.debug("marcaciones6 en pareja desde inicio(i):"+i);					
									if (log.isDebugEnabled()) log.debug("listaMarcaciones.size():"+listaMarcaciones.size());							
									if (i <= (listaMarcaciones.size() - 2)) {
										if (log.isDebugEnabled()) log.debug("i:"+i);
										bMSgte2 = (BeanMarcacion) listaMarcaciones.get(++i);							
										fechaFinMov2 = bMSgte2.getFecha();
										horaFinMov2 = bMSgte2.getHora();
										relojFin2 = bMSgte2.getReloj();
										if (log.isDebugEnabled()) log.debug("bMSgte2 int:"+bMSgte2);
										if (log.isDebugEnabled()) log.debug("fechaFinMov2 int :"+fechaFinMov2);
										if (log.isDebugEnabled()) log.debug("horaFinMov2 int:"+horaFinMov2);
										if (log.isDebugEnabled()) log.debug("relojFin2 int:"+relojFin2);
										if (log.isDebugEnabled()) log.debug("i2:"+i);																													
										//tMov2 = preCalificarMovimientoOpe2(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDx,	Constantes.MINUTO, tieneRefrigerio,	bOperativo2); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										tMov2 = preCalificarMovimientoOpe2(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDx,Constantes.MINUTO, tieneRefrigerio,bOperativo2,procesaClima,minMaxClima); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										if (log.isDebugEnabled()) log.debug("salida6 preCalificarMovimientoOpe2(tMov2):"+tMov2);	

										//if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
										if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO) || tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)) { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
											if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
											
											// ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
											Map calificacionActual=null;
											calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "2", "3","5"); //0=calificacion inicial, 2=papeleta aprobada, 3= papeleta procesada, //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral (adicion 5=calificacion por rrhh)
											if (log.isDebugEnabled()) log.debug("calificacionActuall : "+calificacionActual);												
											if (calificacionActual!=null){
												if (log.isDebugEnabled()) log.debug("entrooooo");
												movAct= calificacionActual.get("mov").toString().trim();//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
												//if (tMov2.trim().equals(calificacionActual.get("mov").toString().trim())){ ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
												if (movAct.equals(Constantes.MOV_EXCESO_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRIGERIO) || movAct.equals(Constantes.MOV_REFRI_CLIMALABORAL) ){ //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (log.isDebugEnabled()) log.debug("movAct igual a refri, exceso o refri clima");
													if (log.isDebugEnabled()) log.debug("tMov2 : "+tMov2);
													if (log.isDebugEnabled()) log.debug("calificacionActual : "+calificacionActual);
													
													if (log.isDebugEnabled()) log.debug("tieneRefrigerio : "+tieneRefrigerio);
													if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
													tieneRefrigerio = true;
													if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2:"+fechaMarcacion2 + " " + horaMarcacion2);
													if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2:"+fechaMarcacion2 + " " + horaFinMov2);
													float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
													if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
													
													//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (procesaClima){
														float quedan = minMaxClima - durante1;	
														if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
														if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
														minMaxClima= new Float(quedan).intValue();
														//new
														if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
															excesoClima=true;
														}
														if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
															refriClima=true;
														}
														//new
													}else{
													//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
														float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
														log.debug("turnoDx.getMinutosRefrigerio(): " + turnoDx.getMinutosRefrigerio());
														if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
														turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());
													}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													
												}else{
													tieneRefrigerio = false;
													if (log.isDebugEnabled()) log.debug("tieneRefrigerio: "+tieneRefrigerio);
												}
													
											}
											//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas
											else{													
												calificacionActual = asisDAO.findByCodPersFechaHingHsal(codPers, fechaMarcacion2, horaMarcacion2, horaFinMov2, "0", "0", "0","0"); //0=calificacion inicial
												if (log.isDebugEnabled()) log.debug("calificacionActual2 : "+calificacionActual);
												if (calificacionActual==null){
													tieneRefrigerio = true;
													float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
													if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
													
													//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
													if (procesaClima){
														float quedan = minMaxClima - durante1;	
														if (log.isDebugEnabled()) log.debug("minMaxClima: "+minMaxClima);
														if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
														minMaxClima= new Float(quedan).intValue();
														//new
														if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)){
															excesoClima=true;
														}
														if (tMov2.trim().equals(Constantes.MOV_REFRI_CLIMALABORAL)){
															refriClima=true;
														}
														//new
													}else{
													//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral	
														float quedan = turnoDx.getMinutosRefrigerio() - durante1;														
														log.debug("turnoDx.getMinutosRefrigerio(): " + turnoDx.getMinutosRefrigerio());
														if (log.isDebugEnabled()) log.debug("quedan: "+quedan);
														turnoDx.setMinutosRefrigerio( new Float(quedan).intValue());
													}//add linea ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral														
												}													
											}
											//ultimo agregado debe recalificar refrigerio y exceso de haber papeletas aprobadas											
											//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
										}																						
									}else{//marcacion par
										if (log.isDebugEnabled()) log.debug("marcacion par FORMATIVAS(i):"+i);
										fechaFinMov2 = bMarcacion2.getFecha();
										horaFinMov2 = "";																				
										tMov2 = Constantes.MOV_OMISION_MARCA;
										//tMov2 = Constantes.MOV_SALIDA_AUTORIZADA;
										if (log.isDebugEnabled()) log.debug("tMov12-FORMATIVAS:"+tMov2);										
									}																	
								}
								//fin mov intermedios

								try{
									if (horaFinMov2!=null && horaFinMov2!="") {
										log.debug("borrando6 asistencia FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
										t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
									}
									Map params1 = new HashMap();
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);
									params1.put("cod_uorgan", codUO);
									params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
									params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									params1.put("mov", tMov2);
									params1.put("relojIni", relojIni2);
									params1.put("relojFin", relojFin2);
									params1.put("usuario", usuario);	
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI (SES");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else {	
										log.debug("isProcesar NO (SES)");
										boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
										if (inserto){
											log.debug("SI inserto1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO inserto1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0							
								}
								catch(Exception e){
									if (log.isDebugEnabled()) log.debug("catch6- generarAsistenciaTrabajadorModFormativa");										
									Map params1 = new HashMap();
									params1.put("mov", tMov2);
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("usuario", usuario);
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);							
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", horaMarcacion2);
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);	
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else{
										log.debug("isProcesar NO");
									//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
										boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
										if (actualizo){
											log.debug("SI actualizo1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO actualizo1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									
								}
							}//fin for ok
							
							//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral - new
							if (autoriClima!=null && !autoriClima.isEmpty()){
								estadoAut=autoriClima.get("ind_aut").toString().trim();
								cod_auto = autoriClima.get("cod_aut").toString().trim();
								if ((excesoClima==true || refriClima==true) && estadoAut.equals("0")){
									log.debug("actualizara estado autorizacion (codPers: "+codPers+" fechaEval: "+fechaEval+" )");
									prms.put("ind_aut", Constantes.ACTIVO);					
									prms.put("cod_user_mod", "BATCH-CLIMA-LAB");
									prms.put("cod_pers", codPers);
									prms.put("fec_aut", autoriClima.get("fec_aut_desc").toString());					
									climaLabDAO.updateRegistroAutorizaCli(prms);
									
									//envio correo
									nomApell = (autoriClima.get("t02ap_pate")!=null?autoriClima.get("t02ap_pate").toString().trim():"")+" "+(autoriClima.get("t02ap_mate")!=null?autoriClima.get("t02ap_mate").toString().trim():"")+" "+(autoriClima.get("t02nombres")!=null?autoriClima.get("t02nombres").toString().trim():"");
									mParams.put("registro",codPers);
									if (log.isDebugEnabled()) log.debug("mParamss: " + mParams);
									
									mensajeF = "El sistema ha procedido a calificar sus marcaciones de Clima Laboral para la fecha "+(String)autoriClima.get("fec_aut_desc")+".";	
									if (log.isDebugEnabled()) log.debug("mensajeFF: " + mensajeF);	
									mensaje = textoCorreoClimaLaboral(mParams,nomApell,mensajeF);//mensaje en html
									if (log.isDebugEnabled()) log.debug("mensajee: " + mensaje);																			
									Correo objCorreo = new Correo(mensaje.toString());									
									objCorreo.setServidor(propiedadesCorreo.leePropiedad("servidor"));									
									objCorreo.setRemitente(propiedadesCorreo.leePropiedad("correoRemitenteMovimientos"),propiedadesCorreo.leePropiedad("nombreRemitenteMovimientos"));
															
									correoColab=correoDAO.findCorreoByRegistro(codPers);
									correoAutoriz=correoDAO.findCorreoByRegistro(cod_auto);
														
									// VALIDANDO SI TRABAJADOR TIENE CORREO																
									if (!correoColab.equals("")) {						
										if (log.isDebugEnabled()) log.debug("correoColab Trabajador= " + correoColab);
										try{
											//trabajador tiene correo correcto, se debe enviar correo a trabajador con copia a autorizador								
											objCorreo.agregarDestinatario(correoColab.trim());
											if(!correoAutoriz.equals("")){
												objCorreo.agregarConCopia(correoAutoriz.trim());
											}
											//objCorreo.agregarConCopia("jquispecoi@sunat.gob.pe");/////ELIMINAR
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral");
											objCorreo.enviarHtml();		
											if (log.isDebugEnabled()) log.debug("Se envio correo a trabajador");	
																		
										} catch (CorreoException ce) {
											//trabajador tiene correo erroneo, hay destinatario erroneo 
											objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - CORREO ERR흁EO");
											objCorreo.enviarHtml();
									 		if (log.isDebugEnabled()) log.debug("Error en CorreoExceptionn: "+ce.toString());									 	
										 	if (log.isDebugEnabled()) log.debug("SI tiene correo trabajador: "+codPers+" - pero correo es erroneo");									 										 	
										}											
									}//fin if tiene correo
									else {
										//trabajador no tiene correo, no hay destinatario y se debe copiar a rrhh correo
										objCorreo.agregarConCopia(propiedadesCorreo.leePropiedad("correoReceptorAlertaCambioTurnos"));
										objCorreo.setAsunto("Justificaci蚤 de Salida por Actividad de Clima Laboral - NO TIENE CORREO");
										objCorreo.enviarHtml();							
										if (log.isDebugEnabled()) log.debug("NO tiene correo trabajador: " + codPers+" - se envio a rrhh");
									}
									//fin envio correo
								}
							}							
							//ICAPUNAY - PAS20175E230300069
						}						
					}
				}				
			}//fin turnoDx!=null
			else{
				if (log.isDebugEnabled()) log.debug("NO tiene turno dia x");
				fechaAntes = Utiles.dameFechaAnterior(fechaEval, 1);	    		   
				BeanTurnoTrabajo turnoDw = daoTurno.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,codPers,fechaAntes); //dia (x-1)
				if (log.isDebugEnabled()) log.debug("turno3 dia x-1 (turnoDw)("+codPers+"): " + turnoDw);
				if (turnoDw!=null){	
					if (log.isDebugEnabled()) log.debug("registro("+codPers+"): SI turno (dia x-1) de 2 dias y NO turno dia x (marcaciones IMPARES requiere para dia x)");
					horaIniTurnoDw = turnoDw.getHoraIni().trim();
					horaFinTurnoDw = turnoDw.getHoraFin().trim();
					bOperativo2 = turnoDw.isOperativo();
					tieneRefrigerio = false;
					if (log.isDebugEnabled()) log.debug("horaIniTurnoDw3("+codPers+"): " + horaIniTurnoDw);
					if (log.isDebugEnabled()) log.debug("horaFinTurnoDw3("+codPers+"): "+ horaFinTurnoDw);
					
					//preCalificarSalidaOpe1 //preCalificarMovimientoOpe1 //solo S
					
					//impar requiere (13/09/2014 par es omision)
					//coloque refrigerio de 03 a 05 al turno C06 y debe tomar 60 min (pruebas)
					//hora limite 00:30 y tolerancia 10 min al turno C06 (hora inicio turno 22:30 para el 12/09/2014)
					listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
					if (log.isDebugEnabled()) log.debug("listaMarcaciones:"+listaMarcaciones);
					if (listaMarcaciones != null && listaMarcaciones.size() > 0) {	
						for (int i = 0; i < listaMarcaciones.size(); i++) {	
							bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
							fechaMarcacion2 = bMarcacion2.getFecha();
							horaMarcacion2 = bMarcacion2.getHora();
							relojIni2 = bMarcacion2.getReloj();
							relojFin2 = "";
							if (log.isDebugEnabled()) log.debug("i:"+i);
							if (log.isDebugEnabled()) log.debug("bMarcacion2("+i+"):"+bMarcacion2);
							if (log.isDebugEnabled()) log.debug("fechaMarcacion2("+i+"):"+fechaMarcacion2);
							if (log.isDebugEnabled()) log.debug("horaMarcacion2("+i+"):"+horaMarcacion2);
							if (i == (listaMarcaciones.size() - 1)){//ultima marcacion es SALIDA
								if (log.isDebugEnabled()) log.debug("ultima marca");
								fechaFinMov2 = bMarcacion2.getFecha();
								horaFinMov2 = "";
								if (log.isDebugEnabled()) log.debug("fechaFinMov2 sal:"+fechaFinMov2);
								if (log.isDebugEnabled()) log.debug("horaFinMov2 sal:"+horaFinMov2);									
								tMov2 = preCalificarSalidaOpe1(
										dbpool,
										codPers,
										fechaMarcacion2,
										horaMarcacion2,
										turnoDw.getHoraFin(),
										Constantes.MINUTO);
								if (log.isDebugEnabled()) log.debug("salida2 preCalificarSalidaOpe1(tMov2):"+tMov2);	
								//ICR 18052015
								if (tMov2.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
									horaFinMov2=turnoDw.getHoraFin();
								}
								//ICR 18052015
							}
							//movimientos intermedios
							else{
								if (log.isDebugEnabled()) log.debug("marcaciones en pareja desde inicio(i):"+i);					
								if (log.isDebugEnabled()) log.debug("listaMarcaciones.size():"+listaMarcaciones.size());							
								if (i < (listaMarcaciones.size() - 2)) {
									if (log.isDebugEnabled()) log.debug("i:"+i);
									bMSgte2 = (BeanMarcacion) listaMarcaciones.get(++i);							
									fechaFinMov2 = bMSgte2.getFecha();
									horaFinMov2 = bMSgte2.getHora();
									relojFin2 = bMSgte2.getReloj();
									if (log.isDebugEnabled()) log.debug("bMSgte2 int:"+bMSgte2);
									if (log.isDebugEnabled()) log.debug("fechaFinMov2 int :"+fechaFinMov2);
									if (log.isDebugEnabled()) log.debug("horaFinMov2 int:"+horaFinMov2);
									if (log.isDebugEnabled()) log.debug("relojFin2 int:"+relojFin2);
									if (log.isDebugEnabled()) log.debug("i2:"+i);																													
									tMov2 = preCalificarMovimientoOpe1(fechaMarcacion2, horaMarcacion2, horaFinMov2, turnoDw,	Constantes.MINUTO, tieneRefrigerio,	bOperativo2);
									if (log.isDebugEnabled()) log.debug("salida preCalificarMovimientoOpe1(tMov2):"+tMov2);	

									/*if (tMov2.trim().equals(Constantes.MOV_EXCESO_REFRIGERIO)|| tMov2.trim().equals(Constantes.MOV_REFRIGERIO)) {
										if (log.isDebugEnabled()) log.debug("exceso o refrigerio");
										tieneRefrigerio = true;
										if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaMarcacion2:"+fechaMarcacion2 + " " + horaMarcacion2);
										if (log.isDebugEnabled()) log.debug("fechaMarcacion2-horaFinMov2:"+fechaMarcacion2 + " " + horaFinMov2);
										float durante1 = Utiles.calculaAcumulado(Constantes.MINUTO, Utiles.stringToTimestamp(fechaMarcacion2 + " " + horaMarcacion2), Utiles.stringToTimestamp(fechaMarcacion2 + " "+ horaFinMov2));
										float quedan = turnoDw.getMinutosRefrigerio() - durante1;
										if (log.isDebugEnabled()) log.debug("durante1:"+durante1);
										if (log.isDebugEnabled()) log.debug("quedan:"+quedan);
										turnoDw.setMinutosRefrigerio( new Float(quedan).intValue());
										log.debug("turnoDw(setMinutosRefrigerio o quedan) : " + quedan);
									}*/																						
								}else{//marcacion par
									if (log.isDebugEnabled()) log.debug("marcacion par(i):"+i);
									fechaFinMov2 = bMarcacion2.getFecha();
									horaFinMov2 = "";																				
									//tMov2 = Constantes.MOV_OMISION_MARCA;
									/*EBV 27/03/2015 CAMBIO DE LINEAMIENTO
									tMov2 = Constantes.MOV_SALIDA_AUTORIZADA;
									 */
                                    tMov2 = Constantes.MOV_SALIDA_NO_AUTORIZADA;

									if (log.isDebugEnabled()) log.debug("tMov12:"+tMov2);										
								}																	
							}
							//fin mov intermedios

							try{
								if (horaFinMov2!=null && horaFinMov2!="") {
									log.debug("borrando5 asistencia FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
									t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
								}
								Map params1 = new HashMap();
								params1.put("cod_pers", codPers);
								params1.put("periodo", periodo);
								params1.put("cod_uorgan", codUO);
								params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
								params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
								params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
								params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
								params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
								params1.put("mov", tMov2);
								params1.put("relojIni", relojIni2);
								params1.put("relojFin", relojFin2);
								params1.put("usuario", usuario);
								
								//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
								if (isProcesar.equals("SI")){
									log.debug("isProcesar SI (SES");
									if (papeletasGeneradas==null){
										papeletasGeneradas = new ArrayList();											
									}
										
									params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
									List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																		
									if(lstPapeletaGenerada.size()>0){
										HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
										hmPapeletaGenerada.put("mov",tMov2);
										hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
										papeletasGeneradas.add(hmPapeletaGenerada);
										log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
									}									
								}else {	
									log.debug("isProcesar NO (SES)");
									boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
									if (inserto){
										log.debug("SI inserto1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}else{										
										log.debug("NO inserto1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}	
								}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0		
							}
							catch(Exception e){
								if (log.isDebugEnabled()) log.debug("catch2- generarAsistenciaTrabajadorModFormativa");										
								Map params1 = new HashMap();
								params1.put("mov", tMov2);
								params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
								params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
								params1.put("usuario", usuario);
								params1.put("cod_pers", codPers);
								params1.put("periodo", periodo);							
								params1.put("fechaMarcacion", fechaMarcacion2);
								params1.put("horaMarcacion", horaMarcacion2);
								params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);	
								
								//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
								if (isProcesar.equals("SI")){
									log.debug("isProcesar SI");
									if (papeletasGeneradas==null){
										papeletasGeneradas = new ArrayList();											
									}
										
									params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
									List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																		
									if(lstPapeletaGenerada.size()>0){
										HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
										hmPapeletaGenerada.put("mov",tMov2);
										hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
										papeletasGeneradas.add(hmPapeletaGenerada);
										log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
									}									
								}else{
									log.debug("isProcesar NO");
								//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
									if (actualizo){
										log.debug("SI actualizo1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}else{										
										log.debug("NO actualizo1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}	
								}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0									
							}
						}//fin for ok						
					}					
				}else{
					if (log.isDebugEnabled()) log.debug("registro("+codPers+"): NO turno (dia x-1) de 2 dias y NO turno dia x");
					BeanTurnoTrabajo turnoNoControlado = null;
					BeanTurnoTrabajo turnoNoControl1 = daoTurno.joinWithT45ByCodPersFecha_NoControlado_OperAdm1dia(dbpool,codPers,fechaEval);
					if (turnoNoControl1!=null){
						turnoNoControlado=turnoNoControl1;					    
					}else{
						BeanTurnoTrabajo turnoNoControl2 = daoTurno.joinWithT45ByCodPersFecha_NoControlado_Oper2dias(dbpool,codPers,fechaEval);
						turnoNoControlado=turnoNoControl2;				    
					}
					if (log.isDebugEnabled()) log.debug("turnoNoControlado("+fechaEval+"): " + "("+codPers+"): "+turnoNoControlado);
					
					if (turnoNoControlado!=null){//tiene turno no controlado de 1 o 2 dias (adm u ope)
						//no control 2 dias (ope: 43, 002 {lo puede trabajar como turno no controlado operativo de 1 dia})
													
						listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
						if (log.isDebugEnabled()) log.debug("listaMarcaciones:"+listaMarcaciones);
						if (listaMarcaciones != null && listaMarcaciones.size() > 0) {
							for (int i = 0; i < listaMarcaciones.size(); i++) {	
								bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
								fechaMarcacion2 = bMarcacion2.getFecha();
								horaMarcacion2 = bMarcacion2.getHora();
								relojIni2 = bMarcacion2.getReloj();
								relojFin2 = "";									
								if ((i==0) || i == (listaMarcaciones.size() - 1)){
									if (log.isDebugEnabled()) log.debug("marcaciones primera o ultima");
									fechaFinMov2 = bMarcacion2.getFecha();
									horaFinMov2 = "";										
								}else{//movs intermedios
									if (log.isDebugEnabled()) log.debug("marcaciones en pareja");
									if (i < (listaMarcaciones.size() - 2)) {
										if (log.isDebugEnabled()) log.debug("i:"+i);
										bMSgte2 = (BeanMarcacion) listaMarcaciones.get(++i);							
										fechaFinMov2 = bMSgte2.getFecha();
										horaFinMov2 = bMSgte2.getHora();
										relojFin2 = bMSgte2.getReloj();											
									}else{//marcacion impar
										if (log.isDebugEnabled()) log.debug("marcacion impar");
										fechaFinMov2 = bMarcacion2.getFecha();
										horaFinMov2 = "";																			
									}
								}
								if ((Constantes.TURNO_RS067).equals(turnoNoControlado.getTurno().trim())){
									tMov2 = Constantes.MOV_RESOLUCION_067;										
								}else{//otros turnos no control 1 dia
									tMov2 = Constantes.MOV_TRABAJO_CAMPO;
								}
								if (log.isDebugEnabled()) log.debug("tMov2:"+tMov2);

								try{
									if (horaFinMov2!=null && horaFinMov2!="") {
										log.debug("borrando2 asistencia FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
										t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
									}
									Map params1 = new HashMap();
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);
									params1.put("cod_uorgan", codUO);
									params1.put("fechaMarcacion", (fechaMarcacion2!=null)?fechaMarcacion2.trim():"");
									params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									params1.put("mov", tMov2);
									params1.put("relojIni", relojIni2);
									params1.put("relojFin", relojFin2);
									params1.put("usuario", usuario);	
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI (SES");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else {	
										log.debug("isProcesar NO (SES)");
										boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
										if (inserto){
											log.debug("SI inserto1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO inserto1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0		
								}
								catch(Exception e){
									if (log.isDebugEnabled()) log.debug("catch2- generarAsistenciaTrabajadorModFormativa");										
									Map params1 = new HashMap();
									params1.put("mov", tMov2);
									params1.put("fechaFinMov", (fechaFinMov2!=null && fechaFinMov2!="")?fechaFinMov2.trim():fechaMarcacion2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("usuario", usuario);
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);							
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", horaMarcacion2);
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);	
									
									//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
									if (isProcesar.equals("SI")){
										log.debug("isProcesar SI");
										if (papeletasGeneradas==null){
											papeletasGeneradas = new ArrayList();											
										}
											
										params1.put("calificacion", Constantes.PAPELETA_REGISTRADA);
										List lstPapeletaGenerada = asisDAO.findRegistroAsistencia(params1);
																			
										if(lstPapeletaGenerada.size()>0){
											HashMap hmPapeletaGenerada = (HashMap)lstPapeletaGenerada.get(0);
											hmPapeletaGenerada.put("mov",tMov2);
											hmPapeletaGenerada.put("estado_id",Constantes.PRE_CALIFICACION_ASIS);
											papeletasGeneradas.add(hmPapeletaGenerada);
											log.debug("hmPapeletaGenerada:"+hmPapeletaGenerada);
										}									
									}else{
										log.debug("isProcesar NO");
									//FIN PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
										boolean actualizo = asisDAO.updateRegistroAsistencia(params1);
										if (actualizo){
											log.debug("SI actualizo1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}else{										
											log.debug("NO actualizo1 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
										}	
									}//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0									
								}									
							}								
						}						
												
					}else{
						//no tiene ningun turno (APORTACION)
						if (log.isDebugEnabled()) log.debug("Ningun turno-No debe calificar");
						/* //No debe calificar nada
						listaMarcaciones = daoMarcacion.findByCodPersFecha(dbpool, codPers, fechaEval);
						if (log.isDebugEnabled()) log.debug("listaMarcaciones:"+listaMarcaciones);
						if (listaMarcaciones != null && listaMarcaciones.size() > 0) {
							for (int i = 0; i < listaMarcaciones.size(); i++) {	
								bMarcacion2 = (BeanMarcacion) listaMarcaciones.get(i);
								fechaMarcacion2 = bMarcacion2.getFecha();
								horaMarcacion2 = bMarcacion2.getHora();
								relojIni2 = bMarcacion2.getReloj();
								relojFin2 = "";									
								if ((i==0) || i == (listaMarcaciones.size() - 1)){
									if (log.isDebugEnabled()) log.debug("marcaciones primera o ultima");
									fechaFinMov2 = bMarcacion2.getFecha();
									horaFinMov2 = "";												
								}else{//movs intermedios
									if (log.isDebugEnabled()) log.debug("marcaciones en pareja");
									if (i < (listaMarcaciones.size() - 2)) {
										if (log.isDebugEnabled()) log.debug("i:"+i);
										bMSgte2 = (BeanMarcacion) listaMarcaciones.get(++i);							
										fechaFinMov2 = bMSgte2.getFecha();
										horaFinMov2 = bMSgte2.getHora();
										relojFin2 = bMSgte2.getReloj();																											
									}else{//marcacion impar
										if (log.isDebugEnabled()) log.debug("marcacion impar");
										fechaFinMov2 = bMarcacion2.getFecha();
										horaFinMov2 = "";																		
									}										
								}
								if (turnoNoControlado==null){
									tMov2 = Constantes.MOV_APORTACION;										
								}							
								try{
									if (horaFinMov2!=null && horaFinMov2!="") {
										log.debug("borrando3 asistencia FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaFinMov2:"+horaFinMov2);
										t1271dao.deleteAsistencia(codPers,periodo,fechaMarcacion2,horaFinMov2);
									}
									Map params1 = new HashMap();
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);
									params1.put("cod_uorgan", codUO);
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", (horaMarcacion2 != null)?horaMarcacion2.trim():"");
									params1.put("fechaFinMov", fechaFinMov2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);
									params1.put("mov", tMov2);
									params1.put("relojIni", relojIni2);
									params1.put("relojFin", relojFin2);
									params1.put("usuario", usuario);										
									boolean inserto = asisDAO.insertRegistroAsistencia(params1);									
									if (inserto){
										log.debug("SI inserto3 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}else{										
										log.debug("NO inserto3 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}			
								}
								catch(Exception e){
									if (log.isDebugEnabled()) log.debug("catch3- generarAsistenciaTrabajadorModFormativa");										
									Map params1 = new HashMap();
									params1.put("mov", tMov2);
									params1.put("fechaFinMov", fechaFinMov2);
									params1.put("horaFinMov", (horaFinMov2!=null)?horaFinMov2.trim():"");
									params1.put("usuario", usuario);
									params1.put("cod_pers", codPers);
									params1.put("periodo", periodo);							
									params1.put("fechaMarcacion", fechaMarcacion2);
									params1.put("horaMarcacion", horaMarcacion2);
									params1.put("calificacion", Constantes.PRE_CALIFICACION_ASIS);									
									boolean actualizo = asisDAO.updateRegistroAsistencia(params1);										
									if (actualizo){
										log.debug("SI actualizo3 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}else{										
										log.debug("NO actualizo3 FORMATIVAS en T1271DAO: "+codPers+"-"+periodo+"-fechaMarcacion2:"+fechaMarcacion2+"-horaMarcacion2:"+horaMarcacion2+"-fechaFinMov2:"+fechaFinMov2+"-horaFinMov2:"+horaFinMov2+"-movimiento: "+tMov2);
									}										
								}							
							}								
						}*/
						//No debe calificar nada
					}					
				}
			}
			//FIN ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)			
			
	    }//fin generar true
	    
	    if (log.isDebugEnabled()) log.debug("fin de metodo ProcesoFacade - generarAsistenciaTrabajadorModFormativa");//LOG GENERACION	
	}catch (Exception e){
		log.fatal("Error en el registro FORMATIVAS de asistencias del trabajador "+codPers+" : "+ e.getMessage(),e);
		throw new IncompleteConversationalState(e.toString());
	}
}
	
	
	/**
	 * Metodo que se encarga de ejecutar el proceso de asistencia para 
	 * Modalidades Formativas
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="Required"
	 * @param mapaPrin
	 * @return
	 * @throws RemoteException
	 */
	public boolean procesarAsistenciaTrabModFormativa(Map mapaPrin) 
		throws RemoteException {
		
		if (log.isDebugEnabled()) log.debug("Utilizando metodo procesarAsistenciaTrabModFormativa");
		
		String dbpool = mapaPrin.get("dbpool").toString(); 
		String codPers = mapaPrin.get("codPers").toString();
		String codUO = mapaPrin.get("codUO").toString(); 
		String periodo = mapaPrin.get("periodo").toString(); 
		String fechaIni = mapaPrin.get("fechaIni").toString(); 
		String fechaFin = mapaPrin.get("fechaFin").toString();
		List movimientos = (List) mapaPrin.get("movimientos"); 
		Map acumulados = (Map) mapaPrin.get("acumulados"); 
		Map acumPeriodo = (Map) mapaPrin.get("acumPeriodo");
		String usuario = mapaPrin.get("usuario").toString();
		String indPap = mapaPrin.get("indPap").toString(); 

		T1271DAO asisDAO = new T1271DAO(dbpool);
		T1272DAO resumenDAO = new T1272DAO();
		T1454DAO diarioDAO = new T1454DAO();
		T1273DAO licenciaDAO = new T1273DAO(dbpool);
		T1282DAO vacacionDAO = new T1282DAO(dbpool);		
		T1270DAO turnoDAO = new T1270DAO();
		T01DAO paramDAO = new T01DAO();
		T99DAO codigoDAO = new T99DAO();
		T8167DAO climaLabDAO = new T8167DAO(dbpool); //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
		
		BeanTurnoTrabajo turno = null;
		boolean res = true;
		String fIni = "";
		String fFin = "";
		
		List papeletasGeneradas=null;//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
		
		try {
			String fechaIniNSA = codigoDAO.findParamByCodTabCodigo(dbpool,
					Constantes.CODTAB_PARAMETROS_ASISTENCIA,
					Constantes.FECHA_INICIO_SIRH_NSA);
			
			//eliminamos la asistencia resumen en el periodo para el trabajador
			resumenDAO.deleteByCodPersPeriodo(dbpool, codPers, periodo);
			diarioDAO.deleteByCodPersPeriodo(dbpool, codPers, periodo);

			//para la verificacion de dias faltantes
			if (fechaIni.indexOf("/")>3) fIni = fechaIni; else fIni = Utiles.toYYYYMMDD(fechaIni);	
			if (fechaFin.indexOf("/")>3) fFin = fechaFin; else fFin = Utiles.toYYYYMMDD(fechaFin);	

			String fAct = fIni;
			String fReal = fechaIni;
			if (fReal.indexOf("/")>3){ 
				fReal = fReal.substring(8,10) + "/" + fReal.substring(5,7) + "/" + fReal.substring(0,4) ;
			}
			
			boolean bVacacion = false;
			boolean bLicencia = false;
			boolean bInasistencia = true;
			boolean bPrimMarca = true;
			boolean bUltMarca = false;
			HashMap acumPer = null;
			HashMap acumDetalle = null;
			HashMap acumDetalleRefri = null;//ICR 18052015
			HashMap acumPerRefri = null;//ICR 18052015
			
			List detalles = null;
			List detallesPapGen = null;//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
			Map proceso = new HashMap();
			
			int minRecuperacion = 0; //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
			
			//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
			Map paramsCli = new HashMap();			
			String climaLab = codigoDAO.findParamByCodTabCodigo(dbpool,Constantes.CODTAB_PARAMETROS_ASISTENCIA,Constantes.MINUTOS_MAXIMO_CLIMALABORAL);
			int minMaxClima = climaLab != null ? Integer.parseInt(climaLab) : 0;
			log.debug("minMaxClima: " + ""+minMaxClima);
			List califClima = null;
			Map autoriClima = null;	
			//ICAPUNAY - PAS20175E230300069
			
			//mientras no haya terminado el periodo en proceso
			while (fAct.compareTo(fFin) <= 0) {

				if (log.isDebugEnabled()) log.debug("--------- Fecha : " + fReal + " ---------");
				
				minRecuperacion = turnoDAO.findHorasCompensa(dbpool,codPers,fReal); //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
				if (log.isDebugEnabled()) log.debug("minRecuperacion3-Forma:"+minRecuperacion);
				
				//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
				paramsCli.put("cod_pers", codPers);
				paramsCli.put("mov", Constantes.MOV_REFRI_CLIMALABORAL);//136
				paramsCli.put("fecha", new FechaBean(fReal).getSQLDate());				
				log.debug("paramsClii: "+paramsCli);
				
				califClima=asisDAO.findByCodPersMovFecha(paramsCli);
				log.debug("califClimaa: "+califClima);
				autoriClima=climaLabDAO.findAutorizaByRegByFecha(codPers, fReal);
				log.debug("autoriClima new: "+autoriClima);	
				//ICAPUNAY - PAS20175E230300069

				//aqui inicializamos todas las variables de control del dia
				bVacacion = false;
				bLicencia = false;
				bInasistencia = true;
				bPrimMarca = true;

				//obtenemos el turno del trabajador para la fecha en proceso
				turno = turnoDAO.joinWithT45ByCodFecha(dbpool, codPers, fReal);
				if (log.isDebugEnabled()) log.debug("Turno de trabajador:" + turno);

				//verificamos si esta de vacaciones para la fecha real
				//prac-jcallo
				Map prm = new HashMap();
				prm.put("cod_pers", codPers);
				prm.put("fechaIni", fReal);
				prm.put("fechaFin", "");
				if (log.isDebugEnabled()) log.debug("metodo procesarAsistenciaTrabModFormativa - findByCodPersFIniFFin - prm:"+prm);
				bVacacion = vacacionDAO.findByCodPersFIniFFin(prm);
				
				/******* JRR NUEVA SOLICITUD - 23/04/2009 *******/
				if (!bVacacion) {
					List vacVencidas = vacacionDAO.findByCodPersFIniFFinVacVencidas(prm);
					if (vacVencidas!=null && vacVencidas.size()>0) { 
						bVacacion = true;
						if (log.isDebugEnabled()) log.debug(codPers + " posee Goce de Vacaciones Vencidas.");
					}
				}
				/************************************************/
				
				if (log.isDebugEnabled()) log.debug("bVacacion: "+bVacacion);
				if (bVacacion) {
					
					if (log.isDebugEnabled()) log.debug("El trabajador esta de vacaciones el " +fReal);

					//obtenemos el movimiento de vacaciones e incrementamos el numero de dias
					acumDetalle = (HashMap) acumulados.get(Constantes.MOV_VACACIONES);
					acumDetalle.put("total", "1");
					acumulados.put(Constantes.MOV_VACACIONES, acumDetalle);
					
					//acumulamos del periodo
					acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_VACACIONES);
					
					float totPer = new Float(acumPer.get("total").toString()).floatValue();
					acumPer.put("total", "" + (totPer + 1));
					acumPeriodo.put(Constantes.MOV_VACACIONES, acumPer);

					//el trabajador no ha faltado xq esta de vacaciones
					bInasistencia = false;
					
				} else {

					//verificamos si esta de licencia
					//prac-jcallo
					Map params = new HashMap();
					params.put("cod_pers", codPers);
					params.put("fecha1", fReal);
					params.put("fecha2", "");
					params.put("numero", "");
					if (log.isDebugEnabled()) log.debug("licenciaDAO.findByCodPersFIniFFin(params)... params:"+params);
					bLicencia = licenciaDAO.findByCodPersFIniFFin(params); //(dbpool,codPers, fReal, "", "");
					
					if (bLicencia) {
						
						if (log.isDebugEnabled()) log.debug("El trabajador esta de licencia el " +fReal);
						
						//obtenemos la licencia de ese dia
						Map prms = new HashMap();
						prms.put("cod_pers", codPers);
						prms.put("fecha", fReal);

						List lista = licenciaDAO.findByCodPersFecha(prms);
						Map licencia = (Map)lista.get(0); //(dbpool, codPers, fReal);
						//obtenemos el movimiento de vacaciones e incrementamos el numero de dias
						acumDetalle = (HashMap) acumulados.get(licencia.get("licencia").toString().trim());
						
						if (acumDetalle != null) {
							//el trabajador esta de licencia
							acumDetalle.put("total", "1");
							acumulados.put(licencia.get("licencia").toString().trim(),acumDetalle);

							//acumulamos del periodo
							acumPer = (HashMap) acumPeriodo.get(licencia.get("licencia").toString().trim());
							
							float totPer = new Float(acumPer.get("total").toString()).floatValue();
							acumPer.put("total", "" + (totPer + 1));
							acumPeriodo.put(licencia.get("licencia").toString().trim(),acumPer);

						}

						//el trabajador no ha faltado xq esta de licencia
						bInasistencia = false;
					}
				}
				
				//si posee turno y no esta ni de vacaciones ni de licencia
				if (turno != null && !bVacacion && !bLicencia) {
					
					//verificamos si es un dia laborable
					boolean diaLaborable = true;
					if (!turno.isOperativo()) {
						if (Utiles.isDiaSemana(fReal, Constantes.SABADO)								
							|| Utiles.isDiaSemana(fReal, Constantes.DOMINGO)
							|| paramDAO.findByFechaFeriado(dbpool, fReal)) {
							diaLaborable = false;
						}
					}

					//obtenemos el detalle de las calificaciones para la fecha
					//prac-jcallo
					Map params = new HashMap();
					params.put("cod_pers", codPers);
					params.put("fing", fReal);
params.put("estado_id", "1");//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
					
					//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
					detallesPapGen = asisDAO.findByCodPersFechaAndEstado(params);
					log.debug("detallesPapGen: "+detallesPapGen);
					
					if (detallesPapGen != null && detallesPapGen.size() > 0) {
						
						String periodoPap = (String)((HashMap)detallesPapGen.get(0)).get("periodo");
						
						HashMap fechas = new HashMap();
						fechas.put("FechaNSA",fechaIniNSA);
						
						DataSource dcsp = ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dcsp");
						pe.gob.sunat.rrhh.dao.T02DAO t02dao = new pe.gob.sunat.rrhh.dao.T02DAO(dcsp);
						HashMap beanPersona = (HashMap)t02dao.findByRegistro(codPers.trim());
						beanPersona.put("t02cod_pers", codPers);
						beanPersona.put("t02cod_uorg", beanPersona.get("cod_uorg"));
						
						HashMap mapa=new HashMap();
						mapa.put("dbpool", "jdbc/dgsp");
						mapa.put("fechaEval",fReal);
						mapa.put("periodo", periodoPap);
						mapa.put("isProcesar", "SI");
						
						Map superMapa = new HashMap();
						superMapa.put("mapa", mapa);
						superMapa.put("beanPersona", beanPersona);
						superMapa.put("fechas", fechas);
						superMapa.put("usuario", usuario);
						superMapa.put("isProcesar", "SI");
						
						String t02cod_rel=(String)beanPersona.get("t02cod_rel");
						
						ProcesoFacade pf=new ProcesoFacade();
						
						log.debug("superMapa--"+superMapa);
						if(t02cod_rel.equals("09")) {
							pf.generarAsistenciaTrabajadorCAS(superMapa);
							log.debug("superMapa: "+superMapa);
						} else if(t02cod_rel.equals("10")) {
							pf.generarAsistenciaTrabajadorModFormativa(superMapa);
						} else {
							pf.generarAsistenciaTrabajador(mapa,beanPersona,fechas,usuario);
						}
						
						papeletasGeneradas = (List)superMapa.get("papeletasGeneradas");
						if (log.isDebugEnabled()) log.debug("papeletasGeneradas fin : "+papeletasGeneradas);
					}
					//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
					
					if (log.isDebugEnabled()) log.debug("asisDAO.findByCodPersFechaPeriodo(params)... params:"+params);
					detalles = asisDAO.findByCodPersFechaPeriodo(params);// (dbpool, codPers, fReal, periodo) CAMBIAR ESTO POR EL DE RRHH ASISTENCIA;
					if (log.isDebugEnabled()) log.debug("detalles.size : "+detalles.size());

					//si el trabajador posee calificaciones para ese dia
					if (detalles != null && detalles.size() > 0) {

						bInasistencia = false;
						
						//analizamos cada movimiento realizado
						for (int j = 0; j < detalles.size(); j++) {
							
							boolean movEspecial = false;
							boolean procesarPapeleta = false;
							proceso = (HashMap) detalles.get(j);
							
							//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0
							String hing = proceso.get("hing").toString().trim();						
							log.debug("papeletasGeneradas: "+papeletasGeneradas);
							if (papeletasGeneradas!=null){
								for (int k = 0; k <= papeletasGeneradas.size()-1; k++) {
									Map papeleta = (HashMap) papeletasGeneradas.get(k);
									if (hing.equals(papeleta.get("hing"))){
										proceso.put("mov", papeleta.get("mov"));
										proceso.put("estado_id", papeleta.get("estado_id"));
									}
								}
							}
							//PAS20155E230300022 papeletas generadas (estado 1) se generen y procesen con estado inicial 0

							String mov = proceso.get("mov")!= null ? proceso.get("mov").toString().trim() : "";
							acumPer = (HashMap) acumPeriodo.get(mov);
							acumDetalle = (HashMap) acumulados.get(mov);
							String recalifica = mov;
							
							//JRR 19 mayo 2008
							String fing = proceso.get("fing_desc").toString().trim();

							if (acumDetalle != null) {
								String tipo = (String) acumDetalle.get("tipo_id");
								String medida = (String) acumDetalle.get("medida");

								float total = new Float(acumDetalle.get("total").toString()).floatValue();
								float cantidad = 0;

								boolean entrada = acumDetalle.get("entrada") != null ? ((String) acumDetalle.get("entrada")).equals(Constantes.ACTIVO): false;
								boolean refrigerio = acumDetalle.get("refrigerio") != null ? ((String) acumDetalle.get("refrigerio")).equals(Constantes.ACTIVO): false;
								boolean salida = acumDetalle.get("salida") != null ? ((String) acumDetalle.get("salida")).equals(Constantes.ACTIVO): false;
								movEspecial = entrada || refrigerio || salida
										|| tipo.trim().equals(Constantes.TIPO_MOV_PAPELETA)
										|| mov.equals(Constantes.MOV_INASISTENCIA);

								//inasistencia
								if (mov.equals(Constantes.MOV_INASISTENCIA)) bInasistencia = true;

								if (!bInasistencia) {
									
									//movimientos de entrada
									if (entrada) {

										bPrimMarca = false;
										String horaLim = turno.getHoraLimite();
										
										if (horaLim != null && !horaLim.equals("")) {

											//cantidad de minutos de tardanza
											cantidad = Utiles
													.calculaAcumulado(
															medida,
											Utiles.stringToTimestamp(fing+ " "+ turno.getHoraIni()),
											Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()));
											

											if (cantidad < 0) cantidad *= -1;
											//EBV 05/01/2009
											//Si existe el movimiento pero le ponemos 1 a fin de que grabe
											if (cantidad == 0) cantidad = 1;
											//EBV 05/01/2009
											
											//acumulamos el diario
											acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
											acumulados.put(mov, acumDetalle);
											
											//acumulamos el periodo
											float totPer = new Float(acumPer.get("total").toString()).floatValue();
											acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
											acumPeriodo.put(mov, acumPer);
										}
									}

									//movimientos de refrigerio
									if (refrigerio) {
										
										bPrimMarca = false;

										cantidad = Utiles
												.calculaAcumulado(
														medida,
										Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()),
										Utiles.stringToTimestamp(fing+ " "+ proceso.get("hsal").toString()));

										//ICR 18052015
										String movAnt="";
										if (j != 0){
											Map procesoAnt = (HashMap) detalles.get(j-1);
											movAnt = procesoAnt.get("mov")!= null ? procesoAnt.get("mov").toString().trim() : "";
										}
										//FIN ICR 18052015
										
										if (!movAnt.equals("") && !movAnt.equals(Constantes.MOV_EXCESO_REFRIGERIO)){ //ICR 18052015
											float totalRefri = 0; //linea add ICAPUNAY - PAS20175E230300069
											log.debug("mov anterior no es exceso:"+movAnt);//BORRAR 25/06
											if (mov.equals(Constantes.MOV_EXCESO_REFRIGERIO)) {
												//ICR 18052015	
												log.debug("es mov exceso refri_Formativa");																					
												//cantidad -= turno.getMinutosRefrigerio();
												if (califClima!=null && califClima.size()>0){ //linea add ICAPUNAY - PAS20175E230300069
													totalRefri = new Float(((HashMap)acumulados.get(Constantes.MOV_REFRI_CLIMALABORAL)).get("total").toString()).floatValue();//linea add ICAPUNAY - PAS20175E230300069
												}else{ //linea add ICAPUNAY - PAS20175E230300069
													totalRefri = new Float(((HashMap)acumulados.get(Constantes.MOV_REFRIGERIO)).get("total").toString()).floatValue();
												}//linea add ICAPUNAY - PAS20175E230300069												
												float totalExceRefri = new Float(((HashMap)acumulados.get(Constantes.MOV_EXCESO_REFRIGERIO)).get("total").toString()).floatValue();
												log.debug("totalRefri_Formativa: "+totalRefri);
												log.debug("totalExceRefri_Formativa: "+totalExceRefri);
												//if (califClima!=null && califClima.size()>0){ //linea add ICAPUNAY - PAS20175E230300069
												if ((califClima!=null && califClima.size()>0) || (autoriClima!=null && !autoriClima.isEmpty())){ //linea add ICAPUNAY - PAS20175E230300069
													if (totalRefri+totalExceRefri+cantidad>minMaxClima){
														log.debug(">>>>>entro IF1 new");
														log.debug("cantidad: "+cantidad);
														log.debug("totalRefri+totalExceRefri+cantidad) - minMaxClima>>>>> ("+totalRefri+"+"+totalExceRefri+"+"+cantidad+") - "+minMaxClima+")");//ICR 18052015
														cantidad = (totalRefri+totalExceRefri+cantidad) - minMaxClima;
														log.debug("cantidad: "+cantidad);
														
														//obtenemos el movimiento de "refrigerio clima laboral" y seteamos en 120 el total
														acumDetalleRefri = (HashMap) acumulados.get(Constantes.MOV_REFRI_CLIMALABORAL);
														log.debug("acumDetalleRefri: "+acumDetalleRefri);
														acumDetalleRefri.put("total", ""+ (Math.round(minMaxClima)));
														acumulados.put(Constantes.MOV_REFRI_CLIMALABORAL, acumDetalleRefri);
														log.debug("acumDetalleRefri2: "+acumDetalleRefri);
														//acumulamos al periodo los 120 min por el movimiento de "refrigerio clima laboral" 
														acumPerRefri= (HashMap) acumPeriodo.get(Constantes.MOV_REFRI_CLIMALABORAL);												
														float totPer = new Float(acumPerRefri.get("total").toString()).floatValue();
														log.debug("totPer: "+totPer);
														log.debug("minMaxClima: "+minMaxClima);
														log.debug("totalRefri: "+totalRefri);
														acumPerRefri.put("total", "" + (Math.round(totPer + (minMaxClima-totalRefri))));
														acumPeriodo.put(Constantes.MOV_REFRI_CLIMALABORAL, acumPerRefri);
														log.debug("acumPerRefri: "+acumPerRefri);
														log.debug(">>>>>sale IF1");
													}	
													
												}else{//linea add ICAPUNAY - PAS20175E230300069
													if (totalRefri+totalExceRefri+cantidad>turno.getMinutosRefrigerio()){
														log.debug(">>>>>entro IF");
														log.debug("cantidad: "+cantidad);
														log.debug("totalRefri+totalExceRefri+cantidad) - turno.getMinutosRefrigerio()>>>>> ("+totalRefri+"+"+totalExceRefri+"+"+cantidad+") - "+turno.getMinutosRefrigerio()+")");//ICR 18052015
														cantidad = (totalRefri+totalExceRefri+cantidad) - turno.getMinutosRefrigerio();
														log.debug("cantidad: "+cantidad);
														
														//obtenemos el movimiento de refrigerio y seteamos en 60 el total
														acumDetalleRefri = (HashMap) acumulados.get(Constantes.MOV_REFRIGERIO);
														log.debug("acumDetalleRefri: "+acumDetalleRefri);
														acumDetalleRefri.put("total", ""+ (Math.round(turno.getMinutosRefrigerio())));
														acumulados.put(Constantes.MOV_REFRIGERIO, acumDetalleRefri);
														log.debug("acumDetalleRefri2: "+acumDetalleRefri);
														//acumulamos al periodo los 60 min por el movimiento de refrigerio 
														acumPerRefri= (HashMap) acumPeriodo.get(Constantes.MOV_REFRIGERIO);												
														float totPer = new Float(acumPerRefri.get("total").toString()).floatValue();
														log.debug("totPer: "+totPer);
														log.debug("turno.getMinutosRefrigerio(): "+turno.getMinutosRefrigerio());
														log.debug("totalRefri: "+totalRefri);
														acumPerRefri.put("total", "" + (Math.round(totPer + (turno.getMinutosRefrigerio()-totalRefri))));
														acumPeriodo.put(Constantes.MOV_REFRIGERIO, acumPerRefri);
														log.debug("acumPerRefri: "+acumPerRefri);
														log.debug(">>>>>sale IF");
													}	
												}//linea add ICAPUNAY - PAS20175E230300069													
												log.debug(">>>>>cantidad1: "+cantidad);
												//FIN ICR 18052015									
											}
										}//ICR 18052015
										
										log.debug(">>>>>cantidad2: "+cantidad);//ICR 18052015									
										log.debug(">>>>>(Math.round(total + cantidad)): Math.round("+total +"+" +cantidad+")");
										//acumulamos el diario
										acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
										acumulados.put(mov, acumDetalle);
										log.debug("total_Formativa: "+total);//ICR 18052015
										log.debug("cantidad_Formativa: "+cantidad);//ICR 18052015
										log.debug("mov exceso_Formativa: "+mov);//ICR 18052015
										log.debug("acumDetalle_Formativa: "+acumDetalle);//ICR 18052015
										//acumulamos el periodo
										float totPer = new Float(acumPer.get("total").toString()).floatValue();
										acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
										acumPeriodo.put(mov, acumPer);
										log.debug("totPer_Formativa: "+totPer);//ICR 18052015
										log.debug("acumPeriodo_Formativa: "+acumPeriodo);//ICR 18052015
									}

									//movimientos de salida
									if (salida) {
										bPrimMarca = false;

										if (proceso.get("hing") != null && !proceso.get("hing").toString().trim().equals(Constantes.SALIDA)) {
											
											/****** JRR - 28/04/2009 *******/
											if (log.isDebugEnabled()) {
												log.debug("SALIDA");
												log.debug("fing + turno.getHoraFin(): " + fing+ " "+turno.getHoraFin());
												log.debug("fing + proceso.get('hing').toString(): " + fing+ " "+ proceso.get("hing").toString());
											}
											
											float minutos = Utiles.obtenerMinutosDiferencia(turno.getHoraIni(), proceso.get("hing").toString());
											if (log.isDebugEnabled()) log.debug("minutos: " + minutos);
											//Salida anticipada
											if (minutos <0) {
												cantidad = Utiles
												.calculaAcumulado(
														medida,
														Utiles.stringToTimestamp(fing+ " "+ turno.getHoraIni()),
														Utiles.stringToTimestamp(fing+ " "+ turno.getHoraFin()));
											} else {
											/*****************************/

												cantidad = Utiles
												.calculaAcumulado(
														medida,
														Utiles.stringToTimestamp(fing+ " "+ turno.getHoraFin()),
														Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()));

											}

											if (log.isDebugEnabled()) log.debug("CANTIDAD antes de validar compensacion: " + cantidad);
											
											//en caso el turno sea onomastico se debe trabajar 1 hora mas
											cantidad-=turnoDAO.findHorasCompensa(dbpool,codPers,fReal);

											//salida anticipada
											if (cantidad < 0) {
												cantidad *= -1;
											}
											
//											EBV 05/01/2009
											//Si existe el movimiento pero le ponemos 1 a fin de que grabe
											if (cantidad == 0) cantidad = 1;
											//EBV 05/01/2009

											//acumulamos el diario
											acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
											acumulados.put(mov, acumDetalle);

											//acumulamos el periodo
											float totPer = new Float(acumPer.get("total").toString()).floatValue();
											acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
											acumPeriodo.put(mov, acumPer);

										}
									}
									
									//en caso sean papeletas
									
									if (tipo.trim().equals(Constantes.TIPO_MOV_PAPELETA)) {
										if (log.isDebugEnabled()) log.debug("Entre Papeletas Formativa");
										if (indPap.equals("1")){ //Si esta Marcado el Flag de Incluir Papeletas
										procesarPapeleta = true;
										
										String horaIni = proceso.get("hing").toString();
										String horaFin = proceso.get("hsal")!=null?proceso.get("hsal").toString():"";
										if (log.isDebugEnabled()) log.debug("Entre Papeletas Formativa "+ horaIni +" - " + horaFin);
										if (horaFin == null || horaFin.equals("") || horaFin.trim().length()== 0) {
										    //primera marca
											if (log.isDebugEnabled()) log.debug("Primera Marca "+ bPrimMarca);
											if (bPrimMarca) {
												horaIni = turno.getHoraIni();
												horaFin = proceso.get("hing").toString();
											}
											//movimiento de salida
											else {
												bUltMarca=true;
												horaIni = proceso.get("hing").toString();
												horaFin = turno.getHoraFin();
											}
										} else //EBV 18/02/2009 Se pone en False la primera y ultima marca para los demas movimientos
										{
											bUltMarca=false;
											bUltMarca=false;

										}

										if (log.isDebugEnabled()) log.debug("Turno "+turno);
										if (log.isDebugEnabled()) log.debug("Proceso "+proceso);
										if (log.isDebugEnabled()) log.debug("Entre Papeletas "+ horaIni +" - " + horaFin);
										//si estan aceptadas
										if (proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_ACEPTADA)
											|| proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_PROCESADA)
											|| proceso.get("estado_id").toString().trim().equals(Constantes.ASISTENCIA_CALIFICADA)) {
											if (log.isDebugEnabled()) log.debug("Entre Papeletas Aceptadas Procesadas Formativa");
											if (horaFin != null && !horaFin.equals(Constantes.SALIDA)) {
												cantidad = Utiles
														.calculaAcumulado(
																Constantes.MINUTO,
												Utiles.stringToTimestamp(fing+ " "+ horaIni),
												Utiles.stringToTimestamp(fing+ " "+ horaFin));
												
												if (log.isDebugEnabled()) log.debug("Entre Papeletas Formativa "+mov +" "+ cantidad);
												
												//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
												//papeleta permiso "particular con descuento" antes y despues del turno (solo se descontara lo que afecte el turno)
												if (mov.equals(Constantes.MOV_PERMISO_SIN_GOCE) || mov.equals(Constantes.MOV_PERM_PART_CON_DESCUENTO_100) ){ //ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia (permiso particular con descuento)
													log.debug("es papeleta perConDescuento03 o perConDescuento100_Formativa");//ICR 18052015
													String horaIniTurno = turno.getHoraIni().trim();
													String horaFinTurno = turno.getHoraFin().trim();
													if(!horaFin.equals(horaFinTurno)){ //el proceso tiene que tener hora salida
														log.debug("hsal de movimiento es diferente hora fin turno_Formativa");//ICR 18052015
														//entrada
														if(horaIni.compareTo(horaIniTurno)<0 &&
														   horaFin.compareTo(horaIniTurno)>0){
															log.debug("es perConDescuento03 o perConDescuento100 que afecta entrada_Formativa");//ICR 18052015
															float cantidadDescontable = Utiles.calculaAcumulado(
																			Constantes.MINUTO,
																			Utiles.stringToTimestamp(fing+ " "+ horaIniTurno),
																			Utiles.stringToTimestamp(fing+ " "+ horaFin));
															cantidad = cantidadDescontable;													
														}
														//salida (pero despues se regresa)
														//if(horaIni.compareTo(horaFinTurno)<0 && ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
														if(( (horaIni.compareTo(horaFinTurno)<0) || (horaIni.compareTo(horaFinTurno)>0 && minRecuperacion==60)) && //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
														   horaFin.compareTo(horaFinTurno)>0){
															log.debug("es perConDescuento03 o perConDescuento100 que afecta salida_Formativa");//ICR 18052015
															
															//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios												
															if (!horaFinTurno.substring(0,2).trim().equals("23")){//hora <> 23	
																log.debug("horaFinTurno anterior: "+horaFinTurno);
																if(minRecuperacion>0){ //ICAPUNAY - PAS20165E230300132 - MSNAAF071 (add solo esta linea)
																	//aumentando a la hora final del turno 1 hora por la hora de recuperacion
																	String shora = horaFinTurno.substring(0,2); //08 de 08:55:47
																	String sresto = horaFinTurno.substring(2,horaFinTurno.length()); //:55:47
																	int hora = Integer.parseInt(shora);														
																	hora = hora + 1; 
																	log.debug("hora aumentada: "+hora);
																	if (hora < 10){//anteponemos el 0 delante (caso2: 9)
																		shora = "0"+String.valueOf(hora)+sresto;// (caso2: 09:55:47)														
																	}else{
																		shora = String.valueOf(hora)+sresto;//14:55:47														
																	}	
																	horaFinTurno=shora;
																	log.debug("horaFinTurno con recuperacion: "+ horaFinTurno);
																} //ICAPUNAY - PAS20165E230300132 - MSNAAF071 (add solo esta linea)		
															}else{//hora = 23
																horaFinTurno="23:59:59";
															}
															log.debug("horaFinTurno final: "+ horaFinTurno);
															log.debug("horaFin: "+ horaFin);
															//FIN ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
															
															if (horaFin.compareTo(horaFinTurno)>0){ //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
																float cantidadDescontable = Utiles.calculaAcumulado(
																				Constantes.MINUTO,
																				Utiles.stringToTimestamp(fing+ " "+ horaIni),
																				Utiles.stringToTimestamp(fing+ " "+ horaFinTurno));
																cantidad = cantidadDescontable;
															}//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
														}														
														log.debug("cantidad(perConDescuento03 o perConDescuento100 real)_Formativa: "+cantidad);//ICR 18052015
													}
													//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
													else{
														log.debug("hsal de movimiento es IGUAL a hora fin turno_Formativa");
														if(minRecuperacion>0){
															log.debug("es perConDescuento03 o perConDescuento100_minRecuperacion3:"+minRecuperacion);
															cantidad = cantidad + minRecuperacion;
														}
														log.debug("es perConDescuento03 o perConDescuento100_cantidad3:"+cantidad);
													}
													//FIN ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
												}
												//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
												
												
												if (cantidad > 480 && (mov.equals(Constantes.MOV_PERMISO_SIN_GOCE) || mov.equals(Constantes.MOV_PERM_PART_CON_DESCUENTO_100))){
													log.debug("cantidad > 480");//BORRAR 25/06
													recalifica = Constantes.MOV_INASISTENCIA;
													acumDetalle = (HashMap) acumulados.get(Constantes.MOV_INASISTENCIA);
													acumDetalle.put("total", "1");
													acumulados.put(Constantes.MOV_INASISTENCIA,acumDetalle);
													//	acumulamos del periodo
													acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_INASISTENCIA);
													float totPer = new Float(acumPer.get("total").toString()).floatValue();
													acumPer.put("total", "" + (totPer + 1));
													acumPeriodo.put(Constantes.MOV_INASISTENCIA, acumPer);
												} else{													
													//ICR 03/07/2015
													if (cantidad < 0) {
														cantidad *= -1;
													}
													//FIN ICR
													
													//acumulamos el diario
													acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
													acumulados.put(mov,acumDetalle);
												
													//acumulamos el periodo
													float totPer = new Float(acumPer.get("total").toString()).floatValue();
													acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
													acumPeriodo.put(mov,acumPer);
												}
											}
										}
										//si estan rechazadas o registradas
										else if (proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_RECHAZADA)
											     || proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_REGISTRADA)) {
								//EBV - 09072008 - Papeletas	
									           //se recalifica a un movimiento descontable
									           recalifica = Constantes.MOV_PAPELETA_NO_AUTORIZADA;
									           
									           if (horaFin != null && !horaFin.equals(Constantes.SALIDA)) {
									 
									            if (bPrimMarca) {
									 
									             
									             String horaLim = turno.getHoraLimite();
									             
									             if (horaLim != null && !horaLim.equals("")) {
									              recalifica = preCalificarEntrada(
									                fing,
									                proceso.get("hing").toString(),
									                turno.getHoraIni(),
									                turno.getTolera(),
									                turno.getHoraLimite(),
									                Constantes.MINUTO);
									              //cantidad de minutos de tardanza
									              cantidad = Utiles
									                .calculaAcumulado(
									                	Constantes.MINUTO,
									              Utiles.stringToTimestamp(fing+ " "+ turno.getHoraIni()),
									              Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()));
									 
									              if (log.isDebugEnabled()) log.debug("acumulados-cantidad " + cantidad);
									              if (cantidad < 0) cantidad *= -1;
									              
									              acumDetalle = (HashMap) acumulados.get(recalifica);
									              total = new Float(acumDetalle.get("total").toString()).floatValue();
									              if (recalifica.equals(Constantes.MOV_INASISTENCIA)){
									               
									               acumDetalle.put("total", "1");
									               acumulados.put(Constantes.MOV_INASISTENCIA,acumDetalle);
									               // acumulamos del periodo
									               acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_INASISTENCIA);
									               float totPer = new Float(acumPer.get("total").toString()).floatValue();
									               acumPer.put("total", "" + (totPer + 1));
									               acumPeriodo.put(Constantes.MOV_INASISTENCIA, acumPer);
									              } else{
									              //acumulamos el diario
									              acumPer = (HashMap) acumPeriodo.get(recalifica);
									              acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
									              acumulados.put(recalifica, acumDetalle);
									              
									              //acumulamos el periodo
									              float totPer = new Float(acumPer.get("total").toString()).floatValue();
									              acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
									              acumPeriodo.put(recalifica, acumPer);
									              }
									             }
									            } else {
									             cantidad = Utiles
									             .calculaAcumulado(
									               medida,
									             Utiles.stringToTimestamp(fing+ " "+ horaIni),
									             Utiles.stringToTimestamp(fing+ " "+ horaFin));
									 
									             if (cantidad < 0) cantidad *= -1;
									             
									             // acumulamos el diario
									             if ((Constantes.TURNO_RS067).equals(turno.getTurno().trim())){
									            	 recalifica = Constantes.MOV_RESOLUCION_067;
								            	} else {
								            		
								            		if (!bUltMarca) {
								            			recalifica = preCalificarMovimiento(
									            				fing,
									            				horaIni,
									            				horaFin,
									            				turno,
									            				Constantes.MINUTO,
									            				false,
									            				turno.isOperativo());
								               			if (Utiles.obtenerDiasDiferencia(fechaIniNSA ,fing)>=0) {
/*EBV 27/03/2015 CAMBIO DE LINEAMIENTO
								               				if (recalifica.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)) {
								               					recalifica = Constantes.MOV_SALIDA_AUTORIZADA;
								               					if (log.isDebugEnabled()) {
								               						log.debug("cambio insertamos en proceso " + recalifica);
								               					}
								               				}
*/
								               			}
								               			
								               			//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
														//salida no autorizada antes y despues del turno (solo se descontara lo que afecte el turno)
														if (recalifica.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)){ 
															log.debug("es SNA_Formativa(papeleta generada)");//ICR 18052015
															String horaIniTurno = turno.getHoraIni().trim();
															String horaFinTurno = turno.getHoraFin().trim();
															if(!horaFin.equals(horaFinTurno)){ //el proceso tiene que tener hora salida
																log.debug("hsal de movimiento es diferente hora fin turno_Formativa");//ICR 18052015
																//entrada
																if(horaIni.compareTo(horaIniTurno)<0 &&
																   horaFin.compareTo(horaIniTurno)>0){
																	log.debug("es SNA que afecta entrada_Formativa");//ICR 18052015
																	float cantidadDescontable = Utiles.calculaAcumulado(
																					Constantes.MINUTO,
																					Utiles.stringToTimestamp(fing+ " "+ horaIniTurno),
																					Utiles.stringToTimestamp(fing+ " "+ horaFin));
																	cantidad = cantidadDescontable;													
																}
																//salida (pero despues se regresa)
																if(horaIni.compareTo(horaFinTurno)<0 &&
																   horaFin.compareTo(horaFinTurno)>0){
																	log.debug("es SNA que afecta salida_Formativa");//ICR 18052015
																	float cantidadDescontable = Utiles.calculaAcumulado(
																					Constantes.MINUTO,
																					Utiles.stringToTimestamp(fing+ " "+ horaIni),
																					Utiles.stringToTimestamp(fing+ " "+ horaFinTurno));
																	cantidad = cantidadDescontable;
																}
																log.debug("cantidad(SNA real)_Formativa: "+cantidad);//ICR 18052015
															}
														}
														//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
								               			
								            
								            	
								            		}
								            		else{
														recalifica = preCalificarSalida(
																dbpool,
																codPers,
																fing,
																horaIni,
																horaFin,
																Constantes.MINUTO);
								            		}
								            	}
									             

									             acumDetalle = (HashMap) acumulados.get(recalifica);
									             total = new Float(acumDetalle.get("total").toString()).floatValue();
									             acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
									             acumulados.put(recalifica,acumDetalle);
									             if (log.isDebugEnabled()) log.debug("acumulados" + acumulados);
									             // acumulamos el periodo
									             acumPer = (HashMap) acumPeriodo.get(recalifica);
									             float totPer = new Float(acumPer.get("total").toString()).floatValue();
									             acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
									             acumPeriodo.put(recalifica,acumPer);
									             //}
									            }
									           }
									          }
								//fin Papeletas EBV	
									
									//las papeletas se cambian a estado procesada									
									if (procesarPapeleta) {
										
										//PRAC-JCALLO
										Map prms = new HashMap();
										prms.put("cod_pers", codPers);
										prms.put("periodo", proceso.get("periodo").toString());//proceso.getPeriodo());
										prms.put("fechaIni", fing);//proceso.getFechaIni());
										prms.put("horaIni", proceso.get("hing").toString());//proceso.getHoraIni());
										prms.put("mov", recalifica);
										prms.put("estado", Constantes.PAPELETA_PROCESADA);
										if (log.isDebugEnabled()) log.debug("asisDAO.updatePapeletaByFecha(prms)... prms:"+prms);
										
								//JRR - 18072008 Papeletas v2
								        if ( (!proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_REGISTRADA)) &&
									            (!proceso.get("estado_id").toString().trim().equals(Constantes.PAPELETA_RECHAZADA)) ) {
									           asisDAO.updatePapeletaByFecha(prms);
									          }
										
										
										log_papeleta.info("Proceso|".
												concat(codPers).
												concat("|").
												concat(fing).
												concat("|").
												concat(proceso.get("hing").toString()).
												concat("|").
												concat(proceso.get("mov").toString()).
												concat("|").
												concat(recalifica)
										);										
									}
										}
										//EBV 16/02/2009 Se pone en False la primera marca para los demas movimientos
										bPrimMarca = false;
									}

									//en caso sea otro tipo de movimiento
									if (!movEspecial) {
										bPrimMarca = false;

										if (log.isDebugEnabled()) log.debug("Entro Mov. Especial" + movEspecial);
										String horaFinal = proceso.get("hsal").toString();
										
										if (horaFinal == null || horaFinal.equals("") || horaFinal.trim().length()== 0) {
											horaFinal = turno.getHoraFin();
										}
										
										cantidad = Utiles
												.calculaAcumulado(
														Constantes.MINUTO,
										Utiles.stringToTimestamp(fing+ " "+ proceso.get("hing").toString()),
										Utiles.stringToTimestamp(fing+ " "+ horaFinal));
										log.debug("otro Mov(forma)_cantidad:"+cantidad);// ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
										
										//ICR 18052015
										//salida no autorizada antes y despues del turno (solo se descontara lo que afecte el turno)
										if (mov.equals(Constantes.MOV_SALIDA_NO_AUTORIZADA)){ 
											log.debug("es SNA_Formativa");//ICR 18052015
											String horaIniTurno = turno.getHoraIni().trim();
											String horaFinTurno = turno.getHoraFin().trim();
											String horaIniProceso = proceso.get("hing").toString().trim();
											String horaFinProceso = horaFinal.trim();
											if(!horaFinProceso.equals(horaFinTurno)){ //el proceso tiene que tener hora salida
												log.debug("hsal de movimiento es diferente hora fin turno_Formativa");//ICR 18052015
												//entrada
												if(horaIniProceso.compareTo(horaIniTurno)<0 &&
												   horaFinProceso.compareTo(horaIniTurno)>0){
													log.debug("es SNA que afecta entrada_Formativa");//ICR 18052015
													float cantidadDescontable = Utiles.calculaAcumulado(
																	Constantes.MINUTO,
																	Utiles.stringToTimestamp(fing+ " "+ horaIniTurno),
																	Utiles.stringToTimestamp(fing+ " "+ horaFinProceso));
													cantidad = cantidadDescontable;													
												}
												//salida (pero despues se regresa)
												//if(horaIniProceso.compareTo(horaFinTurno)<0 &&  ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
												if(( (horaIniProceso.compareTo(horaFinTurno)<0) || (horaIniProceso.compareTo(horaFinTurno)>0 && minRecuperacion==60)) &&  //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
												   horaFinProceso.compareTo(horaFinTurno)>0){ 
													log.debug("es SNA que afecta salida_forma");//ICR 18052015
													
													//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios												
													if (!horaFinTurno.substring(0,2).trim().equals("23")){//hora <> 23	
														log.debug("horaFinTurno anterior: "+horaFinTurno);
														if(minRecuperacion>0){ //ICAPUNAY - PAS20165E230300132 - MSNAAF071 (add solo esta linea)
															//aumentando a la hora final del turno 1 hora por la hora de recuperacion
															String shora = horaFinTurno.substring(0,2); //08 de 08:55:47
															String sresto = horaFinTurno.substring(2,horaFinTurno.length()); //:55:47
															int hora = Integer.parseInt(shora);														
															hora = hora + 1; 
															log.debug("hora aumentada: "+hora);
															if (hora < 10){//anteponemos el 0 delante (caso2: 9)
																shora = "0"+String.valueOf(hora)+sresto;// (caso2: 09:55:47)														
															}else{
																shora = String.valueOf(hora)+sresto;//14:55:47														
															}	
															horaFinTurno=shora;
															log.debug("horaFinTurno con recuperacion: "+ horaFinTurno);
														} //ICAPUNAY - PAS20165E230300132 - MSNAAF071 (add solo esta linea)	
													}else{//hora = 23
														horaFinTurno="23:59:59";
													}
													log.debug("horaFinTurno final: "+ horaFinTurno);
													log.debug("horaFinProceso: "+ horaFinProceso);
													//FIN ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
													
													if (horaFinProceso.compareTo(horaFinTurno)>0){ //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
													
														float cantidadDescontable = Utiles.calculaAcumulado(
																		Constantes.MINUTO,
																		Utiles.stringToTimestamp(fing+ " "+ horaIniProceso),
																		Utiles.stringToTimestamp(fing+ " "+ horaFinTurno));
														cantidad = cantidadDescontable;														
													}//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
												}
												log.debug("cantidad(SNA real)_forma: "+cantidad);//ICR 18052015
											}
											//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
											else{
												log.debug("hsal de movimiento es IGUAL a hora fin turno_Formativa");
												if(minRecuperacion>0){
													log.debug("otro Mov(forma)_minRecuperacion3:"+minRecuperacion);
													cantidad = cantidad + minRecuperacion;
												}
												log.debug("otro Mov(forma)_cantidad3:"+cantidad);
											}
											//FIN ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)- cambios
										}
										//FIN ICR 18052015

										//acumulamos el diario
										if (log.isDebugEnabled()) log.debug("Total: " + total);
										if (log.isDebugEnabled()) log.debug("Cantidad: " + cantidad);
										
										if (cantidad <0) cantidad = cantidad*(-1);

										//Descomentar si no funciona EBV 02/10/2008
										acumDetalle = (HashMap) acumulados.get(mov);
							            total = new Float(acumDetalle.get("total").toString()).floatValue();
							            
										acumDetalle.put("total", ""+ (Math.round(total + cantidad)));
										acumulados.put(mov, acumDetalle);
										
										//acumulamos del periodo
										float totPer = new Float(acumPer.get("total").toString()).floatValue();
										acumPer.put("total", ""+ (Math.round(totPer + cantidad)));
										
										
										acumPeriodo.put(mov, acumPer);
										
									}
								}
							}
						} //end del for de detalles de movimientos del dia
						
					} else {
						//el trabajador no posee marcaciones
						bInasistencia = turno.isControla();
						//EBV Turno Rs 067 - 24/09/2007
						if ((Constantes.TURNO_RS067).equals(turno.getTurno().trim())){
							bInasistencia = true;
						}
				    //EBV-JRR Turnos sin marcaciones - 24/09/2008						
						else {
							   if (log.isDebugEnabled()) log.debug("Turnos sin marcaciones y no es R67");
						       if ((!turno.isControla())&& diaLaborable){
						        acumDetalle = (HashMap) acumulados.get(Constantes.MOV_TRABAJO_CAMPO);
						        acumDetalle.put("total", "1");
						        acumulados.put(Constantes.MOV_TRABAJO_CAMPO,acumDetalle);
						        //acumulamos del periodo
						        acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_TRABAJO_CAMPO);
						        float totPer = new Float(acumPer.get("total").toString()).floatValue();
						        acumPer.put("total", "" + (totPer + 1));
						        acumPeriodo.put(Constantes.MOV_TRABAJO_CAMPO, acumPer);
						        
						       } 
						      }
					//		
						

					}
					
					//si no es un dia laborable 
					if (!diaLaborable) bInasistencia = false;
						
				} else {
					
					bInasistencia = true;
					//no posee turno					
					if (turno==null) bInasistencia = false;
					//esta de vacaciones o licencia					
					else if (bVacacion || bLicencia) bInasistencia = false;					
				}
				
				
				//JRR - 19/05/2011
				//Cantidad de horas/minutos de turno de trabajo de la fecha en analisis
				int horas = 0;
				int minutos = 0;

				if (turno != null) {
					horas = Math.round(Utiles.obtenerHorasDifDia(turno.getHoraIni(), turno.getHoraFin()));
					minutos = 60 * horas;
				}				
				//
				
				
				//si falto ese dia
				if (bInasistencia) {
					
					//output.println("El trabajador no asistio el " + fReal);

					//obtenemos el movimiento de vacaciones e incrementamos el numero de dias
					acumDetalle = (HashMap) acumulados.get(Constantes.MOV_INASISTENCIA);
					//acumDetalle.put("total", "1");
					//JRR - 19/05/2011 - Para que acumule en minutos 
					acumDetalle.put("total", ""+minutos);
					//
					acumulados.put(Constantes.MOV_INASISTENCIA,acumDetalle);
					//acumulamos del periodo
					acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_INASISTENCIA);
					float totPer = new Float(acumPer.get("total").toString()).floatValue();
					//acumPer.put("total", "" + (totPer + 1));
					//JRR - 19/05/2011 - Para que acumule en minutos
					acumPer.put("total", "" + (totPer + minutos));
					//
					acumPeriodo.put(Constantes.MOV_INASISTENCIA, acumPer);
				}

				//Aqui debemos incluir el acumulado del movimiento 98 - Tardanza Efectiva para 
				//que sea igual al exceso de la Tardanza Con Descuento
				if (log.isDebugEnabled()) log.debug("Calculando tardanza efectiva");
				acumDetalle = (HashMap) acumulados.get(Constantes.MOV_TARDANZA_CON_DESCUENTO);
				float totDetalle = new Float(acumDetalle.get("total").toString()).floatValue();
				if (log.isDebugEnabled()) log.debug("Total Tardanza C/Desc : "+totDetalle);
				if (totDetalle>0){
					acumDetalle = (HashMap) acumulados.get(Constantes.MOV_TARDANZA_EFECTIVA);
					float totTardEfect = totDetalle-turno.getTolera();
					if (log.isDebugEnabled()) log.debug("Total Tardanza Efectiva : "+totTardEfect);
					acumDetalle.put("total", ""+totTardEfect);
					acumulados.put(Constantes.MOV_TARDANZA_EFECTIVA,acumDetalle);
					//vamos acumulando en el acumPeriodo el total del movimiento 98
					acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_TARDANZA_EFECTIVA);
					float totPer = new Float(acumPer.get("total").toString()).floatValue();
					acumPer.put("total", "" + (totPer + totTardEfect));
					acumPeriodo.put(Constantes.MOV_TARDANZA_EFECTIVA, acumPer);					
				}
				
				//registramos el resumen del dia
				for (int z = 0; z < movimientos.size(); z++) {

					BeanTipoMovimiento mov = (BeanTipoMovimiento) movimientos.get(z);
					HashMap acumulado = (HashMap) acumulados.get(mov.getMov().trim());
					if (log.isDebugEnabled()) log.debug("Acumulado " + acumulado);
					if (acumulado != null) {
						float total = new Float(acumulado.get("total").toString()).floatValue();
						if (log.isDebugEnabled()) log.debug("Total " + total);
						//Comentado EBV-..28/02/2006 -- Se insertan todos los movientos que se tienen para ese periodo.
						if (total > 0) {
							if (log.isDebugEnabled()) log.debug("DIARIO : " + mov.getDescrip()+ " - Total : " + total);
							//EBV 16/05/2006 Se Redondean los montos
							total = Math.round(total);
							if (log.isDebugEnabled()) log.debug("RESUMEN REDONDEO : " + mov.getDescrip()+ " - Total : " + total);
							diarioDAO.insertByCodPersPeriodoMov(dbpool,codPers, periodo, fReal, codUO, mov.getMov().trim(), total, usuario);
						}
						acumulado.put("total", "0");
						acumulados.put(mov.getMov(), acumulado);
					}
				} //for registro diario
				
				if (fReal.indexOf("/")>3){ 
					fReal = fReal.substring(8,10) + "/" + fReal.substring(5,7) + "/" + fReal.substring(0,4) ;
				}
				
				fReal =  Utiles.dameFechaSiguiente(fReal, 1);
				fAct = Utiles.toYYYYMMDD(fReal);
			}

			//aqui debemos validar el tema de la tardanza efectiva
			HashMap acumTardCDesc = (HashMap) acumPeriodo.get(Constantes.MOV_TARDANZA_CON_DESCUENTO);
			HashMap acumTardSDesc = (HashMap) acumPeriodo.get(Constantes.MOV_TARDANZA_SIN_DESCUENTO);
			
			//T99DAO codigoDAO = new T99DAO();
			String minutosSinDesc = codigoDAO.findParamByCodTabCodigo(dbpool,
					Constantes.CODTAB_PARAMETROS_ASISTENCIA,
					Constantes.MINUTOS_SIN_DESCUENTO);
			int minSinDesc = minutosSinDesc != null ? Integer.parseInt(minutosSinDesc) : 0;
			
			if (log.isDebugEnabled()) log.debug("minSinDesc : "+minSinDesc);
			
			float tTardanzaCDesc = new Float(acumTardCDesc.get("total").toString()).floatValue();
			if (log.isDebugEnabled()) log.debug("tTardanzaCDesc : "+tTardanzaCDesc);
			float tTardanzaSDesc = new Float(acumTardSDesc.get("total").toString()).floatValue();
			if (log.isDebugEnabled()) log.debug("tTardanzaSDesc : "+tTardanzaSDesc);
			boolean bTardanza = (tTardanzaSDesc + tTardanzaCDesc) > minSinDesc;
			if (log.isDebugEnabled()) log.debug("bTardanza : "+bTardanza);
			
			//si el trabajador sobrepaso el limite de minutos, se actualiza el detalle del resumen diario
			if (bTardanza){
				
				fAct = fIni;
				fReal = fechaIni;
				if (fReal.indexOf("/")>3){ 
					fReal = fReal.substring(8,10) + "/" + fReal.substring(5,7) + "/" + fReal.substring(0,4) ;
				}
				
				acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_TARDANZA_EFECTIVA);
				float totPer1 = new Float("0").floatValue();
				acumPer.put("total", "" + (totPer1));
				acumPeriodo.put(Constantes.MOV_TARDANZA_EFECTIVA, acumPer);
				
				//recorremos todos los dias del periodo 
				while (fAct.compareTo(fFin) <= 0) {
					
					if (log.isDebugEnabled()) log.debug("fReal : "+fReal);
					
					//obtenemos el turno del trabajador para la fecha en proceso
					turno = turnoDAO.joinWithT45ByCodFecha(dbpool, codPers, fReal);
					
					//14/01/2009
					if (turno!=null) {

						float minTardanza = 0;
						float tTardCDesc = diarioDAO.findDescuentoDiarioMovimiento(
								dbpool, codPers, fReal, Constantes.MOV_TARDANZA_EFECTIVA);

						if (log.isDebugEnabled()) log.debug("Recalculando tTardCDesc : "+tTardCDesc);

						if (tTardCDesc>0){
							minTardanza = turno.getTolera()+tTardCDesc;
						}
						else{
							//EBV - 16/12/2008
							float tTardConDesc = diarioDAO.findDescuentoDiarioMovimiento(
									dbpool, codPers, fReal, Constantes.MOV_TARDANZA_CON_DESCUENTO);
							if (tTardConDesc==turno.getTolera()){
								minTardanza = turno.getTolera()+tTardCDesc;	
							}
							if (log.isDebugEnabled()) log.debug("Recalculando minTardanza : "+minTardanza);
							//

							float tTardSDesc = diarioDAO.findDescuentoDiarioMovimiento(
									dbpool, codPers, fReal, Constantes.MOV_TARDANZA_SIN_DESCUENTO);
							if (tTardSDesc>0) minTardanza = tTardSDesc;

							if (log.isDebugEnabled()) log.debug("Recalculando tTardSDesc : "+tTardSDesc);
						}

						if (log.isDebugEnabled()) log.debug("Recalculando minTardanza : "+minTardanza);

						if (minTardanza>0){

							//acumulamos a los minutos del movimiento 98 los minutos de tolerancia del turno para ese dia
							boolean hayMinTardEfect = diarioDAO.updateTardanzaEfectiva(
									dbpool,
									codPers, 
									periodo, 
									fReal, 
									Constantes.MOV_TARDANZA_EFECTIVA, 
									minTardanza);

							if (log.isDebugEnabled()) log.debug("hayMinTardEfect : "+hayMinTardEfect);

							if (!hayMinTardEfect){
								diarioDAO.insertByCodPersPeriodoMov(
										dbpool,
										codPers, 
										periodo, 
										fReal, 
										codUO, 
										Constantes.MOV_TARDANZA_EFECTIVA, 
										minTardanza, 
										usuario);
							}

							//actualizamos el acumulado en el acumPeriodo el total del movimiento 98
							acumPer = (HashMap) acumPeriodo.get(Constantes.MOV_TARDANZA_EFECTIVA);
							float totPer = new Float(acumPer.get("total").toString()).floatValue();
							acumPer.put("total", "" + (totPer + minTardanza));
							acumPeriodo.put(Constantes.MOV_TARDANZA_EFECTIVA, acumPer);						
						}

					}
					
					if (fReal.indexOf("/")>3){ 
						fReal = fReal.substring(8,10) + "/" + fReal.substring(5,7) + "/" + fReal.substring(0,4) ;
					}
					
					fReal =  Utiles.dameFechaSiguiente(fReal, 1);
					fAct = Utiles.toYYYYMMDD(fReal);					
				}
			}
			
			
			//registramos el resumen del periodo del trabajador
			for (int k = 0; k < movimientos.size(); k++) {
			
				BeanTipoMovimiento mov = (BeanTipoMovimiento) movimientos.get(k);
				HashMap acumulado = (HashMap) acumPeriodo.get(mov.getMov().trim());
				
				if (acumulado != null) {
					
					float total = new Float(acumulado.get("total").toString()).floatValue();
					
					//Comentado EBV-..28/02/2006 -- Se insertan todos los movientos que se tienen para ese periodo.
					if (total > 0) {
						if (log.isDebugEnabled()) log.debug("RESUMEN : " + mov.getDescrip()+ " - Total : " + total);
						//EBV 16/05/2006 Se Redondean los montos
						total = Math.round(total);
						if (log.isDebugEnabled()) log.debug("RESUMEN REDONDEO : " + mov.getDescrip()+ " - Total : " + total);
						resumenDAO.insertByCodPersPeriodoMov(dbpool, codPers,periodo, codUO, mov.getMov().trim(),total,usuario);
					}
					acumulado.put("total", "0");
					acumPeriodo.put(mov.getMov(), acumulado);
				}
			} //for registro mensual

			
		} catch (Exception e) {
			log.fatal("Error en el proceso del trabajador "+codPers+" : " + e.getMessage(),e);						
			throw new RemoteException(e.toString());
		}
		return res;
	}
	//
	
	//ICAPUNAY 31/01/2013 AOM 06A4T11 LABOR EXCEPCIONAL Y COMPENSACIONES
	/**
	 * Metodo encargado de procesar la acumulaci?e horas de labor excepcional por grupo de colaboradores
	 * @param mapa HashMap 
	 * @param usuario String 
	 * @return res boolean
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public boolean procesarLaborExcepcional_interfaz(HashMap mapa, String usuario) throws RemoteException {

		if(log.isDebugEnabled())log.debug("ProcesoFacade - procesarLaborExcepcional_interfaz - mapa: " + mapa);
		if(log.isDebugEnabled())log.debug("ProcesoFacade - procesarLaborExcepcional_interfaz - usuario: " + usuario);
		
		boolean res = false;		
	    String id = (String) mapa.get("messageID");
		String dbpool = (String) mapa.get("dbpool");
		try {

			super.creaLog(id, "PROCESO GENERAL DE ACUMULACION DE HORAS EXTRAS", usuario);
			//String dbpool = (String) mapa.get("dbpool");
			String regimen = (String) mapa.get("regimen");
			String criterio = (String) mapa.get("criterio");
			String valor = (String) mapa.get("valor");
			String fechaIni = (String) mapa.get("fechaIni");
			String fechaFin = (String) mapa.get("fechaFin");
			String codPers = (String) mapa.get("codPers");			
			HashMap seguridad = (HashMap) mapa.get("seguridad");
						
			HoraExtraFacadeHome spHoraExtraFacadeHome = (HoraExtraFacadeHome) sl.getRemoteHome(
					HoraExtraFacadeHome.JNDI_NAME,	HoraExtraFacadeHome.class);
			HoraExtraFacadeRemote spHoraExtraFacadeRemote;
			
			pe.gob.sunat.rrhh.dao.T12DAO t12dao = new pe.gob.sunat.rrhh.dao.T12DAO("jdbc/dcsp");
			Map mProceso = new HashMap();
			mProceso.put("dbpool", dbpool);	
			mProceso.put("regimen", regimen);			
			mProceso.put("fechaIni", fechaIni);
			mProceso.put("fechaFin", fechaFin);
			mProceso.put("codPers", codPers);
			mProceso.put("usuario", usuario);
			mProceso.put("seguridad", seguridad);
			
			if (criterio.equals("0") || criterio.equals("1") ){//0=registro,1=uuoo
				if(log.isDebugEnabled()) log.debug("entro a registro u uuoo");
				mProceso.put("criterio", criterio);
				mProceso.put("valor", valor.trim().toUpperCase());
				spHoraExtraFacadeRemote = spHoraExtraFacadeHome.create();
				if(log.isDebugEnabled()) log.debug("Llamando a procesarLaborExcepcional-HoraExtraFacade(registro u uuoo): "+mapa);				
				spHoraExtraFacadeRemote.procesarLaborExcepcional((HashMap)mProceso,usuario);
				
			}else{//4=inten y 3=institu
				if(log.isDebugEnabled()) log.debug("entro a intend e institu");
				Map prms=new HashMap();	
				Map mUniOrg = new HashMap();//mapa de unidad organizacional
				prms.put("orden", "1");				
				if (criterio.equals("4")){
					prms.put("criterio", "0");//por t12cod_uorga
					prms.put("valor", valor.substring(0,2));//4E
				}else{//3=institu
					prms.put("valor", "");
					prms.put("criterio", "");
				}
				if(log.isDebugEnabled()) log.debug("prms(intend e institu): "+prms);
				List listaUnidades=  t12dao.findByCodDesc(prms);
				if(log.isDebugEnabled()) log.debug("listaUnidades(intend e institu): "+listaUnidades);
				if (listaUnidades!=null && listaUnidades.size()>0){
					for (int i = 0; i < listaUnidades.size(); i++) {
						mUniOrg = (Map)listaUnidades.get(i);						
						valor = mUniOrg.get("t12cod_uorga").toString();//CODIGO DE UNIDAD ORGANIZACIONAL A PROCESAR	
						mProceso.put("criterio", "1");//por unidad organizacional
						mProceso.put("valor", valor.trim().toUpperCase());
						
						spHoraExtraFacadeRemote = spHoraExtraFacadeHome.create();
						if(log.isDebugEnabled()) log.debug("Llamando a procesarLaborExcepcional-HoraExtraFacade(intend e institu): "+mapa);						
					    if(log.isDebugEnabled()) log.debug("**** PROCESANDO LABOR EXCEPCIONAL PARA LA UNIDAD : "+valor+" ****");	
						spHoraExtraFacadeRemote.procesarLaborExcepcional((HashMap)mProceso,usuario);
					}
				}				
			}			
			
			res = true;
			
		} catch (Exception e){			
			res = false;
			log.error(e.toString());		
		} finally {
			try {
				//registramos el log del proceso
				super.registraLog(dbpool, mapa, usuario);
			} catch (Exception e) {
				res = false;
				log.error(e.toString());
			}
		}
		return res;
	}
	//FIN ICAPUNAY 31/01/2013 AOM 06A4T11 LABOR EXCEPCIONAL Y COMPENSACIONES
	
	//ICAPUNAY 09/04/2012 AOM 06A4T11 LABOR EXCEPCIONAL Y COMPENSACIONES-PAS20124E550000064
	/**
	 * Metodo encargado de procesar la acumulaci?e horas de labor excepcional por grupo de colaboradores
	 * @param mapa HashMap 
	 * @param usuario String 
	 * @return res boolean
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public boolean procesarLaborExcepcional(HashMap mapa, String usuario) throws RemoteException {

		if(log.isDebugEnabled())log.debug("ProcesoFacade - procesarLaborExcepcional - mapa: " + mapa);
		if(log.isDebugEnabled())log.debug("ProcesoFacade - procesarLaborExcepcional - usuario: " + usuario);
		
		boolean res = false;		
	    String id = (String) mapa.get("messageID");
		String dbpool = (String) mapa.get("dbpool");
		try {

			Map beanPersona = null;				
			int trabIni = Integer.parseInt((String) mapa.get("limiteInferior"));
			int trabFin = Integer.parseInt((String) mapa.get("limiteSuperior"));
						
			super.creaLog(id, "PROCESO DE ACUMULACION DE HORAS EXTRAS", usuario);

			DataSource dcsp = ServiceLocator.getInstance().getDataSource("java:comp/env/jdbc/dcsp");
			pe.gob.sunat.rrhh.dao.T02DAO t02dao = new pe.gob.sunat.rrhh.dao.T02DAO(dcsp);
			if(log.isDebugEnabled())log.debug("ProcesoFacade - procesarLaborExcepcional - mapa2: " + mapa);			
			List listaPersonal = t02dao.buscarPersonal_labor(mapa);
			log.debug("listaPersonal: "+ listaPersonal);
			
			for (int j = trabIni; j <= trabFin; j++) {					
				if (j<listaPersonal.size()){
					beanPersona = null;//add ICR 20/12
					beanPersona = new HashMap();//add ICR 20/12
					beanPersona = (HashMap) listaPersonal.get(j);					
					if(log.isDebugEnabled())log.debug("ProcesoFacade - procesarLaborExcepcional - beanPersona: " + beanPersona);
					mapa.put("colaborador", beanPersona);
					
					procesarLaborExcepcionalTrabajador(mapa);					
				}
			}//fin for rango de trabajadores			
			res = true;
			
		} catch (Exception e){			
			res = false;
			log.error(e.toString());		
		} finally {
			try {
				//registramos el log del proceso
				super.registraLog(dbpool, mapa, usuario);
			} catch (Exception e) {
			}
		}
		return res;
	}
	
	/**
	 * Metodo encargado de procesar la acumulacion horas de labor excepcional de cada colaborador segun rango de fechas	
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @param mapa Map 
	 * @return res boolean
	 * @throws FacadeException
	 */
	public boolean procesarLaborExcepcionalTrabajador(Map mapa) throws RemoteException {		
	
		if (log.isDebugEnabled()) log.debug("procesarLaborExcepcionalTrabajador - mapa: " + mapa);		
		DataSource dgsp = sl.getDataSource("java:comp/env/jdbc/dgsp");	
		String dbpool = (String) mapa.get("dbpool");				
				
		String usuario = mapa.get("usuario").toString().trim();//codigo del usuario logueado	
		
		//parametros base: colaborador y rangos de fechas
		Map colaborador1 = null; //mapa del colaborador a procesar
		colaborador1 = new HashMap(); //mapa del colaborador a procesar	
		String regimen="";
		String registro="";
		String uuoo="";
		String nombres="";
		colaborador1 = (Map) mapa.get("colaborador"); //mapa del colaborador a procesar			
		String regimen1 = colaborador1.get("t02cod_rel")!=null?(!colaborador1.get("t02cod_rel").toString().equals("")?(colaborador1.get("t02cod_rel").toString().equals("09")?"DL. 1057":colaborador1.get("t02cod_rel").toString().equals("10")?"MOD. FORM":"DL. 276-728"):""):"";//regimen del colaborador (09=cas,10=mf y el resto planilla 01,02,etc)
		if (log.isDebugEnabled()) log.debug("regimen1("+registro+"): " + regimen1);				
		String registro1 = colaborador1.get("t02cod_pers")!=null?colaborador1.get("t02cod_pers").toString().trim():"";//registro del colaborador
		if (log.isDebugEnabled()) log.debug("registro1: " + registro1);					
		String uuoo1 = colaborador1.get("t02cod_uorg")!=null?colaborador1.get("t02cod_uorg").toString().trim():"";//uuoo del colaborador
		if (log.isDebugEnabled()) log.debug("uuoo1("+registro+"): " + uuoo1);		
		String nombres1 = (colaborador1.get("t02ap_pate")!=null?colaborador1.get("t02ap_pate").toString():"")+" "+(colaborador1.get("t02ap_mate")!=null?colaborador1.get("t02ap_mate").toString():"")+" "+(colaborador1.get("t02nombres")!=null?colaborador1.get("t02nombres").toString():"");//registro del colaborador
		String fechaIni = (String) mapa.get("fechaIni"); //fecha de inicio a procesar del colaborador (dd/MM/yyyy)
		if (log.isDebugEnabled()) log.debug("fechaIni("+registro+"): " + fechaIni);
		String fechaFin = (String) mapa.get("fechaFin"); //fecha de fin a procesar del colaborador
		if (log.isDebugEnabled()) log.debug("fechaFin("+registro+"): " + fechaFin);
		//fin parametros base: trabajador y rangos de fechas
		
		boolean res = true;		
		String texto="";
		String error="";
		String fechaEval = "";
		String fechaAntes = "";
		String horaIniTurnoDw = "";
		String horaFinTurnoDw = "";
		String horaIniTurnoDx = "";
		String horaFinTurnoDx = "";
		ArrayList marcaciones= new ArrayList();
		
		String fecha_ingreso = "";
		Map mapaVacaGen = new HashMap();		
		BeanHoraExtra bhe = null;		
		int nroNoAut = 0; //numero de intervalos de compensacion no autorizados "x fecha"
		int nroAut = 0; //numero de intervalos de compensacion autorizados "x rangos de fechas" del colaborador
			
		List listaNoAut = new ArrayList(); //lista provisional de intervalos de compensacion no autorizados "x fecha" (Antes null)
		List listaAut = new ArrayList(); //lista provisional de intervalos de compensacion autorizados "x fecha"
		List listaRech = new ArrayList(); //lista provisional de intervalos de compensacion rechazados "x fecha"
		List listaTotalAut = new ArrayList(); //lista provisional de intervalos de compensacion autorizados "x rangos de fecha"
		boolean autogenerar = true; //ICAPUNAY-PAS20145E230000109-No generar Sol Autogen cuando no hay turno
			
		try {			
			T4819DAO compensacionesDAO = new T4819DAO(dgsp);				
			pe.gob.sunat.sp.asistencia.dao.T1456DAO reingresoDAO = new pe.gob.sunat.sp.asistencia.dao.T1456DAO();						
			T01DAO paramDAO = new T01DAO();
			T1270DAO turnoDAO = new T1270DAO();			
			T1275DAO marcacionDAO = new T1275DAO();
			T99DAO t99SpDAO = new T99DAO();
			T1608DAO recuperaDAO = new T1608DAO(dbpool);//ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100


			//Validando que cada fecha del rango de fechas sea mayor o igual que fecha de ingreso/reingreso					
			mapaVacaGen = reingresoDAO.findFechaReingreso(dbpool,registro1);
			if (log.isDebugEnabled()) log.debug("mapaVacaGen("+registro+"): " + mapaVacaGen);
			if (mapaVacaGen!=null && mapaVacaGen.get("fecha")!=null && !mapaVacaGen.get("fecha").toString().equals("")){
				if (log.isDebugEnabled()) log.debug("mapaVacaGen.get(fecha)("+registro+"): " + mapaVacaGen.get("fecha"));
				fecha_ingreso = mapaVacaGen.get("fecha").toString();
				if (log.isDebugEnabled()) log.debug("fecha_ingreso reingreso("+registro+"): "+fecha_ingreso);
			} else {
				if (log.isDebugEnabled()) log.debug("colaborador.get(t02f_ingsun)("+registro+"): " + colaborador1.get("t02f_ingsun"));
				fecha_ingreso = Utiles.dateToString((Date)colaborador1.get("t02f_ingsun"));
				if (log.isDebugEnabled()) log.debug("fecha_ingreso sunat("+registro+"): "+fecha_ingreso);
			}
			if (log.isDebugEnabled()) log.debug("fecha_ingreso final("+registro+"): "+fecha_ingreso);	
			
			//tiempo minimo de labor excepcional antes de la hora de entrada y/o despues de la hora de salida
			String labex = t99SpDAO.findParamByCodTabCodigo(dbpool,Constantes.CODTAB_PARAMETROS_ASISTENCIA,Constantes.MINUTOS_LABOR_EXCEPCIONAL);
			int minLabExc = labex != null ? Integer.parseInt(labex) : 0;
			log.debug("minLabExc: " + ""+minLabExc);
			//		
			
			Map mdatos = new HashMap();
			Map mdatosAut = new HashMap();			
			Map ale = new HashMap();		

			int numDias = Utiles.obtenerDiasDiferencia(fechaIni, fechaFin);//30/03/2012 - 05/04/2012 (6 dias)
			if (log.isDebugEnabled()) log.debug("numDias("+registro+"): " + numDias);
			for (int i = 0; i <= numDias; i++) {//i=0 to 6
				
				//add ICR 20/12
				if (i==0){
					Map colaborador = null; //mapa del colaborador a procesar
					colaborador = new HashMap(); //mapa del colaborador a procesar					
					colaborador = (Map) mapa.get("colaborador"); //mapa del colaborador a procesar
					regimen="";
					registro="";
					uuoo="";
					nombres="";
					regimen = colaborador.get("t02cod_rel")!=null?(!colaborador.get("t02cod_rel").toString().equals("")?(colaborador.get("t02cod_rel").toString().equals("09")?"DL. 1057":colaborador.get("t02cod_rel").toString().equals("10")?"MOD. FORM":"DL. 276-728"):""):"";//regimen del colaborador (09=cas,10=mf y el resto planilla 01,02,etc)
					if (log.isDebugEnabled()) log.debug("regimen("+registro+"): " + regimen);				
					registro = colaborador.get("t02cod_pers")!=null?colaborador.get("t02cod_pers").toString().trim():"";//registro del colaborador
					if (log.isDebugEnabled()) log.debug("registro: " + registro);					
					uuoo = colaborador.get("t02cod_uorg")!=null?colaborador.get("t02cod_uorg").toString().trim():"";//uuoo del colaborador
					if (log.isDebugEnabled()) log.debug("uuoo("+registro+"): " + uuoo);		
					nombres = (colaborador.get("t02ap_pate")!=null?colaborador.get("t02ap_pate").toString():"")+" "+(colaborador.get("t02ap_mate")!=null?colaborador.get("t02ap_mate").toString():"")+" "+(colaborador.get("t02nombres")!=null?colaborador.get("t02nombres").toString():"");//registro del colaborador
					if (log.isDebugEnabled()) log.debug("nombres("+registro+"): " + nombres);		
					
					mdatos= null;
					mdatos= new HashMap();
					mdatos.put("listaTotalAut",listaTotalAut);
					mdatos.put("regimen",regimen);
					mdatos.put("registro",registro);
					mdatos.put("uuoo",uuoo);
					mdatos.put("nombres",nombres);
					mdatos.put("usuario",usuario);
					mdatos.put("fechaIni",fechaIni);
					mdatos.put("fechaFin",fechaFin);
					mdatos.put("fecha_ingreso",fecha_ingreso);
					mdatos.put("dbpool",dbpool);		
					mdatos.put("minLabExc",minLabExc+"");
					
					mdatosAut = null;
					mdatosAut= new HashMap();
					mdatosAut.put("regimen",regimen);
					mdatosAut.put("registro",registro);
					mdatosAut.put("uuoo",uuoo);
					mdatosAut.put("nombres",nombres);
					mdatosAut.put("usuario",usuario);
					mdatosAut.put("fechaIni",fechaIni);
					mdatosAut.put("fechaFin",fechaFin);					
					mdatosAut.put("dbpool",dbpool);					
				}										
				ale= null;
				ale= new HashMap();	
				//fin add ICR 20/12
				
				mdatos.put("i",i+"");	
				listaNoAut = new ArrayList();//lista provisional de NO autorizados x fecha	
				listaAut = new ArrayList();//lista provisional de autorizados x fecha
				listaRech = new ArrayList();//lista provisional de rechazados x fecha
				mdatos.put("listaNoAut",listaNoAut);
				mdatos.put("listaAut",listaAut);
				mdatos.put("listaRech",listaRech);						
				fechaEval = Utiles.dameFechaSiguiente(fechaIni, i);
				mdatos.put("fechaEval",fechaEval);
				nroNoAut = 0;//nro de no autorizados insertado x fecha
				autogenerar = true; //ICAPUNAY-PAS20145E230000109-No generar Sol Autogen cuando no hay turno
				if (log.isDebugEnabled()) log.debug("autogenerar: "+autogenerar);
				
				//ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100
				Integer nuevoSaldo = new Integer(0); //ICR-19/06/2014
				Map datoss = new HashMap(); //ICR-19/06/2014
				boolean eliminados2 = false;  //ICR-19/06/2014
				boolean eliminados = false; //si elimino todos los intervalos de compensacion existentes 
				boolean noControlado = false; 
				BeanTurnoTrabajo turnoNoControlado = null;
				BeanTurnoTrabajo turnoNoControl1 = turnoDAO.joinWithT45ByCodPersFecha_NoControlado_OperAdm1dia(dbpool,registro,fechaEval);
				if (turnoNoControl1!=null){
					turnoNoControlado=turnoNoControl1;					    
				}else{
					BeanTurnoTrabajo turnoNoControl2 = turnoDAO.joinWithT45ByCodPersFecha_NoControlado_Oper2dias(dbpool,registro,fechaEval);
					turnoNoControlado=turnoNoControl2;				    
				}
				if (log.isDebugEnabled()) log.debug("turnoNoControlado("+fechaEval+"): " + "("+registro+"): "+turnoNoControlado);
				
				String codTurno="";
				if (turnoNoControlado!=null){
					noControlado=true; //ICAPUNAY-PAS20145E230000109-No generar Sol Autogen para turnos no controlados
					codTurno = turnoNoControlado.getTurno().toString().trim();
					if (log.isDebugEnabled()) log.debug("codTurno("+fechaEval+"): " + "("+registro+"): "+codTurno);
					if (codTurno.equals("R67")){
						noControlado=true;
						Map mFecPerm = compensacionesDAO.findFechaPermanenciaExtra(registro,fechaEval);//fechaEval='07/08/2013 (NI21)'
						if (mFecPerm!=null && !mFecPerm.isEmpty()){
							eliminados = compensacionesDAO.deleteAllIntervalosCompensacionesByCodPersByFecPerm(registro,fechaEval);														
							if (eliminados==true){						
								error = "Se elimino bolsa de labor (autorizada, no autorizada, rechazada con saldo igual a lo acumulado) de la fecha: "+fechaEval+ " por tener actualmente para dicha fecha turno NO CONTROLADO :"+codTurno;
								texto = regimen + " " + registro + " " + nombres + "  " + error;
								if (log.isDebugEnabled()) log.debug("eliminados("+registro+"): " + eliminados+" de bolsa labor (autorizada, no autorizada, rechazada con saldo igual a lo acumulado) de la fecha: "+fechaEval+" por tener actualmente para dicha fecha turno NO CONTROLADO :"+codTurno);
								super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);	
							}
							//ICR-19/06/2014
							datoss.put("saldo", nuevoSaldo);
							datoss.put("usuario_mod", "R67");
							datoss.put("cod_pers", registro);
							datoss.put("fec_perm", fechaEval);
							eliminados2 = compensacionesDAO.updateSaldos(datoss);
							if (eliminados2==true){						
								error = "Se actualizo a 0 labor autorizada con saldo diferente a lo acumulado de la fecha: "+fechaEval+ " por tener actualmente para dicha fecha turno NO CONTROLADO :"+codTurno;
								texto = regimen + " " + registro + " " + nombres + "  " + error;
								if (log.isDebugEnabled()) log.debug("eliminados2("+registro+"): " + eliminados2+" Se actualizo a 0 labor autorizada con saldo diferente a lo acumulado de la fecha: "+fechaEval+" por tener actualmente para dicha fecha turno NO CONTROLADO :"+codTurno);
								super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);	
							}
							//FIN ICR-19/06/2014

						}								
					}
				}
				if(noControlado==false){	
				//FIN ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100

					log.debug("noControlado("+registro+"-"+fechaEval+"): "+noControlado);
					res = validarLaborExcepcional(mdatos);
					log.debug("res("+registro+"-"+fechaEval+"): "+res);
					if(res==true){					
	
						//BeanTurnoTrabajo turno = turnoDAO.joinWithT45ByCodFecha(dbpool,registro,fechaEval);	//ICAPUNAY 05/10/2012 AJUSTES AOM 06A4T11 LABOR EXCEPCIONAL
						BeanTurnoTrabajo turnoDx = null;		   	    
						BeanTurnoTrabajo turno1 = turnoDAO.joinWithT45ByCodPersFecha_Controlado_OperAdm1dia(dbpool,registro,fechaEval);		    
						if (turno1!=null){
							turnoDx=turno1;					    
						}else{
							BeanTurnoTrabajo turno2 = turnoDAO.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,registro,fechaEval);
							turnoDx=turno2;				    
						}
						if (log.isDebugEnabled()) log.debug("turnoDx("+fechaEval+"): " + "("+registro+"): "+turnoDx);
	
						//if (tieneLE==false){//solo se generara LE si "no existe LE para la fecha en analisis" o "no existe LE para la fecha ya que se elimino la LE para la fecha ya que su acumulado era igual a su actual(no fue usado todavia)"
						boolean diaEspecial=false;
						boolean diaLaborable=false;
						boolean diaOperativo=false;			
						String tipoProceso="";						
						if (turnoDx!=null){
							if (log.isDebugEnabled()) log.debug("INGRESO 1");
							horaIniTurnoDx = turnoDx.getHoraIni().trim();
							horaFinTurnoDx = turnoDx.getHoraFin().trim();
							if (log.isDebugEnabled()) log.debug("horaIniTurnoDx("+registro+"): " + horaIniTurnoDx);
							if (log.isDebugEnabled()) log.debug("horaFinTurnoDx("+registro+"): " + horaFinTurnoDx);  
							if(horaFinTurnoDx.trim().compareTo(horaIniTurnoDx.trim())>0){								
								//marcaciones = marcacionDAO.findByCodPersFechaRangosHoras(dbpool, registro, fechaEval,"00:00:00","23:59:59");
								if (log.isDebugEnabled()) log.debug("registro("+registro+"): turno 1 dia (ADM U OPE) (marcaciones PARES requiere para dia x)");
								marcaciones = marcacionDAO.findByCodPersFecha(dbpool, registro, fechaEval);
								if (marcaciones!=null && marcaciones.size()>0){
									if (log.isDebugEnabled()) log.debug("marcaciones ope o adm 1 dia("+registro+"): " + marcaciones);//icr
									if (marcaciones.size()%2==0) { //si numero de marcaciones es par
										mdatos.put("tipo","1dia");
										mdatos.put("inicio","00:00:00");
										mdatos.put("fin","23:59:59");
										//Para ADM Si la fecha es sabado, domingo o es feriado se considera como Dia Especial (no tiene turno de trabajo)
										if (!turnoDx.isOperativo()){//adm
											diaEspecial = Utiles.isDiaSemana(fechaEval, Constantes.SABADO) || Utiles.isDiaSemana(fechaEval, Constantes.DOMINGO) || paramDAO.findByFechaFeriado(dbpool, fechaEval);//21/05/2012 no acumular si coincide fecha con licencia o vacaciones
											//ICAPUNAY-PAS20145E230000172-generar Sol Autogen cuando hay turno administrativo (no incluye fds ni feriado)
											//autogenerar=false; 
											if (diaEspecial){
												autogenerar=false;
												if (log.isDebugEnabled()) log.debug("autogenerar(adm-diaEspecial): "+autogenerar);
											}
											//FIN ICAPUNAY-PAS20145E230000172-generar Sol Autogen cuando hay turno administrativo (no incluye fds ni feriado)

										}
										if (!diaEspecial){
											diaLaborable=true;										
										}		    		
									}	
								}																
							}else{								
								if (log.isDebugEnabled()) log.debug("registro("+registro+"): turno 2 dias (OPE)");
								if (turnoDx.isOperativo()){										
									fechaAntes = Utiles.dameFechaAnterior(fechaEval, 1);	    		   
									BeanTurnoTrabajo turnoDw = turnoDAO.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,registro,fechaAntes); //dia (x-1)	    		 
									if (log.isDebugEnabled()) log.debug("turno dia x-1 (turnoDw)("+registro+"): " + turnoDw);					    		    
									if (turnoDw!=null){					    		    	
										if (log.isDebugEnabled()) log.debug("registro("+registro+"): SI tiene turno (dia x-1) de 2 dias y SI tiene turno dia x de 2 d涌 (marcaciones PARES requiere para dia x)");
										horaIniTurnoDw = turnoDw.getHoraIni().trim();
										horaFinTurnoDw = turnoDw.getHoraFin().trim();
										if (log.isDebugEnabled()) log.debug("horaIniTurnoDw("+registro+"): " + horaIniTurnoDw);
										if (log.isDebugEnabled()) log.debug("horaFinTurnoDw("+registro+"): "+ horaFinTurnoDw); 					    		    	
										//marcaciones = marcacionDAO.findByCodPersFechaRangosHoras(dbpool, registro, fechaEval,horaFinTurnoDw,horaIniTurnoDx);
										marcaciones = marcacionDAO.findByCodPersFecha(dbpool, registro, fechaEval);
										if (marcaciones!=null && marcaciones.size()>0){
											if (log.isDebugEnabled()) log.debug("marcaciones2 ope 2 dias("+registro+"): " + marcaciones);
											if (marcaciones.size()%2==0){
												diaOperativo=true;
												mdatos.put("tipo","2dia");
												tipoProceso="intermedio";// PARES requiere
												mdatos.put("inicio",horaFinTurnoDw);
												mdatos.put("fin",horaIniTurnoDx);												
											}
										}	
									}else{	
										if (log.isDebugEnabled()) log.debug("registro ("+registro+"): NO tiene turno (dia x-1) de 2 dias y SI tiene turno dia x de 2 d涌 (marcaciones IMPARES requiere para dia x)");					    		    	
										//marcaciones = marcacionDAO.findByCodPersFechaRangosHoras(dbpool, registro, fechaEval,"00:00:00",horaIniTurnoDx);
										marcaciones = marcacionDAO.findByCodPersFecha(dbpool, registro, fechaEval);
										if (marcaciones!=null && marcaciones.size()>0){
											if (log.isDebugEnabled()) log.debug("marcaciones3 ope 2 dias("+registro+"): " + marcaciones);
											if (!(marcaciones.size()%2==0)){
												diaOperativo=true;
												mdatos.put("tipo","2dia");
												tipoProceso="entrada";// IMPARES requiere
												mdatos.put("inicio","00:00:00");
												mdatos.put("fin",horaIniTurnoDx);
											}
										}	
									}							
									mdatos.put("tipoProceso",tipoProceso);									
								}												
							}	   
	
						}//fin turnoDx!=null
						else{
							if (log.isDebugEnabled()) log.debug("INGRESO 2");
							autogenerar=false; //ICAPUNAY-PAS20145E230000109-No generar Sol Autogen cuando no hay turno
							if (log.isDebugEnabled()) log.debug("autogenerar2: "+autogenerar);
							fechaAntes = Utiles.dameFechaAnterior(fechaEval, 1);	    		   
							BeanTurnoTrabajo turnoDw = turnoDAO.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,registro,fechaAntes); //dia (x-1)	    		 
							if (log.isDebugEnabled()) log.debug("registro ("+registro+"): No hay turno dia x - turnoDw (turno dia x-1): " + turnoDw);	    		    
							if (turnoDw!=null){
								if (log.isDebugEnabled()) log.debug("registro ("+registro+"): SI tiene turno (dia x-1) de 2 dias y NO tiene turno dia x (marcaciones IMPARES requiere para dia x)");			    		    
								horaIniTurnoDw = turnoDw.getHoraIni().trim();
								horaFinTurnoDw = turnoDw.getHoraFin().trim();
								if (log.isDebugEnabled()) log.debug("horaIniTurnoDw2("+registro+"): " + horaIniTurnoDw);
								if (log.isDebugEnabled()) log.debug("horaFinTurnoDw2("+registro+"): " + horaFinTurnoDw); 
								//marcaciones = marcacionDAO.findByCodPersFechaRangosHoras(dbpool, registro, fechaEval,horaFinTurnoDw,"23:59:59");//nuevo turno o ajustar fecha fin de turno
								marcaciones = marcacionDAO.findByCodPersFecha(dbpool, registro, fechaEval);
								if (marcaciones!=null && marcaciones.size()>0){
									if (!(marcaciones.size()%2==0)) { //si numero de marcaciones es impar
										diaOperativo=true;
										mdatos.put("tipo","2dia");
										tipoProceso="salida";// IMPARES requiere
										mdatos.put("inicio",horaFinTurnoDw);
										mdatos.put("fin","23:59:59");
										mdatos.put("tipoProceso",tipoProceso);										
									}	    		    		
								}			    		    	
							}else{
								if (log.isDebugEnabled()) log.debug("registro ("+registro+"): NO tiene turno (dia x-1) y NO tiene turno dia x (marcaciones PARES requiere para dia x)");			    		    	
								//marcaciones = marcacionDAO.findByCodPersFechaRangosHoras(dbpool, registro, fechaEval,"00:00:00","23:59:59");
								marcaciones = marcacionDAO.findByCodPersFecha(dbpool, registro, fechaEval);
								if (marcaciones!=null && marcaciones.size()>0){
									if (log.isDebugEnabled()) log.debug("marcaciones4 ope 2 dias("+registro+"): " + marcaciones);
									if (marcaciones.size()%2==0) { //si numero de marcaciones es par			    		    		
										diaEspecial=true;
										//ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100
										mdatos.put("tipo","1dia");
										mdatos.put("inicio","00:00:00");
										mdatos.put("fin","23:59:59");
										//FIN ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100
	
									}
								}			    		    	
							}					
						}
	
						bhe = new BeanHoraExtra();
						bhe.setCodPers(registro);
						bhe.setFechaAutorizacion(fechaEval);//dd/MM/yyyy
						if (log.isDebugEnabled()) log.debug("ANALISIS DE HORAS EXTRAS PARA FECHA("+registro+"): " + bhe.getFechaAutorizacion()); //30/03/2012
						if (log.isDebugEnabled()) log.debug("diaEspecial("+registro+"): " + diaEspecial);
						if (diaEspecial==true){// si ES dia especial NO se considera el turno de trabajo
							log.debug("registro ("+registro+"): ES -=Inicio dia especial=-");
							//Seteo de Rango a evaluar para horas extras - RANGO: DIA COMPLETO
							bhe.setHoraIni("00:00:00");
							bhe.setHoraSalida("23:59:59");								
							mdatos.put("bhe",bhe);	
							log.debug("registro ("+registro+"): --diaEspecial(mdatos): "+mdatos);
							ale = acumularLaborExcepcional(mdatos);
							if(ale!=null && !ale.isEmpty()){
								log.debug("registro ("+registro+"): --diaEspecial ale:--"+ale);
								listaNoAut = (List)ale.get("listaNoAut");
								listaRech = (List)ale.get("listaRech");
								listaAut = (List)ale.get("listaAut");
								listaTotalAut = (List)ale.get("listaTotalAut");				    					
							}
							mdatos.put("listaNoAut",listaNoAut);
							mdatos.put("listaAut",listaAut);
							mdatos.put("listaRech",listaRech);
							mdatos.put("listaTotalAut",listaTotalAut);
							ale= null;
							ale= new HashMap();							
							log.debug("registro ("+registro+"): FIN ES -=Inicio dia especial=-");	
						}
	
						if (log.isDebugEnabled()) log.debug("diaLaborable("+registro+"): "+ diaLaborable);						
						if (diaLaborable==true){//diaLaborable (si es diaLaborable SI se considera el turno de trabajo)
							log.debug("registro ("+registro+"): --diaLaborable--");
	
							log.debug("registro ("+registro+"): ES -=Entrada antes de hora=-");
							//Seteo de Rango a evaluar para horas extras - RANGO: ANTES DE LA HORA DE ENTRADA
							bhe.setHoraIni("00:00:00");
							bhe.setHoraSalida(horaIniTurnoDx);//08:30:00									
							mdatos.put("bhe",bhe);	
							log.debug("registro ("+registro+"): --diaLaborable(mdatos-entrada): "+mdatos);
							ale = acumularLaborExcepcional(mdatos);
							if(ale!=null && !ale.isEmpty()){
								log.debug("registro ("+registro+"): --diaLaborable Entrada antes (ale):--"+ale);
								listaNoAut = (List)ale.get("listaNoAut");
								listaRech = (List)ale.get("listaRech");
								listaAut = (List)ale.get("listaAut");
								listaTotalAut = (List)ale.get("listaTotalAut");				    					
							}
							mdatos.put("listaNoAut",listaNoAut);
							mdatos.put("listaAut",listaAut);
							mdatos.put("listaRech",listaRech);
							mdatos.put("listaTotalAut",listaTotalAut);
							ale= null;
							ale= new HashMap();									
							log.debug("registro ("+registro+"): FIN ES -=Entrada antes de hora=-");								
	
							log.debug("registro ("+registro+"): ES -=Salida fuera de hora=-");
							//Seteo de Rango a evaluar para horas extras - RANGO: FUERA DE LA HORA DE SALIDA
							if (horaFinTurnoDx.trim().equals("00:00:00")){//00:00:00 igual a 24 horas o 23:59:59
								horaFinTurnoDx="23:59:59";
							}
	
							//ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100
							Map mapaRecupera = new HashMap();
							mapaRecupera.put("cod_personal", registro);
							mapaRecupera.put("fcompensa", fechaEval);
							Map recuperacion = recuperaDAO.findCompensacionPersonaByPK(mapaRecupera);
							String horaAntigua="";
							if (recuperacion!=null && recuperacion.get("cod_personal")!=null){
								log.debug("recuperacion ("+registro+"): "+ recuperacion);
								if (!horaFinTurnoDx.substring(0,2).trim().equals("23")){//hora <> 23	
									horaAntigua=horaFinTurnoDx;
									//aumentando a la hora final del turno 1 hora por la hora de recuperacion
									String shora = horaFinTurnoDx.substring(0,2); //08 de 08:55:47/13:55:47 
									String sresto = horaFinTurnoDx.substring(2,horaFinTurnoDx.length()); //:55:47
									int hora = Integer.parseInt(shora);
									log.debug("hora("+registro+"): "+hora);
									hora = hora + 1; 
									log.debug("hora("+registro+"): "+hora);
									if (hora < 10){//anteponemos el 0 delante (caso2: 9)
										shora = "0"+String.valueOf(hora)+sresto;// (caso2: 09:55:47)
										log.debug("shora("+registro+"): "+shora);
									}else{
										shora = String.valueOf(hora)+sresto;//14:55:47
										log.debug("shora("+registro+"): "+shora);
									}	
									horaFinTurnoDx=shora;
									log.debug("horaFinTurnoDx nueva("+registro+"): "+ horaFinTurnoDx+" - horaFinTurnoDx anterior: "+horaAntigua);
								
								}else{//hora = 23
									horaFinTurnoDx="23:59:59";
								}
							}
							log.debug("horaFinTurnoDx final("+registro+"): "+ horaFinTurnoDx);
							//FIN ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100
	
							bhe.setHoraIni(horaFinTurnoDx);//16:30:00
							bhe.setHoraSalida("23:59:59");										
							mdatos.put("bhe",bhe);
							log.debug("registro ("+registro+"): --diaLaborable(mdatos-salida): "+mdatos);
							//ale = acumular2LaborExcepcional(mdatos); //ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100
							ale = acumularLaborExcepcional(mdatos); //ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100
							if(ale!=null && !ale.isEmpty()){
								log.debug("registro ("+registro+"): --diaLaborable Salida fuera (ale):--"+ale);
								listaNoAut = (List)ale.get("listaNoAut");
								listaRech = (List)ale.get("listaRech");
								listaAut = (List)ale.get("listaAut");
								listaTotalAut = (List)ale.get("listaTotalAut");				    					
							}
							mdatos.put("listaNoAut",listaNoAut);
							mdatos.put("listaAut",listaAut);
							mdatos.put("listaRech",listaRech);
							mdatos.put("listaTotalAut",listaTotalAut);
							ale= null;
							ale= new HashMap();									
							log.debug("registro ("+registro+"): FIN ES -=Salida fuera de hora=-");													 				    				
						}//fin diaLaborable
	
						if (log.isDebugEnabled()) log.debug("diaOperativo("+registro+"): " + diaOperativo);						
						if (diaOperativo==true){// si ES dia operativo NO se considera el turno de trabajo
							log.debug("registro ("+registro+"): ES -=Inicio dia operativo=-");
							//Seteo de Rango a evaluar para horas extras - RANGO: EL DIA
							if (mdatos.get("inicio")!=null && mdatos.get("fin")!=null){
								bhe.setHoraIni(mdatos.get("inicio").toString());
								bhe.setHoraSalida(mdatos.get("fin").toString());								
								mdatos.put("bhe",bhe);		
								log.debug("registro ("+registro+"): --diaOperativo(mdatos): "+mdatos);
								//ale = acumular2LaborExcepcional(mdatos);ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100
								ale = acumularLaborExcepcional(mdatos);//ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100
								if(ale!=null && !ale.isEmpty()){
									log.debug("registro ("+registro+"): --diaOperativo ale:--"+ale);
									listaNoAut = (List)ale.get("listaNoAut");
									listaRech = (List)ale.get("listaRech");
									listaAut = (List)ale.get("listaAut");
									listaTotalAut = (List)ale.get("listaTotalAut");				    					
								}
								mdatos.put("listaNoAut",listaNoAut);
								mdatos.put("listaAut",listaAut);
								mdatos.put("listaRech",listaRech);
								mdatos.put("listaTotalAut",listaTotalAut);
								ale= null;
								ale= new HashMap();	
							}												
							log.debug("registro ("+registro+"): FIN ES -=Inicio dia operativo=-");	
						}
						//
						//}
						//fin tieneLE==false		    	
					}
					//fin res==true (validacion OK)
				}//ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100 (add })	

				if (log.isDebugEnabled()) log.debug("autogenerar3: "+autogenerar);
				if (autogenerar==true){
					log.debug("registro ("+registro+"): inicio de insertar intervalos de compensacion NO AUTORIZADOS"); 		    	
					log.debug("mdatos("+registro+"): " + mdatos);
					Map laborNoAut = registrarLaborNoAutorizada(mdatos);	
					if (laborNoAut!=null && !laborNoAut.isEmpty()){
						List listaNoAut_final = (List) laborNoAut.get("listaNoAut_final");
						if(listaNoAut_final!=null && listaNoAut_final.size()>0){
							mdatos.put("listaNoAut_final",listaNoAut_final);
							mdatos.put("nroNoAut",nroNoAut+"");
							autogenerarSolicitudLabor(mdatos);//nueva solicitud 124 autogenerada de labor excepcional para todos los "intervalos de compensacion no autorizados de la fecha"
						}						
					}					
					log.debug("registro ("+registro+"): termino de insertar intervalos de compensacion NO AUTORIZADOS");
				}	

				log.debug("registro ("+registro+"): inicio de insertar intervalos de compensacion AUTORIZADOS");						   			    	
				Map laborAut = registrarLaborAutorizada(mdatos);	
				if (laborAut!=null && !laborAut.isEmpty()){
					String m_nroAut = (String) laborAut.get("nroAut");
					if (!m_nroAut.equals("")) nroAut = Integer.parseInt(m_nroAut);					
				}		
				log.debug("registro ("+registro+"): termino de insertar intervalos de compensacion AUTORIZADOS");

				log.debug("registro ("+registro+"): inicio de insertar intervalos de compensacion RECHAZADOS");		   			    	
				registrarLaborRechazada(mdatos);
				log.debug("registro ("+registro+"): termino de insertar intervalos de compensacion RECHAZADOS");
				listaNoAut = null;	
				listaAut = null;
				listaRech = null;
			}//fin for numDias			
			log.debug("registro ("+registro+"): salio de for numDias");
			
			mdatosAut.put("listaTotalAut",listaTotalAut);
			mdatosAut.put("nroAut",nroAut+"");	
			
			//envio de correo con "rangos de fechas e intervalos de compensacion autorizados" para un colaborador
			log.debug("registro ("+registro+"): inicio de envio correo x labor autorizada del registro: "+registro1+" para rango: "+fechaIni+"-"+fechaFin);				
				enviarCorreoLaborAutorizada(mdatosAut);	
			log.debug("registro ("+registro+"): fin envio correo x labor autorizada del registro: "+registro1+" para rango: "+fechaIni+"-"+fechaFin);	
			//fin envio de correo con "rangos de fechas e intervalos de compensacion autorizados" para un colaborador			 
			
		} catch (Exception e){
			res=false;
			error = e.toString();
			texto = regimen1 + " " + registro1 + " " + nombres1 + "  " + "error catch("+registro+"): "+error;
			if (log.isDebugEnabled()) log.debug("error("+registro+"): " + texto);
			super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);		
			log.error(e);			
		}
		return res;
	}
	
	/**
	 * Metodo que devuelve un Mapa de Listas con los intervalos de horas de compensacion con estado autorizado, no autorizado o rechazado
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public Map calcularIntervalosHorasCompensacion(String dbpool,String registro,String uuooRegistro,String fechaEval,Map rangoExtra)
			throws RemoteException {
		
		log.debug("ingreso calcularIntervalosHorasCompensacion("+registro+")");
		log.debug("registro("+registro+"): "+registro); 
		log.debug("uuooRegistro("+registro+"): "+uuooRegistro);
		log.debug("fechaEval("+registro+"): "+fechaEval);	
		log.debug("rangoExtra("+registro+"): "+rangoExtra);	
		
		float difMin = 0;
		int difMin2 = 0;	
		String hor_ini_aut="";
		String hor_fin_aut="";
		String obs_sustento="";
		String cod_jefe_aut="";	
		String ind_aut="";
	
		Map mapAut = new HashMap();
			
		Map HC = new HashMap(); //mapa que guarda 3 lista intervalos de compensacion para el intervalo de hora extra en analisis		
		
		List listaAutorizados = new ArrayList();//lista que guarda los intervalos de compensacion autorizados
		List listaNoAutorizados = new ArrayList();//lista que guarda los intervalos de compensacion no autorizados
		List listaRechazados = new ArrayList();//lista que guarda los intervalos de compensacion rechazados
		
		String hor_ini_perm = (String) rangoExtra.get("hini");//09:00 // 14:00
		String hor_fin_perm = (String) rangoExtra.get("hfin");//12:30 // 19:55
		String hor_ini_perm_act = hor_ini_perm;//09:00 // 14:00
		String hor_fin_perm_act = hor_fin_perm;//12:30 // 19:55		
		Date fechaEvaluada = new FechaBean(fechaEval).getSQLDate();
		Timestamp fec_creacion = new FechaBean().getTimestamp();
		String cod_user_crea ="SIRH";
		
		Map mapa1 = new HashMap();
		Map mapa2 = new HashMap();
		Map mapa3 = new HashMap();
		Map mapa4 = new HashMap();
		Map mapa5 = new HashMap();
		Map mapa6 = new HashMap();
		Map mapa7 = new HashMap();
		Map mapa8 = new HashMap();
		Map mapa9 = new HashMap();
		
		try {
			T4818DAO autorizacionesDAO = new T4818DAO(dbpool);					
			
			log.debug("registro("+registro+"): "+registro);
			log.debug("fechaEvaluada("+registro+"): "+fechaEvaluada);
			List intervalosAut = autorizacionesDAO.findIntervalosAutorizaciones(registro,fechaEvaluada,hor_ini_perm,hor_fin_perm);
			//a0=08:00-15:00
			//a1=15:30-17:00
			//a2=17:10-18:00
			//a3=18:20-19:30			
			//hor_ini_perm = 16:30
			//hor_fin_perm = 19:30
			//a0=17:30-19:30
			//a1=19:30-21:00?			
			if (intervalosAut!=null && intervalosAut.size()>0){	
				log.debug("intervalosAut("+registro+"): "+intervalosAut);
				for (int a = 0; a <= intervalosAut.size()-1; a++) {//a=0,1,2,3
					log.debug("inicia for-a("+registro+"): "+""+a);
					mapAut = (Map)intervalosAut.get(a);//toda la fila de la t4818
					log.debug("mapAut("+registro+"): "+mapAut);
					hor_ini_aut= (String)mapAut.get("hor_ini_aut");//hor_ini_aut=08:00
					hor_fin_aut= (String)mapAut.get("hor_fin_aut");//hor_fin_aut=15:00
					obs_sustento= (String)mapAut.get("obs_sustento");
					cod_jefe_aut= (String)mapAut.get("cod_jefe_aut");	
					ind_aut= (String)mapAut.get("ind_aut");//0=rechazado/1=autorizado
					
					if (hor_ini_perm_act.compareTo(hor_ini_aut)>=0){//hor_ini_perm_act>=hor_ini_aut
						if (hor_fin_perm_act.compareTo(hor_fin_aut)<=0){//hor_fin_perm_act<=hor_fin_aut
							//seteando rango autorizado/rechazado
							mapa1 = null;
							mapa1 = new HashMap();
							mapa1.put("cod_pers",registro);
							mapa1.put("fec_perm",fechaEvaluada);
							mapa1.put("hor_ini_perm",hor_ini_perm);
							mapa1.put("hor_fin_perm",hor_fin_perm);
							mapa1.put("cod_uorga",uuooRegistro);
							mapa1.put("cod_user_crea",cod_user_crea);
							mapa1.put("fec_creacion",fec_creacion);
							log.debug("preCompensacion mapa1("+registro+"): "+mapa1);
							mapa1.put("hor_ini_aut",hor_ini_aut);
							mapa1.put("cod_jefe_aut",cod_jefe_aut);
							mapa1.put("hor_ini_comp",hor_ini_perm_act);
							mapa1.put("hor_fin_comp",hor_fin_perm_act);
							difMin = Utiles.obtenerMinutosDiferencia(hor_ini_perm_act,hor_fin_perm_act);
							difMin2 = Math.round(difMin);
							if(difMin2>0){//ICAPUNAY 19/06 AJUSTES FINALES
							mapa1.put("cnt_min_comp_acu",new Integer(difMin2));
							mapa1.put("cnt_min_comp_sal",new Integer(difMin2));
							mapa1.put("obs_sustento_aut",obs_sustento);							
								if (ind_aut.equals("1")){//es solicitud autorizada
									mapa1.put("ind_comp","1");//1=autorizado
									log.debug("mapa1("+registro+"): "+mapa1);
									listaAutorizados.add(mapa1);
									log.debug("listaAutorizados("+registro+"): "+listaAutorizados);
								}else if (ind_aut.equals("0")){//es solicitud rechazada
									mapa1.put("ind_comp","0");//0=rechazado
									log.debug("mapa1("+registro+"): "+mapa1);
									listaRechazados.add(mapa1);
									log.debug("listaRechazados("+registro+"): "+listaRechazados);
								}
							}//ICAPUNAY 19/06 AJUSTES FINALES							
							//seteando rango autorizado/rechazado
						}else{//hor_fin_perm_act>hor_fin_aut (rango Autorizado/Rechazado y No autorizado)									
							//seteando rango autorizado/rechazado
							mapa2 = null;
							mapa2 = new HashMap();
							mapa2.put("cod_pers",registro);
							mapa2.put("fec_perm",fechaEvaluada);
							mapa2.put("hor_ini_perm",hor_ini_perm);
							mapa2.put("hor_fin_perm",hor_fin_perm);
							mapa2.put("cod_uorga",uuooRegistro);
							mapa2.put("cod_user_crea",cod_user_crea);
							mapa2.put("fec_creacion",fec_creacion);
							log.debug("preCompensacion mapa2("+registro+"): "+mapa2);
							mapa2.put("hor_ini_aut",hor_ini_aut);
							mapa2.put("cod_jefe_aut",cod_jefe_aut);
							mapa2.put("hor_ini_comp",hor_ini_perm_act);//hor_fin_comp=hor_ini_perm_act	
							mapa2.put("hor_fin_comp",hor_fin_aut);//hor_fin_comp=hor_fin_aut									
							difMin = Utiles.obtenerMinutosDiferencia(hor_ini_perm_act, hor_fin_aut);
							difMin2 = Math.round(difMin);	
							if(difMin2>0){//ICAPUNAY 19/06 AJUSTES FINALES
							mapa2.put("cnt_min_comp_acu",new Integer(difMin2));									
							mapa2.put("cnt_min_comp_sal",new Integer(difMin2));
							mapa2.put("obs_sustento_aut",obs_sustento);						
								if (ind_aut.equals("1")){//es solicitud autorizada
									mapa2.put("ind_comp","1");//1=autorizado
									log.debug("mapa2("+registro+"): "+mapa2);
									log.debug("listaAutorizados("+registro+"): "+listaAutorizados);
									listaAutorizados.add(mapa2);
								}else if (ind_aut.equals("0")){//es solicitud rechazada
									mapa2.put("ind_comp","0");//0=rechazado
									log.debug("mapa2("+registro+"): "+mapa2);
									listaRechazados.add(mapa2);
									log.debug("listaRechazados("+registro+"): "+listaRechazados);
								}		
							}//ICAPUNAY 19/06 AJUSTES FINALES													
							//fin seteo rango autorizado/rechazado	

							//seteando rango no autorizado a REPROCESAR
							if(a < intervalosAut.size()-1){							
									hor_ini_perm_act = hor_fin_aut;						
							}else{//ultimo
								//seteando rango no autorizado
								mapa3 = null;
								mapa3 = new HashMap();
								mapa3.put("cod_pers",registro);
								mapa3.put("fec_perm",fechaEvaluada);
								mapa3.put("hor_ini_perm",hor_ini_perm);
								mapa3.put("hor_fin_perm",hor_fin_perm);
								mapa3.put("cod_uorga",uuooRegistro);
								mapa3.put("cod_user_crea",cod_user_crea);
								mapa3.put("fec_creacion",fec_creacion);
								log.debug("preCompensacion mapa3("+registro+"): "+mapa3);
								mapa3.put("hor_ini_aut",null);
								mapa3.put("cod_jefe_aut",null);
								mapa3.put("hor_ini_comp",hor_fin_aut);//hor_ini_comp=hor_fin_aut	
								mapa3.put("hor_fin_comp",hor_fin_perm_act);//hor_fin_comp=hor_fin_perm_act									
								difMin = Utiles.obtenerMinutosDiferencia(hor_fin_aut, hor_fin_perm_act);
								difMin2 = Math.round(difMin);
								if(difMin2>0){//ICAPUNAY 19/06 AJUSTES FINALES
									mapa3.put("cnt_min_comp_acu",new Integer(difMin2));
									mapa3.put("ind_comp","4");//4=no autorizado									
									mapa3.put("cnt_min_comp_sal",new Integer(difMin2));
									mapa3.put("obs_sustento_aut",null);
									log.debug("mapa3("+registro+"): "+mapa3);								
									listaNoAutorizados.add(mapa3);
									log.debug("listaNoAutorizados("+registro+"): "+listaNoAutorizados);
								}//ICAPUNAY 19/06 AJUSTES FINALES							
								//fin seteo rango no autorizado	
							}																		
							//fin seteo rango no autorizado	a REPROCESAR									
						}								
					}else{//hor_ini_perm_act<hor_ini_aut	
						//seteando rango no autorizado
						mapa4 = null;
						mapa4 = new HashMap();
						mapa4.put("cod_pers",registro);
						mapa4.put("fec_perm",fechaEvaluada);
						mapa4.put("hor_ini_perm",hor_ini_perm);
						mapa4.put("hor_fin_perm",hor_fin_perm);
						mapa4.put("cod_uorga",uuooRegistro);
						mapa4.put("cod_user_crea",cod_user_crea);
						mapa4.put("fec_creacion",fec_creacion);
						log.debug("preCompensacion mapa4("+registro+"): "+mapa4);
						mapa4.put("hor_ini_aut",null);
						mapa4.put("cod_jefe_aut",null);
						mapa4.put("hor_ini_comp",hor_ini_perm_act);//hor_ini_comp=hor_ini_perm_act	
						mapa4.put("hor_fin_comp",hor_ini_aut);//hor_fin_comp=hor_ini_aut									
						difMin = Utiles.obtenerMinutosDiferencia(hor_ini_perm_act, hor_ini_aut);
						difMin2 = Math.round(difMin);
						if(difMin2>0){//ICAPUNAY 19/06 AJUSTES FINALES
							mapa4.put("cnt_min_comp_acu",new Integer(difMin2));
							mapa4.put("ind_comp","4");//4=no autorizado									
							mapa4.put("cnt_min_comp_sal",new Integer(difMin2));
							mapa4.put("obs_sustento_aut",null);
							log.debug("mapa4("+registro+"): "+mapa4);							
							listaNoAutorizados.add(mapa4);
							log.debug("listaNoAutorizados("+registro+"): "+listaNoAutorizados);
						}//ICAPUNAY 19/06 AJUSTES FINALES						
						//fin seteo rango no autorizado	
						if (hor_fin_perm_act.compareTo(hor_fin_aut)<=0){//hor_fin_perm_act<=hor_fin_aut (rango Autorizado/Rechazado)																
							//seteando rango autorizado/rechazado
							mapa5 = null;
							mapa5 = new HashMap();
							mapa5.put("cod_pers",registro);
							mapa5.put("fec_perm",fechaEvaluada);
							mapa5.put("hor_ini_perm",hor_ini_perm);
							mapa5.put("hor_fin_perm",hor_fin_perm);
							mapa5.put("cod_uorga",uuooRegistro);
							mapa5.put("cod_user_crea",cod_user_crea);
							mapa5.put("fec_creacion",fec_creacion);
							log.debug("preCompensacion mapa5("+registro+"): "+mapa5);
							mapa5.put("hor_ini_aut",hor_ini_aut);
							mapa5.put("cod_jefe_aut",cod_jefe_aut);
							mapa5.put("hor_ini_comp",hor_ini_aut);//hor_ini_comp=hor_ini_aut
							mapa5.put("hor_fin_comp",hor_fin_perm_act);//hor_fin_comp=hor_fin_perm_act
							difMin = Utiles.obtenerMinutosDiferencia(hor_ini_aut,hor_fin_perm_act);
							difMin2 = Math.round(difMin);
							if(difMin2>0){//ICAPUNAY 19/06 AJUSTES FINALES
								mapa5.put("cnt_min_comp_acu",new Integer(difMin2));
								mapa5.put("cnt_min_comp_sal",new Integer(difMin2));
								mapa5.put("obs_sustento_aut",obs_sustento);							
								if (ind_aut.equals("1")){//es solicitud autorizada
									mapa5.put("ind_comp","1");//1=autorizado
									log.debug("mapa5("+registro+"): "+mapa5);
									listaAutorizados.add(mapa5);
									log.debug("listaAutorizados("+registro+"): "+listaAutorizados);
								}else if (ind_aut.equals("0")){//es solicitud rechazada
									mapa5.put("ind_comp","0");//0=rechazado
									log.debug("mapa5: "+mapa5);
									listaRechazados.add(mapa5);
									log.debug("listaRechazados("+registro+"): "+listaRechazados);
								}
							}//ICAPUNAY 19/06 AJUSTES FINALES							
							//fin seteando rango autorizado/rechazado
							
							//ICAPUNAY 19/06 AJUSTES FINALES NUEVO
							//seteando rango no autorizado a REPROCESAR
							if(a < intervalosAut.size()-1){
								hor_ini_perm_act = hor_fin_aut;														
							}else{//ultimo
								//seteando rango no autorizado
								mapa9 = null;
								mapa9 = new HashMap();
								mapa9.put("cod_pers",registro);
								mapa9.put("fec_perm",fechaEvaluada);
								mapa9.put("hor_ini_perm",hor_ini_perm);
								mapa9.put("hor_fin_perm",hor_fin_perm);
								mapa9.put("cod_uorga",uuooRegistro);
								mapa9.put("cod_user_crea",cod_user_crea);
								mapa9.put("fec_creacion",fec_creacion);
								log.debug("preCompensacion mapa9("+registro+"): "+mapa9);
								mapa9.put("hor_ini_aut",null);
								mapa9.put("cod_jefe_aut",null);
								mapa9.put("hor_ini_comp",hor_fin_aut);//hor_ini_comp=hor_fin_aut	
								mapa9.put("hor_fin_comp",hor_fin_perm_act);//hor_fin_comp=hor_fin_perm_act									
								difMin = Utiles.obtenerMinutosDiferencia(hor_fin_aut, hor_fin_perm_act);
								difMin2 = Math.round(difMin);
								if(difMin2>0){
									mapa7.put("cnt_min_comp_acu",new Integer(difMin2));
									mapa7.put("ind_comp","4");//4=no autorizado									
									mapa7.put("cnt_min_comp_sal",new Integer(difMin2));
									mapa7.put("obs_sustento_aut",null);
									log.debug("mapa9("+registro+"): "+mapa9);								
									listaNoAutorizados.add(mapa9);
									log.debug("listaNoAutorizados("+registro+"): "+listaNoAutorizados);
								}								
								//fin seteo rango no autorizado	
							}																		
							//fin seteo rango no autorizado	a REPROCESAR
							//FIN ICAPUNAY 19/06 AJUSTES FINALES NUEVO

						}else{//hor_fin_perm_act>hor_fin_aut (rango Autorizado/Rechazado y no autorizado)									
							//seteando rango autorizado/rechazado
							mapa6 = null;
							mapa6 = new HashMap();
							mapa6.put("cod_pers",registro);
							mapa6.put("fec_perm",fechaEvaluada);
							mapa6.put("hor_ini_perm",hor_ini_perm);
							mapa6.put("hor_fin_perm",hor_fin_perm);
							mapa6.put("cod_uorga",uuooRegistro);
							mapa6.put("cod_user_crea",cod_user_crea);
							mapa6.put("fec_creacion",fec_creacion);
							log.debug("preCompensacion mapa6("+registro+"): "+mapa6);
							mapa6.put("hor_ini_aut",hor_ini_aut);
							mapa6.put("cod_jefe_aut",cod_jefe_aut);
							mapa6.put("hor_ini_comp",hor_ini_aut);//hor_fin_comp=hor_ini_aut	
							mapa6.put("hor_fin_comp",hor_fin_aut);//hor_fin_comp=hor_fin_aut									
							difMin = Utiles.obtenerMinutosDiferencia(hor_ini_aut,hor_fin_aut);
							difMin2 = Math.round(difMin);
							if(difMin2>0){//ICAPUNAY 19/06 AJUSTES FINALES
								mapa6.put("cnt_min_comp_acu",new Integer(difMin2));									
								mapa6.put("cnt_min_comp_sal",new Integer(difMin2));
								mapa6.put("obs_sustento_aut",obs_sustento);						
								if (ind_aut.equals("1")){//es solicitud autorizada
									mapa6.put("ind_comp","1");//1=autorizado
									log.debug("mapa6("+registro+"): "+mapa6);
									listaAutorizados.add(mapa6);
									log.debug("listaAutorizados("+registro+"): "+listaAutorizados);
								}else if (ind_aut.equals("0")){//es solicitud rechazada
									mapa6.put("ind_comp","0");//0=rechazado
									log.debug("mapa6("+registro+"): "+mapa6);
									listaRechazados.add(mapa6);
									log.debug("listaRechazados("+registro+"): "+listaRechazados);
								}		
							}//ICAPUNAY 19/06 AJUSTES FINALES															
							//fin seteo rango autorizado/rechazado
							
							//seteando rango no autorizado a REPROCESAR
							if(a < intervalosAut.size()-1){							
									hor_ini_perm_act = hor_fin_aut;														
							}else{//ultimo
								//seteando rango no autorizado
								mapa7 = null;
								mapa7 = new HashMap();
								mapa7.put("cod_pers",registro);
								mapa7.put("fec_perm",fechaEvaluada);
								mapa7.put("hor_ini_perm",hor_ini_perm);
								mapa7.put("hor_fin_perm",hor_fin_perm);
								mapa7.put("cod_uorga",uuooRegistro);
								mapa7.put("cod_user_crea",cod_user_crea);
								mapa7.put("fec_creacion",fec_creacion);
								log.debug("preCompensacion mapa7("+registro+"): "+mapa7);
								mapa7.put("hor_ini_aut",null);
								mapa7.put("cod_jefe_aut",null);
								mapa7.put("hor_ini_comp",hor_fin_aut);//hor_ini_comp=hor_fin_aut	
								mapa7.put("hor_fin_comp",hor_fin_perm_act);//hor_fin_comp=hor_fin_perm_act									
								difMin = Utiles.obtenerMinutosDiferencia(hor_fin_aut, hor_fin_perm_act);
								difMin2 = Math.round(difMin);
								if(difMin2>0){//ICAPUNAY 19/06 AJUSTES FINALES
									mapa7.put("cnt_min_comp_acu",new Integer(difMin2));
									mapa7.put("ind_comp","4");//4=no autorizado									
									mapa7.put("cnt_min_comp_sal",new Integer(difMin2));
									mapa7.put("obs_sustento_aut",null);
									log.debug("mapa7("+registro+"): "+mapa7);								
									listaNoAutorizados.add(mapa7);
									log.debug("listaNoAutorizados("+registro+"): "+listaNoAutorizados);
								}//ICAPUNAY 19/06 AJUSTES FINALES								
								//fin seteo rango no autorizado	
							}																		
							//fin seteo rango no autorizado	a REPROCESAR																	
						}
					}					
				}//fin for intervalosAut					
								
			}else{
				//seteando rango no autorizado
				mapa8 = null;
				mapa8 = new HashMap();
				mapa8.put("cod_pers",registro);
				mapa8.put("fec_perm",fechaEvaluada);
				mapa8.put("hor_ini_perm",hor_ini_perm);
				mapa8.put("hor_fin_perm",hor_fin_perm);
				mapa8.put("cod_uorga",uuooRegistro);
				mapa8.put("cod_user_crea",cod_user_crea);
				mapa8.put("fec_creacion",fec_creacion);
				log.debug("preCompensacion mapa8("+registro+"): "+mapa8);
				mapa8.put("hor_ini_aut",null);
				mapa8.put("cod_jefe_aut",null);
				mapa8.put("hor_ini_comp",hor_ini_perm);
				mapa8.put("hor_fin_comp",hor_fin_perm);
				difMin = Utiles.obtenerMinutosDiferencia(hor_ini_perm,hor_fin_perm);
				difMin2 = Math.round(difMin);
				if(difMin2>0){//ICAPUNAY 19/06 AJUSTES FINALES
					mapa8.put("cnt_min_comp_acu",new Integer(difMin2));
					mapa8.put("ind_comp","4");//4=no autorizado
					mapa8.put("cnt_min_comp_sal",new Integer(difMin2));
					mapa8.put("obs_sustento_aut",null);
					log.debug("mapa8("+registro+"): "+mapa8);			
					listaNoAutorizados.add(mapa8);	
					log.debug("listaNoAutorizados("+registro+"): "+listaNoAutorizados);
				}//ICAPUNAY 19/06 AJUSTES FINALES			
				//fin seteando rango no autorizado
			}
			log.debug("listaAutorizados final("+registro+"): "+listaAutorizados);
			log.debug("listaNoAutorizados final("+registro+"): "+listaNoAutorizados);
			log.debug("listaRechazados final("+registro+"): "+listaRechazados);
			HC.put("intervalosAutorizados", listaAutorizados);
			HC.put("intervalosNoAutorizados", listaNoAutorizados);		
			HC.put("intervalosRechazados", listaRechazados);	
			log.debug("HC("+registro+"): "+HC);			
			
		} catch (Exception e){
			log.debug("error("+registro+"): "+ e.toString() );
			log.error(e);		
		}		
		return HC;
	}
	
	//ICAPUNAY 21/05/2012 INTERSECCION DE RANGOS NO AUTORIZADOS EN SOLICITUDES EN SEGUIMIENTO
	/**
	 * Metodo que devuelve una Lista con los nuevos intervalos de horas de compensacion con estado no autorizado
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public List calcularIntervalosNoAutorizados(String horIniPermisoSol,String horFinPermisoSol,Map mapaNoAut)
			throws RemoteException {
		
		String registro = (String) mapaNoAut.get("cod_pers");
		log.debug("registro ("+registro+"): ingreso calcularListaIntervalosNoAutorizados");			
		log.debug("mapaNoAut("+registro+"): "+mapaNoAut);	
		log.debug("horIniPermisoSol("+registro+"): "+horIniPermisoSol);//inicio de intervalo de solicitud en seguimiento que intersecta con "rango no autorizado"
		log.debug("horFinPermisoSol("+registro+"): "+horFinPermisoSol);//fin de intervalo de solicitud en seguimiento que intersecta con "rango no autorizado"
		
		float difMin = 0;
		int difMin2 = 0;			
		
		List listaNoAutorizados = new ArrayList();//lista que guarda los intervalos de compensacion no autorizados		
				
		Date fechaPermiso = (Date)mapaNoAut.get("fec_perm");
		String hor_ini_comp = (String) mapaNoAut.get("hor_ini_comp");//16:30:00 (17:38:10) //inicio de rango no autorizado
		String hor_fin_comp = (String) mapaNoAut.get("hor_fin_comp");//16:41:20 (19:55:47)	//fin de rango no autorizado		
		
		Map mapa1 = new HashMap();		
		Map mapa3 = new HashMap();		
		Map mapa6 = new HashMap();		
		
		try {			
			String hor_ini_perm= (String)mapaNoAut.get("hor_ini_perm");
			String hor_fin_perm= (String)mapaNoAut.get("hor_fin_perm");
			String uuooRegistro= (String)mapaNoAut.get("cod_uorga");
			String cod_user_crea ="SIRH";					
			Timestamp fec_creacion = new FechaBean().getTimestamp();
			String hor_ini_aut= (String)mapaNoAut.get("hor_ini_aut");
			String cod_jefe_aut= (String)mapaNoAut.get("cod_jefe_aut");
			String ind_comp= (String)mapaNoAut.get("ind_comp");//4=no autorizado
			String obs_sustento_aut= (String)mapaNoAut.get("obs_sustento_aut");

			if (hor_ini_comp.compareTo(horIniPermisoSol)>=0){//hor_ini_comp>=horIniPermisoSol
				if (hor_fin_comp.compareTo(horFinPermisoSol)<=0){//hor_fin_comp<=horFinPermisoSol

					//rango intersectado-No se considera rango no autorizado por estar incluido en el rango de la solicitud	

				}else{//hor_fin_comp>horFinPermisoSol (rango no autorizado)																	
					//seteando rango no autorizado								
					mapa1.put("cod_pers",registro);
					mapa1.put("fec_perm",fechaPermiso);
					mapa1.put("hor_ini_perm",hor_ini_perm);
					mapa1.put("hor_fin_perm",hor_fin_perm);
					mapa1.put("cod_uorga",uuooRegistro);
					mapa1.put("cod_user_crea",cod_user_crea);
					mapa1.put("fec_creacion",fec_creacion);								
					mapa1.put("hor_ini_aut",hor_ini_aut);
					mapa1.put("cod_jefe_aut",cod_jefe_aut);
					mapa1.put("hor_ini_comp",horFinPermisoSol);//hor_ini_comp=horFinPermisoSol	
					mapa1.put("hor_fin_comp",hor_fin_comp);//hor_fin_comp=hor_fin_comp									
					difMin = Utiles.obtenerMinutosDiferencia(horFinPermisoSol, hor_fin_comp);
					difMin2 = Math.round(difMin);
					if(difMin2>0){//ICAPUNAY 19/06 AJUSTES FINALES
						mapa1.put("cnt_min_comp_acu",new Integer(difMin2));
						mapa1.put("ind_comp",ind_comp);//4=no autorizado									
						mapa1.put("cnt_min_comp_sal",new Integer(difMin2));
						mapa1.put("obs_sustento_aut",obs_sustento_aut);
						log.debug("mapa1("+registro+"): "+mapa1);
						listaNoAutorizados.add(mapa1);	
						log.debug("listaNoAutorizados("+registro+"): "+listaNoAutorizados);
					}//ICAPUNAY 19/06 AJUSTES FINALES					
					//fin seteo rango no autorizado										
				}								
			}else{//hor_ini_comp<horIniPermisoSol	
				//seteando rango no autorizado							
				mapa3.put("cod_pers",registro);
				mapa3.put("fec_perm",fechaPermiso);
				mapa3.put("hor_ini_perm",hor_ini_perm);
				mapa3.put("hor_fin_perm",hor_fin_perm);
				mapa3.put("cod_uorga",uuooRegistro);
				mapa3.put("cod_user_crea",cod_user_crea);
				mapa3.put("fec_creacion",fec_creacion);							
				mapa3.put("hor_ini_aut",hor_ini_aut);
				mapa3.put("cod_jefe_aut",cod_jefe_aut);
				mapa3.put("hor_ini_comp",hor_ini_comp);//hor_ini_comp=hor_ini_comp	
				mapa3.put("hor_fin_comp",horIniPermisoSol);//hor_fin_comp=horIniPermisoSol									
				difMin = Utiles.obtenerMinutosDiferencia(hor_ini_comp, horIniPermisoSol);
				difMin2 = Math.round(difMin);
				if(difMin2>0){//ICAPUNAY 19/06 AJUSTES FINALES
					mapa3.put("cnt_min_comp_acu",new Integer(difMin2));
					mapa3.put("ind_comp",ind_comp);//4=no autorizado									
					mapa3.put("cnt_min_comp_sal",new Integer(difMin2));
					mapa3.put("obs_sustento_aut",obs_sustento_aut);
					log.debug("mapa3("+registro+"): "+mapa3);
					listaNoAutorizados.add(mapa3);
					log.debug("listaNoAutorizados2("+registro+"): "+listaNoAutorizados);
				}//ICAPUNAY 19/06 AJUSTES FINALES				
				//fin seteo rango no autorizado	
				
				if (hor_fin_comp.compareTo(horFinPermisoSol)<=0){//hor_fin_comp<=horFinPermisoSol (rango intersectado)																

					//rango intersectado-No se considera rango no autorizado por estar incluido en el rango de la solicitud

				}else{//hor_fin_comp>horFinPermisoSol (rango no autorizado)	

					//seteando rango no autorizado							
					mapa6.put("cod_pers",registro);
					mapa6.put("fec_perm",fechaPermiso);
					mapa6.put("hor_ini_perm",hor_ini_perm);
					mapa6.put("hor_fin_perm",hor_fin_perm);
					mapa6.put("cod_uorga",uuooRegistro);
					mapa6.put("cod_user_crea",cod_user_crea);
					mapa6.put("fec_creacion",fec_creacion);							
					mapa6.put("hor_ini_aut",hor_ini_aut);
					mapa6.put("cod_jefe_aut",cod_jefe_aut);
					mapa6.put("hor_ini_comp",horFinPermisoSol);//hor_ini_comp=horFinPermisoSol	
					mapa6.put("hor_fin_comp",hor_fin_comp);//hor_fin_comp=hor_fin_comp									
					difMin = Utiles.obtenerMinutosDiferencia(horFinPermisoSol, hor_fin_comp);
					difMin2 = Math.round(difMin);	
					if(difMin2>0){//ICAPUNAY 19/06 AJUSTES FINALES
						mapa6.put("cnt_min_comp_acu",new Integer(difMin2));
						mapa6.put("ind_comp",ind_comp);//4=no autorizado									
						mapa6.put("cnt_min_comp_sal",new Integer(difMin2));
						mapa6.put("obs_sustento_aut",obs_sustento_aut);
						log.debug("mapa6("+registro+"): "+mapa6);
						listaNoAutorizados.add(mapa6);
						log.debug("listaNoAutorizados3("+registro+"): "+listaNoAutorizados);
					}//ICAPUNAY 19/06 AJUSTES FINALES					
					//fin seteo rango no autorizado																	
				}
			}			
			log.debug("listaNoAutorizados final("+registro+"): "+listaNoAutorizados);				
			
		} catch (Exception e){
			log.debug("error("+registro+"): "+ e.toString() );
			log.error(e);		
		}
		log.debug("registro ("+registro+"): fin ingreso calcularListaIntervalosNoAutorizados");	
		return listaNoAutorizados;
	}
		
	/**
	 * Metodo que devuelve una Lista con el total de nuevos intervalos de horas de compensacion con estado no autorizado
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public List calcularTotalIntervalosNoAutorizados(Map mapaNoAut,List listInterSolic)
			throws RemoteException {
		
		String cod_pers= (String)mapaNoAut.get("cod_pers");
		log.debug("registro ("+cod_pers+"): ingreso calcularTotalIntervalosNoAutorizados");			
		log.debug("mapaNoAut("+cod_pers+"): "+mapaNoAut);//mapaNoAut=17:00:00-19:53:40	
		log.debug("listInterSolic("+cod_pers+"): "+listInterSolic);
		log.debug("listInterSolic.size()("+cod_pers+"): "+listInterSolic.size());//3	
		log.debug("listInterSolic.size()-1("+cod_pers+"): "+(listInterSolic.size()-1));//2
		//lisInterSolic 5xx= 17:20:00-17:40:00 (0)
		//lisInterSolic 5xx= 18:00:00-18:20:00 (1)
		//lisInterSolic 5xx= 18:40:00-19:00:00 (2)
		
		List listaFinal = new ArrayList();//lista que guarda el total de los intervalos de compensacion no autorizados
		String hor_ini_comp ="";
		String hor_fin_comp ="";
		String horIniPermisoSol ="";
		String horFinPermisoSol ="";	
		String horIniPermisoSol_b ="";		
		Map mapInterSolic = new HashMap();		
		float difMin = 0;
		int difMin2 = 0;
		Map mapInterSolic_b = new HashMap();
		int b = 0;
		List listaAux = new ArrayList();
		Map mapaAux = new HashMap();
		
		Map mapa1 = new HashMap();		
		Map mapa2 = new HashMap();		
		Map mapa3 = new HashMap();
		
		Date fec_perm= (Date)mapaNoAut.get("fec_perm");
		String hor_ini_perm= (String)mapaNoAut.get("hor_ini_perm");
		String hor_fin_perm= (String)mapaNoAut.get("hor_fin_perm");
		String cod_uorga= (String)mapaNoAut.get("cod_uorga");
		String cod_user_crea = (String)mapaNoAut.get("cod_user_crea");					
		Timestamp fec_creacion = (Timestamp)mapaNoAut.get("fec_creacion");
		String hor_ini_aut= (String)mapaNoAut.get("hor_ini_aut");
		String cod_jefe_aut= (String)mapaNoAut.get("cod_jefe_aut");
		String ind_comp= (String)mapaNoAut.get("ind_comp");//4=no autorizado
		String obs_sustento_aut= (String)mapaNoAut.get("obs_sustento_aut");
				
		try {	
			
			hor_ini_comp = (String) mapaNoAut.get("hor_ini_comp");//16:30:00 (17:38:10) //inicio de rango no autorizado
			hor_fin_comp = (String) mapaNoAut.get("hor_fin_comp");//16:41:20 (19:55:47)	//fin de rango no autorizado
			
			for (int a = 0; a <= listInterSolic.size()-1; a++) {//a=0,1,2
				mapInterSolic = (Map)listInterSolic.get(a);//5xx= 17:20:00-17:40:00 (lis=0)
				log.debug("mapInterSolic("+cod_pers+"): "+mapInterSolic);	
				horIniPermisoSol = mapInterSolic.get("hor_ini_permiso").toString();//horIniPermisoSol=17:20:00
				horFinPermisoSol = mapInterSolic.get("hor_fin_permiso").toString();//horFinPermisoSol=17:40:00
				if(a< listInterSolic.size()-1){//a<2
					if(a==0){//primero
						if(hor_ini_comp.compareTo(horIniPermisoSol)<0){
							mapa1.put("cod_pers",cod_pers);
							mapa1.put("fec_perm",fec_perm);
							mapa1.put("hor_ini_perm",hor_ini_perm);
							mapa1.put("hor_fin_perm",hor_fin_perm);
							mapa1.put("cod_uorga",cod_uorga);
							mapa1.put("cod_user_crea",cod_user_crea);
							mapa1.put("fec_creacion",fec_creacion);								
							mapa1.put("hor_ini_aut",hor_ini_aut);
							mapa1.put("cod_jefe_aut",cod_jefe_aut);							
							mapa1.put("hor_ini_comp",hor_ini_comp);
							mapa1.put("hor_fin_comp",horIniPermisoSol);
        					difMin = Utiles.obtenerMinutosDiferencia(hor_ini_comp,horIniPermisoSol);
        					difMin2 = Math.round(difMin);
        					if(difMin2>0){//ICAPUNAY 19/06 AJUSTES FINALES
        						mapa1.put("cnt_min_comp_acu",new Integer(difMin2));	        													
            					mapa1.put("cnt_min_comp_sal",new Integer(difMin2));
            					mapa1.put("ind_comp",ind_comp);//4=no autorizado	
            					mapa1.put("obs_sustento_aut",obs_sustento_aut);
            					log.debug("mapa1("+cod_pers+"): "+mapa1);
            					listaFinal.add(mapa1);
            					log.debug("listaFinal1("+cod_pers+"): "+listaFinal);
        					}//ICAPUNAY 19/06 AJUSTES FINALES        					
						}
					}
					b=a+1;
					mapInterSolic_b = (Map)listInterSolic.get(b);
					log.debug("mapInterSolic_b("+cod_pers+"): "+mapInterSolic_b);
					horIniPermisoSol_b = mapInterSolic_b.get("hor_ini_permiso").toString();					
					if(horIniPermisoSol_b.compareTo(horFinPermisoSol)>0){
						mapa2 = null;
						mapa2 = new HashMap();
						mapa2.put("cod_pers",cod_pers);
						mapa2.put("fec_perm",fec_perm);
						mapa2.put("hor_ini_perm",hor_ini_perm);
						mapa2.put("hor_fin_perm",hor_fin_perm);
						mapa2.put("cod_uorga",cod_uorga);
						mapa2.put("cod_user_crea",cod_user_crea);
						mapa2.put("fec_creacion",fec_creacion);								
						mapa2.put("hor_ini_aut",hor_ini_aut);
						mapa2.put("cod_jefe_aut",cod_jefe_aut);		
						mapa2.put("hor_ini_comp",horFinPermisoSol);
						mapa2.put("hor_fin_comp",horIniPermisoSol_b);
    					difMin = Utiles.obtenerMinutosDiferencia(horFinPermisoSol,horIniPermisoSol_b);
    					difMin2 = Math.round(difMin);
    					if(difMin2>0){//ICAPUNAY 19/06 AJUSTES FINALES
    						mapa2.put("cnt_min_comp_acu",new Integer(difMin2));	        													
        					mapa2.put("cnt_min_comp_sal",new Integer(difMin2));
        					mapa2.put("ind_comp",ind_comp);//4=no autorizado	
        					mapa2.put("obs_sustento_aut",obs_sustento_aut);
        					log.debug("mapa2("+cod_pers+"): "+mapa2);
        					listaFinal.add(mapa2);
        					log.debug("listaFinal2("+cod_pers+"): "+listaFinal);
    					}//ICAPUNAY 19/06 AJUSTES FINALES    					
					}					
				}else{//ultimo/a=2
					if(a==0){//unico elemento
						listaAux = calcularIntervalosNoAutorizados(horIniPermisoSol, horFinPermisoSol, mapaNoAut);
						if (listaAux!=null && listaAux.size()>0){
							log.debug("listaAux("+cod_pers+"): "+listaAux);
							for (int x = 0; x <= listaAux.size()-1; x++) {
								mapaAux = null;
								mapaAux = new HashMap();
								mapaAux = (Map)listaAux.get(x);
								log.debug("mapaAux("+cod_pers+"): "+mapaAux);
								listaFinal.add(mapaAux);
								log.debug("listaFinal("+cod_pers+"): "+listaFinal);
							}							
						}
					}else{
						if(hor_fin_comp.compareTo(horFinPermisoSol)>0){
							mapa3 = null;
							mapa3 = new HashMap();
							mapa3.put("cod_pers",cod_pers);
							mapa3.put("fec_perm",fec_perm);
							mapa3.put("hor_ini_perm",hor_ini_perm);
							mapa3.put("hor_fin_perm",hor_fin_perm);
							mapa3.put("cod_uorga",cod_uorga);
							mapa3.put("cod_user_crea",cod_user_crea);
							mapa3.put("fec_creacion",fec_creacion);								
							mapa3.put("hor_ini_aut",hor_ini_aut);
							mapa3.put("cod_jefe_aut",cod_jefe_aut);	
							mapa3.put("hor_ini_comp",horFinPermisoSol);
							mapa3.put("hor_fin_comp",hor_fin_comp);
        					difMin = Utiles.obtenerMinutosDiferencia(horFinPermisoSol,hor_fin_comp);
        					difMin2 = Math.round(difMin);	
        					if(difMin2>0){//ICAPUNAY 19/06 AJUSTES FINALES
        						mapa3.put("cnt_min_comp_acu",new Integer(difMin2));	        													
            					mapa3.put("cnt_min_comp_sal",new Integer(difMin2));
            					mapa3.put("ind_comp",ind_comp);//4=no autorizado	
            					mapa3.put("obs_sustento_aut",obs_sustento_aut);
            					log.debug("mapa3("+cod_pers+"): "+mapa3);
            					listaFinal.add(mapa3);
            					log.debug("listaFinal3("+cod_pers+"): "+listaFinal);
        					}//ICAPUNAY 19/06 AJUSTES FINALES        					
						}
					}
				}				
			}						
			
		} catch (Exception e){
			log.debug("error("+cod_pers+"): "+ e.toString() );
			log.error(e);		
		}	
		log.debug("listaFinal_final("+cod_pers+"): "+listaFinal);		
		log.debug("registro ("+cod_pers+"): fin ingreso calcularTotalIntervalosNoAutorizados");	
		return listaFinal;
	}
	//FIN ICAPUNAY 21/05/2012 INTERSECCION DE RANGOS NO AUTORIZADOS EN SOLICITUDES EN SEGUIMIENTO
	
	/**
	 * Genera una cadena que contiene una tabla html con los intervalos de compensacion autorizados para un rango de fechas de un colaborador
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"	 
	 * @param lista List	
	 * @return String
	 * @throws FacadeException
	 */
	public String generaTablaLaborAutorizada(List lista) throws FacadeException{
		StringBuffer cadenaTabla = new StringBuffer("");
		Map registro = null;
		Date dfec_perm = null;
		String fec_perm="";
		Integer cnt_min_comp_acu=new Integer(0);
		
		try{			
			cadenaTabla.append("<table border='0' cellpadding='0' cellspacing='1'> <tr align='center'>")			
			.append("<th width='10%' ><font face='Verdana' size='2'>FECHA</font></th>")
			.append("<th width='15%' ><font face='Verdana' size='2'>H.INICIO</font></th>")
			.append("<th width='15%' ><font face='Verdana' size='2'>H.FIN</font></th>")			
			.append("<th width='10%' ><font face='Verdana' size='2'>MINUTOS</font></th>")
			.append("<th width='30%' ><font face='Verdana' size='2'>SUSTENTO</font></th>")
			.append("</tr>");

			for(int i=0;i<lista.size();i++){
				registro = (HashMap) lista.get(i);
				dfec_perm = (Date)registro.get("fec_perm");
				fec_perm = Utiles.dateToString(dfec_perm);
				log.debug("fec_perm: " + fec_perm);				
				cnt_min_comp_acu = registro.get("cnt_min_comp_acu")!=null?(Integer)registro.get("cnt_min_comp_acu"):cnt_min_comp_acu; 
				log.debug("cnt_min_comp_acu: " + cnt_min_comp_acu);								
				cadenaTabla.append("<tr align='left' class='dato'><td align='center' style='background-color:#FFF;'><font face='Verdana' size='2'>");								
				cadenaTabla.append(fec_perm)			
				.append("</font></td><td align='center' style='background-color:#FFF;'><font face='Verdana' size='2'>")
				.append((registro.get("hor_ini_comp")!=null)?(String)registro.get("hor_ini_comp"):"")
				.append("</font></td><td align='center' style='background-color:#FFF;'><font face='Verdana' size='2'>")
				.append((registro.get("hor_fin_comp")!=null)?(String)registro.get("hor_fin_comp"):"")
				.append("</font></td><td align='center' style='background-color:#FFF;'><font face='Verdana' size='2'>")
				.append(String.valueOf(cnt_min_comp_acu.intValue()))
				.append("</font></td><td align='center' style='background-color:#FFF;'><font face='Verdana' size='2'>")
				.append((registro.get("obs_sustento_aut")!=null)?(String)registro.get("obs_sustento_aut"):"")
				.append("</font></td></tr>");
				log.debug("cadenaTabla1: " + cadenaTabla);	
			}			
			cadenaTabla.append("</table>");
			log.debug("cadenaTabla final: " + cadenaTabla);	
			
		} catch(Exception e){
			log.error(e);
			throw new FacadeException(this,e.getMessage());
		} finally{
		}
		return cadenaTabla.toString(); 
	}
	
	/**
	 * Metodo que devuelve el texto en html para el correo a Trabajadores por movimientos de asistencia	
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @param params Map
	 * @param nombre String
	 * @param mensaje String
	 * @return String
	 * @throws FacadeException
	 */
	public String textoCorreoLaborExcepcional(Map params,String nombre,String mensaje) throws FacadeException{

		String head = "";
		String html = "";
		StringBuffer body = new StringBuffer();
		log.debug("params: " + params);
		log.debug("nombre: " + nombre);
		log.debug("mensaje: " + mensaje);
		String tituloCorreo="Notificaci&oacute;n de labor Excepcional autorizada";
		
		try {

			head += "<html><head><title>"
					+ tituloCorreo
					+ "</title><style>"
					+ ".T1 {font-style  : normal;text-transform : uppercase;font-size :10pt;color: #FFFFFF;background  : #336699;font-family : Tahoma,Verdana,Arial,Helvetica,sans-serif ;}"
					+ "</style></head>";
			log.debug("head:" + head);
			
			body.append(
					"<body><table width='100%' align='center' class='T1'><tr><td><center><strong>"
							+ tituloCorreo
							+ "</strong></center></td></tr></table><br><br>")
					.append("<table>")					
					.append("<tr><td class='membrete'><strong>Fecha:</strong></td></tr>")
					.append("<tr><td class='dato'>")
					.append((String)params.get("fec_notificacion"))
					.append("</td></tr>")
					.append("<tr><td class='membrete'><strong>Asunto:</strong></td></tr>")
					.append("<tr><td class='dato'>Notificaci&oacute;n de labor excepcional autorizada</td></tr>")
					/*//mostrar registro 17/05/2012
					.append("<tr><td class='membrete'><strong>Registro:</strong></td></tr>")
					.append("<tr><td class='dato'>").append((String)params.get("registro")).append("</td></tr>")
					.append("<tr><td><strong>Sr(a)(ita).</strong> <em>")*/
					//mostrar registro 17/05/2012
					.append("<tr><td><strong>Sr(a)(ita).</strong> <em>").append((String)params.get("registro")+" - ")//mostrar registro 17/05/2012
					.append(nombre).append("</em></td></tr></table><br>")
					.append("<table width='80%'><tr><td>").append(mensaje)
					.append("</td></tr></table>");
           
			body.append("<table>")			
			//.append("<tr><td class='membrete'><strong>Divisi&oacute;n de Planillas y Pensiones</strong></td></tr>") //ICAPUNAY 23072015 - PAS20155E230300073 - Habilitar Lic. Matrimonio CAS a cuenta
			.append("<tr><td class='membrete'><strong>Divisi&oacute;n de Compensaciones</strong></td></tr>") //ICAPUNAY 23072015 - PAS20155E230300073 - Habilitar Lic. Matrimonio CAS a cuenta 
			//.append("<tr><td>&nbsp;</td></tr>")
			.append("<tr><td class='membrete'><strong>Intendencia Nacional de Recursos Humanos</strong></td></tr>")
			.append("</table>");	
			log.debug("body: " + body);
			
			html = head + body.toString();
			log.debug("html: " + html);

		} catch (Exception e) {
			return "";
		}
		return html;
	}
	
	/**
	 * Metodo que devuelve los aprobadores de la solicitud autogenerada de labor excepcional
	 * @param mapa Map 
	 * @return aprobadores Map
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public Map findAprobadoresSolicitudLaborExcep(String dbpool, Map mapa)
			throws RemoteException {
		
		Map mAprobadores = new HashMap();		
		List errores = new ArrayList();
		
		Map mapa_jefeFinal = null;
		String cod_Jefe = "";
		String uuoo_Jefe = "";
		Map mapa_receptorSolic = new HashMap();
		String receptorSolic = "";
		String jefeEncargadoFlujo = "";
		
		String cod_Colab = (String)mapa.get("colab");
		String uuoo_Colab = (String)mapa.get("uuooColab");
		String fecha = (String)mapa.get("fecha");
					
		HashMap pp = new HashMap();
		pp.put("dbpool", dbpool);
		pp.put("codUO",uuoo_Colab);		
		pp.put("mov",Constantes.MOV_LABOR_EXCEPCIONAL);			
		
		try {					
			
			T12DAO t12dao= new T12DAO();//tabla t12uorga
			T1480DAO flujoDAO = new T1480DAO();

			if (!uuoo_Colab.trim().equals("")) {//uuoo del colaborador
    			mapa_jefeFinal = new HashMap();
				mapa_jefeFinal = t12dao.findJefeByTrabajador(dbpool,uuoo_Colab,cod_Colab);							
				if (mapa_jefeFinal.get("t12cod_jefe_final") != null	&& !mapa_jefeFinal.get("t12cod_jefe_final").toString().trim().equals("")) {								
					cod_Jefe = mapa_jefeFinal.get("t12cod_jefe_final").toString().trim();
					uuoo_Jefe = mapa_jefeFinal.get("t12cod_uorg_jefe").toString().trim();
					if (log.isDebugEnabled()) log.debug("colaborador: "+cod_Colab+" tiene Jefe asignado: "+cod_Jefe);//LINEA MODIFICADA 21/05/2011
					pp.put("cod_pers_ori",cod_Jefe);
					if (!(cod_Colab.trim().equals(cod_Jefe.trim()))){
						uuoo_Jefe = uuoo_Colab;
					}
					//BUSCO DELEGACION EN LA UNIDAD DEL JEFE DEL COLABORADOR
					Map map_aux = new HashMap();
					map_aux.put("dbpool", dbpool);
					map_aux.put("codUO", uuoo_Jefe);
					map_aux.put("codOpcion",Constantes.DELEGA_SOLICITUDES);
					if (log.isDebugEnabled()) log.debug("mapa_aux: " + map_aux);
					Map mapa_delegado = t12dao.findDelegado((HashMap)map_aux);
					if (log.isDebugEnabled()) log.debug("mapa_delegado: " + mapa_delegado);

					//SI EXISTE DELEGACION
					if (mapa_delegado!=null) {
						String cod_Delegado = (mapa_delegado.get("t02cod_pers")!=null?mapa_delegado.get("t02cod_pers").toString().trim():"");
						String jefe_delegado = (mapa_delegado.get("cod_jefe")!=null?mapa_delegado.get("cod_jefe").toString().trim():"");

						if (!cod_Delegado.equals("") && cod_Delegado.equals(cod_Colab)) {
							//COLABORADOR ES EL DELEGADO
							mapa_receptorSolic = t12dao.findJefeByTrabajador(dbpool,uuoo_Colab,jefe_delegado);
							if (log.isDebugEnabled()) log.debug("A mapa_receptorSolic: " + mapa_receptorSolic);
							receptorSolic = mapa_receptorSolic.get("t12cod_jefe_final").toString().trim();
							jefeEncargadoFlujo = receptorSolic;

							//PARA VER SI EXISTE DOBLE DELEGACION
							String UO_jefeEncargado1 = mapa_receptorSolic.get("t12cod_uorg_jefe").toString().trim();
							map_aux.put("codUO", UO_jefeEncargado1);
							mapa_delegado = t12dao.findDelegado((HashMap)map_aux);
							if (log.isDebugEnabled()) log.debug("DOBLE DELEGACION - mapa_delegado : " + mapa_delegado);
							if (mapa_delegado!=null) receptorSolic = (mapa_delegado.get("t02cod_pers")!=null?mapa_delegado.get("t02cod_pers").toString().trim():"");
							//
						} else {
							//DELEGADO NO ES EL COLABORADOR
							receptorSolic = cod_Delegado;
							jefeEncargadoFlujo = cod_Jefe;
						}
					} else {
						//SI NO EXISTE DELEGACION SIEMPRE IRA AL JEFE
						receptorSolic = cod_Jefe;
						jefeEncargadoFlujo = receptorSolic;
					}						
					if (!jefeEncargadoFlujo.equals("") && !receptorSolic.equals("")){//jefeEncargadoFlujo=1113 y receptorSolic=NI60
						log.debug("receptorSolic: " + receptorSolic);
						log.debug("jefeEncargadoFlujo: " + jefeEncargadoFlujo);
										
						pp.put("cod_pers_ori", jefeEncargadoFlujo);
						pp.put("codUO", map_aux.get("codUO"));
						
						log.debug("MAPA VERIFICAR APROBADORES: " + pp);
						ArrayList datospp = flujoDAO.findAprobadores(pp);					
						log.debug("LISTA APROBADORES: "+ datospp);
						pp.put("codOpcion",Constantes.DELEGA_SOLICITUDES);
						HashMap delegado = t12dao.findDelegado(pp);
						log.debug("delegado: "+delegado);
						if ((datospp.size() == 0)   || (datospp.size() == 0 && delegado == null )){
							pp.put("codUO",uuoo_Colab);
							log.debug("MAPA VERIFICAR APROBADORES1: " + pp);
							datospp = flujoDAO.findAprobadores(pp);
							log.debug("LISTA APROBADORES1: "+ datospp);
							delegado = t12dao.findDelegado(pp);
							log.debug("delegado1: "+delegado);
						}
						if ((datospp.size() == 0)   || (datospp.size() == 0 && delegado == null )){
							pp.put("codUO",uuoo_Jefe);
							log.debug("MAPA VERIFICAR APROBADORES2: " + pp);
							datospp = flujoDAO.findAprobadores(pp);
							log.debug("LISTA APROBADORES2 : "+ datospp);
							delegado = t12dao.findDelegado(pp);
							log.debug("delegado2: "+delegado);
						}
						if ((datospp.size() == 0)   || (datospp.size() == 0 && delegado == null)){
							log.debug("entro aca1");
							if(datospp.size() == 0){
								errores.add("No se puede autogenerar solicitud para fecha: "+fecha+ " para colaborador: "+ cod_Colab + " porque no hay flujo para el jefe. Favor coordine con su Analista");
							}
							if(datospp.size() == 0 && delegado == null){
								errores.add("No se puede autogenerar solicitud para fecha: "+fecha+ " para colaborador: "+ cod_Colab + " porque no hay flujo para el jefe ni delegado. Favor coordine con su Analista");
							}												
						}else{	
							log.debug("entro aca2");
							if ((datospp!=null & datospp.size()>0) || (delegado!=null && !delegado.isEmpty())){
								log.debug("entro aca3");
								mAprobadores.put("receptorSolic",receptorSolic);//? NI60
								mAprobadores.put("jefeEncargadoFlujo",jefeEncargadoFlujo);//? 1113
								mAprobadores.put("aprobador",datospp);//? Lista unica 1113 de la t1480sol_flujo
								if (delegado!=null && !delegado.isEmpty()){
									mAprobadores.put("delegado",delegado);//? Mapa NI60 de la t1595delega
								}								
								log.debug("mAprobadores: "+mAprobadores);
							}							
						}	
					}else{
						if (jefeEncargadoFlujo.equals("")){
							errores.add("No se puede autogenerar solicitud para fecha: "+fecha+ " para colaborador: "+ cod_Colab + " porque no tiene jefe. Favor coordine con su Analista");
						}
						if (receptorSolic.equals("")){
							errores.add("No se puede autogenerar solicitud para fecha: "+fecha+ " para colaborador: "+ cod_Colab + " porque no tiene aprobador. Favor coordine con su Analista");
						}						
					}
				}else{
					errores.add("No se puede autogenerar solicitud para fecha: "+fecha+ " porque colaborador: "+ cod_Colab + "no tiene jefe asignado");		    										
				}								
			}			
				
		} catch (Exception e){
			log.debug("error: "+ e.toString() );
			log.error(e);		
		}
		if(errores!=null && errores.size()>0){
			log.debug("entro aca4");
			mAprobadores.put("errores",errores);
		}		
		return mAprobadores;
	}
	
	//ICAPUNAY 05/10/2012 AJUSTES AOM 06A4T11 LABOR EXCEPCIONAL
	/**
	 * Metodo encargado de validar si cumple requisitos para la acumulacion de horas de labor excepcional de cada colaborador para una fecha	
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @param mapa Map 
	 * @return res boolean
	 * @throws FacadeException
	 */
	public boolean validarLaborExcepcional(Map mapa) throws RemoteException {
		boolean res = true;
		String codTurnoDx="";
		String descTurnoDx="";
		String HoraIniDx="";
		String HoraFinDx="";
		String codTurnoDw="";
		String descTurnoDw="";
		String HoraIniDw="";
		String HoraFinDw="";
		String texto="";
		String error="";
		String fechaEval = "";		
		String regimen = mapa.get("regimen")!=null?mapa.get("regimen").toString():"";
		String registro = mapa.get("registro")!=null?mapa.get("registro").toString():"";
		String uuoo = mapa.get("uuoo")!=null?mapa.get("uuoo").toString():"";
		String nombres = mapa.get("nombres")!=null?mapa.get("nombres").toString():"";
		String usuario = mapa.get("usuario")!=null?mapa.get("usuario").toString():"";
		String fechaIni = mapa.get("fechaIni")!=null?mapa.get("fechaIni").toString():"";
		String fecha_ingreso = mapa.get("fecha_ingreso")!=null?mapa.get("fecha_ingreso").toString():"";
		String dbpool = mapa.get("dbpool")!=null?mapa.get("dbpool").toString():"";		
		String v_i = mapa.get("i")!=null?mapa.get("i").toString().trim():"";
		int i = Integer.parseInt(v_i.trim());
		int dias = 0;
		ArrayList marcaciones= new ArrayList();
		
		T1270DAO turnoDAO = new T1270DAO();
		T1282DAO vacacionDAO = new T1282DAO(dbpool);
		T1273DAO licenciaDAO = new T1273DAO(dbpool);
		T1275DAO marcacionDAO = new T1275DAO();
		
		try {			
			//1ra Validacion: que fechaEval >= fecha_ingreso
			log.debug("Registro: "+registro+" fechaIni: " + fechaIni);			
			fechaEval = Utiles.dameFechaSiguiente(fechaIni, i);//si i=0 y fechaIni=30/03/2012 => fechaEval=30/03/2012
			log.debug("Registro: "+registro+" fechaEval: " + fechaEval);				
			log.debug("Registro: "+registro+" fecha_ingreso: " + fecha_ingreso);
		    dias = Utiles.obtenerDiasDiferencia(fecha_ingreso, fechaEval);			    
		    if (dias<0) {
		    	log.debug("Entro dias < 0");
		    	error = "No se puede procesar fecha: "+fechaEval+ " por ser menor a la fecha de su ingreso/reingreso: " + fecha_ingreso+".";
		    	texto = regimen + " " + registro + " " + nombres + "  " + error;
		    	if (log.isDebugEnabled()) log.debug("1ra validacion: " + texto);
		    	super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);		    	
		    	res = false;
		    }
		    //1.1ra Validacion: uuoo asignada					    
		    if (uuoo.toString().equals("")) {
		    	error = "No se puede procesar fecha: "+fechaEval+ " porque colaborador no tiene UUOO asignada.";
		    	texto = regimen + " " + registro + " " + nombres + "  " + error;
		    	if (log.isDebugEnabled()) log.debug("1.1ra validacion: " + texto);
		    	super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);		    	
		    	res = false;
		    }
		    //fin 1.1ra
		    //fin 1ra
		    
		    //validaciones turno y marcaciones
		    String fechaAntes = "";
		    BeanTurnoTrabajo turnoDx = null;		   	    
		    BeanTurnoTrabajo turno1 = turnoDAO.joinWithT45ByCodPersFecha_Controlado_OperAdm1dia(dbpool,registro,fechaEval);		    
		    if (turno1!=null){
		    	turnoDx=turno1;		    	
		    }else{
		    	BeanTurnoTrabajo turno2 = turnoDAO.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,registro,fechaEval);
		    	turnoDx=turno2;		    		    	
		    }
		    if (log.isDebugEnabled()) log.debug("turnoDx: " + turnoDx);
		    
		    if (turnoDx!=null){//tiene turno (dia x)
		    	codTurnoDx = turnoDx.getTurno().trim();
		    	descTurnoDx = turnoDx.getDescTurno();
		    	HoraIniDx = turnoDx.getHoraIni().trim();
		    	HoraFinDx = turnoDx.getHoraFin().trim();
		    	if (log.isDebugEnabled()) log.debug("codTurnoDx: " + codTurnoDx);
		    	if (log.isDebugEnabled()) log.debug("descTurnoDx: " + descTurnoDx);
		    	if (log.isDebugEnabled()) log.debug("HoraIniDx: " + HoraIniDx); //hinicio dia (x)
		    	if (log.isDebugEnabled()) log.debug("HoraFinDx: " + HoraFinDx);	//hfin dia (x)	    	
		    	
		    	if(HoraFinDx.compareTo(HoraIniDx)>0){//operativo o administrativo de 1 dia (marcaciones PARES requiere)
		    		//marcaciones = marcacionDAO.findByCodPersFechaRangosHoras(dbpool, registro, fechaEval,"00:00:00","23:59:59");		    		
		    		marcaciones = marcacionDAO.findByCodPersFecha(dbpool, registro, fechaEval);
		    		if (marcaciones!=null && marcaciones.size()>0){
		    			if (!(marcaciones.size()%2==0)) { //si numero de marcaciones es impar
	    		    		error = "No se puede procesar fecha: "+fechaEval+ " porque tiene numero impar de marcaciones: "+ marcaciones.size()+".Agregar o anular marcacion para la fecha "+fechaEval+" a procesar.";
	    		    		texto = regimen + " " + registro + " " + nombres + "  " + error;
	    		    		if (log.isDebugEnabled()) log.debug("5ta validacion: " + texto);
	    		    		super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);		    		
	    		    		res = false;		    		
	    		    	}	
		    		}else{
		    			error = "No se puede procesar fecha: "+fechaEval+ " porque no tiene marcaciones.";
	    	    		texto = regimen + " " + registro + " " + nombres + "  " + error;
	    	    		if (log.isDebugEnabled()) log.debug("6ta validacion: " + texto);
	    	    		super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);    		
	    	    		res = false;
		    		}		    			
	    		}else{//operativo de 2 dias entonces (marcaciones impares o par requiere)	    			
	    			fechaAntes = Utiles.dameFechaAnterior(fechaEval, 1);	    		   
	    		    BeanTurnoTrabajo turnoDw = turnoDAO.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,registro,fechaAntes); //dia (x-1)	    		 
	    		    if (log.isDebugEnabled()) log.debug("turno dia x-1 (turnoDw): " + turnoDw);	    		    
	    		    if (turnoDw!=null){//SI tiene turno (dia x-1) y SI tiene turno dia x (marcaciones PARES requiere)
	    		    	codTurnoDw = turnoDw.getTurno().trim();
	    		    	descTurnoDw = turnoDw.getDescTurno();
	    		    	HoraIniDw = turnoDw.getHoraIni().trim(); //hinicio dia (x-1)
	    		    	HoraFinDw = turnoDw.getHoraFin().trim(); //hfin dia (x-1)
	    		    	if (log.isDebugEnabled()) log.debug("codTurnoDw: " + codTurnoDw);
	    		    	if (log.isDebugEnabled()) log.debug("descTurnoDw: " + descTurnoDw);
	    		    	if (log.isDebugEnabled()) log.debug("HoraIniDw: " + HoraIniDw);
	    		    	if (log.isDebugEnabled()) log.debug("HoraFinDw: " + HoraFinDw);
	    		    	//marcaciones = marcacionDAO.findByCodPersFechaRangosHoras(dbpool, registro, fechaEval,HoraFinDw,HoraIniDx);
	    		    	marcaciones = marcacionDAO.findByCodPersFecha(dbpool, registro, fechaEval);
	    		    	if (marcaciones!=null && marcaciones.size()>0){
	    		    		if (!(marcaciones.size()%2==0)) { //si numero de marcaciones es impar
		    		    		error = "No se puede procesar fecha: "+fechaEval+ " porque tiene numero impar de marcaciones: "+ marcaciones.size()+".Agregar o anular marcacion para la fecha "+fechaEval+" a procesar.";
		    		    		texto = regimen + " " + registro + " " + nombres + "  " + error;
		    		    		if (log.isDebugEnabled()) log.debug("7ma validacion: " + texto);
		    		    		super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);		    		
		    		    		res = false;		    		
		    		    	}	
	    		    	}else{
	    		    		error = "No se puede procesar fecha: "+fechaEval+ " porque no tiene marcaciones.";
		    	    		texto = regimen + " " + registro + " " + nombres + "  " + error;
		    	    		if (log.isDebugEnabled()) log.debug("8va validacion: " + texto);
		    	    		super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);    		
		    	    		res = false;
	    		    	}		    			
	    		    }else{//NO tiene turno (dia x-1) y SI tiene turno dia x (marcaciones IMPARES requiere)
	    		    	fechaAntes = Utiles.dameFechaAnterior(fechaEval, 1);
	    		    	//marcaciones = marcacionDAO.findByCodPersFechaRangosHoras(dbpool, registro, fechaEval,"00:00:00",HoraIniDx);
	    		    	marcaciones = marcacionDAO.findByCodPersFecha(dbpool, registro, fechaEval);
	    		    	if (marcaciones!=null && marcaciones.size()>0){
	    		    		if (marcaciones.size()%2==0) { //si numero de marcaciones es par
	    		    			error = "No se puede procesar fecha: "+fechaEval+ " porque tiene numero par de marcaciones: "+ marcaciones.size()+".Agregar o anular marcacion para la fecha "+fechaEval+" o registrar turno para la fecha "+fechaAntes+".";
	    		    			texto = regimen + " " + registro + " " + nombres + "  " + error;
	    		    			if (log.isDebugEnabled()) log.debug("9na validacion: " + texto);
	    		    			super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);		    		
	    		    			res = false;		    		
	    		    		}	
	    		    	}else{
	    		    		error = "No se puede procesar fecha: "+fechaEval+ " porque no tiene marcaciones.";
		    	    		texto = regimen + " " + registro + " " + nombres + "  " + error;
		    	    		if (log.isDebugEnabled()) log.debug("10ma validacion: " + texto);
		    	    		super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);    		
		    	    		res = false;
	    		    	}    		    	
	    		    }	    			
	    		}		    		    	
		    }else{//no tiene turno (dia x)
		    	fechaAntes = Utiles.dameFechaAnterior(fechaEval, 1);	    		   
    		    BeanTurnoTrabajo turnoDw = turnoDAO.joinWithT45ByCodPersFecha_Controlado_Oper2dias(dbpool,registro,fechaAntes); //dia (x-1)	    		 
    		    if (log.isDebugEnabled()) log.debug("No turno dia x-turno dia x-1 (turnoDw): " + turnoDw);	    		    
    		    if (turnoDw!=null){//SI tiene turno (dia x-1) y NO tiene turno dia x (marcaciones IMPARES requiere)
    		    	codTurnoDw = turnoDw.getTurno().trim();
    		    	descTurnoDw = turnoDw.getDescTurno();
    		    	HoraIniDw = turnoDw.getHoraIni().trim(); //hinicio dia (x-1)
    		    	HoraFinDw = turnoDw.getHoraFin().trim(); //hfin dia (x-1)
    		    	if (log.isDebugEnabled()) log.debug("codTurnoDw: " + codTurnoDw);
    		    	if (log.isDebugEnabled()) log.debug("descTurnoDw: " + descTurnoDw);
    		    	if (log.isDebugEnabled()) log.debug("HoraIniDw: " + HoraIniDw);
    		    	if (log.isDebugEnabled()) log.debug("HoraFinDw: " + HoraFinDw);
    		    	//marcaciones = marcacionDAO.findByCodPersFechaRangosHoras(dbpool, registro, fechaEval,HoraFinDw,"23:59:59");//nuevo turno o ajustar fecha fin de turno
    		    	marcaciones = marcacionDAO.findByCodPersFecha(dbpool, registro, fechaEval);//nuevo turno o ajustar fecha fin de turno
    		    	if (marcaciones!=null && marcaciones.size()>0){
    		    		if (marcaciones.size()%2==0) { //si numero de marcaciones es par
	    		    		error = "No se puede procesar fecha: "+fechaEval+ " porque tiene numero par de marcaciones: "+ marcaciones.size()+".Agregar o anular marcacion o registrar turno para la fecha "+ fechaEval+" a procesar.";
	    		    		texto = regimen + " " + registro + " " + nombres + "  " + error;
	    		    		if (log.isDebugEnabled()) log.debug("11va validacion: " + texto);
	    		    		super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);		    		
	    		    		res = false;		    		
	    		    	}	
    		    	}else{
    		    		error = "No se puede procesar fecha: "+fechaEval+ " porque no tiene marcaciones.";
	    	    		texto = regimen + " " + registro + " " + nombres + "  " + error;
	    	    		if (log.isDebugEnabled()) log.debug("12va validacion: " + texto);
	    	    		super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);    		
	    	    		res = false;
    		    	}		    			
    		    }else{//NO tiene turno (dia x-1) y NO tiene turno dia x (marcaciones PARES requiere)
    		    	//marcaciones = marcacionDAO.findByCodPersFechaRangosHoras(dbpool, registro, fechaEval,"00:00:00","23:59:59");
    		    	marcaciones = marcacionDAO.findByCodPersFecha(dbpool, registro, fechaEval);
    		    	if (marcaciones!=null && marcaciones.size()>0){
    		    		if (!(marcaciones.size()%2==0)) { //si numero de marcaciones es impar
    		    			error = "No se puede procesar fecha: "+fechaEval+ " porque tiene numero impar de marcaciones: "+ marcaciones.size()+".Se requiere n? par para procesar fecha "+fechaEval+" como dia habil.";
    		    			texto = regimen + " " + registro + " " + nombres + "  " + error;
    		    			if (log.isDebugEnabled()) log.debug("13va validacion: " + texto);
    		    			super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);		    		
    		    			res = false;		    		
    		    		}	
    		    	}else{
    		    		error = "No se puede procesar fecha: "+fechaEval+ " no tiene turno y no tiene marcaciones; y fecha no es fecha de fin de turno para fecha "+fechaAntes+".";
	    	    		texto = regimen + " " + registro + " " + nombres + "  " + error;
	    	    		if (log.isDebugEnabled()) log.debug("14va validacion: " + texto);
	    	    		super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);    		
	    	    		res = false;
    		    	}    		    	
    		    }
		    }
		    //fin validaciones turno y marcaciones		   
		  
		  //21/05/2012 no acumular si coincide fecha con licencia o vacaciones  
		  //2da y 3ra validacion: si fecha a acumular coincide con vacaciones
		    Map prm = new HashMap();
            prm.put("cod_pers", registro);
            prm.put("fechaIni", fechaEval);
            prm.put("fechaFin", fechaEval);
            if (log.isDebugEnabled()) log.debug("prm: " + prm);
            boolean bVacacion = vacacionDAO.findByCodPersFIniFFin(prm);
            if (log.isDebugEnabled()) log.debug("bVacacion: " + bVacacion);
            if(bVacacion==true){
            	error = "No se puede procesar fecha: "+fechaEval+ " porque coincide con fecha de vacaciones.";
	    		texto = regimen + " " + registro + " " + nombres + "  " + error;
	    		if (log.isDebugEnabled()) log.debug("2da validacion: " + texto);
	    		super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);			    	
	    		
	    		res = false;
            }                
            //ICAPUNAY 11/06/2012 VALIDA VACACIONES PROGRAMADAS
			boolean bVacacion1 = vacacionDAO.findByCodPersFIniFFin49(prm);    			
			if (bVacacion1) {
				error = "No se puede procesar fecha: "+fechaEval+ " porque coincide con fecha de vacaciones programadas.";
	    		texto = regimen + " " + registro + " " + nombres + "  " + error;
	    		if (log.isDebugEnabled()) log.debug("3ra validacion: " + texto);
	    		super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);			    	
	    			
	    		res = false;    			
			}
			//FIN ICAPUNAY
          //fin 2da y 3ra   
            
          //4ta validacion: si fecha a acumular coincide con licencia  
            Map prms = new HashMap();
            prms.put("cod_pers", registro);
            prms.put("fecha1", fechaEval);
            prms.put("fecha2", fechaEval);
            prms.put("numero", "");//validar todos los numeros de licencias (si numero=3456 significa no incluye ese numero de licencia)
            if (log.isDebugEnabled()) log.debug("prms: " + prms);
            boolean bLicencia = licenciaDAO.findByCodPersFIniFFin(prms);              
            if (log.isDebugEnabled()) log.debug("bLicencia: " + bLicencia);
            if(bLicencia==true){
            	error = "No se puede procesar fecha: "+fechaEval+ " porque coincide con fecha de licencia aprobada.";
	    		texto = regimen + " " + registro + " " + nombres + "  " + error;
	    		if (log.isDebugEnabled()) log.debug("4ta validacion: " + texto);
	    		super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);			    	
	    			
	    		res = false;
            }
          //fin 4ta 
          //fin 21/05/2012 no acumular si coincide fecha con licencia o vacaciones  			
		
		} catch (Exception e){
			res=false;
			error = e.toString();
			texto = regimen + " " + registro + " " + nombres + "  " + "error: "+error+".";
			if (log.isDebugEnabled()) log.debug("error: " + texto);
			super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);		
			log.error(e);			
		}
		return res;
	}	
	
	/**
	 * Metodo encargado de acumular intervalos de labor excepcional autorizada, no autorizada y rechazada para una fecha	
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @param mapa Map 
	 * @return labor Map
	 * @throws FacadeException
	 */
	public Map acumularLaborExcepcional(Map mapa) throws RemoteException {
		
		HashMap mHorasExtras = new HashMap();
		Map intervalosCompensa = new HashMap();
		List listaTotalAut = mapa.get("listaTotalAut")!=null?(List)mapa.get("listaTotalAut"):new ArrayList();
		List listaAut = mapa.get("listaAut")!=null?(List)mapa.get("listaAut"):new ArrayList();
		List listaNoAut = mapa.get("listaNoAut")!=null?(List)mapa.get("listaNoAut"):new ArrayList();
		List listaRech = mapa.get("listaRech")!=null?(List)mapa.get("listaRech"):new ArrayList();
		
		Map labor = new HashMap();
		
		DataSource dgsp = sl.getDataSource("java:comp/env/jdbc/dgsp");//ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100
		T4819DAO compensacionesDAO = new T4819DAO(dgsp);//ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100
	
		int minLabExc=0;
		//mostrar error 06/11 del catch en archivo
		String texto="";
		String error="";
		String regimen = mapa.get("regimen")!=null?mapa.get("regimen").toString():"";		
		String nombres = mapa.get("nombres")!=null?mapa.get("nombres").toString():"";
		String usuario = mapa.get("usuario")!=null?mapa.get("usuario").toString():"";
		//mostrar error 06/11 del catch en archivo
				
		String registro = mapa.get("registro")!=null?mapa.get("registro").toString():"";
		String uuoo = mapa.get("uuoo")!=null?mapa.get("uuoo").toString():"";
		String fechaEval = mapa.get("fechaEval")!=null?mapa.get("fechaEval").toString():"";		
		String dbpool = mapa.get("dbpool")!=null?mapa.get("dbpool").toString():"";		
		BeanHoraExtra bhe = mapa.get("bhe")!=null?(BeanHoraExtra)mapa.get("bhe"):new BeanHoraExtra();		
		String m_minLabExc = mapa.get("minLabExc")!=null?mapa.get("minLabExc").toString().trim():"";
		if (!m_minLabExc.equals("")) minLabExc = Integer.parseInt(m_minLabExc.trim());
		String tipo = mapa.get("tipo")!=null?mapa.get("tipo").toString().trim():"";
		String tipoProceso="";
		
		String inicio = mapa.get("inicio")!=null?mapa.get("inicio").toString().trim():"";
		String fin = mapa.get("fin")!=null?mapa.get("fin").toString().trim():"";
		
		try {			
			log.debug("registro ("+registro+"): -=Inicio acumularLaborExcepcional=-");											
			String horaFin = bhe.getHoraSalida() != null ? bhe.getHoraSalida().trim() : "";																	
			if (!horaFin.equals("")) {												
				log.debug("bhe.getCodPers()("+registro+"): "+ bhe.getCodPers());				    					
				log.debug("bhe.getFechaAutorizacion()("+registro+"): " + bhe.getFechaAutorizacion());
				log.debug("bhe.getHoraIni()("+registro+"): " + bhe.getHoraIni());
				log.debug("bhe.getHoraSalida()("+registro+"): " + bhe.getHoraSalida());
				
				if (!tipo.equals("")){
					log.debug("Nuevo log(tipo!vacio)");
					if (tipo.equals("1dia")){
						mHorasExtras= calcularRangosPermanenciaExtra(dbpool,registro,bhe,inicio, fin);
						log.debug("mHorasExtras adm u ope 1 dia("+registro+"): " + mHorasExtras);
					}else{					
						if (mapa.get("tipoProceso")!=null){
							tipoProceso = mapa.get("tipoProceso").toString().trim();//2 dias
							if (tipoProceso.equals("entrada")){
								mHorasExtras= calcularRangosPermanenciaExtraOperativoEntrada(dbpool,registro,bhe,inicio, fin);
								log.debug("mHorasExtras ope 2 dias (entrada)("+registro+"): " + mHorasExtras);
							}
							if (tipoProceso.equals("salida")){
								mHorasExtras= calcularRangosPermanenciaExtraOperativoSalida(dbpool,registro,bhe,inicio, fin);
								log.debug("mHorasExtras ope 2 dias (salida)("+registro+"): " + mHorasExtras);
							}
							if (tipoProceso.equals("intermedio")){
								mHorasExtras= calcularRangosPermanenciaExtraOperativoIntermedio(dbpool,registro,bhe,inicio, fin);
								log.debug("mHorasExtras ope 2 dias (intermedio)("+registro+"): " + mHorasExtras);
							}
						}					
					}	
				}							

				if(mHorasExtras!=null && !mHorasExtras.isEmpty()){
					log.debug("Nuevo log (mHorasExtras!null)");
					int totalMinutos = 0;
					log.debug("mHorasExtras("+registro+"): " + mHorasExtras);
					List intervalos_HorExt = (List) mHorasExtras.get("intervalos");
					if (intervalos_HorExt!=null && intervalos_HorExt.size()>0){				    							
						log.debug("intervalos_HorExt("+registro+"): " + intervalos_HorExt);
						log.debug("intervalos_HorExt.size()("+registro+"): " + intervalos_HorExt.size());
						for (int k = 0; k < intervalos_HorExt.size(); k++) {
							Map intervalo = (Map)intervalos_HorExt.get(k);
							log.debug("intervalo("+registro+"): " + intervalo);
							String diferencia = (String) intervalo.get("diferencia");
							int minutosExtras = Integer.parseInt(diferencia);
							log.debug("minutosExtras("+registro+"): " + minutosExtras);
							log.debug("totalMinutos("+registro+"): " + totalMinutos);
							totalMinutos = totalMinutos + minutosExtras;
							log.debug("totalMinutos1("+registro+"): " + totalMinutos);
						}//fin for intervalos

						if (totalMinutos > minLabExc){ // > 20	
							//para c/rango de hora extra valida con la tabla t4818AutorizaExc												
							for (int l = 0; l < intervalos_HorExt.size(); l++) {
								Map intervaloExtra = (Map)intervalos_HorExt.get(l);
								log.debug("intervaloExtra("+registro+"): " + intervaloExtra);
								Map intervaloExtraAct = new HashMap();
								intervaloExtraAct.put("hini",(String) intervaloExtra.get("horaIni"));//17:38:10 (16:30:00)
								intervaloExtraAct.put("hfin", (String) intervaloExtra.get("hora"));//19:55:47 (16:41:20)
								intervaloExtraAct.put("minutos", (String) intervaloExtra.get("diferencia"));//138 (11)
								log.debug("intervaloExtraAct("+registro+"): " + intervaloExtraAct);
								
								//ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100								
								boolean tieneLE= false;			    	
								boolean eliminado = false; //si elimino todos los intervalos de compensacion existentes (para recalcularlos todos)
								List intervaloNoUsado = new ArrayList();
								List intervaloUsado = new ArrayList();
								Map noUsado = new HashMap();
								Map Usado = new HashMap();
								String ind = "";
								String hic= "";
								String hfc= "";
								String hic2= "";
								String hfc2= "";
								String estado= "";
								String cod_user_crea = "";
								int nro = 0;
								Integer acumulado = new Integer(0);
								Integer saldo = new Integer(0);	
								Map mFecPerm = compensacionesDAO.findFechaPermanenciaExtra(registro,fechaEval);//fechaEval='03/08/2013'			    	
								if (mFecPerm!=null && !mFecPerm.isEmpty()){//tieneLE=true
									//tieneLE= true;
									if (log.isDebugEnabled()) log.debug("Registro("+registro+"): "+registro+" fechaEval: "+fechaEval+" tieneLE: " + tieneLE);
									if (log.isDebugEnabled()) log.debug("Registro("+registro+"): "+registro+" fechaEval: "+fechaEval+" mFecPerm: " + mFecPerm);
									cod_user_crea = mFecPerm.get("cod_user_crea").toString().trim();//SIRH (nuevo proceso de labor) o SIRH Migracion (migracion proceso antiguo con estado autorizado)

									if (cod_user_crea.equals("SIRH")){//cod_user_crea=SIRH										
										//intervaloNoUsado = compensacionesDAO.findAcumIgualActual_ByRangos(registro,new FechaBean(fechaEval).getSQLDate(),(String)intervaloExtraAct.get("hini"),(String)intervaloExtraAct.get("hfin"));
										intervaloUsado = compensacionesDAO.findAcumDiferenteActual_ByRangos(registro,new FechaBean(fechaEval).getSQLDate(),(String)intervaloExtraAct.get("hini"),(String)intervaloExtraAct.get("hfin"));
										if (intervaloUsado!=null && intervaloUsado.size()>0){
											
											tieneLE= true;
											for (int v = 0; v < intervaloUsado.size(); v++) {
												Usado = (Map)intervaloUsado.get(v);
												if (log.isDebugEnabled()) log.debug("intervaloUsado("+registro+"): " + intervaloUsado);																						
												hic = (String)Usado.get("hor_ini_comp");
												hfc = (String)Usado.get("hor_fin_comp");
												ind = (String)Usado.get("ind_comp"); //1=autorizado con saldo /3=compensado sin saldo
												acumulado = (Integer)Usado.get("cnt_min_comp_acu");//
												saldo = (Integer)Usado.get("cnt_min_comp_sal");//
												estado = ind.equals("1")?"Autorizado usandose":"Compensado sin saldo";
												error = "No se puede procesar intervalo extra ("+ intervaloExtraAct.get("hini").toString()+" - "+intervaloExtraAct.get("hfin").toString()+") para fecha: "+fechaEval+ " porque tiene intervalo ("+ hic + " - " + hfc + ") "+ estado+". Acumulado: "+String.valueOf(acumulado.intValue())+" - Saldo: "+String.valueOf(saldo.intValue());
												texto = regimen + " " + registro + " " + nombres + "  " + error;
												if (log.isDebugEnabled()) log.debug("rango de fecha usado o en uso("+registro+"): " + texto);
												super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);
											}	
											
										}else{
											//intervaloUsado = compensacionesDAO.findAcumDiferenteActual_ByRangos(registro,new FechaBean(fechaEval).getSQLDate(),(String)intervaloExtraAct.get("hini"),(String)intervaloExtraAct.get("hfin"));
											intervaloNoUsado = compensacionesDAO.findAcumIgualActual_ByRangos(registro,new FechaBean(fechaEval).getSQLDate(),(String)intervaloExtraAct.get("hini"),(String)intervaloExtraAct.get("hfin"));
											if (intervaloNoUsado!=null && intervaloNoUsado.size()>0){
												tieneLE= true;
												for (int u = 0; u < intervaloNoUsado.size(); u++) {
													noUsado = (Map)intervaloNoUsado.get(u);												
													hic2 = (String)noUsado.get("hor_ini_comp");
													hfc2 = (String)noUsado.get("hor_fin_comp");
													if (log.isDebugEnabled()) log.debug("Para fecha("+registro+"): "+fechaEval+" intervalo de compensacion ("+hic2+" - "+hfc2+") no es usado todavia en compensaciones-rango puede ser recalculado");
													eliminado = compensacionesDAO.deleteIntervaloCompensacion(registro,fechaEval,hic2,hfc2);
													if (log.isDebugEnabled()) log.debug("eliminado("+registro+"): " + eliminado);							
													if (eliminado==true) nro=nro+1;
													if (log.isDebugEnabled()) log.debug("nro("+registro+"): " + nro);													
												}
												if (nro==intervaloNoUsado.size()){
													if (log.isDebugEnabled()) log.debug("nro("+registro+")==intervaloNoUsado.size()");
													tieneLE= false;
													if (log.isDebugEnabled()) log.debug("tieneLE("+registro+"): " + tieneLE);
												}
												
											}else{
												if (log.isDebugEnabled()) log.debug("No cruza con ningun rango existente en bolsa("+registro+"): (" + intervaloExtraAct.get("hini").toString()+" - "+intervaloExtraAct.get("hfin").toString()+")");	
												tieneLE= false;
											}
										}
									}else{
										error = "No se puede procesar fecha: "+fechaEval+ " porque tiene intervalo(s) de compensacion autorizados por la migracion del anterior proceso";
										texto = regimen + " " + registro + " " + nombres + "  " + error;
										if (log.isDebugEnabled()) log.debug("fecha con horas migradas autorizadas("+registro+"): " + texto);
										super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);						    			
									}
								}//fin tieneLE=true
								//FIN ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100
								
								if (tieneLE==false){ ////ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100 (solo add if)	
									//solo se generara LE si "no existe LE para la fecha" o "no existe LE para el rango evaluado de la fecha (acumulado igual a su actual-no fue usado todavia)"
									
									intervalosCompensa = calcularIntervalosHorasCompensacion(dbpool,registro,uuoo,fechaEval,intervaloExtraAct);
																		
									if (intervalosCompensa!=null && !intervalosCompensa.isEmpty()){
										log.debug("intervalosCompensa("+registro+"): " + intervalosCompensa);
										List aut = (List)intervalosCompensa.get("intervalosAutorizados");
										List noAut = (List)intervalosCompensa.get("intervalosNoAutorizados");
										List rech = (List)intervalosCompensa.get("intervalosRechazados");
										
										if(aut!=null && aut.size()>0){				    											
											log.debug("aut("+registro+"): " + aut);
											for (int a = 0; a < aut.size(); a++) {
												Map rango = (Map)aut.get(a);
												log.debug("rango("+registro+"): " + rango);
												listaAut.add(rango);
												log.debug("listaAut("+registro+"): " + listaAut);
												listaTotalAut.add(rango);				    												
												log.debug("listaTotalAut("+registro+"): " + listaTotalAut);
											}			    											
										}
										if(noAut!=null && noAut.size()>0){
											log.debug("noAut("+registro+"): " + noAut);
											for (int na = 0; na < noAut.size(); na++) {
												Map rango = (Map)noAut.get(na);
												log.debug("rango("+registro+"): " + rango);
												listaNoAut.add(rango);
												log.debug("listaNoAut("+registro+"): " + listaNoAut);
											}			    											
										}
										if(rech!=null && rech.size()>0){
											log.debug("rech("+registro+"): " + rech);
											for (int r = 0; r < rech.size(); r++) {
												Map rango = (Map)rech.get(r);
												log.debug("rango("+registro+"): " + rango);
												listaRech.add(rango);
												log.debug("listaRech("+registro+"): " + listaRech);
											}			    											
										}			    										
									}										
								}//ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100 (solo add })											    									
							}//fin for intervalos													
						}//fin > 10
					}//fin intervalos_HorExt!=null												
				}//fin mHorasExtras!=null											
			}//fin horaFin!""
			log.debug("registro ("+registro+"): FIN ES -=acumularLaborExcepcional=-");
			labor.put("listaAut",listaAut);
			labor.put("listaTotalAut",listaTotalAut);
			labor.put("listaNoAut",listaNoAut);
			labor.put("listaRech",listaRech);
		
		} catch (Exception e){			
			error = "No se puede procesar fecha: "+fechaEval+ " por error: "+e.toString()+ " metodo:acumularLaborExcepcional()";
			texto = regimen + " " + registro + " " + nombres + "  " + error;
			if (log.isDebugEnabled()) log.debug("error("+registro+"): " + texto);
			super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);	
		}
		return labor;
	}
	
	/**
	 * Metodo encargado de acumular intervalos de labor excepcional (despues de hora de salida) autorizada, no autorizada y rechazada para una fecha	
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @param mapa Map 
	 * @return labor Map
	 * @throws FacadeException
	 */
	public Map acumular2LaborExcepcional(Map mapa) throws RemoteException {
		
		HashMap mHorasExtras = new HashMap();
		Map intervalosCompensa = new HashMap();
		List listaTotalAut = mapa.get("listaTotalAut")!=null?(List)mapa.get("listaTotalAut"):new ArrayList();
		List listaAut = mapa.get("listaAut")!=null?(List)mapa.get("listaAut"):new ArrayList();
		List listaNoAut = mapa.get("listaNoAut")!=null?(List)mapa.get("listaNoAut"):new ArrayList();
		List listaRech = mapa.get("listaRech")!=null?(List)mapa.get("listaRech"):new ArrayList();
		
		Map labor = new HashMap();
		T1270DAO turnoDAO = new T1270DAO();
		
		DataSource dgsp = sl.getDataSource("java:comp/env/jdbc/dgsp");//ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100
		T4819DAO compensacionesDAO = new T4819DAO(dgsp);//ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100
		
		int minLabExc=0;
		//mostrar error 06/11 del catch en archivo
		String texto="";
		String error="";
		String regimen = mapa.get("regimen")!=null?mapa.get("regimen").toString():"";		
		String nombres = mapa.get("nombres")!=null?mapa.get("nombres").toString():"";
		String usuario = mapa.get("usuario")!=null?mapa.get("usuario").toString():"";
		//mostrar error 06/11 del catch en archivo
				
		String registro = mapa.get("registro")!=null?mapa.get("registro").toString():"";
		String uuoo = mapa.get("uuoo")!=null?mapa.get("uuoo").toString():"";
		String fechaEval = mapa.get("fechaEval")!=null?mapa.get("fechaEval").toString():"";		
		String dbpool = mapa.get("dbpool")!=null?mapa.get("dbpool").toString():"";		
		BeanHoraExtra bhe = mapa.get("bhe")!=null?(BeanHoraExtra)mapa.get("bhe"):new BeanHoraExtra();		
		String m_minLabExc = mapa.get("minLabExc")!=null?mapa.get("minLabExc").toString().trim():"";
		if (!m_minLabExc.equals("")) minLabExc = Integer.parseInt(m_minLabExc.trim());
		String tipo = mapa.get("tipo")!=null?mapa.get("tipo").toString().trim():"";
		String tipoProceso="";
		
		String inicio = mapa.get("inicio")!=null?mapa.get("inicio").toString().trim():"";
		String fin = mapa.get("fin")!=null?mapa.get("fin").toString().trim():"";
		
		try {
			
			log.debug("registro ("+registro+"): -=Inicio acumular2LaborExcepcional=-");											
			String horaFin = bhe.getHoraSalida() != null ? bhe.getHoraSalida().trim() : "";																		
			if (!horaFin.equals("")) {												
				log.debug("bhe.getCodPers()("+registro+"): " + bhe.getCodPers());				    					
				log.debug("bhe.getFechaAutorizacion()("+registro+"): " + bhe.getFechaAutorizacion());
				log.debug("bhe.getHoraIni()("+registro+"): " + bhe.getHoraIni());
				log.debug("bhe.getHoraSalida()("+registro+"): " + bhe.getHoraSalida());

				if (!tipo.equals("")){
					log.debug("Nuevo log2(tipo!vacio)");
					if (tipo.equals("1dia")){
						mHorasExtras= calcularRangosPermanenciaExtra(dbpool,registro,bhe,inicio, fin);
						log.debug("mHorasExtras adm u ope 1 dia("+registro+"): " + mHorasExtras);
					}else{					
						if (mapa.get("tipoProceso")!=null){
							tipoProceso = mapa.get("tipoProceso").toString().trim();//2 dias
							if (tipoProceso.equals("entrada")){
								mHorasExtras= calcularRangosPermanenciaExtraOperativoEntrada(dbpool,registro,bhe,inicio, fin);
								log.debug("mHorasExtras ope 2 dias (entrada)("+registro+"): " + mHorasExtras);
							}
							if (tipoProceso.equals("salida")){
								mHorasExtras= calcularRangosPermanenciaExtraOperativoSalida(dbpool,registro,bhe,inicio, fin);
								log.debug("mHorasExtras ope 2 dias (salida)("+registro+"): " + mHorasExtras);
							}
							if (tipoProceso.equals("intermedio")){
								mHorasExtras= calcularRangosPermanenciaExtraOperativoIntermedio(dbpool,registro,bhe,inicio, fin);
								log.debug("mHorasExtras ope 2 dias (intermedio)("+registro+"): " + mHorasExtras);
							}
						}					
					}	
				}					

				if(mHorasExtras!=null && !mHorasExtras.isEmpty()){
					log.debug("Nuevo log2 (mHorasExtras!null)");
					int totalMinutos = 0;											
					log.debug("mHorasExtras("+registro+"): " + mHorasExtras);
					List intervalos_HorExt = (List) mHorasExtras.get("intervalos");
					if (intervalos_HorExt!=null && intervalos_HorExt.size()>0){
						log.debug("intervalos_HorExt("+registro+"): " + intervalos_HorExt);
						log.debug("intervalos_HorExt.size()("+registro+"): " + intervalos_HorExt.size());
						for (int k = 0; k < intervalos_HorExt.size(); k++) {
							Map intervaloExtra = (Map)intervalos_HorExt.get(k);//16:30:00-16:41:20 (17:38:10-19:55:47)
							log.debug("intervaloExtra("+registro+"): " + intervaloExtra);
							String diferencia = (String) intervaloExtra.get("diferencia");//11 (138)
							int minutosExtras = Integer.parseInt(diferencia);
							log.debug("minutosExtras("+registro+"): " + minutosExtras);
							log.debug("totalMinutos("+registro+"): " + totalMinutos);
							totalMinutos = totalMinutos + minutosExtras;//totalMinutos = suma minutos x cada rango de hora extra despues de hora de salida
							log.debug("totalMinutos1("+registro+"): " + totalMinutos);
						}//fin for intervalos

						int minutosXRecuperar = turnoDAO.findHorasCompensa(dbpool,registro,fechaEval);//se calcula si para la fecha tiene que recuperar 1 hora x otra licencia(60 minutos)
						log.debug("minutosXRecuperar("+registro+"): " + minutosXRecuperar);
						log.debug("totalMinutos("+registro+"): " + totalMinutos);

						totalMinutos = totalMinutos - minutosXRecuperar;//puede devolver cantidad negativa (89 = 149 - 60)
						log.debug("totalMinutos2("+registro+"): " + totalMinutos);

						if (totalMinutos > minLabExc){ //89 > 20	
							int saldoMinExt = 0;
							int saldoTotal = totalMinutos; //89
							log.debug("saldoTotal("+registro+"): " + saldoTotal);
							//c/rango de hora extra valida con la tabla t4818AutorizaExc													
							for (int l = 0; l < intervalos_HorExt.size(); l++) {
								saldoMinExt = 0;												    									
								Map intervaloExtra = (Map)intervalos_HorExt.get(l);
								log.debug("intervaloExtra("+registro+"): " + intervaloExtra);
								Map intervaloExtraAct = new HashMap();
								String horIniExt = (String) intervaloExtra.get("horaIni");//16:30:00 (17:38:10)
								String horFinExt = (String) intervaloExtra.get("hora");//16:41:20 (19:55:47)
								String diferencia = (String) intervaloExtra.get("diferencia");//11 (138)
								int minutos = Integer.parseInt(diferencia);//11 (138)
								log.debug("horIniExt("+registro+"): " + horIniExt);
								log.debug("horFinExt("+registro+"): " + horFinExt);
								log.debug("minutos("+registro+"): " + minutos);
								intervaloExtraAct.put("hini",horIniExt);//16:30:00 (17:38:10)	
								intervaloExtraAct.put("hfin",horFinExt);	
								if(saldoTotal>0){//89>0 (78>0)
									log.debug("saldoTotal("+registro+"): " + saldoTotal);
									if (minutos<saldoTotal){ //11<89 
										log.debug("minutos<saldoTotal");
										saldoMinExt = minutos;//saldoMinExt=11
										log.debug("saldoMinExt("+registro+"): " + saldoMinExt);
										saldoTotal = saldoTotal - saldoMinExt;//saldoTotal=78				    											
										log.debug("saldoTotal("+registro+"): " + saldoTotal);
									}else if (minutos==saldoTotal){//xx>89
										log.debug("minutos==saldoTotal");
										saldoMinExt = saldoTotal;//89
										log.debug("saldoMinExt("+registro+"): "+saldoMinExt);
										saldoTotal = 0;//0
										log.debug("saldoTotal("+registro+"): "+saldoTotal);
									}else if (minutos>saldoTotal){// (138>78)
										log.debug("minutos>saldoTotal");
										saldoMinExt = saldoTotal;// (saldoMinExt=78)
										log.debug("saldoMinExt("+registro+"): "+saldoMinExt);
										saldoTotal = 0;// (saldoTotal=0)
										log.debug("saldoTotal("+registro+"): "+saldoTotal);
										if (minutosXRecuperar==60){//solo resta 1 hora a la hora final si tiene que recuperar 1 hora en la fecha
											log.debug("minutosXRecuperar==60");
											//restando a la hora final 1 hora por la de recuperacion de 60 minutos
											String shora = horFinExt.substring(0,2); //19 de 19:55:47 (caso2: 10)
											String sresto = horFinExt.substring(2,horFinExt.length()); //:55:47
											int hora = Integer.parseInt(shora);
											log.debug("hora("+registro+"): "+hora);
											hora = hora - 1; //(caso2: 9)
											log.debug("hora1("+registro+"): "+hora);
											if (hora < 10){//anteponemos el 0 delante (caso2: 9)
												shora = "0"+String.valueOf(hora)+sresto;// (caso2: 09)
												log.debug("shora2("+registro+"): "+shora);
											}else{
												shora = String.valueOf(hora)+sresto;//18
												log.debug("shora3("+registro+"): "+shora);
											}				    											
											intervaloExtraAct.put("hfin",shora);//hora: 18:55:47					    										
											//fin restando
										}				    											
									}
								}				    											    									
								intervaloExtraAct.put("minutos",""+saldoMinExt);//diferencia: 78
								log.debug("intervaloExtraAct("+registro+"): "+intervaloExtraAct);
								
								//ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100								
								boolean tieneLE= false;			    	
								boolean eliminado = false; //si elimino todos los intervalos de compensacion existentes (para recalcularlos todos)
								List intervaloNoUsado = new ArrayList();
								List intervaloUsado = new ArrayList();
								Map noUsado = new HashMap();
								Map Usado = new HashMap();
								String ind = "";
								String hic= "";
								String hfc= "";
								String hic2= "";
								String hfc2= "";
								String estado= "";
								String cod_user_crea = "";
								Integer acumulado = new Integer(0);
								Integer saldo = new Integer(0);	
															
								Map mFecPerm = compensacionesDAO.findFechaPermanenciaExtra(registro,fechaEval);//fechaEval='03/08/2013'			    	
								if (mFecPerm!=null && !mFecPerm.isEmpty()){//tieneLE=true
									tieneLE= true;
									if (log.isDebugEnabled()) log.debug("Registro("+registro+"): "+registro+" fechaEval: "+fechaEval+" tieneLE: " + tieneLE);
									if (log.isDebugEnabled()) log.debug("Registro("+registro+"): "+registro+" fechaEval: "+fechaEval+" mFecPerm: " + mFecPerm);
									cod_user_crea = mFecPerm.get("cod_user_crea").toString().trim();//SIRH (nuevo proceso de labor) o SIRH Migracion (migracion proceso antiguo con estado autorizado)

									if (cod_user_crea.equals("SIRH")){//cod_user_crea=SIRH										
										intervaloNoUsado = compensacionesDAO.findAcumIgualActual_ByRangos(registro,new FechaBean(fechaEval).getSQLDate(),(String)intervaloExtraAct.get("hini"),(String)intervaloExtraAct.get("hfin"));
										if (intervaloNoUsado!=null && intervaloNoUsado.size()>0){
											for (int u = 0; u < intervaloNoUsado.size(); u++) {
												noUsado = (Map)intervaloNoUsado.get(u);												
												hic2 = (String)noUsado.get("hor_ini_comp");
												hfc2 = (String)noUsado.get("hor_fin_comp");
												if (log.isDebugEnabled()) log.debug("Para fecha("+registro+"): "+fechaEval+" intervalo de compensacion ("+hic+" - "+hfc+") no es usado todavia en compensaciones-rango puede ser recalculado");
												eliminado = compensacionesDAO.deleteIntervaloCompensacion(registro,fechaEval,hic2,hfc2);
												if (log.isDebugEnabled()) log.debug("eliminado("+registro+"): " + eliminado);							
												if (eliminado==true){
													tieneLE= false;
													if (log.isDebugEnabled()) log.debug("tieneLE("+registro+"): " + tieneLE);
												}
											}
										}else{
											intervaloUsado = compensacionesDAO.findAcumDiferenteActual_ByRangos(registro,new FechaBean(fechaEval).getSQLDate(),(String)intervaloExtraAct.get("hini"),(String)intervaloExtraAct.get("hfin"));
											if (intervaloUsado!=null && intervaloUsado.size()>0){
												for (int v = 0; v < intervaloUsado.size(); v++) {
													Usado = (Map)intervaloUsado.get(v);
													if (log.isDebugEnabled()) log.debug("intervaloUsado("+registro+"): " + intervaloUsado);																						
													hic = (String)Usado.get("hor_ini_comp");
													hfc = (String)Usado.get("hor_fin_comp");
													ind = (String)Usado.get("ind_comp"); //1=autorizado con saldo /3=compensado sin saldo
													acumulado = (Integer)Usado.get("cnt_min_comp_acu");//
													saldo = (Integer)Usado.get("cnt_min_comp_sal");//
													estado = ind.equals("1")?"Autorizado usandose":"Compensado sin saldo";
													error = "No se puede procesar intervalo extra ("+ intervaloExtraAct.get("hini").toString()+" - "+intervaloExtraAct.get("hfin").toString()+") para fecha: "+fechaEval+ " porque tiene intervalo ("+ hic + " - " + hfc + ") "+ estado+". Acumulado: "+String.valueOf(acumulado.intValue())+" - Saldo: "+String.valueOf(saldo.intValue());
													texto = regimen + " " + registro + " " + nombres + "  " + error;
													if (log.isDebugEnabled()) log.debug("rango de fecha usado o en uso("+registro+"): " + texto);
													super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);
												}	
											}else{
												if (log.isDebugEnabled()) log.debug("No cruza con ningun rango existente en bolsa("+registro+"): (" + intervaloExtraAct.get("hini").toString()+" - "+intervaloExtraAct.get("hfin").toString()+")");	
												tieneLE= false;
											}
										}
									}else{
										error = "No se puede procesar fecha: "+fechaEval+ " porque tiene intervalo(s) de compensacion autorizados por la migracion del anterior proceso";
										texto = regimen + " " + registro + " " + nombres + "  " + error;
										if (log.isDebugEnabled()) log.debug("fecha con horas migradas autorizadas("+registro+"): " + texto);
										super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);						    			
									}
								}//fin tieneLE=true
								//FIN ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100
								
								if (tieneLE==false){ ////ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100 (solo add if)	
									//solo se generara LE si "no existe LE para la fecha" o "no existe LE para el rango evaluado de la fecha (acumulado igual a su actual-no fue usado todavia)"
									
									intervalosCompensa = calcularIntervalosHorasCompensacion(dbpool,registro,uuoo,fechaEval,intervaloExtraAct);
									
									if (intervalosCompensa!=null && !intervalosCompensa.isEmpty()){
										log.debug("intervalosCompensa("+registro+"): " + intervalosCompensa);
										List aut = (List)intervalosCompensa.get("intervalosAutorizados");
										List noAut = (List)intervalosCompensa.get("intervalosNoAutorizados");
										List rech = (List)intervalosCompensa.get("intervalosRechazados");
										
										if(aut!=null && aut.size()>0){
											log.debug("aut("+registro+"): " + aut);
											for (int a = 0; a < aut.size(); a++) {
												Map rango = (Map)aut.get(a);
												log.debug("rango("+registro+"): " + rango);
												listaAut.add(rango);
												log.debug("listaAut("+registro+"): " + listaAut);
												listaTotalAut.add(rango);				    												
												log.debug("listaTotalAut("+registro+"): " + listaTotalAut);
											}			    											
										}
										if(noAut!=null && noAut.size()>0){
											log.debug("noAut("+registro+"): " + noAut);
											for (int na = 0; na < noAut.size(); na++) {
												Map rango = (Map)noAut.get(na);
												log.debug("rango("+registro+"): "+ rango);
												listaNoAut.add(rango);
												log.debug("listaNoAut("+registro+"): " + listaNoAut);
											}			    											
										}
										if(rech!=null && rech.size()>0){
											log.debug("rech("+registro+"): " + rech);
											for (int r = 0; r < rech.size(); r++) {
												Map rango = (Map)rech.get(r);
												log.debug("rango("+registro+"): " + rango);
												listaRech.add(rango);
												log.debug("listaRech("+registro+"): " + listaRech);
											}			    											
										}			    										
									}	
								}//ICAPUNAY-PAS20144EB20000144-Optimizacion Labor Excepcional-Memo 31-2013-4F3100 (solo add })		
							}//fin for intervalos													
						}//fin > 10
					}//fin intervalos_HorExt!=null												
				}//fin mHorasExtras!=null											
			}//fin horaFin!""
			log.debug("registro ("+registro+"): FIN ES -=acumular2LaborExcepcional=-");
			labor.put("listaAut",listaAut);
			labor.put("listaTotalAut",listaTotalAut);
			labor.put("listaNoAut",listaNoAut);
			labor.put("listaRech",listaRech);
		
		} catch (Exception e){
			error = "No se puede procesar fecha("+registro+"): "+fechaEval+ " por error: "+e.toString()+ " metodo:acumular2LaborExcepcional()";
			texto = regimen + " " + registro + " " + nombres + "  " + error;
			if (log.isDebugEnabled()) log.debug("error("+registro+"): " + texto);
			super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);				
		}
		return labor;
	}
	
	/**
	 * Metodo encargado de insertar labor excepcional no autorizada para una fecha	
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @param mapa Map 
	 * @return laborNoAut Map
	 * @throws FacadeException
	 */
	public Map registrarLaborNoAutorizada(Map mapa) throws RemoteException {
		
		Map laborNoAut = new HashMap();
		int nroNoAut = 0;//nro de no autorizados insertado x fecha
		List listaNoAut_final = null;
		listaNoAut_final = new ArrayList();//lista de intervalos no autorizados final x fecha
		String dbpool = mapa.get("dbpool")!=null?mapa.get("dbpool").toString():"";
		DataSource dgsp = sl.getDataSource("java:comp/env/jdbc/dgsp");
		T4821DAO detalleDAO = new T4821DAO(dbpool); //t4821solicituddet de rrhh
		T4819DAO compensacionesDAO = new T4819DAO(dgsp);
		boolean insertoCompensacion = false;
				
		List listaNoAut = mapa.get("listaNoAut")!=null?(List)mapa.get("listaNoAut"):new ArrayList();		
		String fechaEval = mapa.get("fechaEval")!=null?mapa.get("fechaEval").toString():"";			
		try {
			
			if(listaNoAut!=null && listaNoAut.size()>0){
				log.debug("listaNoAut: " + listaNoAut);				
				log.debug("listaNoAut_final: " + listaNoAut_final);
				Map mapaNoAut = new HashMap();			    	
				//INSERCION X FECHA DE TODOS INTERVALOS DE COMPENSACION NO AUTORIZADOS en BD
				for (int na = 0; na < listaNoAut.size(); na++) {
					mapaNoAut = (Map)listaNoAut.get(na);//mapaNoAut=17:00:00-19:53:40
					log.debug("mapaNoAut: " + mapaNoAut);

					List listInterSolic = detalleDAO.findIntervalosIntersectados(Constantes.MOV_LABOR_EXCEPCIONAL,mapaNoAut);			    		
					if(listInterSolic!=null && listInterSolic.size()>0){//lisInterSolic.size()=3			    				
						log.debug("intervalo: "+mapaNoAut.get("hor_ini_comp").toString()+" - "+mapaNoAut.get("hor_fin_comp").toString()+" SI intersecta con intervalos de solicitudes de labor en seguimiento: "+listInterSolic);		    			
						List lista = calcularTotalIntervalosNoAutorizados (mapaNoAut,listInterSolic);
						//lista(0)= 17:00:00-17:20:00///lista(1)= 17:40:00-18:00:00///lista(2)= 18:20:00-18:40:00///lista(3)= 19:00:00-19:53:40
						if(lista!=null && lista.size()>0){
							for (int li = 0; li < lista.size(); li++) {
								mapaNoAut = (Map)lista.get(li);//mapaNoAut=17:00:00-17:20:00
								log.debug("mapaNoAut: " + mapaNoAut);
								listaNoAut_final.add(mapaNoAut);
							}			    				
						}			    			
					}else{
						log.debug("intervalo: "+mapaNoAut.get("hor_ini_comp").toString()+" - "+mapaNoAut.get("hor_fin_comp").toString()+" NO intersecta con ningun intervalo de solicitudes de labor en seguimiento");				    		
						listaNoAut_final.add(mapaNoAut);				    		
					}			    				    		
				}//fin for listaNoAut

				//insertando rangos no autorizados finales en tabla t4819compensacion
				if(listaNoAut_final!=null && listaNoAut_final.size()>0){
					log.debug("insertando rangos no autorizados finales en tabla t4819compensacion");
					log.debug("listaNoAut_final: " + listaNoAut_final);
					log.debug("listaNoAut_final.size(): " + listaNoAut_final.size());
					for (int y = 0; y < listaNoAut_final.size(); y++) {
						Map mapaNoAut_final = (Map)listaNoAut_final.get(y);
						log.debug("mapaNoAut_final: " + mapaNoAut_final);
						Map existePermanencia = compensacionesDAO.findPermanenciaExtraByPk(mapaNoAut_final);
						if (existePermanencia!=null && !existePermanencia.isEmpty()){
							log.debug("Ya existe permanencia registrada: "+existePermanencia+". No se se puede registrar sgte permanencia: "+mapaNoAut_final+".");
						}else{
							insertoCompensacion = compensacionesDAO.insertIntervaloCompensacion(mapaNoAut_final);
							if (insertoCompensacion==true){//si inserto intervalo compensacion NO AUTORIZADA								
								nroNoAut = nroNoAut + 1;
								log.debug("nroNoAut: " + nroNoAut);
							}else{
								log.debug("Para fecha: "+fechaEval+" No se inserto intervalo compensacion NO AUTORIZADA-mapaNoAut_final: "+mapaNoAut_final);
							}	
						}						
					}
					log.debug("fin insertando rangos no autorizados finales en tabla t4819compensacion");
				}
				//fin insertando rangos	
			}		
			laborNoAut.put("listaNoAut_final",listaNoAut_final);
			laborNoAut.put("nroNoAut",nroNoAut+"");			
		
		} catch (Exception e){
			log.debug("error: "+ e.toString() );
			log.error(e);				
		}
		return laborNoAut;
	}
	
	/**
	 * Metodo encargado de insertar labor excepcional autorizada para una fecha	
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @param mapa Map
	 * @return laborAut Map	
	 * @throws FacadeException
	 */
	public Map registrarLaborAutorizada(Map mapa) throws RemoteException {
		
		int nroAut = 0;//nro de autorizados insertado x fecha		
		DataSource dgsp = sl.getDataSource("java:comp/env/jdbc/dgsp");
		Map laborAut = new HashMap();
		
		T4819DAO compensacionesDAO = new T4819DAO(dgsp);
		boolean insertoCompensacion = false;
				
		List listaAut = mapa.get("listaAut")!=null?(List)mapa.get("listaAut"):new ArrayList();		
			
		try {
			
			if(listaAut!=null && listaAut.size()>0){
				log.debug("listaAut: " + listaAut);				
				for (int na1 = 0; na1 < listaAut.size(); na1++) {
					Map mapaInsercion = (Map)listaAut.get(na1);
					log.debug("mapaInsercion: " + mapaInsercion);
					Map existePermanencia = compensacionesDAO.findPermanenciaExtraByPk(mapaInsercion);
					if (existePermanencia!=null && !existePermanencia.isEmpty()){
						log.debug("Ya existe permanencia registrada: "+existePermanencia+". No se se puede registrar sgte permanencia: "+existePermanencia+".");
					}else{
						insertoCompensacion = compensacionesDAO.insertIntervaloCompensacion(mapaInsercion);
						if (insertoCompensacion==true){//si inserto intervalo compensacion AUTORIZADA								
							nroAut = nroAut + 1;
							log.debug("nroAut: " + nroAut);
						}else{
							log.debug("No se inserto intervalo compensacion AUTORIZADA-mapaInsercion: "+mapaInsercion);
						}	
					}    			
				}							    
			}			
			laborAut.put("nroAut",nroAut+"");	
		
		} catch (Exception e){
			log.debug("error: "+ e.toString() );
			log.error(e);				
		}	
		return laborAut;
	}
	
	/**
	 * Metodo encargado de insertar labor excepcional rechazada para una fecha	
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @param mapa Map	 
	 * @throws FacadeException
	 */
	public void registrarLaborRechazada(Map mapa) throws RemoteException {
		
		DataSource dgsp = sl.getDataSource("java:comp/env/jdbc/dgsp");		
		T4819DAO compensacionesDAO = new T4819DAO(dgsp);
		boolean insertoCompensacion = false;
				
		List listaRech = mapa.get("listaRech")!=null?(List)mapa.get("listaRech"):new ArrayList();		
			
		try {
			
			if(listaRech!=null && listaRech.size()>0){
				log.debug("listaRech: " + listaRech);					
				for (int nr = 0; nr < listaRech.size(); nr++) {
					Map mapaInsercion = (Map)listaRech.get(nr);
					log.debug("mapaInsercion: " + mapaInsercion);
					Map existePermanencia = compensacionesDAO.findPermanenciaExtraByPk(mapaInsercion);
					if (existePermanencia!=null && !existePermanencia.isEmpty()){
						log.debug("Ya existe permanencia registrada: "+existePermanencia+". No se se puede registrar sgte permanencia: "+existePermanencia+".");
					}else{
						insertoCompensacion = compensacionesDAO.insertIntervaloCompensacion(mapaInsercion);
						if (insertoCompensacion==true){//si inserto intervalo compensacion RECHAZADA								
							log.debug("Se inserto intervalo compensacion RECHAZADA-mapaInsercion: "+mapaInsercion);								
						}else{
							log.debug("No se inserto intervalo compensacion RECHAZADA-mapaInsercion: "+mapaInsercion);
						}	
					}						    			
				}					
			}		
		
		} catch (Exception e){
			log.debug("error: "+ e.toString() );
			log.error(e);				
		}		
	}
	
	/**
	 * Metodo encargado de autogenerar solicitud de labor excepcional para una fecha	
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @param mapa Map	
	 * @throws FacadeException
	 */
	public boolean autogenerarSolicitudLabor(Map mapa) throws RemoteException {
		boolean res = true;		
		int nroNoAut = 0;//nro de no autorizados insertado x fecha
		
		String dbpool = mapa.get("dbpool")!=null?mapa.get("dbpool").toString():"";		
		T4821DAO detalleDAO = new T4821DAO(dbpool); //t4821solicituddet de rrhh		
		pe.gob.sunat.sp.asistencia.dao.T1277DAO soliDAO = new pe.gob.sunat.sp.asistencia.dao.T1277DAO();//t1277 de sp
		T1455DAO seguiDAO = new T1455DAO(dbpool); //t1455 de rrhh
		T1279DAO movDAO = new T1279DAO();
		CorreoDAO correoDAO = new CorreoDAO();			
		T02DAO personalDAO = new T02DAO();
		DataSource dsOracle = sl.getDataSource("java:comp/env/pool_oracle");		
				
		List listaNoAut_final = mapa.get("listaNoAut_final")!=null?(List)mapa.get("listaNoAut_final"):new ArrayList();
		List listaNoAut = mapa.get("listaNoAut")!=null?(List)mapa.get("listaNoAut"):new ArrayList();	
		String m_nroNoAut = mapa.get("nroNoAut")!=null?mapa.get("nroNoAut").toString().trim():"";
		if (!m_nroNoAut.equals("")) nroNoAut = Integer.parseInt(m_nroNoAut.trim());	
		String regimen = mapa.get("regimen")!=null?mapa.get("regimen").toString():"";
		String registro = mapa.get("registro")!=null?mapa.get("registro").toString():"";
		String uuoo = mapa.get("uuoo")!=null?mapa.get("uuoo").toString():"";
		String nombres = mapa.get("nombres")!=null?mapa.get("nombres").toString():"";
		String fechaEval = mapa.get("fechaEval")!=null?mapa.get("fechaEval").toString():"";	
		String usuario = mapa.get("usuario")!=null?mapa.get("usuario").toString():"";
		String texto="";
		String error="";
		
		try {
			
			//nueva solicitud 124 autogenerada de labor excepcional para todos los "intervalos de compensacion no autorizados de la fecha"	
			if(listaNoAut_final!=null && listaNoAut_final.size()>0){
				log.debug("nroNoAut: " + nroNoAut);
				log.debug("listaNoAut.size(): " + listaNoAut.size());
				log.debug("listaNoAut_final.size(): " + listaNoAut_final.size());
				Map mapaAprob = null;
				//Map mapaAprob = new HashMap();
				mapaAprob = new HashMap();
				mapaAprob.put("colab",registro);
				mapaAprob.put("uuooColab",uuoo);
				mapaAprob.put("fecha",fechaEval);
				log.debug("mapaAprob: " + mapaAprob);
				Map aprobador = null;
				aprobador = new HashMap();
				aprobador = this.findAprobadoresSolicitudLaborExcep(dbpool,mapaAprob);
				//Map aprobador = this.findAprobadoresSolicitudLaborExcep(dbpool,mapaAprob);
				if(aprobador!=null && !aprobador.isEmpty()){
					log.debug("aprobador: " + aprobador); 			    				
					if (aprobador.get("receptorSolic")!=null){
						String cod_ReceptorSol = "";
						cod_ReceptorSol = (String)aprobador.get("receptorSolic");//NI60 cuser_dest de la t1455sol_seg
						//String cod_ReceptorSol = (String)aprobador.get("receptorSolic");//NI60 cuser_dest de la t1455sol_seg
						boolean solicitud = false;
						boolean seguimiento = false;
						boolean detalle = false;
						int nroDetalle = 0;
						//registramos la solicitud
						String annoSol = Utiles.obtenerAnhoActual();								
						OracleSequenceDAO seqDAO = new OracleSequenceDAO();
						String numeroSol = seqDAO.getSequenceDS(dsOracle,Constantes.SEQ_SOLICITUD);//numero solicitud
						String movimiento = Constantes.MOV_LABOR_EXCEPCIONAL;
						String asuntoCorto = "Solicitud autogenerada";
						String asunto = "Solicitud autogenerada de labor excepcional";
						String observ = "Fecha Permanencia no autorizada: "+fechaEval;				    			
						String user_crea = "SIRH";
						//String fechaCreacion = new FechaBean().getFormatDate("dd/MM/yyyy");

						solicitud = soliDAO.insertRegistroSolicitud(dbpool,annoSol,new Integer(numeroSol),uuoo,registro,							
								//asuntoCorto,"",movimiento,fechaCreacion,fechaCreacion,Integer.parseInt("0"),"","2",//estado=2 (est_id=2 tabla t1277solicitud) para solicitud autogenerada
								asuntoCorto,"",movimiento,fechaEval,fechaEval,Integer.parseInt("1"),"","2",//estado=2 (est_id=2 tabla t1277solicitud) para solicitud autogenerada
								observ,user_crea,user_crea);
						log.debug("solicitud: " + solicitud);

						if(solicitud==true){
							//insertando detalles de intervalos no autorizados en la t4821solicituddet
							for (int p = 0; p < listaNoAut_final.size(); p++) {
								log.debug("listaNoAut_final: " + listaNoAut_final);
								Map rangoNoAut =  (Map)listaNoAut_final.get(p);
								log.debug("rangoNoAut: " + rangoNoAut);
								Map mapaDetalle = new HashMap();
								mapaDetalle.put("ann_sol",annoSol);
								mapaDetalle.put("num_sol",new Integer(numeroSol));
								mapaDetalle.put("cod_uo_sol",uuoo);
								mapaDetalle.put("cod_pers_sol",registro);
								mapaDetalle.put("cod_mov_sol",movimiento);
								//mapaDetalle.put("fec_registro_sol",Utiles.stringToTimestamp(fechaCreacion + " 00:00:00"));
								mapaDetalle.put("fec_registro_sol",new FechaBean().getTimestamp());
								mapaDetalle.put("num_detalle",new Integer(p+1));
								mapaDetalle.put("fec_permiso",new FechaBean(fechaEval).getSQLDate());
								mapaDetalle.put("hor_ini_permiso",(String)rangoNoAut.get("hor_ini_comp"));
								mapaDetalle.put("hor_fin_permiso",(String)rangoNoAut.get("hor_fin_comp"));
								mapaDetalle.put("obs_sustento_obs",asunto);
								mapaDetalle.put("cod_user_crea",user_crea);
								mapaDetalle.put("fec_creacion",new FechaBean().getTimestamp());
								log.debug("mapaDetalle: " + mapaDetalle);
								//insertar detalle en t4821
								detalle = detalleDAO.insertDetalleSolicitud(mapaDetalle);
								log.debug("detalle: " + detalle);
								if (detalle==true) nroDetalle = nroDetalle + 1;
								log.debug("nroDetalle: " + nroDetalle);
							}
							//fin detalles

							log.debug("listaNoAut_final.size() a insertar: " + listaNoAut_final.size());
							log.debug("nroDetalle insertados: " + nroDetalle);				    				
							//insertando seguimiento en la t1455sol_seg
							Map mapaSegui = new HashMap();
							mapaSegui.put("anno",annoSol);
							mapaSegui.put("numero", new Integer(numeroSol));//										
							mapaSegui.put("u_organ",uuoo);
							mapaSegui.put("cod_pers",registro);
							mapaSegui.put("num_seguim", "0");
							mapaSegui.put("fecha_recep",new FechaBean().getTimestamp());
							mapaSegui.put("fecha_deriv",null);
							mapaSegui.put("accion_id",Constantes.ACCION_INICIAR);//1
							mapaSegui.put("estado_id", Constantes.ESTADO_SEGUIMIENTO);//1
							mapaSegui.put("cuser_orig",registro);
							mapaSegui.put("cuser_dest",cod_ReceptorSol);//NI60
							mapaSegui.put("tobserv",asunto);
							mapaSegui.put("fcreacion", new FechaBean().getTimestamp());
							mapaSegui.put("cuser_crea",user_crea);
							log.debug("seguiDAO.insertarSeguimientoSol(mapaSegui)... mapaSegui: "+mapaSegui);
							seguimiento = seguiDAO.insertarSeguimientoSol(mapaSegui);
							log.debug("seguimiento: " + seguimiento);
							//fin insertando seguimiento
							if (seguimiento==true){					    						
								HashMap tipoMov = movDAO.findByMov(dbpool,movimiento);
								String origen = registro;
								String destino = cod_ReceptorSol;
								String tipoSol = (String) tipoMov.get("descrip");
								try{		
									ResourceBundle bundle = ResourceBundle.getBundle("pe.gob.sunat.sp.asistencia.sirh");
									String servidorIP = bundle.getString("servidorIP");
									//String mensaje = "Ud. ha recibido una nueva solicitud electr&oacute;nica de <strong>"+ tipoSol + "</strong>.";									
									String mensaje = "Ud. ha recibido una nueva <strong> PAPELETA "+ "AUTOGENERADA DE "+tipoSol + " N? "+annoSol+"-"+numeroSol+"</strong> por el(la):";
									String mensajeColab = "para el " + fechaEval ;
									String programa = bundle.getString("programa1");
									String url = MenuCliente.generaInvocacionURL(programa,null,true,MenuCliente.INTRANET,"/ol-ti-iaasistencia/asisS11Alias");
									String strURL = "http://"+servidorIP+url;
									log.debug("URL "+url);
									log.debug("strURL "+strURL);
									String nombre = personalDAO.findNombreCompletoByCodPers(dbpool, destino);
									String nombreColab = personalDAO.findNombreCompletoByCodPers(dbpool, origen);
									nombre = destino +" - "+nombre;
									nombreColab = origen +" - "+nombreColab;									
									//String textoCorreo = Utiles.textoCorreoProceso(dbpool, nombre, mensaje, strURL);
									String textoCorreoJefe = Utiles.textoCorreoaJefes(dbpool, nombre, mensaje, strURL,nombreColab,mensajeColab);
									log.debug("textoCorreoJefe: " + textoCorreoJefe);
									//enviamos el mail al Receptor de la solicitud
									HashMap datos = new HashMap();
									//datos.put("subject", "Solicitud de Asistencia");
									datos.put("subject", "Papeleta de Asistencia");
									datos.put("message", textoCorreoJefe);
									datos.put("from", correoDAO.findCorreoByCodPers(dbpool,origen));
									datos.put("to", correoDAO.findCorreoByCodPers(dbpool, destino));
									QueueDAO queue = new QueueDAO();
									log.debug("datos: " + datos);
									queue.enviaCorreo(datos);
									//fin enviamos el mail al Receptor de la solicitud
									if (log.isDebugEnabled()) log.debug("Se envio correo a jefe: "+destino);
								} catch (CorreoException ce) {			    								
									error = "No se envio correo a jefe: "+destino+ " por solicitud autogenerada de labor excepcional no autorizada para la fecha: "+ fechaEval+" por error: "+ce.toString();
									texto = regimen + " " + registro + " " + nombres + "  " + error;
									if (log.isDebugEnabled()) log.debug("error envio correo jefe: " + texto);
									super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);
									res = false;
								}	
							}			
						}else{
							error = "No se registro solicitud autogenerada a colaborador: "+registro+ " para fecha de permanencia no autorizada: "+ fechaEval;
							texto = regimen + " " + registro + " " + nombres + "  " + error;
							if (log.isDebugEnabled()) log.debug("4ta validacion: " + texto);
							super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);
							res = false;
						}
						//fin registramos
					} else{
						List errores = (List)aprobador.get("errores");
						log.debug("lista errores: " + errores);	 
						if (errores!=null && errores.size()>0){
							for (int e = 0; e < errores.size(); e++) {
								error = (String)errores.get(e);
								texto = regimen + " " + registro + " " + nombres + "  " + error;
								if (log.isDebugEnabled()) log.debug("4ta validacion: " + texto);
								super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);						    							    		
							}
							res = false;
						}				    				
					}//fin receptorSolic							
				}			    	
			}			    	
			//nueva solicitud 124 autogenerada de labor excepcional para todos los "intervalos de compensacion no autorizados de la fecha"			
		
		} catch (Exception e){
			res=false;
			error = e.toString();
			texto = regimen + " " + registro + " " + nombres + "  " + "error catch: "+error;
			if (log.isDebugEnabled()) log.debug("error: " + texto);
			super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);		
			log.error(e);					
		}
		return res;
	}
	
	/**
	 * Metodo encargado de enviar correo al colaborador con intervalos de labor autorizada para un rango de fechas o una fecha	
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @param mapa Map	
	 * @param res boolean
	 * @throws FacadeException
	 */
	public boolean enviarCorreoLaborAutorizada(Map mapa) throws RemoteException {
		boolean res = true;		
		int nroAut = 0;//nro de no autorizados insertado x fecha
		
		String dbpool = mapa.get("dbpool")!=null?mapa.get("dbpool").toString():"";		
		CorreoDAO correoDAO = new CorreoDAO();			
		T12DAO t12DAO= new T12DAO();//tabla t12uorga
		log.debug("ingreso a enviarCorreoLaborAutorizada(mapa): "+mapa);			
		List listaTotalAut = mapa.get("listaTotalAut")!=null?(List)mapa.get("listaTotalAut"):new ArrayList();			
		String m_nroAut = mapa.get("nroAut")!=null?mapa.get("nroAut").toString().trim():"";
		if (!m_nroAut.equals("")) nroAut = Integer.parseInt(m_nroAut.trim());	
		String regimen = mapa.get("regimen")!=null?mapa.get("regimen").toString():"";
		String registro = mapa.get("registro")!=null?mapa.get("registro").toString():"";
		String uuoo = mapa.get("uuoo")!=null?mapa.get("uuoo").toString():"";
		String nombres = mapa.get("nombres")!=null?mapa.get("nombres").toString():"";
		String fechaIni = mapa.get("fechaIni")!=null?mapa.get("fechaIni").toString():"";
		String fechaFin = mapa.get("fechaFin")!=null?mapa.get("fechaFin").toString():"";	
		String usuario = mapa.get("usuario")!=null?mapa.get("usuario").toString():"";
		String texto="";
		String error="";
		
		try {
			
			if(listaTotalAut!=null && listaTotalAut.size()>0){    
				log.debug("listaTotalAut: " + listaTotalAut);
				log.debug("nroAut: " + nroAut);
				log.debug("listaTotalAut.size(): " + listaTotalAut.size());
				String direCorreo = "";
				String cod_persJefe = "";
				String direCorreoJefe = "";
				direCorreo=correoDAO.findCorreoByCodPers(dbpool,registro);
				if (!direCorreo.equals("")) {		    			
					if (log.isDebugEnabled()) log.debug("direCorreo Trabajador= " + direCorreo);
					if(uuoo!=null && !uuoo.equals("")){
						Map mapa_Jefe = null;
						//Map mapa_Jefe = new HashMap();
						mapa_Jefe = new HashMap();
						mapa_Jefe = t12DAO.findJefeByTrabajador(dbpool,uuoo,registro);							
						if (mapa_Jefe.get("t12cod_jefe_final") != null	&& !mapa_Jefe.get("t12cod_jefe_final").toString().trim().equals("")) {								
							cod_persJefe = mapa_Jefe.get("t12cod_jefe_final").toString().trim();								
							direCorreoJefe=correoDAO.findCorreoByCodPers(dbpool,cod_persJefe);
							if (log.isDebugEnabled()) log.debug("cod_persJefe= " + cod_persJefe);
							if (log.isDebugEnabled()) log.debug("direCorreoJefe= " + direCorreoJefe);
						}		    				
					}		    			
					try{
						String mensaje = "";
						StringBuffer sb_mensaje = new StringBuffer("");
						String mensajeF = "";
						String mensajeI = "Se le informa que ha generado labor excepcional, al haberse "+
						"verificado las permanencias y solicitudes autorizadas en el intervalo del " + fechaIni + " al " + fechaFin + ".";
						if (log.isDebugEnabled()) log.debug("mensajeI: " + mensajeI);

						sb_mensaje.append("<tr><td>&nbsp;</td></tr>")							
						.append("<tr><td style='background-color:#B6CBEB;'>")							
						.append(generaTablaLaborAutorizada(listaTotalAut))//listaTotalAut debe tener el campo "obs_sustento" de la t4818autorizaexc
						.append("</td></tr><tr><td>&nbsp;</td></tr>");									

						if (log.isDebugEnabled()) log.debug("sb_mensaje: " + sb_mensaje);							
						mensajeF = mensajeI + sb_mensaje.toString();
						if (log.isDebugEnabled()) log.debug("mensajeF: " + mensajeF);

						Map mParams = new HashMap();
						mParams.put("fec_notificacion",new FechaBean().getFormatDate("dd/MM/yyyy"));//fecha de envio
						mParams.put("registro",registro);//mostrar registro 17/05/2012
						mensaje = this.textoCorreoLaborExcepcional(mParams,nombres,mensajeF);//devuelve todo el mensajeF en html
						if (log.isDebugEnabled()) log.debug("mensaje formateado: " + mensaje);
						if (!mensaje.equals("")){
							Correo objCorreo = new Correo(mensaje);									
							objCorreo.setServidor(propiedadesCorreo.leePropiedad("servidor"));									
							objCorreo.setRemitente(propiedadesCorreo.leePropiedad("correoRemitenteMovimientos"),propiedadesCorreo.leePropiedad("nombreRemitenteMovimientos"));										
							if(!direCorreo.equals("")){
								objCorreo.agregarDestinatario(direCorreo.trim());
								/*if(!direCorreoJefe.equals("")){
									objCorreo.agregarConCopia(direCorreoJefe.trim());
								}*/ //no definido en F2											
							}							
							objCorreo.setAsunto("Notificaci?e labor excepcional autorizada");
							objCorreo.enviarHtml();
							if (log.isDebugEnabled()) log.debug("Se envio correo a colaborador: "+registro);
						}
						log.debug("sale de enviarCorreoLaborAutorizada(mapa): "+mapa);
					} catch (CorreoException ce) {		    			
						error = "No se envio correo a colaborador: "+registro+ " con intervalos de compensaciones autorizadas del "+ fechaIni + " al "+fechaFin+" por error: "+ce.toString();
						texto = regimen + " " + registro + " " + nombres + "  " + error;
						if (log.isDebugEnabled()) log.debug("error envio correo colaborador: " + texto);
						super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);
						res=false;
					}		    			
				}//tiene correo colaborador
				else{		    	
					error = "No se envio correo a colaborador: "+registro+ " con intervalos de compensaciones autorizadas del "+ fechaIni + " al "+fechaFin+" por no tener correo";
					texto = regimen + " " + registro + " " + nombres + "  " + error;
					if (log.isDebugEnabled()) log.debug("no tiene correo colaborador: " + texto);
					super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);
					res=false;
				}	    	
			}			
		
		} catch (Exception e){
			res=false;
			error = e.toString();
			texto = regimen + " " + registro + " " + nombres + "  " + "error catch: "+error;
			if (log.isDebugEnabled()) log.debug("error: " + texto);
			super.escribe(texto,"PROCESO DE ACUMULACION DE HORAS EXTRAS", (HashMap)mapa, usuario);		
			log.error(e);					
		}
		return res;
	}
	
	/**
	 * Calcular rangos de permanencia para administtrativos y operativos con turnos de trabajo de 1 dia (hfin>hinicio) segun marcaciones
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public HashMap calcularRangosPermanenciaExtra(String dbpool, String codpers, BeanHoraExtra he,String HoraIni, String HoraFin )
			throws RemoteException {

		float cantidad = 0;
		String hora = "";
		String hora0 = "";
		HashMap PE = new HashMap();
		
		List lista = new ArrayList();//lista que guarada los intervalos de tiempo de permanencia extra.
		
		try {
			T1275DAO daoMarcacion = new T1275DAO();			
			
			String fecha = he.getFechaAutorizacion() != null ? he.getFechaAutorizacion().trim() : "";
			String horaIni = he.getHoraIni() != null ? he.getHoraIni().trim() : "";
			String horaFin = he.getHoraSalida() != null ? he.getHoraSalida().trim() : "";
			
			if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtra - he.getHoraIni()("+codpers+"): " + he.getHoraIni());
			if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtra - he.getHoraSalida()("+codpers+"): " + he.getHoraSalida());
			
			
			//obtenemos las marcaciones del dia para el rango [00:00:00-23:59:59]				
			ArrayList marcaciones = daoMarcacion.findByCodPersFechaRangosHoras(dbpool, codpers, fecha,HoraIni,HoraFin);
			if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtra - marcaciones("+codpers+"): " + marcaciones);

			BeanMarcacion marca = null;
			BeanMarcacion marca1 = null;
			if (marcaciones!=null && marcaciones.size()>0){
				if (marcaciones.size()%2==0){//PARES requiere
					marca1 = (BeanMarcacion) marcaciones.get(0);
					hora0 = marca1.getHora();
					for (int i=0; i<marcaciones.size();i++){

						marca = (BeanMarcacion) marcaciones.get(i);
						hora = marca.getHora();					
						if (hora.trim().equals(Constantes.SALIDA) || hora.compareTo(horaFin)>0) {
							hora = horaFin;
						}							
						if (hora.compareTo(horaIni)>=0){							
							//Marcaciones pares son entradas
							//Marcaciones impares son salidas 
							if (i%2==1){//si marcacion es impar
								log.debug("Hora i%2 ==1("+codpers+"): "+ hora );							
								cantidad = cantidad + Utiles.obtenerMinutosDiferencia(horaIni, hora);									
								Map mapa = new HashMap();
								mapa.put("horaIni", horaIni);
								mapa.put("hora", hora);
								float dif = Utiles.obtenerMinutosDiferencia(horaIni, hora);
								int can = Math.round(dif);
								mapa.put("diferencia", String.valueOf(can));
								if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtra - mapa("+codpers+"): " + mapa);
								if(!horaIni.equals(hora)){
									lista.add(mapa);
								}									
							}
							else{
								log.debug("Hora i%2!=1("+codpers+"): "+ hora );
								horaIni = hora;
							}
						}							
					}
				}
			}					
			
		} catch (Exception e){
			log.error(e);			
		}
		int canti = Math.round(cantidad);
		PE.put("cantidad",String.valueOf(canti));
		PE.put("hora", hora);
		PE.put("hora0", hora0);		
		PE.put("intervalos", lista);		
		return PE;
	}
	//FIN ICAPUNAY 05/10/2012 AJUSTES AOM 06A4T11 LABOR EXCEPCIONAL
	
	/**
	 * Calcular rangos de permanencia para operativos con turnos de trabajo de 2 dias (hfin<=hinicio) segun marcaciones por dia de trabajo
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public HashMap calcularRangosPermanenciaExtraOperativoEntrada(String dbpool, String codpers, BeanHoraExtra he,String HoraIni, String HoraFin)
			throws RemoteException {

		float cantidad = 0;
		String hora = "";
		String hora0 = "";
		HashMap PE = new HashMap();
		
		List lista = new ArrayList();//lista que guarada los intervalos de tiempo de permanencia extra.
		
		try {
			T1275DAO daoMarcacion = new T1275DAO();			
			
			String fecha = he.getFechaAutorizacion() != null ? he.getFechaAutorizacion().trim() : "";
			String horaIni = he.getHoraIni() != null ? he.getHoraIni().trim() : "";
			String horaFin = he.getHoraSalida() != null ? he.getHoraSalida().trim() : "";
			
			if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtraOperativoEntrada - he.getHoraIni()("+codpers+"): " + he.getHoraIni());
			if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtraOperativoEntrada - he.getHoraSalida()("+codpers+"): " + he.getHoraSalida());
			
			//obtenemos las marcaciones del dia para el rango [00:00:00-horaIniTurnoDx]				
			ArrayList marcaciones = daoMarcacion.findByCodPersFechaRangosHoras(dbpool, codpers, fecha,HoraIni,HoraFin);			
			if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtraOperativoEntrada - marcaciones("+codpers+"): " + marcaciones);

			BeanMarcacion marca = null;
			BeanMarcacion marca1 = null;
			if (marcaciones!=null && marcaciones.size()>0){
				if (marcaciones.size()%2==1){//IMPARES requiere
					marca1 = (BeanMarcacion) marcaciones.get(0);
					hora0 = marca1.getHora();
					for (int i=0; i<marcaciones.size();i++){							
						marca = (BeanMarcacion) marcaciones.get(i);
						hora = marca.getHora();					
						if (hora.compareTo(horaFin)>0) {
							hora = horaFin;
						}							
						if (hora.compareTo(horaIni)>=0){							
							//Marcaciones pares son entradas
							//Marcaciones impares son salidas 
							if (i%2==1){//si marcacion es impar (salida)
								log.debug("Hora i%2 ==("+codpers+"): "+ hora );							
								cantidad = cantidad + Utiles.obtenerMinutosDiferencia(horaIni, hora);									
								Map mapa = new HashMap();
								mapa.put("horaIni", horaIni);
								mapa.put("hora", hora);
								float dif = Utiles.obtenerMinutosDiferencia(horaIni, hora);
								int can = Math.round(dif);
								mapa.put("diferencia", String.valueOf(can));
								if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtraOperativoEntrada - mapa("+codpers+"): " + mapa);
								if(!horaIni.equals(hora)){
									lista.add(mapa);
								}									
							}
							else{//par (entrada)
								log.debug("Hora i%2!=1("+codpers+"): "+ hora );
								horaIni = hora;
								if (i==marcaciones.size()-1){//ultimo
									log.debug("registro ("+codpers+"): ultima o unica marcacion");
									hora=horaFin;
									cantidad = cantidad + Utiles.obtenerMinutosDiferencia(horaIni, hora);									
									Map mapa1 = new HashMap();
									mapa1.put("horaIni", horaIni);
									mapa1.put("hora", hora);
									float dif = Utiles.obtenerMinutosDiferencia(horaIni, hora);
									int can = Math.round(dif);
									mapa1.put("diferencia", String.valueOf(can));
									if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtraOperativoEntrada - mapa1("+codpers+"): " + mapa1);
									if(!horaIni.equals(hora)){
										lista.add(mapa1);
									}			
								}
							}
						}							
					}
				}
			}				
				
		} catch (Exception e){
			log.error(e);			
		}
		int canti = Math.round(cantidad);
		PE.put("cantidad",String.valueOf(canti));
		PE.put("hora", hora);
		PE.put("hora0", hora0);		
		PE.put("intervalos", lista);		
		return PE;
	}
	//FIN ICAPUNAY 05/10/2012 AJUSTES AOM 06A4T11 LABOR EXCEPCIONAL
	
	/**
	 * Calcular rangos de permanencia para operativos con turnos de trabajo de 2 dias (hfin<=hinicio) segun marcaciones por dia de trabajo
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public HashMap calcularRangosPermanenciaExtraOperativoSalida(String dbpool, String codpers, BeanHoraExtra he,String HoraIni, String HoraFin)
			throws RemoteException {

		float cantidad = 0;
		String hora = "";
		String hora0 = "";
		HashMap PE = new HashMap();
		
		List lista = new ArrayList();//lista que guarada los intervalos de tiempo de permanencia extra.
		
		try {

			T1275DAO daoMarcacion = new T1275DAO();
			
			String fecha = he.getFechaAutorizacion() != null ? he.getFechaAutorizacion().trim() : "";
			String horaIni = he.getHoraIni() != null ? he.getHoraIni().trim() : "";
			String horaFin = he.getHoraSalida() != null ? he.getHoraSalida().trim() : "";
			
			if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtraOperativoSalida - he.getHoraIni()("+codpers+"): " + he.getHoraIni());
			if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtraOperativoSalida - he.getHoraSalida()("+codpers+"): " + he.getHoraSalida());
			
			
			//obtenemos las marcaciones del dia para el rango [horaFinTurnoDw-23:59:59]				
			ArrayList marcaciones = daoMarcacion.findByCodPersFechaRangosHoras(dbpool, codpers, fecha,HoraIni,HoraFin);				
			if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtraOperativoSalida - marcaciones("+codpers+"): " + marcaciones);

			BeanMarcacion marca = null;
			BeanMarcacion marca1 = null;
			if (marcaciones!=null && marcaciones.size()>0){
				if (marcaciones.size()%2==1){//IMPARES requiere
					marca1 = (BeanMarcacion) marcaciones.get(0);
					hora0 = marca1.getHora();
					for (int i=0; i<marcaciones.size();i++){							
						marca = (BeanMarcacion) marcaciones.get(i);
						hora = marca.getHora();					
						if (hora.compareTo(horaFin)>0) {
							hora = horaFin;
						}							
						if (hora.compareTo(horaIni)>=0){							
							//Marcaciones pares son salidas
							//Marcaciones impares son entradas 
							if (i%2==0){//si marcacion es par (salida)
								log.debug("Hora i%2 ==0("+codpers+"): "+ hora );							
								cantidad = cantidad + Utiles.obtenerMinutosDiferencia(horaIni, hora);									
								Map mapa = new HashMap();
								mapa.put("horaIni", horaIni);
								mapa.put("hora", hora);
								float dif = Utiles.obtenerMinutosDiferencia(horaIni, hora);
								int can = Math.round(dif);
								mapa.put("diferencia", String.valueOf(can));
								if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtraOperativoSalida - mapa("+codpers+"): " + mapa);
								if(!horaIni.equals(hora)){
									lista.add(mapa);
								}									
							}
							else{//impar (entrada)
								log.debug("Hora i%2!=0("+codpers+"): "+ hora );
								horaIni = hora;
							}
						}							
					}
				}
			}			
					
		} catch (Exception e){
			log.error(e);			
		}
		int canti = Math.round(cantidad);
		PE.put("cantidad",String.valueOf(canti));
		PE.put("hora", hora);
		PE.put("hora0", hora0);		
		PE.put("intervalos", lista);		
		return PE;
	}
	
	/**
	 * Calcular rangos de permanencia para operativos con turnos de trabajo de 2 dias (hfin<=hinicio) segun marcaciones por dia de trabajo
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public HashMap calcularRangosPermanenciaExtraOperativoIntermedio(String dbpool, String codpers, BeanHoraExtra he,String HoraIni, String HoraFin)
			throws RemoteException {

		float cantidad = 0;
		String hora = "";
		String hora0 = "";
		HashMap PE = new HashMap();
		
		List lista = new ArrayList();//lista que guarada los intervalos de tiempo de permanencia extra.
		
		try {

			T1275DAO daoMarcacion = new T1275DAO();			
			
			String fecha = he.getFechaAutorizacion() != null ? he.getFechaAutorizacion().trim() : "";
			String horaIni = he.getHoraIni() != null ? he.getHoraIni().trim() : "";
			String horaFin = he.getHoraSalida() != null ? he.getHoraSalida().trim() : "";
			
			if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtraOperativoIntermedio - he.getHoraIni()("+codpers+"): " + he.getHoraIni());
			if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtraOperativoIntermedio - he.getHoraSalida()("+codpers+"): " + he.getHoraSalida());
						
			//obtenemos las marcaciones del dia para el rango [horaFinTurnoDw-horaIniTurnoDx]				
			ArrayList marcaciones = daoMarcacion.findByCodPersFechaRangosHoras(dbpool, codpers, fecha,HoraIni,HoraFin);			
			if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtraOperativoIntermedio - marcaciones("+codpers+"): " + marcaciones);
				
			BeanMarcacion marca = null;
			BeanMarcacion marca1 = null;
			if (marcaciones!=null && marcaciones.size()>0){
				if (marcaciones.size()%2==0){//PARES requiere
					marca1 = (BeanMarcacion) marcaciones.get(0);
					hora0 = marca1.getHora();
					for (int i=0; i<marcaciones.size();i++){							
						marca = (BeanMarcacion) marcaciones.get(i);
						hora = marca.getHora();					
						if (hora.compareTo(horaFin)>0) {
							hora = horaFin;
						}							
						if (hora.compareTo(horaIni)>=0){							
							//Marcaciones pares son salidas
							//Marcaciones impares son entradas  
							if (i%2==0){//si marcacion es par (salida)
								log.debug("Hora i%2 ==0("+codpers+"): "+ hora );							
								cantidad = cantidad + Utiles.obtenerMinutosDiferencia(horaIni, hora);									
								Map mapa = new HashMap();
								mapa.put("horaIni", horaIni);
								mapa.put("hora", hora);
								float dif = Utiles.obtenerMinutosDiferencia(horaIni, hora);
								int can = Math.round(dif);
								mapa.put("diferencia", String.valueOf(can));
								if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtraOperativoIntermedio - mapa("+codpers+"): " + mapa);
								if(!horaIni.equals(hora)){
									lista.add(mapa);
								}									
							}
							else{//impar (entrada)
								log.debug("Hora i%2!=0("+codpers+"): "+ hora );
								horaIni = hora;
								if (i==marcaciones.size()-1){//ultimo
									log.debug("registro ("+codpers+"): ultima marcacion");
									hora=horaFin;
									cantidad = cantidad + Utiles.obtenerMinutosDiferencia(horaIni, hora);									
									Map mapa1 = new HashMap();
									mapa1.put("horaIni", horaIni);
									mapa1.put("hora", hora);
									float dif = Utiles.obtenerMinutosDiferencia(horaIni, hora);
									int can = Math.round(dif);
									mapa1.put("diferencia", String.valueOf(can));
									if (log.isDebugEnabled()) log.debug("calcularRangosPermanenciaExtraOperativoIntermedio - mapa1("+codpers+"): " + mapa1);
									if(!horaIni.equals(hora)){
										lista.add(mapa1);
									}			
								}
							}
						}							
					}
				}
			}				
						
		} catch (Exception e){
			log.error(e);			
		}
		int canti = Math.round(cantidad);
		PE.put("cantidad",String.valueOf(canti));
		PE.put("hora", hora);
		PE.put("hora0", hora0);		
		PE.put("intervalos", lista);		
		return PE;
	}
	//FIN ICAPUNAY 05/10/2012 AJUSTES AOM 06A4T11 LABOR EXCEPCIONAL
	//FIN ICAPUNAY 09/04/2012 AOM 06A4T11 LABOR EXCEPCIONAL Y COMPENSACIONES-PAS20124E550000064

	
	/**	
	 * Metodo encargado de registrar masivamente los flujos de aprobadores. 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @param mapa HashMap
	 * @param usuario String
	 * @return	String
	 * @throws RemoteException
	 */
	public String planificarRegistroFlujoAprobadoresMasivo(HashMap mapa, String usuario)
			throws RemoteException {

		String result = Constantes.OK; 
		
		if (log.isDebugEnabled()) log.debug("Ingreso al metodo planificarRegistroFlujoAprobadoresMasivo-ProcesoFacade");
		if (log.isDebugEnabled()) log.debug("result al iniciar: "+result);
		
		try {
			
			if (log.isDebugEnabled()) log.debug("Va a ingresar al metodo validarArchivoXlsxAprobadoresMasivo-ProcesoFacade");
			if (log.isDebugEnabled()) log.debug("mapa validarArchivoCsvTurnos: "+mapa);
			if (log.isDebugEnabled()) log.debug("usuario validarArchivoCsvTurnos: "+usuario);
			
			String resVal=registroFlujoAprobadoresMasivo(mapa,usuario);
			
			if (log.isDebugEnabled()) log.debug("Salio del metodo validarArchivoXlsxAprobadoresMasivo-ProcesoFacade");
			if (log.isDebugEnabled()) log.debug("Estado DESPUES de Validacion (resVal): "+resVal);		
			
		} catch (Exception e) {	
			result="Error";		
			log.error(e);			
		} finally {
			try {
				
				result = Constantes.OK;
				
			} catch (Exception e) {				
				result="Error";				
				log.error(e);
			}
		}
		return result;
		
	}

	
	/**	 
	 * Metodo encargado de la Validacion del Archivo de Flujo de Aprobadores Masivos
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"	
	 * @param mapa HashMap
	 * @param usuario String
	 * @return	String
	 * @throws RemoteException
	 */
	public String registroFlujoAprobadoresMasivo(HashMap mapa, String usuario)
			throws RemoteException {

		String res = Constantes.OK; 
		String id = (String) mapa.get("messageID");
		String dbpool = (String) mapa.get("dbpool");
		HashMap hmDatos = new HashMap();
		HashMap row;
		String texto=null;
		
		if (log.isDebugEnabled()) log.debug("Ingreso al metodo validarArchivoXlsxFlujoAprobadores-ProcesoFacade");
		if (log.isDebugEnabled()) log.debug("res al iniciar: "+res);		
		if (log.isDebugEnabled()) log.debug("mapa: "+mapa);
		if (log.isDebugEnabled()) log.debug("usuario: "+usuario);
		if (log.isDebugEnabled()) log.debug("id: "+id);
		if (log.isDebugEnabled()) log.debug("dbpool: "+dbpool);
		
		try {		
			
			super.creaLog(id, "VALIDACION DE FLUJO DE APROBADORES MASIVOS", usuario);
			
			List fileDataList = (ArrayList) mapa.get("archivo");			
			//Map cabecera = (HashMap) fileDataList.get(0);//obteniendo la cabecera del archivo
			
			//if (log.isDebugEnabled()) log.debug("cabecera: "+cabecera);			
			if (log.isDebugEnabled()) log.debug("llego1");

			// VALIDANDO CADA UNO DE LOS REGISTROS DEL ARCHIVO XLSX - NO INCLUYE LA CABECERA
			T02DAO t02dao = new T02DAO();		
			T12DAO t12dao = new T12DAO();
			ReporteDAO repDao = new ReporteDAO();
			pe.gob.sunat.sp.asistencia.dao.T1455DAO t1455dao = new pe.gob.sunat.sp.asistencia.dao.T1455DAO();
			T1480DAO t1480dao = new T1480DAO();
			T1279DAO t1279dao = new T1279DAO();
			
			if (log.isDebugEnabled()) log.debug("llego2");
			
			texto=" ESTADO "+"  UBICACI흹  "+"     PROBLEMA     ";					
			super.escribe(texto,"VALIDACION DE FLUJO DE APROBADORES MASIVOS", mapa, usuario);
			
			texto="--------------------------------------------------------------------------------------";					
			super.escribe(texto,"VALIDACION DE FLUJO DE APROBADORES MASIVOS", mapa, usuario);
			
			if (log.isDebugEnabled()) log.debug("llego3");
			
			int tamanoArchivo=fileDataList.size();

			//
			int filasErroneas=0;
			int filasValidadas=0;
			boolean swError=false;
			SimpleDateFormat sd = new SimpleDateFormat("dd/MM/yyyy", Locale.getDefault());			

			if (log.isDebugEnabled()) log.debug("Se inicia la validaci?el fileList AprobadoresMasivos. Registros="+fileDataList.size());
			
			texto = "Se encontraron "+fileDataList.size()+" registros.";			
			super.escribe(texto,"", mapa, usuario);
			
			super.escribe("IMPORTANTE: S?se graban en la base de datos las filas sin errores detectados.","", mapa, usuario);
			super.escribe("--------------------------------------------------------------------------------------","", mapa, usuario);
			
			String[] cabecera = (String[])mapa.get("cabeceraXlsx");
			int rowIniData = ((Integer) mapa.get("rowIniData")).intValue();
			String sTipoMovFila="",sUniOrgFila="";
			
			HashMap hmTipoMov = t1279dao.findMapByEstado(dbpool, "1");
			
			for (int y = 0; y < fileDataList.size(); y++) {
				row = (HashMap) fileDataList.get(y);				
				if (log.isDebugEnabled()) log.debug("Inicio Validaciones en fila: "+(y+rowIniData)+" del excel");
				
				//La fila debe contener cuando menos  UniOrg y Instancia1.
				if(!(row.get("UniOrg").equals("") || row.get("Instancia1").equals(""))){					
					
					//Validamos que cada instancia tenga la cantidad de datos correctos.
					if(!row.get("Instancia1").equals("") && row.get("Instancia1").toString().split(",").length != 8){
						row.put("estado", "ERROR");
						texto = ("ERROR: Fila "+(y+rowIniData)+", la instancia 1 debe tener 8 datos para poder registrarse.");
						super.escribe(texto,"VALIDACION DE FLUJO DE APROBADORES MASIVOS",mapa, usuario);
					}else if(!row.get("Instancia2").equals("") && row.get("Instancia2").toString().split(",").length != 8){
						row.put("estado", "ERROR");
						texto = ("ERROR: Fila "+(y+rowIniData)+", la instancia 2 debe tener 8 datos para poder registrarse.");
						super.escribe(texto,"VALIDACION DE FLUJO DE APROBADORES MASIVOS",mapa, usuario);
					}else if(!row.get("Instancia3").equals("") && row.get("Instancia3").toString().split(",").length != 8){
						row.put("estado", "ERROR");
						texto = ("ERROR: Fila "+(y+rowIniData)+", la instancia 3 debe tener 8 datos para poder registrarse.");
						super.escribe(texto,"VALIDACION DE FLUJO DE APROBADORES MASIVOS",mapa, usuario);
					}

					//Validamos que se use la plantilla excel autorizada, la cual tiene una correlaci?atural entre instancias, es decir
					//no puede haber instancia 3 si no hay instancia 2					
					if(row.get("estado").equals("OK") && !row.get("Instancia3").equals("") && row.get("Instancia2").equals("")){
						row.put("estado","ERROR");
						texto = ("ERROR: Fila "+(y+rowIniData)+", cuando hay instancia3 debe existir tambi缶말nstancia2.");
						super.escribe(texto,"VALIDACION DE FLUJO DE APROBADORES MASIVOS",mapa, usuario);
					}
					
					//Obtenemos la UniOrg y el tipo de movimiento involucrado en la fila (luego de validar).
					sTipoMovFila = row.get("Instancia1").toString().split(",")[0].replaceAll("'", "");
					sUniOrgFila = row.get("UniOrg").toString();
					
					//Solo seguimos validando si las celdas del excel contienen datos v谿뼋os.
					if(row.get("estado").equals("OK")){
						//Validamos que por cada instancia tenga los campos necesarios  .
						if(row.get("Instancia1").toString().trim().length()>0){
							if(!row.get("Instancia1").toString().split(",")[1].equals("'2'") ){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", El segundo campo debe ser la constante '2'.");
								super.escribe(texto,"",mapa, usuario);							
							}else if(row.get("Instancia1").toString().split(",")[3].replaceAll("'", "").trim().length() != 4 ){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", El c?o de registro de origen debe tener 4 caracteres.");
								super.escribe(texto,"",mapa, usuario);
							}else if(  row.get("Instancia1").toString().split(",")[4].replaceAll("'", "").trim().equals("") && 
									!( row.get("Instancia1").toString().split(",")[5].equals("'"+Constantes.ESTACION_UNICA+"'") )){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", S?se permite aprobador destino en blanco cuando es instancia ?nica.");
								super.escribe(texto,"",mapa, usuario);
							}else if(hmTipoMov.get(sTipoMovFila) == null){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", El tipo de Movivimiento registrado no existe o est械뼕activo.");
								super.escribe(texto,"",mapa, usuario);
							}else if(! ( row.get("Instancia1").toString().split(",")[5].equals("'"+Constantes.ESTACION_INICIAL+"'") || row.get("Instancia1").toString().split(",")[5].equals("'"+Constantes.ESTACION_UNICA+"'"))){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", La instancia 1 deber涌쪕er de tipo: 1 o 3 (ESTACION INICIAL o UNICA).");
								super.escribe(texto,"",mapa, usuario);
							}
						}
						if(row.get("Instancia2").toString().trim().length()>0){
							if(!row.get("Instancia2").toString().split(",")[1].equals("'2'") ){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", El segundo campo debe ser la constante '2'.");
								super.escribe(texto,"",mapa, usuario);	
							}else if(!(row.get("Instancia2").toString().split(",")[5].equals("'"+Constantes.ESTACION_INTERMEDIA+"'") || 
									row.get("Instancia2").toString().split(",")[5].equals("'"+Constantes.ESTACION_FINAL+"'"))){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", La instancia2 no est械볍pecificando el tipo de estacion (1,2,3,4).");
								super.escribe(texto,"",mapa, usuario);	
							}else if(row.get("Instancia2").toString().split(",")[5].equals("'"+Constantes.ESTACION_INTERMEDIA+"'")){
								if(row.get("Instancia2").toString().split(",")[3].replaceAll("'", "").trim().length() != 4 ||
										row.get("Instancia2").toString().split(",")[4].replaceAll("'", "").trim().length() != 4){
									row.put("estado","ERROR");
									texto = ("ERROR: Fila "+(y+rowIniData)+", El c?o de registro de origen/destino debe tener 4 caracteres.");
									super.escribe(texto,"",mapa, usuario);
								}else if(  row.get("Instancia2").toString().split(",")[4].replaceAll("'", "").trim().equals("") ){
									row.put("estado","ERROR");
									texto = ("ERROR: Fila "+(y+rowIniData)+", No se permite instancia intermedia con aprobador destino en blanco.");
									super.escribe(texto,"",mapa, usuario);
								}else if(hmTipoMov.get(sTipoMovFila) == null){
									row.put("estado","ERROR");
									texto = ("ERROR: Fila "+(y+rowIniData)+", El tipo de Movivimiento registrado no existe o est械뼕activo.");
									super.escribe(texto,"",mapa, usuario);
								}
							}else if(row.get("Instancia2").toString().split(",")[5].equals("'"+Constantes.ESTACION_FINAL+"'")){
								if(row.get("Instancia2").toString().split(",")[3].replaceAll("'", "").trim().length() != 4 ||
										row.get("Instancia2").toString().split(",")[4].replaceAll("'", "").trim().length() != 0){
									row.put("estado","ERROR");
									texto = ("ERROR: Fila "+(y+rowIniData)+", El c?o de registro de origen deber涌쪖ener 4 caracteres y el destino 0 caracteres.");
									super.escribe(texto,"",mapa, usuario);
								}else if(hmTipoMov.get(sTipoMovFila) == null){
									row.put("estado","ERROR");
									texto = ("ERROR: Fila "+(y+rowIniData)+", El tipo de Movivimiento registrado no existe o est械뼕activo.");
									super.escribe(texto,"",mapa, usuario);
								}								
							}
						}
						if(row.get("Instancia3").toString().trim().length()>0){
							if(!row.get("Instancia3").toString().split(",")[1].equals("'2'") ){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", El segundo campo debe ser la constante '2'.");
								super.escribe(texto,"",mapa, usuario);							
							}else if(row.get("Instancia3").toString().split(",")[3].replaceAll("'", "").trim().length() != 4 ||
									row.get("Instancia3").toString().split(",")[4].replaceAll("'", "").trim().length() > 0){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", La instancia final s?deber涌쪆ontener aprobador origen (4 caracteres.");
								super.escribe(texto,"",mapa, usuario);
							}else if(hmTipoMov.get(sTipoMovFila) == null){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", El tipo de Movivimiento registrado no existe o est械뼕activo.");
								super.escribe(texto,"",mapa, usuario);
							}else if(! row.get("Instancia3").toString().split(",")[5].equals("'"+Constantes.ESTACION_FINAL+"'")){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", La instancia 3 deber涌쪕er de tipo: 3 (ESTACION FINAL).");
								super.escribe(texto,"",mapa, usuario);
							}
						}
							
						//validamos que la UO de cabecera sea la misma que los items.
						if(!row.get("UniOrg").toString().equals( row.get("Instancia1").toString().split(",")[2].replaceAll("'", ""))){
							row.put("estado","ERROR");
							texto = ("ERROR: Fila "+(y+rowIniData)+", UniOrg de cabecera no coincide con Instancia 1.");
							super.escribe(texto,"",mapa, usuario);
						}else if(!row.get("Instancia2").equals("")){
							if(!row.get("UniOrg").toString().equals( row.get("Instancia2").toString().split(",")[2].replaceAll("'", ""))){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", UniOrg de cabecera no coincide con Instancia 2.");
								super.escribe(texto,"",mapa, usuario);
							}else if(!row.get("Instancia3").equals("")){
								if(!row.get("UniOrg").toString().equals( row.get("Instancia3").toString().split(",")[2].replaceAll("'", ""))){
									row.put("estado","ERROR");
									texto = ("ERROR: Fila "+(y+rowIniData)+", UniOrg de cabecera no coincide con Instancia 3.");
									super.escribe(texto,"",mapa, usuario);
								}
							}
						}
						//Validaciones dependiente de la cantidad de instancias.
						//Empezamos con la validaci?i se trata de un movimiento con tres instancias.
						if(row.get("estado").equals("OK") && !row.get("Instancia3").equals("")){
							row.put("instancias", "3");
							//Validamos la coherencia de instancias.1,2,3,4
							if(!row.get("Instancia3").toString().split(",")[5].replaceAll("'", "").equals(Constantes.ESTACION_FINAL)){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", la Instancia3 deber涌쪕er la instancia final (3).");
								super.escribe(texto,"",mapa, usuario);
							}else if(!row.get("Instancia2").toString().split(",")[5].replaceAll("'", "").equals(Constantes.ESTACION_INTERMEDIA)){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", la Instancia2 deber涌쪕er la instancia intermedia (2).");
								super.escribe(texto,"",mapa, usuario);
							}else if(!row.get("Instancia1").toString().split(",")[5].replaceAll("'", "").equals(Constantes.ESTACION_INICIAL)){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", la Instancia1 deber涌쪕er la instancia inicial (1).");
								super.escribe(texto,"",mapa, usuario);
							}
							
							//Validamos la correcta correlaci?ntre aprobadores.
							if(!row.get("Instancia1").toString().split(",")[4].equals(row.get("Instancia2").toString().split(",")[3])){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", el Aprobador-Destino en Instancia1 no coincide con Aprobador-Origen de Instancia 2.");
								super.escribe(texto,"",mapa, usuario);
							}else if(!row.get("Instancia2").toString().split(",")[4].equals(row.get("Instancia3").toString().split(",")[3])){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", el Aprobador-Destino en Instancia2 no coincide con Aprobador-Origen de Instancia3.");
								super.escribe(texto,"V",mapa, usuario);
							}
							
							//validamos que el origen y destino sean diferentes en las dos primeras instancias.
							if(row.get("Instancia1").toString().split(",")[3].equals(row.get("Instancia1").toString().split(",")[4])){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", el Aprobador-Origen debe ser distinto al Aprobador-Destino en Instancia1 .");
								super.escribe(texto,"",mapa, usuario);
							}else if(row.get("Instancia2").toString().split(",")[3].equals(row.get("Instancia2").toString().split(",")[4])){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", el Aprobador-Origen debe ser distinto al Aprobador-Destino en Instancia2 .");
								super.escribe(texto,"",mapa, usuario);
							}
							
							//validamos que el aprobador destido de la instancia final sea vacio
							if(!row.get("Instancia3").toString().split(",")[4].replaceAll("'", "").equals("")){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", el Aprobador-Destino en Instancia3 deber涌쪕er vacio.");
								super.escribe(texto,"",mapa, usuario);
							}
							
						}//fin si es movimiento con tres (3) instancias
						else if(row.get("estado").equals("OK") && !row.get("Instancia2").equals("")){
							row.put("instancias", "2");
							//Validamos la coherencia de instancias.1,2,3,4
							if(!row.get("Instancia2").toString().split(",")[5].replaceAll("'", "").equals(Constantes.ESTACION_FINAL)){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", la Instancia2 deber涌쪕er la instancia final (3).");
								super.escribe(texto,"",mapa, usuario);
							}else if(!row.get("Instancia1").toString().split(",")[5].replaceAll("'", "").equals(Constantes.ESTACION_INICIAL)){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", la Instancia1 deber涌쪕er la instancia inicial (1).");
								super.escribe(texto,"",mapa, usuario);
							}
							
							//Validamos la correcta correlaci?ntre aprobadores.
							if(!row.get("Instancia1").toString().split(",")[4].equals(row.get("Instancia2").toString().split(",")[3])){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", el Aprobador-Destino en Instancia1 no coincide con Aprobador-Origen de Instancia 2.");
								super.escribe(texto,"",mapa, usuario);
							}
							
							//validamos que el orrigen y destino sean diferentes en la primera instancia.
							if(row.get("Instancia1").toString().split(",")[3].equals(row.get("Instancia1").toString().split(",")[4])){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", el Aprobador-Origen debe ser distinto al Aprobador-Destino en Instancia1 .");
								super.escribe(texto,"",mapa, usuario);
							}
							
							//validamos que el aprobador destido de la instancia final sea vacio
							if(!row.get("Instancia2").toString().split(",")[4].replaceAll("'", "").equals("")){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", el Aprobador-Destino en Instancia2 deber涌쪕er vacio.");
								super.escribe(texto,"",mapa, usuario);
							}
							
						}//fin si es de dos instancias.
						else if(row.get("estado").equals("OK") && !row.get("Instancia1").equals("")){
							row.put("instancias", "1");
							//Validamos la coherencia de instancias.1,2,3,4
							if(!row.get("Instancia1").toString().split(",")[5].replaceAll("'", "").equals(Constantes.ESTACION_UNICA)){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", la Instancia1 deber涌쪕er instancia ?nica (4).");
								super.escribe(texto,"",mapa, usuario);
							}							
	
							//validamos que el aprobador destido de la instancia final sea vacio
							if(!row.get("Instancia1").toString().split(",")[4].replaceAll("'", "").equals("")){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", el Aprobador-Destino en Instancia1 deber涌쪕er vacio (Instancia ?nica).");
								super.escribe(texto,"",mapa, usuario);
							}							
						}//Fin si es de instancia ?nica
						
						//-------------------------------------
						//Iniciamos validaciones con BaseDatos.
						if(row.get("estado").equals("OK")){
							//Validamos que la Unidad Organizacional que se intenta modificar(flujo) exista.
							HashMap hmUniOrg = t12dao.findByCodUorga(dbpool,sUniOrgFila);
							if(hmUniOrg != null && hmUniOrg.get("t12cod_uorga").equals("-")){
								row.put("estado","ERROR");
								texto = ("ERROR: Fila "+(y+rowIniData)+", la unidad organizacional con c?o: "+sUniOrgFila+" no existe.");
								super.escribe(texto,"",mapa, usuario);
							}
						}
						
						if(row.get("estado").equals("OK")){							
							//Validamos si hay solicitudes pendientes involucradas con el tipo de movimiento.
							hmDatos.clear();
							hmDatos.put("filtra_tipo_mov",sTipoMovFila );
							hmDatos.put("uniOrgan", sUniOrgFila);
							List listPendientes = repDao.findMovimientosFlujosAprobadores(dbpool,hmDatos);
							if(listPendientes.size()>0){
								HashMap hmPend = (HashMap)listPendientes.get(0);
								int iPendientes = Integer.parseInt(hmPend.get("aprob_ini_pend").toString())+Integer.parseInt(hmPend.get("aprob_int_pend").toString())+Integer.parseInt(hmPend.get("aprob_fin_pend").toString());
								if(iPendientes>0){
									//Aqui se debe tener cuidado de que la cantidad de instacias nuevas coincidan con las antiguas.
									
									//Como hay pendientes y no se debe derivar, no se debe actualizar el flujo porque quedar涌 solicitudes zombies.
									//Comentamos porque el F2 dice que se permita.
									/*
									if(!mapa.get("derivarPendientes").equals("SI")){		
										if(row.get("instancias").equals("3")){
											if(	Integer.parseInt(hmPend.get("aprob_ini_pend").toString())>0 && !hmPend.get("aprob_ini").equals(row.get("Instancia1").toString().split(",")[3].replaceAll("'", "")) ||
												Integer.parseInt(hmPend.get("aprob_int_pend").toString())>0 && !hmPend.get("aprob_int").equals(row.get("Instancia2").toString().split(",")[3].replaceAll("'", "")) ||
												Integer.parseInt(hmPend.get("aprob_fin_pend").toString())>0 && !hmPend.get("aprob_fin").equals(row.get("Instancia3").toString().split(",")[3].replaceAll("'", ""))
											){
												row.put("estado","ERROR");
												texto = ("INFO: Fila "+(y+rowIniData)+", hay solicitudes pendientes en la UniOrg="+sUniOrgFila+" y TipoMov="+sTipoMovFila+" -> No se modificar械볇 flujo.");
												super.escribe(texto,"",mapa, usuario);
											}											
										}else if(row.get("instancias").equals("2")){
											if(	Integer.parseInt(hmPend.get("aprob_ini_pend").toString())>0 && row.get("Instancia1").toString().split(",")[3].replaceAll("'", "").equals("") ||
												Integer.parseInt(hmPend.get("aprob_fin_pend").toString())>0 && row.get("Instancia2").toString().split(",")[3].replaceAll("'", "").equals("")
												){
													row.put("estado","ERROR");
													texto = ("INFO: Fila "+(y+rowIniData)+", hay solicitudes pendientes en la UniOrg="+sUniOrgFila+" y TipoMov="+sTipoMovFila+" -> No se modificar械볇 flujo.");
													super.escribe(texto,"",mapa, usuario);
												}
											
											//Los pendientes no pueden transferirse a "" (vacio).
											if(	Integer.parseInt(hmPend.get("aprob_int_pend").toString())>0 ){
												row.put("estado","ERROR");
												texto = ("INFO: Fila "+(y+rowIniData)+", hay solicitudes pendientes en la UniOrg="+sUniOrgFila+" y TipoMov="+sTipoMovFila+" -> No se modificar械볇 flujo (falta Aprob-Dest).");
												super.escribe(texto,"",mapa, usuario);
											}
										}else if(row.get("instancias").equals("1")){
											if(	Integer.parseInt(hmPend.get("aprob_ini_pend").toString())>0 && !hmPend.get("aprob_ini").equals(row.get("Instancia1").toString().split(",")[3].replaceAll("'", ""))
												){
													row.put("estado","ERROR");
													texto = ("INFO: Fila "+(y+rowIniData)+", hay solicitudes pendientes en la UniOrg="+sUniOrgFila+" y TipoMov="+sTipoMovFila+" -> No se modificar械볇 flujo.");
													super.escribe(texto,"",mapa, usuario);
											}
											//Los pendientes no pueden transferirse a "" (vacio).
											if(	Integer.parseInt(hmPend.get("aprob_int_pend").toString())>0 || Integer.parseInt(hmPend.get("aprob_fin_pend").toString())>0 ){
												row.put("estado","ERROR");
												texto = ("INFO: Fila "+(y+rowIniData)+", hay solicitudes pendientes en la UniOrg="+sUniOrgFila+" y TipoMov="+sTipoMovFila+" -> No se modificar械볇 flujo (falta Aprob-Dest).");
												super.escribe(texto,"",mapa, usuario);
											}
										}
									}else{//Si se deben derivar los pendientes
										row.put("tienePendientes","SI");
									}
									*/
									row.put("tienePendientes","SI");
								}//Fin si hay pendientes
							}
							
							//Iniciamos validaciones de c?os de registro de los aprobadores.(solo para las filas v谿뼋as.
							if(row.get("estado").equals("OK")){
								for(int inst=1;inst<=3;inst++){
									HashMap hmAprob = null;
									String sCodAprobNew = null;
									if(row.get("Instancia"+String.valueOf(inst)) != null && row.get("Instancia"+String.valueOf(inst)).toString().split(",").length ==8 ){
										sCodAprobNew=row.get("Instancia"+String.valueOf(inst)).toString().split(",")[3].replaceAll("'", "");
										if(sCodAprobNew.length()>0 ){
											hmAprob =t02dao.findByCodPers(dbpool, sCodAprobNew);
											if(hmAprob == null || hmAprob.get("t02cod_pers").equals("-")){
												row.put("estado", "ERROR");
												texto= "ERROR: Fila "+(y+rowIniData)+", el registro de aprobador "+sCodAprobNew+" no existe.";
												super.escribe(texto,"",mapa, usuario);
											}else if(! hmAprob.get("t02cod_stat").equals("1") ){
												row.put("estado", "ERROR");
												texto= "ERROR: Fila "+(y+rowIniData)+", el registro de aprobador "+sCodAprobNew+" NO esta ACTIVO.";
												super.escribe(texto,"",mapa, usuario);
											}
										}
									}//FinSi Instancia existente
								}//Fin FOR para cada instancia
							}
						}//fin validaciones desde BaseDatos
						
					}//Fin si fila OK (validac?固뼊a)
				}else{//La fila no contiene cuando menos las columnas UniOrg y Instancia1.
					row.put("estado","ERROR");
					texto = ("ERROR: Fila "+(y+rowIniData)+", no tiene datos v谿뼋os.");
					super.escribe(texto,"",mapa, usuario);
				}
		
				if(row.get("estado").equals("OK")) filasValidadas++;
				else filasErroneas++;
				
			}//Fin for para cada fila.				
			
			super.escribe(" ","",mapa, usuario);
			
			super.escribe("--------------------------------------------------------------------------------------","", mapa, usuario);
			
			super.escribe("NOTA: Proceso de validaci?ncluido, ahora se procede a grabar los datos.","", mapa, usuario);
			texto = "Hay "+String.valueOf(filasErroneas)+" Filas con errores." ;
			super.escribe(texto,"",mapa, usuario);
			texto = "Hay "+String.valueOf(filasValidadas)+" Filas que se grabar鷄" ;
			super.escribe(texto,"",mapa, usuario);
			
			texto="--------------------------------------------------------------------------------------";					
			super.escribe(texto,"", mapa, usuario);
			
			//Iniciamos la grabaci?e los datos, s?de las filas con estado=OK
			for (int y = 0; y < fileDataList.size(); y++) {
				if(((HashMap)fileDataList.get(y)).get("estado").equals("OK")){
					row = (HashMap) fileDataList.get(y);				
					if (log.isDebugEnabled()) log.debug("Inicio Validaciones en fila: "+(y+rowIniData)+" del excel");
					//Obtenemos la UniOrg y el tipo de movimiento involucrado en la fila.
					sTipoMovFila = row.get("Instancia1").toString().split(",")[0].replaceAll("'", "");
					sUniOrgFila = row.get("UniOrg").toString();
					
					try{
						//El criterio de grabaci?epender械반l n?mero de la cantidad de instacias que tenga el TipoMov en la UniOrg de la fila.				
						//Primero debemos efectuar la derivaci?e los pendientes.(Si marco SI en el combo de la interfaz de usuario).
						if(mapa.get("derivarPendientes").equals("SI") && row.get("tienePendientes")!=null && row.get("tienePendientes").equals("SI") ){
							hmDatos.clear();
							hmDatos.put("filtra_tipo_mov",sTipoMovFila );
							hmDatos.put("uniOrgan", sUniOrgFila);
							HashMap hmPend = (HashMap) repDao.findMovimientosFlujosAprobadores(dbpool,hmDatos).get(0);
							
							if(row.get("instancias").equals("3")){
								if(	Integer.parseInt(hmPend.get("aprob_ini_pend").toString())>0 && !hmPend.get("aprob_ini").equals(row.get("Instancia1").toString().split(",")[3].replaceAll("'", "")) ){
									t1455dao.transferirSegPendientes(dbpool, sUniOrgFila, sTipoMovFila, hmPend.get("aprob_ini").toString(), row.get("Instancia1").toString().split(",")[3].replaceAll("'", ""), usuario);
									super.escribe("INFO: Fila "+(y+rowIniData)+", Se transfirieron las solicitudes de la UO="+sUniOrgFila+" TipoMov="+sTipoMovFila+" de "+hmPend.get("aprob_ini").toString()+" a "+row.get("Instancia1").toString().split(",")[3].replaceAll("'", ""),"", mapa, usuario);
								}
								if(Integer.parseInt(hmPend.get("aprob_int_pend").toString())>0 && !hmPend.get("aprob_int").equals(row.get("Instancia2").toString().split(",")[3].replaceAll("'", ""))){
									t1455dao.transferirSegPendientes(dbpool, sUniOrgFila, sTipoMovFila, hmPend.get("aprob_int").toString(), row.get("Instancia2").toString().split(",")[3].replaceAll("'", ""), usuario);
									super.escribe("INFO: Fila "+(y+rowIniData)+", Se transfirieron las solicitudes de la UO="+sUniOrgFila+" TipoMov="+sTipoMovFila+" de "+hmPend.get("aprob_int").toString()+" a "+row.get("Instancia2").toString().split(",")[3].replaceAll("'", ""),"", mapa, usuario);
								}
								if(Integer.parseInt(hmPend.get("aprob_fin_pend").toString())>0 && !hmPend.get("aprob_fin").equals(row.get("Instancia3").toString().split(",")[3].replaceAll("'", ""))){
									t1455dao.transferirSegPendientes(dbpool, sUniOrgFila, sTipoMovFila, hmPend.get("aprob_fin").toString(), row.get("Instancia3").toString().split(",")[3].replaceAll("'", ""), usuario);
									super.escribe("INFO: Fila "+(y+rowIniData)+", Se transfirieron las solicitudes de la UO="+sUniOrgFila+" TipoMov="+sTipoMovFila+" de "+hmPend.get("aprob_fin").toString()+" a "+row.get("Instancia3").toString().split(",")[3].replaceAll("'", ""),"", mapa, usuario);
								}								
								
							}else if(row.get("instancias").equals("2")){
								if(	Integer.parseInt(hmPend.get("aprob_ini_pend").toString())>0 && !hmPend.get("aprob_ini").equals(row.get("Instancia1").toString().split(",")[3].replaceAll("'", "")) ){
									t1455dao.transferirSegPendientes(dbpool, sUniOrgFila, sTipoMovFila, hmPend.get("aprob_ini").toString(), row.get("Instancia1").toString().split(",")[3].replaceAll("'", ""), usuario);
									super.escribe("INFO: Fila "+(y+rowIniData)+", Se transfirieron las solicitudes de la UO="+sUniOrgFila+" TipoMov="+sTipoMovFila+" de "+hmPend.get("aprob_ini").toString()+" a "+row.get("Instancia1").toString().split(",")[3].replaceAll("'", ""),"", mapa, usuario);
								}
								if(Integer.parseInt(hmPend.get("aprob_fin_pend").toString())>0 && !hmPend.get("aprob_fin").equals(row.get("Instancia2").toString().split(",")[3].replaceAll("'", ""))){
									t1455dao.transferirSegPendientes(dbpool, sUniOrgFila, sTipoMovFila, hmPend.get("aprob_fin").toString(), row.get("Instancia2").toString().split(",")[3].replaceAll("'", ""), usuario);
									super.escribe("INFO: Fila "+(y+rowIniData)+", Se transfirieron las solicitudes de la UO="+sUniOrgFila+" TipoMov="+sTipoMovFila+" de "+hmPend.get("aprob_fin").toString()+" a "+row.get("Instancia2").toString().split(",")[3].replaceAll("'", ""),"", mapa, usuario);
								}	
								
							}else if(row.get("instancias").equals("1")){
								if(	Integer.parseInt(hmPend.get("aprob_ini_pend").toString())>0 && !hmPend.get("aprob_ini").equals(row.get("Instancia1").toString().split(",")[3].replaceAll("'", "")) ){
									t1455dao.transferirSegPendientes(dbpool, sUniOrgFila, sTipoMovFila, hmPend.get("aprob_ini").toString(), row.get("Instancia1").toString().split(",")[3].replaceAll("'", ""), usuario);
									super.escribe("INFO: Fila "+(y+rowIniData)+", Se transfirieron las solicitudes de la UO="+sUniOrgFila+" TipoMov="+sTipoMovFila+" de "+hmPend.get("aprob_ini").toString()+" a "+row.get("Instancia1").toString().split(",")[3].replaceAll("'", ""),"", mapa, usuario);
								}
							}					
						}//Fin trabajo de derivaciones/transferencias
							
						//Ahora eliminamos el(los) registro(s) actual(es) del flujo asociado a la UniOrg y TipoMov de la fila.
						hmDatos.clear();
						hmDatos.put("sNumMov", sTipoMovFila);
						hmDatos.put("cAccion", "2");
						hmDatos.put("sUniOrgan", sUniOrgFila );
						t1480dao.deleteAprobadorFlujo4UniOrgYMov(dbpool, hmDatos);	
						
						//Ahora insertamos los nuevos valores.		
						if(!row.get("Instancia1").equals("") && row.get("Instancia1").toString().split(",").length == 8){
							hmDatos.clear();
							hmDatos.put("sNumMov",sTipoMovFila);
							hmDatos.put("cAccion",row.get("Instancia1").toString().split(",")[1].replaceAll("'", ""));
							hmDatos.put("sUniOrgan",sUniOrgFila);
							hmDatos.put("sCodPersOri",row.get("Instancia1").toString().split(",")[3].replaceAll("'", ""));
							hmDatos.put("sCodPersDes",row.get("Instancia1").toString().split(",")[4].replaceAll("'", ""));
							hmDatos.put("cInstancia",row.get("Instancia1").toString().split(",")[5].replaceAll("'", ""));
							hmDatos.put("sUsuario",usuario);
							t1480dao.insertAprobadorFlujo(dbpool, hmDatos);
						}
						if(!row.get("Instancia2").equals("") && row.get("Instancia2").toString().split(",").length == 8){
							hmDatos.clear();
							hmDatos.put("sNumMov",sTipoMovFila);
							hmDatos.put("cAccion",row.get("Instancia2").toString().split(",")[1].replaceAll("'", ""));
							hmDatos.put("sUniOrgan",sUniOrgFila);
							hmDatos.put("sCodPersOri",row.get("Instancia2").toString().split(",")[3].replaceAll("'", ""));
							hmDatos.put("sCodPersDes",row.get("Instancia2").toString().split(",")[4].replaceAll("'", ""));
							hmDatos.put("cInstancia",row.get("Instancia2").toString().split(",")[5].replaceAll("'", ""));
							hmDatos.put("sUsuario",usuario);
							t1480dao.insertAprobadorFlujo(dbpool, hmDatos);
						}
						if(!row.get("Instancia3").equals("") && row.get("Instancia3").toString().split(",").length == 8){
							hmDatos.clear();
							hmDatos.put("sNumMov",sTipoMovFila);
							hmDatos.put("cAccion",row.get("Instancia3").toString().split(",")[1].replaceAll("'", ""));
							hmDatos.put("sUniOrgan",sUniOrgFila);
							hmDatos.put("sCodPersOri",row.get("Instancia3").toString().split(",")[3].replaceAll("'", ""));
							hmDatos.put("sCodPersDes",row.get("Instancia3").toString().split(",")[4].replaceAll("'", ""));
							hmDatos.put("cInstancia",row.get("Instancia3").toString().split(",")[5].replaceAll("'", ""));
							hmDatos.put("sUsuario",usuario);
							t1480dao.insertAprobadorFlujo(dbpool, hmDatos);
						}
					}catch(Exception e){
						row.put("estado","ERROR-GRABAR");
						texto = ("ERROR: Fila "+(y+rowIniData)+", problemas al intentar  grabar los datos de la fila (Verifique).");
						super.escribe(texto,"",mapa, usuario);
						log.error(e);
					}
				}//FinSi es fila OK
			}//Fin For cada fila del excel.			
			
		} catch (Exception e) {	
			res="Error";	
			if (log.isDebugEnabled()) log.debug("llego27");
			if (log.isDebugEnabled()) log.debug("No valido: "+e.toString());
			log.error(e);
		} finally {
			try {
				// registramos el log del proceso
				super.registraLog(dbpool, mapa, usuario);			
				
			} catch (Exception e) {				
				res="Error";	
				if (log.isDebugEnabled()) log.debug("llego28");
				if (log.isDebugEnabled()) log.debug("No valido2: "+e.toString());
				log.error(e);
			}
		}
		return res;
	}	
	
	//ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)
	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public String preCalificarEntradaOpe2(String fechaMarca, String horaMarca,
			String horaIni, int tolera, String horaLim, String medida)
			throws RemoteException {

		String calif = Constantes.ENTRADA_NORMAL;
	
		
		if (log.isDebugEnabled()) log.debug("ingreso preCalificarEntradaOpe2");//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("fechaMarca-CAS:"+fechaMarca);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaMarca-CAS:"+horaMarca);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("tolera-CAS:"+tolera);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaLim-CAS:"+horaLim);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("medida-CAS:"+medida);//LOG GENERACION		
		if (log.isDebugEnabled()) log.debug("calif0-CAS:"+calif);//LOG GENERACION
		try {			
			if (horaLim != null && !horaLim.equals("")) {				
				if (horaLim.trim().equals("00:00:00") || horaLim.trim().equals("00:01:00")) {
					horaLim="24:00:00";
				}
				log.debug("horaLim:"+horaLim);
				if (horaLim.compareTo("24:00:00")<=0){
					log.debug("entro");
					float dif = Utiles.obtenerHorasDiferencia(horaMarca, horaLim);
					log.debug("dif " + dif);
					log.debug("horaMarca " + horaMarca);//LOG GENERACION
					log.debug("horaLim " + horaLim);//LOG GENERACION
					if (dif < 0) {
						calif = Constantes.MOV_INASISTENCIA;
						if (log.isDebugEnabled()) log.debug("calif1-CAS:"+calif);//LOG GENERACION
					} 
					else {
						//cantidad de minutos de tardanza
						float cantidad = Utiles.calculaAcumulado(medida, Utiles
								.stringToTimestamp(fechaMarca + " " + horaIni),
								Utiles.stringToTimestamp(fechaMarca + " " + horaMarca));						
						log.debug("cantidad " + cantidad);//LOG GENERACION
						log.debug("horaIni " + horaIni);//LOG GENERACION
						log.debug("horaMarca " + horaMarca);//LOG GENERACION
						if (cantidad == 0) {
							calif = Constantes.ENTRADA_NORMAL;
							if (log.isDebugEnabled()) log.debug("calif2-CAS:"+calif);//LOG GENERACION
						} else if (cantidad < 0) {
							calif = Constantes.MOV_ENTRADA_ANTICIPADA;
							if (log.isDebugEnabled()) log.debug("calif3-CAS:"+calif);//LOG GENERACION
						} else {
							if (cantidad > tolera) {
								calif = Constantes.MOV_TARDANZA_CON_DESCUENTO;
								if (log.isDebugEnabled()) log.debug("calif4-CAS:"+calif);//LOG GENERACION
							} else {
								calif = Constantes.MOV_TARDANZA_SIN_DESCUENTO;
								if (log.isDebugEnabled()) log.debug("calif5-CAS:"+calif);//LOG GENERACION
							}
						}
					}					
				}
			}
			
		} catch (Exception e){
			log.error(e);		
		}
		return calif;
	}
	
	/**
	 *
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 *  
	 */
	public String preCalificarSalidaOpe1(String dbpool, String codPers, String fechaMarca, 
			String horaMarca, String horaFinTurno, String medida)
			throws RemoteException {

		String calif = Constantes.SALIDA_NORMAL;
		if (log.isDebugEnabled()) log.debug("ingreso preCalificarSalidaOpe1");
		if (log.isDebugEnabled()) log.debug("fechaMarca-CAS:"+fechaMarca);
		if (log.isDebugEnabled()) log.debug("horaMarca-CAS:"+horaMarca);
		if (log.isDebugEnabled()) log.debug("horaFinTurno-CAS:"+horaFinTurno);
		if (log.isDebugEnabled()) log.debug("medida-CAS:"+medida);		
		if (log.isDebugEnabled()) log.debug("calif0-CAS:"+calif);
		try {
			
			if (horaMarca != null && horaFinTurno != null ) {
				
				float cantidad = Utiles.calculaAcumulado(medida, Utiles
						.stringToTimestamp(fechaMarca + " " + horaFinTurno), Utiles
						.stringToTimestamp(fechaMarca + " " + horaMarca));

				log.debug("cantidad " + cantidad);
				log.debug("horaFinTurno " + horaFinTurno);
				log.debug("horaMarca " + horaMarca);				
				
				//salida anticipada
				if (cantidad < 0) {
					calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
					if (log.isDebugEnabled()) log.debug("calif1-CAS:"+calif);
				}
			}

		} catch (Exception e){
			log.error(e);		
		}

		return calif;
	}
	
	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public String preCalificarMovimientoOpe1(String fechaMarca, String horaIni, String horaFin,
			BeanTurnoTrabajo turno, String medida, boolean tieneRefrigerio, boolean bOperativo) throws RemoteException {

		if (log.isDebugEnabled()) log.debug("ingreso preCalificarMovimientoOpe1");
		if (log.isDebugEnabled()) log.debug("fechaMarca-CAS:"+fechaMarca);
		if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);
		if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);
		if (log.isDebugEnabled()) log.debug("medida-CAS:"+medida);	
		if (log.isDebugEnabled()) log.debug("turno.getHoraIni()-CAS:"+turno.getHoraIni());
		if (log.isDebugEnabled()) log.debug("turno.getHoraFin()-CAS:"+turno.getHoraFin());
		if (log.isDebugEnabled()) log.debug("tieneRefrigerio-CAS:"+tieneRefrigerio);
		if (log.isDebugEnabled()) log.debug("bOperativo-CAS:"+bOperativo);
		if (log.isDebugEnabled()) log.debug("turno.getHoraIniRefrigerio()-CAS:"+turno.getHoraIniRefrigerio());
		if (log.isDebugEnabled()) log.debug("turno.getMinutosRefrigerio()-CAS:"+turno.getMinutosRefrigerio());
		if (log.isDebugEnabled()) log.debug("turno.getHoraFinRefrigerio()-CAS:"+turno.getHoraFinRefrigerio());
		if (log.isDebugEnabled()) log.debug("turno.getDuracion()-CAS:"+turno.getDuracion());
		if (log.isDebugEnabled()) log.debug("turno.getHoraLimite()-CAS:"+turno.getHoraLimite());//	----procesar metodo
		if (log.isDebugEnabled()) log.debug("turno.getTolera()-CAS:"+turno.getTolera());//			----procesar metodo
		String calif = Constantes.MOVIMIENTO_NORMAL;
		if (log.isDebugEnabled()) log.debug("calif0-CAS(NN):"+calif);
		try {

			float cantidad = 0;
			
			/*if (tieneRefrigerio) {			
				if (log.isDebugEnabled()) log.debug("tiene refrigerio");				
				cantidad = Utiles.calculaAcumulado(medida, 
						Utiles.stringToTimestamp(fechaMarca + " " + turno.getHoraFin()),
						Utiles.stringToTimestamp(fechaMarca + " " + horaIni));
				if (log.isDebugEnabled()) log.debug("cantidad-CAS:"+cantidad);
				if (log.isDebugEnabled()) log.debug("turno.getHoraFin()-CAS:"+turno.getHoraFin());
				if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);	
				if (cantidad > 0) {
					calif = Constantes.MOV_APORTACION;
					if (log.isDebugEnabled()) log.debug("calif3-CAS:"+calif);
				} else {
					cantidad = Utiles.calculaAcumulado(medida, 
							Utiles.stringToTimestamp(fechaMarca + " " + horaIni), 
							Utiles.stringToTimestamp(fechaMarca + " " + turno.getHoraIniRefrigerio()));
					if (log.isDebugEnabled()) log.debug("cantidad2-CAS:"+cantidad);
					if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);
					if (log.isDebugEnabled()) log.debug("turno.getHoraIniRefrigerio()-CAS:"+turno.getHoraIniRefrigerio());					
					log_papeleta.debug("Cantidad " + cantidad);
					log_papeleta.debug("Turno.getHoraIniRefrigerio " + turno.getHoraIniRefrigerio());
					log_papeleta.debug("horaIni " + horaIni);
					if (cantidad < 0) {
						float durante1 = Utiles.calculaAcumulado(medida, 
								Utiles.stringToTimestamp(fechaMarca + " " + horaIni),
								Utiles.stringToTimestamp(fechaMarca + " "+ horaFin));
						if (log.isDebugEnabled()) log.debug("durante1-CAS:"+durante1);
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);
						if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);	
						float tarde1 = Utiles.calculaAcumulado(medida,
								Utiles.stringToTimestamp(fechaMarca + " "+ turno.getHoraFinRefrigerio()), 
								Utiles.stringToTimestamp(fechaMarca + " "+ horaIni));
						if (log.isDebugEnabled()) log.debug("tarde1-CAS:"+tarde1);
						if (log.isDebugEnabled()) log.debug("turno.getHoraFinRefrigerio()-CAS:"+turno.getHoraFinRefrigerio());
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);
						log_papeleta.debug("durante " + durante1);
						log_papeleta.debug("despues " + tarde1);
						if (tarde1 >= 0) {
							
                                                                calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
							if (log.isDebugEnabled()) log.debug("calif10-CAS:"+calif);
						} else {
							if (durante1 > turno.getMinutosRefrigerio()){

                                //ICR 18052015 
								//calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
								calif = Constantes.MOV_EXCESO_REFRIGERIO;

								if (log.isDebugEnabled()) log.debug("calif11-CAS:"+calif);

							} else {
								calif = Constantes.MOV_REFRIGERIO;
								if (log.isDebugEnabled()) log.debug("calif12-CAS:"+calif);
							}
						}
						
					} 
					if (log.isDebugEnabled()) log.debug("calif4-CAS:"+calif);
				}
			}
			else*/ 				
			if (tieneRefrigerio==false){
				if (log.isDebugEnabled()) log.debug("NO tiene refrigerio(primera vez)");
				/*cantidad = Utiles.calculaAcumulado(medida, 
						Utiles.stringToTimestamp(fechaMarca + " " + horaIni), 
						Utiles.stringToTimestamp(fechaMarca + " " + turno.getHoraIniRefrigerio()));
				if (log.isDebugEnabled()) log.debug("cantidad4-CAS:"+cantidad);
				if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);
				if (log.isDebugEnabled()) log.debug("turno.getHoraIniRefrigerio()-CAS:"+turno.getHoraIniRefrigerio());	
				if (cantidad > 0) {
					
                                                                calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
					if (log.isDebugEnabled()) log.debug("calif5.1-CAS:"+calif);
				} 
				else {					
					//70 min (03:10-04:20)
					float durante = Utiles.calculaAcumulado(medida, 
							Utiles.stringToTimestamp(fechaMarca + " " + horaIni),
							Utiles.stringToTimestamp(fechaMarca + " "+ horaFin));
					if (log.isDebugEnabled()) log.debug("durante2-CAS:"+durante);
					if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);
					if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);	

					//(05:00-03:10)-110//(05:00-05:20)+20
					float despues = Utiles.calculaAcumulado(medida,
							Utiles.stringToTimestamp(fechaMarca + " "+ turno.getHoraFinRefrigerio()), 
							Utiles.stringToTimestamp(fechaMarca + " "+ horaIni));
					if (log.isDebugEnabled()) log.debug("despues-CAS:"+despues);
					if (log.isDebugEnabled()) log.debug("turno.getHoraFinRefrigerio()-CAS:"+turno.getHoraFinRefrigerio());
					if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);

					if (despues > 0) {*/
						cantidad = Utiles.calculaAcumulado(medida, 
								Utiles.stringToTimestamp(fechaMarca + " " + turno.getHoraFin()),
								Utiles.stringToTimestamp(fechaMarca + " " + horaIni));
						//if (log.isDebugEnabled()) log.debug("cantidad5-CAS:"+despues);
						if (log.isDebugEnabled()) log.debug("turno.getHoraFin()-CAS:"+turno.getHoraFin());
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);
						if (log.isDebugEnabled()) log.debug("Cantidad " + cantidad);
						if (log.isDebugEnabled()) log.debug("Turno.getHoraFin " + turno.getHoraFin());
						if (log.isDebugEnabled()) log.debug("horaIni " + horaIni);
						//if (cantidad > 0) { //ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
						if (cantidad >= 0) { //ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
							if (log.isDebugEnabled()) log.debug("horaIni>=turno.getHoraFin()_ope1");//ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
							calif = Constantes.MOV_APORTACION;
							if (log.isDebugEnabled()) log.debug("calif6-CAS:"+calif);
						} else {
							/*EBV 25/03/2015 CAMBIO DE LINEAMIENTO
								calif = Constantes.MOV_SALIDA_AUTORIZADA;*/
                            calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
							if (log.isDebugEnabled()) log.debug("calif7-CAS:"+calif);
						}
					//} 
					/*else {
						if (durante > turno.getMinutosRefrigerio()) {
							calif = Constantes.MOV_EXCESO_REFRIGERIO;
							if (log.isDebugEnabled()) log.debug("calif8-CAS:"+calif);
						} else {
							calif = Constantes.MOV_REFRIGERIO;
							if (log.isDebugEnabled()) log.debug("calif9-CAS:"+calif);
						}
					}*/
				//}
			}				
			
		} catch (Exception e){
			log.error(e);			
		}
		return calif;
	}
	
	/**
	 * 
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public String preCalificarMovimientoOpe2(String fechaMarca, String horaIni, String horaFin,
			//BeanTurnoTrabajo turno, String medida, boolean tieneRefrigerio, boolean bOperativo) throws RemoteException { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
			BeanTurnoTrabajo turno, String medida, boolean tieneRefrigerio, boolean bOperativo,boolean procesaClima, int minutosClima) throws RemoteException { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral

		if (log.isDebugEnabled()) log.debug("ingreso preCalificarMovimientoOpe2");//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("fechaMarca-CAS:"+fechaMarca);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("medida-CAS:"+medida);//LOG GENERACION		
		if (log.isDebugEnabled()) log.debug("turno.getHoraIni()-CAS:"+turno.getHoraIni());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getHoraFin()-CAS:"+turno.getHoraFin());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("tieneRefrigerio-CAS:"+tieneRefrigerio);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("bOperativo-CAS:"+bOperativo);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getHoraIniRefrigerio()-CAS:"+turno.getHoraIniRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getMinutosRefrigerio()-CAS:"+turno.getMinutosRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getHoraFinRefrigerio()-CAS:"+turno.getHoraFinRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getDuracion()-CAS:"+turno.getDuracion());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getHoraLimite()-CAS:"+turno.getHoraLimite());//LOG GENERACION 	----procesar metodo
		if (log.isDebugEnabled()) log.debug("turno.getTolera()-CAS:"+turno.getTolera());//LOG GENERACION 			----procesar metodo
		String calif = Constantes.MOVIMIENTO_NORMAL;
		if (log.isDebugEnabled()) log.debug("calif0-CAS:"+calif);//LOG GENERACION
		try {

			float cantidad = 0;
			
			if (tieneRefrigerio) {			
				if (log.isDebugEnabled()) log.debug("tiene refrigerio");//LOG GENERACION
								
				cantidad = Utiles.calculaAcumulado(medida, 
						Utiles.stringToTimestamp(fechaMarca + " " + horaIni), 
						Utiles.stringToTimestamp(fechaMarca + " " + turno.getHoraIniRefrigerio()));
				if (log.isDebugEnabled()) log.debug("cantidad2-CAS:"+cantidad);//LOG GENERACION
				if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
				if (log.isDebugEnabled()) log.debug("turno.getHoraIniRefrigerio()-CAS:"+turno.getHoraIniRefrigerio());//LOG GENERACION					
				log_papeleta.debug("Cantidad " + cantidad);
				log_papeleta.debug("Turno.getHoraIniRefrigerio " + turno.getHoraIniRefrigerio());
				log_papeleta.debug("horaIni " + horaIni);
				//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
				if ("".equals(turno.getHoraIniRefrigerio().trim())) {
					calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
					if (log.isDebugEnabled()) log.debug("calif(inicioRefri vacio):"+calif);
				} else {					
				//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
				if (cantidad < 0) {
					float durante1 = Utiles.calculaAcumulado(medida, 
							Utiles.stringToTimestamp(fechaMarca + " " + horaIni),
							Utiles.stringToTimestamp(fechaMarca + " "+ horaFin));
					if (log.isDebugEnabled()) log.debug("durante1-CAS:"+durante1);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION	
					float tarde1 = Utiles.calculaAcumulado(medida,
							Utiles.stringToTimestamp(fechaMarca + " "+ turno.getHoraFinRefrigerio()), 
							Utiles.stringToTimestamp(fechaMarca + " "+ horaIni));
					if (log.isDebugEnabled()) log.debug("tarde1-CAS:"+tarde1);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("turno.getHoraFinRefrigerio()-CAS:"+turno.getHoraFinRefrigerio());//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
					log_papeleta.debug("durante " + durante1);
					log_papeleta.debug("despues " + tarde1);
					//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
					if ("".equals(turno.getHoraFinRefrigerio().trim())) {
						calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
						if (log.isDebugEnabled()) log.debug("calif(inicioRefri vacio):"+calif);
					} else {					
						//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
						//if (tarde1 >= 0) { //ICR 18052015
						if (tarde1 > 0) { //ICR 18052015
							/*EBV 25/03/2015 CAMBIO DE LINEAMIENTO
									calif = Constantes.MOV_SALIDA_AUTORIZADA;*/
	                        calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
							if (log.isDebugEnabled()) log.debug("calif10-CAS:"+calif);//LOG GENERACION
						} else {
							
							//ICAPUNAY - PAS20175E230300069
							if (procesaClima){
								if (durante1 > minutosClima) {										
									calif = Constantes.MOV_EXCESO_REFRIGERIO;
									if (log.isDebugEnabled()) log.debug("calif111-CAS:"+calif);
								} else {
									calif = Constantes.MOV_REFRI_CLIMALABORAL;
									if (log.isDebugEnabled()) log.debug("calif122-CAS:"+calif);
								}
							}else{
							//ICAPUNAY - PAS20175E230300069
								if (durante1 > turno.getMinutosRefrigerio()) {
									//ICR - EBV 18052015 
									//calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
									calif = Constantes.MOV_EXCESO_REFRIGERIO;
									if (log.isDebugEnabled()) log.debug("calif11-CAS:"+calif);//LOG GENERACION
								} else {
									calif = Constantes.MOV_REFRIGERIO;
									if (log.isDebugEnabled()) log.debug("calif12-CAS:"+calif);//LOG GENERACION
								}
							}//linea add ICAPUNAY - PAS20175E230300069						
						}					
					}//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
				} 
				if (log.isDebugEnabled()) log.debug("calif4-CAS:"+calif);//LOG GENERACION
				}//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
			}
			else {
				if (log.isDebugEnabled()) log.debug("NO tiene refrigerio");//LOG GENERACION
				cantidad = Utiles.calculaAcumulado(medida, 
						Utiles.stringToTimestamp(fechaMarca + " " + turno.getHoraIni()),
						Utiles.stringToTimestamp(fechaMarca + " " + horaFin));
				if (log.isDebugEnabled()) log.debug("cantidad3-CAS:"+cantidad);//LOG GENERACION
				if (log.isDebugEnabled()) log.debug("turno.getHoraIni()-CAS:"+turno.getHoraIni());//LOG GENERACION
				if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION
				if (cantidad < 0) {
					calif = Constantes.MOV_APORTACION;
					if (log.isDebugEnabled()) log.debug("calif5-CAS:"+calif);//LOG GENERACION
				}
				else{
					cantidad = Utiles.calculaAcumulado(medida, 
							Utiles.stringToTimestamp(fechaMarca + " " + horaIni), 
							Utiles.stringToTimestamp(fechaMarca + " " + turno.getHoraIniRefrigerio()));
					if (log.isDebugEnabled()) log.debug("cantidad4-CAS:"+cantidad);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("turno.getHoraIniRefrigerio()-CAS:"+turno.getHoraIniRefrigerio());//LOG GENERACION
					//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
					if ("".equals(turno.getHoraIniRefrigerio().trim())) {
						calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
						if (log.isDebugEnabled()) log.debug("calif(inicioRefri vacio):"+calif);
					} else {					
					//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
					if (cantidad > 0) {
						/*EBV 25/03/2015 CAMBIO DE LINEAMIENTO
								calif = Constantes.MOV_SALIDA_AUTORIZADA;*/
                        calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
						if (log.isDebugEnabled()) log.debug("calif5.1-CAS:"+calif);//LOG GENERACION
					} 
					else {
							float durante = Utiles.calculaAcumulado(medida, 
									Utiles.stringToTimestamp(fechaMarca + " " + horaIni),
									Utiles.stringToTimestamp(fechaMarca + " "+ horaFin));
							if (log.isDebugEnabled()) log.debug("durante2-CAS:"+durante);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION	
	
							float despues = Utiles.calculaAcumulado(medida,
									Utiles.stringToTimestamp(fechaMarca + " "+ turno.getHoraFinRefrigerio()), 
									Utiles.stringToTimestamp(fechaMarca + " "+ horaIni));
							if (log.isDebugEnabled()) log.debug("despues-CAS:"+despues);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("turno.getHoraFinRefrigerio()-CAS:"+turno.getHoraFinRefrigerio());//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
							//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
							if ("".equals(turno.getHoraFinRefrigerio().trim())) {
								calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
								if (log.isDebugEnabled()) log.debug("calif(finRefri vacio):"+calif);
							} else {					
							//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
							//if (despues >= 0) {	//ICR 18052015
								if (despues > 0) {	//ICR 18052015
									/*EBV 25/03/2015 CAMBIO DE LINEAMIENTO
										calif = Constantes.MOV_SALIDA_AUTORIZADA;*/
		                            calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
									if (log.isDebugEnabled()) log.debug("calif7-CAS:"+calif);//LOG GENERACION							
								} else {
									//ICAPUNAY - PAS20175E230300069
									if (procesaClima){
										if (durante > minutosClima) {										
											calif = Constantes.MOV_EXCESO_REFRIGERIO;
											if (log.isDebugEnabled()) log.debug("calif8:"+calif);
										} else {
											calif = Constantes.MOV_REFRI_CLIMALABORAL;
											if (log.isDebugEnabled()) log.debug("calif9:"+calif);
										}
									}else{
									//ICAPUNAY - PAS20175E230300069
										if (durante > turno.getMinutosRefrigerio()) {
											//ICR - EBV 18052015 
											//calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
											calif = Constantes.MOV_EXCESO_REFRIGERIO;
											if (log.isDebugEnabled()) log.debug("calif8:"+calif);//LOG GENERACION
										} else {
											calif = Constantes.MOV_REFRIGERIO;
											if (log.isDebugEnabled()) log.debug("calif9:"+calif);//LOG GENERACION
										}
									}//linea add ICAPUNAY - PAS20175E230300069					
								}							
							}//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
						}
					
					}//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
					
				}
			}
			
		} catch (Exception e){
			log.error(e);
			
		}

		return calif;
	}
	
	/**
	 * Calificar asistencia cuando SI tiene turno (dia w:x-1) de 2 dias y SI tiene turno dia x de 2 d涌 (marcaciones PARES requiere para dia x)
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @return califica Map
	 * @throws FacadeException
	 */
	public Map preCalificarMovimientoOpe3(String fechaMarca, String horaIni, String horaFin,
			//BeanTurnoTrabajo turnoW, BeanTurnoTrabajo turnoX, String medida, boolean tieneRefrigerioW,boolean tieneRefrigerioX, boolean bOperativoW, boolean bOperativoX) throws RemoteException { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
			BeanTurnoTrabajo turnoW, BeanTurnoTrabajo turnoX, String medida, boolean tieneRefrigerioW,boolean tieneRefrigerioX, boolean bOperativoW, boolean bOperativoX,boolean procesaClima, int minutosClima) throws RemoteException { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
		
		Map califica = new HashMap();

		if (log.isDebugEnabled()) log.debug("ingreso preCalificarMovimientoOpe3");//NUEVO
		if (log.isDebugEnabled()) log.debug("fechaMarca-CAS:"+fechaMarca);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("medida-CAS:"+medida);//LOG GENERACION	
		
		if (log.isDebugEnabled()) log.debug("turnoW.getHoraIni()-CAS:"+turnoW.getHoraIni());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turnoW.getHoraFin()-CAS:"+turnoW.getHoraFin());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turnoW.getHoraLimite()-CAS:"+turnoW.getHoraLimite());//LOG GENERACION 
		if (log.isDebugEnabled()) log.debug("turnoW.getTolera()-CAS:"+turnoW.getTolera());//LOG GENERACION 			
		if (log.isDebugEnabled()) log.debug("turnoW.getHoraIniRefrigerio()-CAS:"+turnoW.getHoraIniRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turnoW.getMinutosRefrigerio()-CAS:"+turnoW.getMinutosRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turnoW.getHoraFinRefrigerio()-CAS:"+turnoW.getHoraFinRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("tieneRefrigerioW-CAS:"+tieneRefrigerioW);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("bOperativoW-CAS:"+bOperativoW);//LOG GENERACION
		
		if (log.isDebugEnabled()) log.debug("turnoX.getHoraIni()-CAS:"+turnoX.getHoraIni());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turnoX.getHoraFin()-CAS:"+turnoX.getHoraFin());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turnoX.getHoraLimite()-CAS:"+turnoX.getHoraLimite());//LOG GENERACION 
		if (log.isDebugEnabled()) log.debug("turnoX.getTolera()-CAS:"+turnoX.getTolera());//LOG GENERACION 			
		if (log.isDebugEnabled()) log.debug("turnoX.getHoraIniRefrigerio()-CAS:"+turnoX.getHoraIniRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turnoX.getMinutosRefrigerio()-CAS:"+turnoX.getMinutosRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turnoX.getHoraFinRefrigerio()-CAS:"+turnoX.getHoraFinRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("tieneRefrigerioX-CAS:"+tieneRefrigerioX);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("bOperativoX-CAS:"+bOperativoX);//LOG GENERACION

		
		String calif = Constantes.MOVIMIENTO_NORMAL;
		califica.put("calif",calif);
		
		if (log.isDebugEnabled()) log.debug("calif0-CAS:"+calif);//LOG GENERACION
		try {

			float cantidad = 0;
			float cantidad2 = 0;
			boolean parejaCalificada= false;//NUEVO
			
			//TURNO W
			/*if (tieneRefrigerioW) {
				if (log.isDebugEnabled()) log.debug("tiene refrigerioW");//LOG GENERACION
				if (horaIni.trim().compareTo(turnoX.getHoraIni().trim())<0){//NUEVO
					if (log.isDebugEnabled()) log.debug("tiene refrigerioW(horaIni<turnoX.getHoraIni)");//LOG GENERACION	
					cantidad = Utiles.calculaAcumulado(medida, 
							Utiles.stringToTimestamp(fechaMarca + " " + turnoW.getHoraFin()),
							Utiles.stringToTimestamp(fechaMarca + " " + horaIni));
					if (log.isDebugEnabled()) log.debug("cantidad-CAS:"+cantidad);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("turnoW.getHoraFin()-CAS:"+turnoW.getHoraFin());//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION	
					if (cantidad > 0) {							
						if(parejaCalificada== false){
							parejaCalificada= true;
							calif = Constantes.MOV_APORTACION;
							califica.put("calif",calif);
							califica.put("refrigerioW","SI");
							califica.put("refrigerioX","NO");
							if (log.isDebugEnabled()) log.debug("calif3-CAS:"+calif);//LOG GENERACION	
						}							
					} else {						
						cantidad = Utiles.calculaAcumulado(medida, 
								Utiles.stringToTimestamp(fechaMarca + " " + horaIni), 
								Utiles.stringToTimestamp(fechaMarca + " " + turnoW.getHoraIniRefrigerio()));
						if (log.isDebugEnabled()) log.debug("cantidad2-CAS:"+cantidad);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("turnoW.getHoraIniRefrigerio()-CAS:"+turnoW.getHoraIniRefrigerio());//LOG GENERACION					
						if (log.isDebugEnabled()) log.debug("Cantidad " + cantidad);
						if (log.isDebugEnabled()) log.debug("turnoW.getHoraIniRefrigerio " + turnoW.getHoraIniRefrigerio());
						if (log.isDebugEnabled()) log.debug("horaIni " + horaIni);
						if (cantidad < 0) {
							float durante1 = Utiles.calculaAcumulado(medida, 
									Utiles.stringToTimestamp(fechaMarca + " " + horaIni),
									Utiles.stringToTimestamp(fechaMarca + " "+ horaFin));
							if (log.isDebugEnabled()) log.debug("durante1-CAS:"+durante1);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION	
							float tarde1 = Utiles.calculaAcumulado(medida,
									Utiles.stringToTimestamp(fechaMarca + " "+ turnoW.getHoraFinRefrigerio()), 
									Utiles.stringToTimestamp(fechaMarca + " "+ horaIni));
							if (log.isDebugEnabled()) log.debug("tarde1-CAS:"+tarde1);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("turnoW.getHoraFinRefrigerio()-CAS:"+turnoW.getHoraFinRefrigerio());//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("durante W" + durante1);
							if (log.isDebugEnabled()) log.debug("despues W" + tarde1);
							if (tarde1 >= 0) {
								if(parejaCalificada== false){
									parejaCalificada= true;
									
                                                                        calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
									if (log.isDebugEnabled()) log.debug("calif10-CAS:"+calif);//LOG GENERACION
								}	
							} else {
								if (durante1 > turnoW.getMinutosRefrigerio()) {
									if(parejaCalificada== false){
										parejaCalificada= true;
										
                                          //ICR 18052015 
										  //calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
											calif = Constantes.MOV_EXCESO_REFRIGERIO;
										if (log.isDebugEnabled()) log.debug("calif11-CAS:"+calif);//LOG GENERACION
									}	
								} else {
									if(parejaCalificada== false){
										parejaCalificada= true;
										calif = Constantes.MOV_REFRIGERIO;
										if (log.isDebugEnabled()) log.debug("calif12-CAS:"+calif);//LOG GENERACION
									}	
								}

							}
							califica.put("calif",calif);
							califica.put("refrigerioW","SI");
							califica.put("refrigerioX","NO");							
						} 
						if (log.isDebugEnabled()) log.debug("calif4-CAS:"+calif);//LOG GENERACION							
					}
				}
				//NUEVO				
			}
			else*/ 
			if (tieneRefrigerioW==false){
				if (log.isDebugEnabled()) log.debug("NO tiene refrigerioW");			
				if (horaIni.trim().compareTo(turnoX.getHoraIni().trim())<0){//NUEVO
					if (log.isDebugEnabled()) log.debug("NO tiene refrigerioW(horaIni<turnoX.getHoraIni)");//LOG GENERACION
					/*cantidad = Utiles.calculaAcumulado(medida, 
							Utiles.stringToTimestamp(fechaMarca + " " + horaIni), 
							Utiles.stringToTimestamp(fechaMarca + " " + turnoW.getHoraIniRefrigerio()));
					if (log.isDebugEnabled()) log.debug("cantidad4-CAS:"+cantidad);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("turnoW.getHoraIniRefrigerio()-CAS:"+turnoW.getHoraIniRefrigerio());//LOG GENERACION	
					if (cantidad > 0) {
						if(parejaCalificada== false){
							parejaCalificada= true;
							
                                                        calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
							califica.put("calif",calif);
							califica.put("refrigerioW","NO");
							califica.put("refrigerioX","NO");
							if (log.isDebugEnabled()) log.debug("calif5.1-CAS:"+calif);//LOG GENERACION
						}	
					} 
					else {						
						float durante = Utiles.calculaAcumulado(medida, 
								Utiles.stringToTimestamp(fechaMarca + " " + horaIni),
								Utiles.stringToTimestamp(fechaMarca + " "+ horaFin));
						if (log.isDebugEnabled()) log.debug("durante2-CAS:"+durante);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION	

						float despues = Utiles.calculaAcumulado(medida,
								Utiles.stringToTimestamp(fechaMarca + " "+ turnoW.getHoraFinRefrigerio()), 
								Utiles.stringToTimestamp(fechaMarca + " "+ horaIni));
						if (log.isDebugEnabled()) log.debug("despues-CAS:"+despues);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("turnoW.getHoraFinRefrigerio()-CAS:"+turnoW.getHoraFinRefrigerio());//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION

						if (despues >= 0) {*/
							cantidad = Utiles.calculaAcumulado(medida, 
									Utiles.stringToTimestamp(fechaMarca + " " + turnoW.getHoraFin()),
									Utiles.stringToTimestamp(fechaMarca + " " + horaIni));
							//if (log.isDebugEnabled()) log.debug("cantidad5-CAS:"+despues);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("turnoW.getHoraFin()-CAS:"+turnoW.getHoraFin());//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("Cantidad " + cantidad);
							if (log.isDebugEnabled()) log.debug("turnoW.getHoraFin " + turnoW.getHoraFin());
							if (log.isDebugEnabled()) log.debug("horaIni " + horaIni);
							//if (cantidad > 0) { //ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
							if (cantidad >= 0) { //ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
								if (log.isDebugEnabled()) log.debug("horaIni>=turno.getHoraFin()_ope3");//ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
								if(parejaCalificada== false){
									parejaCalificada= true;
									calif = Constantes.MOV_APORTACION;
									if (log.isDebugEnabled()) log.debug("calif6-CAS:"+calif);//LOG GENERACION
								}	
							} else {
								if(parejaCalificada== false){
									parejaCalificada= true;
									/*EBV 25/03/2015 CAMBIO DE LINEAMIENTO
								calif = Constantes.MOV_SALIDA_AUTORIZADA;
*/
                                    calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
									if (log.isDebugEnabled()) log.debug("calif7-CAS:"+calif);//LOG GENERACION
								}	
							}
							califica.put("calif",calif);
							califica.put("refrigerioW","NO");
							califica.put("refrigerioX","NO");
						/*} else {
							if (durante > turnoW.getMinutosRefrigerio()) {
								if(parejaCalificada== false){
									parejaCalificada= true;
									calif = Constantes.MOV_EXCESO_REFRIGERIO;							
									if (log.isDebugEnabled()) log.debug("calif8-CAS:"+calif);//LOG GENERACION
								}	
							} else {
								if(parejaCalificada== false){
									parejaCalificada= true;
									calif = Constantes.MOV_REFRIGERIO;
									if (log.isDebugEnabled()) log.debug("calif9-CAS:"+calif);//LOG GENERACION
								}	
							}
							califica.put("calif",calif);
							califica.put("refrigerioW","SI");
							califica.put("refrigerioX","NO");
						}*/						
					//}
				}
				//NUEVO				
			}
			
			//TURNO X
			if (tieneRefrigerioX) {
				if (log.isDebugEnabled()) log.debug("tiene refrigerioX");//LOG GENERACION					
				if (horaIni.trim().compareTo(turnoX.getHoraIni().trim())>0){//NUEVO
					if (log.isDebugEnabled()) log.debug("tiene refrigerioX(horaIni>turnoX.getHoraIni)");//LOG GENERACION	
					cantidad2 = Utiles.calculaAcumulado(medida, 
							Utiles.stringToTimestamp(fechaMarca + " " + horaIni), 
							Utiles.stringToTimestamp(fechaMarca + " " + turnoX.getHoraIniRefrigerio()));
					if (log.isDebugEnabled()) log.debug("cantidad2-CAS:"+cantidad);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("turnoX.getHoraIniRefrigerio()-CAS:"+turnoX.getHoraIniRefrigerio());//LOG GENERACION					
					if (log.isDebugEnabled()) log.debug("Cantidad " + cantidad);
					if (log.isDebugEnabled()) log.debug("turnoX.getHoraIniRefrigerio " + turnoX.getHoraIniRefrigerio());
					if (log.isDebugEnabled()) log.debug("horaIni " + horaIni);
					//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
					if ("".equals(turnoX.getHoraIniRefrigerio().trim())) {
						calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
						if (log.isDebugEnabled()) log.debug("calif(inicioRefri vacio):"+calif);
					} else {					
					//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
					if (cantidad2 < 0) {
						float durante1 = Utiles.calculaAcumulado(medida, 
								Utiles.stringToTimestamp(fechaMarca + " " + horaIni),
								Utiles.stringToTimestamp(fechaMarca + " "+ horaFin)
						);
						if (log.isDebugEnabled()) log.debug("durante1-CAS:"+durante1);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION	
						float tarde1 = Utiles.calculaAcumulado(medida,
								Utiles.stringToTimestamp(fechaMarca + " "+ turnoX.getHoraFinRefrigerio()), 
								Utiles.stringToTimestamp(fechaMarca + " "+ horaIni));
						if (log.isDebugEnabled()) log.debug("tarde1-CAS:"+tarde1);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("turnoX.getHoraFinRefrigerio()-CAS:"+turnoX.getHoraFinRefrigerio());//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("durante X" + durante1);
						if (log.isDebugEnabled()) log.debug("despues X" + tarde1);
						//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
						if ("".equals(turnoX.getHoraFinRefrigerio().trim())) {
							calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
							if (log.isDebugEnabled()) log.debug("calif(finRefri vacio):"+calif);
						} else {					
							//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
							//if (tarde1 >= 0) { //ICR 18052015
							if (tarde1 > 0) { //ICR 18052015
								if(parejaCalificada== false){
									parejaCalificada= true;
									/*EBV 25/03/2015 CAMBIO DE LINEAMIENTO
									calif = Constantes.MOV_SALIDA_AUTORIZADA;
	*/
	                                calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
									if (log.isDebugEnabled()) log.debug("calif10-CAS:"+calif);//LOG GENERACION
								}	
							} else {
								
								//ICAPUNAY - PAS20175E230300069
								if (procesaClima){
									if (durante1 > minutosClima) {
										if(parejaCalificada== false){
											parejaCalificada= true;											
											calif = Constantes.MOV_EXCESO_REFRIGERIO;
											if (log.isDebugEnabled()) log.debug("calif11-CAS:"+calif);//LOG GENERACION
										}	
									} else {
										if(parejaCalificada== false){
											parejaCalificada= true;
											calif = Constantes.MOV_REFRI_CLIMALABORAL;
											if (log.isDebugEnabled()) log.debug("calif12-CAS:"+calif);//LOG GENERACION
										}	
									}	
								}else{
								//ICAPUNAY - PAS20175E230300069
									if (durante1 > turnoX.getMinutosRefrigerio()) {
										if(parejaCalificada== false){
											parejaCalificada= true;											
											calif = Constantes.MOV_EXCESO_REFRIGERIO;
											if (log.isDebugEnabled()) log.debug("calif11-CAS:"+calif);//LOG GENERACION
										}	
									} else {
										if(parejaCalificada== false){
											parejaCalificada= true;
											calif = Constantes.MOV_REFRIGERIO;
											if (log.isDebugEnabled()) log.debug("calif12-CAS:"+calif);//LOG GENERACION
										}	
									}		
								}//linea add ICAPUNAY - PAS20175E230300069					
							}
							
						}//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
						califica.put("calif",calif);
						califica.put("refrigerioW","NO");
						califica.put("refrigerioX","SI");						
					} 
					if (log.isDebugEnabled()) log.debug("calif4-CAS:"+calif);//LOG GENERACION					
					}//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
				}
				//NUEVO				
			}
			else {
				if (log.isDebugEnabled()) log.debug("NO tiene refrigerioX");//LOG GENERACION
				
				if (horaIni.trim().compareTo(turnoX.getHoraIni().trim())>0){//NUEVO
					if (log.isDebugEnabled()) log.debug("NO tiene refrigerioX(horaIni>turnoX.getHoraIni)");//LOG GENERACION
					/*cantidad2 = Utiles.calculaAcumulado(medida, 
							Utiles.stringToTimestamp(fechaMarca + " " + turnoX.getHoraIni()),
							Utiles.stringToTimestamp(fechaMarca + " " + horaFin));
					if (log.isDebugEnabled()) log.debug("cantidad3-CAS:"+cantidad);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("turnoX.getHoraIni()-CAS:"+turnoX.getHoraIni());//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION
	
					if (cantidad2 < 0) {
						if(parejaCalificada== false){
							parejaCalificada= true;
							calif = Constantes.MOV_APORTACION;
							califica.put("calif",calif);
							califica.put("refrigerioW","NO");
							califica.put("refrigerioX","NO");
							if (log.isDebugEnabled()) log.debug("calif5-CAS:"+calif);//LOG GENERACION
						}	
					}
					else{*/					
						cantidad2 = Utiles.calculaAcumulado(medida, 
								Utiles.stringToTimestamp(fechaMarca + " " + horaIni), 
								Utiles.stringToTimestamp(fechaMarca + " " + turnoX.getHoraIniRefrigerio()));
						if (log.isDebugEnabled()) log.debug("cantidad4-CAS:"+cantidad);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("turnoX.getHoraIniRefrigerio()-CAS:"+turnoX.getHoraIniRefrigerio());//LOG GENERACION
						//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
						if ("".equals(turnoX.getHoraIniRefrigerio().trim())) {
							calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
							//ultimo agregado cuando turno no tiene refrigerio
							if(parejaCalificada== false){
								parejaCalificada= true;
                                calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
								califica.put("calif",calif);
								califica.put("refrigerioW","NO");
								califica.put("refrigerioX","NO");
							}
							//ultimo agregado cuando turno no tiene refrigerio
							if (log.isDebugEnabled()) log.debug("calif(inicioRefri vacio):"+calif);
						} else {					
						//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
						if (cantidad2 > 0) {
							if(parejaCalificada== false){
								parejaCalificada= true;
								/*EBV 25/03/2015 CAMBIO DE LINEAMIENTO
								calif = Constantes.MOV_SALIDA_AUTORIZADA;
*/
                                calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
								califica.put("calif",calif);
								califica.put("refrigerioW","NO");
								califica.put("refrigerioX","NO");
								if (log.isDebugEnabled()) log.debug("calif5.1-CAS:"+calif);//LOG GENERACION
							}	
						} 
						else {				
							float durante = Utiles.calculaAcumulado(medida, 
									Utiles.stringToTimestamp(fechaMarca + " " + horaIni),
									Utiles.stringToTimestamp(fechaMarca + " "+ horaFin));
							if (log.isDebugEnabled()) log.debug("durante2-CAS:"+durante);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION	
	
							float despues = Utiles.calculaAcumulado(medida,
									Utiles.stringToTimestamp(fechaMarca + " "+ turnoX.getHoraFinRefrigerio()), 
									Utiles.stringToTimestamp(fechaMarca + " "+ horaIni));
							if (log.isDebugEnabled()) log.debug("despues-CAS:"+despues);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("turnoX.getHoraFinRefrigerio()-CAS:"+turnoX.getHoraFinRefrigerio());//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
							//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
							if ("".equals(turnoX.getHoraFinRefrigerio().trim())) {
								calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
								//ultimo agregado cuando turno no tiene refrigerio
								if(parejaCalificada== false){
									parejaCalificada= true;
	                                calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
									califica.put("calif",calif);
									califica.put("refrigerioW","NO");
									califica.put("refrigerioX","NO");
								}
								//ultimo agregado cuando turno no tiene refrigerio
								if (log.isDebugEnabled()) log.debug("calif(finRefri vacio):"+calif);
							} else {					
								//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
								//if (despues >= 0) { //ICR 18052015
								if (despues > 0) { //ICR 18052015
									cantidad2 = Utiles.calculaAcumulado(medida, 
											Utiles.stringToTimestamp(fechaMarca + " " + turnoX.getHoraFin()),
											Utiles.stringToTimestamp(fechaMarca + " " + horaIni));
									if (log.isDebugEnabled()) log.debug("cantidad5-CAS:"+despues);//LOG GENERACION
									if (log.isDebugEnabled()) log.debug("turnoX.getHoraFin()-CAS:"+turnoX.getHoraFin());//LOG GENERACION
									if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
									if (log.isDebugEnabled()) log.debug("Cantidad " + cantidad);
									if (log.isDebugEnabled()) log.debug("turnoX.getHoraFin " + turnoX.getHoraFin());
									if (log.isDebugEnabled()) log.debug("horaIni " + horaIni);
									if (cantidad2 > 0) {
										if(parejaCalificada== false){
											parejaCalificada= true;
											/*EBV 25/03/2015 CAMBIO DE LINEAMIENTO
									calif = Constantes.MOV_SALIDA_AUTORIZADA;
	*/
	                                                                                calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
											if (log.isDebugEnabled()) log.debug("calif6-CAS:"+calif);//LOG GENERACION
										}	
									} 
									califica.put("calif",calif);
									califica.put("refrigerioW","NO");
									califica.put("refrigerioX","NO");
								} else {
									//ICAPUNAY - PAS20175E230300069
									if (procesaClima){
										if (durante > minutosClima) {
											if(parejaCalificada== false){
												parejaCalificada= true;											
												calif = Constantes.MOV_EXCESO_REFRIGERIO;
												if (log.isDebugEnabled()) log.debug("calif8-CAS:"+calif);//LOG GENERACION
											}	
										} else {
											if(parejaCalificada== false){
												parejaCalificada= true;
												calif = Constantes.MOV_REFRI_CLIMALABORAL;
												if (log.isDebugEnabled()) log.debug("calif9-CAS:"+calif);//LOG GENERACION
											}	
										}	
									}else{
									//ICAPUNAY - PAS20175E230300069
										if (durante > turnoX.getMinutosRefrigerio()) {
											if(parejaCalificada== false){
												parejaCalificada= true;											
												calif = Constantes.MOV_EXCESO_REFRIGERIO;
												if (log.isDebugEnabled()) log.debug("calif8-CAS:"+calif);//LOG GENERACION
											}	
										} else {
											if(parejaCalificada== false){
												parejaCalificada= true;
												calif = Constantes.MOV_REFRIGERIO;
												if (log.isDebugEnabled()) log.debug("calif9-CAS:"+calif);//LOG GENERACION
											}	
										}		
									}//linea add ICAPUNAY - PAS20175E230300069
									
									califica.put("calif",calif);
									califica.put("refrigerioW","NO");
									califica.put("refrigerioX","SI");
								}							
							}//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
						}
						
						}//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
					//}
				}
				//NUEVO					
			}			
		} catch (Exception e){
			log.error(e);			
		}
		return califica;
	}
	
	/**
	 * Califica movimientos para colaboradores para una fecha con s?un turno administrativo o controlado de 1 dia de duraci?	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * 
	 */
	public String preCalificarMovimiento_soloTurnoAdmOpe1dia(String dbpool,String codPers,String fechaMarca, String horaIni, String horaFin,
			BeanTurnoTrabajo turno, String medida, boolean tieneRefrigerio, boolean bOperativo, boolean procesaClima, int minutosClima ) throws RemoteException { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
			//BeanTurnoTrabajo turno, String medida, boolean tieneRefrigerio, boolean bOperativo) throws RemoteException { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral

		if (log.isDebugEnabled()) log.debug("ingreso preCalificarMovimiento_soloTurnoAdmOpe1dia");//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("fechaMarca:"+fechaMarca);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaIni:"+horaIni);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaFin:"+horaFin);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("medida:"+medida);//LOG GENERACION		
		if (log.isDebugEnabled()) log.debug("turno.getHoraIni():"+turno.getHoraIni());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getHoraFin():"+turno.getHoraFin());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("tieneRefrigerio:"+tieneRefrigerio);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("bOperativo:"+bOperativo);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getHoraIniRefrigerio():"+turno.getHoraIniRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getMinutosRefrigerio():"+turno.getMinutosRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getHoraFinRefrigerio():"+turno.getHoraFinRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getDuracion():"+turno.getDuracion());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turno.getHoraLimite():"+turno.getHoraLimite());//LOG GENERACION 	
		if (log.isDebugEnabled()) log.debug("turno.getTolera():"+turno.getTolera());//LOG GENERACION 			
		String calif = Constantes.MOVIMIENTO_NORMAL;
		if (log.isDebugEnabled()) log.debug("calif0:"+calif);//LOG GENERACION
		try {

			float cantidad = 0;
			//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
			T1270DAO dao = new T1270DAO();	
			int horasCompensa = dao.findHorasCompensa(dbpool,codPers,fechaMarca); 
			if (log.isDebugEnabled()) log.debug("horasCompensa-CAS:"+horasCompensa);
			//ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
			
			/*if (bOperativo){
				if (log.isDebugEnabled()) log.debug("es operativo-CAS");//LOG GENERACION
				calif = Constantes.MOV_TRABAJO_CAMPO;
				if (log.isDebugEnabled()) log.debug("calif1-CAS:"+calif);//LOG GENERACION
			}
			else */
			//se comento seg?n lo indicado por dcaballero a calidad 28/11/2014
			if ((turno.getTurno().equals("099")) ||
					//(turno.getTurno().equals("098")) ||
					(turno.getTurno().equals("097"))){
				calif = Constantes.MOV_LABOR_FUERA_OFICINA;
				if (log.isDebugEnabled()) log.debug("turnos 097 o 099");//LOG GENERACION
				if (log.isDebugEnabled()) log.debug("calif2:"+calif);//LOG GENERACION
			}
			else 
				if (tieneRefrigerio) {
				if (log.isDebugEnabled()) log.debug("tiene refrigerio");//LOG GENERACION				
				cantidad = Utiles.calculaAcumulado(medida, 
						Utiles.stringToTimestamp(fechaMarca + " " + turno.getHoraFin()),
						Utiles.stringToTimestamp(fechaMarca + " " + horaIni));
				if (log.isDebugEnabled()) log.debug("cantidad:"+cantidad);//LOG GENERACION
				if (log.isDebugEnabled()) log.debug("turno.getHoraFin():"+turno.getHoraFin());//LOG GENERACION
				if (log.isDebugEnabled()) log.debug("horaIni:"+horaIni);//LOG GENERACION
				
				//en caso se posea horas (60 min) por compensar se adicionan
				cantidad =cantidad - horasCompensa; //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
				
				//if (cantidad > 0) { //ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
				if (cantidad >= 0) { //ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
					if (log.isDebugEnabled()) log.debug("horaIni>=turno.getHoraFin()");//ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
					calif = Constantes.MOV_APORTACION;
					if (log.isDebugEnabled()) log.debug("calif3:"+calif);//LOG GENERACION
				} else {
					cantidad = Utiles.calculaAcumulado(medida, 
							Utiles.stringToTimestamp(fechaMarca + " " + horaIni), 
							Utiles.stringToTimestamp(fechaMarca + " " + turno.getHoraIniRefrigerio()));
					if (log.isDebugEnabled()) log.debug("cantidad2:"+cantidad);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("horaIni:"+horaIni);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("turno.getHoraIniRefrigerio():"+turno.getHoraIniRefrigerio());//LOG GENERACION					
					log_papeleta.debug("Cantidad " + cantidad);
					log_papeleta.debug("Turno.getHoraIniRefrigerio " + turno.getHoraIniRefrigerio());
					log_papeleta.debug("horaIni " + horaIni);
					//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
					if ("".equals(turno.getHoraIniRefrigerio().trim())) {
						calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
						if (log.isDebugEnabled()) log.debug("calif(inicioRefri vacio):"+calif);
					} else {					
					//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
					if (cantidad < 0) {
						float durante1 = Utiles.calculaAcumulado(medida, 
								Utiles.stringToTimestamp(fechaMarca + " " + horaIni),
								Utiles.stringToTimestamp(fechaMarca + " "+ horaFin)
								);
						if (log.isDebugEnabled()) log.debug("durante1:"+durante1);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni:"+horaIni);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaFin:"+horaFin);//LOG GENERACION	
						float tarde1 = Utiles.calculaAcumulado(medida,
								Utiles.stringToTimestamp(fechaMarca + " "+ turno.getHoraFinRefrigerio()), 
								Utiles.stringToTimestamp(fechaMarca + " "+ horaIni));
						if (log.isDebugEnabled()) log.debug("tarde1:"+tarde1);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("turno.getHoraFinRefrigerio():"+turno.getHoraFinRefrigerio());//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni:"+horaIni);//LOG GENERACION
						log_papeleta.debug("durante " + durante1);
						log_papeleta.debug("despues " + tarde1);
						//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
						if ("".equals(turno.getHoraFinRefrigerio().trim())) {
							calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
							if (log.isDebugEnabled()) log.debug("calif(finRefri vacio):"+calif);
						} else {					
						//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
							//if (tarde1 >= 0) { //ICR 18052015
							if (tarde1 > 0) { //ICR 18052015
								calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
								if (log.isDebugEnabled()) log.debug("calif10:"+calif);//LOG GENERACION
							} else {
								//ICAPUNAY - PAS20175E230300069
								if (procesaClima){
									if (durante1 > minutosClima) {										
										calif = Constantes.MOV_EXCESO_REFRIGERIO;
										if (log.isDebugEnabled()) log.debug("calif101:"+calif);
									} else {
										calif = Constantes.MOV_REFRI_CLIMALABORAL;
										if (log.isDebugEnabled()) log.debug("calif102:"+calif);
									}
								}else{
								//ICAPUNAY - PAS20175E230300069
									if (durante1 > turno.getMinutosRefrigerio()) {
										//ICR - EBV 18052015 
										//calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
										calif = Constantes.MOV_EXCESO_REFRIGERIO;
										if (log.isDebugEnabled()) log.debug("calif11:"+calif);//LOG GENERACION
									} else {
										calif = Constantes.MOV_REFRIGERIO;
										if (log.isDebugEnabled()) log.debug("calif12:"+calif);//LOG GENERACION
									}
								}//linea add ICAPUNAY - PAS20175E230300069							
							}						
						}//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
					}
					
					}//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
					if (log.isDebugEnabled()) log.debug("calif4:"+calif);//LOG GENERACION	
				}
			}
			else {
				if (log.isDebugEnabled()) log.debug("NO tiene refrigerio");//LOG GENERACION
				cantidad = Utiles.calculaAcumulado(medida, 
						Utiles.stringToTimestamp(fechaMarca + " " + turno.getHoraIni()),
						Utiles.stringToTimestamp(fechaMarca + " " + horaFin));
				if (log.isDebugEnabled()) log.debug("cantidad3:"+cantidad);//LOG GENERACION
				if (log.isDebugEnabled()) log.debug("turno.getHoraIni():"+turno.getHoraIni());//LOG GENERACION
				if (log.isDebugEnabled()) log.debug("horaFin:"+horaFin);//LOG GENERACION				
				//if (cantidad < 0) {  //ICR 10/04/2015 aportacion si marca es menor igual a hora inicio turno (antes solo menor)
				if (cantidad <= 0) {  //ICR 10/04/2015 aportacion si marca es menor igual a hora inicio turno (antes solo menor)
					if (log.isDebugEnabled()) log.debug("horaFin<=turno.getHoraIni()");//ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
					calif = Constantes.MOV_APORTACION;
					if (log.isDebugEnabled()) log.debug("calif5:"+calif);//LOG GENERACION
				}
				else{					
					cantidad = Utiles.calculaAcumulado(medida, 
							Utiles.stringToTimestamp(fechaMarca + " " + horaIni), 
							Utiles.stringToTimestamp(fechaMarca + " " + turno.getHoraIniRefrigerio()));
					if (log.isDebugEnabled()) log.debug("cantidad4:"+cantidad);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("horaIni:"+horaIni);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("turno.getHoraIniRefrigerio():"+turno.getHoraIniRefrigerio());//LOG GENERACION
					//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
					if ("".equals(turno.getHoraIniRefrigerio().trim())) {
						calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
						if (log.isDebugEnabled()) log.debug("calif(inicioRefri vacio):"+calif);
					} else {					
					//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
					if (cantidad > 0) {
						calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
						if (log.isDebugEnabled()) log.debug("calif5.1:"+calif);//LOG GENERACION
					} 
					else {				
						float durante = Utiles.calculaAcumulado(medida, 
								Utiles.stringToTimestamp(fechaMarca + " " + horaIni),
								Utiles.stringToTimestamp(fechaMarca + " "+ horaFin));
						if (log.isDebugEnabled()) log.debug("durante2:"+durante);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni:"+horaIni);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaFin:"+horaFin);//LOG GENERACION	

						float despues = Utiles.calculaAcumulado(medida,
								Utiles.stringToTimestamp(fechaMarca + " "+ turno.getHoraFinRefrigerio()), 
								Utiles.stringToTimestamp(fechaMarca + " "+ horaIni));
						if (log.isDebugEnabled()) log.debug("despues:"+despues);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("turno.getHoraFinRefrigerio():"+turno.getHoraFinRefrigerio());//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni:"+horaIni);//LOG GENERACION
						//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
						if ("".equals(turno.getHoraFinRefrigerio().trim())) {
							calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
							if (log.isDebugEnabled()) log.debug("calif(finRefri vacio):"+calif);
						} else {					
						//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia

							//if (despues >= 0) { //ICR 18052015
							if (despues > 0) { //ICR 18052015
								cantidad = Utiles.calculaAcumulado(medida, 
										Utiles.stringToTimestamp(fechaMarca + " " + turno.getHoraFin()),
										Utiles.stringToTimestamp(fechaMarca + " " + horaIni));
								if (log.isDebugEnabled()) log.debug("cantidad5:"+despues);//LOG GENERACION
								if (log.isDebugEnabled()) log.debug("turno.getHoraFin():"+turno.getHoraFin());//LOG GENERACION
								if (log.isDebugEnabled()) log.debug("horaIni:"+horaIni);//LOG GENERACION
								log_papeleta.debug("Cantidad " + cantidad);
								log_papeleta.debug("Turno.getHoraFin " + turno.getHoraFin());
								log_papeleta.debug("horaIni " + horaIni);
								
								//en caso se posea horas (60 min) por compensar se adicionan
								cantidad =cantidad - horasCompensa; //ICR 09092015 - PAS20155E230300109 - ajustes a proceso asistencia (descuento salida no autorizada o permiso particular c/descuento por SNA antes de la hora final de recuperacion por feriado compensable)
								
								//if (cantidad > 0) { //ICR 13/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
								if (cantidad >= 0) { //ICR 13/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
									if (log.isDebugEnabled()) log.debug("horaIni>=turno.getHoraFin()_2");//ICR 13/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
									calif = Constantes.MOV_APORTACION;
									if (log.isDebugEnabled()) log.debug("calif6:"+calif);//LOG GENERACION
								} else {
									calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
									if (log.isDebugEnabled()) log.debug("calif7:"+calif);//LOG GENERACION
								}
							} else {
								//ICAPUNAY - PAS20175E230300069
								if (procesaClima){
									if (durante > minutosClima) {										
										calif = Constantes.MOV_EXCESO_REFRIGERIO;
										if (log.isDebugEnabled()) log.debug("calif81:"+calif);
									} else {
										calif = Constantes.MOV_REFRI_CLIMALABORAL;
										if (log.isDebugEnabled()) log.debug("calif91:"+calif);
									}
								}else{
								//ICAPUNAY - PAS20175E230300069
									if (durante > turno.getMinutosRefrigerio()) {										
										calif = Constantes.MOV_EXCESO_REFRIGERIO;
										if (log.isDebugEnabled()) log.debug("calif8:"+calif);//LOG GENERACION
									} else {
										calif = Constantes.MOV_REFRIGERIO;
										if (log.isDebugEnabled()) log.debug("calif9:"+calif);//LOG GENERACION
									}
								}//linea add ICAPUNAY - PAS20175E230300069								
							}
						
						}//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
					}
					
					}//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
				}
			}
			
		} catch (Exception e){
			log.error(e);		
		}
		return calif;
	}
	//ICAPUNAY 10/11/2014 AJUSTES GENERACION ASISTENCIA (ADM Y OPE)
	
	//ICAPUNAY 23/02/2015 AJUSTES GENERACION ASISTENCIA (caso SES: SI turno (dia x-1) de 2 dias y SI turno dia x de 1 d涌(marcaciones IMPARES requiere para dia x))
	/**
	 * Calificar asistencia (caso: SES) cuando SI turno (dia x-1) de 2 dias y SI turno dia x de 1 d涌(marcaciones IMPARES requiere para dia x)
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @return califica Map
	 * @throws FacadeException
	 */
	public Map preCalificarMovimientoOpe4(String fechaMarca, String horaIni, String horaFin,
			BeanTurnoTrabajo turnoW, BeanTurnoTrabajo turnoX, String medida, boolean tieneRefrigerioW,boolean tieneRefrigerioX, boolean bOperativoW, boolean bOperativoX, boolean procesaClima, int minutosClima) throws RemoteException { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
			//BeanTurnoTrabajo turnoW, BeanTurnoTrabajo turnoX, String medida, boolean tieneRefrigerioW,boolean tieneRefrigerioX, boolean bOperativoW, boolean bOperativoX) throws RemoteException { //ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
		
		Map califica = new HashMap();

		if (log.isDebugEnabled()) log.debug("ingreso preCalificarMovimientoOpe4_SES");//NUEVO
		if (log.isDebugEnabled()) log.debug("fechaMarca-CAS:"+fechaMarca);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("medida-CAS:"+medida);//LOG GENERACION	
		
		if (log.isDebugEnabled()) log.debug("turnoW.getHoraIni()-CAS:"+turnoW.getHoraIni());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turnoW.getHoraFin()-CAS:"+turnoW.getHoraFin());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turnoW.getHoraLimite()-CAS:"+turnoW.getHoraLimite());//LOG GENERACION 
		if (log.isDebugEnabled()) log.debug("turnoW.getTolera()-CAS:"+turnoW.getTolera());//LOG GENERACION 			
		if (log.isDebugEnabled()) log.debug("turnoW.getHoraIniRefrigerio()-CAS:"+turnoW.getHoraIniRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turnoW.getMinutosRefrigerio()-CAS:"+turnoW.getMinutosRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turnoW.getHoraFinRefrigerio()-CAS:"+turnoW.getHoraFinRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("tieneRefrigerioW-CAS:"+tieneRefrigerioW);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("bOperativoW-CAS:"+bOperativoW);//LOG GENERACION
		
		if (log.isDebugEnabled()) log.debug("turnoX.getHoraIni()-CAS:"+turnoX.getHoraIni());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turnoX.getHoraFin()-CAS:"+turnoX.getHoraFin());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turnoX.getHoraLimite()-CAS:"+turnoX.getHoraLimite());//LOG GENERACION 
		if (log.isDebugEnabled()) log.debug("turnoX.getTolera()-CAS:"+turnoX.getTolera());//LOG GENERACION 			
		if (log.isDebugEnabled()) log.debug("turnoX.getHoraIniRefrigerio()-CAS:"+turnoX.getHoraIniRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turnoX.getMinutosRefrigerio()-CAS:"+turnoX.getMinutosRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("turnoX.getHoraFinRefrigerio()-CAS:"+turnoX.getHoraFinRefrigerio());//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("tieneRefrigerioX-CAS:"+tieneRefrigerioX);//LOG GENERACION
		if (log.isDebugEnabled()) log.debug("bOperativoX-CAS:"+bOperativoX);//LOG GENERACION

		
		String calif = Constantes.MOVIMIENTO_NORMAL;
		califica.put("calif",calif);
		
		if (log.isDebugEnabled()) log.debug("calif0-CAS:"+calif);//LOG GENERACION
		try {

			float cantidad = 0;
			float cantidad2 = 0;
			boolean parejaCalificada= false;
			
			//TURNO W
			/*if (tieneRefrigerioW) {
				if (log.isDebugEnabled()) log.debug("tiene refrigerioW");//LOG GENERACION
				if (horaIni.trim().compareTo(turnoX.getHoraIni().trim())<0){//NUEVO
					if (log.isDebugEnabled()) log.debug("tiene refrigerioW(horaIni<turnoX.getHoraIni)");//LOG GENERACION	
					cantidad = Utiles.calculaAcumulado(medida, 
							Utiles.stringToTimestamp(fechaMarca + " " + turnoW.getHoraFin()),
							Utiles.stringToTimestamp(fechaMarca + " " + horaIni));
					if (log.isDebugEnabled()) log.debug("cantidad-CAS:"+cantidad);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("turnoW.getHoraFin()-CAS:"+turnoW.getHoraFin());//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION	
					if (cantidad > 0) {							
						if(parejaCalificada== false){
							parejaCalificada= true;
							calif = Constantes.MOV_APORTACION;
							califica.put("calif",calif);
							califica.put("refrigerioW","SI");
							califica.put("refrigerioX","NO");
							if (log.isDebugEnabled()) log.debug("calif3-CAS:"+calif);//LOG GENERACION	
						}							
					} else {						
						cantidad = Utiles.calculaAcumulado(medida, 
								Utiles.stringToTimestamp(fechaMarca + " " + horaIni), 
								Utiles.stringToTimestamp(fechaMarca + " " + turnoW.getHoraIniRefrigerio()));
						if (log.isDebugEnabled()) log.debug("cantidad2-CAS:"+cantidad);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("turnoW.getHoraIniRefrigerio()-CAS:"+turnoW.getHoraIniRefrigerio());//LOG GENERACION					
						if (log.isDebugEnabled()) log.debug("Cantidad " + cantidad);
						if (log.isDebugEnabled()) log.debug("turnoW.getHoraIniRefrigerio " + turnoW.getHoraIniRefrigerio());
						if (log.isDebugEnabled()) log.debug("horaIni " + horaIni);
						if (cantidad < 0) {
							float durante1 = Utiles.calculaAcumulado(medida, 
									Utiles.stringToTimestamp(fechaMarca + " " + horaIni),
									Utiles.stringToTimestamp(fechaMarca + " "+ horaFin));
							if (log.isDebugEnabled()) log.debug("durante1-CAS:"+durante1);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION	
							float tarde1 = Utiles.calculaAcumulado(medida,
									Utiles.stringToTimestamp(fechaMarca + " "+ turnoW.getHoraFinRefrigerio()), 
									Utiles.stringToTimestamp(fechaMarca + " "+ horaIni));
							if (log.isDebugEnabled()) log.debug("tarde1-CAS:"+tarde1);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("turnoW.getHoraFinRefrigerio()-CAS:"+turnoW.getHoraFinRefrigerio());//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("durante W" + durante1);
							if (log.isDebugEnabled()) log.debug("despues W" + tarde1);
							if (tarde1 >= 0) {
								if(parejaCalificada== false){
									parejaCalificada= true;
									
                                                                        calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
									if (log.isDebugEnabled()) log.debug("calif10-CAS:"+calif);//LOG GENERACION
								}	
							} else {
								if (durante1 > turnoW.getMinutosRefrigerio()) {
									if(parejaCalificada== false){
										parejaCalificada= true;
										
                                            //ICR - EBV 18052015 
											//calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
											calif = Constantes.MOV_EXCESO_REFRIGERIO;
										if (log.isDebugEnabled()) log.debug("calif11-CAS:"+calif);//LOG GENERACION
									}	
								} else {
									if(parejaCalificada== false){
										parejaCalificada= true;
										calif = Constantes.MOV_REFRIGERIO;
										if (log.isDebugEnabled()) log.debug("calif12-CAS:"+calif);//LOG GENERACION
									}	
								}

							}
							califica.put("calif",calif);
							califica.put("refrigerioW","SI");
							califica.put("refrigerioX","NO");							
						} 
						if (log.isDebugEnabled()) log.debug("calif4-CAS:"+calif);//LOG GENERACION							
					}
				}
				//NUEVO				
			}
			else*/ 
			if (tieneRefrigerioW==false){
				if (log.isDebugEnabled()) log.debug("NO tiene refrigerioW_SES");			
				if (horaIni.trim().compareTo(turnoX.getHoraIni().trim())<0){
					if (log.isDebugEnabled()) log.debug("NO tiene refrigerioW(horaIni<turnoX.getHoraIni)_SES");//LOG GENERACION
					/*cantidad = Utiles.calculaAcumulado(medida, 
							Utiles.stringToTimestamp(fechaMarca + " " + horaIni), 
							Utiles.stringToTimestamp(fechaMarca + " " + turnoW.getHoraIniRefrigerio()));
					if (log.isDebugEnabled()) log.debug("cantidad4-CAS:"+cantidad);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("turnoW.getHoraIniRefrigerio()-CAS:"+turnoW.getHoraIniRefrigerio());//LOG GENERACION	
					if (cantidad > 0) {
						if(parejaCalificada== false){
							parejaCalificada= true;
							
                                                        calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
							califica.put("calif",calif);
							califica.put("refrigerioW","NO");
							califica.put("refrigerioX","NO");
							if (log.isDebugEnabled()) log.debug("calif5.1-CAS:"+calif);//LOG GENERACION
						}	
					} 
					else {						
						float durante = Utiles.calculaAcumulado(medida, 
								Utiles.stringToTimestamp(fechaMarca + " " + horaIni),
								Utiles.stringToTimestamp(fechaMarca + " "+ horaFin));
						if (log.isDebugEnabled()) log.debug("durante2-CAS:"+durante);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION	

						float despues = Utiles.calculaAcumulado(medida,
								Utiles.stringToTimestamp(fechaMarca + " "+ turnoW.getHoraFinRefrigerio()), 
								Utiles.stringToTimestamp(fechaMarca + " "+ horaIni));
						if (log.isDebugEnabled()) log.debug("despues-CAS:"+despues);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("turnoW.getHoraFinRefrigerio()-CAS:"+turnoW.getHoraFinRefrigerio());//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION

						if (despues >= 0) {*/
							cantidad = Utiles.calculaAcumulado(medida, 
									Utiles.stringToTimestamp(fechaMarca + " " + turnoW.getHoraFin()),
									Utiles.stringToTimestamp(fechaMarca + " " + horaIni));
							//if (log.isDebugEnabled()) log.debug("cantidad5-CAS:"+despues);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("turnoW.getHoraFin()-CAS:"+turnoW.getHoraFin());//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("Cantidad " + cantidad);
							if (log.isDebugEnabled()) log.debug("turnoW.getHoraFin " + turnoW.getHoraFin());
							if (log.isDebugEnabled()) log.debug("horaIni " + horaIni);
							//if (cantidad > 0) { //ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
							if (cantidad >= 0) { //ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
								if (log.isDebugEnabled()) log.debug("horaIni>=turno.getHoraFin()_ope4");//ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
								if(parejaCalificada== false){
									parejaCalificada= true;
									calif = Constantes.MOV_APORTACION;
									if (log.isDebugEnabled()) log.debug("calif6-CAS:"+calif);//LOG GENERACION
								}	
							} else {
								if(parejaCalificada== false){
									parejaCalificada= true;
									/*EBV 25/03/2015 CAMBIO DE LINEAMIENTO
									calif = Constantes.MOV_SALIDA_AUTORIZADA;
									*/
                                    calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
									if (log.isDebugEnabled()) log.debug("calif7-CAS:"+calif);//LOG GENERACION
								}	
							}
							califica.put("calif",calif);
							califica.put("refrigerioW","NO");
							califica.put("refrigerioX","NO");
						/*} else {
							if (durante > turnoW.getMinutosRefrigerio()) {
								if(parejaCalificada== false){
									parejaCalificada= true;
									calif = Constantes.MOV_EXCESO_REFRIGERIO;							
									if (log.isDebugEnabled()) log.debug("calif8-CAS:"+calif);//LOG GENERACION
								}	
							} else {
								if(parejaCalificada== false){
									parejaCalificada= true;
									calif = Constantes.MOV_REFRIGERIO;
									if (log.isDebugEnabled()) log.debug("calif9-CAS:"+calif);//LOG GENERACION
								}	
							}
							califica.put("calif",calif);
							califica.put("refrigerioW","SI");
							califica.put("refrigerioX","NO");
						}*/						
					//}
				}
				//NUEVO				
			}
			
			//TURNO X
			if (tieneRefrigerioX) {
				if (log.isDebugEnabled()) log.debug("tiene refrigerioX_SES");//LOG GENERACION					
				if (horaIni.trim().compareTo(turnoX.getHoraIni().trim())>0){
					if (log.isDebugEnabled()) log.debug("tiene refrigerioX(horaIni>turnoX.getHoraIni)_SES");//LOG GENERACION
					
					cantidad = Utiles.calculaAcumulado(medida, 
							Utiles.stringToTimestamp(fechaMarca + " " + turnoX.getHoraFin()),
							Utiles.stringToTimestamp(fechaMarca + " " + horaIni));
					if (log.isDebugEnabled()) log.debug("cantidad:"+cantidad);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("turnoX.getHoraFin():"+turnoX.getHoraFin());//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("horaIni:"+horaIni);//LOG GENERACION	
					//if (cantidad > 0) { //ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
					if (cantidad >= 0) { //ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
						if (log.isDebugEnabled()) log.debug("horaIni>=turno.getHoraFin()_ope4_x");//ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
						if(parejaCalificada== false){
							parejaCalificada= true;
							calif = Constantes.MOV_APORTACION;
							if (log.isDebugEnabled()) log.debug("calif3:"+calif);//LOG GENERACION
						}						
					} else {
						cantidad2 = Utiles.calculaAcumulado(medida, 
								Utiles.stringToTimestamp(fechaMarca + " " + horaIni), 
								Utiles.stringToTimestamp(fechaMarca + " " + turnoX.getHoraIniRefrigerio()));
						if (log.isDebugEnabled()) log.debug("cantidad2-CAS:"+cantidad2);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("turnoX.getHoraIniRefrigerio()-CAS:"+turnoX.getHoraIniRefrigerio());//LOG GENERACION					
						if (log.isDebugEnabled()) log.debug("Cantidad " + cantidad);
						if (log.isDebugEnabled()) log.debug("turnoX.getHoraIniRefrigerio " + turnoX.getHoraIniRefrigerio());
						if (log.isDebugEnabled()) log.debug("horaIni " + horaIni);
						//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
						if ("".equals(turnoX.getHoraIniRefrigerio().trim())) {
							if(parejaCalificada== false){
								parejaCalificada= true;
								calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;								
							}							
							if (log.isDebugEnabled()) log.debug("calif(inicioRefri vacio):"+calif);
						} else {					
						//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
						if (cantidad2 < 0) {
							float durante1 = Utiles.calculaAcumulado(medida, 
									Utiles.stringToTimestamp(fechaMarca + " " + horaIni),
									Utiles.stringToTimestamp(fechaMarca + " "+ horaFin)
							);
							if (log.isDebugEnabled()) log.debug("durante1-CAS:"+durante1);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION	
							float tarde1 = Utiles.calculaAcumulado(medida,
									Utiles.stringToTimestamp(fechaMarca + " "+ turnoX.getHoraFinRefrigerio()), 
									Utiles.stringToTimestamp(fechaMarca + " "+ horaIni));
							if (log.isDebugEnabled()) log.debug("tarde1-CAS:"+tarde1);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("turnoX.getHoraFinRefrigerio()-CAS:"+turnoX.getHoraFinRefrigerio());//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("durante X" + durante1);
							if (log.isDebugEnabled()) log.debug("despues X" + tarde1);
							//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
							if ("".equals(turnoX.getHoraFinRefrigerio().trim())) {
								if(parejaCalificada== false){
									parejaCalificada= true;
									calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;								
								}	
								if (log.isDebugEnabled()) log.debug("calif(finRefri vacio):"+calif);
							} else {					
								//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
								//if (tarde1 >= 0) { //ICR 18052015
								if (tarde1 > 0) { //ICR 18052015
									if(parejaCalificada== false){
										parejaCalificada= true;
										/*EBV 25/03/2015 CAMBIO DE LINEAMIENTO
									calif = Constantes.MOV_SALIDA_AUTORIZADA;
										*/
	                                    calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
										if (log.isDebugEnabled()) log.debug("calif10-CAS:"+calif);//LOG GENERACION
									}	
								} else {
									//ICAPUNAY - PAS20175E230300069
									if (procesaClima){
										if (durante1 > minutosClima) {
											if(parejaCalificada== false){
												parejaCalificada= true;											
												calif = Constantes.MOV_EXCESO_REFRIGERIO;
												if (log.isDebugEnabled()) log.debug("calif11-CAS:"+calif);//LOG GENERACION
											}	
										} else {
											if(parejaCalificada== false){
												parejaCalificada= true;
												calif = Constantes.MOV_REFRI_CLIMALABORAL;
												if (log.isDebugEnabled()) log.debug("calif12-CAS:"+calif);//LOG GENERACION
											}	
										}	
									}else{
									//ICAPUNAY - PAS20175E230300069
										if (durante1 > turnoX.getMinutosRefrigerio()) {
											if(parejaCalificada== false){
												parejaCalificada= true;											
												calif = Constantes.MOV_EXCESO_REFRIGERIO;
												if (log.isDebugEnabled()) log.debug("calif11-CAS:"+calif);//LOG GENERACION
											}	
										} else {
											if(parejaCalificada== false){
												parejaCalificada= true;
												calif = Constantes.MOV_REFRIGERIO;
												if (log.isDebugEnabled()) log.debug("calif12-CAS:"+calif);//LOG GENERACION
											}	
										}		
									}//linea add ICAPUNAY - PAS20175E230300069										
								}
							
							}//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
						} 
						if (log.isDebugEnabled()) log.debug("calif4-CAS:"+calif);//LOG GENERACION
						
						}//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
					}	
					califica.put("calif",calif);
					califica.put("refrigerioW","NO");
					califica.put("refrigerioX","SI");					
				}
							
			}
			else {
				if (log.isDebugEnabled()) log.debug("NO tiene refrigerioX_SES");//LOG GENERACION
				
				if (horaIni.trim().compareTo(turnoX.getHoraIni().trim())>0){//NUEVO
					if (log.isDebugEnabled()) log.debug("NO tiene refrigerioX(horaIni>turnoX.getHoraIni)_SES");//LOG GENERACION
					/*cantidad2 = Utiles.calculaAcumulado(medida, 
							Utiles.stringToTimestamp(fechaMarca + " " + turnoX.getHoraIni()),
							Utiles.stringToTimestamp(fechaMarca + " " + horaFin));
					if (log.isDebugEnabled()) log.debug("cantidad3-CAS:"+cantidad);//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("turnoX.getHoraIni()-CAS:"+turnoX.getHoraIni());//LOG GENERACION
					if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION
	
					if (cantidad2 < 0) {
						if(parejaCalificada== false){
							parejaCalificada= true;
							calif = Constantes.MOV_APORTACION;
							califica.put("calif",calif);
							califica.put("refrigerioW","NO");
							califica.put("refrigerioX","NO");
							if (log.isDebugEnabled()) log.debug("calif5-CAS:"+calif);//LOG GENERACION
						}	
					}
					else{*/					
						cantidad2 = Utiles.calculaAcumulado(medida, 
								Utiles.stringToTimestamp(fechaMarca + " " + horaIni), 
								Utiles.stringToTimestamp(fechaMarca + " " + turnoX.getHoraIniRefrigerio()));
						if (log.isDebugEnabled()) log.debug("cantidad4-CAS:"+cantidad2);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
						if (log.isDebugEnabled()) log.debug("turnoX.getHoraIniRefrigerio()-CAS:"+turnoX.getHoraIniRefrigerio());//LOG GENERACION
						//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
						if ("".equals(turnoX.getHoraIniRefrigerio().trim())) {
							if(parejaCalificada== false){
								parejaCalificada= true;
							    calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
								califica.put("calif",calif);
								califica.put("refrigerioW","NO");
								califica.put("refrigerioX","NO");								
							}
							if (log.isDebugEnabled()) log.debug("calif(inicioRefri vacio):"+calif);
						} else {					
						//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
						if (cantidad2 > 0) {
							if(parejaCalificada== false){
								parejaCalificada= true;
								/*EBV 25/03/2015 CAMBIO DE LINEAMIENTO
								calif = Constantes.MOV_SALIDA_AUTORIZADA;
								 */
                                calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
								califica.put("calif",calif);
								califica.put("refrigerioW","NO");
								califica.put("refrigerioX","NO");
								if (log.isDebugEnabled()) log.debug("calif5.1-CAS:"+calif);//LOG GENERACION
							}	
						} 
						else {				
							float durante = Utiles.calculaAcumulado(medida, 
									Utiles.stringToTimestamp(fechaMarca + " " + horaIni),
									Utiles.stringToTimestamp(fechaMarca + " "+ horaFin));
							if (log.isDebugEnabled()) log.debug("durante2-CAS:"+durante);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaFin-CAS:"+horaFin);//LOG GENERACION	
	
							float despues = Utiles.calculaAcumulado(medida,
									Utiles.stringToTimestamp(fechaMarca + " "+ turnoX.getHoraFinRefrigerio()), 
									Utiles.stringToTimestamp(fechaMarca + " "+ horaIni));
							if (log.isDebugEnabled()) log.debug("despues-CAS:"+despues);//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("turnoX.getHoraFinRefrigerio()-CAS:"+turnoX.getHoraFinRefrigerio());//LOG GENERACION
							if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
							//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
							if ("".equals(turnoX.getHoraFinRefrigerio().trim())) {
								if(parejaCalificada== false){
									parejaCalificada= true;
								    calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;
									califica.put("calif",calif);
									califica.put("refrigerioW","NO");
									califica.put("refrigerioX","NO");								
								}
								if (log.isDebugEnabled()) log.debug("calif(inicioRefri vacio):"+calif);
							} else {					
								//FIN ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
								//if (despues >= 0) { //ICR 18052015
								if (despues > 0) { //ICR 18052015
									cantidad2 = Utiles.calculaAcumulado(medida, 
											Utiles.stringToTimestamp(fechaMarca + " " + turnoX.getHoraFin()),
											Utiles.stringToTimestamp(fechaMarca + " " + horaIni));
									if (log.isDebugEnabled()) log.debug("cantidad5-CAS:"+despues);//LOG GENERACION
									if (log.isDebugEnabled()) log.debug("turnoX.getHoraFin()-CAS:"+turnoX.getHoraFin());//LOG GENERACION
									if (log.isDebugEnabled()) log.debug("horaIni-CAS:"+horaIni);//LOG GENERACION
									if (log.isDebugEnabled()) log.debug("Cantidad " + cantidad2);
									if (log.isDebugEnabled()) log.debug("turnoX.getHoraFin " + turnoX.getHoraFin());
									if (log.isDebugEnabled()) log.debug("horaIni " + horaIni);
									//if (cantidad2 > 0) { //ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
									if (cantidad2 >= 0) { //ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
										if (log.isDebugEnabled()) log.debug("horaIni>=turno.getHoraFin()_ope4_nox");//ICR 10/04/2015 aportacion si marca es mayor igual a hora fin turno (antes solo mayor)
										if(parejaCalificada== false){
											parejaCalificada= true;
											calif = Constantes.MOV_APORTACION;
											if (log.isDebugEnabled()) log.debug("calif6-CAS:"+calif);//LOG GENERACION
										}	
									} else {
										if(parejaCalificada== false){
											parejaCalificada= true;
											/*EBV 25/03/2015 CAMBIO DE LINEAMIENTO
									calif = Constantes.MOV_SALIDA_AUTORIZADA;
	*/
	                                        calif = Constantes.MOV_SALIDA_NO_AUTORIZADA;										
											if (log.isDebugEnabled()) log.debug("calif7-CAS:"+calif);//LOG GENERACION
										}
									}
									califica.put("calif",calif);
									califica.put("refrigerioW","NO");
									califica.put("refrigerioX","NO");
								} else {
									
									//ICAPUNAY - PAS20175E230300069
									if (procesaClima){
										if (durante > minutosClima) {
											if(parejaCalificada== false){
												parejaCalificada= true;											
												calif = Constantes.MOV_EXCESO_REFRIGERIO;
												if (log.isDebugEnabled()) log.debug("calif8-CAS:"+calif);//LOG GENERACION
											}	
										} else {
											if(parejaCalificada== false){
												parejaCalificada= true;
												calif = Constantes.MOV_REFRI_CLIMALABORAL;
												if (log.isDebugEnabled()) log.debug("calif9-CAS:"+calif);//LOG GENERACION
											}	
										}	
									}else{
									//ICAPUNAY - PAS20175E230300069
										if (durante > turnoX.getMinutosRefrigerio()) {
											if(parejaCalificada== false){
												parejaCalificada= true;											
												calif = Constantes.MOV_EXCESO_REFRIGERIO;
												if (log.isDebugEnabled()) log.debug("calif8-CAS:"+calif);//LOG GENERACION
											}	
										} else {
											if(parejaCalificada== false){
												parejaCalificada= true;
												calif = Constantes.MOV_REFRIGERIO;
												if (log.isDebugEnabled()) log.debug("calif9-CAS:"+calif);//LOG GENERACION
											}	
										}		
									}//linea add ICAPUNAY - PAS20175E230300069								
									
									califica.put("calif",calif);
									califica.put("refrigerioW","NO");
									califica.put("refrigerioX","SI");
								}
							
							}//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
						}
						
						}//ICR 10062015 - PAS20155E230300022 - ajustes a generacion y proceso asistencia
					//}
				}								
			}			
		} catch (Exception e){
			log.error(e);			
		}
		return califica;
	}
	//FIN ICAPUNAY 23/02/2015 AJUSTES GENERACION ASISTENCIA (caso SES: SI turno (dia x-1) de 2 dias y SI turno dia x de 1 d涌(marcaciones IMPARES requiere para dia x))
	
	//ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
	/**
	 * Metodo que devuelve el texto en html para el envio de correo de procesamiento por clima laboral
	 * @ejb.interface-method view-type="remote"
	 * @ejb.transaction type="NotSupported"
	 * @param params Map
	 * @param nombre String
	 * @param mensaje String
	 * @return String
	 * @throws FacadeException
	 */
	public String textoCorreoClimaLaboral(Map params,String nombre,String mensaje) throws FacadeException{

		String head = "";
		String html = "";
		StringBuffer body = new StringBuffer();
		log.debug("paramss: " + params);
		log.debug("nombreee: " + nombre);
		log.debug("mensajeee: " + mensaje);
		String tituloCorreo="Justificaci蚤 de Salida por Actividad de Clima Laboral";
		log.debug("ingreso a textoCorreoClimaLaboral");
		
		try {

			head += "<html><head><title>"
					+ tituloCorreo
					+ "</title><style>"
					+ ".T1 {font-style  : normal;text-transform : uppercase;font-size :10pt;color: #FFFFFF;background  : #336699;font-family : Tahoma,Verdana,Arial,Helvetica,sans-serif ;}"
					+ "</style></head>";
			log.debug("head:" + head);
			
			body.append(
					"<body><table width='100%' align='center' class='T1'><tr><td><center><strong>"
							+ tituloCorreo
							+ "</strong></center></td></tr></table><br><br>")
					.append("<table>")				
					.append("<tr><td><strong>Sr(a)(ita).</strong> <em>").append((String)params.get("registro")+" - ")
					.append(nombre).append("</em></td></tr></table><br>")
					.append("<tr><td>").append(mensaje)
					.append("</td></tr><br><br><br>");
           
			body.append("<table>")			
			//.append("<tr><td class='dato'>")
			//.append((String)params.get("fec_correo"))
			//.append("</td></tr><br>")
			.append("<br>")
			.append("<tr><td class='membrete'><strong>Divisi&oacute;n de Compensaciones</strong></td></tr>")			
			.append("<tr><td class='membrete'><strong>Intendencia Nacional de Recursos Humanos</strong></td></tr>")
			.append("</table>");	
			log.debug("body: " + body);
			
			html = head + body.toString();
			log.debug("html2: " + html);

		} catch (Exception e) {
			return "";
		}
		return html;
	}
	//FIN ICAPUNAY - PAS20175E230300069 - Refrigerio Clima Laboral
}
